// Project Script Bundle
globalThis['default.playground.js']=true;


// default.playground.js
var PROJECT;(function(PROJECT){class TerrainBuilder extends TOOLKIT.ScriptComponent{detailLayerContainers=[];detailMeshSources=new Map;detailLayerCullInfo=[];windTime=0;static grassTintIntensity=1.0;static grassDryColorBias=0.15;static grassHeightScale=0.85;static grassCastShadows=false;constructor(transform,scene,properties={},alias="PROJECT.TerrainBuilder"){super(transform,scene,properties,alias)}awake(){const terrainGenerator=this.getComponent("TOOLKIT.TerrainGenerator");const terrainProperties=terrainGenerator?terrainGenerator.getProperties():null;if(terrainProperties){PROJECT.TerrainBuilder.BuildDetailPrototypes(terrainProperties,this.transform,this.scene,this)}}update(){if(this.detailLayerContainers.length>0){this.windTime+=this.getDeltaTime();this.updateWindAnimation()}if(this.detailLayerCullInfo.length>0){this.updateDetailLayerCulling()}}destroy(){this.disposeDetailLayers()}updateWindAnimation(){}updateDetailLayerCulling(){if(!this.detailLayerCullInfo||this.detailLayerCullInfo.length===0){return}const cam=this.scene.activeCamera;if(!cam){return}const camPos=cam.position;for(const entry of this.detailLayerCullInfo){if(!entry||!entry.mesh||!entry.maxDistance||entry.maxDistance<=0){continue}try{const mat=entry.mesh.material;if(mat&&typeof mat.setFloatValue==="function"){mat.setFloatValue("g_maxDistance",entry.maxDistance);if(!mat.getFloatValue||mat.getFloatValue("g_fadeStart")===0){mat.setFloatValue("g_fadeStart",Math.max(0,entry.maxDistance*0.75))}}}catch(e){}}}disposeDetailLayers(){for(const container of this.detailLayerContainers){container.dispose()}this.detailLayerContainers=[];for(const[key,mesh]of this.detailMeshSources){mesh.dispose()}this.detailMeshSources.clear()}static BuildDetailPrototypes(properties,terrainTransform,scene,builderInstance){if(!properties||!properties.detaillayers||properties.detaillayers.length===0){console.log("No terrain detail layers to build");return}console.log(`Building ${properties.detaillayers.length} terrain detail prototype layers...`);const terrainSize=properties.terrainsize?new BABYLON.Vector3(properties.terrainsize[0],properties.terrainsize[1],properties.terrainsize[2]):new BABYLON.Vector3(500,100,500);const terrainPosition=terrainTransform.position||BABYLON.Vector3.Zero();const detailObjectDensity=properties.detailobjectdensity||1.0;const detailRotationOffset=properties.detailrotationoffset||180;const densityMultiplier=detailObjectDensity;const wavingGrassAmount=(properties.wavinggrassamount!=null)?properties.wavinggrassamount:0.5;const wavingGrassSpeed=(properties.wavinggrassspeed!=null)?properties.wavinggrassspeed:0.5;const wavingGrassStrength=(properties.wavinggrassstrength!=null)?properties.wavinggrassstrength:0.5;const wavingGrassTint=properties.wavinggrasstint?new BABYLON.Color4(properties.wavinggrasstint[0],properties.wavinggrasstint[1],properties.wavinggrasstint[2],properties.wavinggrasstint[3]||1.0):new BABYLON.Color4(0.7,0.8,0.5,1.0);for(let i=0;i<properties.detaillayers.length;i++){const layer=properties.detaillayers[i];if(!layer.isvalid){console.warn(`Skipping invalid detail layer ${layer.layerindex}`);continue}try{if(layer.useprototypemesh){PROJECT.TerrainBuilder.BuildMeshDetailLayer(layer,terrainSize,terrainPosition,terrainTransform,scene,densityMultiplier,detailRotationOffset,builderInstance)}else{PROJECT.TerrainBuilder.BuildBillboardDetailLayer(layer,terrainSize,terrainPosition,terrainTransform,scene,densityMultiplier,detailRotationOffset,wavingGrassAmount,wavingGrassSpeed,wavingGrassStrength,wavingGrassTint,builderInstance)}}catch(error){console.error(`Error building detail layer ${layer.layerindex}:`,error)}}console.log("Terrain detail prototypes built successfully")}static BuildMeshDetailLayer(layer,terrainSize,terrainPosition,terrainTransform,scene,densityMultiplier,detailRotationOffset,builderInstance){console.log(`Building mesh detail layer ${layer.layerindex} (${layer.prototypemeshname})`);const prototypeMesh=layer.prototypemeshnodeid?scene.getNodeById(layer.prototypemeshnodeid):null;if(!prototypeMesh||!(prototypeMesh instanceof BABYLON.Mesh)){console.warn(`Prototype mesh not found for layer ${layer.layerindex}: ${layer.prototypemeshname}`);return}const layerContainer=new BABYLON.TransformNode(`DetailLayer_${layer.layerindex}_${layer.prototypemeshname}`,scene);layerContainer.parent=terrainTransform;if(builderInstance){builderInstance.detailLayerContainers.push(layerContainer)}const instances=PROJECT.TerrainBuilder.GenerateInstancesFromDensityMap(layer,terrainSize,terrainPosition,densityMultiplier,detailRotationOffset);console.log(`Generated ${instances.length} mesh detail instances for layer ${layer.layerindex}`);if(instances.length===0){return}const instancedMesh=PROJECT.TerrainBuilder.CreateThinInstances(prototypeMesh,instances,layerContainer,scene,layer);if(instancedMesh){if(builderInstance){builderInstance.detailMeshSources.set(`layer_${layer.layerindex}`,instancedMesh);builderInstance.detailLayerCullInfo.push({container:layerContainer,mesh:instancedMesh,maxDistance:layer.maxdistance,layerIndex:layer.layerindex})}}}static BuildBillboardDetailLayer(layer,terrainSize,terrainPosition,terrainTransform,scene,densityMultiplier,detailRotationOffset,wavingAmount,wavingSpeed,wavingStrength,wavingTint,builderInstance){console.log(`Building billboard detail layer ${layer.layerindex}`);const renderMode=layer.rendermode||"GrassBillboard";const layerContainer=new BABYLON.TransformNode(`DetailLayer_${layer.layerindex}_Billboard`,scene);layerContainer.parent=terrainTransform;if(builderInstance){builderInstance.detailLayerContainers.push(layerContainer)}const instances=PROJECT.TerrainBuilder.GenerateInstancesFromDensityMap(layer,terrainSize,terrainPosition,densityMultiplier,detailRotationOffset);console.log(`Generated ${instances.length} billboard detail instances for layer ${layer.layerindex}`);if(instances.length===0){return}const billboardMesh=PROJECT.TerrainBuilder.CreateBillboardMesh(layer,layerContainer,scene,wavingAmount,wavingSpeed,wavingStrength,wavingTint);if(!billboardMesh){console.warn(`Failed to create billboard mesh for layer ${layer.layerindex}`);return}const instancedMesh=PROJECT.TerrainBuilder.CreateThinInstances(billboardMesh,instances,layerContainer,scene,layer);if(instancedMesh&&builderInstance){builderInstance.detailMeshSources.set(`layer_${layer.layerindex}`,instancedMesh);try{const mat=instancedMesh.material;if(mat&&typeof mat.setFloatValue==="function"){const md=layer.maxdistance!=null?layer.maxdistance:0;mat.setFloatValue("g_maxDistance",md);const fadeStart=md>0?Math.max(0,md*0.75):0;mat.setFloatValue("g_fadeStart",fadeStart)}}catch(e){}builderInstance.detailLayerCullInfo.push({container:layerContainer,mesh:instancedMesh,maxDistance:layer.maxdistance,layerIndex:layer.layerindex})}}static GenerateInstancesFromDensityMap(layer,terrainSize,terrainPosition,densityMultiplier,detailRotationOffset){const instances=[];if(!layer.densitymap||!layer.densitywidth||!layer.densityheight){return instances}const densityWidth=layer.densitywidth;const densityHeight=layer.densityheight;const noiseSpread=layer.noisespread!=null?layer.noisespread:1.0;const cellSizeX=terrainSize.x/densityWidth;const cellSizeZ=terrainSize.z/densityHeight;console.log(`Processing density map: ${densityWidth}x${densityHeight}, cell size: ${cellSizeX}x${cellSizeZ}`);console.log(`Detail object density multiplier: ${densityMultiplier}`);const minWidth=layer.minwidth||1.0;const maxWidth=layer.maxwidth||2.0;const minHeight=layer.minheight||1.0;const maxHeight=layer.maxheight||2.0;const detailRotationOffsetRadians=(detailRotationOffset||0)*(Math.PI/180.0);console.log(`Scale range: width ${minWidth}-${maxWidth}, height ${minHeight}-${maxHeight}`);const healthyColor=layer.healthycolor?new BABYLON.Color4(layer.healthycolor[0],layer.healthycolor[1],layer.healthycolor[2],layer.healthycolor[3]||1.0):new BABYLON.Color4(0.3,0.8,0.2,1.0);const dryColor=layer.drycolor?new BABYLON.Color4(layer.drycolor[0],layer.drycolor[1],layer.drycolor[2],layer.drycolor[3]||1.0):new BABYLON.Color4(0.8,0.7,0.3,1.0);let totalDensity=0;let maxDensityValue=0;const layerSeed=(layer.layerindex!=null?layer.layerindex:0)+1;for(let z=0;z<densityHeight;z++){for(let x=0;x<densityWidth;x++){const densityIndex=z*densityWidth+x;const density=layer.densitymap[densityIndex]||0;totalDensity+=density;maxDensityValue=Math.max(maxDensityValue,density);if(density<=0){continue}const instanceCount=Math.max(1,Math.ceil(density*densityMultiplier));for(let i=0;i<instanceCount;i++){const rawRandomX=PROJECT.TerrainBuilder.HashToUnitFloat(x,z,i,layerSeed,1);const rawRandomZ=PROJECT.TerrainBuilder.HashToUnitFloat(x,z,i,layerSeed,2);const spread=Math.min(Math.max(noiseSpread,0.0),1.0);const randomX=0.5+(rawRandomX-0.5)*spread;const randomZ=0.5+(rawRandomZ-0.5)*spread;const cellX=x*cellSizeX+randomX*cellSizeX;const cellZ=z*cellSizeZ+randomZ*cellSizeZ;const posX=cellZ;const posZ=cellX;const worldX=terrainPosition.x+posX-terrainSize.z*0.5;const worldZ=terrainPosition.z+posZ-terrainSize.x*0.5;let posYWorld=terrainPosition.y;const cornerHeights=(layer&&layer.cellcornerheights)?layer.cellcornerheights:null;const centerHeights=(layer&&layer.cellheights)?layer.cellheights:null;if(cornerHeights&&cornerHeights.length===(densityWidth+1)*(densityHeight+1)){const uNorm=(worldX-(terrainPosition.x-terrainSize.x*0.5))/terrainSize.x;const vNorm=(worldZ-(terrainPosition.z-terrainSize.z*0.5))/terrainSize.z;const sampleX=Math.max(0,Math.min(1,uNorm))*densityWidth;const sampleY=Math.max(0,Math.min(1,vNorm))*densityHeight;let ix=Math.floor(sampleX);let iy=Math.floor(sampleY);const tx=sampleX-ix;const ty=sampleY-iy;const ix0=Math.max(0,Math.min(densityWidth,ix));const ix1=Math.max(0,Math.min(densityWidth,ix+1));const iy0=Math.max(0,Math.min(densityHeight,iy));const iy1=Math.max(0,Math.min(densityHeight,iy+1));const w=densityWidth+1;const h00=cornerHeights[iy0*w+ix0];const h10=cornerHeights[iy0*w+ix1];const h01=cornerHeights[iy1*w+ix0];const h11=cornerHeights[iy1*w+ix1];const hx0=h00+(h10-h00)*tx;const hx1=h01+(h11-h01)*tx;posYWorld=hx0+(hx1-hx0)*ty;const groundOffset=layer.groundOffset!=null?layer.groundOffset:0.02;posYWorld+=groundOffset}else if(centerHeights&&centerHeights.length===densityWidth*densityHeight){const uNorm=(worldX-(terrainPosition.x-terrainSize.x*0.5))/terrainSize.x;const vNorm=(worldZ-(terrainPosition.z-terrainSize.z*0.5))/terrainSize.z;const sampleX=Math.max(0,Math.min(1,uNorm))*densityWidth-0.5;const sampleY=Math.max(0,Math.min(1,vNorm))*densityHeight-0.5;let ix=Math.floor(sampleX);let iy=Math.floor(sampleY);const tx=sampleX-ix;const ty=sampleY-iy;const ix0=Math.max(0,Math.min(densityWidth-1,ix));const ix1=Math.max(0,Math.min(densityWidth-1,ix+1));const iy0=Math.max(0,Math.min(densityHeight-1,iy));const iy1=Math.max(0,Math.min(densityHeight-1,iy+1));const h00=centerHeights[iy0*densityWidth+ix0];const h10=centerHeights[iy0*densityWidth+ix1];const h01=centerHeights[iy1*densityWidth+ix0];const h11=centerHeights[iy1*densityWidth+ix1];const hx0=h00+(h10-h00)*tx;const hx1=h01+(h11-h01)*tx;posYWorld=hx0+(hx1-hx0)*ty;const groundOffset=layer.groundOffset!=null?layer.groundOffset:0.02;posYWorld+=groundOffset;try{const neighbors=[];neighbors.push(h00,h10,h01,h11);const maxNeighbor=Math.max(...neighbors);if(maxNeighbor-posYWorld>0.05){posYWorld=posYWorld*0.6+maxNeighbor*0.4}}catch(e){}}else{posYWorld=terrainPosition.y}const position=new BABYLON.Vector3(worldX,posYWorld,worldZ);const unityRotation=layer.useprototypemesh?PROJECT.TerrainBuilder.HashToUnitFloat(x,z,i,layerSeed,3)*Math.PI*2:0.0;const rotation=layer.useprototypemesh?PROJECT.TerrainBuilder.NormalizeRotation(PROJECT.TerrainBuilder.ConvertDetailRotation(unityRotation)+detailRotationOffsetRadians):0.0;const scaleWidth=minWidth+PROJECT.TerrainBuilder.HashToUnitFloat(x,z,i,layerSeed,4)*(maxWidth-minWidth);const scaleHeight=(minHeight+PROJECT.TerrainBuilder.HashToUnitFloat(x,z,i,layerSeed,5)*(maxHeight-minHeight))*PROJECT.TerrainBuilder.grassHeightScale;const scale=new BABYLON.Vector3(scaleWidth,scaleHeight,scaleWidth);let color;if(layer.useprototypemesh){color=new BABYLON.Color4(1,1,1,1)}else{let colorLerp=PROJECT.TerrainBuilder.HashToUnitFloat(x,z,i,layerSeed,6);if(PROJECT.TerrainBuilder.grassDryColorBias&&PROJECT.TerrainBuilder.grassDryColorBias!==0){colorLerp=Math.min(1.0,Math.max(0.0,colorLerp+PROJECT.TerrainBuilder.grassDryColorBias))}color=BABYLON.Color4.Lerp(healthyColor,dryColor,colorLerp);color=BABYLON.Color4.Lerp(new BABYLON.Color4(1,1,1,1),color,0.9)}instances.push({position:position,rotation:rotation,scale:scale,color:color})}}}console.log(`Total density sum: ${totalDensity}, max density: ${maxDensityValue}, instances created: ${instances.length}`);return instances}static HashToUnitFloat(x,z,i,layerSeed,salt){let h=x*374761393+z*668265263+i*1442695041+layerSeed*374761393+salt*374761393;h=(h^(h>>13))*1274126177;h=h^(h>>16);return(h>>>0)/4294967296}static sRGBToLinear(value){const v=Math.max(0,Math.min(1,value));return Math.pow(v,2.2)}static ConvertDetailRotation(unityRotation){const twoPi=Math.PI*2;let rotation=(Math.PI*0.5)-unityRotation;rotation=rotation%twoPi;if(rotation<0){rotation+=twoPi}return rotation}static NormalizeRotation(rotation){const twoPi=Math.PI*2;let result=rotation%twoPi;if(result<0){result+=twoPi}return result}static CreateThinInstances(sourceMesh,instances,parent,scene,layer){if(instances.length===0){return null}console.log(`Creating thin instances: source=${sourceMesh.name}, layer=${layer.layerindex}, count=${instances.length}`);const instancedMesh=sourceMesh.clone(`${sourceMesh.name}_Instanced`,parent,false,false);if(!instancedMesh){console.warn("Failed to clone mesh for instancing");return null}instancedMesh.setEnabled(true);instancedMesh.isVisible=true;sourceMesh.setEnabled(false);sourceMesh.isVisible=false;instancedMesh.receiveShadows=false;instancedMesh.applyFog=true;instancedMesh.thinInstanceEnablePicking=false;const bufferMatrices=new Float32Array(instances.length*16);const shouldUseVertexColors=!layer.useprototypemesh&&(layer.healthycolor||layer.drycolor);const bufferColors=shouldUseVertexColors?new Float32Array(instances.length*4):null;for(let i=0;i<instances.length;i++){const instance=instances[i];const matrixIndex=i*16;const matrix=BABYLON.Matrix.Identity();BABYLON.Matrix.ComposeToRef(instance.scale,BABYLON.Quaternion.RotationAxis(BABYLON.Axis.Y,instance.rotation),instance.position,matrix);matrix.copyToArray(bufferMatrices,matrixIndex);if(bufferColors){const colorIndex=i*4;const tint=PROJECT.TerrainBuilder.grassTintIntensity;const r=Math.min(1.0,instance.color.r*tint);const g=Math.min(1.0,instance.color.g*tint);const b=Math.min(1.0,instance.color.b*tint);bufferColors[colorIndex]=PROJECT.TerrainBuilder.sRGBToLinear(r);bufferColors[colorIndex+1]=PROJECT.TerrainBuilder.sRGBToLinear(g);bufferColors[colorIndex+2]=PROJECT.TerrainBuilder.sRGBToLinear(b);bufferColors[colorIndex+3]=instance.color.a}}instancedMesh.thinInstanceSetBuffer("matrix",bufferMatrices,16,false);if(bufferColors){instancedMesh.thinInstanceSetBuffer("color",bufferColors,4,false);instancedMesh.useVertexColors=true;instancedMesh.hasVertexAlpha=true}try{if(scene&&scene.lights){scene.lights.forEach(light=>{try{const shadowGenerator=light.getShadowGenerator?light.getShadowGenerator():null;if(shadowGenerator){const shadowMap=shadowGenerator.getShadowMap?shadowGenerator.getShadowMap():null;if(shadowMap){if(PROJECT.TerrainBuilder.grassCastShadows){if(!shadowMap.renderList){shadowMap.renderList=[]}if(shadowMap.renderList.indexOf(instancedMesh)===-1){shadowMap.renderList.push(instancedMesh)}}else{if(shadowMap.renderList){const idx=shadowMap.renderList.indexOf(instancedMesh);if(idx!==-1){shadowMap.renderList.splice(idx,1)}}}}}}catch(e){}})}}catch(e){}instancedMesh.metadata=instancedMesh.metadata||{};instancedMesh.metadata.toolkit=instancedMesh.metadata.toolkit||{};instancedMesh.metadata.toolkit.castRealtimeShadow=PROJECT.TerrainBuilder.grassCastShadows;console.log(`Created ${instances.length} thin instances for ${instancedMesh.name}`);return instancedMesh}static CreateBillboardMesh(layer,parent,scene,wavingAmount,wavingSpeed,wavingStrength,wavingTint){const renderMode=layer.rendermode||"GrassBillboard";const hasTexture=layer.prototypetexture!=null&&layer.prototypetexture.filename!=null&&layer.prototypetexture.filename!=="";const useGrassBillboardMaterial=(renderMode!=="VertexLit")&&(hasTexture||renderMode==="GrassBillboard"||renderMode==="Grass");const avgWidth=((layer.minwidth||1.0)+(layer.maxwidth||2.0))/2;const avgHeight=(((layer.minheight||1.0)+(layer.maxheight||2.0))/2)*PROJECT.TerrainBuilder.grassHeightScale;let billboardMesh=null;if(renderMode==="GrassBillboard"){billboardMesh=PROJECT.TerrainBuilder.CreateCrossedQuadsBillboard(`GrassBillboard_${layer.layerindex}`,avgWidth,avgHeight,scene)}else if(renderMode==="Grass"){billboardMesh=PROJECT.TerrainBuilder.CreateCrossedQuadsBillboard(`GrassBillboard_${layer.layerindex}`,avgWidth,avgHeight,scene)}else if(renderMode==="VertexLit"){billboardMesh=BABYLON.MeshBuilder.CreatePlane(`GrassPlane_${layer.layerindex}`,{width:avgWidth,height:avgHeight},scene);billboardMesh.rotation.x=Math.PI/2}if(!billboardMesh){return null}billboardMesh.parent=parent;billboardMesh.isVisible=false;billboardMesh.sideOrientation=BABYLON.Mesh.DOUBLESIDE;billboardMesh.applyFog=true;if(renderMode!=="VertexLit"){PROJECT.TerrainBuilder.ApplyUpNormals(billboardMesh)}const material=useGrassBillboardMaterial?new TOOLKIT.GrassBillboardMaterial(`GrassMaterial_${layer.layerindex}`,scene):new BABYLON.StandardMaterial(`GrassMaterial_${layer.layerindex}`,scene);if(layer.prototypetexture!=null&&layer.prototypetexture.filename!=null&&layer.prototypetexture.filename!=""){const texturePath=`scenes/${layer.prototypetexture.filename}`;const texture=new BABYLON.Texture(texturePath,scene);texture.hasAlpha=true;texture.updateSamplingMode(BABYLON.Texture.TRILINEAR_SAMPLINGMODE);texture.anisotropicFilteringLevel=4;texture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;texture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;if(material instanceof TOOLKIT.GrassBillboardMaterial){material.albedoTexture=texture;material.opacityTexture=texture;material.useAlphaFromAlbedoTexture=true;material.alphaCutOff=0.3;try{material.setFloatValue("g_alphaCutoff",(material.alphaCutOff!=null)?material.alphaCutOff:0.3)}catch(e){}}else{material.diffuseTexture=texture;material.opacityTexture=texture;material.useAlphaFromDiffuseTexture=true;material.alphaCutOff=0.3}}else{material.alphaCutOff=0.3;if(layer&&layer.healthycolor){const healthy=new BABYLON.Color3(layer.healthycolor[0],layer.healthycolor[1],layer.healthycolor[2]);const tint=PROJECT.TerrainBuilder.grassTintIntensity;const colorToUse=new BABYLON.Color3(PROJECT.TerrainBuilder.sRGBToLinear(healthy.r*tint),PROJECT.TerrainBuilder.sRGBToLinear(healthy.g*tint),PROJECT.TerrainBuilder.sRGBToLinear(healthy.b*tint));if(material instanceof TOOLKIT.GrassBillboardMaterial){material.albedoColor=colorToUse}else{material.diffuseColor=colorToUse}}material.emissiveColor=new BABYLON.Color3(0,0,0)}if(material instanceof TOOLKIT.GrassBillboardMaterial){if(material.albedoTexture){material.albedoColor=new BABYLON.Color3(1.0,1.0,1.0);try{material.setFloatValue("g_alphaCutoff",(material.alphaCutOff!=null)?material.alphaCutOff:0.3)}catch(e){}}material.emissiveColor=new BABYLON.Color3(0,0,0);material.metallic=0.0;material.roughness=1.0;material.twoSidedLighting=true;material.backFaceCulling=false;material.transparencyMode=BABYLON.Material.MATERIAL_ALPHATEST}else{if(material.diffuseTexture){material.diffuseColor=new BABYLON.Color3(1,1,1)}material.emissiveColor=new BABYLON.Color3(0,0,0);material.ambientColor=new BABYLON.Color3(0.1,0.1,0.1);material.specularColor=new BABYLON.Color3(0,0,0);material.disableLighting=false;material.twoSidedLighting=true;material.backFaceCulling=false;material.transparencyMode=BABYLON.Material.MATERIAL_ALPHATEST}billboardMesh.material=material;if(material instanceof TOOLKIT.GrassBillboardMaterial){material.setFloatValue("g_windAmount",(wavingAmount!=null)?wavingAmount:0.5);material.setFloatValue("g_windSpeed",(wavingSpeed!=null)?wavingSpeed:0.5);material.setFloatValue("g_windStrength",(wavingStrength!=null)?wavingStrength:0.5);material.setVector4Value("g_windTint",new BABYLON.Vector4(wavingTint.r,wavingTint.g,wavingTint.b,wavingTint.a));material.setFloatValue("g_maxDistance",0.0);material.setFloatValue("g_fadeStart",0.0)}return billboardMesh}static CreateCrossedQuadsBillboard(name,width,height,scene){const positions=[];const indices=[];const normals=[];const uvs=[];const halfWidth=width/2;const halfHeight=height/2;positions.push(-halfWidth,0,0,halfWidth,0,0,halfWidth,height,0,-halfWidth,height,0);indices.push(0,1,2,0,2,3);indices.push(0,3,2,0,2,1);uvs.push(0,0,1,0,1,1,0,1);for(let i=0;i<4;i++){normals.push(0,1,0)}const customMesh=new BABYLON.Mesh(name,scene);const vertexData=new BABYLON.VertexData;vertexData.positions=positions;vertexData.indices=indices;vertexData.normals=normals;vertexData.uvs=uvs;vertexData.applyToMesh(customMesh);return customMesh}static CreateVerticalBillboard(name,width,height,scene){const plane=BABYLON.MeshBuilder.CreatePlane(name,{width:width,height:height},scene);plane.billboardMode=BABYLON.Mesh.BILLBOARDMODE_Y;return plane}static ApplyUpNormals(mesh){const positions=mesh.getVerticesData(BABYLON.VertexBuffer.PositionKind);if(!positions){return}const normals=new Array(positions.length);for(let i=0;i<positions.length;i+=3){normals[i]=0;normals[i+1]=1;normals[i+2]=0}mesh.setVerticesData(BABYLON.VertexBuffer.NormalKind,normals,false)}}PROJECT.TerrainBuilder=TerrainBuilder;TOOLKIT.SceneManager.RegisterClass("PROJECT.TerrainBuilder",TerrainBuilder)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class CheckpointManager extends TOOLKIT.ScriptComponent{checkPointList=null;checkPointCount=0;checkPointIndex=0;nextCheckPoint=0;startRaceTime=0;totalRaceTime=0;lapNumber=0;lapTimer=0;lapTimes=null;playerID=0;playerName="Player";raceOver=false;register(id,name){this.playerID=id;this.playerName=name;PROJECT.RaceTrackManager.RegisterPlayer(this.playerID,this.playerName)}getLapTimes(){return this.lapTimes}getLapNumber(){return this.lapNumber}getCheckPoint(){return this.checkPointIndex}getPlayerName(){return this.playerName}getPlayerID(){return this.playerID}getRaceTime(){return this.totalRaceTime}getRaceOver(){return this.raceOver}constructor(transform,scene,properties={},alias="PROJECT.CheckpointManager"){super(transform,scene,properties,alias)}start(){this.lapTimes=[];this.lapNumber=0;this.nextCheckPoint=0;this.checkPointList=PROJECT.RaceTrackManager.GetCheckpointList();this.checkPointCount=PROJECT.RaceTrackManager.GetCheckpointCount()}nextCheckPointName="";update(){if(this.raceOver===false){if(this.checkPointList!=null&&this.checkPointList.length>0){const nextCheckpointMesh=this.checkPointList[this.nextCheckPoint];if(nextCheckpointMesh!=null){this.nextCheckPointName=nextCheckpointMesh.name;if(nextCheckpointMesh.intersectsPoint(this.transform.absolutePosition)){this.checkPointIndex=this.nextCheckPoint;if(this.checkPointIndex===0){if(this.lapNumber>0&&this.lapTimer>0){const lapTime=(TOOLKIT.SceneManager.GetGameTime()-this.lapTimer);if(this.lapTimes==null)this.lapTimes=[];this.lapTimes.push(lapTime)}this.lapNumber++;this.lapTimer=TOOLKIT.SceneManager.GetGameTime();if(this.lapNumber>PROJECT.RaceTrackManager.TotalLapCount){this.startRaceTime=0;this.lapNumber=PROJECT.RaceTrackManager.TotalLapCount;this.raceOver=true;PROJECT.RaceTrackManager.EventBus.PostMessage("GameOver");if(PROJECT.RaceTrackManager.WinnerTransform==null){PROJECT.RaceTrackManager.WinnerTransform=this.transform;console.warn("RACE WINNER: "+this.transform.name)}}}this.nextCheckPoint++;if(this.nextCheckPoint>=this.checkPointCount){this.nextCheckPoint=0}}}}}}late(){if(this.raceOver===false){if(this.startRaceTime>0){this.totalRaceTime=(TOOLKIT.SceneManager.GetGameTime()-this.startRaceTime)}if(this.playerID>0){PROJECT.RaceTrackManager.UpdateLeaderboard(this.playerID,this.lapNumber,this.checkPointIndex,this.transform.absolutePosition)}}}startRaceTimer(){if(this.startRaceTime===0){this.lapTimes=[];this.raceOver=false;this.startRaceTime=TOOLKIT.SceneManager.GetGameTime()}}}PROJECT.CheckpointManager=CheckpointManager;TOOLKIT.SceneManager.RegisterClass("PROJECT.CheckpointManager",CheckpointManager)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class NetworkCarPrediction extends TOOLKIT.ScriptComponent{autoRegister=true;handlerName="VehiclePrediction";extrapolateTimeMs=200;constructor(transform,scene,properties={},alias="PROJECT.NetworkCarPrediction"){super(transform,scene,properties,alias)}awake(){if(this.autoRegister===true)this.register()}register(){BABYLON.NetworkManager.RegisterCustomInterpolationHandler(this.handlerName,(networkEntity,remoteTransform,deltaTime)=>{this.HandleUpdate(networkEntity,remoteTransform,deltaTime)})}HandleUpdate(networkEntity,remoteTransform,deltaTime){}LegacyHandleUpdate(networkEntity,remoteTransform,deltaTime){const entityDeltaTime=0;const entityElaspedTime=0;const entityDeltaTimeMs=(entityDeltaTime*1000);const entityElaspedTimeMs=(entityElaspedTime*1000);if(entityDeltaTimeMs<=this.extrapolateTimeMs&&entityElaspedTimeMs<=this.extrapolateTimeMs){let rotationSlerpFactor=10.0;let rotationLerpSpeed=(rotationSlerpFactor*deltaTime);rotationLerpSpeed=BABYLON.Scalar.Clamp(rotationLerpSpeed,0,1)}else{}}}PROJECT.NetworkCarPrediction=NetworkCarPrediction;TOOLKIT.SceneManager.RegisterClass("PROJECT.NetworkCarPrediction",NetworkCarPrediction)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class RoutePoint{position;direction;}PROJECT.RoutePoint=RoutePoint;class PlayerRaceStats{id;name;position;}PROJECT.PlayerRaceStats=PlayerRaceStats;class RaceTrackManager extends TOOLKIT.ScriptComponent{static TrackLength=0;static TotalLapCount=3;static WinnerTransform=null;static CheckPointTag="Checkpoint";static CheckPointList=null;static LeaderBoardList=null;static PlayerVehicleList=null;trackNodes=null;raceLineData_1=null;raceLineData_2=null;raceLineData_3=null;raceLineData_4=null;raceLineData_5=null;raceLineColor_1=null;raceLineColor_2=null;raceLineColor_3=null;raceLineColor_4=null;raceLineColor_5=null;debugMeshLines_1=null;debugMeshLines_2=null;debugMeshLines_3=null;debugMeshLines_4=null;debugMeshLines_5=null;p0n=0;p1n=0;p2n=0;p3n=0;i=0;static _EventBus=null;static get EventBus(){if(PROJECT.RaceTrackManager._EventBus==null){PROJECT.RaceTrackManager._EventBus=new TOOLKIT.LocalMessageBus}return PROJECT.RaceTrackManager._EventBus}drawDebugLines=false;getTrackNodes(){return this.trackNodes}getControlPoints(line){let result=null;switch(line){case 0:result=this.raceLineData_1;break;case 1:result=this.raceLineData_2;break;case 2:result=this.raceLineData_3;break;case 3:result=this.raceLineData_4;break;case 4:result=this.raceLineData_5;break}return result}constructor(transform,scene,properties={},alias="PROJECT.RaceTrackManager"){super(transform,scene,properties,alias)}awake(){this.trackNodes=this.getProperty("TrackNodes",this.trackNodes);this.raceLineData_1=this.getProperty("RaceLineData_1",this.raceLineData_1);this.raceLineData_2=this.getProperty("RaceLineData_2",this.raceLineData_2);this.raceLineData_3=this.getProperty("RaceLineData_3",this.raceLineData_3);this.raceLineData_4=this.getProperty("RaceLineData_4",this.raceLineData_4);this.raceLineData_5=this.getProperty("RaceLineData_5",this.raceLineData_5);this.raceLineColor_1=this.getProperty("RaceLineColor_1",this.raceLineColor_1);this.raceLineColor_2=this.getProperty("RaceLineColor_2",this.raceLineColor_2);this.raceLineColor_3=this.getProperty("RaceLineColor_3",this.raceLineColor_3);this.raceLineColor_4=this.getProperty("RaceLineColor_4",this.raceLineColor_4);this.raceLineColor_5=this.getProperty("RaceLineColor_5",this.raceLineColor_5);this.drawDebugLines=this.getProperty("DrawDebugLines",this.drawDebugLines);let index=0;if(this.trackNodes!=null){PROJECT.RaceTrackManager.TrackLength=0;for(index=0;index<this.trackNodes.length;index++){const element=this.trackNodes[index];const t1=this.trackNodes[(index)%this.trackNodes.length];const t2=this.trackNodes[(index+1)%this.trackNodes.length];if(t1!=null&&t2!=null){const rot=TOOLKIT.Utilities.ParseVector4(element.rotation);element.localRotation=new BABYLON.Quaternion(rot.x,rot.y,rot.z,rot.w);element.localPosition=TOOLKIT.Utilities.ParseVector3(element.position);const p1=TOOLKIT.Utilities.ParseVector3(t1.position);const p2=TOOLKIT.Utilities.ParseVector3(t2.position);element.localDistance=PROJECT.RaceTrackManager.TrackLength;PROJECT.RaceTrackManager.TrackLength+=(p1.subtract(p2)).length()}}}console.warn(">>> Race Track Nodes");console.log(this.trackNodes);if(PROJECT.RaceTrackManager.LeaderBoardList==null){PROJECT.RaceTrackManager.LeaderBoardList=[]}if(PROJECT.RaceTrackManager.CheckPointList==null){PROJECT.RaceTrackManager.CheckPointList=this.scene.getMeshesByTags(PROJECT.RaceTrackManager.CheckPointTag);if(PROJECT.RaceTrackManager.CheckPointList!=null&&PROJECT.RaceTrackManager.CheckPointList.length>0){for(index=0;index<PROJECT.RaceTrackManager.CheckPointList.length;index++){PROJECT.RaceTrackManager.CheckPointList[index].refreshBoundingInfo({})}}}}start(){if(this.drawDebugLines===true){let index=0;const pointSize=0.5;const debugLines=new BABYLON.TransformNode(this.transform.name+".DebugLines",this.scene);debugLines.position.set(0,0,0);debugLines.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);if(this.trackNodes!=null&&this.trackNodes.length>0){const trackNodePos_1=[];const trackNodeCol_1=BABYLON.Color3.White();const trackNodeMat_1=new BABYLON.StandardMaterial(this.transform.name+".NodeMaterial",this.scene);trackNodeMat_1.diffuseColor=trackNodeCol_1;index=0;this.trackNodes.forEach(node=>{const trackNodePosition=new BABYLON.Vector3(node.position.x,node.position.y,node.position.z);const trackNodeRotation=new BABYLON.Quaternion(node.rotation.x,node.rotation.y,node.rotation.z,node.rotation.w);trackNodePos_1.push(trackNodePosition);const trackNode=BABYLON.MeshBuilder.CreateCylinder(this.transform.name+".TrackNode_"+index,{diameterTop:0,diameterBottom:(pointSize*2),height:2.0},this.scene);trackNode.parent=debugLines;trackNode.position.copyFrom(trackNodePosition);trackNode.position.y+=0.5;trackNode.rotationQuaternion=trackNodeRotation.multiply(TOOLKIT.Utilities.FromEuler(90,0,0));trackNode.material=trackNodeMat_1;index++})}if(this.raceLineData_5!=null&&this.raceLineData_5.length>0){const raceLinePos_5=[];const raceLineCol_5=(this.raceLineColor_5!=null)?new BABYLON.Color3(this.raceLineColor_5.r,this.raceLineColor_5.g,this.raceLineColor_5.b):BABYLON.Color3.White();const raceLineMat_5=new BABYLON.StandardMaterial(this.transform.name+".PointMaterial_5",this.scene);raceLineMat_5.diffuseColor=raceLineCol_5;index=0;this.raceLineData_5.forEach(point=>{const raceLinePoint=new BABYLON.Vector3(point.position.x,point.position.y,point.position.z);raceLinePos_5.push(raceLinePoint);const controlPoint_5=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".ControlPoint_5_"+index,{segments:24,diameter:(pointSize*2)},this.scene);controlPoint_5.parent=debugLines;controlPoint_5.position.copyFrom(raceLinePoint);controlPoint_5.position.y+=0.5;controlPoint_5.material=raceLineMat_5;index++});this.debugMeshLines_5=BABYLON.MeshBuilder.CreateLines((this.transform.name+".RaceLine_5"),{points:raceLinePos_5},this.scene);this.debugMeshLines_5.parent=debugLines;this.debugMeshLines_5.position.y+=0.5;this.debugMeshLines_5.color=raceLineCol_5}if(this.raceLineData_4!=null&&this.raceLineData_4.length>0){const raceLinePos_4=[];const raceLineCol_4=(this.raceLineColor_4!=null)?new BABYLON.Color3(this.raceLineColor_4.r,this.raceLineColor_4.g,this.raceLineColor_4.b):BABYLON.Color3.White();const raceLineMat_4=new BABYLON.StandardMaterial(this.transform.name+".PointMaterial_4",this.scene);raceLineMat_4.diffuseColor=raceLineCol_4;index=0;this.raceLineData_4.forEach(point=>{const raceLinePoint=new BABYLON.Vector3(point.position.x,point.position.y,point.position.z);raceLinePos_4.push(raceLinePoint);const controlPoint_4=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".ControlPoint_4_"+index,{segments:24,diameter:(pointSize*2)},this.scene);controlPoint_4.parent=debugLines;controlPoint_4.position.copyFrom(raceLinePoint);controlPoint_4.position.y+=0.5;controlPoint_4.material=raceLineMat_4;index++});this.debugMeshLines_4=BABYLON.MeshBuilder.CreateLines((this.transform.name+".RaceLine_4"),{points:raceLinePos_4},this.scene);this.debugMeshLines_4.parent=debugLines;this.debugMeshLines_4.position.y+=0.5;this.debugMeshLines_4.color=raceLineCol_4}if(this.raceLineData_3!=null&&this.raceLineData_3.length>0){const raceLinePos_3=[];const raceLineCol_3=(this.raceLineColor_3!=null)?new BABYLON.Color3(this.raceLineColor_3.r,this.raceLineColor_3.g,this.raceLineColor_3.b):BABYLON.Color3.White();const raceLineMat_3=new BABYLON.StandardMaterial(this.transform.name+".PointMaterial_3",this.scene);raceLineMat_3.diffuseColor=raceLineCol_3;index=0;this.raceLineData_3.forEach(point=>{const raceLinePoint=new BABYLON.Vector3(point.position.x,point.position.y,point.position.z);raceLinePos_3.push(raceLinePoint);const controlPoint_3=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".ControlPoint_3_"+index,{segments:24,diameter:(pointSize*2)},this.scene);controlPoint_3.parent=debugLines;controlPoint_3.position.copyFrom(raceLinePoint);controlPoint_3.position.y+=0.5;controlPoint_3.material=raceLineMat_3;index++});this.debugMeshLines_3=BABYLON.MeshBuilder.CreateLines((this.transform.name+".RaceLine_3"),{points:raceLinePos_3},this.scene);this.debugMeshLines_3.parent=debugLines;this.debugMeshLines_3.position.y+=0.5;this.debugMeshLines_3.color=raceLineCol_3}if(this.raceLineData_2!=null&&this.raceLineData_2.length>0){const raceLinePos_2=[];const raceLineCol_2=(this.raceLineColor_2!=null)?new BABYLON.Color3(this.raceLineColor_2.r,this.raceLineColor_2.g,this.raceLineColor_2.b):BABYLON.Color3.White();const raceLineMat_2=new BABYLON.StandardMaterial(this.transform.name+".PointMaterial_2",this.scene);raceLineMat_2.diffuseColor=raceLineCol_2;index=0;this.raceLineData_2.forEach(point=>{const raceLinePoint=new BABYLON.Vector3(point.position.x,point.position.y,point.position.z);raceLinePos_2.push(raceLinePoint);const controlPoint_2=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".ControlPoint_2_"+index,{segments:24,diameter:(pointSize*2)},this.scene);controlPoint_2.parent=debugLines;controlPoint_2.position.copyFrom(raceLinePoint);controlPoint_2.position.y+=0.5;controlPoint_2.material=raceLineMat_2;index++});this.debugMeshLines_2=BABYLON.MeshBuilder.CreateLines((this.transform.name+".RaceLine_2"),{points:raceLinePos_2},this.scene);this.debugMeshLines_2.parent=debugLines;this.debugMeshLines_2.position.y+=0.5;this.debugMeshLines_2.color=raceLineCol_2}if(this.raceLineData_1!=null&&this.raceLineData_1.length>0){const raceLinePos_1=[];const raceLineCol_1=(this.raceLineColor_1!=null)?new BABYLON.Color3(this.raceLineColor_1.r,this.raceLineColor_1.g,this.raceLineColor_1.b):BABYLON.Color3.White();const raceLineMat_1=new BABYLON.StandardMaterial(this.transform.name+".PointMaterial_1",this.scene);raceLineMat_1.diffuseColor=raceLineCol_1;index=0;this.raceLineData_1.forEach(point=>{const raceLinePoint=new BABYLON.Vector3(point.position.x,point.position.y,point.position.z);raceLinePos_1.push(raceLinePoint);const controlPoint_1=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".ControlPoint_1_"+index,{segments:24,diameter:(pointSize*2)},this.scene);controlPoint_1.parent=debugLines;controlPoint_1.position.copyFrom(raceLinePoint);controlPoint_1.position.y+=0.5;controlPoint_1.material=raceLineMat_1;index++});this.debugMeshLines_1=BABYLON.MeshBuilder.CreateLines((this.transform.name+".RaceLine_1"),{points:raceLinePos_1},this.scene);this.debugMeshLines_1.parent=debugLines;this.debugMeshLines_1.position.y+=0.5;this.debugMeshLines_1.color=raceLineCol_1}}}after(){if(this.isReady()){PROJECT.RaceTrackManager.SortLeaderboardPositionList()}}destroy(){}getRoutePoint(distance){const result=new RoutePoint;this.getRoutePointToRef(distance,result);return result}getRoutePointToRef(distance,result){const p1=this.getRoutePosition(distance);const p2=this.getRoutePosition(distance+0.1);const delta=p2.subtract(p1);result.position=p1.clone();result.direction=delta.normalizeToNew()}getRoutePosition(distance){const result=new BABYLON.Vector3(0,0,0);this.getRoutePositionToRef(distance,result);return result}getRoutePositionToRef(distance,result){let point=0;const dist=BABYLON.Scalar.Repeat(distance,PROJECT.RaceTrackManager.TrackLength);const numPoints=this.trackNodes.length;while(this.trackNodes[point].localDistance<dist){++point}this.p1n=((point-1)+numPoints)%numPoints;this.p2n=point;this.i=BABYLON.Scalar.InverseLerp(this.trackNodes[this.p1n].localDistance,this.trackNodes[this.p2n].localDistance,dist);BABYLON.Vector3.LerpToRef(this.trackNodes[this.p1n].localPosition,this.trackNodes[this.p2n].localPosition,this.i,result)}static GetCheckpointTag(){return PROJECT.RaceTrackManager.CheckPointTag}static GetCheckpointList(){return PROJECT.RaceTrackManager.CheckPointList}static GetCheckpointCount(){return(PROJECT.RaceTrackManager.CheckPointList!=null)?PROJECT.RaceTrackManager.CheckPointList.length:0}static GetCheckpointDistance(position,lastPointReached,nextPoint){const displacementFromCurrentNode=position.subtract(lastPointReached);const currentSegmentVector=nextPoint.subtract(lastPointReached);const fraction=BABYLON.Vector3.Dot(displacementFromCurrentNode,currentSegmentVector)/currentSegmentVector.lengthSquared();return BABYLON.Scalar.Clamp(fraction)}static RegisterVehicle(vehicle){if(PROJECT.RaceTrackManager.PlayerVehicleList==null)PROJECT.RaceTrackManager.PlayerVehicleList=[];PROJECT.RaceTrackManager.PlayerVehicleList.push(vehicle)}static GetPlayerVehicles(){return PROJECT.RaceTrackManager.PlayerVehicleList}static RegisterPlayer(id,name){const player=new PROJECT.PlayerRaceStats;player.id=id;player.name=name;player.position=0;if(PROJECT.RaceTrackManager.LeaderBoardList==null)PROJECT.RaceTrackManager.LeaderBoardList=[];PROJECT.RaceTrackManager.LeaderBoardList.push(player)}static UpdateLeaderboard(id,lap,checkpoint,position){if(PROJECT.RaceTrackManager.LeaderBoardList!=null&&PROJECT.RaceTrackManager.LeaderBoardList.length>0){const leaderboard=PROJECT.RaceTrackManager.LeaderBoardList;for(let index=0;index<leaderboard.length;index++){const element=leaderboard[index];if(element.id===id){if(PROJECT.RaceTrackManager.CheckPointList!=null&&PROJECT.RaceTrackManager.CheckPointList.length>0){let checkPointCount=PROJECT.RaceTrackManager.CheckPointList.length;let nextCheckPointIndex=(checkpoint+1);if(nextCheckPointIndex>=checkPointCount)nextCheckPointIndex=0;const startCheckpointMesh=PROJECT.RaceTrackManager.CheckPointList[checkpoint];const nextCheckpointMesh=PROJECT.RaceTrackManager.CheckPointList[nextCheckPointIndex];const checkPointFraction=PROJECT.RaceTrackManager.GetCheckpointDistance(position,startCheckpointMesh.absolutePosition,nextCheckpointMesh.absolutePosition);element.position=(((lap*1000)+checkpoint)+checkPointFraction)}break}}}}static GetLeaderboardPosition(id){let result=-1;if(PROJECT.RaceTrackManager.LeaderBoardList!=null&&PROJECT.RaceTrackManager.LeaderBoardList.length>0){const leaderboard=PROJECT.RaceTrackManager.LeaderBoardList;for(let index=0;index<leaderboard.length;index++){const element=leaderboard[index];if(element.id===id){result=(index+1);break}}}return result}static GetLeaderboardPositionList(){return PROJECT.RaceTrackManager.LeaderBoardList}static SortLeaderboardPositionList(){if(PROJECT.RaceTrackManager.LeaderBoardList!=null&&PROJECT.RaceTrackManager.LeaderBoardList.length>0){const leaderboard=PROJECT.RaceTrackManager.LeaderBoardList;leaderboard.sort((left,right)=>{if(left.position<right.position)return 1;if(left.position>right.position)return-1;return 0})}}}PROJECT.RaceTrackManager=RaceTrackManager;TOOLKIT.SceneManager.RegisterClass("PROJECT.RaceTrackManager",RaceTrackManager)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class RemoteCarController extends TOOLKIT.ScriptComponent{static ShowSensorLines=false;centerOfMass=0.4;burnoutWheelPitch=0.85;linkTrackManager=true;playVehicleSounds=true;smokeTexture=null;skidThreashold=0.65;smokeIntensity=150;wheelDrawVelocity=0.02;smokeOpacity=0.1;smokeDonuts=2.0;steeringWheelHub=null;steeringWheelAxis=2;maxSteeringAngle=35.0;maxSteeringSpeed=10.0;_animator=null;_engineAudioSource=null;_skidAudioSource=null;brakeLightsMesh=null;brakeLightsTrans=null;reverseLightsMesh=null;reverseLightsTrans=null;frontLeftWheelTrans=null;frontRightWheelTrans=null;backLeftWheelTrans=null;backRightWheelTrans=null;frontLeftWheelMesh=null;frontRightWheelMesh=null;backLeftWheelMesh=null;backRightWheelMesh=null;frontLeftWheelEmitter=null;frontRightWheelEmitter=null;backLeftWheelEmitter=null;backRightWheelEmitter=null;frontLeftWheelParticle=null;frontRightWheelParticle=null;backLeftWheelParticle=null;backRightWheelParticle=null;frontLeftContact=false;frontRightContact=false;rearLeftContact=false;rearRightContact=false;frontLeftContactTag="";frontRightContactTag="";rearLeftContactTag="";rearRightContactTag="";frontLeftContactPoint=new BABYLON.Vector3(0,0,0);frontRightContactPoint=new BABYLON.Vector3(0,0,0);rearLeftContactPoint=new BABYLON.Vector3(0,0,0);rearRightContactPoint=new BABYLON.Vector3(0,0,0);frontLeftContactNormal=new BABYLON.Vector3(0,0,0);frontRightContactNormal=new BABYLON.Vector3(0,0,0);rearLeftContactNormal=new BABYLON.Vector3(0,0,0);rearRightContactNormal=new BABYLON.Vector3(0,0,0);frontLeftSensorLine=null;frontRightSensorLine=null;rearLeftSensorLine=null;rearRightSensorLine=null;startRaycastPosition=new BABYLON.Vector3(0,0,0);endRaycastPosition=new BABYLON.Vector3(0,0,0);smokeIntensityFactor=0;downDirection=new BABYLON.Vector3(0,-1,0);downDistance=2.0;lastPitch=0;lastBrake=0;lastReverse=0;lastBurnout=0;lastSteering=0;lastSKID_FL=0;lastSKID_FR=0;lastSKID_RL=0;lastSKID_RR=0;lastSPIN_FL=0;lastSPIN_FR=0;lastSPIN_RL=0;lastSPIN_RR=0;PITCH_FL=0;PITCH_FR=0;PITCH_RL=0;PITCH_RR=0;WHEEL_SKID_PITCH=0;getFrontLeftWheelContact(){return this.frontLeftContact}getFrontRightWheelContact(){return this.frontRightContact}getRearLeftWheelContact(){return this.rearLeftContact}getRearRightWheelContact(){return this.rearRightContact}getFrontLeftWheelContactTag(){return this.frontLeftContactTag}getFrontRightWheelContactTag(){return this.frontRightContactTag}getRearLeftWheelContactTag(){return this.rearLeftContactTag}getRearRightWheelContactTag(){return this.rearRightContactTag}getFrontLeftWheelContactPoint(){return this.frontLeftContactPoint}getFrontRightWheelContactPoint(){return this.frontRightContactPoint}getRearLeftWheelContactPoint(){return this.rearLeftContactPoint}getRearRightWheelContactPoint(){return this.rearRightContactPoint}getFrontLeftWheelContactNormal(){return this.frontLeftContactNormal}getFrontRightWheelContactNormal(){return this.frontRightContactNormal}getRearLeftWheelContactNormal(){return this.rearLeftContactNormal}getRearRightWheelContactNormal(){return this.rearRightContactNormal}m_frontLeftWheelSkid=-1;m_frontRightWheelSkid=-1;m_backLeftWheelSkid=-1;m_backRightWheelSkid=-1;m_velocityOffset=new BABYLON.Vector3(0,0,0);m_linearVelocity=new BABYLON.Vector3(0,0,0);m_lastPosition=new BABYLON.Vector3(0,0,0);m_positionCenter=new BABYLON.Vector3(0,0,0);m_scaledVelocity=0;constructor(transform,scene,properties={},alias="PROJECT.RemoteCarController"){super(transform,scene,properties,alias)}awake(){this.centerOfMass=this.getProperty("centerOfMass",this.centerOfMass);this.burnoutWheelPitch=this.getProperty("burnoutWheelPitch",this.burnoutWheelPitch);this.linkTrackManager=this.getProperty("linkTrackManager",this.linkTrackManager);this.playVehicleSounds=this.getProperty("playVehicleSounds",this.playVehicleSounds);this.wheelDrawVelocity=this.getProperty("wheelDrawVelocity",this.wheelDrawVelocity);this.skidThreashold=this.getProperty("skidThreashold",this.skidThreashold);this.smokeIntensity=this.getProperty("smokeIntensity",this.smokeIntensity);this.smokeOpacity=this.getProperty("smokeOpacity",this.smokeOpacity);this.smokeDonuts=this.getProperty("smokeDonuts",this.smokeDonuts);this.steeringWheelAxis=this.getProperty("steeringWheelAxis",this.steeringWheelAxis);this.maxSteeringAngle=this.getProperty("maxSteeringAngle",this.maxSteeringAngle);this.maxSteeringSpeed=this.getProperty("maxSteeringSpeed",this.maxSteeringSpeed);this.frontLeftWheelTrans=this.getProperty("frontLeftWheelMesh",this.frontLeftWheelTrans);this.frontRightWheelTrans=this.getProperty("frontRightWheelMesh",this.frontRightWheelTrans);this.backLeftWheelTrans=this.getProperty("rearLeftWheelMesh",this.backLeftWheelTrans);this.backRightWheelTrans=this.getProperty("rearRightWheelMesh",this.backRightWheelTrans);this.brakeLightsTrans=this.getProperty("brakeLightsMesh",this.brakeLightsTrans);this.reverseLightsTrans=this.getProperty("reverseLightsMesh",this.reverseLightsTrans);const smokeTextureInfo=this.getProperty("smokeTexture");if(smokeTextureInfo!=null){this.smokeTexture=TOOLKIT.Utilities.ParseTexture(smokeTextureInfo,this.scene)}if(this.linkTrackManager===true)PROJECT.RaceTrackManager.RegisterVehicle(this.transform);this._animator=this.getComponent("TOOLKIT.AnimationState");if(this._animator==null){const animationNode=this.getChildWithScript("TOOLKIT.AnimationState");if(animationNode!=null){this._animator=TOOLKIT.SceneManager.FindScriptComponent(animationNode,"TOOLKIT.AnimationState")}else{}}this._engineAudioSource=this.getComponent("TOOLKIT.AudioSource");if(this._engineAudioSource==null)TOOLKIT.SceneManager.LogWarning("No engine audio source manager found for: "+this.transform.name);const steeringWheelNode=this.getProperty("steeringWheelHub");if(steeringWheelNode!=null&&steeringWheelNode.name!=null&&steeringWheelNode.name!==""){this.steeringWheelHub=this.getChildNode(steeringWheelNode.name,TOOLKIT.SearchType.IndexOf,false)}const brakeLightslName=(this.brakeLightsTrans!=null&&this.brakeLightsTrans.name!=null&&this.brakeLightsTrans.name!=="")?this.brakeLightsTrans.name:null;const reverseLightslName=(this.reverseLightsTrans!=null&&this.reverseLightsTrans.name!=null&&this.reverseLightsTrans.name!=="")?this.reverseLightsTrans.name:null;const frontLeftWheelName=(this.frontLeftWheelTrans!=null&&this.frontLeftWheelTrans.name!=null&&this.frontLeftWheelTrans.name!=="")?this.frontLeftWheelTrans.name:null;const frontRightWheelName=(this.frontRightWheelTrans!=null&&this.frontRightWheelTrans.name!=null&&this.frontRightWheelTrans.name!=="")?this.frontRightWheelTrans.name:null;const backLeftWheelName=(this.backLeftWheelTrans!=null&&this.backLeftWheelTrans.name!=null&&this.backLeftWheelTrans.name!=="")?this.backLeftWheelTrans.name:null;const backRightWheelName=(this.backRightWheelTrans!=null&&this.backRightWheelTrans.name!=null&&this.backRightWheelTrans.name!=="")?this.backRightWheelTrans.name:null;if(brakeLightslName!=null){this.brakeLightsMesh=this.getChildNode(brakeLightslName,TOOLKIT.SearchType.IndexOf,false);if(this.brakeLightsMesh!=null){this.brakeLightsMesh.isVisible=false}}if(reverseLightslName!=null){this.reverseLightsMesh=this.getChildNode(reverseLightslName,TOOLKIT.SearchType.IndexOf,false);if(this.reverseLightsMesh!=null){this.reverseLightsMesh.isVisible=false}}this.frontLeftWheelMesh=this.getChildNode(frontLeftWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.frontLeftWheelMesh!=null){this.frontLeftWheelMesh.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.frontLeftWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.frontLeftWheelEmitter=new BABYLON.Mesh("Emitter_FL");this.frontLeftWheelEmitter.parent=this.frontLeftWheelMesh.spinner||this.frontLeftWheelMesh;this.frontLeftWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.frontLeftWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_FL",this.frontLeftWheelEmitter)}this.frontRightWheelMesh=this.getChildNode(frontRightWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.frontRightWheelMesh!=null){this.frontRightWheelMesh.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.frontRightWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.frontRightWheelEmitter=new BABYLON.Mesh("Emitter_FR");this.frontRightWheelEmitter.parent=this.frontRightWheelMesh.spinner||this.frontRightWheelMesh;this.frontRightWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.frontRightWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_FR",this.frontRightWheelEmitter)}this.backLeftWheelMesh=this.getChildNode(backLeftWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.backLeftWheelMesh!=null){this.backLeftWheelMesh.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.backLeftWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.backLeftWheelEmitter=new BABYLON.Mesh("Emitter_RL");this.backLeftWheelEmitter.parent=this.backLeftWheelMesh.spinner||this.backLeftWheelMesh;this.backLeftWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.backLeftWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_RL",this.backLeftWheelEmitter)}this.backRightWheelMesh=this.getChildNode(backRightWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.backRightWheelMesh!=null){this.backRightWheelMesh.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.backRightWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.backRightWheelEmitter=new BABYLON.Mesh("Emitter_RR");this.backRightWheelEmitter.parent=this.backRightWheelMesh.spinner||this.backRightWheelMesh;this.backRightWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.backRightWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_RR",this.backRightWheelEmitter)}if(this._skidAudioSource==null&&this.backRightWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.backRightWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null&&this.backLeftWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.backLeftWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null&&this.frontRightWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.frontRightWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null&&this.frontLeftWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.frontLeftWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null)TOOLKIT.SceneManager.LogWarning("No skid audio source manager found for: "+this.transform.name)}start(){this.m_positionCenter.set(0,0,-this.centerOfMass)}update(){if(TOOLKIT.EntityController.HasNetworkEntity(this.transform)){this.lastPitch=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,0);this.lastBrake=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,1);this.lastReverse=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,2);this.lastBurnout=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,3);this.lastSKID_FL=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,4);this.lastSKID_FR=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,5);this.lastSKID_RL=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,6);this.lastSKID_RR=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,7);this.lastSPIN_FL=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,8);this.lastSPIN_FR=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,9);this.lastSPIN_RL=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,10);this.lastSPIN_RR=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,11);this.lastSteering=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,12)}this.updateVehicleProperties()}destroy(){}updateVehicleProperties(){this.m_linearVelocity=this.transform.absolutePosition.subtract(this.m_lastPosition);this.m_scaledVelocity=(this.m_linearVelocity.length()/this.getDeltaSeconds());this.m_linearVelocity.normalize();this.m_linearVelocity.scaleInPlace(this.m_scaledVelocity);if(this.wheelDrawVelocity>0){this.m_velocityOffset.copyFrom(this.m_linearVelocity);this.m_velocityOffset.scaleInPlace(this.wheelDrawVelocity)}else{this.m_velocityOffset.set(0,0,0)}this.m_lastPosition.copyFrom(this.transform.absolutePosition);this.castWheelContactRays();if(this.playVehicleSounds===true){if(this._engineAudioSource!=null){this._engineAudioSource.setPitch(this.lastPitch)}}const SPIN_FL_Transform=this.frontLeftWheelMesh.spinner;const SPIN_FR_Transform=this.frontRightWheelMesh.spinner;const SPIN_RL_Transform=this.backLeftWheelMesh.spinner;const SPIN_RR_Transform=this.backRightWheelMesh.spinner;if(SPIN_FL_Transform!=null&&SPIN_FL_Transform.rotationQuaternion!=null){const SPIN_FL_Rotation=BABYLON.Quaternion.FromEulerAngles(this.lastSPIN_FL,0,0);BABYLON.Quaternion.SlerpToRef(SPIN_FL_Transform.rotationQuaternion,SPIN_FL_Rotation,0.5,SPIN_FL_Transform.rotationQuaternion)}if(SPIN_FR_Transform!=null&&SPIN_FR_Transform.rotationQuaternion!=null){const SPIN_FR_Rotation=BABYLON.Quaternion.FromEulerAngles(this.lastSPIN_FR,0,0);BABYLON.Quaternion.SlerpToRef(SPIN_FR_Transform.rotationQuaternion,SPIN_FR_Rotation,0.5,SPIN_FR_Transform.rotationQuaternion)}if(SPIN_RL_Transform!=null&&SPIN_RL_Transform.rotationQuaternion!=null){const SPIN_RL_Rotation=BABYLON.Quaternion.FromEulerAngles(this.lastSPIN_RL,0,0);BABYLON.Quaternion.SlerpToRef(SPIN_RL_Transform.rotationQuaternion,SPIN_RL_Rotation,0.5,SPIN_RL_Transform.rotationQuaternion)}if(SPIN_RR_Transform!=null&&SPIN_RR_Transform.rotationQuaternion!=null){const SPIN_RR_Rotation=BABYLON.Quaternion.FromEulerAngles(this.lastSPIN_RR,0,0);BABYLON.Quaternion.SlerpToRef(SPIN_RR_Transform.rotationQuaternion,SPIN_RR_Rotation,0.5,SPIN_RR_Transform.rotationQuaternion)}this.smokeDonuts=BABYLON.Scalar.Clamp(this.smokeDonuts,1,10);this.smokeIntensityFactor=this.smokeIntensity;if(this.lastBurnout>0)this.smokeIntensityFactor*=this.smokeDonuts;if(this.lastSKID_FL>0&&this.frontLeftContact===true){const skidScaleFL=BABYLON.Scalar.Normalize(this.lastSKID_FL,this.skidThreashold,1.0);this.m_frontLeftWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(this.frontLeftContactPoint,this.frontLeftContactNormal,skidScaleFL,this.m_frontLeftWheelSkid);if(this.frontLeftWheelParticle!=null){if(this.frontLeftWheelParticle.isStarted()===false){this.frontLeftWheelParticle.start()}const smoke_FL=this.lastSKID_FL*this.lastSKID_FL;this.frontLeftWheelParticle.emitRate=this.smokeIntensityFactor*smoke_FL;this.frontLeftWheelParticle.minSize=0.2*smoke_FL+0.2;this.frontLeftWheelParticle.maxSize=1.5*smoke_FL+1.2}}else{if(this.frontLeftWheelParticle!=null)this.frontLeftWheelParticle.emitRate=0;this.m_frontLeftWheelSkid=-1}if(this.lastSKID_FR>0&&this.frontRightContact===true){const skidScaleFR=BABYLON.Scalar.Normalize(this.lastSKID_FR,this.skidThreashold,1.0);this.m_frontRightWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(this.frontRightContactPoint,this.frontRightContactNormal,skidScaleFR,this.m_frontRightWheelSkid);if(this.frontRightWheelParticle!=null){if(this.frontRightWheelParticle.isStarted()===false){this.frontRightWheelParticle.start()}const smoke_FR=this.lastSKID_FR*this.lastSKID_FR;this.frontRightWheelParticle.emitRate=this.smokeIntensityFactor*smoke_FR;this.frontRightWheelParticle.minSize=0.2*smoke_FR+0.2;this.frontRightWheelParticle.maxSize=1.5*smoke_FR+1.2}}else{if(this.frontRightWheelParticle!=null)this.frontRightWheelParticle.emitRate=0;this.m_frontRightWheelSkid=-1}this.PITCH_FL=this.lastSKID_FL;this.PITCH_FR=this.lastSKID_FR;if(this.lastBurnout>0){this.PITCH_FL*=this.burnoutWheelPitch;this.PITCH_FR*=this.burnoutWheelPitch}this.PITCH_FL*=0.75;this.PITCH_FR*=0.75;if(this.lastSKID_RL>0&&this.rearLeftContact===true){const skidScaleRL=BABYLON.Scalar.Normalize(this.lastSKID_RL,this.skidThreashold,1.0);this.m_backLeftWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(this.rearLeftContactPoint,this.rearLeftContactNormal,skidScaleRL,this.m_backLeftWheelSkid);if(this.backLeftWheelParticle!=null){if(this.backLeftWheelParticle.isStarted()===false){this.backLeftWheelParticle.start()}const smoke_RL=this.lastSKID_RL*this.lastSKID_RL;this.backLeftWheelParticle.emitRate=this.smokeIntensityFactor*smoke_RL;this.backLeftWheelParticle.minSize=0.2*smoke_RL+0.2;this.backLeftWheelParticle.maxSize=1.5*smoke_RL+1.2}}else{if(this.backLeftWheelParticle!=null)this.backLeftWheelParticle.emitRate=0;this.m_backLeftWheelSkid=-1}if(this.lastSKID_RR>0&&this.rearRightContact===true){const skidScaleRR=BABYLON.Scalar.Normalize(this.lastSKID_RR,this.skidThreashold,1.0);this.m_backRightWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(this.rearRightContactPoint,this.rearRightContactNormal,skidScaleRR,this.m_backRightWheelSkid);if(this.backRightWheelParticle!=null){if(this.backRightWheelParticle.isStarted()===false){this.backRightWheelParticle.start()}const smoke_RR=this.lastSKID_RR*this.lastSKID_RR;this.backRightWheelParticle.emitRate=this.smokeIntensityFactor*smoke_RR;this.backRightWheelParticle.minSize=0.2*smoke_RR+0.2;this.backRightWheelParticle.maxSize=1.5*smoke_RR+1.2}}else{if(this.backRightWheelParticle!=null)this.backRightWheelParticle.emitRate=0;this.m_backRightWheelSkid=-1}this.PITCH_RL=this.lastSKID_RL;this.PITCH_RR=this.lastSKID_RR;if(this.lastBurnout>0){this.PITCH_RL*=this.burnoutWheelPitch;this.PITCH_RR*=this.burnoutWheelPitch}this.WHEEL_SKID_PITCH=0;if(this.PITCH_FL>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_FL;if(this.PITCH_FR>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_FR;if(this.PITCH_RL>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_RL;if(this.PITCH_RR>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_RR;if(this.playVehicleSounds===true){if(this._skidAudioSource!=null){this._skidAudioSource.setPitch(this.WHEEL_SKID_PITCH)}}if(this.steeringWheelHub!=null){if(this.steeringWheelHub.rotationQuaternion==null){this.steeringWheelHub.rotationQuaternion=BABYLON.Quaternion.FromEulerVector(this.steeringWheelHub.rotation)}const degreesSteerAngle=(this.lastSteering*this.maxSteeringAngle);const radiansSteerAngle=BABYLON.Tools.ToRadians(degreesSteerAngle);const xaxis=(this.steeringWheelAxis===0)?radiansSteerAngle:0;const yaxis=(this.steeringWheelAxis===1)?radiansSteerAngle:0;const zaxis=(this.steeringWheelAxis===2)?radiansSteerAngle:0;BABYLON.Quaternion.FromEulerAnglesToRef(xaxis,yaxis,zaxis,this.steeringWheelHub.rotationQuaternion)}if(this._animator!=null)this._animator.setFloat("TurnAngle",this.lastSteering);if(this.brakeLightsMesh!=null){this.brakeLightsMesh.isVisible=(this.lastBrake>0)}if(this.reverseLightsMesh!=null){this.reverseLightsMesh.isVisible=(this.lastReverse>0)}if(this.lastSKID_FL===0&&this.lastSKID_FL===0&&this.lastSKID_FL===0&&this.lastSKID_FL===0){this.smokeIntensityFactor=0}}castWheelContactRays(){let raycast=null;this.frontLeftContact=false;this.frontRightContact=false;this.rearLeftContact=false;this.rearRightContact=false;this.frontLeftContactTag="";this.frontRightContactTag="";this.rearLeftContactTag="";this.rearRightContactTag="";this.frontLeftContactPoint.set(0,0,0);this.frontRightContactPoint.set(0,0,0);this.rearLeftContactPoint.set(0,0,0);this.rearRightContactPoint.set(0,0,0);this.frontLeftContactNormal.set(0,0,0);this.frontRightContactNormal.set(0,0,0);this.rearLeftContactNormal.set(0,0,0);this.rearRightContactNormal.set(0,0,0);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.frontLeftWheelMesh,this.startRaycastPosition);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.frontLeftWheelMesh,this.endRaycastPosition,this.downDirection.scale(this.downDistance));this.startRaycastPosition.addInPlace(this.m_velocityOffset);this.endRaycastPosition.addInPlace(this.m_velocityOffset);if(raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){this.frontLeftContact=true;this.frontLeftContactTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);this.frontLeftContactPoint.copyFrom(raycast.hitPoint);this.frontLeftContactNormal.copyFrom(raycast.hitNormal)}if(PROJECT.RemoteCarController.ShowSensorLines===true){if(this.frontLeftSensorLine==null)this.frontLeftSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".FrontLeftSensorLine",this.scene);if(this.frontLeftContact===true){this.frontLeftSensorLine.drawLine([this.startRaycastPosition,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.frontLeftSensorLine.drawLine([this.startRaycastPosition,this.endRaycastPosition],BABYLON.Color3.Blue())}}TOOLKIT.Utilities.GetAbsolutePositionToRef(this.frontRightWheelMesh,this.startRaycastPosition);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.frontRightWheelMesh,this.endRaycastPosition,this.downDirection.scale(this.downDistance));this.startRaycastPosition.addInPlace(this.m_velocityOffset);this.endRaycastPosition.addInPlace(this.m_velocityOffset);if(raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){this.frontRightContact=true;this.frontRightContactTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);this.frontRightContactPoint.copyFrom(raycast.hitPoint);this.frontRightContactNormal.copyFrom(raycast.hitNormal)}if(PROJECT.RemoteCarController.ShowSensorLines===true){if(this.frontRightSensorLine==null)this.frontRightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".FrontRightSensorLine",this.scene);if(this.frontRightContact===true){this.frontRightSensorLine.drawLine([this.startRaycastPosition,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.frontRightSensorLine.drawLine([this.startRaycastPosition,this.endRaycastPosition],BABYLON.Color3.Blue())}}TOOLKIT.Utilities.GetAbsolutePositionToRef(this.backLeftWheelMesh,this.startRaycastPosition);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.backLeftWheelMesh,this.endRaycastPosition,this.downDirection.scale(this.downDistance));this.startRaycastPosition.addInPlace(this.m_velocityOffset);this.endRaycastPosition.addInPlace(this.m_velocityOffset);if(raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){this.rearLeftContact=true;this.rearLeftContactTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);this.rearLeftContactPoint.copyFrom(raycast.hitPoint);this.rearLeftContactNormal.copyFrom(raycast.hitNormal)}if(PROJECT.RemoteCarController.ShowSensorLines===true){if(this.rearLeftSensorLine==null)this.rearLeftSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".RearLeftSensorLine",this.scene);if(this.rearLeftContact===true){this.rearLeftSensorLine.drawLine([this.startRaycastPosition,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.rearLeftSensorLine.drawLine([this.startRaycastPosition,this.endRaycastPosition],BABYLON.Color3.Blue())}}TOOLKIT.Utilities.GetAbsolutePositionToRef(this.backRightWheelMesh,this.startRaycastPosition);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.backRightWheelMesh,this.endRaycastPosition,this.downDirection.scale(this.downDistance));this.startRaycastPosition.addInPlace(this.m_velocityOffset);this.endRaycastPosition.addInPlace(this.m_velocityOffset);if(raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){this.rearRightContact=true;this.rearRightContactTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);this.rearRightContactPoint.copyFrom(raycast.hitPoint);this.rearRightContactNormal.copyFrom(raycast.hitNormal)}if(PROJECT.RemoteCarController.ShowSensorLines===true){if(this.rearRightSensorLine==null)this.rearRightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".RearRightSensorLine",this.scene);if(this.rearRightContact===true){this.rearRightSensorLine.drawLine([this.startRaycastPosition,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.rearRightSensorLine.drawLine([this.startRaycastPosition,this.endRaycastPosition],BABYLON.Color3.Blue())}}}createSmokeParticleSystem(name,emitter){const result=new BABYLON.ParticleSystem(name,10000,this.scene);result.blendMode=BABYLON.ParticleSystem.BLENDMODE_STANDARD;result.particleTexture=this.smokeTexture;result.emitter=emitter;result.emitRate=0;result.updateSpeed=0.01;result.minSize=0.2;result.maxSize=1.3;result.minAngularSpeed=-1.5;result.maxAngularSpeed=1.5;result.minLifeTime=3.0;result.maxLifeTime=5.0;result.addVelocityGradient(0,1);result.addVelocityGradient(0.1,0.7);result.addVelocityGradient(0.7,0.2);result.addVelocityGradient(1.0,0.05);result.gravity=new BABYLON.Vector3(0,-0.1,0);result.minEmitBox=new BABYLON.Vector3(0,-0.25,0);result.maxEmitBox=new BABYLON.Vector3(0,-0.25,0);result.direction1=new BABYLON.Vector3(-1,-1,-1);result.direction2=new BABYLON.Vector3(1,1,1);result.color1=new BABYLON.Color4(0.95,0.95,0.95,this.smokeOpacity);result.color2=new BABYLON.Color4(0.85,0.85,0.85,this.smokeOpacity);result.colorDead=new BABYLON.Color4(0.9,0.9,0.9,(this.smokeOpacity*0.5));return result}}PROJECT.RemoteCarController=RemoteCarController;TOOLKIT.SceneManager.RegisterClass("PROJECT.RemoteCarController",RemoteCarController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SkidMarkSection{Pos=BABYLON.Vector3.Zero();Normal=BABYLON.Vector3.Zero();Tangent=BABYLON.Vector4.Zero();Posl=BABYLON.Vector3.Zero();Posr=BABYLON.Vector3.Zero();Intensity=0.0;LastIndex=-1;}PROJECT.SkidMarkSection=SkidMarkSection;class SkidMarkManager extends TOOLKIT.ScriptComponent{static MAX_MARKS=1024;static GROUND_OFFSET=0.01;static GPU_TRIANGLES=true;static MARK_COLOR=BABYLON.Color3.Black();static MARK_WIDTH=0.3;static TEX_INTENSITY=1.0;static MIN_DISTANCE=0.1;static MIN_SQR_DISTANCE=(SkidMarkManager.MIN_DISTANCE*SkidMarkManager.MIN_DISTANCE);static TEXTURE_MARKS=null;static SkidBufferPositions=null;static SkidBufferNormals=null;static SkidBufferTangents=null;static SkidBufferColors=null;static SkidBufferUvs=null;static SkidBufferIndices=null;static SkidMarkSections=null;static SkidMarkIndex=0;static SkidMarkMesh=null;static SkidMarkUpdated=false;static TempVector3_POS=new BABYLON.Vector3(0,0,0);static TempVector3_DIR=new BABYLON.Vector3(0,0,0);static TempVector3_XDIR=new BABYLON.Vector3(0,0,0);static TempVector3_SDIR=new BABYLON.Vector3(0,0,0);constructor(transform,scene,properties={},alias="PROJECT.SkidMarkManager"){super(transform,scene,properties,alias);SkidMarkManager.MAX_MARKS=this.getProperty("maxSections",SkidMarkManager.MAX_MARKS);SkidMarkManager.MARK_COLOR=TOOLKIT.Utilities.ParseColor3(this.getProperty("textureColor"),SkidMarkManager.MARK_COLOR);SkidMarkManager.MARK_WIDTH=this.getProperty("textureWidth",SkidMarkManager.MARK_WIDTH);SkidMarkManager.GROUND_OFFSET=this.getProperty("groundOffset",SkidMarkManager.GROUND_OFFSET);SkidMarkManager.GPU_TRIANGLES=this.getProperty("gpuQuadIndices",SkidMarkManager.GPU_TRIANGLES);SkidMarkManager.TEXTURE_MARKS=this.getProperty("textureMarks",SkidMarkManager.TEXTURE_MARKS);SkidMarkManager.TEX_INTENSITY=this.getProperty("textureIntensity",SkidMarkManager.TEX_INTENSITY);SkidMarkManager.MIN_DISTANCE=this.getProperty("textureDistance",SkidMarkManager.MIN_DISTANCE);SkidMarkManager.MIN_SQR_DISTANCE=(SkidMarkManager.MIN_DISTANCE*SkidMarkManager.MIN_DISTANCE)}start(){SkidMarkManager.CreateSkidMarkManager(this.scene)}update(){SkidMarkManager.UpdateSkidMarkManager()}static AddSkidMarkSegment(pos,normal,intensity,lastIndex){if(SkidMarkManager.SkidMarkMesh==null)return null;SkidMarkManager.TempVector3_POS.set(0,0,0);SkidMarkManager.TempVector3_DIR.set(0,0,0);SkidMarkManager.TempVector3_XDIR.set(0,0,0);SkidMarkManager.TempVector3_SDIR.set(0,0,0);if(intensity>1.0)intensity=1.0;else if(intensity<0.0)return-1.0;if(lastIndex>0){pos.subtractToRef(SkidMarkManager.SkidMarkSections[lastIndex].Pos,SkidMarkManager.TempVector3_POS);const sqrDistance=SkidMarkManager.TempVector3_POS.lengthSquared();if(sqrDistance<SkidMarkManager.MIN_SQR_DISTANCE)return lastIndex}const curSection=SkidMarkManager.SkidMarkSections[SkidMarkManager.SkidMarkIndex];normal.scaleToRef(SkidMarkManager.GROUND_OFFSET,SkidMarkManager.TempVector3_POS);pos.addToRef(SkidMarkManager.TempVector3_POS,curSection.Pos);curSection.Normal.copyFrom(normal);curSection.Intensity=(intensity*SkidMarkManager.TEX_INTENSITY);curSection.LastIndex=lastIndex;if(lastIndex!=-1){const lastSection=SkidMarkManager.SkidMarkSections[lastIndex];curSection.Pos.subtractToRef(lastSection.Pos,SkidMarkManager.TempVector3_DIR);BABYLON.Vector3.CrossToRef(SkidMarkManager.TempVector3_DIR,normal,SkidMarkManager.TempVector3_XDIR);SkidMarkManager.TempVector3_XDIR.normalizeToRef(SkidMarkManager.TempVector3_XDIR);SkidMarkManager.TempVector3_XDIR.scaleToRef(SkidMarkManager.MARK_WIDTH*0.5,SkidMarkManager.TempVector3_SDIR);curSection.Pos.addToRef(SkidMarkManager.TempVector3_SDIR,curSection.Posl);curSection.Pos.subtractToRef(SkidMarkManager.TempVector3_SDIR,curSection.Posr);curSection.Tangent.set(SkidMarkManager.TempVector3_XDIR.x,SkidMarkManager.TempVector3_XDIR.y,SkidMarkManager.TempVector3_XDIR.z,1);if(lastSection.LastIndex===-1){curSection.Pos.addToRef(SkidMarkManager.TempVector3_SDIR,lastSection.Posl);curSection.Pos.subtractToRef(SkidMarkManager.TempVector3_SDIR,lastSection.Posr);lastSection.Tangent.copyFrom(curSection.Tangent)}}SkidMarkManager.AddSkidMarkVertexData();const curIndex=SkidMarkManager.SkidMarkIndex;SkidMarkManager.SkidMarkIndex=++SkidMarkManager.SkidMarkIndex%SkidMarkManager.MAX_MARKS;return curIndex}static CreateSkidMarkManager(scene){if(SkidMarkManager.SkidMarkMesh==null){const skidmarkMaterial=new BABYLON.StandardMaterial("SkidMarkMaterial",scene);skidmarkMaterial.backFaceCulling=false;skidmarkMaterial.disableLighting=true;skidmarkMaterial.emissiveColor=SkidMarkManager.MARK_COLOR;skidmarkMaterial.diffuseColor=SkidMarkManager.MARK_COLOR;skidmarkMaterial.diffuseTexture=TOOLKIT.Utilities.ParseTexture(SkidMarkManager.TEXTURE_MARKS,scene);if(skidmarkMaterial.diffuseTexture!=null){skidmarkMaterial.diffuseTexture.hasAlpha=true;skidmarkMaterial.useAlphaFromDiffuseTexture=true}skidmarkMaterial.freeze();SkidMarkManager.SkidMarkMesh=new BABYLON.Mesh("SkidMarkMesh",scene);SkidMarkManager.SkidMarkMesh.material=skidmarkMaterial;SkidMarkManager.SkidMarkMesh.renderingGroupId=TOOLKIT.Utilities.DefaultRenderGroup();SkidMarkManager.SkidMarkMesh.alwaysSelectAsActiveMesh=true;SkidMarkManager.SkidMarkMesh.doNotSyncBoundingInfo=true;SkidMarkManager.SkidMarkMesh.receiveShadows=false;SkidMarkManager.SkidMarkMesh.checkCollisions=false;SkidMarkManager.SkidMarkMesh.useVertexColors=true;SkidMarkManager.SkidMarkMesh.hasVertexAlpha=true;SkidMarkManager.SkidMarkMesh.isPickable=false;SkidMarkManager.SkidMarkSections=new Array(SkidMarkManager.MAX_MARKS);for(let i=0;i<SkidMarkManager.SkidMarkSections.length;i++){SkidMarkManager.SkidMarkSections[i]=new SkidMarkSection}SkidMarkManager.SkidBufferPositions=new Float32Array(SkidMarkManager.MAX_MARKS*4*3);SkidMarkManager.SkidBufferNormals=new Float32Array(SkidMarkManager.MAX_MARKS*4*3);SkidMarkManager.SkidBufferTangents=new Float32Array(SkidMarkManager.MAX_MARKS*4*4);SkidMarkManager.SkidBufferColors=new Float32Array(SkidMarkManager.MAX_MARKS*4*4);SkidMarkManager.SkidBufferUvs=new Float32Array(SkidMarkManager.MAX_MARKS*4*2);SkidMarkManager.SkidBufferIndices=new Int32Array(SkidMarkManager.MAX_MARKS*6);const vertexData=new BABYLON.VertexData;vertexData.positions=SkidMarkManager.SkidBufferPositions;vertexData.normals=SkidMarkManager.SkidBufferNormals;vertexData.tangents=SkidMarkManager.SkidBufferTangents;vertexData.colors=SkidMarkManager.SkidBufferColors;vertexData.uvs=SkidMarkManager.SkidBufferUvs;vertexData.indices=SkidMarkManager.SkidBufferIndices;vertexData.applyToMesh(SkidMarkManager.SkidMarkMesh,true);SkidMarkManager.SkidMarkMesh.freezeWorldMatrix()}}static AddSkidMarkVertexData(){const curr=SkidMarkManager.SkidMarkSections[SkidMarkManager.SkidMarkIndex];if(curr.LastIndex===-1)return;const last=SkidMarkManager.SkidMarkSections[curr.LastIndex];SkidMarkManager.SkidMarkUpdated=true;let index=SkidMarkManager.SkidMarkIndex*4+0;SkidMarkManager.SkidBufferPositions[index*3]=last.Posl.x;SkidMarkManager.SkidBufferPositions[(index*3)+1]=last.Posl.y;SkidMarkManager.SkidBufferPositions[(index*3)+2]=last.Posl.z;index=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferPositions[index*3]=last.Posr.x;SkidMarkManager.SkidBufferPositions[(index*3)+1]=last.Posr.y;SkidMarkManager.SkidBufferPositions[(index*3)+2]=last.Posr.z;index=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferPositions[index*3]=curr.Posl.x;SkidMarkManager.SkidBufferPositions[(index*3)+1]=curr.Posl.y;SkidMarkManager.SkidBufferPositions[(index*3)+2]=curr.Posl.z;index=SkidMarkManager.SkidMarkIndex*4+3;SkidMarkManager.SkidBufferPositions[index*3]=curr.Posr.x;SkidMarkManager.SkidBufferPositions[(index*3)+1]=curr.Posr.y;SkidMarkManager.SkidBufferPositions[(index*3)+2]=curr.Posr.z;index=SkidMarkManager.SkidMarkIndex*4+0;SkidMarkManager.SkidBufferNormals[index*3]=last.Normal.x;SkidMarkManager.SkidBufferNormals[(index*3)+1]=last.Normal.y;SkidMarkManager.SkidBufferNormals[(index*3)+2]=last.Normal.z;index=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferNormals[index*3]=last.Normal.x;SkidMarkManager.SkidBufferNormals[(index*3)+1]=last.Normal.y;SkidMarkManager.SkidBufferNormals[(index*3)+2]=last.Normal.z;index=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferNormals[index*3]=curr.Normal.x;SkidMarkManager.SkidBufferNormals[(index*3)+1]=curr.Normal.y;SkidMarkManager.SkidBufferNormals[(index*3)+2]=curr.Normal.z;index=SkidMarkManager.SkidMarkIndex*4+3;SkidMarkManager.SkidBufferNormals[index*3]=curr.Normal.x;SkidMarkManager.SkidBufferNormals[(index*3)+1]=curr.Normal.y;SkidMarkManager.SkidBufferNormals[(index*3)+2]=curr.Normal.z;index=SkidMarkManager.SkidMarkIndex*4+0;SkidMarkManager.SkidBufferTangents[index*4]=last.Tangent.x;SkidMarkManager.SkidBufferTangents[(index*4)+1]=last.Tangent.y;SkidMarkManager.SkidBufferTangents[(index*4)+2]=last.Tangent.z;SkidMarkManager.SkidBufferTangents[(index*4)+3]=last.Tangent.w;index=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferTangents[index*4]=last.Tangent.x;SkidMarkManager.SkidBufferTangents[(index*4)+1]=last.Tangent.y;SkidMarkManager.SkidBufferTangents[(index*4)+2]=last.Tangent.z;SkidMarkManager.SkidBufferTangents[(index*4)+3]=last.Tangent.w;index=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferTangents[index*4]=curr.Tangent.x;SkidMarkManager.SkidBufferTangents[(index*4)+1]=curr.Tangent.y;SkidMarkManager.SkidBufferTangents[(index*4)+2]=curr.Tangent.z;SkidMarkManager.SkidBufferTangents[(index*4)+3]=curr.Tangent.w;index=SkidMarkManager.SkidMarkIndex*4+3;SkidMarkManager.SkidBufferTangents[index*4]=curr.Tangent.x;SkidMarkManager.SkidBufferTangents[(index*4)+1]=curr.Tangent.y;SkidMarkManager.SkidBufferTangents[(index*4)+2]=curr.Tangent.z;SkidMarkManager.SkidBufferTangents[(index*4)+3]=curr.Tangent.w;index=SkidMarkManager.SkidMarkIndex*4+0;SkidMarkManager.SkidBufferColors[index*4]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+1]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+2]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+3]=last.Intensity;index=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferColors[index*4]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+1]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+2]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+3]=last.Intensity;index=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferColors[index*4]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+1]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+2]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+3]=curr.Intensity;index=SkidMarkManager.SkidMarkIndex*4+3;SkidMarkManager.SkidBufferColors[index*4]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+1]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+2]=1.0;SkidMarkManager.SkidBufferColors[(index*4)+3]=curr.Intensity;index=SkidMarkManager.SkidMarkIndex*4+0;SkidMarkManager.SkidBufferUvs[index*2]=0;SkidMarkManager.SkidBufferUvs[(index*2)+1]=0;index=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferUvs[index*2]=1;SkidMarkManager.SkidBufferUvs[(index*2)+1]=0;index=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferUvs[index*2]=0;SkidMarkManager.SkidBufferUvs[(index*2)+1]=1;index=SkidMarkManager.SkidMarkIndex*4+3;SkidMarkManager.SkidBufferUvs[index*2]=1;SkidMarkManager.SkidBufferUvs[(index*2)+1]=1;SkidMarkManager.SkidBufferIndices[SkidMarkManager.SkidMarkIndex*6+0]=SkidMarkManager.SkidMarkIndex*4+0;SkidMarkManager.SkidBufferIndices[SkidMarkManager.SkidMarkIndex*6+2]=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferIndices[SkidMarkManager.SkidMarkIndex*6+1]=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferIndices[SkidMarkManager.SkidMarkIndex*6+3]=SkidMarkManager.SkidMarkIndex*4+2;SkidMarkManager.SkidBufferIndices[SkidMarkManager.SkidMarkIndex*6+5]=SkidMarkManager.SkidMarkIndex*4+1;SkidMarkManager.SkidBufferIndices[SkidMarkManager.SkidMarkIndex*6+4]=SkidMarkManager.SkidMarkIndex*4+3}static UpdateSkidMarkManager(){if(SkidMarkManager.SkidMarkMesh!=null&&SkidMarkManager.SkidMarkUpdated===true){SkidMarkManager.SkidMarkUpdated=false;if(SkidMarkManager.SkidMarkMesh.geometry!=null){SkidMarkManager.SkidMarkMesh.geometry.updateVerticesDataDirectly(BABYLON.VertexBuffer.PositionKind,SkidMarkManager.SkidBufferPositions,0,false);SkidMarkManager.SkidMarkMesh.geometry.updateVerticesDataDirectly(BABYLON.VertexBuffer.NormalKind,SkidMarkManager.SkidBufferNormals,0,false);SkidMarkManager.SkidMarkMesh.geometry.updateVerticesDataDirectly(BABYLON.VertexBuffer.TangentKind,SkidMarkManager.SkidBufferTangents,0,false);SkidMarkManager.SkidMarkMesh.geometry.updateVerticesDataDirectly(BABYLON.VertexBuffer.ColorKind,SkidMarkManager.SkidBufferColors,0,false);SkidMarkManager.SkidMarkMesh.geometry.updateVerticesDataDirectly(BABYLON.VertexBuffer.UVKind,SkidMarkManager.SkidBufferUvs,0,false);SkidMarkManager.SkidMarkMesh.geometry.updateIndices(SkidMarkManager.SkidBufferIndices,0,SkidMarkManager.GPU_TRIANGLES)}}}}PROJECT.SkidMarkManager=SkidMarkManager;TOOLKIT.SceneManager.RegisterClass("PROJECT.SkidMarkManager",SkidMarkManager)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class StandardCarController extends TOOLKIT.ScriptComponent{static DEFAULT_SKID_FACTOR=1.0;static DEFAULT_PITCH_FACTOR=1.0;static DEFAULT_SPEED_FACTOR=1.0;static DEFAULT_DONUT_FACTOR=1.0;static SimplexNoise2D=TOOLKIT.SimplexNoise.createNoise2D();MIN_RPM=800;MAX_RPM=8000;_animator=null;_rigidbody=null;_engineAudioSource=null;_skidAudioSource=null;_nosAudioSource=null;steeringWheelHub=null;steeringWheelAxis=2;maxSteeringAngle=65.0;maxSteeringSpeed=15.0;minSkiddingSpeed=25.0;gearIndex=0;shiftingTime=0;shiftingSide=1;shiftingBrake=1.0;engineForce=0;handBraking=false;linearDamping=0;forwardSpeed=0;absoluteSpeed=0;americanSpeed=0;gradientSpeed=0;frontWheelPower=0;backWheelPower=0;wheelBrakingForce=0;enginePitchLevel=0;smokeIntensityFactor=0;raycastVehicle=null;brakeLightsMesh=null;brakeLightsTrans=null;reverseLightsMesh=null;reverseLightsTrans=null;frontLeftWheelTrans=null;frontRightWheelTrans=null;backLeftWheelTrans=null;backRightWheelTrans=null;frontLeftWheelMesh=null;frontRightWheelMesh=null;backLeftWheelMesh=null;backRightWheelMesh=null;frontLeftWheelEmitter=null;frontRightWheelEmitter=null;backLeftWheelEmitter=null;backRightWheelEmitter=null;frontLeftWheelParticle=null;frontRightWheelParticle=null;backLeftWheelParticle=null;backRightWheelParticle=null;frontLeftWheelCollider=null;frontRightWheelCollider=null;backLeftWheelCollider=null;backRightWheelCollider=null;engineTorqueCurve=null;physicsSteerAngleL=0;physicsSteerAngleR=0;visualSteerAngleL=0;visualSteerAngleR=0;visualSteerBoostL=0;visualSteerBoostR=0;idleNoiseDelta=0;driveNoiseDelta=0;boostSpeedTimer=0;burnoutMeter=0;donutMeter=0;wheelRadius=0;engineRPM=0;pitchRPM=0;shiftRPM=0;SKID_FL=0;SKID_FR=0;SKID_RL=0;SKID_RR=0;PITCH_FL=0;PITCH_FR=0;PITCH_RL=0;PITCH_RR=0;FRONT_LEFT=-1;FRONT_RIGHT=-1;BACK_LEFT=-1;BACK_RIGHT=-1;WHEEL_SKID_PITCH=0;POWER_BOOST_PITCH=0;wheelRPM=0;transmissionInputRPM=0;actualEngineRPM=0;targetEngineRPM=0;throttleRPM=0;engineLoad=0;gearShiftCooldown=0;isShifting=false;shiftDirection=0;clutchEngagement=1.0;engineBraking=0;shiftHysteresis=200;velocityCompensation=new BABYLON.Vector3(0,0,0);SPIN_FL_Rotation=new BABYLON.Vector3(0,0,0);SPIN_FR_Rotation=new BABYLON.Vector3(0,0,0);SPIN_RL_Rotation=new BABYLON.Vector3(0,0,0);SPIN_RR_Rotation=new BABYLON.Vector3(0,0,0);isBraking(){return(this.getFootBraking()||this.getHandBraking())}isBoosting(){return this.currentBoosting}getFootBraking(){return(this.currentForward<0&&this.forwardSpeed>=0)}getHandBraking(){return this.handBraking}getLinearVelocity(){return this.m_linearVelocity}getCurrentForward(){return this.currentForward}getCurrentTurning(){return this.currentTurning}getCurrentSkidding(){return this.currentSkidding}getBurnoutButton(){return this.burnoutButton}getReverseThrottle(){return(this.currentForward<0&&this.forwardSpeed<0)}getEnginePitchLevel(){return this.enginePitchLevel}getCurrentBurnout(){return this.wheelBurnout||this.restoreTimer>0}getFrontLeftSkid(){return this.SKID_FL}getFrontRightSkid(){return this.SKID_FR}getBackLeftSkid(){return this.SKID_RL}getBackRightSkid(){return this.SKID_RR}getWheelSkidPitch(){return this.WHEEL_SKID_PITCH}getRigidbodyPhysics(){return this._rigidbody}getRaycastVehicle(){return this.raycastVehicle}getGradientSpeed(){return this.gradientSpeed}getForwardSpeed(){return this.forwardSpeed}getAbsoluteSpeed(){return this.absoluteSpeed}getAmericanSpeed(){return this.americanSpeed}getTopEngineSpeed(){return(this.currentBoosting===true)?this.topBoosterSpeed:this.topEngineSpeed}getNormalizedSpeed(){return this.americanSpeed/this.getTopEngineSpeed()}getMaxReversePower(){return this.maxReversePower}getCurrentGearIndex(){return this.gearIndex}getCurrentEngineRPM(){return this.engineRPM}getCurrentEngineForce(){return this.engineForce}getCurrentEnginePitch(){return BABYLON.Scalar.Clamp((this.pitchRPM/this.MAX_RPM)+0.1)}getGearShiftRatioCount(){return(this.gearBoxShiftRatios!=null)?this.gearBoxShiftRatios.length:0}getSmokeTextureMask(){return this.smokeTexture}getBrakeLightsMesh(){return this.brakeLightsMesh}getReverseLightsMesh(){return this.reverseLightsMesh}getFrontLeftWheelNode(){return this.frontLeftWheelMesh}getFrontRightWheelNode(){return this.frontRightWheelMesh}getBackLeftWheelNode(){return this.backLeftWheelMesh}getBackRightWheelNode(){return this.backRightWheelMesh}getWheelBurnoutEnabled(){return this.wheelBurnout}getWheelDonutsEnabled(){return this.wheelDonuts}getCurrentDonutSpinTime(){return this.donutSpinTime}getSmokeIntensityFactor(){return this.smokeIntensityFactor}getWheelVelocityOffset(){return this.m_velocityOffset}smokeTexture=null;skidThreashold=0.65;wheelDrawVelocity=0.02;smokeIntensity=150;smokeOpacity=0.1;smokeDonuts=2.0;noiseTimeScale=1.0;noiseTimeFactor=0;maxSteerBoost=6;overSteerSpeed=1.0;overSteerTimeout=0.2;topEngineSpeed=160;topBoosterSpeed=220;powerChangeRate=12.0;powerCoefficient=1.0;boosterCoefficient=1.5;frictionLerpSpeed=0.25;burnoutLerpSpeed=0.01;topSpeedDampener=0.15;lowSpeedSteering=5.0;highSpeedSteering=5.0;donutEngineFactor=1.0;donutTurningRadius=6.0;donutTransitionSpeed=0.05;burnoutRotationBoost=6.0;donutRotationBoost=8.0;skiddingTurnAssist=8.50;handbrakePreserve=0.85;burnoutFirstGearMultiplier=1.0;raycastDriveType=0;maxRadiusMultiplier=2.0;stabilizeVelocity=false;gravitationalForce=3;smoothFlyingForce=250;transmissionRatio=0.75;differentialRatio=3.55;minBoosterSpeed=25.0;maxBoosterTime=10.0;maxFrontBraking=0.0;maxReversePower=1.0;handBrakingForce=2500;handBrakingTimer=0;skidRotationTimeout=1.0;linearBrakingForce=15.0;burnoutFrictionSlip=0.8;burnoutFrictionGrip=1.2;burnoutCooldownTime=1.0;burnoutTimeDelay=1.0;burnoutWheelPitch=0.85;burnoutCoefficient=15;burnoutTriggerMark=10;burnoutTransition=0.01;enableAutoBurnouts=false;driftTriggerAngle=30.0;driftTriggerSpeed=30.0;enableAutoDrifting=false;penaltyGroundTag="Offroad";minPenaltySpeed=65;linearWheelDrag=0.03;penaltyWheelSlip=0.175;showSensorLines=false;powerBooster=false;linkTrackManager=true;playVehicleSounds=true;postNetworkAttributes=false;wheelDriveType=0;currentPitchScale=1.0;gearBoxPitchScale=1.0;gearBoxShiftDelay=0.5;gearBoxShiftRatios=[3.60,2.10,1.45,1.08,0.88,0.70];gearBoxShiftUpRanges=[55,90,130,155,170,999];gearBoxShiftDownRanges=[0,35,70,110,140,160];throttleBrakingForce=0;throttleEngineSpeed=0;maxSkiddingTimer=1.0;brakeRecoveryDelay=0.05;brakeRecoverySpeed=0.35;extraRotationSpeed=0.01;maxRotationSpeed=2.0;ackermanWheelBase=2.5;ackermanRearTrack=1.5;ackermanTurnRadius=9;ackermanMaxRadius=18;ackermanTurnFactor=1;readBurnoutMeter(){return this.burnoutMeter}resetBurnoutMeter(){this.burnoutMeter=0}readDonutMeter(){return this.donutMeter}resetDonutMeter(){this.donutMeter=0}getBoosterTime(){return this.boostSpeedTimer}setBoosterTime(time){this.boostSpeedTimer=time}resetBoosterTime(){this.setBoosterTime(this.maxBoosterTime)}roadSurfaceFactor=1.0;movementTilting=false;surfaceDetection=false;idleShakeRate=5.0;idleShakeNoise=0.01;maxForwardAngle=3.0;maxLateralAngle=3.0;lerpForwardFactor=10.0;lerpLateralFactor=10.0;shiftForwardExtra=0.2;shiftLateralExtra=0.2;forwardPitchFactor=0.2;lateralRollFactor=0.2;forwardRecoverRate=0.2;lateralRecoverRate=0.2;lowSpeedScale=1.0;highSpeedScale=5.0;lowForwardNoise=0.05;highForwardNoise=0.05;lowLateralNoise=0.05;highLateralNoise=0.05;speedThreashold=5.0;boosterTransform=null;chassisTransform=null;tiltChassisEulers=new BABYLON.Vector3(0,0,0);maxWheelDistanceFactor=8.0;minUpwardAngleFactor=0.2;m_frontLeftWheel=null;m_frontRightWheel=null;m_backLeftWheel=null;m_backRightWheel=null;m_frontLeftWheelSkid=-1;m_frontRightWheelSkid=-1;m_backLeftWheelSkid=-1;m_backRightWheelSkid=-1;m_angularDampener=new BABYLON.Vector3(1.0,1.0,1.0);m_velocityOffset=new BABYLON.Vector3(0,0,0);m_linearVelocity=new BABYLON.Vector3(0,0,0);m_lastPosition=new BABYLON.Vector3(0,0,0);m_scaledVelocity=0;constructor(transform,scene,properties={},alias="PROJECT.StandardCarController"){super(transform,scene,properties,alias)}awake(){this.awakeVehicleState()}start(){this.initVehicleState()}update(){this.updateVehicleState()}destroy(){this.destroyVehicleState()}awakeVehicleState(){this.engineForce=0;this.frontWheelPower=0;this.backWheelPower=0;this.wheelBrakingForce=0;this.throttleRPM=this.MIN_RPM;this.raycastDriveType=this.getProperty("raycastDriveType",this.raycastDriveType);this.maxRadiusMultiplier=this.getProperty("maxRadiusMultiplier",this.maxRadiusMultiplier);this.stabilizeVelocity=this.getProperty("stabilizeVelocity",this.stabilizeVelocity);this.ackermanWheelBase=this.getProperty("ackermanWheelBase",this.ackermanWheelBase);this.ackermanRearTrack=this.getProperty("ackermanRearTrack",this.ackermanRearTrack);this.ackermanTurnRadius=this.getProperty("ackermanTurnRadius",this.ackermanTurnRadius);this.ackermanMaxRadius=this.getProperty("ackermanMaxRadius",this.ackermanMaxRadius);this.wheelDrawVelocity=this.getProperty("wheelDrawVelocity",this.wheelDrawVelocity);this.skidThreashold=this.getProperty("skidThreashold",this.skidThreashold);this.smokeIntensity=this.getProperty("smokeIntensity",this.smokeIntensity);this.smokeOpacity=this.getProperty("smokeOpacity",this.smokeOpacity);this.smokeDonuts=this.getProperty("smokeDonuts",this.smokeDonuts);this.powerBooster=this.getProperty("powerBooster",this.powerBooster);this.movementTilting=this.getProperty("movementTilting",this.movementTilting);this.surfaceDetection=this.getProperty("surfaceDetection",this.surfaceDetection);this.idleShakeNoise=this.getProperty("idleShakeNoise",this.idleShakeNoise);this.idleShakeRate=this.getProperty("idleShakeRate",this.idleShakeRate);this.maxForwardAngle=this.getProperty("maxForwardAngle",this.maxForwardAngle);this.maxLateralAngle=this.getProperty("maxLateralAngle",this.maxLateralAngle);this.forwardPitchFactor=this.getProperty("forwardPitchFactor",this.forwardPitchFactor);this.lateralRollFactor=this.getProperty("lateralRollFactor",this.lateralRollFactor);this.forwardRecoverRate=this.getProperty("forwardRecoverRate",this.forwardRecoverRate);this.lateralRecoverRate=this.getProperty("lateralRecoverRate",this.lateralRecoverRate);this.lowSpeedScale=this.getProperty("lowSpeedScale",this.lowSpeedScale);this.highSpeedScale=this.getProperty("highSpeedScale",this.highSpeedScale);this.lowForwardNoise=this.getProperty("lowForwardNoise",this.lowForwardNoise);this.highForwardNoise=this.getProperty("highForwardNoise",this.highForwardNoise);this.lowLateralNoise=this.getProperty("lowLateralNoise",this.lowLateralNoise);this.highLateralNoise=this.getProperty("highLateralNoise",this.highLateralNoise);this.speedThreashold=this.getProperty("speedThreashold",this.speedThreashold);this.lerpForwardFactor=this.getProperty("lerpForwardFactor",this.lerpForwardFactor);this.lerpLateralFactor=this.getProperty("lerpLateralFactor",this.lerpLateralFactor);this.shiftForwardExtra=this.getProperty("shiftForwardExtra",this.shiftForwardExtra);this.shiftLateralExtra=this.getProperty("shiftLateralExtra",this.shiftLateralExtra);this.topEngineSpeed=this.getProperty("topEngineSpeed",this.topEngineSpeed);this.topBoosterSpeed=this.getProperty("topBoosterSpeed",this.topBoosterSpeed);this.powerChangeRate=this.getProperty("powerChangeRate",this.powerChangeRate);this.powerCoefficient=this.getProperty("powerCoefficient",this.powerCoefficient);this.boosterCoefficient=this.getProperty("boosterCoefficient",this.boosterCoefficient);this.maxBoosterTime=this.getProperty("maxBoosterTime",this.maxBoosterTime);this.minBoosterSpeed=this.getProperty("minBoosterSpeed",this.minBoosterSpeed);this.maxFrontBraking=this.getProperty("maxFrontBraking",this.maxFrontBraking);this.maxReversePower=this.getProperty("maxReversePower",this.maxReversePower);this.minSkiddingSpeed=this.getProperty("minSkiddingSpeed",this.minSkiddingSpeed);this.penaltyGroundTag=this.getProperty("penaltyGroundTag",this.penaltyGroundTag);this.minPenaltySpeed=this.getProperty("minPenaltySpeed",this.minPenaltySpeed);this.linearWheelDrag=this.getProperty("linearWheelDrag",this.linearWheelDrag);this.penaltyWheelSlip=this.getProperty("penaltyWheelSlip",this.penaltyWheelSlip);this.showSensorLines=this.getProperty("showSensorLines",this.showSensorLines);this.gravitationalForce=this.getProperty("gravityMultiplier",this.gravitationalForce);this.smoothFlyingForce=this.getProperty("smoothFlyingForce",this.smoothFlyingForce);this.frictionLerpSpeed=this.getProperty("frictionLerpSpeed",this.frictionLerpSpeed);this.burnoutLerpSpeed=this.getProperty("burnoutLerpSpeed",this.burnoutLerpSpeed);this.maxSteerBoost=this.getProperty("maxSteerBoost",this.maxSteerBoost);this.overSteerSpeed=this.getProperty("overSteerSpeed",this.overSteerSpeed);this.overSteerTimeout=this.getProperty("overSteerTimeout",this.overSteerTimeout);this.wheelDriveType=this.getProperty("wheelDriveType",this.wheelDriveType);this.maxSkiddingTimer=this.getProperty("maxSkiddingTimer",this.maxSkiddingTimer);this.handBrakingForce=this.getProperty("handBrakingForce",this.handBrakingForce);this.brakeRecoveryDelay=this.getProperty("brakeRecoveryDelay",this.brakeRecoveryDelay);this.brakeRecoverySpeed=this.getProperty("brakeRecoverySpeed",this.brakeRecoverySpeed);this.maxRotationSpeed=this.getProperty("maxRotationSpeed",this.maxRotationSpeed);this.extraRotationSpeed=this.getProperty("extraRotationSpeed",this.extraRotationSpeed);this.skidRotationTimeout=this.getProperty("skidRotationTimeout",this.skidRotationTimeout);this.linearBrakingForce=this.getProperty("linearBrakingForce",this.linearBrakingForce);this.steeringWheelAxis=this.getProperty("steeringWheelAxis",this.steeringWheelAxis);this.maxSteeringAngle=this.getProperty("maxSteeringAngle",this.maxSteeringAngle);this.maxSteeringSpeed=this.getProperty("maxSteeringSpeed",this.maxSteeringSpeed);this.topSpeedDampener=this.getProperty("topSpeedDampener",this.topSpeedDampener);this.lowSpeedSteering=this.getProperty("lowSpeedSteering",this.lowSpeedSteering);this.highSpeedSteering=this.getProperty("highSpeedSteering",this.highSpeedSteering);this.burnoutRotationBoost=this.getProperty("burnoutRotationBoost",this.burnoutRotationBoost);this.donutEngineFactor=this.getProperty("donutEngineFactor",this.donutEngineFactor);this.donutRotationBoost=this.getProperty("donutRotationBoost",this.donutRotationBoost);this.donutTurningRadius=this.getProperty("donutTurningRadius",this.donutTurningRadius);this.donutTransitionSpeed=this.getProperty("donutTransitionSpeed",this.donutTransitionSpeed);this.skiddingTurnAssist=this.getProperty("skiddingTurnAssist",this.skiddingTurnAssist);this.handbrakePreserve=this.getProperty("handbrakePreserve",this.handbrakePreserve);this.brakeLightsTrans=this.getProperty("brakeLightsMesh",this.brakeLightsTrans);this.reverseLightsTrans=this.getProperty("reverseLightsMesh",this.reverseLightsTrans);this.frontLeftWheelTrans=this.getProperty("frontLeftWheelMesh",this.frontLeftWheelTrans);this.frontRightWheelTrans=this.getProperty("frontRightWheelMesh",this.frontRightWheelTrans);this.backLeftWheelTrans=this.getProperty("rearLeftWheelMesh",this.backLeftWheelTrans);this.backRightWheelTrans=this.getProperty("rearRightWheelMesh",this.backRightWheelTrans);this.frontLeftWheelCollider=this.getProperty("frontLeftWheelCollider",this.frontLeftWheelCollider);this.frontRightWheelCollider=this.getProperty("frontRightWheelCollider",this.frontRightWheelCollider);this.backLeftWheelCollider=this.getProperty("rearLeftWheelCollider",this.backLeftWheelCollider);this.backRightWheelCollider=this.getProperty("rearRightWheelCollider",this.backRightWheelCollider);this.burnoutFrictionSlip=this.getProperty("burnoutFrictionSlip",this.burnoutFrictionSlip);this.burnoutFrictionGrip=this.getProperty("burnoutFrictionGrip",this.burnoutFrictionGrip);this.burnoutCooldownTime=this.getProperty("burnoutCooldownTime",this.burnoutCooldownTime);this.burnoutTimeDelay=this.getProperty("burnoutTimeDelay",this.burnoutTimeDelay);this.burnoutTransition=this.getProperty("burnoutTransition",this.burnoutTransition);this.burnoutWheelPitch=this.getProperty("burnoutWheelPitch",this.burnoutWheelPitch);this.burnoutCoefficient=this.getProperty("burnoutCoefficient",this.burnoutCoefficient);this.burnoutTriggerMark=this.getProperty("burnoutTriggerMark",this.burnoutTriggerMark);this.enableAutoBurnouts=this.getProperty("enableAutoBurnouts",this.enableAutoBurnouts);this.driftTriggerAngle=this.getProperty("driftTriggerAngle",this.driftTriggerAngle);this.driftTriggerSpeed=this.getProperty("driftTriggerSpeed",this.driftTriggerSpeed);this.enableAutoDrifting=this.getProperty("enableAutoDrifting",this.enableAutoDrifting);this.postNetworkAttributes=this.getProperty("postNetworkAttributes",this.postNetworkAttributes);this.linkTrackManager=this.getProperty("linkTrackManager",this.linkTrackManager);this.playVehicleSounds=this.getProperty("playVehicleSounds",this.playVehicleSounds);this.differentialRatio=this.getProperty("gearBoxDifferential",this.differentialRatio);this.transmissionRatio=this.getProperty("gearBoxOverdrive",this.transmissionRatio);this.gearBoxPitchScale=this.getProperty("gearBoxPitchScale",this.gearBoxPitchScale);this.gearBoxShiftDelay=this.getProperty("gearBoxShiftDelay",this.gearBoxShiftDelay);this.gearBoxShiftRatios=this.getProperty("gearBoxShiftRatios",this.gearBoxShiftRatios);this.gearBoxShiftUpRanges=this.getProperty("gearBoxShiftUpRanges",this.gearBoxShiftUpRanges);this.gearBoxShiftDownRanges=this.getProperty("gearBoxShiftDownRanges",this.gearBoxShiftDownRanges);this.MIN_RPM=this.getProperty("gearBoxMinPower",this.MIN_RPM);this.MAX_RPM=this.getProperty("gearBoxMaxPower",this.MAX_RPM);if(this.topSpeedDampener<=0)this.topSpeedDampener=0.15;if(this.gravitationalForce<=0)this.gravitationalForce=3;if(this.smoothFlyingForce<=0)this.smoothFlyingForce=0;if(this.maxFrontBraking<=0)this.maxFrontBraking=0;if(this.maxReversePower<=0)this.maxReversePower=0.5;if(this.lowSpeedSteering<=0)this.lowSpeedSteering=5.0;if(this.highSpeedSteering<=0)this.highSpeedSteering=5.0;if(this.powerCoefficient<=0)this.powerCoefficient=1.0;if(this.topEngineSpeed<=0)this.topEngineSpeed=180;if(this.topBoosterSpeed<=0)this.topBoosterSpeed=150;if(this.gearBoxPitchScale<=0)this.gearBoxPitchScale=1.0;if(this.gearBoxShiftDelay<=0)this.gearBoxShiftDelay=0.35;if(this.transmissionRatio<=0)this.transmissionRatio=1;if(this.differentialRatio<=0)this.differentialRatio=1;if(this.frictionLerpSpeed<=0)this.frictionLerpSpeed=0.25;if(this.burnoutLerpSpeed<=0)this.burnoutLerpSpeed=0.1;if(this.burnoutTimeDelay<=0)this.burnoutTimeDelay=1;if(this.burnoutWheelPitch<=0)this.burnoutWheelPitch=1;if(this.maxRotationSpeed<=0)this.maxRotationSpeed=1;if(this.minBoosterSpeed<=0)this.minBoosterSpeed=0;if(this.maxBoosterTime<=0)this.maxBoosterTime=0;this.setBoosterTime(this.maxBoosterTime);const vehicleChassisTransform=this.getProperty("chassisTransform");if(vehicleChassisTransform!=null&&vehicleChassisTransform.name!=null&&vehicleChassisTransform.name!==""){this.chassisTransform=this.getChildNode(vehicleChassisTransform.name,TOOLKIT.SearchType.IndexOf,false)}const powerBoosterTransform=this.getProperty("boosterTransform");if(powerBoosterTransform!=null&&powerBoosterTransform.name!=null&&powerBoosterTransform.name!==""){this.boosterTransform=this.getChildNode(powerBoosterTransform.name,TOOLKIT.SearchType.IndexOf,false);if(this.boosterTransform!=null)this._nosAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.boosterTransform,"TOOLKIT.AudioSource")}const steeringWheelNode=this.getProperty("steeringWheelHub");if(steeringWheelNode!=null&&steeringWheelNode.name!=null&&steeringWheelNode.name!==""){this.steeringWheelHub=this.getChildNode(steeringWheelNode.name,TOOLKIT.SearchType.IndexOf,false)}const angularDampener=this.getProperty("angularDampener");if(angularDampener!=null)this.m_angularDampener=TOOLKIT.Utilities.ParseVector3(angularDampener);const smokeTextureInfo=this.getProperty("smokeTexture");if(smokeTextureInfo!=null){this.smokeTexture=TOOLKIT.Utilities.ParseTexture(smokeTextureInfo,this.scene)}const engineTorqueInfo=this.getProperty("engineTorque");if(engineTorqueInfo!=null&&engineTorqueInfo.animation!=null){this.engineTorqueCurve=BABYLON.Animation.Parse(engineTorqueInfo.animation)}if(this.engineTorqueCurve==null)TOOLKIT.SceneManager.LogWarning("Failed to parse engine torque curve for: "+this.transform.name)}initVehicleState(){TOOLKIT.Utilities.ValidateTransformQuaternion(this.transform);if(this.linkTrackManager===true)PROJECT.RaceTrackManager.RegisterVehicle(this.transform);this._animator=this.getComponent("TOOLKIT.AnimationState");if(this._animator==null){const animationNode=this.getChildWithScript("TOOLKIT.AnimationState");if(animationNode!=null){this._animator=TOOLKIT.SceneManager.FindScriptComponent(animationNode,"TOOLKIT.AnimationState")}else{}}this._engineAudioSource=this.getComponent("TOOLKIT.AudioSource");if(this._engineAudioSource==null)TOOLKIT.SceneManager.LogWarning("No engine audio source manager found for: "+this.transform.name);this._rigidbody=this.getComponent("TOOLKIT.RigidbodyPhysics");if(this.transform.physicsBody!=null&&this._rigidbody!=null){this.raycastVehicle=this._rigidbody.getRaycastVehicle();if(this.raycastVehicle!=null){const props=this.transform.physicsBody.getMassProperties();props.inertia=new BABYLON.Vector3(this.m_angularDampener.x,this.m_angularDampener.y,this.m_angularDampener.z);this.transform.physicsBody.setMassProperties(props);this.linearDamping=this.transform.physicsBody.getLinearDamping();const brakeLightslName=(this.brakeLightsTrans!=null&&this.brakeLightsTrans.name!=null&&this.brakeLightsTrans.name!=="")?this.brakeLightsTrans.name:null;const reverseLightslName=(this.reverseLightsTrans!=null&&this.reverseLightsTrans.name!=null&&this.reverseLightsTrans.name!=="")?this.reverseLightsTrans.name:null;const frontLeftWheelName=(this.frontLeftWheelTrans!=null&&this.frontLeftWheelTrans.name!=null&&this.frontLeftWheelTrans.name!=="")?this.frontLeftWheelTrans.name:null;const frontRightWheelName=(this.frontRightWheelTrans!=null&&this.frontRightWheelTrans.name!=null&&this.frontRightWheelTrans.name!=="")?this.frontRightWheelTrans.name:null;const backLeftWheelName=(this.backLeftWheelTrans!=null&&this.backLeftWheelTrans.name!=null&&this.backLeftWheelTrans.name!=="")?this.backLeftWheelTrans.name:null;const backRightWheelName=(this.backRightWheelTrans!=null&&this.backRightWheelTrans.name!=null&&this.backRightWheelTrans.name!=="")?this.backRightWheelTrans.name:null;const frontLeftWheelLabel=(this.frontLeftWheelCollider!=null&&this.frontLeftWheelCollider.name!=null&&this.frontLeftWheelCollider.name!=="")?this.frontLeftWheelCollider.name:null;const frontRightWheelLabel=(this.frontRightWheelCollider!=null&&this.frontRightWheelCollider.name!=null&&this.frontRightWheelCollider.name!=="")?this.frontRightWheelCollider.name:null;const backLeftWheelLabel=(this.backLeftWheelCollider!=null&&this.backLeftWheelCollider.name!=null&&this.backLeftWheelCollider.name!=="")?this.backLeftWheelCollider.name:null;const backRightWheelLabel=(this.backRightWheelCollider!=null&&this.backRightWheelCollider.name!=null&&this.backRightWheelCollider.name!=="")?this.backRightWheelCollider.name:null;if(frontLeftWheelLabel!=null)this.FRONT_LEFT=this.raycastVehicle.getWheelIndexByName(frontLeftWheelLabel);if(frontRightWheelLabel!=null)this.FRONT_RIGHT=this.raycastVehicle.getWheelIndexByName(frontRightWheelLabel);if(backLeftWheelLabel!=null)this.BACK_LEFT=this.raycastVehicle.getWheelIndexByName(backLeftWheelLabel);if(backRightWheelLabel!=null)this.BACK_RIGHT=this.raycastVehicle.getWheelIndexByName(backRightWheelLabel);if(brakeLightslName!=null){this.brakeLightsMesh=this.getChildNode(brakeLightslName,TOOLKIT.SearchType.IndexOf,false);if(this.brakeLightsMesh!=null){this.brakeLightsMesh.isVisible=false}}if(reverseLightslName!=null){this.reverseLightsMesh=this.getChildNode(reverseLightslName,TOOLKIT.SearchType.IndexOf,false);if(this.reverseLightsMesh!=null){this.reverseLightsMesh.isVisible=false}}if(this.raycastVehicle.getNumWheels()>=4){if(this.BACK_LEFT>=0&&backLeftWheelName!=null){this.m_backLeftWheel=this.raycastVehicle.getWheelInfo(this.BACK_LEFT);this.backLeftWheelMesh=this.getChildNode(backLeftWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.backLeftWheelMesh!=null){this.m_backLeftWheel.hub=this.backLeftWheelMesh;this.m_backLeftWheel.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.backLeftWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.backLeftWheelEmitter=new BABYLON.Mesh("Emitter_RL");this.backLeftWheelEmitter.parent=this.m_backLeftWheel.spinner||this.backLeftWheelMesh;this.backLeftWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.backLeftWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_RL",this.backLeftWheelEmitter);if(this.wheelDriveType===0||this.wheelDriveType===2){if(this.wheelRadius<=0&&this.m_backLeftWheel!=null){this.wheelRadius=this.m_backLeftWheel.radius}}}}if(this.BACK_RIGHT>=0&&backRightWheelName!=null){this.m_backRightWheel=this.raycastVehicle.getWheelInfo(this.BACK_RIGHT);this.backRightWheelMesh=this.getChildNode(backRightWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.backRightWheelMesh!=null){this.m_backRightWheel.hub=this.backRightWheelMesh;this.m_backRightWheel.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.backRightWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.backRightWheelEmitter=new BABYLON.Mesh("Emitter_RR");this.backRightWheelEmitter.parent=this.m_backRightWheel.spinner||this.backRightWheelMesh;this.backRightWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.backRightWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_RR",this.backRightWheelEmitter);if(this.wheelDriveType===0||this.wheelDriveType===2){if(this.wheelRadius<=0&&this.m_backRightWheel!=null){this.wheelRadius=this.m_backRightWheel.radius}}}}if(this.FRONT_LEFT>=0&&frontLeftWheelName!=null){this.m_frontLeftWheel=this.raycastVehicle.getWheelInfo(this.FRONT_LEFT);this.frontLeftWheelMesh=this.getChildNode(frontLeftWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.frontLeftWheelMesh!=null){this.m_frontLeftWheel.hub=this.frontLeftWheelMesh;this.m_frontLeftWheel.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.frontLeftWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.frontLeftWheelEmitter=new BABYLON.Mesh("Emitter_FL");this.frontLeftWheelEmitter.parent=this.m_frontLeftWheel.spinner||this.frontLeftWheelMesh;this.frontLeftWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.frontLeftWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_FL",this.frontLeftWheelEmitter);if(this.wheelDriveType===1||this.wheelDriveType===2){if(this.wheelRadius<=0&&this.m_frontLeftWheel!=null){this.wheelRadius=this.m_frontLeftWheel.radius}}}}if(this.FRONT_RIGHT>=0&&frontRightWheelName!=null){this.m_frontRightWheel=this.raycastVehicle.getWheelInfo(this.FRONT_RIGHT);this.frontRightWheelMesh=this.getChildNode(frontRightWheelName,TOOLKIT.SearchType.IndexOf,false);if(this.frontRightWheelMesh!=null){this.m_frontRightWheel.hub=this.frontRightWheelMesh;this.m_frontRightWheel.spinner=TOOLKIT.SceneManager.FindChildTransformNode(this.frontRightWheelMesh,"Wheel",TOOLKIT.SearchType.IndexOf,true);this.frontRightWheelEmitter=new BABYLON.Mesh("Emitter_FR");this.frontRightWheelEmitter.parent=this.m_frontRightWheel.spinner||this.frontRightWheelMesh;this.frontRightWheelEmitter.position=new BABYLON.Vector3(0,0,0);this.frontRightWheelParticle=this.createSmokeParticleSystem(this.transform.name+"Smoke_FR",this.frontRightWheelEmitter);if(this.wheelDriveType===1||this.wheelDriveType===2){if(this.wheelRadius<=0&&this.m_frontRightWheel!=null){this.wheelRadius=this.m_frontRightWheel.radius}}}}this.raycastVehicle.setLoggingEnabled(false);this.raycastVehicle.setMultiRaycastEnabled(this.raycastDriveType===1);this.raycastVehicle.setMultiRaycastRadiusScale(this.maxRadiusMultiplier);this.raycastVehicle.setStabilizeVelocityEnabled(this.stabilizeVelocity);this.raycastVehicle.setMinPenaltySpeed(this.minPenaltySpeed);this.raycastVehicle.setPenaltyGroundTag(this.penaltyGroundTag);this.raycastVehicle.setPenaltyWheelSlip(this.penaltyWheelSlip);this.raycastVehicle.setSmoothFlyingImpulse(this.smoothFlyingForce);this.raycastVehicle.setStabilizingForce(this.gravitationalForce);this.raycastVehicle.setBaseRotationBoost(this.burnoutRotationBoost);this.raycastVehicle.setBurnoutCoefficient(this.burnoutCoefficient);this.raycastVehicle.setBurnoutFrictionSlip(this.burnoutFrictionSlip);this.raycastVehicle.setBurnoutFrictionGrip(this.burnoutFrictionGrip);this.raycastVehicle.setBurnoutCooldownTime(this.burnoutCooldownTime);this.raycastVehicle.setBurnoutTransitionSpeed(this.burnoutTransition);this.raycastVehicle.setBurnoutFrictionUpdateSpeed(this.burnoutLerpSpeed);this.raycastVehicle.setSkiddingFrictionUpdateSpeed(this.frictionLerpSpeed);this.raycastVehicle.setDonutTurnRadius(this.donutTurningRadius);this.raycastVehicle.setDonutEngineMultiplier(this.donutEngineFactor);this.raycastVehicle.setDonutTransitionSpeed(this.donutTransitionSpeed);this.raycastVehicle.setDonutRotationBoost(this.donutRotationBoost);this.raycastVehicle.setLaunchBoostEnabled(true);this.raycastVehicle.setLaunchBoostDuration(1.2);this.raycastVehicle.setLaunchBoostMultiplier(0.8);this.raycastVehicle.setLaunchBoostDecaySpeed(0.008);this.raycastVehicle.setBurnoutKickStrength(0.7);this.raycastVehicle.setHandbrakeWheelStiffness(1.0);this.raycastVehicle.setBurnoutWheelStiffness(0.9);this.raycastVehicle.setDriftWheelStiffness(1.0);this.raycastVehicle.setArcadeWheelSkidLimit(this.maxSkiddingTimer);this.raycastVehicle.setArcadeHandBrakeDelay(this.brakeRecoveryDelay);this.raycastVehicle.setArcadeSteerAssistFactor(this.skiddingTurnAssist);this.raycastVehicle.setArcadeMomentumPreserveFactor(this.handbrakePreserve);if(this._skidAudioSource==null&&this.backRightWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.backRightWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null&&this.backLeftWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.backLeftWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null&&this.frontRightWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.frontRightWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null&&this.frontLeftWheelMesh!=null)this._skidAudioSource=TOOLKIT.SceneManager.FindScriptComponent(this.frontLeftWheelMesh,"TOOLKIT.AudioSource");if(this._skidAudioSource==null)TOOLKIT.SceneManager.LogWarning("No skid audio source manager found for: "+this.transform.name)}else{TOOLKIT.SceneManager.LogWarning("Invalid vehicle controller wheel count info for: "+this.transform.name)}}else{TOOLKIT.SceneManager.LogWarning("No wheel collider information found for: "+this.transform.name)}}else{TOOLKIT.SceneManager.LogWarning("Failed to get rigidbody component: "+this.transform.name)}}updateVehicleState(){this.m_linearVelocity=this.transform.absolutePosition.subtract(this.m_lastPosition);this.m_scaledVelocity=(this.m_linearVelocity.length()/this.getDeltaSeconds());this.m_linearVelocity.normalize();this.m_linearVelocity.scaleInPlace(this.m_scaledVelocity);if(this.wheelDrawVelocity>0){this.m_velocityOffset.copyFrom(this.m_linearVelocity);this.m_velocityOffset.scaleInPlace(this.wheelDrawVelocity)}else{this.m_velocityOffset.set(0,0,0)}this.m_lastPosition.copyFrom(this.transform.absolutePosition)}destroyVehicleState(){this._rigidbody=null;this._engineAudioSource=null;this._skidAudioSource=null;if(this.m_frontLeftWheel!=null){this.m_frontLeftWheel=null}if(this.m_frontRightWheel!=null){this.m_frontRightWheel=null}if(this.m_backLeftWheel!=null){this.m_backLeftWheel=null}if(this.m_backRightWheel!=null){this.m_backRightWheel=null}this.raycastVehicle=null;this.frontLeftWheelMesh=null;this.frontRightWheelMesh=null;this.backLeftWheelMesh=null;this.backRightWheelMesh=null;this.frontLeftWheelTrans=null;this.frontRightWheelTrans=null;this.backLeftWheelTrans=null;this.backRightWheelTrans=null;this.frontLeftWheelCollider=null;this.frontRightWheelCollider=null;this.backLeftWheelCollider=null;this.backRightWheelCollider=null}burnoutButton=false;burnoutTimer=0;restoreTimer=0;cooldownTimer=0;wheelDonuts=false;wheelBurnout=false;wheelSkidding=false;donutSpinTime=0;currentForward=0;currentTurning=0;currentBoosting=false;currentSkidding=false;currentSlipAngle=0;currentDrivePower=0;targetDrivePower=0;animatorSteerAngle=0;getCurrentSlipAngle(signed){const vehicle=this.raycastVehicle;if(vehicle==null)return 0;this.transform.physicsBody.getAngularVelocityToRef(this.angularVelocity);const lateralGForce=this.angularVelocity.y;const signedLateralGForce=BABYLON.Tools.ToDegrees(lateralGForce);const absoluteLateralGForce=Math.abs(signedLateralGForce);return(signed===true)?signedLateralGForce:absoluteLateralGForce}getCurrentSlipRadians(signed){const vehicle=this.raycastVehicle;if(vehicle==null)return 0;this.transform.physicsBody.getAngularVelocityToRef(this.angularVelocity);const lateralGForce=this.angularVelocity.y;const signedLateralGForce=lateralGForce;const absoluteLateralGForce=Math.abs(signedLateralGForce);return(signed===true)?signedLateralGForce:absoluteLateralGForce}drive(throttle,steering,braking,burnout,booster=0,autopilot=false,nos=false){const deltaTime=this.getDeltaSeconds();this.currentForward=BABYLON.Scalar.Clamp(throttle,-1,1);this.currentTurning=BABYLON.Scalar.Clamp(steering,-1,1);this.currentSkidding=braking;this.burnoutButton=burnout;this.currentBoosting=(nos===true&&this.powerBooster===true&&this.wheelBurnout===false&&this.boostSpeedTimer>0&&this.americanSpeed>=this.minBoosterSpeed);this.currentSlipAngle=this.getCurrentSlipAngle(true);this.targetDrivePower=(this.currentBoosting===true)?this.boosterCoefficient:(this.powerCoefficient+booster);this.currentDrivePower=BABYLON.Scalar.Lerp(this.currentDrivePower,this.targetDrivePower,(this.powerChangeRate*deltaTime));this.currentPitchScale=this.gearBoxPitchScale;let burnoutMultiplier=1.0;let gearShiftRatio=(this.gearBoxShiftRatios!=null&&this.gearBoxShiftRatios.length>this.gearIndex)?this.gearBoxShiftRatios[this.gearIndex]:3.25;if(this.gearIndex===0&&(this.wheelBurnout===true||this.restoreTimer>0)){burnoutMultiplier=this.burnoutFirstGearMultiplier;gearShiftRatio*=burnoutMultiplier}const finalGearRatio=(gearShiftRatio*this.differentialRatio*this.transmissionRatio);const engineTorque=this.getVehicleEngineTorque(this.engineRPM,this.currentDrivePower);const finalTorque=engineTorque*finalGearRatio;const shiftUpSpeed=(this.gearBoxShiftUpRanges!=null&&this.gearBoxShiftUpRanges.length>this.gearIndex)?this.gearBoxShiftUpRanges[this.gearIndex]:999;const shiftDownSpeed=(this.gearBoxShiftDownRanges!=null&&this.gearBoxShiftDownRanges.length>this.gearIndex)?this.gearBoxShiftDownRanges[this.gearIndex]:0;this.handBraking=(this.getCurrentSkidding()===true&&this.handBrakingForce>0);if(this.handBraking===true){this.handBrakingTimer+=deltaTime}else{this.handBrakingTimer=0}if(this._rigidbody==null||this.raycastVehicle==null)return;if(this.FRONT_LEFT>=0&&this.FRONT_RIGHT>=0&&this.BACK_LEFT>=0&&this.BACK_RIGHT>=0){this.engineForce=0;this.wheelBrakingForce=0;this.frontWheelPower=0;this.backWheelPower=0;const throttleSpeed=(this.throttleEngineSpeed>0)?this.throttleEngineSpeed:this.getTopEngineSpeed();let gearShiftRatio=(this.gearBoxShiftRatios!=null&&this.gearBoxShiftRatios.length>this.gearIndex)?this.gearBoxShiftRatios[this.gearIndex]:1.0;if(this.gearIndex===0&&this.wheelBurnout===true){gearShiftRatio*=this.burnoutFirstGearMultiplier}const finalGearRatio=(gearShiftRatio*this.differentialRatio*this.transmissionRatio);const engineMotorTorque=engineTorque*Math.abs(this.currentForward);const allowedEnginePower=(engineMotorTorque*finalGearRatio);if(this.currentForward>0){this.engineForce=allowedEnginePower;this.wheelBrakingForce=0}else if(this.currentForward<0){const isActuallyGoingReverse=this.forwardSpeed<-0.5;if(isActuallyGoingReverse){this.engineForce=-(allowedEnginePower*this.maxReversePower)}else{this.engineForce=-allowedEnginePower}this.wheelBrakingForce=0}else{this.engineForce=0;this.wheelBrakingForce=(this.americanSpeed<10)?50:0}if(this.currentBoosting===false&&this.americanSpeed>this.topEngineSpeed){this.engineForce=0;this.wheelBrakingForce=100}let engineBrake=0;if(this.shiftingTime>0||this.americanSpeed>throttleSpeed){engineBrake=this.shiftingBrake;this.engineForce=0}let visualSteerBoost=0;let ackermanSteerLeft=0;let ackermanSteerRight=0;let turningRadius=BABYLON.Scalar.Lerp(this.ackermanTurnRadius,this.ackermanMaxRadius,this.gradientSpeed);let steeringBoost=(Math.abs(this.currentTurning)>=0.02);let steeringRadius=(turningRadius*this.ackermanTurnFactor);let steeringAmount=BABYLON.Scalar.Lerp(this.lowSpeedSteering,this.highSpeedSteering,this.gradientSpeed);let steeringGradient=(steeringAmount*deltaTime);let currentSlipRadians=this.getCurrentSlipRadians(true);if(this.currentTurning>0){if(this.maxSteerBoost>0&&steeringBoost===true)visualSteerBoost=BABYLON.Tools.ToRadians(this.maxSteerBoost);ackermanSteerLeft=Math.atan(this.ackermanWheelBase/(steeringRadius+(this.ackermanRearTrack/2)))*this.currentTurning;ackermanSteerRight=Math.atan(this.ackermanWheelBase/(steeringRadius-(this.ackermanRearTrack/2)))*this.currentTurning}else if(this.currentTurning<0){if(this.maxSteerBoost>0&&steeringBoost===true)visualSteerBoost=-BABYLON.Tools.ToRadians(this.maxSteerBoost);ackermanSteerLeft=Math.atan(this.ackermanWheelBase/(steeringRadius-(this.ackermanRearTrack/2)))*this.currentTurning;ackermanSteerRight=Math.atan(this.ackermanWheelBase/(steeringRadius+(this.ackermanRearTrack/2)))*this.currentTurning}else{visualSteerBoost=0;ackermanSteerLeft=0;ackermanSteerRight=0}if(this.wheelBurnout===true&&this.wheelDonuts===true){}else if(autopilot===false){const smoothSteerFactor=BABYLON.Scalar.Lerp(1.0,this.topSpeedDampener,this.gradientSpeed);ackermanSteerLeft*=smoothSteerFactor;ackermanSteerRight*=smoothSteerFactor}this.physicsSteerAngleL=BABYLON.Scalar.Lerp(this.physicsSteerAngleL,ackermanSteerLeft,steeringGradient);this.physicsSteerAngleR=BABYLON.Scalar.Lerp(this.physicsSteerAngleR,ackermanSteerRight,steeringGradient);this.visualSteerBoostL=(ackermanSteerLeft+visualSteerBoost);this.visualSteerBoostR=(ackermanSteerRight+visualSteerBoost);if(this.wheelBurnout===true&&this.wheelDonuts===true){this.visualSteerBoostL*=1.5;this.visualSteerBoostR*=1.5}if(this.overSteerSpeed>0&&this.handBraking===true&&this.handBrakingTimer>this.overSteerTimeout){this.visualSteerBoostL*=-1;this.visualSteerBoostR*=-1}this.visualSteerAngleL=BABYLON.Scalar.Lerp(this.visualSteerAngleL,this.visualSteerBoostL,steeringGradient);this.visualSteerAngleR=BABYLON.Scalar.Lerp(this.visualSteerAngleR,this.visualSteerBoostR,steeringGradient);let steeringAngleBoost=2.0;let steeringAngleFactor=Math.abs(this.currentTurning)*steeringAngleBoost;if(this.currentTurning>0){steeringAngleFactor=BABYLON.Scalar.Clamp(steeringAngleFactor,0,1)}else if(this.currentTurning<0){steeringAngleFactor=-BABYLON.Scalar.Clamp(steeringAngleFactor,0,1)}let fixedCurrentTurning=(this.overSteerSpeed>0&&this.handBraking===true&&this.handBrakingTimer>this.overSteerTimeout)?steeringAngleFactor:-steeringAngleFactor;this.animatorSteerAngle=BABYLON.Scalar.Lerp(this.animatorSteerAngle,fixedCurrentTurning,(this.maxSteeringSpeed*deltaTime));if(this.steeringWheelHub!=null){if(this.steeringWheelHub.rotationQuaternion==null){this.steeringWheelHub.rotationQuaternion=BABYLON.Quaternion.FromEulerVector(this.steeringWheelHub.rotation)}const degreesSteerAngle=(this.animatorSteerAngle*this.maxSteeringAngle);const radiansSteerAngle=BABYLON.Tools.ToRadians(degreesSteerAngle);const xaxis=(this.steeringWheelAxis===0)?radiansSteerAngle:0;const yaxis=(this.steeringWheelAxis===1)?radiansSteerAngle:0;const zaxis=(this.steeringWheelAxis===2)?radiansSteerAngle:0;BABYLON.Quaternion.SlerpToRef(this.steeringWheelHub.rotationQuaternion,BABYLON.Quaternion.FromEulerAngles(xaxis,yaxis,zaxis),(this.maxSteeringSpeed*deltaTime),this.steeringWheelHub.rotationQuaternion)}if(this._animator!=null)this._animator.setFloat("TurnAngle",this.animatorSteerAngle);if(this.handBraking===true){this.wheelBurnout=false;this.wheelDonuts=false;this.burnoutTimer=0;if(this.americanSpeed>=this.minSkiddingSpeed){if(this.wheelSkidding===false){this.wheelSkidding=true;this.raycastVehicle.setLockedWheelIndexes([this.BACK_LEFT,this.BACK_RIGHT])}}this.raycastVehicle.setArcadeSteeringInput(this.currentTurning);this.raycastVehicle.setVisualSteeringAngle(this.visualSteerAngleL,this.FRONT_LEFT);this.raycastVehicle.setVisualSteeringAngle(this.visualSteerAngleR,this.FRONT_RIGHT);this.raycastVehicle.setPhysicsSteeringAngle(this.physicsSteerAngleL,this.FRONT_LEFT);this.raycastVehicle.setPhysicsSteeringAngle(this.physicsSteerAngleR,this.FRONT_RIGHT);this.raycastVehicle.setEngineForce(0,this.FRONT_LEFT);this.raycastVehicle.setEngineForce(0,this.FRONT_RIGHT);this.raycastVehicle.setEngineForce(0,this.BACK_LEFT);this.raycastVehicle.setEngineForce(0,this.BACK_RIGHT);const handBrakeForce=(this.handBrakingForce*25);this.raycastVehicle.setHandBrake(0,this.FRONT_LEFT);this.raycastVehicle.setHandBrake(0,this.FRONT_RIGHT);this.raycastVehicle.setHandBrake(handBrakeForce,this.BACK_LEFT);this.raycastVehicle.setHandBrake(handBrakeForce,this.BACK_RIGHT);if(this.raycastVehicle.getArcadeHandBrakingTimer()<=0)this.raycastVehicle.applyEngineBrake(this.linearBrakingForce,(deltaTime*this.brakeRecoverySpeed))}else{this.wheelSkidding=false;this.raycastVehicle.setLockedWheelIndexes(null);this.burnoutCoefficient=BABYLON.Scalar.Clamp(this.burnoutCoefficient,1,30);this.burnoutTriggerMark=BABYLON.Scalar.Clamp(this.burnoutTriggerMark,1,20);const isBurnoutSpeed=(this.americanSpeed<=this.burnoutTriggerMark);const isFullThrottle=(this.currentForward<-0.9||this.currentForward>0.9);const isFullTurning=(this.currentTurning<-0.9||this.currentTurning>0.9);if(this.enableAutoBurnouts===true&&this.burnoutButton===true&&this.burnoutTimer<=0&&isFullThrottle===true&&isBurnoutSpeed===true){this.burnoutTimer=(this.burnoutTimeDelay*0.25);this.wheelDonuts=false;this.wheelBurnout=true}if(this.restoreTimer>0){this.restoreTimer-=deltaTime;if(this.restoreTimer<0)this.restoreTimer=0}if(this.cooldownTimer>0){this.cooldownTimer-=deltaTime;if(this.cooldownTimer<0)this.cooldownTimer=0}if(this.wheelDonuts===true){this.donutSpinTime+=deltaTime;if(isFullTurning===false){this.burnoutTimer=0}}else{this.donutSpinTime=0}if(this.burnoutTimer>0&&isFullThrottle===true){this.burnoutTimer-=deltaTime;if(this.wheelBurnout===true&&this.burnoutTimer<=0&&isFullTurning===true&&this.cooldownTimer<=0&&this.currentForward>0){this.burnoutTimer=0.01;this.wheelDonuts=true}}else{this.burnoutTimer=0;this.donutSpinTime=0;if(this.wheelDonuts===true){this.wheelDonuts=false;this.cooldownTimer=(this.burnoutTimeDelay*2)}if(this.wheelBurnout===true){this.wheelBurnout=false;this.restoreTimer=(this.burnoutTimeDelay*0.75)}}if(this.wheelBurnout===true&&this.wheelDonuts===true){this.frontWheelPower=(this.engineForce*0.2)}else if(this.wheelDriveType===1||this.wheelDriveType===2){this.frontWheelPower=this.engineForce}if(this.wheelDriveType===0||this.wheelDriveType===2){this.backWheelPower=this.engineForce}this.raycastVehicle.setArcadeSteeringInput(this.currentTurning);this.raycastVehicle.setVisualSteeringAngle(this.visualSteerAngleL,this.FRONT_LEFT);this.raycastVehicle.setVisualSteeringAngle(this.visualSteerAngleR,this.FRONT_RIGHT);this.raycastVehicle.setPhysicsSteeringAngle(this.physicsSteerAngleL,this.FRONT_LEFT);this.raycastVehicle.setPhysicsSteeringAngle(this.physicsSteerAngleR,this.FRONT_RIGHT);this.raycastVehicle.setEngineForce(this.frontWheelPower,this.FRONT_LEFT);this.raycastVehicle.setEngineForce(this.frontWheelPower,this.FRONT_RIGHT);this.raycastVehicle.setEngineForce(this.backWheelPower,this.BACK_LEFT);this.raycastVehicle.setEngineForce(this.backWheelPower,this.BACK_RIGHT);const wheelBrakeForce=(this.wheelBrakingForce*10);this.raycastVehicle.setHandBrake(wheelBrakeForce,this.FRONT_LEFT);this.raycastVehicle.setHandBrake(wheelBrakeForce,this.FRONT_RIGHT);this.raycastVehicle.setHandBrake(wheelBrakeForce,this.BACK_LEFT);this.raycastVehicle.setHandBrake(wheelBrakeForce,this.BACK_RIGHT);if(this.getFootBraking()===true)this.raycastVehicle.applyEngineBrake((this.linearBrakingForce*0.05));else if(this.throttleBrakingForce>0)this.raycastVehicle.applyEngineBrake(this.throttleBrakingForce);else if(this.engineForce!==0)this.raycastVehicle.applyEngineBrake(engineBrake);else this.raycastVehicle.applyEngineBrake(this.linearDamping)}this.raycastVehicle.setisArcadeHandBrakeActive(this.handBraking);this.raycastVehicle.setIsArcadeWheelSkidActive(this.wheelSkidding);this.raycastVehicle.setIsArcadeBurnoutModeActive(this.wheelBurnout);this.raycastVehicle.setIsArcadeDonutModeActive(this.wheelDonuts)}this.syncVehicleState(deltaTime);this.syncVehicleTilting(deltaTime)}syncVehicleState(deltaTime){const gearCount=this.getGearShiftRatioCount();if(this.shiftingTime>0){this.shiftingTime-=deltaTime;if(this.shiftingTime<0)this.shiftingTime=0}if(this.currentBoosting===true){if(this.boostSpeedTimer>0){this.boostSpeedTimer-=deltaTime;if(this.boostSpeedTimer<0)this.boostSpeedTimer=0}}if(this._rigidbody!=null&&this.raycastVehicle!=null){const deadSpeed=0.2;this.forwardSpeed=this.raycastVehicle.getRawCurrentSpeedKph()*PROJECT.StandardCarController.DEFAULT_SPEED_FACTOR;if(Math.abs(this.forwardSpeed)<deadSpeed)this.forwardSpeed=0;this.absoluteSpeed=this.raycastVehicle.getAbsCurrentSpeedKph()*PROJECT.StandardCarController.DEFAULT_SPEED_FACTOR;if(this.absoluteSpeed<deadSpeed)this.absoluteSpeed=0;this.americanSpeed=(this.absoluteSpeed*TOOLKIT.System.Kph2Mph);this.gradientSpeed=BABYLON.Scalar.Clamp((this.absoluteSpeed/this.getTopEngineSpeed()));if(this.gearBoxShiftRatios!=null&&this.gearIndex>=0&&this.gearIndex<gearCount){const minimumDelta=Math.min(Math.max(deltaTime,1/200),1);const wheelDiameter=(this.wheelRadius*2);const finalGearRatio=(this.gearBoxShiftRatios[this.gearIndex]*this.differentialRatio*this.transmissionRatio);const wheelCircumference=Math.PI*wheelDiameter;const wheelSpeedMs=this.absoluteSpeed/3.6;this.wheelRPM=(wheelSpeedMs*60)/wheelCircumference;this.transmissionInputRPM=this.wheelRPM*this.differentialRatio*this.transmissionRatio;this.targetEngineRPM=this.transmissionInputRPM*this.gearBoxShiftRatios[this.gearIndex];this.engineLoad=Math.abs(this.currentForward)*this.currentDrivePower;this.updateGearShifting(deltaTime);this.updateClutchEngagement(deltaTime);if(this.isShifting&&this.clutchEngagement<1.0){const engineInertiaRPM=BABYLON.Scalar.Lerp(this.actualEngineRPM,this.targetEngineRPM+this.getIdleRPM(),0.1);this.actualEngineRPM=BABYLON.Scalar.Lerp(engineInertiaRPM,this.targetEngineRPM,this.clutchEngagement)}else{const maxThrottleRPM=this.getIdleRPM()+(Math.abs(this.currentForward)*2500);const transmissionRPM=Math.max(this.targetEngineRPM,this.getIdleRPM());if(!this.throttleRPM)this.throttleRPM=this.getIdleRPM();const rpmBuildupRate=1500;const rpmDeclineRate=2000;if(Math.abs(this.currentForward)>0.1){this.throttleRPM=BABYLON.Scalar.Lerp(this.throttleRPM,maxThrottleRPM,(rpmBuildupRate*deltaTime)/1000)}else{this.throttleRPM=BABYLON.Scalar.Lerp(this.throttleRPM,this.getIdleRPM(),(rpmDeclineRate*deltaTime)/1000)}if(this.americanSpeed<15&&Math.abs(this.currentForward)>0.1){this.actualEngineRPM=this.throttleRPM}else{this.actualEngineRPM=Math.max(this.throttleRPM,transmissionRPM)}}this.actualEngineRPM=Math.max(this.actualEngineRPM,this.getIdleRPM());if(this.currentForward>=0&&this.engineLoad<0.1){this.engineBraking=BABYLON.Scalar.Lerp(this.engineBraking,0.3,deltaTime*2)}else{this.engineBraking=BABYLON.Scalar.Lerp(this.engineBraking,0,deltaTime*4)}this.engineRPM=this.actualEngineRPM;if(this.wheelDonuts===true||this.wheelBurnout===true){const burnoutRPM=Math.min(this.MAX_RPM*0.85,this.engineRPM+1500);this.pitchRPM=BABYLON.Scalar.Lerp(this.pitchRPM,burnoutRPM,deltaTime*4)}else if(this.isShifting){const shiftProgress=1-(this.shiftingTime/this.gearBoxShiftDelay);const smoothRPM=BABYLON.Scalar.Lerp(this.shiftRPM,this.engineRPM,shiftProgress);this.pitchRPM=BABYLON.Scalar.Lerp(this.pitchRPM,smoothRPM,deltaTime*6)}else{this.pitchRPM=BABYLON.Scalar.Lerp(this.pitchRPM,this.engineRPM,deltaTime*8)}}}this.enginePitchLevel=(this.getCurrentEnginePitch()*PROJECT.StandardCarController.DEFAULT_PITCH_FACTOR*this.currentPitchScale);if(this.playVehicleSounds===true){if(this._engineAudioSource!=null){this._engineAudioSource.setPitch(this.enginePitchLevel)}}this.POWER_BOOST_PITCH=(this.currentBoosting===true)?1:0;if(this.playVehicleSounds===true){if(this._nosAudioSource!=null){this._nosAudioSource.setPitch(this.POWER_BOOST_PITCH)}}this.smokeDonuts=BABYLON.Scalar.Clamp(this.smokeDonuts,1,10);this.smokeIntensityFactor=this.smokeIntensity;if(this.wheelBurnout===true&&this.wheelDonuts===true)this.smokeIntensityFactor*=this.smokeDonuts;const vehicleVelocity=this.getLinearVelocity();const speedMs=vehicleVelocity.length();const predictionTime=deltaTime*1.5;const speedCompensation=speedMs*predictionTime;const velocityDirection=vehicleVelocity.clone();if(velocityDirection.length()>0.1){velocityDirection.normalize();velocityDirection.scaleInPlace(speedCompensation);this.velocityCompensation.copyFrom(velocityDirection)}else{this.velocityCompensation.setAll(0)}this.SKID_FL=0,this.SKID_FR=0,this.SKID_RL=0,this.SKID_RR=0;if(this.m_frontLeftWheel!=null){const wheelContactFL=(this.m_frontLeftWheel.raycastResult.body!=null);this.SKID_FL=this.updateCurrentSkidInfo(this.m_frontLeftWheel);if(this.SKID_FL<this.skidThreashold)this.SKID_FL=0;let isProperGroundContactFL=false;if(this.SKID_FL>0&&wheelContactFL===true){const skidPosFL=this.m_frontLeftWheel.raycastResult.hitPointWorld;const skidNormFL=this.m_frontLeftWheel.raycastResult.hitNormalWorld;const wheelWorldPos=this.m_frontLeftWheel.chassisConnectionPointWorld;const hitDistance=wheelWorldPos.subtract(skidPosFL).length();const maxWheelDistance=this.wheelRadius*this.maxWheelDistanceFactor;const upwardDot=skidNormFL.dot(BABYLON.Vector3.Up());const minUpwardAngle=this.minUpwardAngleFactor;const hasLoad=(this.m_frontLeftWheel.suspensionForce!==undefined)?this.m_frontLeftWheel.suspensionForce>=-10:true;const distanceOK=hitDistance<=maxWheelDistance;const angleOK=upwardDot>=minUpwardAngle;isProperGroundContactFL=(distanceOK&&angleOK&&hasLoad)}if(isProperGroundContactFL){const skidPosFL=this.m_frontLeftWheel.raycastResult.hitPointWorld.clone();const skidNormFL=this.m_frontLeftWheel.raycastResult.hitNormalWorld;const skidScaleFL=BABYLON.Scalar.Normalize(this.SKID_FL,this.skidThreashold,1.0);const wheelVelocity=this.getLinearVelocity();const wheelSpeedMs=wheelVelocity.length();let wheelCompensation=this.velocityCompensation.clone();if(wheelSpeedMs>15){const extraCompensation=(wheelSpeedMs-15)*0.02;const velocityDir=wheelVelocity.clone().normalize();velocityDir.scaleInPlace(extraCompensation);wheelCompensation.addInPlace(velocityDir)}skidPosFL.addInPlace(wheelCompensation);this.m_frontLeftWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(skidPosFL,skidNormFL,skidScaleFL,this.m_frontLeftWheelSkid);if(this.wheelDonuts===true)this.donutMeter+=this.SKID_FL;this.burnoutMeter+=this.SKID_FL;if(this.frontLeftWheelParticle!=null){if(this.frontLeftWheelParticle.isStarted()===false){this.frontLeftWheelParticle.start()}const smoke_FL=this.SKID_FL*this.SKID_FL;this.frontLeftWheelParticle.emitRate=this.smokeIntensityFactor*smoke_FL;this.frontLeftWheelParticle.minSize=0.2*smoke_FL+0.2;this.frontLeftWheelParticle.maxSize=1.5*smoke_FL+1.2}}else{if(this.frontLeftWheelParticle!=null)this.frontLeftWheelParticle.emitRate=0;this.m_frontLeftWheelSkid=-1}}if(this.m_frontRightWheel!=null){const wheelContactFR=(this.m_frontRightWheel.raycastResult.body!=null);this.SKID_FR=this.updateCurrentSkidInfo(this.m_frontRightWheel);if(this.SKID_FR<this.skidThreashold)this.SKID_FR=0;let isProperGroundContactFR=false;if(this.SKID_FR>0&&wheelContactFR===true){const skidPosFR=this.m_frontRightWheel.raycastResult.hitPointWorld;const skidNormFR=this.m_frontRightWheel.raycastResult.hitNormalWorld;const wheelWorldPos=this.m_frontRightWheel.chassisConnectionPointWorld;const hitDistance=wheelWorldPos.subtract(skidPosFR).length();const maxWheelDistance=this.wheelRadius*this.maxWheelDistanceFactor;const upwardDot=skidNormFR.dot(BABYLON.Vector3.Up());const minUpwardAngle=this.minUpwardAngleFactor;const hasLoad=(this.m_frontRightWheel.suspensionForce!==undefined)?this.m_frontRightWheel.suspensionForce>=-10:true;isProperGroundContactFR=(hitDistance<=maxWheelDistance&&upwardDot>=minUpwardAngle&&hasLoad)}if(isProperGroundContactFR){const skidPosFR=this.m_frontRightWheel.raycastResult.hitPointWorld.clone();const skidNormFR=this.m_frontRightWheel.raycastResult.hitNormalWorld;const skidScaleFR=BABYLON.Scalar.Normalize(this.SKID_FR,this.skidThreashold,1.0);const wheelVelocity=this.getLinearVelocity();const wheelSpeedMs=wheelVelocity.length();let wheelCompensation=this.velocityCompensation.clone();if(wheelSpeedMs>15){const extraCompensation=(wheelSpeedMs-15)*0.02;const velocityDir=wheelVelocity.clone().normalize();velocityDir.scaleInPlace(extraCompensation);wheelCompensation.addInPlace(velocityDir)}skidPosFR.addInPlace(wheelCompensation);this.m_frontRightWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(skidPosFR,skidNormFR,skidScaleFR,this.m_frontRightWheelSkid);if(this.wheelDonuts===true)this.donutMeter+=this.SKID_FR;this.burnoutMeter+=this.SKID_FR;if(this.frontRightWheelParticle!=null){if(this.frontRightWheelParticle.isStarted()===false){this.frontRightWheelParticle.start()}const smoke_FR=this.SKID_FR*this.SKID_FR;this.frontRightWheelParticle.emitRate=this.smokeIntensityFactor*smoke_FR;this.frontRightWheelParticle.minSize=0.2*smoke_FR+0.2;this.frontRightWheelParticle.maxSize=1.5*smoke_FR+1.2}}else{if(this.frontRightWheelParticle!=null)this.frontRightWheelParticle.emitRate=0;this.m_frontRightWheelSkid=-1}}this.PITCH_FL=this.SKID_FL;this.PITCH_FR=this.SKID_FR;if(this.wheelBurnout==true||this.restoreTimer>0){this.PITCH_FL*=this.burnoutWheelPitch;this.PITCH_FR*=this.burnoutWheelPitch}this.PITCH_FL*=0.75;this.PITCH_FR*=0.75;if(this.m_backLeftWheel!=null){const wheelContactBL=(this.m_backLeftWheel.raycastResult.body!=null);this.SKID_RL=this.updateCurrentSkidInfo(this.m_backLeftWheel);if(this.SKID_RL<this.skidThreashold)this.SKID_RL=0;let isProperGroundContactRL=false;if(this.SKID_RL>0&&wheelContactBL===true){const skidPosRL=this.m_backLeftWheel.raycastResult.hitPointWorld;const skidNormRL=this.m_backLeftWheel.raycastResult.hitNormalWorld;const wheelWorldPos=this.m_backLeftWheel.chassisConnectionPointWorld;const hitDistance=wheelWorldPos.subtract(skidPosRL).length();const maxWheelDistance=this.wheelRadius*this.maxWheelDistanceFactor;const upwardDot=skidNormRL.dot(BABYLON.Vector3.Up());const minUpwardAngle=this.minUpwardAngleFactor;const hasLoad=(this.m_backLeftWheel.suspensionForce!==undefined)?this.m_backLeftWheel.suspensionForce>=-10:true;isProperGroundContactRL=(hitDistance<=maxWheelDistance&&upwardDot>=minUpwardAngle&&hasLoad)}if(isProperGroundContactRL){const skidPosRL=this.m_backLeftWheel.raycastResult.hitPointWorld.clone();const skidNormRL=this.m_backLeftWheel.raycastResult.hitNormalWorld;const skidScaleRL=BABYLON.Scalar.Normalize(this.SKID_RL,this.skidThreashold,1.0);const wheelVelocity=this.getLinearVelocity();const wheelSpeedMs=wheelVelocity.length();let wheelCompensation=this.velocityCompensation.clone();if(wheelSpeedMs>15){const extraCompensation=(wheelSpeedMs-15)*0.02;const velocityDir=wheelVelocity.clone().normalize();velocityDir.scaleInPlace(extraCompensation);wheelCompensation.addInPlace(velocityDir)}skidPosRL.addInPlace(wheelCompensation);this.m_backLeftWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(skidPosRL,skidNormRL,skidScaleRL,this.m_backLeftWheelSkid);if(this.wheelDonuts===true)this.donutMeter+=this.SKID_RL;this.burnoutMeter+=this.SKID_RL;if(this.backLeftWheelParticle!=null){if(this.backLeftWheelParticle.isStarted()===false){this.backLeftWheelParticle.start()}const smoke_RL=this.SKID_RL*this.SKID_RL;this.backLeftWheelParticle.emitRate=this.smokeIntensityFactor*smoke_RL;this.backLeftWheelParticle.minSize=0.2*smoke_RL+0.2;this.backLeftWheelParticle.maxSize=1.5*smoke_RL+1.2}}else{if(this.backLeftWheelParticle!=null)this.backLeftWheelParticle.emitRate=0;this.m_backLeftWheelSkid=-1}}if(this.m_backRightWheel!=null){const wheelContactBR=(this.m_backRightWheel.raycastResult.body!=null);this.SKID_RR=this.updateCurrentSkidInfo(this.m_backRightWheel);if(this.SKID_RR<this.skidThreashold)this.SKID_RR=0;let isProperGroundContactRR=false;if(this.SKID_RR>0&&wheelContactBR===true){const skidPosRR=this.m_backRightWheel.raycastResult.hitPointWorld;const skidNormRR=this.m_backRightWheel.raycastResult.hitNormalWorld;const wheelWorldPos=this.m_backRightWheel.chassisConnectionPointWorld;const hitDistance=wheelWorldPos.subtract(skidPosRR).length();const maxWheelDistance=this.wheelRadius*this.maxWheelDistanceFactor;const upwardDot=skidNormRR.dot(BABYLON.Vector3.Up());const minUpwardAngle=this.minUpwardAngleFactor;const hasLoad=(this.m_backRightWheel.suspensionForce!==undefined)?this.m_backRightWheel.suspensionForce>=-10:true;isProperGroundContactRR=(hitDistance<=maxWheelDistance&&upwardDot>=minUpwardAngle&&hasLoad)}if(isProperGroundContactRR){const skidPosRR=this.m_backRightWheel.raycastResult.hitPointWorld.clone();const skidNormRR=this.m_backRightWheel.raycastResult.hitNormalWorld;const skidScaleRR=BABYLON.Scalar.Normalize(this.SKID_RR,this.skidThreashold,1.0);const wheelVelocity=this.getLinearVelocity();const wheelSpeedMs=wheelVelocity.length();let wheelCompensation=this.velocityCompensation.clone();if(wheelSpeedMs>15){const extraCompensation=(wheelSpeedMs-15)*0.02;const velocityDir=wheelVelocity.clone().normalize();velocityDir.scaleInPlace(extraCompensation);wheelCompensation.addInPlace(velocityDir)}skidPosRR.addInPlace(wheelCompensation);this.m_backRightWheelSkid=PROJECT.SkidMarkManager.AddSkidMarkSegment(skidPosRR,skidNormRR,skidScaleRR,this.m_backRightWheelSkid);if(this.wheelDonuts===true)this.donutMeter+=this.SKID_RR;this.burnoutMeter+=this.SKID_RR;if(this.backRightWheelParticle!=null){if(this.backRightWheelParticle.isStarted()===false){this.backRightWheelParticle.start()}const smoke_RR=this.SKID_RR*this.SKID_RR;this.backRightWheelParticle.emitRate=this.smokeIntensityFactor*smoke_RR;this.backRightWheelParticle.minSize=0.2*smoke_RR+0.2;this.backRightWheelParticle.maxSize=1.5*smoke_RR+1.2}}else{if(this.backRightWheelParticle!=null)this.backRightWheelParticle.emitRate=0;this.m_backRightWheelSkid=-1}}this.PITCH_RL=this.SKID_RL;this.PITCH_RR=this.SKID_RR;if(this.wheelBurnout==true||this.restoreTimer>0){this.PITCH_RL*=this.burnoutWheelPitch;this.PITCH_RR*=this.burnoutWheelPitch}this.WHEEL_SKID_PITCH=0;if(this.PITCH_FL>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_FL;if(this.PITCH_FR>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_FR;if(this.PITCH_RL>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_RL;if(this.PITCH_RR>this.WHEEL_SKID_PITCH)this.WHEEL_SKID_PITCH=this.PITCH_RR;if(this.playVehicleSounds===true){if(this._skidAudioSource!=null){this._skidAudioSource.setPitch(this.WHEEL_SKID_PITCH)}}if(this.brakeLightsMesh!=null){this.brakeLightsMesh.isVisible=this.isBraking()}if(this.reverseLightsMesh!=null){this.reverseLightsMesh.isVisible=this.getReverseThrottle()}if(this.SKID_FL===0&&this.SKID_FL===0&&this.SKID_FL===0&&this.SKID_FL===0){this.smokeIntensityFactor=0}if(this.postNetworkAttributes==true&&TOOLKIT.EntityController.HasNetworkEntity(this.transform)){const pitch_Attribute=this.getEnginePitchLevel();const brake_Attribute=this.isBraking()?1:0;const reverse_Attribute=this.getReverseThrottle()?1:0;const burnout_Attribute=(this.getCurrentBurnout()||this.getBurnoutButton())?1:0;const SKID_FL_Attribute=this.getFrontLeftSkid();const SKID_FR_Attribute=this.getFrontRightSkid();const SKID_RL_Attribute=this.getBackLeftSkid();const SKID_RR_Attribute=this.getBackRightSkid();const SPIN_FL_Transform=this.m_frontLeftWheel.spinner;const SPIN_FR_Transform=this.m_frontRightWheel.spinner;const SPIN_RL_Transform=this.m_backLeftWheel.spinner;const SPIN_RR_Transform=this.m_backRightWheel.spinner;TOOLKIT.EntityController.PostBufferedAttribute(this.transform,0,pitch_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,1,brake_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,2,reverse_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,3,burnout_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,4,SKID_FL_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,5,SKID_FR_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,6,SKID_RL_Attribute);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,7,SKID_RR_Attribute);if(SPIN_FL_Transform!=null&&SPIN_FL_Transform.rotationQuaternion!=null){SPIN_FL_Transform.rotationQuaternion.toEulerAnglesToRef(this.SPIN_FL_Rotation);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,8,this.SPIN_FL_Rotation.x)}else{TOOLKIT.EntityController.PostBufferedAttribute(this.transform,8,0)}if(SPIN_FR_Transform!=null&&SPIN_FR_Transform.rotationQuaternion!=null){SPIN_FR_Transform.rotationQuaternion.toEulerAnglesToRef(this.SPIN_FR_Rotation);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,9,this.SPIN_FR_Rotation.x)}else{TOOLKIT.EntityController.PostBufferedAttribute(this.transform,9,0)}if(SPIN_RL_Transform!=null&&SPIN_RL_Transform.rotationQuaternion!=null){SPIN_RL_Transform.rotationQuaternion.toEulerAnglesToRef(this.SPIN_RL_Rotation);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,10,this.SPIN_RL_Rotation.x)}else{TOOLKIT.EntityController.PostBufferedAttribute(this.transform,10,0)}if(SPIN_RR_Transform!=null&&SPIN_RR_Transform.rotationQuaternion!=null){SPIN_RR_Transform.rotationQuaternion.toEulerAnglesToRef(this.SPIN_RR_Rotation);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,11,this.SPIN_RR_Rotation.x)}else{TOOLKIT.EntityController.PostBufferedAttribute(this.transform,11,0)}TOOLKIT.EntityController.PostBufferedAttribute(this.transform,12,this.animatorSteerAngle)}this.writeTransformMetadata()}currentPitch=0;currentRoll=0;previousSpeed=0;angularVelocity=new BABYLON.Vector3(0,0,0);syncVehicleTilting(deltaTime){const vehicle=this.raycastVehicle;if(vehicle==null||this.transform.physicsBody==null)return;if(this.movementTilting===true){const currentSpeed=vehicle.getRawCurrentSpeedKph();const speedChange=(currentSpeed-this.previousSpeed);this.transform.physicsBody.getAngularVelocityToRef(this.angularVelocity);const lateralGForce=this.angularVelocity.y;if(speedChange>0){this.currentPitch-=(this.forwardPitchFactor*Math.min(speedChange,10)*deltaTime)}else if(speedChange<0){if(this.getFootBraking()===true||this.getHandBraking()===true&&this.americanSpeed<10){this.currentPitch+=(this.forwardPitchFactor*Math.min(-speedChange,10)*deltaTime)}}this.currentRoll+=(this.lateralRollFactor*lateralGForce*deltaTime);this.currentPitch*=(1.0-this.forwardRecoverRate);this.currentRoll*=(1.0-this.lateralRecoverRate);const maxPitch=BABYLON.Tools.ToRadians(this.maxForwardAngle);const maxRoll=BABYLON.Tools.ToRadians(this.maxLateralAngle);this.currentPitch=Math.max(-maxPitch,Math.min(maxPitch,this.currentPitch));this.currentRoll=Math.max(-maxRoll,Math.min(maxRoll,this.currentRoll));if(this.shiftingTime>0){const maxShiftEffect=Math.sin(this.shiftingTime*Math.PI);const forwardShiftSign=(this.currentForward>0)?1:-1;const forwardShiftEffect=(forwardShiftSign*maxShiftEffect*this.shiftForwardExtra*0.015);const lateralShiftEffect=(this.shiftingSide*maxShiftEffect*this.shiftLateralExtra*0.015);this.currentPitch+=forwardShiftEffect;this.currentRoll+=lateralShiftEffect}if(this.surfaceDetection===true){this.idleNoiseDelta+=(deltaTime*this.idleShakeRate)*3.0;this.driveNoiseDelta+=(deltaTime*BABYLON.Scalar.Lerp(this.lowSpeedScale,this.highSpeedScale,this.gradientSpeed))*3.0;const movementSpeed=Math.abs(currentSpeed);if(movementSpeed>=1){if(movementSpeed>=this.speedThreashold&&this.handBraking===false){if(this.lowForwardNoise>0||this.highForwardNoise>0){const forwardNoiseIntensity=BABYLON.Scalar.Lerp(this.lowForwardNoise,this.highForwardNoise,this.gradientSpeed);this.currentPitch+=(PROJECT.StandardCarController.SimplexNoise2D(this.driveNoiseDelta,0)*forwardNoiseIntensity*0.065)*this.roadSurfaceFactor}if(this.lowLateralNoise>0||this.highLateralNoise>0){const laterialNoiseIntensity=BABYLON.Scalar.Lerp(this.lowLateralNoise,this.highLateralNoise,this.gradientSpeed);this.currentRoll+=(PROJECT.StandardCarController.SimplexNoise2D(this.driveNoiseDelta,1)*laterialNoiseIntensity*0.065)*this.roadSurfaceFactor}}}else if(this.idleShakeNoise>0){this.currentPitch+=(PROJECT.StandardCarController.SimplexNoise2D(this.idleNoiseDelta,0)*this.idleShakeNoise*0.065);this.currentRoll+=(PROJECT.StandardCarController.SimplexNoise2D(this.idleNoiseDelta,1)*this.idleShakeNoise*0.065)}}if(this.chassisTransform!=null&&this.chassisTransform.rotationQuaternion!=null){this.chassisTransform.rotationQuaternion.toEulerAnglesToRef(this.tiltChassisEulers);const tiltAngleX=BABYLON.Scalar.Lerp(this.tiltChassisEulers.x,this.currentPitch,(this.lerpForwardFactor*deltaTime));const tiltAngleZ=BABYLON.Scalar.Lerp(this.tiltChassisEulers.z,this.currentRoll,(this.lerpLateralFactor*deltaTime));BABYLON.Quaternion.FromEulerAnglesToRef(tiltAngleX,this.tiltChassisEulers.y,tiltAngleZ,this.chassisTransform.rotationQuaternion)}this.previousSpeed=currentSpeed}}updateGearShifting(deltaTime){const gearCount=this.gearBoxShiftRatios.length;if(this.gearShiftCooldown>0){this.gearShiftCooldown-=deltaTime}if(this.shiftingTime>0){this.shiftingTime-=deltaTime;if(this.shiftingTime<=0){this.isShifting=false}}const enableShifting=!this.currentBoosting&&!this.burnoutButton&&this.gearShiftCooldown<=0;if(!enableShifting)return;if(this.americanSpeed<3){if(this.gearIndex!==0){this.initiateGearShift(0)}return}if(this.gearIndex===0&&this.americanSpeed<15){if(this.engineLoad<0.6||this.americanSpeed<12){return}}const currentGearMaxSpeed=this.gearBoxShiftUpRanges[this.gearIndex]||999;const currentGearMinSpeed=this.gearBoxShiftDownRanges[this.gearIndex]||0;if(this.gearIndex<(gearCount-1)){const shouldUpshift=this.shouldUpshift(currentGearMaxSpeed);if(shouldUpshift){this.initiateGearShift(this.gearIndex+1);return}}if(this.gearIndex>0){const shouldDownshift=this.shouldDownshift(currentGearMinSpeed);if(shouldDownshift){this.initiateGearShift(this.gearIndex-1);return}}}shouldUpshift(maxSpeed){if(this.americanSpeed<maxSpeed-1)return false;if(this.actualEngineRPM<(this.MIN_RPM+600))return false;if(this.engineLoad<0.2)return false;if(this.getCurrentBurnout()||this.getBurnoutButton())return false;if(this.gearIndex+1<this.gearBoxShiftRatios.length){const nextGearRatio=this.gearBoxShiftRatios[this.gearIndex+1];const currentGearRatio=this.gearBoxShiftRatios[this.gearIndex];const rpmAfterShift=this.actualEngineRPM*(nextGearRatio/currentGearRatio);if(rpmAfterShift<(this.MIN_RPM+400))return false}return true}shouldDownshift(minSpeed){if(this.americanSpeed>(minSpeed+1))return false;const rpmTooLow=this.actualEngineRPM<(this.MIN_RPM+500);if(this.gearIndex>0){const lowerGearRatio=this.gearBoxShiftRatios[this.gearIndex-1];const currentGearRatio=this.gearBoxShiftRatios[this.gearIndex];const rpmAfterShift=this.actualEngineRPM*(lowerGearRatio/currentGearRatio);if(rpmAfterShift>(this.MAX_RPM-300))return false}if(this.engineLoad>0.3&&rpmTooLow)return true;if(this.americanSpeed<minSpeed)return true;return false}initiateGearShift(newGear){const oldGear=this.gearIndex;this.gearIndex=BABYLON.Scalar.Clamp(newGear,0,this.gearBoxShiftRatios.length-1);if(this.gearIndex!==oldGear){this.isShifting=true;this.shiftDirection=this.gearIndex>oldGear?1:-1;this.shiftingTime=this.gearBoxShiftDelay;this.gearShiftCooldown=0.3;this.shiftingSide=TOOLKIT.Utilities.GetRandomRange(-10,10)>0?1:-1;this.shiftRPM=this.actualEngineRPM}}updateClutchEngagement(deltaTime){if(this.isShifting){const targetEngagement=0.2;this.clutchEngagement=BABYLON.Scalar.Lerp(this.clutchEngagement,targetEngagement,deltaTime*8)}else{this.clutchEngagement=BABYLON.Scalar.Lerp(this.clutchEngagement,1.0,deltaTime*6)}}getIdleRPM(){return this.MIN_RPM+(this.engineLoad*100)}writeTransformMetadata(){if(this.transform.metadata==null)this.transform.metadata={};if(this.transform.metadata.car==null)this.transform.metadata.car={};this.transform.metadata.car.forwardSpeed=this.forwardSpeed;this.transform.metadata.car.reversePower=this.maxReversePower;this.transform.metadata.car.americanSpeed=this.americanSpeed;this.transform.metadata.car.gradientSpeed=this.gradientSpeed;this.transform.metadata.car.currentForward=this.currentForward;this.transform.metadata.car.linearVelocity=this.getLinearVelocity().length();this.transform.metadata.car.normalizedSpeed=this.getNormalizedSpeed()}getVehicleEngineTorque(rpm,powerCoefficient){let result=0;if(this.engineTorqueCurve!=null){result=(TOOLKIT.Utilities.SampleAnimationFloat(this.engineTorqueCurve,BABYLON.Scalar.Clamp(rpm,this.MIN_RPM,this.MAX_RPM),BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,false)*powerCoefficient)}else{result=this.calculateDefaultEngineTorqueCurve(rpm)*powerCoefficient}return result}calculateDefaultEngineTorqueCurve(rpm){let torque=0;const clampedRPM=BABYLON.Scalar.Clamp(rpm,this.MIN_RPM,this.MAX_RPM);if(clampedRPM<=1500){const t=(clampedRPM-800)/700;torque=BABYLON.Scalar.Lerp(950,1400,BABYLON.Scalar.Clamp(t,0,1))}else if(clampedRPM<=2500){const t=(clampedRPM-1500)/1000;torque=BABYLON.Scalar.Lerp(1400,1650,t)}else if(clampedRPM<=3500){const t=(clampedRPM-2500)/1000;torque=BABYLON.Scalar.Lerp(1650,1750,t)}else if(clampedRPM<=4500){const t=(clampedRPM-3500)/1000;torque=BABYLON.Scalar.Lerp(1750,1600,t)}else if(clampedRPM<=5500){const t=(clampedRPM-4500)/1000;torque=BABYLON.Scalar.Lerp(1600,1300,t)}else if(clampedRPM<=6500){const t=(clampedRPM-5500)/1000;torque=BABYLON.Scalar.Lerp(1300,1000,t)}else{const t=(clampedRPM-6500)/1000;torque=BABYLON.Scalar.Lerp(1000,700,BABYLON.Scalar.Clamp(t,0,1))}const noise=(Math.sin(clampedRPM*0.01)*0.02);torque+=(torque*noise);return Math.max(torque,400)}createSmokeParticleSystem(name,emitter){const result=new BABYLON.ParticleSystem(name,10000,this.scene);result.blendMode=BABYLON.ParticleSystem.BLENDMODE_STANDARD;result.renderingGroupId=TOOLKIT.Utilities.DefaultRenderGroup();result.particleTexture=this.smokeTexture;result.emitter=emitter;result.emitRate=0;result.updateSpeed=0.01;result.minSize=0.2;result.maxSize=1.3;result.minAngularSpeed=-1.5;result.maxAngularSpeed=1.5;result.minLifeTime=3.0;result.maxLifeTime=5.0;result.addVelocityGradient(0,1);result.addVelocityGradient(0.1,0.7);result.addVelocityGradient(0.7,0.2);result.addVelocityGradient(1.0,0.05);result.gravity=new BABYLON.Vector3(0,-0.1,0);result.minEmitBox=new BABYLON.Vector3(0,-0.25,0);result.maxEmitBox=new BABYLON.Vector3(0,-0.25,0);result.direction1=new BABYLON.Vector3(-1,-1,-1);result.direction2=new BABYLON.Vector3(1,1,1);result.color1=new BABYLON.Color4(0.95,0.95,0.95,this.smokeOpacity);result.color2=new BABYLON.Color4(0.85,0.85,0.85,this.smokeOpacity);result.colorDead=new BABYLON.Color4(0.9,0.9,0.9,(this.smokeOpacity*0.5));return result}updateCurrentSkidInfo(wheel){return BABYLON.Scalar.Clamp((1-wheel.skidInfo))}}PROJECT.StandardCarController=StandardCarController;TOOLKIT.SceneManager.RegisterClass("PROJECT.StandardCarController",StandardCarController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class VehicleCameraManager extends TOOLKIT.ScriptComponent{enableCamera=false;followTarget=false;followHeight=1.25;pitchingAngle=0.0;rotationDamping=5.0;minimumDistance=4.0;maximumDistance=5.0;buttonCamera=BABYLON.Xbox360Button.Y;keyboardCamera=TOOLKIT.UserInputKey.P;tickRemoteEntities=false;fastMotionBlur=false;lowSpeedBlurring=0.0;highSpeedBlurring=20.0;motionBlurSamples=32;isObjectBasedBlur=true;fastCameraShake=false;lowSpeedShaking=1.0;highSpeedShaking=1.0;firstPerson=false;cameraPivot=null;targetEulers=BABYLON.Vector3.Zero();cameraRotation=BABYLON.Quaternion.Zero();cameraPivotOffset=BABYLON.Vector3.Zero();autoAttachCamera=false;motionBlurAttached=false;m_freeCamera=null;m_motionBlur=null;m_cameraTransform=null;m_inputController=null;m_standardController=null;m_firstPersonOffset=new BABYLON.Vector3(0.0,1.15,0.15);constructor(transform,scene,properties={},alias="PROJECT.VehicleCameraManager"){super(transform,scene,properties,alias)}awake(){this.awakeCameraManager()}start(){this.initCameraManager()}late(){this.lateUpdateCameraManager()}destroy(){this.destroyCameraManager()}awakeCameraManager(){this.enableCamera=this.getProperty("enableCamera",this.enableCamera);this.followTarget=this.getProperty("followTarget",this.followTarget);this.followHeight=this.getProperty("followHeight",this.followHeight);this.pitchingAngle=this.getProperty("pitchingAngle",this.pitchingAngle);this.rotationDamping=this.getProperty("rotationDamping",this.rotationDamping);this.minimumDistance=this.getProperty("minimumDistance",this.minimumDistance);this.maximumDistance=this.getProperty("maximumDistance",this.maximumDistance);this.autoAttachCamera=this.getProperty("attachCamera",this.autoAttachCamera);this.tickRemoteEntities=this.getProperty("tickRemoteEntities",this.tickRemoteEntities);this.fastMotionBlur=this.getProperty("fastMotionBlur",this.fastMotionBlur);this.lowSpeedBlurring=this.getProperty("lowSpeedBlurring",this.lowSpeedBlurring);this.highSpeedBlurring=this.getProperty("highSpeedBlurring",this.highSpeedBlurring);this.motionBlurSamples=this.getProperty("motionBlurSamples",this.motionBlurSamples);this.isObjectBasedBlur=this.getProperty("isObjectBasedBlur",this.isObjectBasedBlur);this.fastCameraShake=this.getProperty("fastCameraShake",this.fastCameraShake);this.lowSpeedShaking=this.getProperty("lowSpeedShaking",this.lowSpeedShaking);this.highSpeedShaking=this.getProperty("highSpeedShaking",this.highSpeedShaking);const firstPersonOffset=this.getProperty("firstPersonOffset");if(firstPersonOffset!=null)this.m_firstPersonOffset=TOOLKIT.Utilities.ParseVector3(firstPersonOffset);if(this.rotationDamping<=0)this.rotationDamping=1}initCameraManager(){this.m_standardController=this.getComponent("PROJECT.StandardCarController");this.m_inputController=this.getComponent("PROJECT.VehicleInputController");if(this.m_inputController!=null){TOOLKIT.InputController.OnKeyboardPress(this.keyboardCamera,()=>{this.togglePlayerCamera()});TOOLKIT.InputController.OnGamepadButtonPress(this.buttonCamera,()=>{this.togglePlayerCamera()})}}lateUpdateCameraManager(){if(this.m_cameraTransform==null&&this.autoAttachCamera===true){if(this.m_inputController!=null)this.attachPlayerCamera(this.m_inputController.playerNumber)}if(this.firstPerson===true){this.firstPersonCamera()}else{this.thirdPersonCamera()}if(this.m_freeCamera!=null&&this.m_motionBlur!=null&&this.m_standardController!=null){if(this.m_standardController.isBoosting()){if(this.motionBlurAttached===false){this.m_freeCamera.attachPostProcess(this.m_motionBlur);this.motionBlurAttached=true}this.m_motionBlur.motionStrength=BABYLON.Scalar.Lerp(this.lowSpeedBlurring,this.highSpeedBlurring,this.m_standardController.getGradientSpeed())}else{this.m_motionBlur.motionStrength=this.lowSpeedBlurring;if(this.motionBlurAttached===true){this.m_freeCamera.detachPostProcess(this.m_motionBlur);this.motionBlurAttached=false}}}}destroyCameraManager(){this.m_standardController=null;this.m_cameraTransform=null}attachPlayerCamera(player){if(this.m_cameraTransform==null){const playerCamera=(player<=0||player>4)?1:player;this.m_freeCamera=PROJECT.DefaultCameraSystem.GetMainCamera(this.scene);this.m_cameraTransform=PROJECT.DefaultCameraSystem.GetCameraTransform(this.scene,playerCamera);if(this.m_cameraTransform!=null&&this.followTarget===true){if(this.cameraPivot==null){this.cameraPivot=new BABYLON.TransformNode(this.transform.name+".CameraPivot",this.scene);this.cameraPivot.parent=null;this.cameraPivot.position=this.transform.position.clone();this.cameraPivot.rotationQuaternion=this.transform.rotationQuaternion.clone()}this.m_cameraTransform.parent=this.cameraPivot;this.m_cameraTransform.position.set(0,0,0);this.m_cameraTransform.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1)}if(this.m_motionBlur==null&&this.m_freeCamera!=null&&this.fastMotionBlur===true){try{this.m_motionBlur=new BABYLON.MotionBlurPostProcess("FastMotionBlur",this.scene,1.0,this.m_freeCamera)}catch(e){console.warn(e)}try{if(this.m_motionBlur!=null){this.m_freeCamera.detachPostProcess(this.m_motionBlur);this.m_motionBlur.isObjectBased=this.isObjectBasedBlur;this.m_motionBlur.motionStrength=this.lowSpeedBlurring;this.m_motionBlur.motionBlurSamples=this.motionBlurSamples;this.motionBlurAttached=false}}catch(e){console.warn(e)}}}}togglePlayerCamera(){this.firstPerson=!this.firstPerson}firstPersonCamera(){if(this.enableCamera===true&&this.m_cameraTransform!=null&&this.m_standardController!=null){if(this.followTarget===true){if(this.cameraPivot!=null){TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.cameraPivot.position);this.cameraPivot.rotationQuaternion.copyFrom(this.transform.rotationQuaternion);this.m_cameraTransform.position.copyFrom(this.m_firstPersonOffset);TOOLKIT.Utilities.FromEulerToRef(0,0,0,this.m_cameraTransform.rotationQuaternion)}}else{this.m_cameraTransform.lookAt(this.transform.position)}}}thirdPersonCamera(){if(this.enableCamera===true&&this.m_cameraTransform!=null&&this.m_standardController!=null){if(this.followTarget===true){if(this.cameraPivot!=null){const deltaTime=this.getDeltaSeconds();this.cameraPivotOffset.set(0,this.followHeight,0);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.cameraPivot.position,this.cameraPivotOffset);const turnDampener=(deltaTime*this.rotationDamping);this.transform.rotationQuaternion.toEulerAnglesToRef(this.targetEulers);BABYLON.Quaternion.FromEulerAnglesToRef((this.targetEulers.x+BABYLON.Tools.ToRadians(this.pitchingAngle)),this.targetEulers.y,0,this.cameraRotation);BABYLON.Quaternion.SlerpToRef(this.cameraPivot.rotationQuaternion,this.cameraRotation,turnDampener,this.cameraPivot.rotationQuaternion);const cameraBoomDistance=BABYLON.Scalar.Lerp(this.minimumDistance,this.maximumDistance,this.m_standardController.getGradientSpeed());this.m_cameraTransform.position.set(0,0,-cameraBoomDistance)}}else{this.m_cameraTransform.lookAt(this.transform.position)}}}}PROJECT.VehicleCameraManager=VehicleCameraManager;TOOLKIT.SceneManager.RegisterClass("PROJECT.VehicleCameraManager",VehicleCameraManager)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class VehicleInputController extends TOOLKIT.ScriptComponent{playerDeltaX=0;playerDeltaY=0;playerMouseX=0;playerMouseY=0;ackermanRadius=0.85;recoveryRadius=0.25;waypointPosition=BABYLON.Vector3.Zero();waypointCount=0;waypointIndex=0;noMovementTime=0;reverseFixMode=false;recoveryFixMode=false;nextTargetSpeed=0;prevTargetSpeed=0;vehicleResetCheck=0;randomSkillFactor=0;showChaseRabbit=false;showSensorLines=false;steeringWheelMode=-1;rabbitTrackerLine=null;rabbitTrackerColor=new BABYLON.Color3(1,1,1);greenTrackingColor=new BABYLON.Color3(0,1,0);redTrackingColor=new BABYLON.Color3(1,0,0);localTargetPosition=new BABYLON.Vector3(0,0,0);avoidPositionOffset=new BABYLON.Vector3(0,0,0);avoidanceLerp=0;avoidanceTimer=0;avoidanceValue=0;randomTurning=0;randomBoosting=0;randomDistance=0;lastCheckpoint=-1;mainCenterSensorLine=null;mainRightSensorLine=null;mainLeftSensorLine=null;angleRightSensorLine=null;angleLeftSensorLine=null;sideRightSensorLine=null;sideLeftSensorLine=null;backRightSensorLine=null;backLeftSensorLine=null;sidewaysOffsetVector=BABYLON.Vector3.Zero();backBumperEdgeVector=BABYLON.Vector3.Zero();sensorStartPos=BABYLON.Vector3.Zero();sensorPointPos=BABYLON.Vector3.Zero();sensorAnglePos=BABYLON.Vector3.Zero();rsideStartPos=BABYLON.Vector3.Zero();rsidePointPos=BABYLON.Vector3.Zero();lsideStartPos=BABYLON.Vector3.Zero();lsidePointPos=BABYLON.Vector3.Zero();tempScaleVector=BABYLON.Vector3.Zero();rbackStartPos=BABYLON.Vector3.Zero();rbackPointPos=BABYLON.Vector3.Zero();lbackStartPos=BABYLON.Vector3.Zero();lbackPointPos=BABYLON.Vector3.Zero();trackVehiclePosition=BABYLON.Vector3.Zero();trackRabbitPosition=BABYLON.Vector3.Zero();getPlayerDeltaX(){return this.playerDeltaX}getPlayerDeltaY(){return this.playerDeltaY}getPlayerMouseX(){return this.playerMouseX}getPlayerMouseY(){return this.playerMouseY}getWaypointIndex(){return this.waypointIndex}getChaseRabbitMesh(){return this.m_chaseRabbitMesh}resetChaseRabbitMesh(){if(this.m_chaseRabbitMesh!=null){this.m_chaseRabbitMesh.position=this.transform.position.clone();this.m_chaseRabbitMesh.rotationQuaternion=this.transform.rotationQuaternion.clone()}}getChasePointMesh(){return this.m_chasePointMesh}resetChasePointMesh(){if(this.m_chasePointMesh!=null){this.m_chasePointMesh.position=this.transform.position.clone();this.m_chasePointMesh.rotationQuaternion=this.transform.rotationQuaternion.clone()}}enableInput=false;resetTiming=3.0;playerNumber=TOOLKIT.PlayerNumber.One;pedelForward=7;triggerForward=TOOLKIT.Xbox360Trigger.Right;keyboardForawrd=TOOLKIT.UserInputKey.W;auxKeyboardForawrd=TOOLKIT.UserInputKey.UpArrow;pedalBackward=6;triggerBackwards=TOOLKIT.Xbox360Trigger.Left;keyboardBackwards=TOOLKIT.UserInputKey.S;auxKeyboardBackwards=TOOLKIT.UserInputKey.DownArrow;pedalBooster=1;keyboardBooster=TOOLKIT.UserInputKey.Ctrl;leftButtonBooster=BABYLON.Xbox360Button.LB;rightButtonBooster=BABYLON.Xbox360Button.RB;buttonHandbrake=BABYLON.Xbox360Button.X;keyboardHandbrake=TOOLKIT.UserInputKey.SpaceBar;leftWheelHandbrake=4;rightWheelHandbrake=5;keyboardBurnout=TOOLKIT.UserInputKey.Shift;buttonBurnout=BABYLON.Xbox360Button.B;leftWheelBurnout=10;rightWheelBurnout=11;raceLineNode=0;minLookAhead=5;maxLookAhead=50;driverSkillLevel=1;chaseRabbitSpeed=1.0;throttleSensitivity=1;steeringSensitivity=1;brakingSensitivity=1;brakingTurnAngle=15;brakingSpeedLimit=90;skiddingSpeedLimit=100;linearDampenForce=0.1;driveSpeedMultiplier=5.0;driveLineDistance=1.0;resetMovingTimeout=3;reverseThrottleTime=3;maxRaceTrackSpeed=0;trackManagerIdentity="TrackManager";vehicleTag="Vehicle";obstacleTag="Obstacle";sensorLength=8;spacerWidths=0.85;angleFactors=1.5;initialOffsetX=1;initialOffsetY=0.5;initialOffsetZ=2;sidewaysLength=1.5;sidewaysOffset=0.5;backBumperEdge=2.5;powerBoosting=0.5;wonderDistance=1.0;avoidanceFactor=0.5;avoidanceSpeed=3.0;avoidanceTimeout=3.0;avoidanceDistance=2.0;reversingFlag=false;reversingTime=0.0;reversingWait=2.0;reversingFor=1.5;m_chasePointMesh=null;m_chaseRabbitMesh=null;m_circuitInterfaces=null;m_circuitRaceLine_1=null;m_circuitRaceLine_2=null;m_circuitRaceLine_3=null;m_circuitRaceLine_4=null;m_circuitRaceLine_5=null;m_rigidbodyPhysics=null;m_checkpointManager=null;m_standardCarController=null;constructor(transform,scene,properties={},alias="PROJECT.VehicleInputController"){super(transform,scene,properties,alias)}awake(){this.awakeVehicleController()}start(){this.initVehicleController()}update(){this.updateVehicleController()}destroy(){this.destroyVehicleController()}awakeVehicleController(){this.enableInput=this.getProperty("enableInput",this.enableInput);this.resetTiming=this.getProperty("resetTiming",this.resetTiming);this.playerNumber=this.getProperty("playerNumber",this.playerNumber);this.ackermanRadius=this.getProperty("ackermanRadius",this.ackermanRadius);this.recoveryRadius=this.getProperty("recoveryRadius",this.recoveryRadius);this.showChaseRabbit=this.getProperty("showChaseRabbit",this.showChaseRabbit);this.showSensorLines=this.getProperty("showSensorLines",this.showSensorLines);this.minLookAhead=this.getProperty("minLookAhead",this.minLookAhead);this.maxLookAhead=this.getProperty("maxLookAhead",this.maxLookAhead);this.driverSkillLevel=this.getProperty("driverSkillLevel",this.driverSkillLevel);this.throttleSensitivity=this.getProperty("throttleSensitivity",this.throttleSensitivity);this.steeringSensitivity=this.getProperty("steeringSensitivity",this.steeringSensitivity);this.brakingSensitivity=this.getProperty("brakingSensitivity",this.brakingSensitivity);this.brakingTurnAngle=this.getProperty("brakingTurnAngle",this.brakingTurnAngle);this.brakingSpeedLimit=this.getProperty("brakingSpeedLimit",this.brakingSpeedLimit);this.skiddingSpeedLimit=this.getProperty("skiddingSpeedLimit",this.skiddingSpeedLimit);this.linearDampenForce=this.getProperty("linearDampenForce",this.linearDampenForce);this.resetMovingTimeout=this.getProperty("resetMovingTimeout",this.resetMovingTimeout);this.reverseThrottleTime=this.getProperty("reverseThrottleTime",this.reverseThrottleTime);this.driveSpeedMultiplier=this.getProperty("driveSpeedMultiplier",this.driveSpeedMultiplier);this.driveLineDistance=this.getProperty("driveLineDistance",this.driveLineDistance);this.maxRaceTrackSpeed=this.getProperty("maxRaceTrackSpeed",this.maxRaceTrackSpeed);this.trackManagerIdentity=this.getProperty("trackManagerIdentity",this.trackManagerIdentity);this.vehicleTag=this.getProperty("vehicleTag",this.vehicleTag);this.obstacleTag=this.getProperty("obstacleTag",this.obstacleTag);this.sensorLength=this.getProperty("sensorLength",this.sensorLength);this.spacerWidths=this.getProperty("spacerWidths",this.spacerWidths);this.angleFactors=this.getProperty("angleFactors",this.angleFactors);this.initialOffsetX=this.getProperty("initialOffsetX",this.initialOffsetX);this.initialOffsetY=this.getProperty("initialOffsetY",this.initialOffsetY);this.initialOffsetZ=this.getProperty("initialOffsetZ",this.initialOffsetZ);this.sidewaysLength=this.getProperty("sidewaysLength",this.sidewaysLength);this.sidewaysOffset=this.getProperty("sidewaysOffset",this.sidewaysOffset);this.backBumperEdge=this.getProperty("backBumperEdge",this.backBumperEdge);this.powerBoosting=this.getProperty("powerBoosting",this.powerBoosting);this.wonderDistance=this.getProperty("wonderDistance",this.wonderDistance);this.avoidanceFactor=this.getProperty("avoidanceFactor",this.avoidanceFactor);this.avoidanceSpeed=this.getProperty("avoidanceSpeed",this.avoidanceSpeed);this.avoidanceTimeout=this.getProperty("avoidanceTimeout",this.avoidanceTimeout);this.avoidanceDistance=this.getProperty("avoidanceDistance",this.avoidanceDistance);if(this.ackermanRadius<=0)this.ackermanRadius=1;if(this.recoveryRadius<=0)this.recoveryRadius=1;if(this.resetMovingTimeout<=0)this.resetMovingTimeout=3;if(this.reverseThrottleTime<=0)this.reverseThrottleTime=3;if(this.throttleSensitivity<=0)this.throttleSensitivity=1;if(this.steeringSensitivity<=0)this.steeringSensitivity=1;if(this.brakingSensitivity<=0)this.brakingSensitivity=1;if(this.linearDampenForce<=0)this.linearDampenForce=0.1;if(this.angleFactors<=0)this.angleFactors=1.5;if(this.sensorLength<=0)this.sensorLength=8;if(this.sidewaysLength<=0)this.sidewaysLength=1;if(this.brakingSpeedLimit<=0)this.brakingSpeedLimit=40;if(this.skiddingSpeedLimit<=0)this.skiddingSpeedLimit=80;if(this.driveSpeedMultiplier<=1)this.driveSpeedMultiplier=5;if(this.trackManagerIdentity==null||this.trackManagerIdentity==="")this.trackManagerIdentity="TrackManager";const initialRaceLineNode=this.getProperty("initialRaceLineNode",1);this.raceLineNode=(initialRaceLineNode-1);const randomizer=this.getRandomNumber(10,15)*1000;TOOLKIT.WindowManager.SetInterval(randomizer,()=>{this.randomSkillFactor=this.getRandomNumber(1,20)})}initVehicleController(){this.m_rigidbodyPhysics=this.getComponent("TOOLKIT.RigidbodyPhysics");this.m_checkpointManager=this.getComponent("PROJECT.CheckpointManager");if(this.m_rigidbodyPhysics!=null){this.m_rigidbodyPhysics.onCollisionEnterObservable.add(mesh=>{const tag=TOOLKIT.SceneManager.GetTransformTag(mesh);if(tag===this.vehicleTag){}});this.m_rigidbodyPhysics.onCollisionStayObservable.add(mesh=>{if(mesh!=null){const tag=TOOLKIT.SceneManager.GetTransformTag(mesh);if(tag===this.vehicleTag){}}});this.m_rigidbodyPhysics.onCollisionExitObservable.add(mesh=>{if(mesh!=null){const tag=TOOLKIT.SceneManager.GetTransformTag(mesh);if(tag===this.vehicleTag){}}})}else{TOOLKIT.SceneManager.LogWarning("Null rigidbody physics for: "+this.transform.name)}this.m_standardCarController=this.getComponent("PROJECT.StandardCarController");const waypointsTransform=TOOLKIT.SceneManager.GetTransformNode(this.scene,this.trackManagerIdentity);if(waypointsTransform!=null){const raceTrackManager=TOOLKIT.SceneManager.FindScriptComponent(waypointsTransform,"PROJECT.RaceTrackManager");if(raceTrackManager!=null){this.waypointCount=0;this.waypointIndex=0;this.m_circuitInterfaces=raceTrackManager.getTrackNodes();this.m_circuitRaceLine_1=raceTrackManager.getControlPoints(0);this.m_circuitRaceLine_2=raceTrackManager.getControlPoints(1);this.m_circuitRaceLine_3=raceTrackManager.getControlPoints(2);this.m_circuitRaceLine_4=raceTrackManager.getControlPoints(3);this.m_circuitRaceLine_5=raceTrackManager.getControlPoints(4);if(this.m_circuitInterfaces!=null&&this.m_circuitInterfaces.length>0){this.waypointCount=this.m_circuitInterfaces.length}}else{TOOLKIT.SceneManager.LogWarning("Fail to locate race track manager for: "+this.transform.name)}}else{TOOLKIT.SceneManager.LogWarning("Fail to locate race track manager '"+this.trackManagerIdentity+"' for: "+this.transform.name)}}updateVehicleController(){if(this.enableInput===true){if(this.playerNumber===0){this.updateAutoPilotDrive()}else{this.updateManualInputDrive()}}if(this.resetTiming>0&&this.m_standardCarController!=null){const gameTime=TOOLKIT.SceneManager.GetGameTime();if(this.transform.up.y>0.5||this.m_standardCarController.getAbsoluteSpeed()>1){this.vehicleResetCheck=gameTime}if(gameTime>(this.vehicleResetCheck+this.resetTiming)){this.transform.position.addInPlace(BABYLON.Vector3.Up().scale(0.5));TOOLKIT.Utilities.LookRotationToRef(this.transform.forward,this.transform.rotationQuaternion)}}}updateManualInputDrive(){if(this.m_standardCarController!=null){this.playerDeltaX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Horizontal,this.playerNumber);this.playerDeltaY=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Vertical,this.playerNumber);this.playerMouseX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseX,this.playerNumber);this.playerMouseY=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseY,this.playerNumber);const auxForwardKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.auxKeyboardForawrd);const forwardKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.keyboardForawrd);const forwardTrigger=TOOLKIT.InputController.GetGamepadTriggerInput(this.triggerForward,this.playerNumber);const forwardPedal=TOOLKIT.InputController.GetGamepadButtonInput(this.pedelForward,this.playerNumber);const auxBackwardKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.auxKeyboardBackwards);const backwardKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.keyboardBackwards);const backwardTrigger=TOOLKIT.InputController.GetGamepadTriggerInput(this.triggerBackwards,this.playerNumber);const backwardPedal=TOOLKIT.InputController.GetGamepadButtonInput(this.pedalBackward,this.playerNumber);const boosterPedal=TOOLKIT.InputController.GetGamepadButtonInput(this.pedalBooster,this.playerNumber);const boosterKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.keyboardBooster);const boosterButton_L=TOOLKIT.InputController.GetGamepadButtonInput(this.leftButtonBooster,this.playerNumber);const boosterButton_R=TOOLKIT.InputController.GetGamepadButtonInput(this.rightButtonBooster,this.playerNumber);const handbrakeKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.keyboardHandbrake);const handbrakeWheel_L=TOOLKIT.InputController.GetGamepadButtonInput(this.leftWheelHandbrake,this.playerNumber);const handbrakeWheel_R=TOOLKIT.InputController.GetGamepadButtonInput(this.rightWheelHandbrake,this.playerNumber);const handbrakeButton=TOOLKIT.InputController.GetGamepadButtonInput(this.buttonHandbrake,this.playerNumber);const burnoutKeyboard=TOOLKIT.InputController.GetKeyboardInput(this.keyboardBurnout);const burnoutButton_L=TOOLKIT.InputController.GetGamepadButtonInput(this.leftWheelBurnout,this.playerNumber);const burnoutButton_R=TOOLKIT.InputController.GetGamepadButtonInput(this.rightWheelBurnout,this.playerNumber);const burnoutButton=TOOLKIT.InputController.GetGamepadButtonInput(this.buttonBurnout,this.playerNumber);let playerMovement=0;let playerSteering=0;let playerHandbrake=false;let playerBurnout=false;let speedBooster=false;let wheelInput=false;if(forwardTrigger>0.2)playerMovement=forwardTrigger;else if(forwardPedal===true){playerMovement=1;wheelInput=true}else if(this.playerNumber===TOOLKIT.PlayerNumber.One&&(forwardKeyboard===true||auxForwardKeyboard===true))playerMovement=1;else if(TOOLKIT.InputController.AllowMobileControls===true&&TOOLKIT.InputController.MobileControlsActive===true&&this.playerDeltaY>0)playerMovement=this.playerDeltaY;if(backwardTrigger>0.2)playerMovement=-backwardTrigger;else if(backwardPedal===true){playerMovement=-1;wheelInput=true}else if(this.playerNumber===TOOLKIT.PlayerNumber.One&&(backwardKeyboard===true||auxBackwardKeyboard===true))playerMovement=-1;else if(TOOLKIT.InputController.AllowMobileControls===true&&TOOLKIT.InputController.MobileControlsActive===true&&this.playerDeltaY<0)playerMovement=this.playerDeltaY;playerSteering=this.playerDeltaX;playerHandbrake=(handbrakeKeyboard===true||handbrakeButton===true||handbrakeWheel_L===true||handbrakeWheel_R===true);playerBurnout=(burnoutKeyboard===true||burnoutButton===true||burnoutButton_L===true||burnoutButton_R===true);speedBooster=(boosterKeyboard===true||boosterButton_L===true||boosterButton_R===true||boosterPedal===true);if(this.steeringWheelMode===-1&&TOOLKIT.UserInputOptions.SupportedInputDevices!=null&&TOOLKIT.UserInputOptions.SupportedInputDevices.length>0){const gamepad=TOOLKIT.InputController.GetGamepad(this.playerNumber);if(gamepad!=null&&gamepad.id!=null){let foundSupportedDevice=false;for(let index=0;index<TOOLKIT.UserInputOptions.SupportedInputDevices.length;index++){const wheel=TOOLKIT.UserInputOptions.SupportedInputDevices[index];if(wheel==null||wheel.deviceName==null)continue;if(gamepad.id.toLowerCase().indexOf(wheel.deviceName.toLowerCase())>=0){if(wheel.forwardButton>-1)this.pedelForward=wheel.forwardButton;if(wheel.backwardButton>-1)this.pedalBackward=wheel.backwardButton;if(wheel.leftHandBrake>-1)this.leftWheelHandbrake=wheel.leftHandBrake;if(wheel.rightHandBrake>-1)this.rightWheelHandbrake=wheel.rightHandBrake;if(wheel.leftBurnoutBoost>-1)this.leftWheelBurnout=wheel.leftBurnoutBoost;if(wheel.rightBurnoutBoost>-1)this.rightWheelBurnout=wheel.rightBurnoutBoost;foundSupportedDevice=true;console.warn(gamepad.id+" steering wheel controls attached to: "+this.transform.name);break}}this.steeringWheelMode=(foundSupportedDevice===true)?1:0}}this.m_standardCarController.ackermanTurnFactor=(wheelInput===true)?this.ackermanRadius:1.0;this.m_standardCarController.throttleEngineSpeed=0;this.m_standardCarController.throttleBrakingForce=0;this.m_standardCarController.drive(playerMovement,playerSteering,playerHandbrake,playerBurnout,0,false,speedBooster)}}autoDriveRaycastResult=new BABYLON.PhysicsRaycastResult;updateAutoPilotDrive(){if(this.m_standardCarController!=null){const gameTime=this.getGameTime();const deltaTime=this.getDeltaSeconds();const transformPosition=this.transform.getAbsolutePosition();this.raceLineNode=BABYLON.Scalar.Clamp(this.raceLineNode,0,4);if(this.m_chaseRabbitMesh==null){this.m_chaseRabbitMesh=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".Rabbit",{segments:24,diameter:1},this.scene);this.m_chaseRabbitMesh.checkCollisions=false;this.m_chaseRabbitMesh.receiveShadows=false;this.m_chaseRabbitMesh.visibility=1.0;this.m_chaseRabbitMesh.isVisible=false;this.resetChaseRabbitMesh()}if(this.m_chaseRabbitMesh!=null){if(this.m_chaseRabbitMesh.isVisible===true&&this.showChaseRabbit===false){this.m_chaseRabbitMesh.isVisible=false}if(this.m_chaseRabbitMesh.isVisible===false&&this.showChaseRabbit===true){this.m_chaseRabbitMesh.isVisible=true}}if(this.m_chasePointMesh==null){this.m_chasePointMesh=BABYLON.MeshBuilder.CreateBox(this.transform.name+".Point",{size:0.9},this.scene);this.m_chasePointMesh.checkCollisions=false;this.m_chasePointMesh.receiveShadows=false;this.m_chasePointMesh.visibility=1.0;this.m_chasePointMesh.isVisible=false;this.resetChasePointMesh()}if(this.m_chasePointMesh!=null){if(this.m_chasePointMesh.isVisible===true&&this.showChaseRabbit===false){this.m_chasePointMesh.isVisible=false}if(this.m_chasePointMesh.isVisible===false&&this.showChaseRabbit===true){this.m_chasePointMesh.isVisible=true}}if(this.avoidanceTimer>0){this.avoidanceTimer-=deltaTime;if(this.avoidanceTimer<=0){this.avoidanceTimer=0;this.avoidanceValue=0}}let tagname="";let contact=false;let raycast=this.autoDriveRaycastResult;let avoidance=0;this.sidewaysOffsetVector.set(0,0,-this.sidewaysOffset);this.backBumperEdgeVector.set(0,0,-this.backBumperEdge);this.sensorStartPos.copyFrom(transformPosition);this.transform.up.scaleAndAddToRef(this.initialOffsetY,this.sensorStartPos);this.transform.forward.scaleAndAddToRef(this.initialOffsetZ,this.sensorStartPos);this.sensorPointPos.copyFrom(this.sensorStartPos);this.transform.forward.scaleAndAddToRef(this.sensorLength,this.sensorPointPos);this.sensorAnglePos.copyFrom(this.sensorPointPos);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.rsideStartPos,this.sidewaysOffsetVector);this.transform.up.scaleAndAddToRef(this.initialOffsetY,this.rsideStartPos);this.transform.right.scaleAndAddToRef(this.initialOffsetX,this.rsideStartPos);this.rsidePointPos.copyFrom(this.rsideStartPos);this.transform.right.scaleAndAddToRef(this.sidewaysLength,this.rsidePointPos);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.rbackStartPos,this.backBumperEdgeVector);this.transform.up.scaleAndAddToRef(this.initialOffsetY,this.rbackStartPos);this.transform.right.scaleAndAddToRef(this.initialOffsetX,this.rbackStartPos);this.rbackPointPos.copyFrom(this.rbackStartPos);this.transform.right.scaleAndAddToRef(this.sidewaysLength,this.rbackPointPos);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.lsideStartPos,this.sidewaysOffsetVector);this.transform.up.scaleAndAddToRef(this.initialOffsetY,this.lsideStartPos);this.transform.right.scaleAndAddToRef(-this.initialOffsetX,this.lsideStartPos);this.lsidePointPos.copyFrom(this.lsideStartPos);this.transform.right.scaleAndAddToRef(-this.sidewaysLength,this.lsidePointPos);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.lbackStartPos,this.backBumperEdgeVector);this.transform.up.scaleAndAddToRef(this.initialOffsetY,this.lbackStartPos);this.transform.right.scaleAndAddToRef(-this.initialOffsetX,this.lbackStartPos);this.lbackPointPos.copyFrom(this.lbackStartPos);this.transform.right.scaleAndAddToRef(-this.sidewaysLength,this.lbackPointPos);const firstSensorStartPos=this.sensorStartPos.clone();const firstSensorPointPos=this.sensorPointPos.clone();let mainRightSensorContact=false;this.transform.right.scaleToRef(this.spacerWidths,this.tempScaleVector);this.sensorStartPos.addInPlace(this.tempScaleVector);this.sensorPointPos.addInPlace(this.tempScaleVector);tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.sensorStartPos,this.sensorPointPos,raycast);if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){mainRightSensorContact=true;avoidance-=1.0}}if(this.showSensorLines===true){if(this.mainRightSensorLine==null)this.mainRightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".MainRightSensorLine",this.scene);if(contact===true){this.mainRightSensorLine.drawLine([this.sensorStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.mainRightSensorLine.drawLine([this.sensorStartPos,this.sensorPointPos],BABYLON.Color3.Blue())}}let angleRightSensorContact=false;this.transform.right.scaleToRef((this.spacerWidths*2)*this.angleFactors,this.tempScaleVector);this.sensorAnglePos.addInPlace(this.tempScaleVector);tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.sensorStartPos,this.sensorAnglePos,raycast);if(mainRightSensorContact===false){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){angleRightSensorContact=true;avoidance-=0.5}}}if(this.showSensorLines===true){if(this.angleRightSensorLine==null)this.angleRightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".AngleRightSensorLine",this.scene);if(contact===true){this.angleRightSensorLine.drawLine([this.sensorStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.angleRightSensorLine.drawLine([this.sensorStartPos,this.sensorAnglePos],BABYLON.Color3.Blue())}}let sideRightSensorContact=false;tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.rsideStartPos,this.rsidePointPos,raycast);if(mainRightSensorContact===false&&angleRightSensorContact===false){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){sideRightSensorContact=true;avoidance-=0.5}}}if(this.showSensorLines===true){if(this.sideRightSensorLine==null)this.sideRightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".SideRightSensorLine",this.scene);if(contact===true){this.sideRightSensorLine.drawLine([this.rsideStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.sideRightSensorLine.drawLine([this.rsideStartPos,this.rsidePointPos],BABYLON.Color3.Blue())}}tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.rbackStartPos,this.rbackPointPos,raycast);if(mainRightSensorContact===false&&angleRightSensorContact===false&&sideRightSensorContact===false){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){avoidance-=0.5}}}if(this.showSensorLines===true){if(this.backRightSensorLine==null)this.backRightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".BackRightSensorLine",this.scene);if(contact===true){this.backRightSensorLine.drawLine([this.rbackStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.backRightSensorLine.drawLine([this.rbackStartPos,this.rbackPointPos],BABYLON.Color3.Blue())}}let mainLeftSensorContact=false;this.transform.right.scaleToRef(-(this.spacerWidths*2),this.tempScaleVector);this.sensorStartPos.addInPlace(this.tempScaleVector);this.sensorPointPos.addInPlace(this.tempScaleVector);tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.sensorStartPos,this.sensorPointPos,raycast);if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){mainLeftSensorContact=true;avoidance+=1.0}}if(this.showSensorLines===true){if(this.mainLeftSensorLine==null)this.mainLeftSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".MainLeftSensorLine",this.scene);if(contact===true){this.mainLeftSensorLine.drawLine([this.sensorStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.mainLeftSensorLine.drawLine([this.sensorStartPos,this.sensorPointPos],BABYLON.Color3.Blue())}}let angleLeftSensorContact=false;this.transform.right.scaleToRef(-(this.spacerWidths*4)*this.angleFactors,this.tempScaleVector);this.sensorAnglePos.addInPlace(this.tempScaleVector);tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.sensorStartPos,this.sensorAnglePos,raycast);if(mainLeftSensorContact===false){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){angleLeftSensorContact=true;avoidance+=0.5}}}if(this.showSensorLines===true){if(this.angleLeftSensorLine==null)this.angleLeftSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".AngleLeftSensorLine",this.scene);if(contact===true){this.angleLeftSensorLine.drawLine([this.sensorStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.angleLeftSensorLine.drawLine([this.sensorStartPos,this.sensorAnglePos],BABYLON.Color3.Blue())}}let sideLeftSensorContact=false;tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.lsideStartPos,this.lsidePointPos,raycast);if(mainLeftSensorContact===false&&angleLeftSensorContact===false){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){sideLeftSensorContact=true;avoidance+=0.5}}}if(this.showSensorLines===true){if(this.sideLeftSensorLine==null)this.sideLeftSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".SideLeftSensorLine",this.scene);if(contact===true){this.sideLeftSensorLine.drawLine([this.lsideStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.sideLeftSensorLine.drawLine([this.lsideStartPos,this.lsidePointPos],BABYLON.Color3.Blue())}}tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(this.lbackStartPos,this.lbackPointPos,raycast);if(mainLeftSensorContact===false&&angleLeftSensorContact===false&&sideLeftSensorContact===false){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){avoidance+=0.5}}}if(this.showSensorLines===true){if(this.backLeftSensorLine==null)this.backLeftSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".BackLeftSensorLine",this.scene);if(contact===true){this.backLeftSensorLine.drawLine([this.lbackStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.backLeftSensorLine.drawLine([this.lbackStartPos,this.lbackPointPos],BABYLON.Color3.Blue())}}tagname="";contact=false;raycast.reset();TOOLKIT.RigidbodyPhysics.RaycastToRef(firstSensorStartPos,firstSensorPointPos,raycast);if(avoidance===0){if(raycast.hasHit===true&&raycast.body!=null&&raycast.body.transformNode!=null){tagname=TOOLKIT.SceneManager.GetTransformTag(raycast.body.transformNode);contact=(tagname==this.vehicleTag||tagname===this.obstacleTag);if(contact===true){if(raycast.hitNormal.x<0){avoidance=-1}else{avoidance=1}}}}if(this.showSensorLines===true){if(this.mainCenterSensorLine==null)this.mainCenterSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".MainCenterSensorLine",this.scene);if(contact===true){this.mainCenterSensorLine.drawLine([firstSensorStartPos,raycast.hitPoint],BABYLON.Color3.Yellow())}else{this.mainCenterSensorLine.drawLine([firstSensorStartPos,firstSensorPointPos],BABYLON.Color3.Blue())}}const trackNode=this.getCurrentTrackNode(this.waypointIndex);const controlPoint=this.getCurrentControlPoint(this.raceLineNode,this.waypointIndex);if(this.m_chaseRabbitMesh!=null&&this.waypointCount>0&&trackNode!=null&&controlPoint!=null){this.waypointPosition.set(controlPoint.position.x,controlPoint.position.y,controlPoint.position.z);const targetSpeed=(controlPoint.speed>0?controlPoint.speed:100)*this.getDriverSkillFactor();const targetRadius=(trackNode.radius*1);const distToTarget=BABYLON.Vector3.Distance(this.waypointPosition,transformPosition);if(distToTarget<targetRadius){if(this.prevTargetSpeed<=0)this.prevTargetSpeed=targetSpeed;this.nextTargetSpeed=BABYLON.Scalar.Lerp(this.prevTargetSpeed,targetSpeed,(1.0-(distToTarget/targetRadius)));if(this.showChaseRabbit===true)this.rabbitTrackerColor=this.redTrackingColor}else{this.nextTargetSpeed=targetSpeed;if(this.showChaseRabbit===true)this.rabbitTrackerColor=this.greenTrackingColor}const gradientSpeed=this.m_standardCarController.getGradientSpeed();const americanSpeed=this.m_standardCarController.getAmericanSpeed();const isSkidding=this.m_standardCarController.getCurrentSkidding();const lookAhead=BABYLON.Scalar.Lerp(this.minLookAhead,this.maxLookAhead,gradientSpeed);const rabbitPosition=this.m_chaseRabbitMesh.getAbsolutePosition();const rabbitDistance=BABYLON.Vector3.Distance(transformPosition,rabbitPosition);if(rabbitDistance<=lookAhead){this.chaseRabbitSpeed=BABYLON.Scalar.Lerp(1.0,this.driveSpeedMultiplier,gradientSpeed);this.m_chaseRabbitMesh.lookAt(this.waypointPosition);this.m_chaseRabbitMesh.translate(BABYLON.Axis.Z,this.chaseRabbitSpeed)}if(avoidance!==0){this.avoidanceValue=avoidance;this.avoidanceTimer=this.avoidanceTimeout}if(this.m_checkpointManager!=null){const currentCheckpoint=this.m_checkpointManager.getCheckPoint();if(currentCheckpoint!=this.lastCheckpoint){this.randomTurning=this.generateRandonNumber(0,3);if(this.powerBoosting>0){this.randomBoosting=this.generateRandonNumber(0,this.powerBoosting)}if(this.wonderDistance>0){const minimumVal=this.driveLineDistance;const randomSign=Math.sign(this.generateRandonNumber(-1,1));this.randomDistance=this.generateRandonNumber(minimumVal,(minimumVal+this.wonderDistance))*randomSign}this.lastCheckpoint=currentCheckpoint}}else{this.randomTurning=0;this.randomBoosting=0;this.randomDistance=0}let wantedAvoidDistance=(this.avoidanceTimer>0&&this.avoidanceValue!==0)?(this.avoidanceDistance*Math.sign(this.avoidanceValue)):0;wantedAvoidDistance+=this.randomDistance;this.avoidanceLerp=BABYLON.Scalar.Lerp(this.avoidanceLerp,wantedAvoidDistance,(this.avoidanceSpeed*deltaTime));this.avoidPositionOffset.set(this.avoidanceLerp,0,0);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.m_chaseRabbitMesh,this.m_chasePointMesh.position,this.avoidPositionOffset);if(this.showChaseRabbit===true){this.trackVehiclePosition.set(transformPosition.x,(transformPosition.y+0.5),transformPosition.z);this.trackRabbitPosition.set(this.m_chasePointMesh.position.x,(this.m_chasePointMesh.position.y+0.25),this.m_chasePointMesh.position.z);if(this.rabbitTrackerLine==null)this.rabbitTrackerLine=new TOOLKIT.LinesMeshRenderer((this.transform.name+".TrackingLine"),this.scene);if(this.rabbitTrackerLine!=null)this.rabbitTrackerLine.drawLine([this.trackVehiclePosition,this.trackRabbitPosition],this.rabbitTrackerColor)}const waypointDistance=BABYLON.Vector3.Distance(rabbitPosition,this.waypointPosition);if(waypointDistance<=5.0){this.prevTargetSpeed=this.nextTargetSpeed;this.waypointIndex++;if(this.waypointIndex>=this.waypointCount){this.waypointIndex=0}}TOOLKIT.Utilities.InverseTransformPointToRef(this.transform,this.m_chasePointMesh.position,this.localTargetPosition);const localTargetAngle=BABYLON.Tools.ToDegrees(Math.atan2(this.localTargetPosition.x,this.localTargetPosition.z));const cornerAngle=BABYLON.Scalar.Clamp(Math.abs(localTargetAngle),0,90);const cornerFactor=(cornerAngle/90);let braking=0;let slowdown=0;let boosting=this.randomBoosting;let topspeed=this.maxRaceTrackSpeed;let throttle=(1.0*this.throttleSensitivity);let steering=BABYLON.Scalar.Clamp(((this.localTargetPosition.x/this.localTargetPosition.length())*this.steeringSensitivity),-1,1);if(this.avoidanceFactor>0&&avoidance!==0){const lowSpeedAvoidance=((avoidance*0.112)*this.avoidanceFactor);const highSpeedAvoidance=((avoidance*0.06)*this.avoidanceFactor);steering+=BABYLON.Scalar.Lerp(lowSpeedAvoidance,highSpeedAvoidance,gradientSpeed)}let handbraking=false;if(this.nextTargetSpeed<=0)this.nextTargetSpeed=targetSpeed;if(americanSpeed>this.nextTargetSpeed){slowdown=BABYLON.Scalar.Lerp(0.0,this.linearDampenForce,gradientSpeed);throttle*=0.2}if(this.brakingTurnAngle>0){const checkCornerAngle=(this.brakingTurnAngle-this.randomTurning);if(cornerAngle>=checkCornerAngle&&americanSpeed>=this.brakingSpeedLimit){braking=BABYLON.Scalar.Lerp(0,(1+gradientSpeed),cornerFactor);slowdown=0;const skiddingTriggerSpeed=(isSkidding===true)?this.brakingSpeedLimit:this.skiddingSpeedLimit;handbraking=(braking>0&&americanSpeed>=skiddingTriggerSpeed);if(handbraking===true)braking=1.0}}if(braking>0)braking=BABYLON.Scalar.Clamp((braking*this.brakingSensitivity),0,1);if(braking>0)throttle=(-braking);if(this.reverseFixMode===true){throttle=-1;boosting=0;steering=0;slowdown=0;handbraking=false}if(throttle>=0.1&&americanSpeed<2.0){this.noMovementTime+=deltaTime}else{this.noMovementTime=0}if(this.noMovementTime>=this.resetMovingTimeout){this.noMovementTime=0;this.reverseFixMode=true;this.recoveryFixMode=true;const reverseTime=(this.reverseThrottleTime*1000);const recoveryTime=((this.reverseThrottleTime*1000)*3.0);TOOLKIT.WindowManager.SetTimeout(reverseTime,()=>{this.reverseFixMode=false});TOOLKIT.WindowManager.SetTimeout(recoveryTime,()=>{this.recoveryFixMode=false})}const speedBooster=false;this.m_standardCarController.ackermanTurnFactor=(this.recoveryFixMode===true)?this.recoveryRadius:1.0;this.m_standardCarController.throttleEngineSpeed=topspeed;this.m_standardCarController.throttleBrakingForce=slowdown;this.m_standardCarController.drive(throttle,steering,handbraking,false,boosting,true,speedBooster)}}}getDriverSkillFactor(){let result=0.60;let skill=this.driverSkillLevel;if(this.randomSkillFactor>=18){skill+=2}else if(this.randomSkillFactor>=12){skill+=1}skill=BABYLON.Scalar.Clamp(skill,1,10);switch(skill){case 10:result=1.00;break;case 9:result=0.98;break;case 8:result=0.95;break;case 7:result=0.90;break;case 6:result=0.85;break;case 5:result=0.80;break;case 4:result=0.75;break;case 3:result=0.70;break;case 2:result=0.65;break;case 1:result=0.60;break}return result}getCurrentTrackNode(index){let result=null;if(index>=0&&index<this.waypointCount){result=this.m_circuitInterfaces[index]}return result}getCurrentControlPoint(lane,index){let result=null;if(index>=0&&index<this.waypointCount){switch(lane){case 0:result=this.m_circuitRaceLine_1[index];break;case 1:result=this.m_circuitRaceLine_2[index];break;case 2:result=this.m_circuitRaceLine_3[index];break;case 3:result=this.m_circuitRaceLine_4[index];break;case 4:result=this.m_circuitRaceLine_5[index];break}}return result}getRandomNumber(min,max){min=Math.ceil(min);max=Math.floor(max);return Math.floor(Math.random()*(max-min+1))+min}generateRandonNumber(min,max,decimals=2){const rand=(Math.random()*(max-min)+min).toFixed(decimals);return parseFloat(rand)}destroyVehicleController(){this.m_circuitInterfaces=null;this.m_circuitRaceLine_1=null;this.m_circuitRaceLine_2=null;this.m_circuitRaceLine_3=null;this.m_circuitRaceLine_4=null;this.m_circuitRaceLine_5=null;this.m_rigidbodyPhysics=null;this.m_standardCarController=null;if(this.m_chasePointMesh!=null){this.m_chasePointMesh.dispose();this.m_chasePointMesh=null}if(this.m_chaseRabbitMesh!=null){this.m_chaseRabbitMesh.dispose();this.m_chaseRabbitMesh=null}}}PROJECT.VehicleInputController=VehicleInputController;TOOLKIT.SceneManager.RegisterClass("PROJECT.VehicleInputController",VehicleInputController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class VehicleNetworkLabel extends TOOLKIT.ScriptComponent{label=null;rect;autoCreate=true;offsetX=0;offsetY=0;labelColor=new BABYLON.Color3(1.0,1.0,1.0);borderColor=new BABYLON.Color3(0.0,0.8431373,0.827451);backgroundColor=new BABYLON.Color3(0.0,0.4745098,0.4666667);labelCreated=false;constructor(transform,scene,properties={},alias="PROJECT.VehicleNetworkLabel"){super(transform,scene,properties,alias)}update(){if(this.labelCreated===false&&this.autoCreate===true&&this.isReady()){if(BABYLON.NetworkManager.HasJoinedRoom()){const ownerName=TOOLKIT.EntityController.QueryNetworkAttribute(this.transform,"ownerName");if(ownerName!=null&&ownerName!==""){this.autoCreate=false;this.labelCreated=true;this.createLabel(ownerName)}}}}createLabel(name){const advancedTexture=PROJECT.VehicleNetworkLabel.GetFullscreenUI(this.scene);this.label=new BABYLON.GUI.TextBlock;this.label.text=name;this.label.color=this.labelColor.toHexString();this.label.fontSize=24;this.rect=new BABYLON.GUI.Rectangle;this.rect.width="200px";this.rect.height="40px";this.rect.cornerRadius=10;this.rect.color=this.borderColor.toHexString();this.rect.thickness=4;this.rect.background=this.backgroundColor.toHexString();this.rect.addControl(this.label);advancedTexture.addControl(this.rect);this.rect.linkWithMesh(this.transform);this.rect.linkOffsetXInPixels=this.offsetX;this.rect.linkOffsetYInPixels=this.offsetY}destroy(){console.warn("*** GOT DESTROY MESSAGE ***");if(this.label!=null){this.label.dispose();this.label=null}if(this.rect!=null){this.rect.dispose();this.rect=null}}static AdvDynamicTexture=null;static GetFullscreenUI(scene,sampling=BABYLON.Texture.BILINEAR_SAMPLINGMODE){if(PROJECT.VehicleNetworkLabel.AdvDynamicTexture==null){PROJECT.VehicleNetworkLabel.AdvDynamicTexture=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("Default-Screen-UI",true,scene,sampling)}return PROJECT.VehicleNetworkLabel.AdvDynamicTexture}}PROJECT.VehicleNetworkLabel=VehicleNetworkLabel;TOOLKIT.SceneManager.RegisterClass("PROJECT.VehicleNetworkLabel",VehicleNetworkLabel)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class DefaultCameraSystem extends TOOLKIT.ScriptComponent{static PlayerOneCamera=null;static PlayerTwoCamera=null;static PlayerThreeCamera=null;static PlayerFourCamera=null;static XRExperienceHelper=null;static multiPlayerView=false;static multiPlayerCount=1;static multiPlayerCameras=null;static stereoCameras=true;static startupMode=1;static cameraReady=false;static cameraInstance=null;static renderingPipeline=null;static screenSpacePipeline=null;static GetRenderingPipeline(){return PROJECT.DefaultCameraSystem.renderingPipeline}static GetScreenSpacePipeline(){return PROJECT.DefaultCameraSystem.screenSpacePipeline}static IsCameraSystemReady(){return PROJECT.DefaultCameraSystem.cameraReady}static OnXRExperienceHelperObservable=new BABYLON.Observable;static FOLLOW_SPEED=1.0;mainCamera=false;cameraType=0;cameraInertia=0.9;cameraController=null;immersiveOptions=null;arcRotateConfig=null;multiPlayerSetup=null;fullScreenToggle=0;setPointerLock=false;setCameraTarget=null;setSpatialAudio=true;editorPostProcessing=null;m_cameraRig=null;isMainCamera(){return this.mainCamera}getCameraType(){return this.cameraType}getTargetTransform(){return this.setCameraTarget}setTargetTransform(target){this.setCameraTarget=target}enableSpatialAudio(value){this.setSpatialAudio=value}constructor(transform,scene,properties={},alias="PROJECT.DefaultCameraSystem"){super(transform,scene,properties,alias);PROJECT.DefaultCameraSystem.cameraInstance=this}awake(){this.awakeCameraSystemState()}start(){this.startCameraSystemState()}update(){this.updateCameraSystemState()}destroy(){this.destroyCameraSystemState()}awakeCameraSystemState(){this.mainCamera=(this.getTransformTag()==="MainCamera");this.cameraType=this.getProperty("mainCameraType",this.cameraType);this.cameraInertia=this.getProperty("setCameraInertia",this.cameraInertia);this.fullScreenToggle=this.getProperty("fullScreenToggle",this.fullScreenToggle);this.setSpatialAudio=this.getProperty("setSpatialAudio",this.setSpatialAudio);this.setPointerLock=this.getProperty("setPointerLock",this.setPointerLock);this.immersiveOptions=this.getProperty("immersiveOptions",this.immersiveOptions);this.arcRotateConfig=this.getProperty("arcRotateConfig",this.arcRotateConfig);this.multiPlayerSetup=this.getProperty("multiPlayerSetup",this.multiPlayerSetup);this.cameraController=this.getProperty("cameraController",this.cameraController);this.editorPostProcessing=this.getProperty("renderingPipeline",this.editorPostProcessing);this.cleanCameraSystemState();if(this.fullScreenToggle===0){TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.F,()=>{TOOLKIT.SceneManager.EnterFullscreenMode(this.scene,this.setPointerLock)})}}async startCameraSystemState(){TOOLKIT.Utilities.ValidateTransformQuaternion(this.transform);if(this.multiPlayerSetup!=null){PROJECT.DefaultCameraSystem.startupMode=this.multiPlayerSetup.playerStartupMode;PROJECT.DefaultCameraSystem.stereoCameras=this.multiPlayerSetup.stereoSideBySide}if(this.setSpatialAudio===true&&!TOOLKIT.AudioSource.IsLegacyEngine()){TOOLKIT.AudioSource.AttachSpatialCamera(this.transform)}this.m_cameraRig=this.getCameraRig();if(this.m_cameraRig!=null){this.m_cameraRig.inertia=this.cameraInertia;this.m_cameraRig.layerMask=~TOOLKIT.SceneManager.HiddenLayerMask;if(this.cameraController!=null){this.m_cameraRig.speed=this.cameraController.cameraSpeed;this.m_cameraRig.inverseRotationSpeed=this.cameraController.invRotationSpeed;if(this.m_cameraRig instanceof BABYLON.UniversalCamera){this.m_cameraRig.gamepadAngularSensibility=this.cameraController.gamepadRotation;this.m_cameraRig.gamepadMoveSensibility=this.cameraController.gamepadMovement;this.m_cameraRig.touchAngularSensibility=this.cameraController.touchRotation;this.m_cameraRig.touchMoveSensibility=this.cameraController.touchMovement}if(this.cameraController.keyboardWASD===true){if(this.m_cameraRig.inputs!=null&&this.m_cameraRig.inputs.attached!=null&&this.m_cameraRig.inputs.attached.keyboard!=null){if(this.m_cameraRig.inputs.attached.keyboard instanceof BABYLON.FreeCameraKeyboardMoveInput){const cinput=this.m_cameraRig.inputs.attached.keyboard;cinput.keysUp.push(TOOLKIT.UserInputKey.W);cinput.keysLeft.push(TOOLKIT.UserInputKey.A);cinput.keysDown.push(TOOLKIT.UserInputKey.S);cinput.keysRight.push(TOOLKIT.UserInputKey.D);cinput.rotationSpeed=this.cameraController.rotationSpeed;if(this.cameraController.arrowKeyRotation===true){cinput.keysLeft=[TOOLKIT.UserInputKey.A];cinput.keysRight=[TOOLKIT.UserInputKey.D];cinput.keysRotateLeft=[TOOLKIT.UserInputKey.LeftArrow];cinput.keysRotateRight=[TOOLKIT.UserInputKey.RightArrow]}}}}}if(this.m_cameraRig.inputs!=null&&this.m_cameraRig.inputs.attached!=null&&this.m_cameraRig.inputs.attached.mouse!=null){const mouseInput=this.m_cameraRig.inputs.attached.mouse;if(TOOLKIT.Utilities.HasOwnProperty(mouseInput,"touchEnabled")){mouseInput.touchEnabled=true}}if(this.cameraType===0||this.cameraType===4){PROJECT.DefaultCameraSystem.PlayerOneCamera=this.m_cameraRig;PROJECT.DefaultCameraSystem.PlayerOneCamera.inertia=this.cameraInertia;PROJECT.DefaultCameraSystem.PlayerOneCamera.transform=this.transform}else if(this.cameraType===1||this.cameraType===2){PROJECT.DefaultCameraSystem.PlayerOneCamera=this.m_cameraRig;PROJECT.DefaultCameraSystem.PlayerOneCamera.inertia=this.cameraInertia;PROJECT.DefaultCameraSystem.PlayerOneCamera.transform=this.transform;if(this.immersiveOptions!=null){const localStorageRequired=(this.immersiveOptions.localStorageOption===true);if(localStorageRequired===false||(localStorageRequired===true&&TOOLKIT.WindowManager.GetVirtualRealityEnabled())){let webvrFloorMeshes=null;let webvrHelperOptions=null;let webvrImmersiveMode=(this.cameraType===1)?"immersive-ar":"immersive-vr";let webvrReferenceType="local-floor";switch(this.immersiveOptions.referenceSpaceType){case 0:webvrReferenceType="viewer";break;case 1:webvrReferenceType="local";break;case 2:webvrReferenceType="local-floor";break;case 4:webvrReferenceType="unbounded";break;default:webvrReferenceType="local-floor";break}if(this.immersiveOptions.setFloorMeshesTags==null||this.immersiveOptions.setFloorMeshesTags==="")this.immersiveOptions.setFloorMeshesTags="Navigation";if(this.immersiveOptions.defaultTeleportationSetup.useTeleportation===true)webvrFloorMeshes=this.scene.getMeshesByTags(this.immersiveOptions.setFloorMeshesTags);if(this.immersiveOptions.defaultTeleportationSetup.useTeleportation===true&&webvrFloorMeshes!=null&&webvrFloorMeshes.length>0){webvrHelperOptions={floorMeshes:webvrFloorMeshes,optionalFeatures:this.immersiveOptions.optionalFeatures,useStablePlugins:this.immersiveOptions.useStablePlugins,renderingGroupId:this.immersiveOptions.renderingGroupNum,disableDefaultUI:this.immersiveOptions.disableUserInterface,disableTeleportation:(this.immersiveOptions.defaultTeleportationSetup.useTeleportation===false),disablePointerSelection:this.immersiveOptions.disablePointerSelect,ignoreNativeCameraTransformation:this.immersiveOptions.ignoreNativeCamera,inputOptions:{doNotLoadControllerMeshes:this.immersiveOptions.experienceInputOptions.disableMeshLoad,forceInputProfile:this.immersiveOptions.experienceInputOptions.forceInputProfile,disableOnlineControllerRepository:this.immersiveOptions.experienceInputOptions.disableRepository,customControllersRepositoryURL:this.immersiveOptions.experienceInputOptions.customRepository,disableControllerAnimation:this.immersiveOptions.experienceInputOptions.disableModelAnim,controllerOptions:{disableMotionControllerAnimation:this.immersiveOptions.experienceInputOptions.controllerOptions.disableCtrlAnim,doNotLoadControllerMesh:this.immersiveOptions.experienceInputOptions.controllerOptions.disableCtrlMesh,forceControllerProfile:this.immersiveOptions.experienceInputOptions.controllerOptions.forceCtrlProfile,renderingGroupId:this.immersiveOptions.experienceInputOptions.controllerOptions.renderingGroup}},uiOptions:{sessionMode:webvrImmersiveMode,referenceSpaceType:webvrReferenceType}}}else{webvrHelperOptions={optionalFeatures:this.immersiveOptions.optionalFeatures,useStablePlugins:this.immersiveOptions.useStablePlugins,renderingGroupId:this.immersiveOptions.renderingGroupNum,disableDefaultUI:this.immersiveOptions.disableUserInterface,disableTeleportation:(this.immersiveOptions.defaultTeleportationSetup.useTeleportation===false),disablePointerSelection:this.immersiveOptions.disablePointerSelect,ignoreNativeCameraTransformation:this.immersiveOptions.ignoreNativeCamera,inputOptions:{doNotLoadControllerMeshes:this.immersiveOptions.experienceInputOptions.disableMeshLoad,forceInputProfile:this.immersiveOptions.experienceInputOptions.forceInputProfile,disableOnlineControllerRepository:this.immersiveOptions.experienceInputOptions.disableRepository,customControllersRepositoryURL:this.immersiveOptions.experienceInputOptions.customRepository,disableControllerAnimation:this.immersiveOptions.experienceInputOptions.disableModelAnim,controllerOptions:{disableMotionControllerAnimation:this.immersiveOptions.experienceInputOptions.controllerOptions.disableCtrlAnim,doNotLoadControllerMesh:this.immersiveOptions.experienceInputOptions.controllerOptions.disableCtrlMesh,forceControllerProfile:this.immersiveOptions.experienceInputOptions.controllerOptions.forceCtrlProfile,renderingGroupId:this.immersiveOptions.renderingGroupNum}},uiOptions:{sessionMode:webvrImmersiveMode,referenceSpaceType:webvrReferenceType}}}PROJECT.DefaultCameraSystem.XRExperienceHelper=await this.scene.createDefaultXRExperienceAsync(webvrHelperOptions);if(PROJECT.DefaultCameraSystem.XRExperienceHelper!=null&&PROJECT.DefaultCameraSystem.XRExperienceHelper.baseExperience!=null){if(PROJECT.DefaultCameraSystem.XRExperienceHelper.teleportation!=null){PROJECT.DefaultCameraSystem.XRExperienceHelper.teleportation.rotationAngle=BABYLON.Tools.ToRadians(this.immersiveOptions.defaultTeleportationSetup.turningAxisAngle);PROJECT.DefaultCameraSystem.XRExperienceHelper.teleportation.rotationEnabled=this.immersiveOptions.defaultTeleportationSetup.rotationsEnabled;PROJECT.DefaultCameraSystem.XRExperienceHelper.teleportation.backwardsMovementEnabled=this.immersiveOptions.defaultTeleportationSetup.backwardsEnabled;PROJECT.DefaultCameraSystem.XRExperienceHelper.teleportation.backwardsTeleportationDistance=this.immersiveOptions.defaultTeleportationSetup.backwardsDistance;PROJECT.DefaultCameraSystem.XRExperienceHelper.teleportation.parabolicCheckRadius=this.immersiveOptions.defaultTeleportationSetup.parabolicRadius}if(PROJECT.DefaultCameraSystem.OnXRExperienceHelperObservable&&PROJECT.DefaultCameraSystem.OnXRExperienceHelperObservable.hasObservers()){PROJECT.DefaultCameraSystem.OnXRExperienceHelperObservable.notifyObservers(PROJECT.DefaultCameraSystem.XRExperienceHelper)}if(TOOLKIT.SceneManager.HasNavigationData()){const navmesh=TOOLKIT.SceneManager.GetNavigationMesh();PROJECT.DefaultCameraSystem.SetupNavigationWebXR(navmesh,this.immersiveOptions.setFloorMeshesTags)}else{TOOLKIT.SceneManager.OnNavMeshReadyObservable.addOnce(navmesh=>{PROJECT.DefaultCameraSystem.SetupNavigationWebXR(navmesh,this.immersiveOptions.setFloorMeshesTags)})}}else{TOOLKIT.SceneManager.LogWarning("WebXR not supported in current browser.")}}}}else if(this.cameraType===3){const cameraName=this.m_cameraRig.name;const playerOneTransform=new BABYLON.TransformNode("Player Camera 1",this.scene);playerOneTransform.rotationQuaternion=this.transform.rotationQuaternion.clone();playerOneTransform.position=this.transform.position.clone();playerOneTransform.parent=this.transform.parent;const playerOneName=cameraName+".1";const playerOneCamerax=this.m_cameraRig.clone(playerOneName);playerOneCamerax.name=playerOneName;playerOneCamerax.parent=playerOneTransform;playerOneCamerax.position=new BABYLON.Vector3(0,0,0);playerOneCamerax.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);playerOneCamerax.viewport=new BABYLON.Viewport(0,0,0,0);playerOneCamerax.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerOneCamera=playerOneCamerax;PROJECT.DefaultCameraSystem.PlayerOneCamera.inertia=this.cameraInertia;PROJECT.DefaultCameraSystem.PlayerOneCamera.transform=playerOneTransform;playerOneTransform.cameraRig=PROJECT.DefaultCameraSystem.PlayerOneCamera;const playerTwoTransform=new BABYLON.TransformNode("Player Camera 2",this.scene);playerTwoTransform.rotationQuaternion=this.transform.rotationQuaternion.clone();playerTwoTransform.position=this.transform.position.clone();playerTwoTransform.parent=this.transform.parent;const playerTwoName=cameraName+".2";const playerTwoCamerax=this.m_cameraRig.clone(playerTwoName);playerTwoCamerax.name=playerTwoName;playerTwoCamerax.parent=playerTwoTransform;playerTwoCamerax.position=new BABYLON.Vector3(0,0,0);playerTwoCamerax.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);playerTwoCamerax.viewport=new BABYLON.Viewport(0,0,0,0);playerTwoCamerax.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerTwoCamera=playerTwoCamerax;PROJECT.DefaultCameraSystem.PlayerTwoCamera.inertia=this.cameraInertia;PROJECT.DefaultCameraSystem.PlayerTwoCamera.transform=playerTwoTransform;playerTwoTransform.cameraRig=PROJECT.DefaultCameraSystem.PlayerTwoCamera;const playerThreeTransform=new BABYLON.TransformNode("Player Camera 3",this.scene);playerThreeTransform.rotationQuaternion=this.transform.rotationQuaternion.clone();playerThreeTransform.position=this.transform.position.clone();playerThreeTransform.parent=this.transform.parent;const playerThreeName=cameraName+".3";const playerThreeCamerax=this.m_cameraRig.clone(playerThreeName);playerThreeCamerax.name=playerThreeName;playerThreeCamerax.parent=playerThreeTransform;playerThreeCamerax.position=new BABYLON.Vector3(0,0,0);playerThreeCamerax.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);playerThreeCamerax.viewport=new BABYLON.Viewport(0,0,0,0);playerThreeCamerax.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerThreeCamera=playerThreeCamerax;PROJECT.DefaultCameraSystem.PlayerThreeCamera.inertia=this.cameraInertia;PROJECT.DefaultCameraSystem.PlayerThreeCamera.transform=playerThreeTransform;playerThreeTransform.cameraRig=PROJECT.DefaultCameraSystem.PlayerThreeCamera;const playerFourTransform=new BABYLON.TransformNode("Player Camera 4",this.scene);playerFourTransform.rotationQuaternion=this.transform.rotationQuaternion.clone();playerFourTransform.position=this.transform.position.clone();playerFourTransform.parent=this.transform.parent;const playerFourName=cameraName+".4";const playerFourCamerax=this.m_cameraRig.clone(playerFourName);playerFourCamerax.name=playerFourName;playerFourCamerax.parent=playerFourTransform;playerFourCamerax.position=new BABYLON.Vector3(0,0,0);playerFourCamerax.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);playerFourCamerax.viewport=new BABYLON.Viewport(0,0,0,0);playerFourCamerax.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerFourCamera=playerFourCamerax;PROJECT.DefaultCameraSystem.PlayerFourCamera.inertia=this.cameraInertia;PROJECT.DefaultCameraSystem.PlayerFourCamera.transform=playerFourTransform;playerFourTransform.cameraRig=PROJECT.DefaultCameraSystem.PlayerFourCamera;PROJECT.DefaultCameraSystem.multiPlayerView=true;PROJECT.DefaultCameraSystem.SetMultiPlayerViewLayout(this.scene,PROJECT.DefaultCameraSystem.startupMode)}if(this.cameraController.cameraControl===1||this.cameraController.cameraControl===2){this.m_cameraRig.parent=null;this.m_cameraRig.position.copyFrom(this.transform.position);this.m_cameraRig.rotationQuaternion=(this.transform.rotationQuaternion!=null)?this.transform.rotationQuaternion.clone():BABYLON.Quaternion.FromEulerAngles(this.transform.rotation.x,this.transform.rotation.y,this.transform.rotation.z);const children=this.transform.getChildren(null,true);if(children!=null){children.forEach(child=>{child.parent=this.m_cameraRig})}if(this.m_cameraRig instanceof BABYLON.FreeCamera){this.m_cameraRig.checkCollisions=this.cameraController.checkCollisions;this.m_cameraRig.applyGravity=this.cameraController.setApplyGravity}if(this.cameraController.cameraControl===1){this.m_cameraRig.attachControl(this.cameraController.preventDefault)}}}const quality=TOOLKIT.RenderQuality.High;const allowProcessing=(quality===TOOLKIT.RenderQuality.High);if(allowProcessing===true&&this.editorPostProcessing!=null&&this.editorPostProcessing.usePostProcessing===true){PROJECT.DefaultCameraSystem.renderingPipeline=new BABYLON.DefaultRenderingPipeline("DefaultCameraSystem",this.editorPostProcessing.highDynamicRange,this.scene,this.scene.cameras,true);if(PROJECT.DefaultCameraSystem.renderingPipeline.isSupported===true){const defaultPipeline=PROJECT.DefaultCameraSystem.renderingPipeline;defaultPipeline.samples=this.editorPostProcessing.screenAntiAliasing.msaaSamples;defaultPipeline.imageProcessingEnabled=this.editorPostProcessing.imageProcessingConfig.imageProcessing;if(defaultPipeline.imageProcessingEnabled){defaultPipeline.imageProcessing.contrast=this.editorPostProcessing.imageProcessingConfig.imageContrast;defaultPipeline.imageProcessing.exposure=this.editorPostProcessing.imageProcessingConfig.imageExposure;defaultPipeline.imageProcessing.toneMappingEnabled=this.editorPostProcessing.imageProcessingConfig.toneMapping;defaultPipeline.imageProcessing.toneMappingType=this.editorPostProcessing.imageProcessingConfig.toneMapType;defaultPipeline.imageProcessing.vignetteEnabled=this.editorPostProcessing.imageProcessingConfig.vignetteEnabled;if(defaultPipeline.imageProcessing.vignetteEnabled){defaultPipeline.imageProcessing.vignetteBlendMode=this.editorPostProcessing.imageProcessingConfig.vignetteBlendMode;defaultPipeline.imageProcessing.vignetteCameraFov=this.editorPostProcessing.imageProcessingConfig.vignetteCameraFov;defaultPipeline.imageProcessing.vignetteCentreX=this.editorPostProcessing.imageProcessingConfig.vignetteCentreX;defaultPipeline.imageProcessing.vignetteCentreY=this.editorPostProcessing.imageProcessingConfig.vignetteCentreY;defaultPipeline.imageProcessing.vignetteStretch=this.editorPostProcessing.imageProcessingConfig.vignetteStretch;defaultPipeline.imageProcessing.vignetteWeight=this.editorPostProcessing.imageProcessingConfig.vignetteWeight;if(this.editorPostProcessing.imageProcessingConfig.vignetteColor!=null){const vcolor=TOOLKIT.Utilities.ParseColor4(this.editorPostProcessing.imageProcessingConfig.vignetteColor);if(vcolor!=null)defaultPipeline.imageProcessing.vignetteColor=vcolor}}defaultPipeline.imageProcessing.colorGradingEnabled=this.editorPostProcessing.imageProcessingConfig.useColorGrading;if(defaultPipeline.imageProcessing.colorGradingEnabled){if(this.editorPostProcessing.imageProcessingConfig.setGradingTexture!=null){const colorGradingTexture=TOOLKIT.Utilities.ParseTexture(this.editorPostProcessing.imageProcessingConfig.setGradingTexture,this.scene,true,false);colorGradingTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE;colorGradingTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE;defaultPipeline.imageProcessing.colorGradingTexture=colorGradingTexture;defaultPipeline.imageProcessing.colorGradingWithGreenDepth=false}}defaultPipeline.imageProcessing.colorCurvesEnabled=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.curvesEnabled;if(defaultPipeline.imageProcessing.colorCurvesEnabled){var curve=new BABYLON.ColorCurves;curve.globalDensity=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.globalDen;curve.globalExposure=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.globalExp;curve.globalHue=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.globalHue;curve.globalSaturation=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.globalSat;curve.highlightsDensity=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.highlightsDen;curve.highlightsExposure=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.highlightsExp;curve.highlightsHue=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.highlightsHue;curve.highlightsSaturation=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.highlightsSat;curve.midtonesDensity=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.midtonesDen;curve.midtonesExposure=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.midtonesExp;curve.midtonesHue=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.midtonesHue;curve.midtonesSaturation=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.midtonesSat;curve.shadowsDensity=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.shadowsDen;curve.shadowsExposure=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.shadowsExp;curve.shadowsHue=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.shadowsHue;curve.shadowsSaturation=this.editorPostProcessing.imageProcessingConfig.imagingColorCurves.shadowsSat;defaultPipeline.imageProcessing.colorCurves=curve}}defaultPipeline.bloomEnabled=this.editorPostProcessing.bloomEffectProperties.bloomEnabled;if(defaultPipeline.bloomEnabled){defaultPipeline.bloomKernel=this.editorPostProcessing.bloomEffectProperties.bloomKernel;defaultPipeline.bloomScale=this.editorPostProcessing.bloomEffectProperties.bloomScale;defaultPipeline.bloomWeight=this.editorPostProcessing.bloomEffectProperties.bloomWeight;defaultPipeline.bloomThreshold=this.editorPostProcessing.bloomEffectProperties.bloomThreshold}defaultPipeline.chromaticAberrationEnabled=this.editorPostProcessing.chromaticAberration.aberrationEnabled;if(defaultPipeline.chromaticAberrationEnabled){defaultPipeline.chromaticAberration.aberrationAmount=this.editorPostProcessing.chromaticAberration.aberrationAmount;defaultPipeline.chromaticAberration.adaptScaleToCurrentViewport=this.editorPostProcessing.chromaticAberration.adaptScaleViewport;defaultPipeline.chromaticAberration.alphaMode=this.editorPostProcessing.chromaticAberration.alphaMode;defaultPipeline.chromaticAberration.alwaysForcePOT=this.editorPostProcessing.chromaticAberration.alwaysForcePOT;defaultPipeline.chromaticAberration.enablePixelPerfectMode=this.editorPostProcessing.chromaticAberration.pixelPerfectMode;defaultPipeline.chromaticAberration.forceFullscreenViewport=this.editorPostProcessing.chromaticAberration.fullscreenViewport}defaultPipeline.depthOfFieldEnabled=this.editorPostProcessing.focalDepthOfField.depthOfField;if(defaultPipeline.depthOfFieldEnabled&&defaultPipeline.depthOfField.isSupported){defaultPipeline.depthOfFieldBlurLevel=this.editorPostProcessing.focalDepthOfField.blurLevel;defaultPipeline.depthOfField.fStop=this.editorPostProcessing.focalDepthOfField.focalStop;defaultPipeline.depthOfField.focalLength=this.editorPostProcessing.focalDepthOfField.focalLength;defaultPipeline.depthOfField.focusDistance=this.editorPostProcessing.focalDepthOfField.focusDistance;defaultPipeline.depthOfField.lensSize=this.editorPostProcessing.focalDepthOfField.maxLensSize}defaultPipeline.fxaaEnabled=this.editorPostProcessing.screenAntiAliasing.fxaaEnabled;if(defaultPipeline.fxaaEnabled){defaultPipeline.fxaa.samples=this.editorPostProcessing.screenAntiAliasing.fxaaSamples;defaultPipeline.fxaa.adaptScaleToCurrentViewport=this.editorPostProcessing.screenAntiAliasing.fxaaScaling}defaultPipeline.glowLayerEnabled=this.editorPostProcessing.glowLayerProperties.glowEnabled;if(defaultPipeline.glowLayerEnabled){defaultPipeline.glowLayer.intensity=this.editorPostProcessing.glowLayerProperties.glowIntensity;defaultPipeline.glowLayer.blurKernelSize=this.editorPostProcessing.glowLayerProperties.blurKernelSize}defaultPipeline.grainEnabled=this.editorPostProcessing.grainEffectProperties.grainEnabled;if(defaultPipeline.grainEnabled){defaultPipeline.grain.animated=this.editorPostProcessing.grainEffectProperties.grainAnimated;defaultPipeline.grain.intensity=this.editorPostProcessing.grainEffectProperties.grainIntensity;defaultPipeline.grain.adaptScaleToCurrentViewport=this.editorPostProcessing.grainEffectProperties.adaptScaleViewport}defaultPipeline.sharpenEnabled=this.editorPostProcessing.sharpEffectProperties.sharpenEnabled;if(defaultPipeline.sharpenEnabled){defaultPipeline.sharpen.edgeAmount=this.editorPostProcessing.sharpEffectProperties.sharpEdgeAmount;defaultPipeline.sharpen.colorAmount=this.editorPostProcessing.sharpEffectProperties.sharpColorAmount;defaultPipeline.sharpen.adaptScaleToCurrentViewport=this.editorPostProcessing.sharpEffectProperties.adaptScaleViewport}}else{TOOLKIT.SceneManager.LogWarning("Babylon.js default rendering pipeline not supported")}if(this.editorPostProcessing.screenSpaceRendering!=null&&this.editorPostProcessing.screenSpaceRendering.SSAO===true){const ssaoRatio={ssaoRatio:this.editorPostProcessing.screenSpaceRendering.SSAORatio,combineRatio:this.editorPostProcessing.screenSpaceRendering.combineRatio};PROJECT.DefaultCameraSystem.screenSpacePipeline=new BABYLON.SSAORenderingPipeline("DefaultCameraSystem-SSAO",this.scene,ssaoRatio,this.scene.cameras);if(PROJECT.DefaultCameraSystem.screenSpacePipeline.isSupported===true){const ssaoPipeline=PROJECT.DefaultCameraSystem.screenSpacePipeline;ssaoPipeline.fallOff=this.editorPostProcessing.screenSpaceRendering.fallOff;ssaoPipeline.area=this.editorPostProcessing.screenSpaceRendering.area;ssaoPipeline.radius=this.editorPostProcessing.screenSpaceRendering.radius;ssaoPipeline.totalStrength=this.editorPostProcessing.screenSpaceRendering.totalStrength;ssaoPipeline.base=this.editorPostProcessing.screenSpaceRendering.baseValue}else{TOOLKIT.SceneManager.LogWarning("Babylon.js SSAO rendering pipeline not supported")}}}PROJECT.DefaultCameraSystem.cameraReady=true}updateCameraSystemState(){if(this.m_cameraRig!=null){if(this.cameraType===0){}else if(this.cameraType===1){}else if(this.cameraType===2){}else if(this.cameraType===3){}}if(this.cameraController.cameraControl===3){const deltaTime=this.getDeltaSeconds();const userMouseX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseX,this.cameraController.playerNumber);const userMouseY=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseY,this.cameraController.playerNumber);this.targetRotationVector.y+=(userMouseX*this.cameraController.rotateSpeed*deltaTime);this.targetRotationVector.x+=(-userMouseY*this.cameraController.rotateSpeed*deltaTime);this.targetRotationVector.x=BABYLON.Scalar.Clamp(this.targetRotationVector.x,-BABYLON.Tools.ToRadians(this.cameraController.downLookLimit),BABYLON.Tools.ToRadians(this.cameraController.topLookLimit));if(this.cameraController.autoUpdate===true){PROJECT.DefaultCameraSystem.UpdateFollowTarget()}}}cleanCameraSystemState(){if(PROJECT.DefaultCameraSystem.PlayerOneCamera!=null){PROJECT.DefaultCameraSystem.PlayerOneCamera=null}if(PROJECT.DefaultCameraSystem.PlayerTwoCamera!=null){PROJECT.DefaultCameraSystem.PlayerTwoCamera=null}if(PROJECT.DefaultCameraSystem.PlayerThreeCamera!=null){PROJECT.DefaultCameraSystem.PlayerThreeCamera=null}if(PROJECT.DefaultCameraSystem.PlayerFourCamera!=null){PROJECT.DefaultCameraSystem.PlayerFourCamera=null}}destroyCameraSystemState(){this.immersiveOptions=null;this.cameraPivot=null;this.cameraNode=null}targetCameraOffset=new BABYLON.Vector3(0,0,0);getCameraPivotPosition(){return(this.cameraPivot!=null)?this.cameraPivot.position:null}getCameraPivotRotation(){return(this.cameraPivot!=null)?this.cameraPivot.rotationQuaternion:null}getCameraBoomNode(){return this.cameraNode}getCameraTransform(){return this.cameraPivot}cameraNode=null;cameraPivot=null;cameraDistance=0;cameraPivotOffset=new BABYLON.Vector3(0,0,0);cameraBoomPosition=new BABYLON.Vector3(0,0,0);dollyDirection=new BABYLON.Vector3(0,0,0);rotationEulers=new BABYLON.Vector3(0,0,0);scaledCamDirection=new BABYLON.Vector3(0,0,0);scaledMaxDirection=new BABYLON.Vector3(0,0,0);parentNodePosition=new BABYLON.Vector3(0,0,0);maximumCameraPos=new BABYLON.Vector3(0,0,0);cameraRaycastShape=null;targetRotationVector=BABYLON.Vector2.Zero();resetCameraRotation(){if(this.setCameraTarget==null)return;this.setCameraTarget.rotationQuaternion.toEulerAnglesToRef(this.rotationEulers);this.targetRotationVector.x=this.rotationEulers.x;this.targetRotationVector.y=this.rotationEulers.y}updateCameraController(){const deltaTime=this.getDeltaSeconds();if(this.cameraController.targetTracking===false||this.setCameraTarget==null)return;if(this.cameraRaycastShape==null){this.cameraRaycastShape=new BABYLON.PhysicsShapeSphere(new BABYLON.Vector3(0,0,0),this.cameraController.sphereRadius,this.scene)}if(this.cameraPivot==null){this.resetCameraRotation();this.cameraPivot=new BABYLON.Mesh(this.setCameraTarget.name+".CameraPivot",this.scene);this.cameraPivot.parent=null;this.cameraPivot.position=this.setCameraTarget.position.clone();this.cameraPivot.rotationQuaternion=this.setCameraTarget.rotationQuaternion.clone();this.cameraPivot.checkCollisions=false;this.cameraPivot.isPickable=false;if(TOOLKIT.Utilities.ShowDebugColliders()){const testPivot=BABYLON.MeshBuilder.CreateBox("TestPivot",{width:0.25,height:0.25,depth:0.75},this.scene);testPivot.parent=this.cameraPivot;testPivot.position.set(0,0,0);testPivot.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);testPivot.visibility=1.0;testPivot.renderingGroupId=TOOLKIT.Utilities.ColliderRenderGroup();testPivot.checkCollisions=false;testPivot.isPickable=false}}if(this.cameraNode==null){const player=(this.cameraController.playerNumber!=null)?this.cameraController.playerNumber:1;const playerCamera=(player<=0||player>4)?1:player;const playerCameraNode=PROJECT.DefaultCameraSystem.GetCameraTransform(this.scene,playerCamera);const playerFreeCamera=PROJECT.DefaultCameraSystem.GetMainCamera(this.scene,false);if(playerCameraNode!=null&&playerFreeCamera!=null){playerFreeCamera.detachControl();this.cameraNode=playerCameraNode;this.cameraNode.parent=this.cameraPivot;this.cameraNode.position.set(this.cameraController.boomPosition.x,this.cameraController.boomPosition.y,this.cameraController.boomPosition.z);this.cameraNode.rotationQuaternion=BABYLON.Quaternion.FromEulerAngles(BABYLON.Tools.ToRadians(this.cameraController.maxTiltAngle),0,0);this.cameraDistance=this.cameraNode.position.length();this.dollyDirection.copyFrom(this.cameraNode.position);this.dollyDirection.normalize()}else{}}if(this.cameraPivot!=null){if(this.targetCameraOffset.x!==0||this.targetCameraOffset.y!==0||this.targetCameraOffset.z!==0){this.cameraPivotOffset.copyFrom(this.targetCameraOffset)}else{this.cameraPivotOffset.set(0,this.cameraController.pivotHeight,0)}TOOLKIT.Utilities.GetAbsolutePositionToRef(this.setCameraTarget,this.cameraPivot.position,this.cameraPivotOffset);if(this.cameraController.rotateCamera===true){BABYLON.Quaternion.FromEulerAnglesToRef(this.targetRotationVector.x,this.targetRotationVector.y,0,this.cameraPivot.rotationQuaternion)}}if(this.cameraController.rotateCamera===true&&this.cameraNode!=null){if(this.cameraController.cameraSmoothing<=0)this.cameraController.cameraSmoothing=5.0;if(this.cameraController.cameraCollisions===true){const maxDistance=Math.abs(this.cameraController.boomPosition.z);const parentNode=this.cameraNode.parent;this.dollyDirection.scaleToRef(maxDistance,this.scaledMaxDirection);this.dollyDirection.scaleToRef(this.cameraDistance,this.scaledCamDirection);TOOLKIT.Utilities.GetAbsolutePositionToRef(parentNode,this.parentNodePosition);TOOLKIT.Utilities.TransformPointToRef(parentNode,this.scaledMaxDirection,this.maximumCameraPos);let contact=false;let distance=0;if(this.cameraRaycastShape!=null){const query={shape:this.cameraRaycastShape,rotation:this.cameraNode.rotationQuaternion,startPosition:this.parentNodePosition,endPosition:this.maximumCameraPos,ignoreBody:this.setCameraTarget.physicsBody,shouldHitTriggers:false};const result=TOOLKIT.RigidbodyPhysics.Shapecast(query);contact=(result!=null&&result.world!=null&&result.world.hasHit===true&&result.world.body!=null);distance=(contact===true)?BABYLON.Vector3.Distance(this.parentNodePosition,result.world.hitPoint):0}if(contact===true){this.cameraDistance=BABYLON.Scalar.Clamp((distance*this.cameraController.distanceFactor),this.cameraController.minDistance,this.cameraController.maxDistance);this.dollyDirection.scaleToRef(this.cameraDistance,this.scaledCamDirection);if(this.cameraNode.position.x!==this.scaledCamDirection.x||this.cameraNode.position.y!==this.scaledCamDirection.y||this.cameraNode.position.z!==this.scaledCamDirection.z){const cameraDelta=this.cameraNode.position.subtract(this.scaledCamDirection);const deltaLength=cameraDelta.length();const adaptiveSmoothingFactor=deltaLength>0.3?this.cameraController.cameraSmoothing*0.8:this.cameraController.cameraSmoothing;BABYLON.Vector3.LerpToRef(this.cameraNode.position,this.scaledCamDirection,(deltaTime*adaptiveSmoothingFactor),this.cameraNode.position)}}else{if(this.cameraController.mouseWheel===true){if(TOOLKIT.InputController.IsWheelScrolling()){const wheel=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Wheel);if(wheel<0){const zoomOutSpeed=(this.cameraController.scrollSpeed*deltaTime);this.cameraController.boomPosition.z=BABYLON.Scalar.MoveTowards(this.cameraController.boomPosition.z,-this.cameraController.maxDistance,zoomOutSpeed)}else if(wheel>0){const zoomInSpeed=(this.cameraController.scrollSpeed*deltaTime);this.cameraController.boomPosition.z=BABYLON.Scalar.MoveTowards(this.cameraController.boomPosition.z,-this.cameraController.minDistance,zoomInSpeed)}}}if(this.cameraNode.position.x!==this.cameraBoomPosition.x||this.cameraNode.position.y!==this.cameraBoomPosition.y||this.cameraNode.position.z!==this.cameraBoomPosition.z){this.cameraBoomPosition.set(this.cameraController.boomPosition.x,this.cameraController.boomPosition.y,this.cameraController.boomPosition.z);const cameraDelta=this.cameraNode.position.subtract(this.cameraBoomPosition);const deltaLength=cameraDelta.length();const adaptiveSmoothingFactor=deltaLength>0.3?this.cameraController.cameraSmoothing*0.8:this.cameraController.cameraSmoothing;BABYLON.Vector3.LerpToRef(this.cameraNode.position,this.cameraBoomPosition,(deltaTime*adaptiveSmoothingFactor),this.cameraNode.position)}}}else{if(this.cameraController.mouseWheel===true){if(TOOLKIT.InputController.IsWheelScrolling()){const wheel=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Wheel);if(wheel<0){const zoomOutSpeed=(this.cameraController.scrollSpeed*deltaTime);this.cameraController.boomPosition.z=BABYLON.Scalar.MoveTowards(this.cameraController.boomPosition.z,-this.cameraController.maxDistance,zoomOutSpeed)}else if(wheel>0){const zoomInSpeed=(this.cameraController.scrollSpeed*deltaTime);this.cameraController.boomPosition.z=BABYLON.Scalar.MoveTowards(this.cameraController.boomPosition.z,-this.cameraController.minDistance,zoomInSpeed)}}}if(this.cameraNode.position.x!==this.cameraController.boomPosition.x||this.cameraNode.position.y!==this.cameraController.boomPosition.y||this.cameraNode.position.z!==this.cameraController.boomPosition.z){this.cameraBoomPosition.set(this.cameraController.boomPosition.x,this.cameraController.boomPosition.y,this.cameraController.boomPosition.z);BABYLON.Vector3.LerpToRef(this.cameraNode.position,this.cameraBoomPosition,(deltaTime*this.cameraController.cameraSmoothing),this.cameraNode.position)}}}this.updateSmoothBoomArmLength()}getBoomArmMaxDistance(){return this.cameraController.maxDistance}setBoomArmMaxDistance(distance){this.cameraController.maxDistance=Math.abs(distance)}setSmoothBoomArmLength(length,speed,updateMaxDistance=true){const absoluteLength=Math.abs(length);this.smoothBoomArmLength=-absoluteLength;this.smoothBoomArmSpeed=speed;if(updateMaxDistance===true){const absoluteDistance=Math.abs(this.cameraController.maxDistance);if(absoluteLength>absoluteDistance){this.setBoomArmMaxDistance(absoluteLength)}}}smoothBoomArmLength=null;smoothBoomArmSpeed=null;updateSmoothBoomArmLength(){if(this.smoothBoomArmLength!=null&&this.smoothBoomArmSpeed!=null){if(this.cameraController.boomPosition.z!==this.smoothBoomArmLength){this.cameraController.boomPosition.z=BABYLON.Scalar.MoveTowards(this.cameraController.boomPosition.z,this.smoothBoomArmLength,(this.smoothBoomArmSpeed*this.getDeltaSeconds()))}else{this.smoothBoomArmLength=null;this.smoothBoomArmSpeed=null}}}static EnableTracking(value){if(PROJECT.DefaultCameraSystem.cameraInstance!=null&&PROJECT.DefaultCameraSystem.cameraInstance.cameraController!=null){PROJECT.DefaultCameraSystem.cameraInstance.cameraController.targetTracking=value}}static IsTrackingEnabled(){let result=false;if(PROJECT.DefaultCameraSystem.cameraInstance!=null&&PROJECT.DefaultCameraSystem.cameraInstance.cameraController!=null){result=PROJECT.DefaultCameraSystem.cameraInstance.cameraController.targetTracking}return result}static SetAutoUpdate(value){if(PROJECT.DefaultCameraSystem.cameraInstance!=null&&PROJECT.DefaultCameraSystem.cameraInstance.cameraController!=null){PROJECT.DefaultCameraSystem.cameraInstance.cameraController.autoUpdate=value}}static IsAutoUpdateEnabled(){let result=false;if(PROJECT.DefaultCameraSystem.cameraInstance!=null&&PROJECT.DefaultCameraSystem.cameraInstance.cameraController!=null){result=PROJECT.DefaultCameraSystem.cameraInstance.cameraController.autoUpdate}return result}static GetFollowTarget(){return(PROJECT.DefaultCameraSystem.cameraInstance!=null)?PROJECT.DefaultCameraSystem.cameraInstance.setCameraTarget:null}static SetFollowTarget(target){if(PROJECT.DefaultCameraSystem.cameraInstance!=null){PROJECT.DefaultCameraSystem.cameraInstance.setCameraTarget=target}}static ResetFollowTarget(){if(PROJECT.DefaultCameraSystem.cameraInstance!=null){PROJECT.DefaultCameraSystem.cameraInstance.resetCameraRotation()}}static UpdateFollowTarget(){if(PROJECT.DefaultCameraSystem.cameraInstance!=null){PROJECT.DefaultCameraSystem.cameraInstance.updateCameraController()}}static GetWebXR(){return PROJECT.DefaultCameraSystem.XRExperienceHelper}static IsInWebXR(){return(PROJECT.DefaultCameraSystem.XRExperienceHelper!=null&&PROJECT.DefaultCameraSystem.XRExperienceHelper.baseExperience!=null&&PROJECT.DefaultCameraSystem.XRExperienceHelper.baseExperience.state===BABYLON.WebXRState.IN_XR)}static SetupNavigationWebXR(mesh,tag){const webxr=PROJECT.DefaultCameraSystem.XRExperienceHelper;if(webxr!=null&&webxr.teleportation!=null&&mesh!=null&&tag!=null&&tag!=""){const hastag=BABYLON.Tags.MatchesQuery(mesh,tag);if(hastag===true)webxr.teleportation.addFloorMesh(mesh)}}static GetMainCamera(scene,detach=false){return PROJECT.DefaultCameraSystem.GetPlayerCamera(scene,TOOLKIT.PlayerNumber.One,detach)}static GetPlayerCamera(scene,player=TOOLKIT.PlayerNumber.One,detach=false){let result=null;let transform=PROJECT.DefaultCameraSystem.GetCameraTransform(scene,player);if(PROJECT.DefaultCameraSystem.IsCameraSystemReady()){if(player===TOOLKIT.PlayerNumber.One&&PROJECT.DefaultCameraSystem.PlayerOneCamera!=null)result=PROJECT.DefaultCameraSystem.PlayerOneCamera;else if(player===TOOLKIT.PlayerNumber.Two&&PROJECT.DefaultCameraSystem.PlayerTwoCamera!=null)result=PROJECT.DefaultCameraSystem.PlayerTwoCamera;else if(player===TOOLKIT.PlayerNumber.Three&&PROJECT.DefaultCameraSystem.PlayerThreeCamera!=null)result=PROJECT.DefaultCameraSystem.PlayerThreeCamera;else if(player===TOOLKIT.PlayerNumber.Four&&PROJECT.DefaultCameraSystem.PlayerFourCamera!=null)result=PROJECT.DefaultCameraSystem.PlayerFourCamera;if(result!=null&&detach===true&&parent!=null){result.parent=null;if(transform!=null){result.position.copyFrom(transform.position);result.rotationQuaternion=(transform.rotationQuaternion!=null)?transform.rotationQuaternion.clone():BABYLON.Quaternion.FromEulerAngles(transform.rotation.x,transform.rotation.y,transform.rotation.z);const children=transform.getChildren(null,true);if(children!=null){children.forEach(child=>{child.parent=result})}}}}return result}static GetCameraTransform(scene,player=TOOLKIT.PlayerNumber.One){let result=null;if(PROJECT.DefaultCameraSystem.IsCameraSystemReady()){if(player===TOOLKIT.PlayerNumber.One&&PROJECT.DefaultCameraSystem.PlayerOneCamera!=null&&PROJECT.DefaultCameraSystem.PlayerOneCamera.transform!=null)result=PROJECT.DefaultCameraSystem.PlayerOneCamera.transform;else if(player===TOOLKIT.PlayerNumber.Two&&PROJECT.DefaultCameraSystem.PlayerTwoCamera!=null&&PROJECT.DefaultCameraSystem.PlayerTwoCamera.transform!=null)result=PROJECT.DefaultCameraSystem.PlayerTwoCamera.transform;else if(player===TOOLKIT.PlayerNumber.Three&&PROJECT.DefaultCameraSystem.PlayerThreeCamera!=null&&PROJECT.DefaultCameraSystem.PlayerThreeCamera.transform!=null)result=PROJECT.DefaultCameraSystem.PlayerThreeCamera.transform;else if(player===TOOLKIT.PlayerNumber.Four&&PROJECT.DefaultCameraSystem.PlayerFourCamera!=null&&PROJECT.DefaultCameraSystem.PlayerFourCamera.transform!=null)result=PROJECT.DefaultCameraSystem.PlayerFourCamera.transform}return result}static IsStereoCameras(){return PROJECT.DefaultCameraSystem.stereoCameras}static IsMultiPlayerView(){return PROJECT.DefaultCameraSystem.multiPlayerView}static GetMultiPlayerCount(){return PROJECT.DefaultCameraSystem.multiPlayerCount}static ActivateMultiPlayerCameras(scene){let result=false;if(PROJECT.DefaultCameraSystem.multiPlayerCameras!=null&&PROJECT.DefaultCameraSystem.multiPlayerCameras.length>0){scene.activeCameras=PROJECT.DefaultCameraSystem.multiPlayerCameras;result=true}return result}static DisposeMultiPlayerCameras(){if(PROJECT.DefaultCameraSystem.PlayerOneCamera!=null){PROJECT.DefaultCameraSystem.PlayerOneCamera.dispose();PROJECT.DefaultCameraSystem.PlayerOneCamera=null}if(PROJECT.DefaultCameraSystem.PlayerTwoCamera!=null){PROJECT.DefaultCameraSystem.PlayerTwoCamera.dispose();PROJECT.DefaultCameraSystem.PlayerTwoCamera=null}if(PROJECT.DefaultCameraSystem.PlayerThreeCamera!=null){PROJECT.DefaultCameraSystem.PlayerThreeCamera.dispose();PROJECT.DefaultCameraSystem.PlayerThreeCamera=null}if(PROJECT.DefaultCameraSystem.PlayerFourCamera!=null){PROJECT.DefaultCameraSystem.PlayerFourCamera.dispose();PROJECT.DefaultCameraSystem.PlayerFourCamera=null}}static SetMultiPlayerViewLayout(scene,totalNumPlayers){let result=false;let players=BABYLON.Scalar.Clamp(totalNumPlayers,1,4);if(PROJECT.DefaultCameraSystem.IsMultiPlayerView()){if(PROJECT.DefaultCameraSystem.PlayerOneCamera!=null&&PROJECT.DefaultCameraSystem.PlayerTwoCamera!=null&&PROJECT.DefaultCameraSystem.PlayerThreeCamera!=null&&PROJECT.DefaultCameraSystem.PlayerFourCamera!=null){PROJECT.DefaultCameraSystem.multiPlayerCameras=[];if(players===1){PROJECT.DefaultCameraSystem.PlayerOneCamera.viewport=new BABYLON.Viewport(0,0,1,1);PROJECT.DefaultCameraSystem.PlayerTwoCamera.viewport=new BABYLON.Viewport(0,0,0,0);PROJECT.DefaultCameraSystem.PlayerTwoCamera.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerThreeCamera.viewport=new BABYLON.Viewport(0,0,0,0);PROJECT.DefaultCameraSystem.PlayerThreeCamera.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerFourCamera.viewport=new BABYLON.Viewport(0,0,0,0);PROJECT.DefaultCameraSystem.PlayerFourCamera.setEnabled(false);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerOneCamera)}else if(players===2){if(PROJECT.DefaultCameraSystem.stereoCameras===true){PROJECT.DefaultCameraSystem.PlayerOneCamera.viewport=new BABYLON.Viewport(0,0,0.5,1);PROJECT.DefaultCameraSystem.PlayerTwoCamera.viewport=new BABYLON.Viewport(0.5,0,0.5,1)}else{PROJECT.DefaultCameraSystem.PlayerOneCamera.viewport=new BABYLON.Viewport(0,0.5,1,0.5);PROJECT.DefaultCameraSystem.PlayerTwoCamera.viewport=new BABYLON.Viewport(0,0,1,0.5)}PROJECT.DefaultCameraSystem.PlayerTwoCamera.setEnabled(true);PROJECT.DefaultCameraSystem.PlayerThreeCamera.viewport=new BABYLON.Viewport(0,0,0,0);PROJECT.DefaultCameraSystem.PlayerThreeCamera.setEnabled(false);PROJECT.DefaultCameraSystem.PlayerFourCamera.viewport=new BABYLON.Viewport(0,0,0,0);PROJECT.DefaultCameraSystem.PlayerFourCamera.setEnabled(false);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerOneCamera);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerTwoCamera)}else if(players===3){PROJECT.DefaultCameraSystem.PlayerOneCamera.viewport=new BABYLON.Viewport(0,0,0.5,1);PROJECT.DefaultCameraSystem.PlayerTwoCamera.viewport=new BABYLON.Viewport(0.5,0.5,0.5,0.5);PROJECT.DefaultCameraSystem.PlayerTwoCamera.setEnabled(true);PROJECT.DefaultCameraSystem.PlayerThreeCamera.viewport=new BABYLON.Viewport(0.5,0,0.5,0.5);PROJECT.DefaultCameraSystem.PlayerThreeCamera.setEnabled(true);PROJECT.DefaultCameraSystem.PlayerFourCamera.viewport=new BABYLON.Viewport(0,0,0,0);PROJECT.DefaultCameraSystem.PlayerFourCamera.setEnabled(false);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerOneCamera);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerTwoCamera);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerThreeCamera)}else if(players===4){PROJECT.DefaultCameraSystem.PlayerOneCamera.viewport=new BABYLON.Viewport(0,0.5,0.5,0.5);PROJECT.DefaultCameraSystem.PlayerTwoCamera.viewport=new BABYLON.Viewport(0,0,0.5,0.5);PROJECT.DefaultCameraSystem.PlayerTwoCamera.setEnabled(true);PROJECT.DefaultCameraSystem.PlayerThreeCamera.viewport=new BABYLON.Viewport(0.5,0.5,0.5,0.5);PROJECT.DefaultCameraSystem.PlayerThreeCamera.setEnabled(true);PROJECT.DefaultCameraSystem.PlayerFourCamera.viewport=new BABYLON.Viewport(0.5,0,0.5,0.5);PROJECT.DefaultCameraSystem.PlayerFourCamera.setEnabled(true);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerOneCamera);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerTwoCamera);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerThreeCamera);PROJECT.DefaultCameraSystem.multiPlayerCameras.push(PROJECT.DefaultCameraSystem.PlayerFourCamera)}else{TOOLKIT.SceneManager.LogWarning("Babylon.js camera rig invalid player count specified: "+players)}}else{TOOLKIT.SceneManager.LogWarning("Babylon.js camera rig failed to initialize multi player cameras")}PROJECT.DefaultCameraSystem.multiPlayerCount=players;result=PROJECT.DefaultCameraSystem.ActivateMultiPlayerCameras(scene);if(result===false)TOOLKIT.SceneManager.LogWarning("Babylon.js camera rig failed to initialize multi player views")}else{TOOLKIT.SceneManager.LogWarning("Babylon.js camera rig multi player view option not enabled")}return result}}PROJECT.DefaultCameraSystem=DefaultCameraSystem;TOOLKIT.SceneManager.RegisterClass("PROJECT.DefaultCameraSystem",DefaultCameraSystem)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class DebugInformation extends TOOLKIT.ScriptComponent{keys=true;show=true;popup=false;views=false;xbox=false;color=BABYLON.Color3.Green();constructor(transform,scene,properties={},alias="PROJECT.DebugInformation"){super(transform,scene,properties,alias)}awake(){this.keys=this.getProperty("enableDebugKeys",this.keys);this.show=this.getProperty("showDebugLabels",this.show);this.popup=this.getProperty("popupDebugPanel",this.popup);this.views=this.getProperty("togglePlayerViews",this.views);this.xbox=this.getProperty("allowXboxLiveSignIn",this.xbox);const debugLabelColor=this.getProperty("debugOutputTextColor");if(debugLabelColor!=null)this.color=TOOLKIT.Utilities.ParseColor3(debugLabelColor);if(TOOLKIT.WindowManager.IsWindows())this.popup=false;TOOLKIT.SceneManager.LogMessage("Debug information overlay loaded")}start(){if(this.show===true){}if(this.keys===true){if(this.views===true){TOOLKIT.SceneManager.LogMessage("Enable Multiplayer Keys");TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.Num1,()=>{PROJECT.DefaultCameraSystem.SetMultiPlayerViewLayout(this.scene,1);TOOLKIT.SceneManager.LogMessage("1 player pressed")});TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.Num2,()=>{PROJECT.DefaultCameraSystem.SetMultiPlayerViewLayout(this.scene,2);TOOLKIT.SceneManager.LogMessage("2 players pressed")});TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.Num3,()=>{PROJECT.DefaultCameraSystem.SetMultiPlayerViewLayout(this.scene,3);TOOLKIT.SceneManager.LogMessage("3 players pressed")});TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.Num4,()=>{PROJECT.DefaultCameraSystem.SetMultiPlayerViewLayout(this.scene,4);TOOLKIT.SceneManager.LogMessage("4 players pressed")})}TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.R,()=>{window.location.reload()});TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.I,()=>{if(this.popup===true){TOOLKIT.WindowManager.PopupDebug(this.scene)}else{TOOLKIT.WindowManager.ToggleDebug(this.scene,true,null)}});TOOLKIT.InputController.OnKeyboardPress(TOOLKIT.UserInputKey.F,()=>{this.openFullscreen(window.top.document.documentElement)})}var printColor=this.color.toHexString();var graphicsVersion=TOOLKIT.SceneManager.GetEngineVersionString(this.scene);TOOLKIT.WindowManager.PrintToScreen(graphicsVersion,printColor)}destroy(){}openFullscreen(elem){DebugInformation._RequestFullscreen(elem)}closeFullscreen(){DebugInformation._ExitFullscreen()}static _RequestFullscreen(element){const requestFunction=element.requestFullscreen||element.webkitRequestFullscreen;if(!requestFunction){return}requestFunction.call(element)}static _ExitFullscreen(){const anyDoc=document;if(document.exitFullscreen){document.exitFullscreen()}else if(anyDoc.webkitCancelFullScreen){anyDoc.webkitCancelFullScreen()}}}PROJECT.DebugInformation=DebugInformation;TOOLKIT.SceneManager.RegisterClass("PROJECT.DebugInformation",DebugInformation)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class AssetExporter extends TOOLKIT.ScriptComponent{constructor(transform,scene,properties={},alias="PROJECT.AssetExporter"){super(transform,scene,properties,alias)}awake(){}start(){}fixed(){}update(){}late(){}after(){}ready(){}destroy(){}}PROJECT.AssetExporter=AssetExporter;TOOLKIT.SceneManager.RegisterClass("PROJECT.AssetExporter",AssetExporter)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class AssetPreloader extends TOOLKIT.ScriptComponent{parentMeshes=false;importMeshes=null;assetContainers=null;constructor(transform,scene,properties={},alias="PROJECT.AssetPreloader"){super(transform,scene,properties,alias)}destroy(){this.importMeshes=null;this.assetContainers=null}addPreloaderTasks(assetsManager){const sceneRootUrl=TOOLKIT.SceneManager.GetRootUrl(this.scene);let rooturl=sceneRootUrl;let filename="";if(this.importMeshes!=null){this.importMeshes.forEach((imporUrl,importIndex)=>{rooturl=sceneRootUrl;filename=imporUrl;if(imporUrl.indexOf("://")>=0){rooturl=imporUrl.substring(0,imporUrl.lastIndexOf('/'))+"/";filename=imporUrl.substring(imporUrl.lastIndexOf('/')+1)}const importTask=assetsManager.addMeshTask((this.transform.name+".MeshTask."+importIndex.toString()),null,rooturl,filename);importTask.onSuccess=task=>{if(task.loadedMeshes!=null){if(this.parentMeshes===true)task.loadedMeshes[0].parent=this.transform;const meshTaskKey=task.sceneFilename.toString().toLowerCase();TOOLKIT.SceneManager.RegisterImportMeshes(this.scene,meshTaskKey,task.loadedMeshes)}};importTask.onError=(task,message,exception)=>{console.error(message,exception)}})}if(this.assetContainers!=null){this.assetContainers.forEach((assetUrl,assetIndex)=>{let rooturl=sceneRootUrl;let filename=assetUrl;if(assetUrl.indexOf("://")>=0){rooturl=assetUrl.substring(0,assetUrl.lastIndexOf('/'))+"/";filename=assetUrl.substring(assetUrl.lastIndexOf('/')+1)}const assetTask=assetsManager.addContainerTask((this.transform.name+".ContainerTask."+assetIndex.toString()),null,rooturl,filename);assetTask.onSuccess=task=>{if(task.loadedContainer!=null){const assetTaskKey=task.sceneFilename.toString().toLowerCase();TOOLKIT.SceneManager.RegisterAssetContainer(this.scene,assetTaskKey,task.loadedContainer)}};assetTask.onError=(task,message,exception)=>{console.error(message,exception)}})}}}PROJECT.AssetPreloader=AssetPreloader;TOOLKIT.SceneManager.RegisterClass("PROJECT.AssetPreloader",AssetPreloader)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class NodeMaterialInstance extends TOOLKIT.ScriptComponent{nodeMaterialData=null;setCustomRootUrl=null;getMaterialInstance(){return this.m_nodeMaterial}m_nodeMaterial=null;constructor(transform,scene,properties={},alias="PROJECT.NodeMaterialInstance"){super(transform,scene,properties,alias)}awake(){if(this.nodeMaterialData!=null){const rootUrl=(this.setCustomRootUrl!=null&&this.setCustomRootUrl!=="")?this.setCustomRootUrl.trim():"";this.m_nodeMaterial=BABYLON.NodeMaterial.Parse(this.nodeMaterialData,this.scene,rootUrl);this.m_nodeMaterial.name=this.transform.name+".NodeMaterial"}}destroy(){if(this.m_nodeMaterial!=null){this.m_nodeMaterial.dispose();this.m_nodeMaterial=null}}}PROJECT.NodeMaterialInstance=NodeMaterialInstance;TOOLKIT.SceneManager.RegisterClass("PROJECT.NodeMaterialInstance",NodeMaterialInstance)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class NodeMaterialParticle extends TOOLKIT.ScriptComponent{nodeMaterialEditor=null;constructor(transform,scene,properties={},alias="PROJECT.NodeMaterialParticle"){super(transform,scene,properties,alias)}awake(){}start(){if(this.nodeMaterialEditor!=null){const nme=TOOLKIT.SceneManager.FindScriptComponent(this.nodeMaterialEditor,"PROJECT.NodeMaterialInstance");if(nme!=null){const materialInstance=nme.getMaterialInstance();if(materialInstance!=null){this.setupNodeMaterial(materialInstance)}else{console.warn("Null node material instance on: "+this.nodeMaterialEditor.name)}}else{console.warn("Failed to locate node material editor on: "+this.nodeMaterialEditor.name)}}}setupNodeMaterial(materialInstance){}update(){}late(){}after(){}fixed(){}ready(){}destroy(){this.nodeMaterialEditor=null}}PROJECT.NodeMaterialParticle=NodeMaterialParticle;TOOLKIT.SceneManager.RegisterClass("PROJECT.NodeMaterialParticle",NodeMaterialParticle)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class NodeMaterialProcess extends TOOLKIT.ScriptComponent{nodeMaterialEditor=null;numberOfSamples=1;samplingMode=0;textureType=0;textureFormat=BABYLON.Constants.TEXTUREFORMAT_RGBA;sizeRatio=1.0;resuable=false;getPostProcess(){return this.m_postProcess}m_postProcess=null;constructor(transform,scene,properties={},alias="PROJECT.NodeMaterialProcess"){super(transform,scene,properties,alias)}start(){if(this.nodeMaterialEditor!=null){const nme=TOOLKIT.SceneManager.FindScriptComponent(this.nodeMaterialEditor,"PROJECT.NodeMaterialInstance");if(nme!=null){const materialInstance=nme.getMaterialInstance();if(materialInstance!=null){this.setupNodeMaterial(materialInstance)}else{console.warn("Null node material instance on: "+this.nodeMaterialEditor.name)}}else{console.warn("Failed to locate node material editor on: "+this.nodeMaterialEditor.name)}}}setupNodeMaterial(materialInstance){const camera=this.getCameraRig();if(camera!=null){this.m_postProcess=materialInstance.createPostProcess(camera,this.sizeRatio,this.samplingMode,this.scene.getEngine(),this.resuable,this.textureType,this.textureFormat);if(this.m_postProcess!=null){this.m_postProcess.name=(this.transform.name+".Process");this.m_postProcess.samples=this.numberOfSamples}else{console.warn("Failed to create post process for: "+this.transform.name)}}else{console.warn("Null camera rig for: "+this.transform.name)}}destroy(){this.nodeMaterialEditor=null;if(this.m_postProcess!=null){this.m_postProcess.dispose();this.m_postProcess=null}}}PROJECT.NodeMaterialProcess=NodeMaterialProcess;TOOLKIT.SceneManager.RegisterClass("PROJECT.NodeMaterialProcess",NodeMaterialProcess)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class NodeMaterialTexture extends TOOLKIT.ScriptComponent{nodeMaterialEditor=null;textureSize=256;getProceduralTexture(){return this.m_proceduralTexture}m_proceduralTexture=null;constructor(transform,scene,properties={},alias="PROJECT.NodeMaterialTexture"){super(transform,scene,properties,alias)}start(){if(this.nodeMaterialEditor!=null){const nme=TOOLKIT.SceneManager.FindScriptComponent(this.nodeMaterialEditor,"PROJECT.NodeMaterialInstance");if(nme!=null){const materialInstance=nme.getMaterialInstance();if(materialInstance!=null){this.setupNodeMaterial(materialInstance)}else{console.warn("Null node material instance on: "+this.nodeMaterialEditor.name)}}else{console.warn("Failed to locate node material editor on: "+this.nodeMaterialEditor.name)}}}setupNodeMaterial(materialInstance){this.m_proceduralTexture=materialInstance.createProceduralTexture(this.textureSize,this.scene);if(this.m_proceduralTexture!=null){this.m_proceduralTexture.name=(this.transform.name+".Texture")}}destroy(){this.nodeMaterialEditor=null;if(this.m_proceduralTexture!=null){this.m_proceduralTexture.dispose();this.m_proceduralTexture=null}}}PROJECT.NodeMaterialTexture=NodeMaterialTexture;TOOLKIT.SceneManager.RegisterClass("PROJECT.NodeMaterialTexture",NodeMaterialTexture)})(PROJECT||(PROJECT={}));var __decorate=(this&&this.__decorate)||function(decorators,target,key,desc){var c=arguments.length,r=c<3?target:desc===null?desc=Object.getOwnPropertyDescriptor(target,key):desc,d;if(typeof Reflect==="object"&&typeof Reflect.decorate==="function")r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)if(d=decorators[i])r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r;return c>3&&r&&Object.defineProperty(target,key,r),r};var PROJECT;(function(PROJECT){class MobileInputController extends TOOLKIT.ScriptComponent{static get Instance(){return PROJECT.MobileInputController.StaticInstance}static StaticInstance=null;styleSheet=null;controlType=0;parentElement="root";maxReadyTimeout=200;maxMoveDistance=28;maxMoveDeadzone=4;uiParentElement=null;leftBaseElement=null;rightBaseElement=null;buttonBaseElement=null;leftStickStyle=0;rightStickStyle=0;leftStickFactor=1.0;rightStickFactor=1.0;invertLeftStickY=true;centerLeftJoystick=false;enableLeftJoystick=true;invertRightStickY=true;centerRightJoystick=false;enableRightJoystick=true;enableMouseAxes=false;enableVirtualButtons=false;virtualButtonControls=null;m_leftStick=null;m_rightStick=null;m_mobileDevice=false;getLeftStick(){return this.m_leftStick}getRightStick(){return this.m_rightStick}getLeftStickEnabled(){return this.enableLeftJoystick}getRightStickEnabled(){return this.enableRightJoystick}getLeftStickElement(){return this.leftBaseElement}getRightStickElement(){return this.rightBaseElement}showLeftStickElement(show){if(this.leftBaseElement!=null)this.leftBaseElement.style.display=(show===true)?"block":"none"}showRightStickElement(show){if(this.rightBaseElement!=null)this.rightBaseElement.style.display=(show===true)?"block":"none"}constructor(transform,scene,properties={},alias="PROJECT.MobileInputController"){super(transform,scene,properties,alias);PROJECT.MobileInputController.StaticInstance=this}awake(){this.m_mobileDevice=TOOLKIT.WindowManager.IsMobile();if(this.controlType===1||this.m_mobileDevice===true){}const rootElement=(this.parentElement!=null&&this.parentElement!==""&&this.parentElement.toLowerCase()!=="body")?document.getElementById(this.parentElement):null;this.uiParentElement=(rootElement!=null)?rootElement:document.body}start(){if(this.controlType===1||this.m_mobileDevice===true){this.loadStyleSheet();this.loadHtmlMarkup()}}ready(){if(this.controlType===1||this.m_mobileDevice===true){TOOLKIT.SceneManager.VirtualJoystickEnabled=!this.enableMouseAxes;const displayTimeout=(this.maxReadyTimeout>=10)?this.maxReadyTimeout:10;TOOLKIT.WindowManager.SetTimeout(displayTimeout,()=>{this.createHtmlElements();if(this.enableLeftJoystick===true)this.m_leftStick=new TOOLKIT.TouchJoystickHandler("stick1",this.maxMoveDistance,this.maxMoveDeadzone);if(this.enableRightJoystick===true)this.m_rightStick=new TOOLKIT.TouchJoystickHandler("stick2",this.maxMoveDistance,this.maxMoveDeadzone)})}}update(){if(this.controlType===1||this.m_mobileDevice===true){if(TOOLKIT.InputController.AllowMobileControls===true){if(this.enableLeftJoystick===true&&this.m_leftStick!=null){TOOLKIT.InputController.MobileControlsActive=true;const leftStickValueX=this.m_leftStick.getValueX();const leftStickValueY=this.m_leftStick.getValueY();const leftStickFixedX=BABYLON.Scalar.Clamp((leftStickValueX*this.leftStickFactor),-1,1);const leftStickFixedY=BABYLON.Scalar.Clamp((leftStickValueY*this.leftStickFactor),-1,1);TOOLKIT.InputController.SetLeftJoystickBuffer(leftStickFixedX,leftStickFixedY,this.invertLeftStickY)}if(this.enableRightJoystick===true&&this.m_rightStick!=null){TOOLKIT.InputController.MobileControlsActive=true;const rightStickValueX=this.m_rightStick.getValueX();const rightStickValueY=this.m_rightStick.getValueY();const rightStickFixedX=BABYLON.Scalar.Clamp((rightStickValueX*this.rightStickFactor),-1,1);const rightStickFixedY=BABYLON.Scalar.Clamp((rightStickValueY*this.rightStickFactor),-1,1);TOOLKIT.InputController.SetRightJoystickBuffer(rightStickFixedX,rightStickFixedY,this.invertRightStickY)}if(this.enableVirtualButtons===true){TOOLKIT.InputController.MobileControlsActive=true}}else{}}}destroy(){if(this.m_leftStick!=null){this.m_leftStick.dispose();this.m_leftStick=null}if(this.m_rightStick!=null){this.m_rightStick.dispose();this.m_rightStick=null}}loadStyleSheet(){if(this.styleSheet!=null&&this.styleSheet!==""){const style=document.createElement("style");style.id="MobileStyleSheet";style.type="text/css";if(style.styleSheet){style.styleSheet.cssText=this.styleSheet}else{style.appendChild(document.createTextNode(this.styleSheet))}document.head.appendChild(style)}else{console.warn("WARNING: Mobile Style Sheet Not Defined For: "+this.transform.name)}}loadHtmlMarkup(){}createHtmlElements(){const rootUrl=TOOLKIT.SceneManager.GetRootUrl(this.scene);const leftBaseImageData=this.getProperty("leftStickBase");const rightBaseImageData=this.getProperty("rightStickBase");const leftStickImageData=this.getProperty("leftStickImage");const rightStickImageData=this.getProperty("rightStickImage");const lbaseImageFilename=(leftBaseImageData!=null)?leftBaseImageData.filename:"baseImage.png";const rbaseImageFilename=(rightBaseImageData!=null)?rightBaseImageData.filename:"baseImage.png";const leftStickImageFilename=(leftStickImageData!=null)?leftStickImageData.filename:"leftStick.png";const rightStickImageFilename=(rightStickImageData!=null)?rightStickImageData.filename:"rightStick.png";if(this.enableLeftJoystick===true){this.leftBaseElement=document.createElement("div");this.leftBaseElement.id="base1";this.leftBaseElement.style.display=(this.leftStickStyle===0)?"block":"none";this.leftBaseElement.className=(this.centerLeftJoystick===true)?"GamepadCenterStick":"GamepadLeftStick";this.leftBaseElement.oncontextmenu=()=>{return false};const baseImg1=document.createElement("img");baseImg1.id="image1";baseImg1.src=(rootUrl+lbaseImageFilename);baseImg1.className="GamepadLeftBase";baseImg1.oncontextmenu=()=>{return false};baseImg1.style.userSelect="none";baseImg1.style.webkitUserSelect="none";baseImg1.style.setProperty("-webkit-touch-callout","none");baseImg1.style.setProperty("-webkit-user-drag","none");baseImg1.style.setProperty("-webkit-tap-highlight-color","transparent");baseImg1.draggable=false;const ballDiv1=document.createElement("div");ballDiv1.id="stick1";ballDiv1.className="GamepadLeftContent";ballDiv1.oncontextmenu=()=>{return false};const ballImg1=document.createElement("img");ballImg1.id="ball1";ballImg1.src=(rootUrl+leftStickImageFilename);ballImg1.className="GamepadLeftControl";ballImg1.oncontextmenu=()=>{return false};ballDiv1.appendChild(ballImg1);this.leftBaseElement.appendChild(baseImg1);this.leftBaseElement.appendChild(ballDiv1);this.uiParentElement.appendChild(this.leftBaseElement)}if(this.enableRightJoystick===true){this.rightBaseElement=document.createElement("div");this.rightBaseElement.id="base2";this.rightBaseElement.style.display=(this.rightStickStyle===0)?"block":"none";this.rightBaseElement.className=(this.centerRightJoystick===true)?"GamepadCenterStick":"GamepadRightStick";this.rightBaseElement.oncontextmenu=()=>{return false};const baseImg2=document.createElement("img");baseImg2.id="image2";baseImg2.src=(rootUrl+rbaseImageFilename);baseImg2.className="GamepadRightBase";baseImg2.oncontextmenu=()=>{return false};baseImg2.style.userSelect="none";baseImg2.style.webkitUserSelect="none";baseImg2.style.setProperty("-webkit-touch-callout","none");baseImg2.style.setProperty("-webkit-user-drag","none");baseImg2.style.setProperty("-webkit-tap-highlight-color","transparent");baseImg2.draggable=false;const ballDiv2=document.createElement("div");ballDiv2.id="stick2";ballDiv2.className="GamepadRightContent";ballDiv2.oncontextmenu=()=>{return false};const ballImg2=document.createElement("img");ballImg2.id="ball2";ballImg2.src=(rootUrl+rightStickImageFilename);ballImg2.className="GamepadRightControl";ballImg2.oncontextmenu=()=>{return false};ballDiv2.appendChild(ballImg2);this.rightBaseElement.appendChild(baseImg2);this.rightBaseElement.appendChild(ballDiv2);this.uiParentElement.appendChild(this.rightBaseElement)}if(this.enableVirtualButtons===true){this.buttonBaseElement=document.createElement("div");this.buttonBaseElement.id="base0";this.buttonBaseElement.style.pointerEvents="none";this.buttonBaseElement.className="GamepadButtonGroup";this.buttonBaseElement.oncontextmenu=()=>{return false};if(this.virtualButtonControls!=null){this.virtualButtonControls.forEach((element,index)=>{const buttonIndexCount=(index+1);const buttonImageData=element.buttonImage;const virtualButton=document.createElement("div");virtualButton.id=("button"+buttonIndexCount.toFixed(0));virtualButton.style.cursor="pointer";virtualButton.style.pointerEvents="auto";virtualButton.className=element.className;virtualButton.oncontextmenu=()=>{return false};virtualButton.addEventListener("pointerdown",e=>{TOOLKIT.InputController.InputKeyDownHandler(element.inputKeyCode,e)});virtualButton.addEventListener("pointerup",e=>{TOOLKIT.InputController.InputKeyUpHandler(element.inputKeyCode,e)});if(buttonImageData!=null&&buttonImageData.filename!=null){if(element.buttonCover===0){const buttonImg=document.createElement("img");buttonImg.id=(virtualButton.id+".Image");buttonImg.src=(rootUrl+buttonImageData.filename);buttonImg.style.top="0px";buttonImg.style.left="0px";buttonImg.style.width="100%";buttonImg.style.height="100%";buttonImg.style.border="none";buttonImg.style.margin="0px";buttonImg.style.padding="0px";buttonImg.style.position="absolute";buttonImg.oncontextmenu=()=>{return false};virtualButton.appendChild(buttonImg)}else{virtualButton.textContent=element.buttonName;virtualButton.style.backgroundImage=("url("+rootUrl+buttonImageData.filename+")");virtualButton.style.backgroundRepeat="no-repeat";virtualButton.style.backgroundSize=(element.buttonCover===1)?"cover":"contain"}}else{virtualButton.textContent=element.buttonName}this.buttonBaseElement.appendChild(virtualButton)})}this.uiParentElement.appendChild(this.buttonBaseElement)}}}PROJECT.MobileInputController=MobileInputController;class FreeCameraTouchJoystickInput{camera;controller;joystickAngularSensibility=200;joystickMoveSensibility=40.0;deadzoneDelta=0.1;_yAxisScale=1.0;get invertYAxis(){return this._yAxisScale!==1.0}set invertYAxis(value){this._yAxisScale=value?-1.0:1.0}LSValues=new BABYLON.Vector2(0,0);RSValues=new BABYLON.Vector2(0,0);_cameraTransform=BABYLON.Matrix.Identity();_deltaTransform=BABYLON.Vector3.Zero();_vector3=BABYLON.Vector3.Zero();_vector2=BABYLON.Vector2.Zero();_attached=false;attachControl(){this._attached=true}detachControl(ignored){this._attached=false}checkInputs(){if(this.camera!=null&&this.controller!=null&&this._attached===true){const LStick=this.controller.getLeftStick();if(LStick!=null){this.LSValues.set(LStick.getValueX(),LStick.getValueY());if(this.joystickMoveSensibility!==0){this.LSValues.x=(Math.abs(this.LSValues.x)>this.deadzoneDelta)?this.LSValues.x/this.joystickMoveSensibility:0;this.LSValues.y=(Math.abs(this.LSValues.y)>this.deadzoneDelta)?this.LSValues.y/this.joystickMoveSensibility:0}}else{this.LSValues.set(0,0)}const RStick=this.controller.getRightStick();if(RStick!=null){this.RSValues.set(RStick.getValueX(),RStick.getValueY());if(this.joystickAngularSensibility!==0){this.RSValues.x=(Math.abs(this.RSValues.x)>this.deadzoneDelta)?this.RSValues.x/this.joystickAngularSensibility:0;this.RSValues.y=((Math.abs(this.RSValues.y)>this.deadzoneDelta)?this.RSValues.y/this.joystickAngularSensibility:0)*this._yAxisScale}}else{this.RSValues.set(0,0)}if(!this.camera.rotationQuaternion){BABYLON.Matrix.RotationYawPitchRollToRef(this.camera.rotation.y,this.camera.rotation.x,0,this._cameraTransform)}else{this.camera.rotationQuaternion.toRotationMatrix(this._cameraTransform)}var speed=this.camera._computeLocalCameraSpeed()*50.0;this._vector3.copyFromFloats(this.LSValues.x*speed,0,-this.LSValues.y*speed);BABYLON.Vector3.TransformCoordinatesToRef(this._vector3,this._cameraTransform,this._deltaTransform);this.camera.cameraDirection.addInPlace(this._deltaTransform);this._vector2.copyFromFloats(this.RSValues.y,this.RSValues.x);this.camera.cameraRotation.addInPlace(this._vector2)}}getClassName(){return"FreeCameraTouchJoystickInput"}getSimpleName(){return"joystick"}}__decorate([BABYLON.serialize()],FreeCameraTouchJoystickInput.prototype,"joystickAngularSensibility",void 0);__decorate([BABYLON.serialize()],FreeCameraTouchJoystickInput.prototype,"joystickMoveSensibility",void 0);PROJECT.FreeCameraTouchJoystickInput=FreeCameraTouchJoystickInput;BABYLON.CameraInputTypes["FreeCameraTouchJoystickInput"]=PROJECT.FreeCameraTouchJoystickInput;TOOLKIT.SceneManager.RegisterClass("PROJECT.MobileInputController",MobileInputController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class MobileOccludeMaterial extends TOOLKIT.ScriptComponent{applyToMaterial=true;constructor(transform,scene,properties={},alias="PROJECT.MobileOccludeMaterial"){super(transform,scene,properties,alias)}awake(){if(this.applyToMaterial===true&&this.transform instanceof BABYLON.AbstractMesh){this.transform.material.disableColorWrite=true}}}PROJECT.MobileOccludeMaterial=MobileOccludeMaterial;TOOLKIT.SceneManager.RegisterClass("PROJECT.MobileOccludeMaterial",MobileOccludeMaterial)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class MobileShadowMaterial extends TOOLKIT.ScriptComponent{createNewMaterial=true;constructor(transform,scene,properties={},alias="PROJECT.MobileShadowMaterial"){super(transform,scene,properties,alias)}awake(){if(this.createNewMaterial===true&&this.transform instanceof BABYLON.AbstractMesh){const materialName=this.transform.name.replace(" ","")+".ShadowMaterial";this.transform.material=new BABYLON.ShadowOnlyMaterial(materialName,this.scene)}}destroy(){if(this.createNewMaterial===true&&this.transform instanceof BABYLON.AbstractMesh){if(this.transform.material!=null&&this.transform.material instanceof BABYLON.ShadowOnlyMaterial){this.transform.material.dispose()}}}}PROJECT.MobileShadowMaterial=MobileShadowMaterial;TOOLKIT.SceneManager.RegisterClass("PROJECT.MobileShadowMaterial",MobileShadowMaterial)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class ColyseusGameServer extends TOOLKIT.ScriptComponent{static MAX_FRAME_RATE=200;projectName="Game Project";autoJoinRoom=true;playerUserName="Player";defaultRoomName="default";roomLogicModule="DefaultLogic";maxClientsAllowed=8;patchUpdateRateFps=20;roomSimulateRateFps=60;networkBufferingTime=0.15;soloSession=false;colyseusAvailable=false;networkRoomConnected=false;hostSessionName=null;joinRoomId=null;client=null;static StaticInstance=null;static get Instance(){return PROJECT.ColyseusGameServer.StaticInstance}isSoloSession(){return this.soloSession}isHostSession(){return(this.hostSessionName!=null&&this.hostSessionName!=="")}getColyseusClient(){return this.client}constructor(transform,scene,properties,alias="PROJECT.ColyseusGameServer"){super(transform,scene,properties,alias);PROJECT.ColyseusGameServer.StaticInstance=this}awake(){if(BABYLON.NetworkManager.IsAvailable()){this.colyseusAvailable=true;BABYLON.Tools.Log("Colyseus network library loaded")}else{this.colyseusAvailable=false;BABYLON.Tools.Warn("Colyseus network library not available")}try{const playerSoloParam=TOOLKIT.WindowManager.GetUrlParameter("solo");if(playerSoloParam!=null&&playerSoloParam!==""&&playerSoloParam!=="*"){if(playerSoloParam.toLowerCase()==="true"){this.soloSession=true;this.colyseusAvailable=false;BABYLON.Tools.Warn("Colyseus solo network game play requested")}}}catch(e){console.error(e)}if(this.colyseusAvailable===true){try{const serverEndpointParam=TOOLKIT.WindowManager.GetUrlParameter("endpoint");if(serverEndpointParam!=null&&serverEndpointParam!==""){const serverEndpoint=decodeURIComponent(serverEndpointParam);if(serverEndpoint!=null&&serverEndpoint!==""&&serverEndpoint!=="*"){TOOLKIT.SceneManager.ServerEndPoint=serverEndpoint}}}catch(e0){console.error(e0)}try{const playerNameParam=TOOLKIT.WindowManager.GetUrlParameter("player");if(playerNameParam!=null&&playerNameParam!==""&&playerNameParam!=="*"){this.playerUserName=decodeURIComponent(playerNameParam)}}catch(e1){console.error(e1)}try{const roomNameParam=TOOLKIT.WindowManager.GetUrlParameter("room");if(roomNameParam!=null&&roomNameParam!==""&&roomNameParam!=="*"){this.defaultRoomName=decodeURIComponent(roomNameParam)}}catch(e2){console.error(e2)}try{const hostSessionParam=TOOLKIT.WindowManager.GetUrlParameter("host");if(hostSessionParam!=null&&hostSessionParam!==""&&hostSessionParam!=="*"){this.hostSessionName=decodeURIComponent(hostSessionParam)}}catch(e3){console.error(e3)}try{const joinSessionParam=TOOLKIT.WindowManager.GetUrlParameter("join");if(joinSessionParam!=null&&joinSessionParam!==""&&joinSessionParam!=="*"){this.joinRoomId=decodeURIComponent(joinSessionParam)}}catch(e4){console.error(e4)}BABYLON.NetworkManager.OnJoinRoomObservable.add(user=>{console.warn(user.name+" joined the "+this.defaultRoomName.toLowerCase()+" room.")})}}update(){if(this.colyseusAvailable===true&&this.networkRoomConnected===false&&this.autoJoinRoom===true&&this.isReady()){this.autoJoinRoom=false;this.joinRoom()}}destroy(){this.autoJoinRoom=false;this.colyseusAvailable=false;this.networkRoomConnected=true;this.defaultRoomName=null;this.playerUserName=null;this.client=null}async joinRoom(){if(this.patchUpdateRateFps>PROJECT.ColyseusGameServer.MAX_FRAME_RATE)this.patchUpdateRateFps=PROJECT.ColyseusGameServer.MAX_FRAME_RATE;if(this.roomSimulateRateFps>PROJECT.ColyseusGameServer.MAX_FRAME_RATE)this.roomSimulateRateFps=PROJECT.ColyseusGameServer.MAX_FRAME_RATE;if(this.colyseusAvailable===true){try{const websocketUrl=(TOOLKIT.SceneManager.ServerEndPoint.toLowerCase().startsWith("http"))?("ws"+TOOLKIT.SceneManager.ServerEndPoint.substring(4)):TOOLKIT.SceneManager.ServerEndPoint;if(TOOLKIT.SceneManager.ServerEndPoint.endsWith("/"))TOOLKIT.SceneManager.ServerEndPoint=TOOLKIT.SceneManager.ServerEndPoint.substring(0,(TOOLKIT.SceneManager.ServerEndPoint.length-1));if(this.projectName==null||this.projectName==="")this.projectName="Game Project";console.log(">>> Server Endpoint: "+TOOLKIT.SceneManager.ServerEndPoint);console.log(">>> Web Socket Url: "+websocketUrl);console.log(">>> Max Clients: "+this.maxClientsAllowed);console.log(">>> Room Name: "+this.defaultRoomName);console.log(">>> User Name: "+this.playerUserName);console.log(">>> Host Desc: "+this.hostSessionName);console.log(">>> Join Room: "+this.joinRoomId);let room=null;if(this.client==null)this.client=new Colyseus.Client(websocketUrl);if(this.hostSessionName!=null&&this.hostSessionName!==""){const sceneFile=TOOLKIT.SceneManager.GetSceneFile(this.scene);room=await this.client.create(this.defaultRoomName,{userName:this.playerUserName,roomLogic:this.roomLogicModule,maxClients:this.maxClientsAllowed,interpolationBuffer:this.networkBufferingTime,patchUpdateRateMs:(1000/this.patchUpdateRateFps),roomSimulationIntervalMs:(1000/this.roomSimulateRateFps),userDatagramProtocol:false,compressDataPackets:false,project:this.projectName,type:"client",desc:this.hostSessionName,map:sceneFile,aux:"*"})}else if(this.joinRoomId!=null&&this.joinRoomId!==""){room=await this.client.joinById(this.joinRoomId,{userName:this.playerUserName})}if(room!=null){BABYLON.NetworkManager.AttachDefaultRoom(this.scene,room)}else{console.error("Failed to join room: "+this.transform.name)}}catch(e){console.error("Failed to connect: ",e)}finally{this.networkRoomConnected=true}}}}PROJECT.ColyseusGameServer=ColyseusGameServer;TOOLKIT.SceneManager.RegisterClass("PROJECT.ColyseusGameServer",ColyseusGameServer)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class ColyseusNetworkAvatar extends TOOLKIT.ScriptComponent{static FONT_PADDING=36;static HEIGHT_PADDING=0.1;controlMode=0;defaultAvatar=null;maleAnimationRig=null;femaleAnimationRig=null;castRealtimeShadow=true;disposeOfMannequin=true;pixelOffsetX=0;pixelOffsetY=0;playerJoined=false;preloadLocation=null;ambientMaterial=new BABYLON.Color3(1.0,1.0,1.0);avatarArmature=null;avatarSkeleton=null;avatarHandness="Left";avatarGender="Male";avatarLabel="Default Player";avatarLoaded=false;avatarReady=false;manageLabelTexture=true;textureResolution=512;maxLabelWidth=960;minLabelWidth=320;labelOffsetX=0;labelOffsetY=2.0;labelHeight=64;labelColor=new BABYLON.Color3(0.0,1.0,0.0);labelAlpha=0.85;rectColor=new BABYLON.Color3(0.0,0.0,0.0);rectAlpha=0.65;fontFamily="Arial";fontStyle="Bold";fontSize=36;fillRect=true;constructor(transform,scene,properties={},alias="PROJECT.ColyseusNetworkAvatar"){super(transform,scene,properties,alias)}awake(){const defaultAvatarInfo=this.getProperty("defaultAvatar");if(defaultAvatarInfo!=null)this.defaultAvatar=(defaultAvatarInfo.name+".glb");const maleAnimationInfo=this.getProperty("maleAnimationRig");if(maleAnimationInfo!=null)this.maleAnimationRig=(maleAnimationInfo.name+".glb");const femaleAnimationInfo=this.getProperty("femaleAnimationRig");if(femaleAnimationInfo!=null)this.femaleAnimationRig=(femaleAnimationInfo.name+".glb");if(this.isSafariBrowser()===true)this.pixelOffsetY=0;else this.pixelOffsetY=2}ready(){if(this.controlMode===0){this.setupLocalPlayerAvatar()}this.avatarReady=true}update(){if(this.playerJoined===false&&this.avatarReady===true){if(BABYLON.NetworkManager.HasJoinedRoom()){this.playerJoined=true;if(this.controlMode===0){if(this.manageLabelTexture===true){this.avatarLabel=BABYLON.NetworkManager.GetCurrentUser().name;this.createAvatarLabel(this.avatarLabel)}}else if(this.controlMode===1){this.setupRemotePlayerAvatar();if(this.manageLabelTexture===true){this.createAvatarLabel(this.avatarLabel)}}}}}destroy(){this.avatarLabel=null;this.avatarGender=null;this.avatarHandness=null;this.avatarArmature=null;this.avatarSkeleton=null;this.defaultAvatar=null;this.preloadLocation=null;this.maleAnimationRig=null;this.femaleAnimationRig=null}isSafariBrowser(){let result=false;if(navigator!=null&&navigator.userAgent!=null){result=navigator.vendor.match(/apple/i)&&!navigator.userAgent.match(/crios/i)&&!navigator.userAgent.match(/fxios/i)&&!navigator.userAgent.match(/Opera|OPT\//)}return result}createAvatarLabel(name){if(name!=null&&name!==""){const plane=BABYLON.MeshBuilder.CreatePlane("TexturePlane",{width:1,height:1},this.scene);const planeMaterial=new BABYLON.StandardMaterial((this.transform.name+".PlaneMaterial"),this.scene);const opacityTexture=new BABYLON.DynamicTexture("PlayerTexture",{width:this.textureResolution,height:this.textureResolution},this.scene);const opacityCtx=opacityTexture.getContext();const fontString=this.getResizedFontString(name,this.maxLabelWidth,this.fontSize,this.fontFamily,this.fontStyle);opacityCtx.font=fontString;const fontWidth=opacityCtx.measureText(name).width;const fontPadding=PROJECT.ColyseusNetworkAvatar.FONT_PADDING;let rectWidth=(fontWidth+fontPadding);let rectHeight=this.labelHeight;if(rectWidth<this.minLabelWidth)rectWidth=this.minLabelWidth;if(rectWidth>this.maxLabelWidth)rectWidth=this.maxLabelWidth;if(this.fillRect===true){opacityCtx.fillStyle=`rgba(0, 0, 0, ${this.rectAlpha.toString()})`;this.createRoundedRect((this.textureResolution*0.5)-(rectWidth*0.5),(this.textureResolution*0.5)-(rectHeight*0.5),rectWidth,rectHeight,(rectHeight*0.5),opacityCtx);opacityCtx.fill()}opacityCtx.textAlign="center";opacityCtx.textBaseline="middle";opacityCtx.fillStyle=`rgba(0, 0, 0, ${this.labelAlpha.toString()})`;opacityCtx.fillText(name,(this.textureResolution*0.5)+this.pixelOffsetX,(this.textureResolution*0.5)+this.pixelOffsetY);opacityTexture.update(true);const colorTexture=new BABYLON.DynamicTexture("PlayerTextureColor",{width:this.textureResolution,height:this.textureResolution},this.scene);const colorCtx=colorTexture.getContext();colorCtx.fillStyle=this.rectColor.toHexString();colorCtx.fillRect(0,0,this.textureResolution,this.textureResolution);colorCtx.font=fontString;colorCtx.textAlign="center";colorCtx.textBaseline="middle";colorCtx.fillStyle=this.labelColor.toHexString();colorCtx.fillText(name,(this.textureResolution*0.5)+this.pixelOffsetX,(this.textureResolution*0.5)+this.pixelOffsetY);colorTexture.update(true);planeMaterial.disableLighting=true;planeMaterial.opacityTexture=opacityTexture;planeMaterial.diffuseTexture=colorTexture;planeMaterial.emissiveTexture=colorTexture;plane.material=planeMaterial;plane.billboardMode=BABYLON.Mesh.BILLBOARDMODE_ALL;plane.position.x=this.labelOffsetX;plane.position.y=(this.labelOffsetY+PROJECT.ColyseusNetworkAvatar.HEIGHT_PADDING);plane.parent=this.transform.parent;plane.renderingGroupId=TOOLKIT.Utilities.DefaultRenderGroup()}}createRoundedRect(x,y,w,h,r,ctx){if(w<2*r)r=w/2;if(h<2*r)r=h/2;ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath()}getResizedFontString(text,maxWidth,startingFontSize,fontFamily="Arial",fontStyle=""){const tempCanvas=document.createElement('canvas');const measureCtx=tempCanvas.getContext('2d');const getFontString=size=>{return`${fontStyle}${(fontStyle==="")?"":" "}${size}px ${fontFamily}`};let currentSize=startingFontSize;measureCtx.font=getFontString(currentSize);let currentWidth=measureCtx.measureText(text).width;if(currentWidth>maxWidth){let step=1;while(currentWidth>maxWidth){let newSize=currentSize-step;measureCtx.font=getFontString(newSize);let newWidth=measureCtx.measureText(text).width;if(newWidth<maxWidth&&step===1){step=0.1;newSize+=1}else{currentWidth=newWidth}currentSize=newSize}}return getFontString(currentSize)}setupLocalPlayerAvatar(){try{const playerAvatarParam=TOOLKIT.WindowManager.GetUrlParameter("avatar");if(playerAvatarParam!=null&&playerAvatarParam!==""&&playerAvatarParam!=="*"){this.defaultAvatar=decodeURIComponent(playerAvatarParam)}}catch(e1){console.error(e1)}try{const playerGenderParam=TOOLKIT.WindowManager.GetUrlParameter("gender");if(playerGenderParam!=null&&playerGenderParam!==""&&playerGenderParam!=="*"){this.avatarGender=decodeURIComponent(playerGenderParam)}}catch(e2){console.error(e2)}try{const playerHandnessParam=TOOLKIT.WindowManager.GetUrlParameter("hand");if(playerHandnessParam!=null&&playerHandnessParam!==""&&playerHandnessParam!=="*"){this.avatarHandness=decodeURIComponent(playerHandnessParam)}}catch(e3){console.error(e3)}try{const playerHandnessParam=TOOLKIT.WindowManager.GetUrlParameter("hand");if(playerHandnessParam!=null&&playerHandnessParam!==""&&playerHandnessParam!=="*"){this.avatarHandness=decodeURIComponent(playerHandnessParam)}}catch(e3){console.error(e3)}const klass="PROJECT.ColyseusNetworkEntity";let colyseus=TOOLKIT.SceneManager.FindScriptComponent(this.transform,klass);if(colyseus==null){if(this.transform.parent!=null){colyseus=TOOLKIT.SceneManager.FindScriptComponent(this.transform.parent,klass);if(colyseus==null){if(this.transform.parent.parent!=null){colyseus=TOOLKIT.SceneManager.FindScriptComponent(this.transform.parent.parent,klass);if(colyseus==null){if(this.transform.parent.parent.parent!=null){colyseus=TOOLKIT.SceneManager.FindScriptComponent(this.transform.parent.parent.parent,klass)}}}}}}if(colyseus!=null){if(colyseus.runtimeAttributes==null)colyseus.runtimeAttributes=[];colyseus.runtimeAttributes.push({key:"playerAvatar",value:this.defaultAvatar});colyseus.runtimeAttributes.push({key:"playerGender",value:this.avatarGender});colyseus.runtimeAttributes.push({key:"playerHand",value:this.avatarHandness})}if(this.defaultAvatar!=null&&this.defaultAvatar!==""){if(TOOLKIT.SceneManager.HasSceneBeenPreLoaded(this.scene)){this.loadRuntimePlayerAvatar(this.defaultAvatar)}else{this.preloadLocation=this.defaultAvatar}}else{BABYLON.Tools.Warn("Invalid avatar location specified for: "+this.transform.name)}}setupRemotePlayerAvatar(){let remoteEntity=this.transform.networkEntity;if(remoteEntity==null){if(this.transform.parent!=null){remoteEntity=this.transform.parent.networkEntity;if(remoteEntity==null){if(this.transform.parent.parent!=null){remoteEntity=this.transform.parent.parent.networkEntity;if(remoteEntity==null){if(this.transform.parent.parent.parent!=null){remoteEntity=this.transform.parent.parent.parent.networkEntity}}}}}}if(remoteEntity!=null&&remoteEntity.transformNode!=null&&remoteEntity.transformNodeType!=null&&remoteEntity.transformNodeType===2){const playerAvatar=TOOLKIT.EntityController.QueryNetworkAttribute(remoteEntity.transformNode,"playerAvatar");if(playerAvatar!=null&&playerAvatar!==""){this.defaultAvatar=playerAvatar}const playerGender=TOOLKIT.EntityController.QueryNetworkAttribute(remoteEntity.transformNode,"playerGender");if(playerGender!=null&&playerGender!==""){this.avatarGender=playerGender}const playerHand=TOOLKIT.EntityController.QueryNetworkAttribute(remoteEntity.transformNode,"playerHand");if(playerHand!=null&&playerHand!==""){this.avatarHandness=playerHand}const ownerName=TOOLKIT.EntityController.QueryNetworkAttribute(remoteEntity.transformNode,"ownerName");if(ownerName!=null&&ownerName!==""){this.avatarLabel=ownerName}}if(this.defaultAvatar!=null&&this.defaultAvatar!==""){this.loadRuntimePlayerAvatar(this.defaultAvatar)}else{BABYLON.Tools.Warn("Invalid avatar location specified for: "+this.transform.name)}}configurePlayerAvatarRig(root){if(root!=null){const armatures=root.getChildren(node=>{return(node.name==="Armature")},false);this.avatarLoaded=true;this.avatarArmature=(armatures!=null&&armatures.length>0)?armatures[0]:null;let shadowList=null;let freezeList=null;const meshes=root.getChildMeshes(false);if(meshes!=null&&meshes.length>0){meshes.forEach(mesh=>{mesh.renderingGroupId=TOOLKIT.Utilities.DefaultRenderGroup()})}const skins=root.getChildMeshes(false,node=>{return(node.skeleton!=null)});if(skins!=null&&skins.length>0){skins.forEach(skin=>{if(this.avatarSkeleton==null&&skin.skeleton!=null){this.avatarSkeleton=skin.skeleton}if(this.castRealtimeShadow===true){if(shadowList==null)shadowList=[];shadowList.push(skin)}skin.isPickable=true;skin.useVertexColors=false;skin.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD;skin.alwaysSelectAsActiveMesh=true})}if(shadowList!=null&&shadowList.length>0&&this.scene.lights!=null&&this.scene.lights.length>0){this.scene.lights.forEach(light=>{const shadowgenerator=light.getShadowGenerator();if(shadowgenerator!=null&&light.metadata!=null&&light.metadata.toolkit!=null&&light.metadata.toolkit.autorender===true){const shadowmap=shadowgenerator.getShadowMap();if(shadowmap!=null){if(shadowmap.renderList==null)shadowmap.renderList=[];shadowList.forEach(mesh=>{shadowmap.renderList.push(mesh)})}}})}if(freezeList!=null&&freezeList.length>0){freezeList.forEach(mesh=>{mesh.freezeWorldMatrix()})}if(this.avatarLoaded===true&&this.disposeOfMannequin===true){const children=this.transform.getChildren(null,false);children.forEach(child=>{if(child!=null){if(child instanceof BABYLON.AbstractMesh){try{if(child.skeleton!=null){child.skeleton.dispose();child.skeleton=null}}catch(e3){console.error(e3)}}}});const childrenx=this.transform.getChildren(null,true);childrenx.forEach(childx=>{if(childx!=null){try{childx.dispose()}catch(e4){console.error(e4)}}})}}}loadRuntimePlayerAvatar(url){if(url!=null&&url!==""){const sceneRootUrl=TOOLKIT.SceneManager.GetRootUrl(this.scene);let importUrl=url;let rooturl=sceneRootUrl;let filename="";rooturl=sceneRootUrl;filename=importUrl;if(importUrl.indexOf("://")>=0){rooturl=importUrl.substring(0,importUrl.lastIndexOf('/'))+"/";filename=importUrl.substring(importUrl.lastIndexOf('/')+1)}const assetsManager=new BABYLON.AssetsManager(this.scene);const importTask=assetsManager.addMeshTask((this.transform.name+".MeshTask"),null,rooturl,filename);importTask.onSuccess=task=>{if(task.loadedMeshes!=null){task.loadedMeshes.forEach(mesh=>{if(mesh.material instanceof BABYLON.PBRMaterial){mesh.material.ambientColor=this.ambientMaterial}});let rootAvatarMesh=task.loadedMeshes[0];if(rootAvatarMesh!=null){rootAvatarMesh.parent=this.transform.parent;rootAvatarMesh.name="BlenderAvatar";const meshTaskKey=task.sceneFilename.toString().toLowerCase();TOOLKIT.SceneManager.RegisterImportMeshes(this.scene,meshTaskKey,task.loadedMeshes);this.configurePlayerAvatarRig(rootAvatarMesh)}}};importTask.onError=(task,message,exception)=>{console.error(message,exception)};assetsManager.load()}}addPreloaderTasks(assetsManager){if(this.preloadLocation!=null&&this.preloadLocation!==""){const sceneRootUrl=TOOLKIT.SceneManager.GetRootUrl(this.scene);let importUrl=this.preloadLocation;let rooturl=sceneRootUrl;let filename="";rooturl=sceneRootUrl;filename=importUrl;if(importUrl.indexOf("://")>=0){rooturl=importUrl.substring(0,importUrl.lastIndexOf('/'))+"/";filename=importUrl.substring(importUrl.lastIndexOf('/')+1)}const importTask=assetsManager.addMeshTask((this.transform.name+".MeshTask"),null,rooturl,filename);importTask.onSuccess=task=>{if(task.loadedMeshes!=null){task.loadedMeshes.forEach(mesh=>{if(mesh.material instanceof BABYLON.PBRMaterial){mesh.material.ambientColor=this.ambientMaterial}});let rootAvatarMesh=task.loadedMeshes[0];if(rootAvatarMesh!=null){rootAvatarMesh.parent=this.transform.parent;rootAvatarMesh.name="BlenderAvatar";const meshTaskKey=task.sceneFilename.toString().toLowerCase();TOOLKIT.SceneManager.RegisterImportMeshes(this.scene,meshTaskKey,task.loadedMeshes);this.configurePlayerAvatarRig(rootAvatarMesh)}}};importTask.onError=(task,message,exception)=>{console.error(message,exception)}}}}PROJECT.ColyseusNetworkAvatar=ColyseusNetworkAvatar;TOOLKIT.SceneManager.RegisterClass("PROJECT.ColyseusNetworkAvatar",ColyseusNetworkAvatar)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class ColyseusNetworkEntity extends TOOLKIT.ScriptComponent{autoCreate=true;remotePrefab=null;assetContainer=null;movementEpsilon=0.00001;movementMethod=BABYLON.EntityMovementType.ClientAuthority;interpolationMode=BABYLON.EntityInterpolation.Default;interpolationHandler=null;syncTransformNode=true;runtimeAttributes=null;creationAttributes=null;bufferedAttributes=null;networkEntityCreated=false;constructor(transform,scene,properties={},alias="PROJECT.ColyseusNetworkEntity"){super(transform,scene,properties,alias)}update(){if(this.networkEntityCreated===false&&this.autoCreate===true&&this.isReady()){if(BABYLON.NetworkManager.HasJoinedRoom()){this.autoCreate=false;this.createEntity()}}}destroy(){this.autoCreate=false;this.movementMethod=0;this.remotePrefab=null;this.assetContainer=null;this.interpolationMode=0;this.interpolationHandler=null;this.creationAttributes=null;this.runtimeAttributes=null;this.syncTransformNode=false;this.networkEntityCreated=true;const entityId=TOOLKIT.EntityController.GetNetworkEntityId(this.transform);if(entityId!=null&&entityId!=="")BABYLON.NetworkManager.RemoveNetworkEntity(entityId)}createEntity(){const attributesToCreate={};if(this.creationAttributes!=null&&this.creationAttributes.length>0){this.creationAttributes.forEach(creationAttribute=>{attributesToCreate[creationAttribute.key]=creationAttribute.value})}if(this.runtimeAttributes!=null&&this.runtimeAttributes.length>0){this.runtimeAttributes.forEach(runtimeAttribute=>{attributesToCreate[runtimeAttribute.key]=runtimeAttribute.value})}const customHandler=(this.interpolationMode===BABYLON.EntityInterpolation.Custom)?this.interpolationHandler:"";BABYLON.NetworkManager.CreateNetworkEntity(this.transform,this.remotePrefab,this.assetContainer,this.movementEpsilon,this.movementMethod,this.interpolationMode,this.syncTransformNode,customHandler,this.bufferedAttributes,attributesToCreate);this.networkEntityCreated=true}}PROJECT.ColyseusNetworkEntity=ColyseusNetworkEntity;TOOLKIT.SceneManager.RegisterClass("PROJECT.ColyseusNetworkEntity",ColyseusNetworkEntity)})(PROJECT||(PROJECT={}));var BABYLON;(function(BABYLON){let RemoteFunctionCallTarget;(function(RemoteFunctionCallTarget){RemoteFunctionCallTarget[RemoteFunctionCallTarget["All"]=0]="All";RemoteFunctionCallTarget[RemoteFunctionCallTarget["Others"]=1]="Others"})(RemoteFunctionCallTarget=BABYLON.RemoteFunctionCallTarget||(BABYLON.RemoteFunctionCallTarget={}));let NetworkEntityType;(function(NetworkEntityType){NetworkEntityType[NetworkEntityType["None"]=0]="None";NetworkEntityType[NetworkEntityType["Local"]=1]="Local";NetworkEntityType[NetworkEntityType["Remote"]=2]="Remote"})(NetworkEntityType=BABYLON.NetworkEntityType||(BABYLON.NetworkEntityType={}));let EntityMovementType;(function(EntityMovementType){EntityMovementType[EntityMovementType["ClientAuthority"]=0]="ClientAuthority";EntityMovementType[EntityMovementType["ServerAuthority"]=1]="ServerAuthority"})(EntityMovementType=BABYLON.EntityMovementType||(BABYLON.EntityMovementType={}));let EntityInterpolation;(function(EntityInterpolation){EntityInterpolation[EntityInterpolation["Default"]=0]="Default";EntityInterpolation[EntityInterpolation["Hermite"]=1]="Hermite";EntityInterpolation[EntityInterpolation["Custom"]=2]="Custom"})(EntityInterpolation=BABYLON.EntityInterpolation||(BABYLON.EntityInterpolation={}));class EntityAttribute{key;value;}BABYLON.EntityAttribute=EntityAttribute;class NetworkManager{static RootNode=null;static DefaultRoom=null;static UserReference=null;static NetworkServerTime=0;static NetworkEntityQueue=null;static CustomHandlerMap=new Map;static SendPositionBuffer=new BABYLON.Vector3(0,0,0);static SendRotationBuffer=new BABYLON.Quaternion(0,0,0,1);static SendLinearBuffer=new BABYLON.Vector3(0,0,0);static SendAngularBuffer=new BABYLON.Vector3(0,0,0);static SceneReference=null;static InterpolationBuffer=0.15;static OnConnectObservable=new BABYLON.Observable;static OnDisconnectObservable=new BABYLON.Observable;static OnJoinRoomObservable=new BABYLON.Observable;static OnLeaveRoomObservable=new BABYLON.Observable;static OnCreateEntityObservable=new BABYLON.Observable;static OnRemoveEntityObservable=new BABYLON.Observable;static OnChatMessageObservable=new BABYLON.Observable;static OnPingReceivedObservable=new BABYLON.Observable;static OnErrorMessageObservable=new BABYLON.Observable;static OnRemoteProcedureCallObservable=new BABYLON.Observable;static RegisterCustomInterpolationHandler(name,handler){BABYLON.NetworkManager.CustomHandlerMap.set(name,handler)}static IsAvailable(){return(window.Colyseus!==undefined&&window.Colyseus.Client!==undefined)}static IsRoomAttached(){return(BABYLON.NetworkManager.SceneReference!=null&&BABYLON.NetworkManager.DefaultRoom!=null)}static HasJoinedRoom(){return(BABYLON.NetworkManager.SceneReference!=null&&BABYLON.NetworkManager.DefaultRoom!=null&&BABYLON.NetworkManager.UserReference!=null)}static GetCurrentUser(){return BABYLON.NetworkManager.UserReference}static GetDefaultRoom(){return BABYLON.NetworkManager.DefaultRoom}static GetNetworkTime(){return BABYLON.NetworkManager.NetworkServerTime}static IsLocalNetworkEntity(entity){return(BABYLON.NetworkManager.GetNetworkEntityType(entity)===BABYLON.NetworkEntityType.Local)}static IsRemoteNetworkEntity(entity){return(BABYLON.NetworkManager.GetNetworkEntityType(entity)===BABYLON.NetworkEntityType.Remote)}static GetNetworkEntityType(entity){let result=0;const aentity=entity;if(aentity.transformNode!=null&&aentity.transformNodeType!=null){result=aentity.transformNodeType}return result}static AttachDefaultRoom(scene,room){BABYLON.NetworkManager.DetachDefaultRoom();if(scene!=null&&room!=null){BABYLON.NetworkManager.DefaultRoom=room;BABYLON.NetworkManager.SceneReference=scene;if(room.state!=null&&room.state.entities!=null){room.state.entities.onAdd((e,k)=>{BABYLON.NetworkManager.AddNetworkEntityHandler(e,k)});room.state.entities.onRemove((e,k)=>{BABYLON.NetworkManager.RemoveNetworkEntityHandler(e,k)})}room.onStateChange.once(state=>{BABYLON.NetworkManager.OnDispatchChatQueueMessages(state)});room.onStateChange(state=>{BABYLON.NetworkManager.OnDispatchChatQueueMessages(state)});room.onMessage("onConnect",info=>{BABYLON.NetworkManager.OnConnectObservable.notifyObservers(info.user)});room.onMessage("onDisconnect",info=>{BABYLON.NetworkManager.OnDisconnectObservable.notifyObservers(info.user)});room.onMessage("onJoin",info=>{BABYLON.NetworkManager.JoinDefaultRoomHandler(info);BABYLON.NetworkManager.OnJoinRoomObservable.notifyObservers(info.user)});room.onMessage("onRFC",message=>{BABYLON.NetworkManager.OnRemoteProcedureCallObservable.notifyObservers(message)});room.onLeave(code=>{BABYLON.NetworkManager.OnLeaveRoomObservable.notifyObservers(code)});room.onError((code,message)=>{BABYLON.NetworkManager.OnErrorMessageObservable.notifyObservers({code:code,message:message})});scene.onBeforeRenderObservable.add(BABYLON.NetworkManager.OnSceneBeforeRenderUpdate)}}static DetachDefaultRoom(){try{try{if(BABYLON.NetworkManager.RootNode!=null){BABYLON.NetworkManager.RootNode.dispose()}}catch(e0){console.error(e0)}try{if(BABYLON.NetworkManager.DefaultRoom!=null){BABYLON.NetworkManager.DefaultRoom.removeAllListeners()}}catch(e1){console.error(e1)}try{if(BABYLON.NetworkManager.NetworkEntityQueue!=null){BABYLON.NetworkManager.NetworkEntityQueue.clear()}}catch(e2){console.error(e2)}try{if(BABYLON.NetworkManager.SceneReference!=null){BABYLON.NetworkManager.SceneReference.onBeforeRenderObservable.removeCallback(BABYLON.NetworkManager.OnSceneBeforeRenderUpdate)}}catch(e6){console.error(e6)}}catch(e9){console.error(e9)}finally{BABYLON.NetworkManager.RootNode=null;BABYLON.NetworkManager.DefaultRoom=null;BABYLON.NetworkManager.UserReference=null;BABYLON.NetworkManager.SceneReference=null;BABYLON.NetworkManager.NetworkEntityQueue=null;BABYLON.NetworkManager.NetworkServerTime=0}}static GetNetworkUser(id){let result=null;if(BABYLON.NetworkManager.HasJoinedRoom()){if(BABYLON.NetworkManager.DefaultRoom.state!=null&&BABYLON.NetworkManager.DefaultRoom.state.users!=null){result=BABYLON.NetworkManager.DefaultRoom.state.users.get(id)}}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}return result}static GetNetworkEntity(id){let result=null;if(BABYLON.NetworkManager.HasJoinedRoom()){if(BABYLON.NetworkManager.DefaultRoom.state!=null&&BABYLON.NetworkManager.DefaultRoom.state.entities!=null){result=BABYLON.NetworkManager.DefaultRoom.state.entities.get(id)}}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}return result}static CreateNetworkEntity(localTransform,remotePrefab=null,assetContainer=null,movementEpsilon=0.00001,movementType=BABYLON.EntityMovementType.ClientAuthority,interpolationMode=BABYLON.EntityInterpolation.Default,autoSyncTransform=true,customHandlerName=null,bufferedAttributes,createAttributes=null){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.CreateNetworkEntity(BABYLON.NetworkManager.DefaultRoom,BABYLON.NetworkManager.UserReference.name,localTransform,remotePrefab,assetContainer,movementEpsilon,movementType,interpolationMode,autoSyncTransform,customHandlerName,bufferedAttributes,createAttributes)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static RemoveNetworkEntity(entityId){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.RemoveNetworkEntity(BABYLON.NetworkManager.DefaultRoom,entityId)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static SetUserAttributes(userId,attributesToSet){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.SetUserAttributes(BABYLON.NetworkManager.DefaultRoom,userId,attributesToSet)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static SetEntityAttributes(entityId,attributesToSet){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.SetEntityAttributes(BABYLON.NetworkManager.DefaultRoom,entityId,attributesToSet)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static CallCustomMethod(method,...args){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.CallCustomMethod(BABYLON.NetworkManager.DefaultRoom,method,args)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static ExecuteRemoteFunctionCall(target,entityId,func,...args){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.ExecuteRemoteFunctionCall(BABYLON.NetworkManager.DefaultRoom,target,entityId,func,args)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static GetChatMessages(){let messages=null;if(BABYLON.NetworkManager.HasJoinedRoom()){if(BABYLON.NetworkManager.DefaultRoom.state.queue!=null){BABYLON.NetworkManager.DefaultRoom.state.queue.forEach((queue,id)=>{if(queue!=null&&queue.messages!=null){queue.messages.forEach((message,index)=>{if(message!=null){if(messages==null)messages=[];messages.push(message)}})}})}}return messages}static SendChatMessage(message){if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.RoomController.SendChat(BABYLON.NetworkManager.DefaultRoom,message)}else{BABYLON.Tools.Warn("Network manager has not joined the default universal game room.")}}static OnSceneBeforeRenderUpdate(){const deltaTime=TOOLKIT.SceneManager.GetDeltaSeconds(BABYLON.NetworkManager.SceneReference);if(BABYLON.NetworkManager.NetworkServerTime>0){BABYLON.NetworkManager.NetworkServerTime+=deltaTime}BABYLON.NetworkManager.ProcessNetworkEntities(deltaTime)}static OnDispatchChatQueueMessages(state){if(BABYLON.NetworkManager.HasJoinedRoom()){let messages=BABYLON.NetworkManager.GetChatMessages();if(messages!=null&&messages.length>0){messages.sort((left,right)=>{if(left.timestamp<right.timestamp)return-1;if(left.timestamp>right.timestamp)return 1;return 0});messages.forEach(mx=>{if(mx!=null&&(mx.dispatched==null||mx.dispatched==false)){try{if(BABYLON.NetworkManager.OnChatMessageObservable&&BABYLON.NetworkManager.OnChatMessageObservable.hasObservers()){BABYLON.NetworkManager.OnChatMessageObservable.notifyObservers({...mx})}}catch(e){console.error(e)}finally{mx.dispatched=true}}})}}}static ProcessNetworkEntities(deltaTime){if(BABYLON.NetworkManager.HasJoinedRoom()){let transmitPacketBuffer=null;BABYLON.NetworkManager.DefaultRoom.state.entities.forEach((entity,key)=>{if(entity.transformNode!=null&&entity.transformNode.networkEntitySync!=null&&entity.transformNode.networkEntitySync===true&&entity.transformNodeType!=null){if(entity.transformNodeType===BABYLON.NetworkEntityType.Local){if(entity.transformNode.networkEntityLastPosition==null)entity.transformNode.networkEntityLastPosition=entity.transformNode.position.clone();if(entity.transformNode.position.equalsWithEpsilon(entity.transformNode.networkEntityLastPosition,entity.transformNode.networkEntityEpsilon)===false){entity.transformNode.position.subtractToRef(entity.transformNode.networkEntityLastPosition,entity.transformNode.networkEntityLinearVelocity);entity.transformNode.networkEntityLinearVelocity.x/=deltaTime;entity.transformNode.networkEntityLinearVelocity.y/=deltaTime;entity.transformNode.networkEntityLinearVelocity.z/=deltaTime}else{entity.transformNode.networkEntityLinearVelocity.set(0,0,0)}entity.transformNode.networkEntityLastPosition.copyFrom(entity.transformNode.position);const packet=BABYLON.NetworkManager.CreateNetworkPacketData(entity.transformNode,true);if(transmitPacketBuffer==null)transmitPacketBuffer=[];if(packet!=null)transmitPacketBuffer.push(packet)}else if(entity.transformNodeType===BABYLON.NetworkEntityType.Remote){const buffer=entity.transformNode.networkEntityInterpBuffer;if(buffer!=null){buffer.update(deltaTime*1000);if(entity.transformNode.networkEntityActivated!=null){if(entity.transformNode.networkEntityActivated!==true){entity.transformNode.networkEntityActivated=true;entity.transformNode.position=new BABYLON.Vector3(entity.xPos,entity.yPos,entity.zPos);entity.transformNode.rotationQuaternion=new BABYLON.Quaternion(entity.xRot,entity.yRot,entity.zRot,entity.wRot);entity.transformNode.setEnabled(true);console.warn(">>> Activating Remote Entity: "+entity.transformNode.name)}else{BABYLON.NetworkManager.UpdateRemoteEntity(buffer,entity,entity.transformNode,deltaTime)}}}}}});if(transmitPacketBuffer!=null&&transmitPacketBuffer.length>0){BABYLON.NetworkManager.SendDataPacketToServer(transmitPacketBuffer)}}}static SendDataPacketToServer(transmitPacketBuffer){const dataPacket={entities:transmitPacketBuffer};if(BABYLON.NetworkManager.DefaultRoom!=null){BABYLON.NetworkManager.DefaultRoom.send("packetUpdate",dataPacket)}}static UpdateRemoteEntity(buffer,entity,transform,deltaTime){if(entity==null||transform==null)return;const interpolationMode=transform.networkEntityInterpolate;if(interpolationMode===BABYLON.EntityInterpolation.Custom){if(transform.networkEntityHandler!=null){transform.networkEntityHandler(entity,transform,deltaTime)}}else{if(buffer.state===BufferState.PLAYING){transform.position.copyFrom(buffer.position);transform.rotationQuaternion.copyFrom(buffer.quaternion);transform.scaling.copyFrom(buffer.scale)}}if(transform.networkEntityAttributeBuffer==null)transform.networkEntityAttributeBuffer={};transform.networkEntityAttributeBuffer["0"]=entity.aux00;transform.networkEntityAttributeBuffer["1"]=entity.aux01;transform.networkEntityAttributeBuffer["2"]=entity.aux02;transform.networkEntityAttributeBuffer["3"]=entity.aux03;transform.networkEntityAttributeBuffer["4"]=entity.aux04;transform.networkEntityAttributeBuffer["5"]=entity.aux05;transform.networkEntityAttributeBuffer["6"]=entity.aux06;transform.networkEntityAttributeBuffer["7"]=entity.aux07;transform.networkEntityAttributeBuffer["8"]=entity.aux08;transform.networkEntityAttributeBuffer["9"]=entity.aux09;transform.networkEntityAttributeBuffer["10"]=entity.aux10;transform.networkEntityAttributeBuffer["11"]=entity.aux11;transform.networkEntityAttributeBuffer["12"]=entity.aux12;transform.networkEntityAttributeBuffer["13"]=entity.aux13;transform.networkEntityAttributeBuffer["14"]=entity.aux14;transform.networkEntityAttributeBuffer["15"]=entity.aux15;transform.networkEntityAttributeBuffer["16"]=entity.aux16;transform.networkEntityAttributeBuffer["17"]=entity.aux17;transform.networkEntityAttributeBuffer["18"]=entity.aux18;transform.networkEntityAttributeBuffer["19"]=entity.aux19}static CreateNetworkPacketData(localTransform,postAttributes=true){let result=null;const networkEntity=localTransform.networkEntity;if(networkEntity!=null){if(localTransform.networkEntityMovement!=null&&localTransform.networkEntityMovement===BABYLON.EntityMovementType.ClientAuthority){TOOLKIT.Utilities.GetAbsolutePositionToRef(localTransform,BABYLON.NetworkManager.SendPositionBuffer);TOOLKIT.Utilities.GetAbsoluteRotationToRef(localTransform,BABYLON.NetworkManager.SendRotationBuffer);if(localTransform.networkEntityLinearVelocity!=null)BABYLON.NetworkManager.SendLinearBuffer.copyFrom(localTransform.networkEntityLinearVelocity);else BABYLON.NetworkManager.SendLinearBuffer.set(0,0,0);if(localTransform.networkEntityAngularVelocity!=null)BABYLON.NetworkManager.SendAngularBuffer.copyFrom(localTransform.networkEntityAngularVelocity);else BABYLON.NetworkManager.SendAngularBuffer.set(0,0,0);let a00=0;let a01=0;let a02=0;let a03=0;let a04=0;let a05=0;let a06=0;let a07=0;let a08=0;let a09=0;let a10=0;let a11=0;let a12=0;let a13=0;let a14=0;let a15=0;let a16=0;let a17=0;let a18=0;let a19=0;if(postAttributes===true&&localTransform.networkEntityBatch!=null){if(localTransform.networkEntityBatch["0"]!=null){a00=localTransform.networkEntityBatch["0"]}if(localTransform.networkEntityBatch["1"]!=null){a01=localTransform.networkEntityBatch["1"]}if(localTransform.networkEntityBatch["2"]!=null){a02=localTransform.networkEntityBatch["2"]}if(localTransform.networkEntityBatch["3"]!=null){a03=localTransform.networkEntityBatch["3"]}if(localTransform.networkEntityBatch["4"]!=null){a04=localTransform.networkEntityBatch["4"]}if(localTransform.networkEntityBatch["5"]!=null){a05=localTransform.networkEntityBatch["5"]}if(localTransform.networkEntityBatch["6"]!=null){a06=localTransform.networkEntityBatch["6"]}if(localTransform.networkEntityBatch["7"]!=null){a07=localTransform.networkEntityBatch["7"]}if(localTransform.networkEntityBatch["8"]!=null){a08=localTransform.networkEntityBatch["8"]}if(localTransform.networkEntityBatch["9"]!=null){a09=localTransform.networkEntityBatch["9"]}if(localTransform.networkEntityBatch["10"]!=null){a10=localTransform.networkEntityBatch["10"]}if(localTransform.networkEntityBatch["11"]!=null){a11=localTransform.networkEntityBatch["11"]}if(localTransform.networkEntityBatch["12"]!=null){a12=localTransform.networkEntityBatch["12"]}if(localTransform.networkEntityBatch["13"]!=null){a13=localTransform.networkEntityBatch["13"]}if(localTransform.networkEntityBatch["14"]!=null){a14=localTransform.networkEntityBatch["14"]}if(localTransform.networkEntityBatch["15"]!=null){a15=localTransform.networkEntityBatch["15"]}if(localTransform.networkEntityBatch["16"]!=null){a16=localTransform.networkEntityBatch["16"]}if(localTransform.networkEntityBatch["17"]!=null){a17=localTransform.networkEntityBatch["17"]}if(localTransform.networkEntityBatch["18"]!=null){a18=localTransform.networkEntityBatch["18"]}if(localTransform.networkEntityBatch["19"]!=null){a19=localTransform.networkEntityBatch["19"]}}const packet={};packet.id=networkEntity.id;packet.xPos=BABYLON.NetworkManager.SendPositionBuffer.x;packet.yPos=BABYLON.NetworkManager.SendPositionBuffer.y;packet.zPos=BABYLON.NetworkManager.SendPositionBuffer.z;packet.xRot=BABYLON.NetworkManager.SendRotationBuffer.x;packet.yRot=BABYLON.NetworkManager.SendRotationBuffer.y;packet.zRot=BABYLON.NetworkManager.SendRotationBuffer.z;packet.wRot=BABYLON.NetworkManager.SendRotationBuffer.w;packet.xVel=BABYLON.NetworkManager.SendLinearBuffer.x;packet.yVel=BABYLON.NetworkManager.SendLinearBuffer.y;packet.zVel=BABYLON.NetworkManager.SendLinearBuffer.z;packet.xAng=BABYLON.NetworkManager.SendAngularBuffer.x;packet.yAng=BABYLON.NetworkManager.SendAngularBuffer.y;packet.zAng=BABYLON.NetworkManager.SendAngularBuffer.z;packet.a00=a00;packet.a01=a01;packet.a02=a02;packet.a03=a03;packet.a04=a04;packet.a05=a05;packet.a06=a06;packet.a07=a07;packet.a08=a08;packet.a09=a09;packet.a10=a10;packet.a11=a11;packet.a12=a12;packet.a13=a13;packet.a14=a14;packet.a15=a15;packet.a16=a16;packet.a17=a17;packet.a18=a18;packet.a19=a19;packet.speed=BABYLON.NetworkManager.SendLinearBuffer.length();result=packet}}return result}static JoinDefaultRoomHandler(info){BABYLON.NetworkManager.UserReference=info.user;BABYLON.NetworkManager.NetworkServerTime=info.serverTime;BABYLON.NetworkManager.InterpolationBuffer=info.interpolationBuffer;if(BABYLON.NetworkManager.HasJoinedRoom()){BABYLON.Tools.Warn("TCP: You are connected to the default room channel")}}static AddNetworkEntityHandler(entity,key){if(BABYLON.NetworkManager.HasJoinedRoom()){if(BABYLON.NetworkManager.NetworkEntityQueue!=null){BABYLON.NetworkManager.NetworkEntityQueue.forEach((vx,kx)=>{BABYLON.NetworkManager.ProcessNetworkEntityHandler(vx,kx)});BABYLON.NetworkManager.NetworkEntityQueue.clear();BABYLON.NetworkManager.NetworkEntityQueue=null}BABYLON.NetworkManager.ProcessNetworkEntityHandler(entity,key)}else{if(BABYLON.NetworkManager.NetworkEntityQueue==null)BABYLON.NetworkManager.NetworkEntityQueue=new Map;BABYLON.NetworkManager.NetworkEntityQueue.set(key,entity)}}static ProcessNetworkEntityHandler(entity,key){const aentity=entity;const sceneRef=BABYLON.NetworkManager.SceneReference;const remotePrefab=entity.attributes.get("remotePrefab");const assetContainer=entity.attributes.get("assetContainer");const customHandler=entity.attributes.get("customHandler");const movementEpsilon=entity.attributes.get("movementEpsilon");const movementType=entity.attributes.get("movementType");const interoplation=entity.attributes.get("interoplation");const bufferedAttribs=entity.attributes.get("bufferedAttribs");const syncTransform=entity.attributes.get("syncTransform");const playerAvatar=entity.attributes.get("playerAvatar");const isLocalEntity=(entity.ownerId===BABYLON.NetworkManager.UserReference.id);if(isLocalEntity===false){aentity.onChange(changes=>{BABYLON.NetworkManager.ProcessRemoteEntityChanges(entity,changes)})}let sourceName=entity.attributes.get("sourceName");if(sourceName==null||sourceName==="")sourceName="Unknown";let transformNode=null;let transformNodeName=(sourceName+"."+entity.ownerId);let transformNodeType=(isLocalEntity===true)?BABYLON.NetworkEntityType.Local:BABYLON.NetworkEntityType.Remote;if(BABYLON.NetworkManager.RootNode==null){BABYLON.NetworkManager.RootNode=new BABYLON.TransformNode("Network Entities",sceneRef);BABYLON.NetworkManager.RootNode.position.set(0,0,0)}if(isLocalEntity===false){const initialPosition=new BABYLON.Vector3(0,0,0);const initialRotation=new BABYLON.Quaternion(0,0,0,1);if(remotePrefab!=null&&remotePrefab!==""){if(assetContainer!=null&&assetContainer!==""){const contaier=TOOLKIT.SceneManager.GetAssetContainer(sceneRef,assetContainer);if(contaier!=null){transformNode=TOOLKIT.SceneManager.InstantiatePrefabFromContainer(contaier,remotePrefab,transformNodeName,BABYLON.NetworkManager.RootNode,initialPosition,initialRotation);if(transformNode==null)BABYLON.Tools.Warn("Failed to instaniate '"+remotePrefab+"' from asset container '"+assetContainer+"'.")}else{BABYLON.Tools.Warn("Asset container '"+assetContainer+"' not registered on the scene.")}}else{transformNode=TOOLKIT.SceneManager.InstantiatePrefabFromScene(sceneRef,remotePrefab,transformNodeName,BABYLON.NetworkManager.RootNode,initialPosition,initialRotation);if(transformNode==null)BABYLON.Tools.Warn("Failed to instaniate '"+remotePrefab+"' from current scene.")}}if(transformNode==null){transformNode=new BABYLON.TransformNode(transformNodeName,sceneRef);transformNode.parent=BABYLON.NetworkManager.RootNode;transformNode.position=initialPosition.clone();transformNode.rotationQuaternion=initialRotation.clone()}transformNode.name=transformNodeName;transformNode.setEnabled(false);if(transformNode!=null){if(playerAvatar!=null&&playerAvatar!==""){const skins=transformNode.getChildMeshes(false,node=>{return(node.skeleton!=null)});if(skins!=null&&skins.length>0){skins.forEach(skin=>{const stag=TOOLKIT.SceneManager.GetTransformTag(skin);if(stag!=null&&stag==="Armature"||skin.name.toLowerCase().endsWith(".skin")){skin.isVisible=false}})}}}}else{transformNode=TOOLKIT.SceneManager.GetTransformNodeByID(sceneRef,entity.creationId);if(transformNode==null)BABYLON.Tools.Warn("Failed to locate local entity transform '"+entity.creationId+"' in current scene.")}let customHandlerFunc=null;if(customHandler!=null&&customHandler!==""){customHandlerFunc=BABYLON.NetworkManager.CustomHandlerMap.get(customHandler);if(customHandlerFunc==null)BABYLON.Tools.Warn("Custom interoplation handler not found: "+customHandler+". Default interpolation will be used instead.")}if(transformNode!=null){aentity.transformNode=transformNode;aentity.transformNodeType=transformNodeType;aentity.transformNode.networkEntity=entity;aentity.transformNode.networkEntityType=transformNodeType;aentity.transformNode.networkEntitySync=(syncTransform!=null&&syncTransform==="true");aentity.transformNode.networkEntityBatch=null;aentity.transformNode.networkEntityHandler=customHandlerFunc;aentity.transformNode.networkEntityEpsilon=(movementEpsilon!=null&&movementEpsilon!=="")?parseFloat(movementEpsilon):0.00001;aentity.transformNode.networkEntityMovement=(movementType!=null&&movementType!=="")?parseFloat(movementType):0;aentity.transformNode.networkEntityInterpolate=(interoplation!=null&&interoplation!=="")?parseFloat(interoplation):0;aentity.transformNode.networkEntityActivated=false;aentity.transformNode.networkEntityLastPosition=null;aentity.transformNode.networkEntityLinearVelocity=new BABYLON.Vector3(0,0,0);aentity.transformNode.networkEntityNetworkPosition=new BABYLON.Vector3(0,0,0);aentity.transformNode.networkEntityNetworkRotation=new BABYLON.Quaternion(0,0,0,1);aentity.transformNode.networkEntityNetworkVelocity=new BABYLON.Vector3(0,0,0);aentity.transformNode.networkEntityNetworkScaling=new BABYLON.Vector3(0,0,0);aentity.transformNode.networkEntityAttributeBuffer=null;aentity.transformNode.networkEntityInterpBuffer=null;aentity.transformNode.networkEntityPlayerAvatar=playerAvatar;if(transformNodeType==BABYLON.NetworkEntityType.Remote){const interpolationMode=aentity.transformNode.networkEntityInterpolate;if(interpolationMode!==BABYLON.EntityInterpolation.Custom){const bufferAttribs=(bufferedAttribs!=null&&bufferedAttribs!=="")?JSON.parse(bufferedAttribs):null;aentity.transformNode.networkEntityInterpBuffer=new InterpolationBuffer(interpolationMode,BABYLON.NetworkManager.InterpolationBuffer,bufferAttribs)}}else if(transformNodeType==BABYLON.NetworkEntityType.Local){}}else{aentity.transformNode=null;aentity.transformNodeType=BABYLON.NetworkEntityType.None}BABYLON.NetworkManager.OnCreateEntityObservable.notifyObservers(entity)}static ProcessRemoteEntityChanges(entity,changes){if(entity!=null&&entity.transformNode!=null&&entity.transformNode.networkEntitySync!=null&&entity.transformNode.networkEntitySync===true&&entity.transformNodeType!=null){if(entity.transformNodeType===BABYLON.NetworkEntityType.Remote){entity.transformNode.networkEntityNetworkPosition.set(entity.xPos,entity.yPos,entity.zPos);entity.transformNode.networkEntityNetworkRotation.set(entity.xRot,entity.yRot,entity.zRot,entity.wRot);entity.transformNode.networkEntityNetworkVelocity.set(entity.xVel,entity.yVel,entity.zVel);entity.transformNode.networkEntityNetworkScaling.set(1.0,1.0,1.0);if(entity.transformNode.networkEntityInterpBuffer!=null){const position=entity.transformNode.networkEntityNetworkPosition;const rotation=entity.transformNode.networkEntityNetworkRotation;const velocity=entity.transformNode.networkEntityNetworkVelocity;const scaling=entity.transformNode.networkEntityNetworkScaling;entity.transformNode.networkEntityInterpBuffer.appendBuffer(position,velocity,rotation,scaling)}}}}static RemoveNetworkEntityHandler(entity,key){const aentity=entity;if(aentity.transformNode!=null&&aentity.transformNodeType!=null&&aentity.transformNodeType===BABYLON.NetworkEntityType.Remote){if(aentity.transformNode.dispose)aentity.transformNode.dispose();aentity.transformNode=null;BABYLON.NetworkManager.OnRemoveEntityObservable.notifyObservers(entity)}}}BABYLON.NetworkManager=NetworkManager;class RoomController{static SendPing(room){room.send("ping")}static SendChat(room,message){room.send("sendChat",{sessionId:"*",name:"*",message:message,timestamp:-1})}static CallCustomMethod(room,method,...args){room.send("customMethod",{method:method,param:args})}static SetUserAttributes(room,userId,attributesToSet){room.send("setAttribute",{entityId:null,userId:userId,attributesToSet:attributesToSet})}static SetEntityAttributes(room,entityId,attributesToSet){room.send("setAttribute",{entityId:entityId,userId:null,attributesToSet:attributesToSet})}static CreateNetworkEntity(room,ownerName,localTransform,remotePrefab=null,assetContainer=null,movementEpsilon=0.00001,movementType=BABYLON.EntityMovementType.ClientAuthority,interpolationMode=BABYLON.EntityInterpolation.Default,autoSyncTransform=true,customHandlerName=null,bufferedAttributes,createAttributes=null){const entityAttributes=(createAttributes!=null)?createAttributes:{};const entityPosition=localTransform.position;const entityRotation=(localTransform.rotationQuaternion!=null)?localTransform.rotationQuaternion:BABYLON.Quaternion.FromEulerVector(localTransform.rotation);entityAttributes["ownerName"]=ownerName;entityAttributes["sourceName"]=(localTransform.name!=null)?localTransform.name:localTransform.id;entityAttributes["creationPos"]=[entityPosition.x,entityPosition.y,entityPosition.z];entityAttributes["creationRot"]=[entityRotation.x,entityRotation.y,entityRotation.z,entityRotation.w];entityAttributes["remotePrefab"]=remotePrefab;entityAttributes["assetContainer"]=assetContainer;entityAttributes["customHandler"]=customHandlerName;entityAttributes["movementEpsilon"]=movementEpsilon.toString();entityAttributes["movementType"]=movementType.toString();entityAttributes["interoplation"]=interpolationMode.toString();entityAttributes["syncTransform"]=autoSyncTransform.toString().toLowerCase();entityAttributes["bufferedAttribs"]=(bufferedAttributes!=null)?JSON.stringify(bufferedAttributes):null;room.send("createEntity",{creationId:localTransform.id,attributes:entityAttributes})}static RemoveNetworkEntity(room,entityId){room.send("removeEntity",entityId)}static ExecuteRemoteFunctionCall(room,target,entityId,func,...args){room.send("remoteFunctionCall",{entityId:entityId,function:func,param:args,target:target})}}BABYLON.RoomController=RoomController;let BufferState;(function(BufferState){BufferState[BufferState["INITIALIZING"]=0]="INITIALIZING";BufferState[BufferState["BUFFERING"]=1]="BUFFERING";BufferState[BufferState["PLAYING"]=2]="PLAYING"})(BufferState=BABYLON.BufferState||(BABYLON.BufferState={}));let BufferMode;(function(BufferMode){BufferMode[BufferMode["MODE_LERP"]=0]="MODE_LERP";BufferMode[BufferMode["MODE_HERMITE"]=1]="MODE_HERMITE"})(BufferMode=BABYLON.BufferMode||(BABYLON.BufferMode={}));const framePool=[];const getPooledFrame=()=>{let frame=framePool.pop();if(!frame){frame={position:new BABYLON.Vector3,velocity:new BABYLON.Vector3,scale:new BABYLON.Vector3(1,1,1),quaternion:new BABYLON.Quaternion,aux00:0,aux01:0,aux02:0,aux03:0,aux04:0,aux05:0,aux06:0,aux07:0,aux08:0,aux09:0,aux10:0,aux11:0,aux12:0,aux13:0,aux14:0,aux15:0,aux16:0,aux17:0,aux18:0,aux19:0,speed:0,time:0}}return frame};const freeFrame=f=>framePool.push(f);class InterpolationBuffer{state;mode;buffer;originFrame;position;scale;quaternion;aux00;aux01;aux02;aux03;aux04;aux05;aux06;aux07;aux08;aux09;aux10;aux11;aux12;aux13;aux14;aux15;aux16;aux17;aux18;aux19;speed;time;bufferTime;bufferAttribs;getPosition(){return this.position}getQuaternion(){return this.quaternion}getScale(){return this.scale}constructor(mode=BufferMode.MODE_LERP,bufferTime=0.15,bufferAttribs=null){this.state=BufferState.INITIALIZING;this.buffer=[];this.bufferTime=bufferTime*1000;this.bufferAttribs=bufferAttribs;this.time=0;this.mode=mode;this.originFrame=getPooledFrame();this.position=new BABYLON.Vector3;this.quaternion=new BABYLON.Quaternion;this.scale=new BABYLON.Vector3(1,1,1);this.aux00=0;this.aux01=0;this.aux02=0;this.aux03=0;this.aux04=0;this.aux05=0;this.aux06=0;this.aux07=0;this.aux08=0;this.aux09=0;this.aux10=0;this.aux11=0;this.aux12=0;this.aux13=0;this.aux14=0;this.aux15=0;this.aux16=0;this.aux17=0;this.aux18=0;this.aux19=0;this.speed=0}hermiteToolkit(target,t,p1,p2,v1,v2){TOOLKIT.Utilities.HermiteVector3ToRef(p1,v1,p2,v2,t,target)}hermiteBabylon(target,t,p1,p2,v1,v2){const pos=BABYLON.Vector3.Hermite(p1,v1,p2,v2,t);target.copyFrom(pos)}hermiteLegacy(target,t,p1,p2,v1,v2){const t2=t*t;const t3=t*t*t;const a=2*t3-3*t2+1;const b=-2*t3+3*t2;const c=t3-2*t2+t;const d=t3-t2;target.copyFrom(p1.scaleInPlace(a));target.add(p2.scaleInPlace(b));target.add(v1.scaleInPlace(c));target.add(v2.scaleInPlace(d))}lerp(target,v1,v2,alpha){BABYLON.Vector3.LerpToRef(v1,v2,alpha,target)}slerp(target,r1,r2,alpha){BABYLON.Quaternion.SlerpToRef(r1,r2,alpha,target)}updateOriginFrameToBufferTail(){freeFrame(this.originFrame);this.originFrame=this.buffer.shift()||getPooledFrame()}appendBuffer(position,velocity,quaternion,scale,aux00=0,aux01=0,aux02=0,aux03=0,aux04=0,aux05=0,aux06=0,aux07=0,aux08=0,aux09=0,aux10=0,aux11=0,aux12=0,aux13=0,aux14=0,aux15=0,aux16=0,aux17=0,aux18=0,aux19=0,speed=0){const tail=this.buffer.length>0?this.buffer[this.buffer.length-1]:null;if(tail&&tail.time===this.time){if(position)tail.position.copyFrom(position);if(velocity)tail.velocity.copyFrom(velocity);if(quaternion)tail.quaternion.copyFrom(quaternion);if(scale)tail.scale.copyFrom(scale);tail.aux00=aux00;tail.aux01=aux01;tail.aux02=aux02;tail.aux03=aux03;tail.aux04=aux04;tail.aux05=aux05;tail.aux06=aux06;tail.aux07=aux07;tail.aux08=aux08;tail.aux09=aux09;tail.aux10=aux10;tail.aux11=aux11;tail.aux12=aux12;tail.aux13=aux13;tail.aux14=aux14;tail.aux15=aux15;tail.aux16=aux16;tail.aux17=aux17;tail.aux18=aux18;tail.aux19=aux19;tail.speed=speed}else{const priorFrame=tail||this.originFrame;const newFrame=getPooledFrame();newFrame.position.copyFrom(position||priorFrame.position);newFrame.velocity.copyFrom(velocity||priorFrame.velocity);newFrame.quaternion.copyFrom(quaternion||priorFrame.quaternion);newFrame.scale.copyFrom(scale||priorFrame.scale);newFrame.aux00=aux00;newFrame.aux01=aux01;newFrame.aux02=aux02;newFrame.aux03=aux03;newFrame.aux04=aux04;newFrame.aux05=aux05;newFrame.aux06=aux06;newFrame.aux07=aux07;newFrame.aux08=aux08;newFrame.aux09=aux09;newFrame.aux10=aux10;newFrame.aux11=aux11;newFrame.aux12=aux12;newFrame.aux13=aux13;newFrame.aux14=aux14;newFrame.aux15=aux15;newFrame.aux16=aux16;newFrame.aux17=aux17;newFrame.aux18=aux18;newFrame.aux19=aux19;newFrame.speed=speed;newFrame.time=this.time;this.buffer.push(newFrame)}}update(delta){if(this.state===BufferState.INITIALIZING){if(this.buffer.length>0){this.updateOriginFrameToBufferTail();this.position.copyFrom(this.originFrame.position);this.quaternion.copyFrom(this.originFrame.quaternion);this.scale.copyFrom(this.originFrame.scale);this.aux00=this.originFrame.aux00;this.aux01=this.originFrame.aux01;this.aux02=this.originFrame.aux02;this.aux03=this.originFrame.aux03;this.aux04=this.originFrame.aux04;this.aux05=this.originFrame.aux05;this.aux06=this.originFrame.aux06;this.aux07=this.originFrame.aux07;this.aux08=this.originFrame.aux08;this.aux09=this.originFrame.aux09;this.aux10=this.originFrame.aux10;this.aux11=this.originFrame.aux11;this.aux12=this.originFrame.aux12;this.aux13=this.originFrame.aux13;this.aux14=this.originFrame.aux14;this.aux15=this.originFrame.aux15;this.aux16=this.originFrame.aux16;this.aux17=this.originFrame.aux17;this.aux18=this.originFrame.aux18;this.aux19=this.originFrame.aux19;this.speed=this.originFrame.speed;this.state=BufferState.BUFFERING}}if(this.state===BufferState.BUFFERING){if(this.buffer.length>0&&this.time>this.bufferTime){this.state=BufferState.PLAYING}}if(this.state===BufferState.PLAYING){const mark=this.time-this.bufferTime;while(this.buffer.length>0&&mark>this.buffer[0].time){if(this.buffer.length>1){this.updateOriginFrameToBufferTail()}else{this.originFrame.position.copyFrom(this.buffer[0].position);this.originFrame.velocity.copyFrom(this.buffer[0].velocity);this.originFrame.quaternion.copyFrom(this.buffer[0].quaternion);this.originFrame.scale.copyFrom(this.buffer[0].scale);this.originFrame.aux00=this.buffer[0].aux00;this.originFrame.aux01=this.buffer[0].aux01;this.originFrame.aux02=this.buffer[0].aux02;this.originFrame.aux03=this.buffer[0].aux03;this.originFrame.aux04=this.buffer[0].aux04;this.originFrame.aux05=this.buffer[0].aux05;this.originFrame.aux06=this.buffer[0].aux06;this.originFrame.aux07=this.buffer[0].aux07;this.originFrame.aux08=this.buffer[0].aux08;this.originFrame.aux09=this.buffer[0].aux09;this.originFrame.aux10=this.buffer[0].aux10;this.originFrame.aux11=this.buffer[0].aux11;this.originFrame.aux12=this.buffer[0].aux12;this.originFrame.aux13=this.buffer[0].aux13;this.originFrame.aux14=this.buffer[0].aux14;this.originFrame.aux15=this.buffer[0].aux15;this.originFrame.aux16=this.buffer[0].aux16;this.originFrame.aux17=this.buffer[0].aux17;this.originFrame.aux18=this.buffer[0].aux18;this.originFrame.aux19=this.buffer[0].aux19;this.originFrame.speed=this.buffer[0].speed;this.originFrame.time=this.buffer[0].time;this.buffer[0].time=this.time+delta}}if(this.buffer.length>0&&this.buffer[0].time>0){const targetFrame=this.buffer[0];const delta_time=targetFrame.time-this.originFrame.time;const alpha=(mark-this.originFrame.time)/delta_time;if(this.mode===BufferMode.MODE_LERP){this.lerp(this.position,this.originFrame.position,targetFrame.position,alpha)}else if(this.mode===BufferMode.MODE_HERMITE){this.hermiteLegacy(this.position,alpha,this.originFrame.position,targetFrame.position,this.originFrame.velocity.scaleInPlace(delta_time),targetFrame.velocity.scaleInPlace(delta_time))}this.slerp(this.quaternion,this.originFrame.quaternion,targetFrame.quaternion,alpha);this.lerp(this.scale,this.originFrame.scale,targetFrame.scale,alpha);this.speed=BABYLON.Scalar.Lerp(this.originFrame.speed,targetFrame.speed,alpha);this.aux00=targetFrame.aux00;this.aux01=targetFrame.aux01;this.aux02=targetFrame.aux02;this.aux03=targetFrame.aux03;this.aux04=targetFrame.aux04;this.aux05=targetFrame.aux05;this.aux06=targetFrame.aux06;this.aux07=targetFrame.aux07;this.aux08=targetFrame.aux08;this.aux09=targetFrame.aux09;this.aux10=targetFrame.aux10;this.aux11=targetFrame.aux11;this.aux12=targetFrame.aux12;this.aux13=targetFrame.aux13;this.aux14=targetFrame.aux14;this.aux15=targetFrame.aux15;this.aux16=targetFrame.aux16;this.aux17=targetFrame.aux17;this.aux18=targetFrame.aux18;this.aux19=targetFrame.aux19;if(this.bufferAttribs!=null){if(this.bufferAttribs.interpolateBuffer00===1)this.aux00=BABYLON.Scalar.Lerp(this.originFrame.aux00,targetFrame.aux00,alpha);else if(this.bufferAttribs.interpolateBuffer00===2)this.aux00=BABYLON.Scalar.LerpAngle(this.originFrame.aux00,targetFrame.aux00,alpha);if(this.bufferAttribs.interpolateBuffer01===1)this.aux01=BABYLON.Scalar.Lerp(this.originFrame.aux01,targetFrame.aux01,alpha);else if(this.bufferAttribs.interpolateBuffer01===2)this.aux01=BABYLON.Scalar.LerpAngle(this.originFrame.aux01,targetFrame.aux01,alpha);if(this.bufferAttribs.interpolateBuffer02===1)this.aux02=BABYLON.Scalar.Lerp(this.originFrame.aux02,targetFrame.aux02,alpha);else if(this.bufferAttribs.interpolateBuffer02===2)this.aux02=BABYLON.Scalar.LerpAngle(this.originFrame.aux02,targetFrame.aux02,alpha);if(this.bufferAttribs.interpolateBuffer03===1)this.aux03=BABYLON.Scalar.Lerp(this.originFrame.aux03,targetFrame.aux03,alpha);else if(this.bufferAttribs.interpolateBuffer03===2)this.aux03=BABYLON.Scalar.LerpAngle(this.originFrame.aux03,targetFrame.aux03,alpha);if(this.bufferAttribs.interpolateBuffer04===1)this.aux04=BABYLON.Scalar.Lerp(this.originFrame.aux04,targetFrame.aux04,alpha);else if(this.bufferAttribs.interpolateBuffer04===2)this.aux04=BABYLON.Scalar.LerpAngle(this.originFrame.aux04,targetFrame.aux04,alpha);if(this.bufferAttribs.interpolateBuffer05===1)this.aux05=BABYLON.Scalar.Lerp(this.originFrame.aux05,targetFrame.aux05,alpha);else if(this.bufferAttribs.interpolateBuffer05===2)this.aux05=BABYLON.Scalar.LerpAngle(this.originFrame.aux05,targetFrame.aux05,alpha);if(this.bufferAttribs.interpolateBuffer06===1)this.aux06=BABYLON.Scalar.Lerp(this.originFrame.aux06,targetFrame.aux06,alpha);else if(this.bufferAttribs.interpolateBuffer06===2)this.aux06=BABYLON.Scalar.LerpAngle(this.originFrame.aux06,targetFrame.aux06,alpha);if(this.bufferAttribs.interpolateBuffer07===1)this.aux07=BABYLON.Scalar.Lerp(this.originFrame.aux07,targetFrame.aux07,alpha);else if(this.bufferAttribs.interpolateBuffer07===2)this.aux07=BABYLON.Scalar.LerpAngle(this.originFrame.aux07,targetFrame.aux07,alpha);if(this.bufferAttribs.interpolateBuffer08===1)this.aux08=BABYLON.Scalar.Lerp(this.originFrame.aux08,targetFrame.aux08,alpha);else if(this.bufferAttribs.interpolateBuffer08===2)this.aux08=BABYLON.Scalar.LerpAngle(this.originFrame.aux08,targetFrame.aux08,alpha);if(this.bufferAttribs.interpolateBuffer09===1)this.aux09=BABYLON.Scalar.Lerp(this.originFrame.aux09,targetFrame.aux09,alpha);else if(this.bufferAttribs.interpolateBuffer09===2)this.aux09=BABYLON.Scalar.LerpAngle(this.originFrame.aux09,targetFrame.aux09,alpha);if(this.bufferAttribs.interpolateBuffer10===1)this.aux10=BABYLON.Scalar.Lerp(this.originFrame.aux10,targetFrame.aux10,alpha);else if(this.bufferAttribs.interpolateBuffer10===2)this.aux10=BABYLON.Scalar.LerpAngle(this.originFrame.aux10,targetFrame.aux10,alpha);if(this.bufferAttribs.interpolateBuffer11===1)this.aux11=BABYLON.Scalar.Lerp(this.originFrame.aux11,targetFrame.aux11,alpha);else if(this.bufferAttribs.interpolateBuffer11===2)this.aux11=BABYLON.Scalar.LerpAngle(this.originFrame.aux11,targetFrame.aux11,alpha);if(this.bufferAttribs.interpolateBuffer12===1)this.aux12=BABYLON.Scalar.Lerp(this.originFrame.aux12,targetFrame.aux12,alpha);else if(this.bufferAttribs.interpolateBuffer12===2)this.aux12=BABYLON.Scalar.LerpAngle(this.originFrame.aux12,targetFrame.aux12,alpha);if(this.bufferAttribs.interpolateBuffer13===1)this.aux13=BABYLON.Scalar.Lerp(this.originFrame.aux13,targetFrame.aux13,alpha);else if(this.bufferAttribs.interpolateBuffer13===2)this.aux13=BABYLON.Scalar.LerpAngle(this.originFrame.aux13,targetFrame.aux13,alpha);if(this.bufferAttribs.interpolateBuffer14===1)this.aux14=BABYLON.Scalar.Lerp(this.originFrame.aux14,targetFrame.aux14,alpha);else if(this.bufferAttribs.interpolateBuffer14===2)this.aux14=BABYLON.Scalar.LerpAngle(this.originFrame.aux14,targetFrame.aux14,alpha);if(this.bufferAttribs.interpolateBuffer15===1)this.aux15=BABYLON.Scalar.Lerp(this.originFrame.aux15,targetFrame.aux15,alpha);else if(this.bufferAttribs.interpolateBuffer15===2)this.aux15=BABYLON.Scalar.LerpAngle(this.originFrame.aux15,targetFrame.aux15,alpha);if(this.bufferAttribs.interpolateBuffer16===1)this.aux16=BABYLON.Scalar.Lerp(this.originFrame.aux16,targetFrame.aux16,alpha);else if(this.bufferAttribs.interpolateBuffer16===2)this.aux16=BABYLON.Scalar.LerpAngle(this.originFrame.aux16,targetFrame.aux16,alpha);if(this.bufferAttribs.interpolateBuffer17===1)this.aux17=BABYLON.Scalar.Lerp(this.originFrame.aux17,targetFrame.aux17,alpha);else if(this.bufferAttribs.interpolateBuffer17===2)this.aux17=BABYLON.Scalar.LerpAngle(this.originFrame.aux17,targetFrame.aux17,alpha);if(this.bufferAttribs.interpolateBuffer18===1)this.aux18=BABYLON.Scalar.Lerp(this.originFrame.aux18,targetFrame.aux18,alpha);else if(this.bufferAttribs.interpolateBuffer18===2)this.aux18=BABYLON.Scalar.LerpAngle(this.originFrame.aux18,targetFrame.aux18,alpha);if(this.bufferAttribs.interpolateBuffer19===1)this.aux19=BABYLON.Scalar.Lerp(this.originFrame.aux19,targetFrame.aux19,alpha);else if(this.bufferAttribs.interpolateBuffer19===2)this.aux19=BABYLON.Scalar.LerpAngle(this.originFrame.aux19,targetFrame.aux19,alpha)}}}if(this.state!==BufferState.INITIALIZING){this.time+=delta}}}BABYLON.InterpolationBuffer=InterpolationBuffer})(BABYLON||(BABYLON={}));var PROJECT;(function(PROJECT){class BallSocketJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;pivotA=new BABYLON.Vector3(-0.5,0,-0.5);pivotB=new BABYLON.Vector3(-0.5,0,0.5);axisA=new BABYLON.Vector3(0,1,0);axisB=new BABYLON.Vector3(0,1,0);constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.BallSocketJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.BallAndSocketConstraint(this.pivotA,this.pivotB,this.axisA,this.axisB,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.BallSocketJoint=BallSocketJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.BallSocketJoint",BallSocketJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class DistanceJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;maxDistance=0;constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.DistanceJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.DistanceConstraint(this.maxDistance,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.DistanceJoint=DistanceJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.DistanceJoint",DistanceJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class FixedHingeJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;pivotA=new BABYLON.Vector3(0,0,-0.5);pivotB=new BABYLON.Vector3(0,0,0.5);constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.FixedHingeJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.HingeConstraint(this.pivotA,this.pivotB,undefined,undefined,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.FixedHingeJoint=FixedHingeJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.FixedHingeJoint",FixedHingeJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class LockedJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;pivotA=new BABYLON.Vector3(0.5,0.5,-0.5);pivotB=new BABYLON.Vector3(-0.5,-0.5,0.5);axisA=new BABYLON.Vector3(0,1,0);axisB=new BABYLON.Vector3(0,1,0);constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.LockedJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.LockConstraint(this.pivotA,this.pivotB,this.axisA,this.axisB,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.LockedJoint=LockedJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.LockedJoint",LockedJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class PrismaticJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;pivotA=new BABYLON.Vector3(0,0,-0.2);pivotB=new BABYLON.Vector3(0,0,0.25);axisA=new BABYLON.Vector3(0,1,0);axisB=new BABYLON.Vector3(0,1,0);constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.PrismaticJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.PrismaticConstraint(this.pivotA,this.pivotB,this.axisA,this.axisB,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.PrismaticJoint=PrismaticJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.PrismaticJoint",PrismaticJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SixdofJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;pivotA=new BABYLON.Vector3(0,-0.5,0);pivotB=new BABYLON.Vector3(0,0.5,0);perpAxisA=new BABYLON.Vector3(1,0,0);perpAxisB=new BABYLON.Vector3(1,0,0);axisLimits=null;constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.SixdofJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.Physics6DoFConstraint({pivotA:this.pivotA,pivotB:this.pivotB,perpAxisA:this.perpAxisA,perpAxisB:this.perpAxisB},this.axisLimits,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.SixdofJoint=SixdofJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.SixdofJoint",SixdofJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SliderJoint extends TOOLKIT.ScriptComponent{bodyA=null;bodyB=null;pivotA=new BABYLON.Vector3(0,0,-0.2);pivotB=new BABYLON.Vector3(0,0,0.25);axisA=new BABYLON.Vector3(0,1,0);axisB=new BABYLON.Vector3(0,1,0);constraint=null;collisionsEnabled=false;constructor(transform,scene,properties={},alias="PROJECT.SliderJoint"){super(transform,scene,properties,alias)}awake(){const bodyAInfo=this.getProperty("bodyA");const bodyBInfo=this.getProperty("bodyB");if(bodyAInfo!=null&&bodyBInfo!=null){this.bodyA=(this.transform.name===bodyAInfo.name)?this.transform:this.getChildNode(bodyAInfo.name);this.bodyB=this.getChildNode(bodyBInfo.name);if(this.bodyA!=null&&this.bodyB!=null){if(this.bodyA.physicsBody!=null&&this.bodyB.physicsBody!=null){this.constraint=new BABYLON.SliderConstraint(this.pivotA,this.pivotB,this.axisA,this.axisB,this.scene);this.bodyA.physicsBody.addConstraint(this.bodyB.physicsBody,this.constraint);this.constraint.isCollisionsEnabled=this.collisionsEnabled}}}}destroy(){this.bodyA=null;this.bodyB=null;if(this.constraint!=null){this.constraint.dispose();this.constraint=null}}}PROJECT.SliderJoint=SliderJoint;TOOLKIT.SceneManager.RegisterClass("PROJECT.SliderJoint",SliderJoint)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class RemotePlayerController extends TOOLKIT.ScriptComponent{updateStateParams=true;smoothMotionTime=0;smoothInputVectors=false;animationState=null;animationStateParams=null;constructor(transform,scene,properties={},alias="PROJECT.RemotePlayerController"){super(transform,scene,properties,alias)}awake(){this.updateStateParams=this.getProperty("updateStateParams",this.updateStateParams);this.smoothMotionTime=this.getProperty("smoothMotionTime",this.smoothMotionTime);this.smoothInputVectors=this.getProperty("smoothInputVectors",this.smoothInputVectors);this.animationStateParams=this.getProperty("animationStateParams",this.animationStateParams)}update(){const deltaTime=this.getDeltaSeconds();if(this.animationState==null){this.attachAnimationController()}if(TOOLKIT.EntityController.HasNetworkEntity(this.transform)){const direction=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,0);const magnitude=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,1);const inputX=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,2);const inputZ=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,3);const mouseX=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,4);const mouseY=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,5);const vvelocity=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,6);const movespeed=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,7);const actionstate=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,8);const jumpframe=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,9);const isjumping=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,10);const isfalling=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,11);const issliding=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,12);const isgrounded=TOOLKIT.EntityController.QueryBufferedAttribute(this.transform,13);if(this.animationState!=null&&this.updateStateParams===true){this.validateAnimationStateParams();this.animationState.setInteger(this.animationStateParams.moveDirection,direction);this.animationState.setFloat(this.animationStateParams.heightInput,vvelocity);this.animationState.setBool(this.animationStateParams.jumpFrame,(jumpframe!==0));this.animationState.setBool(this.animationStateParams.jumpState,(isjumping!==0));this.animationState.setInteger(this.animationStateParams.actionState,actionstate);this.animationState.setBool(this.animationStateParams.fallingState,(isfalling!==0));this.animationState.setBool(this.animationStateParams.slidingState,(issliding!==0));this.animationState.setBool(this.animationStateParams.groundedState,(isgrounded!==0));if(this.smoothMotionTime>0){if(this.smoothInputVectors===true){this.animationState.setSmoothFloat(this.animationStateParams.horizontalInput,inputX,(this.smoothMotionTime*deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.verticalInput,inputZ,(this.smoothMotionTime*deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.mouseXInput,mouseX,(this.smoothMotionTime*deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.mouseYInput,mouseY,(this.smoothMotionTime*deltaTime))}else{this.animationState.setFloat(this.animationStateParams.horizontalInput,inputX);this.animationState.setFloat(this.animationStateParams.verticalInput,inputZ);this.animationState.setFloat(this.animationStateParams.mouseXInput,mouseX);this.animationState.setFloat(this.animationStateParams.mouseYInput,mouseY)}this.animationState.setSmoothFloat(this.animationStateParams.inputMagnitude,magnitude,(this.smoothMotionTime*deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.speedInput,movespeed,(this.smoothMotionTime*deltaTime))}else{this.animationState.setFloat(this.animationStateParams.horizontalInput,inputX);this.animationState.setFloat(this.animationStateParams.verticalInput,inputZ);this.animationState.setFloat(this.animationStateParams.mouseXInput,mouseX);this.animationState.setFloat(this.animationStateParams.mouseYInput,mouseY);this.animationState.setFloat(this.animationStateParams.inputMagnitude,magnitude);this.animationState.setFloat(this.animationStateParams.speedInput,movespeed)}}}}destroy(){this.animationState=null;this.animationStateParams=null}attachAnimationController(){if(this.animationState==null){this.animationState=this.getComponent("TOOLKIT.AnimationState");if(this.animationState==null){const animationNode=this.getChildWithScript("TOOLKIT.AnimationState");if(animationNode!=null){this.animationState=TOOLKIT.SceneManager.FindScriptComponent(animationNode,"TOOLKIT.AnimationState")}else{}}}if(this.animationState!=null){this.animationState.onAnimationUpdateObservable.add(()=>{if(this.animationState.ikFrameEnabled()===true){}})}}validateAnimationStateParams(){if(this.animationStateParams==null){this.animationStateParams={moveDirection:"Direction",inputMagnitude:"Magnitude",horizontalInput:"Horizontal",verticalInput:"Vertical",mouseXInput:"MouseX",mouseYInput:"MouseY",heightInput:"Height",speedInput:"Speed",jumpFrame:"Jumped",jumpState:"Jump",actionState:"Action",fallingState:"FreeFall",slidingState:"Sliding",groundedState:"Grounded"}}}}PROJECT.RemotePlayerController=RemotePlayerController;TOOLKIT.SceneManager.RegisterClass("PROJECT.RemotePlayerController",RemotePlayerController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class StandardPlayerController extends TOOLKIT.ScriptComponent{static MIN_VERTICAL_VELOCITY=0.01;static MIN_GROUND_DISTANCE=0.15;static MIN_MOVE_EPSILON=0.001;static MIN_TIMER_OFFSET=0;static MIN_SLOPE_LIMIT=0;static PLAYER_HEIGHT="playerHeight";enableInput=false;attachCamera=false;rotateCamera=true;mouseWheel=true;toggleView=true;freeLooking=false;requireSprintButton=false;gravitationalForce=3.0;minFallVelocity=1.0;verticalStepSpeed=1.0;minStepUpHeight=0.15;rigidBodyMass=85.0;airbornTimeout=0.5;maxAngle=45;speedFactor=1.0;rootMotion=false;moveSpeed=5.335;walkSpeed=2.0;lookSpeed=2.0;jumpSpeed=10.0;jumpDelay=0.25;eyesHeight=1.55;pivotHeight=1.35;maxDistance=5.0;scrollSpeed=25;topLookLimit=60.0;downLookLimit=30.0;lowTurnSpeed=15.0;highTurnSpeed=25.0;smoothMotionTime=0;smoothInputVectors=false;smoothAcceleration=false;accelerationSpeed=0.1;decelerationSpeed=0.1;avatarSkinTag="Skin";climbVolumeTag="Climb";vaultVolumeTag="Vault";maxHeightRanges=null;useClimbSystem=false;distanceFactor=0.85;cameraSmoothing=8;cameraCollisions=true;inputMagnitude=0;landingEpsilon=0.1;minimumDistance=0.5;movementAllowed=true;playerInputX=0;playerInputZ=0;playerMouseX=0;playerMouseY=0;runKeyRequired=true;buttonRun=BABYLON.Xbox360Button.LeftStick;keyboardRun=TOOLKIT.UserInputKey.Shift;buttonJump=BABYLON.Xbox360Button.A;keyboardJump=TOOLKIT.UserInputKey.SpaceBar;buttonCamera=BABYLON.Xbox360Button.Y;keyboardCamera=TOOLKIT.UserInputKey.P;postNetworkAttributes=false;playerNumber=TOOLKIT.PlayerNumber.One;boomPosition=new BABYLON.Vector3(0,0,0);airbornVelocity=new BABYLON.Vector3(0,0,0);movementVelocity=new BABYLON.Vector3(0,0,0);targetCameraOffset=new BABYLON.Vector3(0,0,0);isAnimationEnabled(){return this.updateStateParams}isRunButtonPressed(){return this.isRunPressed}isJumpButtonPressed(){return this.isJumpPressed}getPlayerJumped(){return this.isCharacterJumpFrame}getPlayerJumping(){return this.isCharacterJumping}getPlayerFalling(){return this.isCharacterFalling}getPlayerSliding(){return this.isCharacterSliding}getPlayerGrounded(){return this.isCharacterGrounded}getFallTriggered(){return this.isCharacterFallTriggered}getMovementSpeed(){return this.movementSpeed}getCameraBoomNode(){return this.cameraNode}getCameraTransform(){return this.cameraPivot}getAnimationState(){return this.animationState}getVerticalVelocity(){return this.getCheckedVerticalVelocity()}getCharacterController(){return this.characterController}getPlayerLookRotation(){return this.playerLookRotation}getPlayerMoveDirection(){return this.playerMoveDirection}getInputMovementVector(){return this.inputMovementVector}getInputMagnitudeValue(){return this.inputMagnitude}getCameraPivotPosition(){return(this.cameraPivot!=null)?this.cameraPivot.position:null}getCameraPivotRotation(){return(this.cameraPivot!=null)?this.cameraPivot.rotationQuaternion:null}rayClimbOffset=0.35;rayClimbLength=0.85;getClimbContact(){return this.climbContact}getClimbContactNode(){return this.climbContactNode}getClimbContactPoint(){return this.climbContactPoint}getClimbContactAngle(){return this.climbContactAngle}getClimbContactNormal(){return this.climbContactNormal}getClimbContactDistance(){return this.climbContactDistance}canClimbObstaclePredicate=null;rayHeightOffset=5.0;rayHeightLength=6.0;getHeightContact(){return this.heightContact}getHeightContactNode(){return this.heightContactNode}getHeightContactPoint(){return this.heightContactPoint}getHeightContactAngle(){return this.heightContactAngle}getHeightContactNormal(){return this.heightContactNormal}getHeightContactDistance(){return this.heightContactDistance}abstractMesh=null;cameraDistance=0;forwardCamera=true;avatarRadius=0.5;groundingObject=null;groundingCallback=null;dollyDirection=new BABYLON.Vector3(0,0,0);cameraEulers=new BABYLON.Vector3(0,0,0);rotationEulers=new BABYLON.Vector3(0,0,0);cameraPivotOffset=new BABYLON.Vector3(0,0,0);cameraForwardVector=new BABYLON.Vector3(0,0,0);cameraRightVector=new BABYLON.Vector3(0,0,0);desiredForwardVector=new BABYLON.Vector3(0,0,0);desiredRightVector=new BABYLON.Vector3(0,0,0);lastRotationQuaternion=new BABYLON.Quaternion(0,0,0,1);scaledCamDirection=new BABYLON.Vector3(0,0,0);scaledMaxDirection=new BABYLON.Vector3(0,0,0);parentNodePosition=new BABYLON.Vector3(0,0,0);maximumCameraPos=new BABYLON.Vector3(0,0,0);tempWorldPosition=new BABYLON.Vector3(0,0,0);cameraRaycastShape=null;defaultRaycastGroup=TOOLKIT.CollisionFilters.DefaultFilter;defaultRaycastMask=TOOLKIT.CollisionFilters.StaticFilter;cameraRaycastMask=(TOOLKIT.CollisionFilters.DefaultFilter|TOOLKIT.CollisionFilters.StaticFilter|TOOLKIT.CollisionFilters.KinematicFilter);avatarSkins=null;cameraNode=null;cameraPivot=null;navigationAgent=null;characterController=null;verticalVelocity=0;movementSpeed=0;isRunPressed=false;isJumpPressed=false;isCharacterSliding=false;isCharacterFalling=false;isCharacterGrounded=false;isCharacterFallTriggered=false;isCharacterJumpFrame=false;isCharacterJumping=false;isCharacterLanding=false;isCharacterRising=false;isCharacterNavigating=false;navigationAngularSpeed=0;updateStateParams=true;animationStateParams=null;sphereCollisionShape=null;hasGroundedContact=false;showDebugColliders=false;colliderVisibility=0;colliderRenderGroup=0;groundCheckDistance=0.25;deltaTime=0;minJumpTimer=0;delayJumpTimer=0;playerControl=0;canPlayerJump=true;animationState=null;lastJumpVelocity=new BABYLON.Vector3(0,0,0);inputMovementVector=new BABYLON.Vector3(0,0,0);playerLookRotation=new BABYLON.Vector3(0,0,0);playerRotationVector=BABYLON.Vector2.Zero();playerMovementVelocity=new BABYLON.Vector3(0,0,0);playerRotationQuaternion=BABYLON.Quaternion.Zero();playerMoveDirection=PROJECT.PlayerMoveDirection.Stationary;forwardDirection=new BABYLON.Vector3(0,0,1);downDirection=new BABYLON.Vector3(0,-1,0);climbContact=false;climbContactNode=null;climbContactAngle=0;climbContactPoint=new BABYLON.Vector3(0,0,0);climbContactNormal=new BABYLON.Vector3(0,0,0);climbContactDistance=0;climbSensorLine=null;offsetClimbRaycastPosition=new BABYLON.Vector3(0,0,0);startClimbRaycastPosition=new BABYLON.Vector3(0,0,0);endClimbRaycastPosition=new BABYLON.Vector3(0,0,0);heightContact=false;heightContactNode=null;heightContactAngle=0;heightContactPoint=new BABYLON.Vector3(0,0,0);heightContactNormal=new BABYLON.Vector3(0,0,0);heightContactDistance=0;heightSensorLine=null;offsetHeightRaycastPosition=new BABYLON.Vector3(0,0,0);startHeightRaycastPosition=new BABYLON.Vector3(0,0,0);endHeightRaycastPosition=new BABYLON.Vector3(0,0,0);m_velocityOffset=new BABYLON.Vector3(0,0,0);m_actualVelocity=new BABYLON.Vector3(0,0,0);m_linearVelocity=new BABYLON.Vector3(0,0,0);m_lastPosition=new BABYLON.Vector3(0,0,0);m_positionCenter=new BABYLON.Vector3(0,0,0);m_scaledVelocity=0;playerDrawVelocity=0;constructor(transform,scene,properties,alias="PROJECT.StandardPlayerController"){super(transform,scene,properties,alias)}awake(){this.awakePlayerController()}start(){this.startPlayerController()}after(){this.afterPlayerController()}update(){this.updatePlayerController()}destroy(){this.destroyPlayerController()}onPreUpdateObservable=new BABYLON.Observable;onBeforeMoveObservable=new BABYLON.Observable;onPostUpdateObservable=new BABYLON.Observable;onPlayerInputObservable=new BABYLON.Observable;onPlayerPositionObservable=new BABYLON.Observable;onUpdateActionObservable=new BABYLON.Observable;_deltaMotionPosition=new BABYLON.Vector3(0,0,0);getDeltaMotionPosition(){this._deltaMotionPosition.set(0,0,0);if(this.animationState!=null){const rootMotionPosition=this.animationState.getDeltaRootMotionPosition();if(rootMotionPosition!=null){this._deltaMotionPosition.copyFrom(rootMotionPosition)}}return this._deltaMotionPosition}_deltaMotionRotation=new BABYLON.Quaternion(0,0,0,0);getDeltaMotionRotation(){this._deltaMotionRotation.set(0,0,0,0);if(this.animationState!=null){const rootMotionRotation=this.animationState.getDeltaRootMotionRotation();if(rootMotionRotation!=null){this._deltaMotionRotation.copyFrom(rootMotionRotation)}}return this._deltaMotionRotation}isPerformingAction=false;isRootMotionAction=false;isActionInterruptable=false;afterActionHandler=null;performActionTimer=0;performActionNumber=0;playerRotationSpeed=10;rotatePlayerTowards=false;matchStartTime=0;matchTargetTime=0;matchTargetOffset=0;matchTargetHeight=false;lockTargetHeight=false;lastStartHeight=null;lastTargetHeight=null;lastTargetNormal=new BABYLON.Vector3(0,0,0);lastTargetRotation=new BABYLON.Quaternion(0,0,0,1);lastDeltaPosition=new BABYLON.Vector3(0,0,0);lastDeltaRotation=new BABYLON.Quaternion(0,0,0,1);getIsPerformingAction(){return this.isPerformingAction}getIsRootMotionAction(){return this.isRootMotionAction}getIsActionInterruptable(){return this.isActionInterruptable}playActionAnimation(action,interruptableAction=true,enableRootMotion=false,afterActionComplete=null){if(this.isPerformingAction===false&&this.animationState!=null&&action>=0){this.isPerformingAction=true;this.performActionTimer=0;this.performActionNumber=action;this.afterActionHandler=afterActionComplete;this.isActionInterruptable=interruptableAction;this.isRootMotionAction=enableRootMotion;this.playerRotationSpeed=10;this.rotatePlayerTowards=false;this.matchStartTime=0;this.matchTargetTime=0;this.matchTargetOffset=0;this.matchTargetHeight=false;this.lockTargetHeight=false;this.lastStartHeight=null;this.lastTargetHeight=null;this.lastTargetNormal.set(0,0,0);this.lastTargetRotation.set(0,0,0,1);if(this.isRootMotionAction===true){this.enableCharacterController(false)}}}resetActionAnimationState(){if(this.afterActionHandler!=null){try{this.afterActionHandler()}catch{}}if(this.isRootMotionAction===true){this.enableCharacterController(true)}this.performActionTimer=0;this.performActionNumber=0;this.isPerformingAction=false;this.isRootMotionAction=false;this.isActionInterruptable=false;this.afterActionHandler=null;this.playerRotationSpeed=10;this.rotatePlayerTowards=false;this.matchStartTime=0;this.matchTargetTime=0;this.matchTargetOffset=0;this.matchTargetHeight=false;this.lockTargetHeight=false;this.lastStartHeight=null;this.lastTargetHeight=null;this.lastTargetNormal.set(0,0,0);this.lastTargetRotation.set(0,0,0,1)}updateAnimationActionState(){const deltaTime=this.getDeltaSeconds();const dampTime=(this.matchTargetTime-this.matchStartTime);if(this.animationState!=null&&this.isRootMotionAction===true){const playerGlobalHeight=this.transform.absolutePosition.y;this.lastDeltaPosition.copyFrom(this.getDeltaMotionPosition());BABYLON.Vector3.TransformNormalToRef(this.lastDeltaPosition,this.transform.getWorldMatrix(),this.lastDeltaPosition);if(this.matchTargetHeight===true){if(this.lastStartHeight==null&&this.performActionTimer>=this.matchStartTime){this.lastStartHeight=playerGlobalHeight}if(this.lastStartHeight!=null&&this.lastTargetHeight!=null){this.lastDeltaPosition.y=0;const fixedTargetHeight=(this.lastTargetHeight+this.matchTargetOffset);if(this.performActionTimer<this.matchTargetTime){this.animationState.setSmoothFloat(PROJECT.ThirdPersonPlayerController.PLAYER_HEIGHT,fixedTargetHeight,(dampTime*deltaTime));const smoothPlayerHeight=this.animationState.getFloat(PROJECT.ThirdPersonPlayerController.PLAYER_HEIGHT);this.lastDeltaPosition.y=(smoothPlayerHeight-playerGlobalHeight)}else if(this.lockTargetHeight===false&&this.performActionTimer>=this.matchTargetTime){this.lastDeltaPosition.y=(fixedTargetHeight-playerGlobalHeight);this.lockTargetHeight=true}}}this.transform.position.addInPlace(this.lastDeltaPosition);if(this.rotatePlayerTowards===true){if(this.climbContact===true){this.lastTargetNormal.set(-this.climbContactNormal.x,-this.climbContactNormal.y,-this.climbContactNormal.z);TOOLKIT.Utilities.LookRotationToRef(this.lastTargetNormal,this.lastTargetRotation);const lerpAmount=BABYLON.Scalar.Clamp(this.playerRotationSpeed*deltaTime);BABYLON.Quaternion.SlerpToRef(this.transform.rotationQuaternion,this.lastTargetRotation,lerpAmount,this.transform.rotationQuaternion)}}else{this.lastDeltaRotation.copyFrom(this.getDeltaMotionRotation());this.transform.rotationQuaternion.multiplyInPlace(this.lastDeltaRotation)}}this.performActionTimer+=deltaTime}setWorldPosition(x,y,z){if(this.characterController!=null){this.characterController.set(x,y,z)}}setPlayerControl(mode){this.playerControl=mode;if(this.playerControl===PROJECT.PlayerInputControl.ThirdPersonStrafing){this.showAvatarSkins(true)}else{this.showAvatarSkins(false)}this.forwardCamera=false}togglePlayerControl(){if(this.toggleView===true){if(this.playerControl===PROJECT.PlayerInputControl.FirstPersonStrafing){this.setPlayerControl(PROJECT.PlayerInputControl.ThirdPersonStrafing)}else{this.setPlayerControl(PROJECT.PlayerInputControl.FirstPersonStrafing)}}}showAvatarSkins(show){if(this.avatarSkins!=null){this.avatarSkins.forEach(skin=>{skin.isVisible=show})}}attachPlayerCamera(player){if(this.cameraNode==null){const playerCamera=(player<=0||player>4)?1:player;this.cameraNode=PROJECT.DefaultCameraSystem.GetCameraTransform(this.scene,playerCamera);if(this.cameraNode!=null){this.cameraNode.parent=this.cameraPivot;this.cameraNode.position.copyFrom(this.boomPosition);this.cameraNode.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);this.cameraDistance=this.cameraNode.position.length();this.dollyDirection.copyFrom(this.cameraNode.position);this.dollyDirection.normalize()}else{}}}ikLeftFootTarget=null;ikLeftPoleTarget=null;ikRightFootTarget=null;ikRightPoleTarget=null;abstractSkinMesh=null;rootBoneTransform=null;leftFootTransform=null;leftFootPoleOffset=new BABYLON.Vector3(-0.1,0.5,0.5);leftFootMaxAngle=90;rightFootTransform=null;rightFootPoleOffset=new BABYLON.Vector3(0.1,0.5,0.5);rightFootMaxAngle=90;ikLeftController=null;ikRightController=null;onAnimatorIK=null;getPlayerMesh(){return this.abstractSkinMesh}getRootHipBone(){return(this.rootBoneTransform!=null)?this.rootBoneTransform._linkedBone:null}getLeftFootBone(){return(this.leftFootTransform!=null)?this.leftFootTransform._linkedBone:null}getRightFootBone(){return(this.rightFootTransform!=null)?this.rightFootTransform._linkedBone:null}getLeftFootTarget(){return this.ikLeftFootTarget}getRightFootTarget(){return this.ikRightFootTarget}getLeftFootPoleTarget(){return this.ikLeftPoleTarget}getRightFootPoleTarget(){return this.ikRightPoleTarget}getRootBoneTransform(){return this.rootBoneTransform}getLeftFootTransform(){return this.leftFootTransform}getRightFootTransform(){return this.rightFootTransform}getLeftFootController(){return this.ikLeftController}getRightFootController(){return this.ikRightController}isGroundedFootIKActive(){return(this.isCharacterGrounded===true&&this.animationState!=null&&this.animationState.ikFrameEnabled())}setupBoneControllers(){const createFootIKRig=this.getProperty("createFootIKRig");if(createFootIKRig===true){const displayHandles=this.getProperty("displayHandles");const abstractSkinMeshData=this.getProperty("abstractSkinMesh");if(abstractSkinMeshData!=null)this.abstractSkinMesh=this.getChildNode(abstractSkinMeshData.name,TOOLKIT.SearchType.ExactMatch,false);const rootBoneTransformData=this.getProperty("rootBoneTransform");if(rootBoneTransformData!=null)this.rootBoneTransform=this.getChildNode(rootBoneTransformData.name,TOOLKIT.SearchType.ExactMatch,false);const leftFootTransformData=this.getProperty("leftFootTransform");if(leftFootTransformData!=null)this.leftFootTransform=this.getChildNode(leftFootTransformData.name,TOOLKIT.SearchType.ExactMatch,false);const leftPoleHandleData=this.getProperty("leftFootPoleOffset");if(leftPoleHandleData!=null)this.leftFootPoleOffset.copyFrom(TOOLKIT.Utilities.ParseVector3(leftPoleHandleData));this.leftFootMaxAngle=this.getProperty("leftFootMaxAngle",this.leftFootMaxAngle);const rightFootTransformData=this.getProperty("rightFootTransform");if(rightFootTransformData!=null)this.rightFootTransform=this.getChildNode(rightFootTransformData.name,TOOLKIT.SearchType.ExactMatch,false);const rightPoleHandleData=this.getProperty("rightFootPoleOffset");if(rightPoleHandleData!=null)this.rightFootPoleOffset.copyFrom(TOOLKIT.Utilities.ParseVector3(rightPoleHandleData));this.rightFootMaxAngle=this.getProperty("rightFootMaxAngle",this.rightFootMaxAngle);if(this.abstractSkinMesh!=null&&this.rootBoneTransform!=null){let materialName="M_TARGET_MESH";let targetMaterial=this.scene.getMaterialByName(materialName);if(targetMaterial==null){targetMaterial=new BABYLON.StandardMaterial("M_TARGET_MESH",this.scene);targetMaterial.diffuseColor=new BABYLON.Color3(1.0,0.5,0.25)}if(this.leftFootTransform!=null&&this.leftFootTransform._linkedBone!=null){this.ikLeftFootTarget=BABYLON.MeshBuilder.CreateBox(this.transform.name+".LeftFootTarget",{width:0.1,height:0.1,depth:0.1},this.scene);this.ikLeftFootTarget.parent=this.leftFootTransform;this.ikLeftFootTarget.position.set(0,0,0);this.ikLeftFootTarget.material=targetMaterial;this.ikLeftFootTarget.isVisible=displayHandles;this.ikLeftPoleTarget=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".LeftFootPole",{diameter:0.1},this.scene);this.ikLeftPoleTarget.parent=this.abstractSkinMesh;this.ikLeftPoleTarget.position.copyFrom(this.leftFootPoleOffset);this.ikLeftPoleTarget.isVisible=displayHandles}if(this.rightFootTransform!=null&&this.rightFootTransform._linkedBone!=null){this.ikRightFootTarget=BABYLON.MeshBuilder.CreateBox(this.transform.name+".RightFootTarget",{width:0.1,height:0.1,depth:0.1},this.scene);this.ikRightFootTarget.parent=this.rightFootTransform;this.ikRightFootTarget.position.set(0,0,0);this.ikRightFootTarget.material=targetMaterial;this.ikRightFootTarget.isVisible=displayHandles;this.ikRightPoleTarget=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".RightFootPole",{diameter:0.1},this.scene);this.ikRightPoleTarget.parent=this.abstractSkinMesh;this.ikRightPoleTarget.position.copyFrom(this.rightFootPoleOffset);this.ikRightPoleTarget.isVisible=displayHandles}}}}attachAnimationController(){if(this.animationState==null){this.animationState=this.getComponent("TOOLKIT.AnimationState",true)}if(this.animationState!=null){this.animationState.onAnimationEndObservable.add(()=>{if(this.isPerformingAction===true){this.resetActionAnimationState()}});this.animationState.onAnimationUpdateObservable.add(()=>{if(this.onAnimatorIK!=null){this.onAnimatorIK()}else{this.updateAnimatorTargetMeshes();if(this.ikLeftController!=null){this.ikLeftController.update()}if(this.ikRightController!=null){this.ikRightController.update()}}})}}updateAnimatorTargetMeshes(){}enableCharacterController(state){if(state===true){this.movementAllowed=true;this.resetPlayerJumpingState();if(this.characterController!=null){this.characterController.setGravityFactor(this.gravitationalForce);this.characterController.setCollisionState(true)}}else{this.movementAllowed=false;this.resetPlayerJumpingState();if(this.characterController!=null){this.characterController.setGravityFactor(0);this.characterController.setCollisionState(false)}}}resetPlayerRotation(){this.transform.rotationQuaternion.toEulerAnglesToRef(this.rotationEulers);this.playerRotationVector.x=this.rotationEulers.x;this.playerRotationVector.y=this.rotationEulers.y}resetPlayerJumpingState(){this.minJumpTimer=0;this.isCharacterJumping=false;this.isCharacterLanding=false;this.isCharacterRising=false;this.isCharacterJumpFrame=false;if(this.characterController!=null){this.characterController.jump(0)}}awakePlayerController(){this.gravitationalForce=this.getProperty("gravityMultiplier",this.gravitationalForce);this.verticalStepSpeed=this.getProperty("stepUpVelocity",this.verticalStepSpeed);this.minStepUpHeight=this.getProperty("minStepHeight",this.minStepUpHeight);this.rigidBodyMass=this.getProperty("rigidBodyMass",this.rigidBodyMass);this.rotateCamera=this.getProperty("rotateCamera",this.rotateCamera);this.mouseWheel=this.getProperty("mouseWheel",this.mouseWheel);this.rayClimbLength=this.getProperty("rayClimbLength",this.rayClimbLength);this.rayClimbOffset=this.getProperty("rayClimbOffset",this.rayClimbOffset);this.rayHeightLength=this.getProperty("rayHeightLength",this.rayHeightLength);this.rayHeightOffset=this.getProperty("rayHeightOffset",this.rayHeightOffset);this.maxAngle=this.getProperty("maxAngle",this.maxAngle);this.landingEpsilon=this.getProperty("landingEpsilon",this.landingEpsilon);this.minFallVelocity=this.getProperty("minFallVelocity",this.minFallVelocity);this.airbornTimeout=this.getProperty("airbornTimeout",this.airbornTimeout);this.rootMotion=this.getProperty("rootMotion",this.rootMotion);this.moveSpeed=this.getProperty("moveSpeed",this.moveSpeed);this.walkSpeed=this.getProperty("walkSpeed",this.walkSpeed);this.lookSpeed=this.getProperty("lookSpeed",this.lookSpeed);this.jumpSpeed=this.getProperty("jumpSpeed",this.jumpSpeed);this.jumpDelay=this.getProperty("jumpDelay",this.jumpDelay);this.eyesHeight=this.getProperty("eyesHeight",this.eyesHeight);this.pivotHeight=this.getProperty("pivotHeight",this.pivotHeight);this.maxDistance=this.getProperty("maxDistance",this.maxDistance);this.scrollSpeed=this.getProperty("scrollSpeed",this.scrollSpeed);this.topLookLimit=this.getProperty("topLookLimit",this.topLookLimit);this.downLookLimit=this.getProperty("downLookLimit",this.downLookLimit);this.lowTurnSpeed=this.getProperty("lowTurnSpeed",this.lowTurnSpeed);this.highTurnSpeed=this.getProperty("highTurnSpeed",this.highTurnSpeed);this.enableInput=this.getProperty("enableInput",this.enableInput);this.playerNumber=this.getProperty("playerNumber",this.playerNumber);this.attachCamera=this.getProperty("attachCamera",this.attachCamera);this.freeLooking=this.getProperty("freeLooking",this.freeLooking);this.toggleView=this.getProperty("toggleView",this.toggleView);this.avatarSkinTag=this.getProperty("avatarSkinTag",this.avatarSkinTag);this.runKeyRequired=this.getProperty("runKeyRequired",this.runKeyRequired);this.cameraCollisions=this.getProperty("cameraCollisions",this.cameraCollisions);this.cameraSmoothing=this.getProperty("cameraSmoothing",this.cameraSmoothing);this.distanceFactor=this.getProperty("distanceFactor",this.distanceFactor);this.minimumDistance=this.getProperty("minimumDistance",this.minimumDistance);this.smoothMotionTime=this.getProperty("smoothMotionTime",this.smoothMotionTime);this.smoothInputVectors=this.getProperty("smoothInputVectors",this.smoothInputVectors);this.smoothAcceleration=this.getProperty("smoothAcceleration",this.smoothAcceleration);this.accelerationSpeed=this.getProperty("accelerationSpeed",this.accelerationSpeed);this.decelerationSpeed=this.getProperty("decelerationSpeed",this.decelerationSpeed);this.climbVolumeTag=this.getProperty("climbVolumeTag",this.climbVolumeTag);this.vaultVolumeTag=this.getProperty("vaultVolumeTag",this.vaultVolumeTag);this.useClimbSystem=this.getProperty("useClimbSystem",this.useClimbSystem);this.maxHeightRanges=this.getProperty("maxHeightRanges",this.maxHeightRanges);this.updateStateParams=this.getProperty("updateStateParams",this.updateStateParams);this.animationStateParams=this.getProperty("animationStateParams",this.animationStateParams);this.postNetworkAttributes=this.getProperty("postNetworkAttribs",this.postNetworkAttributes);this.groundCheckDistance=this.getProperty("groundCheckDist",this.groundCheckDistance);const arrowKeyRotation=this.getProperty("arrowKeyRotation");if(arrowKeyRotation===true)TOOLKIT.UserInputOptions.UseArrowKeyRotation=true;const boomPositionData=this.getProperty("boomPosition");if(boomPositionData!=null)this.boomPosition=TOOLKIT.Utilities.ParseVector3(boomPositionData);const sphereRadius=this.getProperty("sphereRadius",0.65);this.cameraRaycastShape=new BABYLON.PhysicsShapeSphere(new BABYLON.Vector3(0,0,0),sphereRadius,this.scene);this.abstractMesh=this.getAbstractMesh();this.showDebugColliders=TOOLKIT.Utilities.ShowDebugColliders();this.colliderVisibility=TOOLKIT.Utilities.ColliderVisibility();this.colliderRenderGroup=TOOLKIT.Utilities.ColliderRenderGroup();if(this.avatarSkinTag!=null&&this.avatarSkinTag!==""){this.avatarSkins=this.getChildrenWithTags(this.avatarSkinTag,false)}const pcontrol=this.getProperty("playerControl",this.playerControl);this.setPlayerControl(pcontrol);this.resetPlayerRotation();this.cameraPivot=new BABYLON.Mesh(this.transform.name+".CameraPivot",this.scene);this.cameraPivot.parent=null;this.cameraPivot.position=this.transform.position.clone();this.cameraPivot.rotationQuaternion=this.transform.rotationQuaternion.clone();this.cameraPivot.checkCollisions=false;this.cameraPivot.isPickable=false;if(this.showDebugColliders===true){const testPivot=BABYLON.MeshBuilder.CreateBox("TestPivot",{width:0.25,height:0.25,depth:0.5},this.scene);testPivot.parent=this.cameraPivot;testPivot.position.set(0,0,0);testPivot.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1);testPivot.visibility=0.5;testPivot.renderingGroupId=this.colliderRenderGroup;testPivot.checkCollisions=false;testPivot.isPickable=false}const configController=this.getComponent("TOOLKIT.CharacterController");this.setupBoneControllers();TOOLKIT.InputController.OnKeyboardPress(this.keyboardCamera,()=>{this.togglePlayerControl()});TOOLKIT.InputController.OnGamepadButtonPress(this.buttonCamera,()=>{this.togglePlayerControl()})}startPlayerController(){if(this.attachCamera===true){this.attachPlayerCamera(this.playerNumber)}this.navigationAgent=this.getComponent("TOOLKIT.NavigationAgent");this.characterController=this.getComponent("TOOLKIT.CharacterController");if(this.characterController!=null){this.avatarRadius=this.characterController.getAvatarRadius();this.characterController.enableGravity=true;this.characterController.enableStepOffset=true;this.characterController.useMultiRaycast=true;this.characterController.multiRaycastCount=5;this.characterController.stepUpVelocityFactor=0.5;this.characterController.groundCheckDistance=this.groundCheckDistance;this.characterController.setRigidBodyMass(this.rigidBodyMass);this.characterController.setGravityFactor(this.gravitationalForce);this.characterController.onUpdatePositionObservable.add(()=>{this.updatePlayerPosition();this.updateCameraController()});TOOLKIT.SceneManager.LogWarning("Starting player controller in physic engine mode for: "+this.transform.name)}else{TOOLKIT.SceneManager.LogWarning("No character controller found for: "+this.transform.name)}}updatePlayerPosition(){if(this.onPlayerPositionObservable&&this.onPlayerPositionObservable.hasObservers()){this.onPlayerPositionObservable.notifyObservers(this.transform)}}updatePlayerController(){this.deltaTime=this.getDeltaSeconds();this.m_actualVelocity=this.transform.absolutePosition.subtract(this.m_lastPosition);this.m_linearVelocity.copyFrom(this.m_actualVelocity);this.m_scaledVelocity=(this.m_linearVelocity.length()/this.deltaTime);this.m_linearVelocity.normalize();this.m_linearVelocity.scaleInPlace(this.m_scaledVelocity);if(this.playerDrawVelocity>0){this.m_velocityOffset.copyFrom(this.m_linearVelocity);this.m_velocityOffset.scaleInPlace(this.playerDrawVelocity)}else{this.m_velocityOffset.set(0,0,0)}this.m_lastPosition.copyFrom(this.transform.absolutePosition);if(this.updateStateParams===true&&this.animationState==null){this.attachAnimationController()}if(this.minJumpTimer>0){this.minJumpTimer-=this.deltaTime;if(this.minJumpTimer<0)this.minJumpTimer=0}if(this.isCharacterGrounded===true&&this.delayJumpTimer>0){this.delayJumpTimer-=this.deltaTime;if(this.delayJumpTimer<0)this.delayJumpTimer=0}this.canPlayerJump=true;if(this.isPerformingAction===true){this.updateAnimationActionState();if(this.onUpdateActionObservable&&this.onUpdateActionObservable.hasObservers()){this.onUpdateActionObservable.notifyObservers(this.transform)}}if(this.enableInput===false)return;const userInputX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Horizontal,this.playerNumber);const userInputZ=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Vertical,this.playerNumber);const userMouseX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseX,this.playerNumber);const userMouseY=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseY,this.playerNumber);if(this.smoothAcceleration===true){if(userInputX>0){this.playerInputX+=(this.accelerationSpeed*this.deltaTime);if(this.playerInputX>1)this.playerInputX=1}else if(userInputX<0){this.playerInputX-=(this.accelerationSpeed*this.deltaTime);if(this.playerInputX<-1)this.playerInputX=-1}else{if(this.playerInputX<0){this.playerInputX+=(this.decelerationSpeed*this.deltaTime);if(this.playerInputX>0)this.playerInputX=0}else if(this.playerInputX>0){this.playerInputX-=(this.decelerationSpeed*this.deltaTime);if(this.playerInputX<0)this.playerInputX=0}}if(userInputZ>0){this.playerInputZ+=(this.accelerationSpeed*this.deltaTime);if(this.playerInputZ>1)this.playerInputZ=1}else if(userInputZ<0){this.playerInputZ-=(this.accelerationSpeed*this.deltaTime);if(this.playerInputZ<-1)this.playerInputZ=-1}else{if(this.playerInputZ<0){this.playerInputZ+=(this.decelerationSpeed*this.deltaTime);if(this.playerInputZ>0)this.playerInputZ=0}else if(this.playerInputZ>0){this.playerInputZ-=(this.decelerationSpeed*this.deltaTime);if(this.playerInputZ<0)this.playerInputZ=0}}}else{this.playerInputX=userInputX;this.playerInputZ=userInputZ}this.playerMouseX=userMouseX;this.playerMouseY=userMouseY;if(this.isPerformingAction===true&&this.isActionInterruptable===true){if(this.playerInputX!==0||this.playerInputZ!==0){this.resetActionAnimationState()}}if(this.isPerformingAction===true){this.canPlayerJump=false;this.playerInputX=0;this.playerInputZ=0}if(this.onPlayerInputObservable&&this.onPlayerInputObservable.hasObservers()){this.onPlayerInputObservable.notifyObservers(this.transform)}this.inputMovementVector.set(this.playerInputX,0,this.playerInputZ);if(this.inputMovementVector.length()>1.0)this.inputMovementVector.normalize();this.inputMagnitude=this.inputMovementVector.length();const moveForward=(this.playerInputZ>0);const moveBackward=(this.playerInputZ<0);const moveRight=(this.playerInputX>0);const moveLeft=(this.playerInputX<0);if(moveForward===true){if(moveLeft===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.ForwardLeft}else if(moveRight===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.ForwardRight}else{this.playerMoveDirection=PROJECT.PlayerMoveDirection.Forward}}else if(moveBackward===true){if(moveLeft===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.BackwardLeft}else if(moveRight===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.BackwardRight}else{this.playerMoveDirection=PROJECT.PlayerMoveDirection.Backward}}else if(moveLeft===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.StrafingLeft}else if(moveRight===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.StrafingRight}else{this.playerMoveDirection=PROJECT.PlayerMoveDirection.Stationary}if(this.onPreUpdateObservable&&this.onPreUpdateObservable.hasObservers()){this.onPreUpdateObservable.notifyObservers(this.transform)}this.cameraForwardVector=this.scene.activeCamera.getForwardRay().direction;this.cameraForwardVector.y=0;this.cameraForwardVector.normalize();this.cameraForwardVector.scaleToRef(this.playerInputZ,this.desiredForwardVector);this.cameraRightVector=BABYLON.Vector3.Cross(this.cameraForwardVector,BABYLON.Vector3.Up());this.cameraRightVector.y=0;this.cameraRightVector.normalize();this.cameraRightVector.scaleToRef(this.playerInputX,this.desiredRightVector);this.playerRotationVector.y+=(this.playerMouseX*this.lookSpeed*this.deltaTime);this.playerRotationVector.x+=(-this.playerMouseY*this.lookSpeed*this.deltaTime);this.playerRotationVector.x=BABYLON.Scalar.Clamp(this.playerRotationVector.x,-BABYLON.Tools.ToRadians(this.downLookLimit),BABYLON.Tools.ToRadians(this.topLookLimit));if(this.movementAllowed===false){this.canPlayerJump=false;this.playerInputX=0;this.playerInputZ=0}this.isRunPressed=(TOOLKIT.InputController.GetKeyboardInput(this.keyboardRun)||TOOLKIT.InputController.GetGamepadButtonInput(this.buttonRun));this.isJumpPressed=(TOOLKIT.InputController.GetKeyboardInput(this.keyboardJump)||TOOLKIT.InputController.GetGamepadButtonInput(this.buttonJump));this.movementSpeed=(this.inputMagnitude*this.moveSpeed*this.speedFactor);if(this.runKeyRequired===true&&this.isRunPressed===false){this.movementSpeed=BABYLON.Scalar.Clamp(this.movementSpeed,0,this.walkSpeed)}this.desiredForwardVector.addToRef(this.desiredRightVector,this.playerMovementVelocity);this.playerMovementVelocity.scaleInPlace(this.movementSpeed);if(this.movementAllowed===true){if(this.playerControl===PROJECT.PlayerInputControl.FirstPersonStrafing){BABYLON.Quaternion.FromEulerAnglesToRef(0,this.playerRotationVector.y,0,this.transform.rotationQuaternion)}else if(this.playerControl===PROJECT.PlayerInputControl.ThirdPersonStrafing){if(this.freeLooking===true){if(this.inputMagnitude>0){const strafingTurnRatio=(this.playerMovementVelocity.length()/this.moveSpeed);const strafingTurnSpeed=BABYLON.Scalar.Lerp(this.highTurnSpeed,this.lowTurnSpeed,strafingTurnRatio);BABYLON.Quaternion.FromEulerAnglesToRef(0,this.playerRotationVector.y,0,this.playerRotationQuaternion);BABYLON.Quaternion.SlerpToRef(this.transform.rotationQuaternion,this.playerRotationQuaternion,(strafingTurnSpeed*this.deltaTime),this.transform.rotationQuaternion)}}else{BABYLON.Quaternion.FromEulerAnglesToRef(0,this.playerRotationVector.y,0,this.transform.rotationQuaternion)}}}this.verticalVelocity=this.getVerticalVelocity();this.movementVelocity.copyFrom(this.playerMovementVelocity);this.hasGroundedContact=false;this.isCharacterGrounded=false;this.isCharacterSliding=false;this.isCharacterFalling=false;this.isCharacterJumpFrame=false;this.isCharacterNavigating=(this.navigationAgent!=null&&this.navigationAgent.isNavigating());this.navigationAngularSpeed=(this.navigationAgent!=null)?this.navigationAgent.angularSpeed:0;this.updateCharacterController();if(this.animationState!=null&&this.updateStateParams===true){this.validateAnimationStateParams();this.animationState.setInteger(this.animationStateParams.moveDirection,this.playerMoveDirection);this.animationState.setFloat(this.animationStateParams.heightInput,this.verticalVelocity);this.animationState.setBool(this.animationStateParams.jumpFrame,this.isCharacterJumpFrame);this.animationState.setBool(this.animationStateParams.jumpState,this.isCharacterJumping);this.animationState.setInteger(this.animationStateParams.actionState,this.performActionNumber);this.animationState.setBool(this.animationStateParams.fallingState,this.isCharacterFalling);this.animationState.setBool(this.animationStateParams.slidingState,this.isCharacterSliding);this.animationState.setBool(this.animationStateParams.groundedState,this.isCharacterGrounded);if(this.smoothMotionTime>0){if(this.smoothInputVectors===true){this.animationState.setSmoothFloat(this.animationStateParams.horizontalInput,this.playerInputX,(this.smoothMotionTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.verticalInput,this.playerInputZ,(this.smoothMotionTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.mouseXInput,this.playerMouseX,(this.smoothMotionTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.mouseYInput,this.playerMouseY,(this.smoothMotionTime*this.deltaTime))}else{this.animationState.setFloat(this.animationStateParams.horizontalInput,this.playerInputX);this.animationState.setFloat(this.animationStateParams.verticalInput,this.playerInputZ);this.animationState.setFloat(this.animationStateParams.mouseXInput,this.playerMouseX);this.animationState.setFloat(this.animationStateParams.mouseYInput,this.playerMouseY)}this.animationState.setSmoothFloat(this.animationStateParams.inputMagnitude,this.inputMagnitude,(this.smoothMotionTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.speedInput,this.movementSpeed,(this.smoothMotionTime*this.deltaTime))}else{this.animationState.setFloat(this.animationStateParams.horizontalInput,this.playerInputX);this.animationState.setFloat(this.animationStateParams.verticalInput,this.playerInputZ);this.animationState.setFloat(this.animationStateParams.mouseXInput,this.playerMouseX);this.animationState.setFloat(this.animationStateParams.mouseYInput,this.playerMouseY);this.animationState.setFloat(this.animationStateParams.inputMagnitude,this.inputMagnitude);this.animationState.setFloat(this.animationStateParams.speedInput,this.movementSpeed)}if(this.isCharacterNavigating===true){}}if(this.postNetworkAttributes==true&&TOOLKIT.EntityController.HasNetworkEntity(this.transform)){TOOLKIT.EntityController.PostBufferedAttribute(this.transform,0,this.playerMoveDirection);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,1,this.inputMagnitude);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,2,this.playerInputX);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,3,this.playerInputZ);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,4,this.playerMouseX);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,5,this.playerMouseY);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,6,this.verticalVelocity);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,7,this.movementSpeed);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,8,this.performActionNumber);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,9,((this.isCharacterJumpFrame)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,10,((this.isCharacterJumping)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,11,((this.isCharacterFalling)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,12,((this.isCharacterSliding)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,13,((this.isCharacterGrounded)?1:0))}if(this.onPostUpdateObservable&&this.onPostUpdateObservable.hasObservers()){this.onPostUpdateObservable.notifyObservers(this.transform)}}afterPlayerController(){}updateCharacterController(){if(this.characterController!=null){this.isCharacterRising=(this.isCharacterJumping==true&&this.verticalVelocity>0);this.isCharacterLanding=(this.isCharacterJumping==true&&this.verticalVelocity<0);if(this.isCharacterRising==true){this.hasGroundedContact=false}if(this.hasGroundedContact===true&&this.minJumpTimer<=0){this.isCharacterSliding=false;this.isCharacterGrounded=true}if(this.isCharacterGrounded===true)this.isCharacterJumping=false;this.isCharacterFalling=(this.isCharacterGrounded===false&&this.isCharacterSliding==false&&this.isCharacterJumping==false&&this.verticalVelocity<0&&Math.abs(this.verticalVelocity)>=this.minFallVelocity);if(this.isCharacterFalling===true&&this.isCharacterFallTriggered===false){this.isCharacterFallTriggered=true;if(this.jumpDelay>0)this.delayJumpTimer=this.jumpDelay}if(this.isCharacterGrounded===true)this.isCharacterFallTriggered=false;if(this.useClimbSystem===true){this.castPhysicsClimbingVolumeRay();this.castPhysicsHeightCheckVolumeRay()}if(this.isCharacterNavigating===false&&this.movementAllowed===true){if(this.isCharacterGrounded===true){if(this.delayJumpTimer<=0)this.isCharacterJumpFrame=(this.canPlayerJump===true&&this.isJumpPressed===true);if(this.isPerformingAction===false&&this.isCharacterJumpFrame===true&&this.useClimbSystem===true&&this.climbContact===true&&this.heightContact===true){let climbAction=-1;let rotateSpeed=1;let rotateTowards=false;let matchHeight=false;let startTime=0;let targetTime=0;let targetOffset=0;const hitHeight=parseFloat(this.heightContactPoint.y.toFixed(2));const playerHeight=parseFloat(this.transform.position.y.toFixed(2));const obstacleHeight=parseFloat((hitHeight-playerHeight).toFixed(2));if(obstacleHeight>=this.maxHeightRanges.stepUpRange.minimumHeight&&obstacleHeight<=this.maxHeightRanges.stepUpRange.maximumHeight){climbAction=PROJECT.ActionAnimationType.StepUp;rotateSpeed=this.maxHeightRanges.stepUpRange.rotationSpeed;rotateTowards=this.maxHeightRanges.stepUpRange.rotateTowards;matchHeight=this.maxHeightRanges.stepUpRange.matchHeight;startTime=this.maxHeightRanges.stepUpRange.startTime;targetTime=this.maxHeightRanges.stepUpRange.targetTime;targetOffset=this.maxHeightRanges.stepUpRange.targetOffset}else if(obstacleHeight>=this.maxHeightRanges.jumpUpRange.minimumHeight&&obstacleHeight<=this.maxHeightRanges.jumpUpRange.maximumHeight){climbAction=PROJECT.ActionAnimationType.JumpUp;rotateSpeed=this.maxHeightRanges.jumpUpRange.rotationSpeed;rotateTowards=this.maxHeightRanges.jumpUpRange.rotateTowards;matchHeight=this.maxHeightRanges.jumpUpRange.matchHeight;startTime=this.maxHeightRanges.jumpUpRange.startTime;targetTime=this.maxHeightRanges.jumpUpRange.targetTime;targetOffset=this.maxHeightRanges.jumpUpRange.targetOffset}else if(obstacleHeight>=this.maxHeightRanges.climbUpRange.minimumHeight&&obstacleHeight<=this.maxHeightRanges.climbUpRange.maximumHeight){climbAction=PROJECT.ActionAnimationType.ClimbUp;rotateSpeed=this.maxHeightRanges.climbUpRange.rotationSpeed;rotateTowards=this.maxHeightRanges.climbUpRange.rotateTowards;matchHeight=this.maxHeightRanges.climbUpRange.matchHeight;startTime=this.maxHeightRanges.climbUpRange.startTime;targetTime=this.maxHeightRanges.climbUpRange.targetTime;targetOffset=this.maxHeightRanges.climbUpRange.targetOffset}if(climbAction>=0){if(this.canClimbObstaclePredicate==null||this.canClimbObstaclePredicate(climbAction)===true){this.isCharacterJumpFrame=false;this.isCharacterJumping=false;this.isCharacterLanding=false;this.isCharacterRising=false;this.playActionAnimation(climbAction,false,true);this.playerRotationSpeed=rotateSpeed;this.rotatePlayerTowards=rotateTowards;this.matchTargetHeight=matchHeight;this.matchStartTime=(startTime-PROJECT.ThirdPersonPlayerController.MIN_TIMER_OFFSET);this.matchTargetTime=(targetTime-PROJECT.ThirdPersonPlayerController.MIN_TIMER_OFFSET);this.matchTargetOffset=targetOffset;this.lastTargetHeight=hitHeight;this.lastStartHeight=null;this.lockTargetHeight=false}}}if(this.isCharacterJumpFrame===true&&this.jumpSpeed>0){this.isCharacterJumping=true;this.characterController.jump(this.jumpSpeed);if(this.jumpDelay>0)this.delayJumpTimer=this.jumpDelay;if(this.airbornTimeout>0)this.minJumpTimer=(this.airbornTimeout+this.deltaTime);this.lastJumpVelocity.set(this.movementVelocity.x,0,this.movementVelocity.z)}if(this.onBeforeMoveObservable&&this.onBeforeMoveObservable.hasObservers()){this.onBeforeMoveObservable.notifyObservers(this.transform)}if(this.animationState!=null&&this.rootMotion===true){const rootMotion=this.getDeltaMotionPosition();this.movementVelocity.set(rootMotion.x,0,rootMotion.z);BABYLON.Vector3.TransformNormalToRef(this.movementVelocity,this.transform.getWorldMatrix(),this.movementVelocity);this.characterController.move(this.movementVelocity)}else{this.characterController.move(this.movementVelocity)}}}else{}}}updateCameraController(){if(this.enableInput===false)return;if(this.cameraPivot!=null){if(this.targetCameraOffset.x!==0||this.targetCameraOffset.y!==0||this.targetCameraOffset.z!==0){this.cameraPivotOffset.copyFrom(this.targetCameraOffset)}else{if(this.playerControl===PROJECT.PlayerInputControl.ThirdPersonStrafing){this.cameraPivotOffset.set(0,this.pivotHeight,0)}else{this.cameraPivotOffset.set(0,this.eyesHeight,0)}}TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.cameraPivot.position,this.cameraPivotOffset);if(this.rotateCamera===true){BABYLON.Quaternion.FromEulerAnglesToRef(this.playerRotationVector.x,this.playerRotationVector.y,0,this.cameraPivot.rotationQuaternion)}}if(this.rotateCamera===true&&this.cameraNode!=null){if(this.cameraSmoothing<=0)this.cameraSmoothing=5.0;if(this.playerControl===PROJECT.PlayerInputControl.ThirdPersonStrafing){if(this.cameraCollisions===true){const parentNode=this.cameraNode.parent;this.dollyDirection.scaleToRef(this.maxDistance,this.scaledMaxDirection);this.dollyDirection.scaleToRef(this.cameraDistance,this.scaledCamDirection);TOOLKIT.Utilities.GetAbsolutePositionToRef(parentNode,this.parentNodePosition);TOOLKIT.Utilities.TransformPointToRef(parentNode,this.scaledMaxDirection,this.maximumCameraPos);let contact=false;let distance=0;if(this.characterController!=null){if(this.cameraRaycastShape!=null){const query={shape:this.cameraRaycastShape,rotation:this.cameraNode.rotationQuaternion,startPosition:this.parentNodePosition,endPosition:this.maximumCameraPos,ignoreBody:this.transform.physicsBody,shouldHitTriggers:false};const result=TOOLKIT.RigidbodyPhysics.Shapecast(query);contact=(result!=null&&result.world!=null&&result.world.hasHit===true&&result.world.body!=null);distance=(contact===true)?BABYLON.Vector3.Distance(this.parentNodePosition,result.world.hitPoint):0}}if(contact===true){this.cameraDistance=BABYLON.Scalar.Clamp((distance*this.distanceFactor),this.minimumDistance,this.maxDistance);if(this.cameraNode.position.x!==this.scaledCamDirection.x||this.cameraNode.position.y!==this.scaledCamDirection.y||this.cameraNode.position.z!==this.scaledCamDirection.z){BABYLON.Vector3.LerpToRef(this.cameraNode.position,this.scaledCamDirection,(this.deltaTime*this.cameraSmoothing),this.cameraNode.position)}}else{if(this.mouseWheel===true){if(TOOLKIT.InputController.IsWheelScrolling()){const wheel=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Wheel);if(wheel<0){const zoomOutSpeed=(this.scrollSpeed*this.deltaTime);this.boomPosition.z=BABYLON.Scalar.MoveTowards(this.boomPosition.z,-this.maxDistance,zoomOutSpeed)}else if(wheel>0){const zoomInSpeed=(this.scrollSpeed*this.deltaTime);this.boomPosition.z=BABYLON.Scalar.MoveTowards(this.boomPosition.z,-this.minimumDistance,zoomInSpeed)}}}if(this.cameraNode.position.x!==this.boomPosition.x||this.cameraNode.position.y!==this.boomPosition.y||this.cameraNode.position.z!==this.boomPosition.z){BABYLON.Vector3.LerpToRef(this.cameraNode.position,this.boomPosition,(this.deltaTime*this.cameraSmoothing),this.cameraNode.position)}}}else{if(this.cameraNode.position.x!==this.boomPosition.x||this.cameraNode.position.y!==this.boomPosition.y||this.cameraNode.position.z!==this.boomPosition.z){BABYLON.Vector3.LerpToRef(this.cameraNode.position,this.boomPosition,(this.deltaTime*this.cameraSmoothing),this.cameraNode.position)}}}else{if(this.cameraNode.position.x!==0||this.cameraNode.position.y!==0||this.cameraNode.position.z!==0){this.cameraNode.position.set(0,0,0)}}}this.updateSmoothBoomArmLength()}getBoomArmMaxDistance(){return this.maxDistance}setBoomArmMaxDistance(distance){this.maxDistance=Math.abs(distance)}setSmoothBoomArmLength(length,speed,updateMaxDistance=true){const absoluteLength=Math.abs(length);this.smoothBoomArmLength=-absoluteLength;this.smoothBoomArmSpeed=speed;if(updateMaxDistance===true){const absoluteDistance=Math.abs(this.maxDistance);if(absoluteLength>absoluteDistance){this.setBoomArmMaxDistance(absoluteLength)}}}smoothBoomArmLength=null;smoothBoomArmSpeed=null;updateSmoothBoomArmLength(){if(this.smoothBoomArmLength!=null&&this.smoothBoomArmSpeed!=null){if(this.boomPosition.z!==this.smoothBoomArmLength){this.boomPosition.z=BABYLON.Scalar.MoveTowards(this.boomPosition.z,this.smoothBoomArmLength,(this.smoothBoomArmSpeed*this.getDeltaSeconds()))}else{this.smoothBoomArmLength=null;this.smoothBoomArmSpeed=null}}}castPhysicsClimbingVolumeRay(){let raycast=null;this.climbContact=false;this.climbContactNode=null;this.climbContactPoint.set(0,0,0);this.climbContactNormal.set(0,0,0);this.climbContactAngle=0;this.climbContactDistance=0;const playerTransformForwardDirection=TOOLKIT.Utilities.TransformDirection(this.transform,this.forwardDirection);this.offsetClimbRaycastPosition.set(0,this.rayClimbOffset,0);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.startClimbRaycastPosition,this.offsetClimbRaycastPosition);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.endClimbRaycastPosition,this.forwardDirection.scale(this.rayClimbLength));this.endClimbRaycastPosition.y+=this.rayClimbOffset;if(raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){const checkTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);if(checkTag===this.climbVolumeTag){this.climbContact=true;this.climbContactNode=raycast.collisionObject.entity;if(raycast.hitPoint!=null)this.climbContactPoint.copyFrom(raycast.hitPoint);if(raycast.hitNormal!=null)this.climbContactNormal.copyFrom(raycast.hitNormal);this.climbContactAngle=(this.climbContactNormal!=null)?Math.abs(TOOLKIT.Utilities.GetAngle(this.climbContactNormal,BABYLON.Vector3.UpReadOnly)):0;this.climbContactDistance=raycast.hitDistance}}if(this.showDebugColliders===true){if(this.climbSensorLine==null)this.climbSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".ClimbingSensorLine",this.scene);if(this.climbContact===true){this.climbSensorLine.drawLine([this.startClimbRaycastPosition,raycast.hitPoint],BABYLON.Color3.Red())}else{this.climbSensorLine.drawLine([this.startClimbRaycastPosition,this.endClimbRaycastPosition],BABYLON.Color3.Green())}}}castPhysicsHeightCheckVolumeRay(){let raycast=null;this.heightContact=false;this.heightContactNode=null;this.heightContactPoint.set(0,0,0);this.heightContactNormal.set(0,0,0);this.heightContactAngle=0;this.heightContactDistance=0;const playerTransformHeightDirection=TOOLKIT.Utilities.TransformDirection(this.transform,this.downDirection);if(this.climbContact===true){this.endHeightRaycastPosition.copyFrom(this.climbContactPoint);this.startHeightRaycastPosition.copyFrom(this.climbContactPoint);this.startHeightRaycastPosition.addInPlace(BABYLON.Vector3.UpReadOnly.scale(this.rayHeightLength))}else{this.offsetHeightRaycastPosition.set(0,this.rayHeightOffset,this.rayClimbLength);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.startHeightRaycastPosition,this.offsetHeightRaycastPosition);this.endHeightRaycastPosition.copyFrom(this.startHeightRaycastPosition);this.endHeightRaycastPosition.addInPlace(this.downDirection.scale(this.rayHeightLength))}if(raycast!=null&&raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){const checkTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);if(checkTag===this.climbVolumeTag){this.heightContact=true;this.heightContactNode=raycast.collisionObject.entity;if(raycast.hitPoint!=null)this.heightContactPoint.copyFrom(raycast.hitPoint);if(raycast.hitNormal!=null)this.heightContactNormal.copyFrom(raycast.hitNormal);this.heightContactAngle=(this.heightContactNormal!=null)?Math.abs(TOOLKIT.Utilities.GetAngle(this.heightContactNormal,BABYLON.Vector3.UpReadOnly)):0;this.heightContactDistance=raycast.hitDistance}}if(this.showDebugColliders===true){if(this.heightSensorLine==null)this.heightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".HeightCheckSensorLine",this.scene);if(raycast!=null&&this.heightContact===true){this.heightSensorLine.drawLine([this.startHeightRaycastPosition,raycast.hitPoint],BABYLON.Color3.Red())}else{this.heightSensorLine.drawLine([this.startHeightRaycastPosition,this.endHeightRaycastPosition],BABYLON.Color3.Green())}}}getCheckedVerticalVelocity(){const currentVelocity=(this.characterController!=null)?this.characterController.getVerticalVelocity():0;return(Math.abs(currentVelocity)>=PROJECT.StandardPlayerController.MIN_VERTICAL_VELOCITY)?currentVelocity:0}destroyPlayerController(){this.cameraPivot=null;this.cameraNode=null;this.animationState=null;this.characterController=null;this.onPreUpdateObservable.clear();this.onPreUpdateObservable=null;this.onBeforeMoveObservable.clear();this.onBeforeMoveObservable=null;this.onPostUpdateObservable.clear();this.onPostUpdateObservable=null}validateAnimationStateParams(){if(this.animationStateParams==null){this.animationStateParams={moveDirection:"Direction",inputMagnitude:"Magnitude",horizontalInput:"Horizontal",verticalInput:"Vertical",mouseXInput:"MouseX",mouseYInput:"MouseY",heightInput:"Height",speedInput:"Speed",jumpFrame:"Jumped",jumpState:"Jump",actionState:"Action",fallingState:"FreeFall",slidingState:"Sliding",groundedState:"Grounded"}}}}PROJECT.StandardPlayerController=StandardPlayerController;let PlayerInputControl;(function(PlayerInputControl){PlayerInputControl[PlayerInputControl["FirstPersonStrafing"]=0]="FirstPersonStrafing";PlayerInputControl[PlayerInputControl["ThirdPersonStrafing"]=1]="ThirdPersonStrafing"})(PlayerInputControl=PROJECT.PlayerInputControl||(PROJECT.PlayerInputControl={}));let PlayerMoveDirection;(function(PlayerMoveDirection){PlayerMoveDirection[PlayerMoveDirection["Stationary"]=0]="Stationary";PlayerMoveDirection[PlayerMoveDirection["Forward"]=1]="Forward";PlayerMoveDirection[PlayerMoveDirection["ForwardLeft"]=2]="ForwardLeft";PlayerMoveDirection[PlayerMoveDirection["ForwardRight"]=3]="ForwardRight";PlayerMoveDirection[PlayerMoveDirection["Backward"]=4]="Backward";PlayerMoveDirection[PlayerMoveDirection["BackwardLeft"]=5]="BackwardLeft";PlayerMoveDirection[PlayerMoveDirection["BackwardRight"]=6]="BackwardRight";PlayerMoveDirection[PlayerMoveDirection["StrafingLeft"]=7]="StrafingLeft";PlayerMoveDirection[PlayerMoveDirection["StrafingRight"]=8]="StrafingRight"})(PlayerMoveDirection=PROJECT.PlayerMoveDirection||(PROJECT.PlayerMoveDirection={}));let ActionAnimationType;(function(ActionAnimationType){ActionAnimationType[ActionAnimationType["Neutral"]=0]="Neutral";ActionAnimationType[ActionAnimationType["StepUp"]=1]="StepUp";ActionAnimationType[ActionAnimationType["JumpUp"]=2]="JumpUp";ActionAnimationType[ActionAnimationType["ClimbUp"]=3]="ClimbUp";ActionAnimationType[ActionAnimationType["VaultOver"]=4]="VaultOver"})(ActionAnimationType=PROJECT.ActionAnimationType||(PROJECT.ActionAnimationType={}));TOOLKIT.SceneManager.RegisterClass("PROJECT.StandardPlayerController",StandardPlayerController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class ThirdPersonPlayerController extends TOOLKIT.ScriptComponent{static MIN_VERTICAL_VELOCITY=0.01;static MIN_GROUND_DISTANCE=0.15;static MIN_MOVE_EPSILON=0.001;static MIN_TIMER_OFFSET=0;static MIN_SLOPE_LIMIT=0;static PLAYER_HEIGHT="playerHeight";enableInput=false;attachCamera=false;mouseWheel=true;requireSprintButton=false;gravitationalForce=3.0;minFallVelocity=1.0;verticalStepSpeed=1.0;minStepUpHeight=0.15;rigidBodyMass=85.0;airbornTimeout=0.5;maxAngle=45;speedFactor=1.0;rootMotion=false;moveSpeed=5.335;walkSpeed=2.0;jumpSpeed=10.0;jumpDelay=0.25;lowTurnSpeed=15.0;highTurnSpeed=25.0;smoothInputTime=0;smoothInputVectors=false;smoothAcceleration=false;accelerationSpeed=0.1;decelerationSpeed=0.1;climbVolumeTag="Climb";vaultVolumeTag="Vault";maxHeightRanges=null;useClimbSystem=false;distanceFactor=0.85;inputMagnitude=0;landingEpsilon=0.1;minimumDistance=0.5;movementAllowed=true;playerInputX=0;playerInputZ=0;playerMouseX=0;playerMouseY=0;runKeyRequired=true;buttonRun=BABYLON.Xbox360Button.LeftStick;keyboardRun=TOOLKIT.UserInputKey.Shift;buttonJump=BABYLON.Xbox360Button.A;keyboardJump=TOOLKIT.UserInputKey.SpaceBar;buttonCamera=BABYLON.Xbox360Button.Y;keyboardCamera=TOOLKIT.UserInputKey.P;postNetworkAttributes=false;playerNumber=TOOLKIT.PlayerNumber.One;airbornVelocity=new BABYLON.Vector3(0,0,0);movementVelocity=new BABYLON.Vector3(0,0,0);isAnimationEnabled(){return this.updateStateParams}isRunButtonPressed(){return this.isRunPressed}isJumpButtonPressed(){return this.isJumpPressed}getPlayerJumped(){return this.isCharacterJumpFrame}getPlayerJumping(){return this.isCharacterJumping}getPlayerFalling(){return this.isCharacterFalling}getPlayerSliding(){return this.isCharacterSliding}getPlayerGrounded(){return this.isCharacterGrounded}getFallTriggered(){return this.isCharacterFallTriggered}getMovementSpeed(){return this.movementSpeed}getAnimationSpeed(){return this.animationSpeed}getAnimationState(){return this.animationState}getVerticalVelocity(){return this.getCheckedVerticalVelocity()}getCharacterController(){return this.characterController}getPlayerLookRotation(){return this.playerLookRotation}getPlayerMoveDirection(){return this.playerMoveDirection}getInputMovementVector(){return this.inputMovementVector}getInputMagnitudeValue(){return this.inputMagnitude}rayClimbOffset=0.35;rayClimbLength=0.85;getClimbContact(){return this.climbContact}getClimbContactNode(){return this.climbContactNode}getClimbContactPoint(){return this.climbContactPoint}getClimbContactAngle(){return this.climbContactAngle}getClimbContactNormal(){return this.climbContactNormal}getClimbContactDistance(){return this.climbContactDistance}canClimbObstaclePredicate=null;rayHeightOffset=5.0;rayHeightLength=6.0;getHeightContact(){return this.heightContact}getHeightContactNode(){return this.heightContactNode}getHeightContactPoint(){return this.heightContactPoint}getHeightContactAngle(){return this.heightContactAngle}getHeightContactNormal(){return this.heightContactNormal}getHeightContactDistance(){return this.heightContactDistance}freeCamera=null;cameraForwardVector=new BABYLON.Vector3(0,0,0);cameraRightVector=new BABYLON.Vector3(0,0,0);desiredForwardVector=new BABYLON.Vector3(0,0,0);desiredRightVector=new BABYLON.Vector3(0,0,0);lastRotationQuaternion=new BABYLON.Quaternion(0,0,0,1);avatarSkins=null;avatarRadius=0.5;navigationAgent=null;characterController=null;verticalVelocity=0;smoothMotionSpeed=false;smoothChangeRate=25;animationSpeed=0;movementSpeed=0;isRunPressed=false;isJumpPressed=false;isCharacterSliding=false;isCharacterFalling=false;isCharacterGrounded=false;isCharacterFallTriggered=false;isCharacterJumpFrame=false;isCharacterJumping=false;isCharacterRising=false;isCharacterLanding=false;isCharacterNavigating=false;navigationAngularSpeed=0;updateStateParams=true;animationStateParams=null;sphereCollisionShape=null;hasGroundedContact=false;showDebugColliders=false;colliderVisibility=0;colliderRenderGroup=0;groundCheckDistance=0.25;deltaTime=0;delayJumpTimer=0;canPlayerJump=true;animationState=null;lastJumpVelocity=new BABYLON.Vector3(0,0,0);inputMovementVector=new BABYLON.Vector3(0,0,0);playerLookRotation=new BABYLON.Vector3(0,0,0);playerMovementVelocity=new BABYLON.Vector3(0,0,0);playerRotationQuaternion=BABYLON.Quaternion.Zero();playerMoveDirection=PROJECT.PlayerMoveDirection.Stationary;forwardDirection=new BABYLON.Vector3(0,0,1);downDirection=new BABYLON.Vector3(0,-1,0);climbContact=false;climbContactNode=null;climbContactAngle=0;climbContactPoint=new BABYLON.Vector3(0,0,0);climbContactNormal=new BABYLON.Vector3(0,0,0);climbContactDistance=0;climbSensorLine=null;offsetClimbRaycastPosition=new BABYLON.Vector3(0,0,0);startClimbRaycastPosition=new BABYLON.Vector3(0,0,0);endClimbRaycastPosition=new BABYLON.Vector3(0,0,0);heightContact=false;heightContactNode=null;heightContactAngle=0;heightContactPoint=new BABYLON.Vector3(0,0,0);heightContactNormal=new BABYLON.Vector3(0,0,0);heightContactDistance=0;heightSensorLine=null;offsetHeightRaycastPosition=new BABYLON.Vector3(0,0,0);startHeightRaycastPosition=new BABYLON.Vector3(0,0,0);endHeightRaycastPosition=new BABYLON.Vector3(0,0,0);m_velocityOffset=new BABYLON.Vector3(0,0,0);m_actualVelocity=new BABYLON.Vector3(0,0,0);m_linearVelocity=new BABYLON.Vector3(0,0,0);m_lastPosition=new BABYLON.Vector3(0,0,0);m_positionCenter=new BABYLON.Vector3(0,0,0);m_scaledVelocity=0;playerDrawVelocity=0;constructor(transform,scene,properties,alias="PROJECT.ThirdPersonPlayerController"){super(transform,scene,properties,alias)}awake(){this.awakePlayerController()}start(){this.startPlayerController()}after(){this.afterPlayerController()}update(){this.updatePlayerController()}destroy(){this.destroyPlayerController()}boomPosition=new BABYLON.Vector3(0,0,-5);onPreUpdateObservable=new BABYLON.Observable;onBeforeMoveObservable=new BABYLON.Observable;onPostUpdateObservable=new BABYLON.Observable;onPlayerInputObservable=new BABYLON.Observable;onPlayerPositionObservable=new BABYLON.Observable;onUpdateActionObservable=new BABYLON.Observable;onAnimationStateObservable=new BABYLON.Observable;_deltaMotionPosition=new BABYLON.Vector3(0,0,0);getDeltaMotionPosition(){this._deltaMotionPosition.set(0,0,0);if(this.animationState!=null){const rootMotionPosition=this.animationState.getDeltaRootMotionPosition();if(rootMotionPosition!=null){this._deltaMotionPosition.copyFrom(rootMotionPosition)}}return this._deltaMotionPosition}_deltaMotionRotation=new BABYLON.Quaternion(0,0,0,0);getDeltaMotionRotation(){this._deltaMotionRotation.set(0,0,0,0);if(this.animationState!=null){const rootMotionRotation=this.animationState.getDeltaRootMotionRotation();if(rootMotionRotation!=null){this._deltaMotionRotation.copyFrom(rootMotionRotation)}}return this._deltaMotionRotation}isPerformingAction=false;isRootMotionAction=false;isActionInterruptable=false;afterActionHandler=null;performActionTimer=0;performActionNumber=0;playerRotationSpeed=10;rotatePlayerTowards=false;matchStartTime=0;matchTargetTime=0;matchTargetOffset=0;matchTargetHeight=false;lockTargetHeight=false;lastStartHeight=null;lastTargetHeight=null;lastTargetNormal=new BABYLON.Vector3(0,0,0);lastTargetRotation=new BABYLON.Quaternion(0,0,0,1);lastDeltaPosition=new BABYLON.Vector3(0,0,0);lastDeltaRotation=new BABYLON.Quaternion(0,0,0,1);getIsPerformingAction(){return this.isPerformingAction}getIsRootMotionAction(){return this.isRootMotionAction}getIsActionInterruptable(){return this.isActionInterruptable}playActionAnimation(action,interruptableAction=true,enableRootMotion=false,afterActionComplete=null){if(this.isPerformingAction===false&&this.animationState!=null&&action>=0){this.isPerformingAction=true;this.performActionTimer=0;this.performActionNumber=action;this.afterActionHandler=afterActionComplete;this.isActionInterruptable=interruptableAction;this.isRootMotionAction=enableRootMotion;this.playerRotationSpeed=10;this.rotatePlayerTowards=false;this.matchStartTime=0;this.matchTargetTime=0;this.matchTargetOffset=0;this.matchTargetHeight=false;this.lockTargetHeight=false;this.lastStartHeight=null;this.lastTargetHeight=null;this.lastTargetNormal.set(0,0,0);this.lastTargetRotation.set(0,0,0,1);if(this.isRootMotionAction===true){this.enableCharacterController(false)}}}resetActionAnimationState(){if(this.afterActionHandler!=null){try{this.afterActionHandler()}catch{}}if(this.isRootMotionAction===true){this.enableCharacterController(true)}this.performActionTimer=0;this.performActionNumber=0;this.isPerformingAction=false;this.isRootMotionAction=false;this.isActionInterruptable=false;this.afterActionHandler=null;this.playerRotationSpeed=10;this.rotatePlayerTowards=false;this.matchStartTime=0;this.matchTargetTime=0;this.matchTargetOffset=0;this.matchTargetHeight=false;this.lockTargetHeight=false;this.lastStartHeight=null;this.lastTargetHeight=null;this.lastTargetNormal.set(0,0,0);this.lastTargetRotation.set(0,0,0,1)}updateAnimationActionState(){const deltaTime=this.getDeltaSeconds();const dampTime=(this.matchTargetTime-this.matchStartTime);if(this.animationState!=null&&this.isRootMotionAction===true){const playerGlobalHeight=this.transform.absolutePosition.y;this.lastDeltaPosition.copyFrom(this.getDeltaMotionPosition());BABYLON.Vector3.TransformNormalToRef(this.lastDeltaPosition,this.transform.getWorldMatrix(),this.lastDeltaPosition);if(this.matchTargetHeight===true){if(this.lastStartHeight==null&&this.performActionTimer>=this.matchStartTime){this.lastStartHeight=playerGlobalHeight}if(this.lastStartHeight!=null&&this.lastTargetHeight!=null){this.lastDeltaPosition.y=0;const fixedTargetHeight=(this.lastTargetHeight+this.matchTargetOffset);if(this.performActionTimer<this.matchTargetTime){this.animationState.setSmoothFloat(PROJECT.ThirdPersonPlayerController.PLAYER_HEIGHT,fixedTargetHeight,(dampTime*deltaTime));const smoothPlayerHeight=this.animationState.getFloat(PROJECT.ThirdPersonPlayerController.PLAYER_HEIGHT);this.lastDeltaPosition.y=(smoothPlayerHeight-playerGlobalHeight)}else if(this.lockTargetHeight===false&&this.performActionTimer>=this.matchTargetTime){this.lastDeltaPosition.y=(fixedTargetHeight-playerGlobalHeight);this.lockTargetHeight=true}}}this.transform.position.addInPlace(this.lastDeltaPosition);if(this.rotatePlayerTowards===true){if(this.climbContact===true){this.lastTargetNormal.set(-this.climbContactNormal.x,-this.climbContactNormal.y,-this.climbContactNormal.z);TOOLKIT.Utilities.LookRotationToRef(this.lastTargetNormal,this.lastTargetRotation);const lerpAmount=BABYLON.Scalar.Clamp(this.playerRotationSpeed*deltaTime);BABYLON.Quaternion.SlerpToRef(this.transform.rotationQuaternion,this.lastTargetRotation,lerpAmount,this.transform.rotationQuaternion)}}else{this.lastDeltaRotation.copyFrom(this.getDeltaMotionRotation());this.transform.rotationQuaternion.multiplyInPlace(this.lastDeltaRotation)}}this.performActionTimer+=deltaTime}setWorldPosition(x,y,z){if(this.characterController!=null){this.characterController.set(x,y,z)}}ikLeftFootTarget=null;ikLeftPoleTarget=null;ikRightFootTarget=null;ikRightPoleTarget=null;abstractSkinMesh=null;rootBoneTransform=null;leftFootTransform=null;leftFootPoleOffset=new BABYLON.Vector3(-0.1,0.5,0.5);leftFootMaxAngle=90;rightFootTransform=null;rightFootPoleOffset=new BABYLON.Vector3(0.1,0.5,0.5);rightFootMaxAngle=90;ikLeftController=null;ikRightController=null;onAnimatorIK=null;getPlayerMesh(){return this.abstractSkinMesh}getRootHipBone(){return(this.rootBoneTransform!=null)?this.rootBoneTransform._linkedBone:null}getLeftFootBone(){return(this.leftFootTransform!=null)?this.leftFootTransform._linkedBone:null}getRightFootBone(){return(this.rightFootTransform!=null)?this.rightFootTransform._linkedBone:null}getLeftFootTarget(){return this.ikLeftFootTarget}getRightFootTarget(){return this.ikRightFootTarget}getLeftFootPoleTarget(){return this.ikLeftPoleTarget}getRightFootPoleTarget(){return this.ikRightPoleTarget}getRootBoneTransform(){return this.rootBoneTransform}getLeftFootTransform(){return this.leftFootTransform}getRightFootTransform(){return this.rightFootTransform}getLeftFootController(){return this.ikLeftController}getRightFootController(){return this.ikRightController}isGroundedFootIKActive(){return(this.isCharacterGrounded===true&&this.animationState!=null&&this.animationState.ikFrameEnabled())}setupBoneControllers(){const createFootIKRig=this.getProperty("createFootIKRig");if(createFootIKRig===true){const displayHandles=this.getProperty("displayHandles");const abstractSkinMeshData=this.getProperty("abstractSkinMesh");if(abstractSkinMeshData!=null)this.abstractSkinMesh=this.getChildNode(abstractSkinMeshData.name,TOOLKIT.SearchType.ExactMatch,false);const rootBoneTransformData=this.getProperty("rootBoneTransform");if(rootBoneTransformData!=null)this.rootBoneTransform=this.getChildNode(rootBoneTransformData.name,TOOLKIT.SearchType.ExactMatch,false);const leftFootTransformData=this.getProperty("leftFootTransform");if(leftFootTransformData!=null)this.leftFootTransform=this.getChildNode(leftFootTransformData.name,TOOLKIT.SearchType.ExactMatch,false);const leftPoleHandleData=this.getProperty("leftFootPoleOffset");if(leftPoleHandleData!=null)this.leftFootPoleOffset.copyFrom(TOOLKIT.Utilities.ParseVector3(leftPoleHandleData));this.leftFootMaxAngle=this.getProperty("leftFootMaxAngle",this.leftFootMaxAngle);const rightFootTransformData=this.getProperty("rightFootTransform");if(rightFootTransformData!=null)this.rightFootTransform=this.getChildNode(rightFootTransformData.name,TOOLKIT.SearchType.ExactMatch,false);const rightPoleHandleData=this.getProperty("rightFootPoleOffset");if(rightPoleHandleData!=null)this.rightFootPoleOffset.copyFrom(TOOLKIT.Utilities.ParseVector3(rightPoleHandleData));this.rightFootMaxAngle=this.getProperty("rightFootMaxAngle",this.rightFootMaxAngle);if(this.abstractSkinMesh!=null&&this.rootBoneTransform!=null){let materialName="M_TARGET_MESH";let targetMaterial=this.scene.getMaterialByName(materialName);if(targetMaterial==null){targetMaterial=new BABYLON.StandardMaterial("M_TARGET_MESH",this.scene);targetMaterial.diffuseColor=new BABYLON.Color3(1.0,0.5,0.25)}if(this.leftFootTransform!=null&&this.leftFootTransform._linkedBone!=null){this.ikLeftFootTarget=BABYLON.MeshBuilder.CreateBox(this.transform.name+".LeftFootTarget",{width:0.1,height:0.1,depth:0.1},this.scene);this.ikLeftFootTarget.parent=this.leftFootTransform;this.ikLeftFootTarget.position.set(0,0,0);this.ikLeftFootTarget.material=targetMaterial;this.ikLeftFootTarget.isVisible=displayHandles;this.ikLeftPoleTarget=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".LeftFootPole",{diameter:0.1},this.scene);this.ikLeftPoleTarget.parent=this.abstractSkinMesh;this.ikLeftPoleTarget.position.copyFrom(this.leftFootPoleOffset);this.ikLeftPoleTarget.isVisible=displayHandles}if(this.rightFootTransform!=null&&this.rightFootTransform._linkedBone!=null){this.ikRightFootTarget=BABYLON.MeshBuilder.CreateBox(this.transform.name+".RightFootTarget",{width:0.1,height:0.1,depth:0.1},this.scene);this.ikRightFootTarget.parent=this.rightFootTransform;this.ikRightFootTarget.position.set(0,0,0);this.ikRightFootTarget.material=targetMaterial;this.ikRightFootTarget.isVisible=displayHandles;this.ikRightPoleTarget=BABYLON.MeshBuilder.CreateSphere(this.transform.name+".RightFootPole",{diameter:0.1},this.scene);this.ikRightPoleTarget.parent=this.abstractSkinMesh;this.ikRightPoleTarget.position.copyFrom(this.rightFootPoleOffset);this.ikRightPoleTarget.isVisible=displayHandles}}}}attachAnimationController(){if(this.animationState==null){this.animationState=this.getComponent("TOOLKIT.AnimationState",true)}if(this.animationState!=null){this.animationState.onAnimationEndObservable.add(()=>{if(this.isPerformingAction===true){this.resetActionAnimationState()}});this.animationState.onAnimationUpdateObservable.add(()=>{if(this.onAnimatorIK!=null){this.onAnimatorIK()}else{this.updateAnimatorTargetMeshes();if(this.ikLeftController!=null){this.ikLeftController.update()}if(this.ikRightController!=null){this.ikRightController.update()}}})}}updateAnimatorTargetMeshes(){}enableCharacterController(state){if(state===true){this.movementAllowed=true;this.resetPlayerJumpingState();if(this.characterController!=null){this.characterController.setGravityFactor(this.gravitationalForce);this.characterController.setCollisionState(true)}}else{this.movementAllowed=false;this.resetPlayerJumpingState();if(this.characterController!=null){this.characterController.setGravityFactor(0);this.characterController.setCollisionState(false)}}}resetPlayerJumpingState(){this.isCharacterJumping=false;this.isCharacterLanding=false;this.isCharacterRising=false;this.isCharacterJumpFrame=false;if(this.characterController!=null){this.characterController.jump(0)}}awakePlayerController(){this.gravitationalForce=this.getProperty("gravityMultiplier",this.gravitationalForce);this.verticalStepSpeed=this.getProperty("stepUpVelocity",this.verticalStepSpeed);this.minStepUpHeight=this.getProperty("minStepHeight",this.minStepUpHeight);this.rigidBodyMass=this.getProperty("rigidBodyMass",this.rigidBodyMass);this.mouseWheel=this.getProperty("mouseWheel",this.mouseWheel);this.rayClimbLength=this.getProperty("rayClimbLength",this.rayClimbLength);this.rayClimbOffset=this.getProperty("rayClimbOffset",this.rayClimbOffset);this.rayHeightLength=this.getProperty("rayHeightLength",this.rayHeightLength);this.rayHeightOffset=this.getProperty("rayHeightOffset",this.rayHeightOffset);this.maxAngle=this.getProperty("maxAngle",this.maxAngle);this.landingEpsilon=this.getProperty("landingEpsilon",this.landingEpsilon);this.minFallVelocity=this.getProperty("minFallVelocity",this.minFallVelocity);this.airbornTimeout=this.getProperty("airbornTimeout",this.airbornTimeout);this.rootMotion=this.getProperty("rootMotion",this.rootMotion);this.moveSpeed=this.getProperty("moveSpeed",this.moveSpeed);this.walkSpeed=this.getProperty("walkSpeed",this.walkSpeed);this.jumpSpeed=this.getProperty("jumpSpeed",this.jumpSpeed);this.jumpDelay=this.getProperty("jumpDelay",this.jumpDelay);this.lowTurnSpeed=this.getProperty("lowTurnSpeed",this.lowTurnSpeed);this.highTurnSpeed=this.getProperty("highTurnSpeed",this.highTurnSpeed);this.enableInput=this.getProperty("enableInput",this.enableInput);this.attachCamera=this.getProperty("attachCamera",this.attachCamera);this.playerNumber=this.getProperty("playerNumber",this.playerNumber);this.runKeyRequired=this.getProperty("runKeyRequired",this.runKeyRequired);this.distanceFactor=this.getProperty("distanceFactor",this.distanceFactor);this.minimumDistance=this.getProperty("minimumDistance",this.minimumDistance);this.smoothInputTime=this.getProperty("smoothInputTime",this.smoothInputTime);this.smoothInputVectors=this.getProperty("smoothInputVectors",this.smoothInputVectors);this.smoothAcceleration=this.getProperty("smoothAcceleration",this.smoothAcceleration);this.accelerationSpeed=this.getProperty("accelerationSpeed",this.accelerationSpeed);this.decelerationSpeed=this.getProperty("decelerationSpeed",this.decelerationSpeed);this.climbVolumeTag=this.getProperty("climbVolumeTag",this.climbVolumeTag);this.vaultVolumeTag=this.getProperty("vaultVolumeTag",this.vaultVolumeTag);this.useClimbSystem=this.getProperty("useClimbSystem",this.useClimbSystem);this.maxHeightRanges=this.getProperty("maxHeightRanges",this.maxHeightRanges);this.smoothMotionSpeed=this.getProperty("smoothMotionSpeed",this.smoothMotionSpeed);this.smoothChangeRate=this.getProperty("smoothChangeRate",this.smoothChangeRate);this.updateStateParams=this.getProperty("updateStateParams",this.updateStateParams);this.animationStateParams=this.getProperty("animationStateParams",this.animationStateParams);this.postNetworkAttributes=this.getProperty("postNetworkAttribs",this.postNetworkAttributes);this.groundCheckDistance=this.getProperty("groundCheckDist",this.groundCheckDistance);const arrowKeyRotation=this.getProperty("arrowKeyRotation");if(arrowKeyRotation===true)TOOLKIT.UserInputOptions.UseArrowKeyRotation=true;this.setupBoneControllers()}startPlayerController(){if(this.attachCamera===true){PROJECT.DefaultCameraSystem.SetAutoUpdate(false);PROJECT.DefaultCameraSystem.SetFollowTarget(this.transform)}this.navigationAgent=this.getComponent("TOOLKIT.NavigationAgent");this.characterController=this.getComponent("TOOLKIT.CharacterController");if(this.characterController!=null){this.avatarRadius=this.characterController.getAvatarRadius();this.characterController.enableGravity=true;this.characterController.enableStepOffset=true;this.characterController.useMultiRaycast=true;this.characterController.multiRaycastCount=5;this.characterController.stepUpVelocityFactor=0.5;this.characterController.groundCheckDistance=this.groundCheckDistance;this.characterController.setRigidBodyMass(this.rigidBodyMass);this.characterController.setGravityFactor(this.gravitationalForce);this.characterController.onUpdatePositionObservable.add(()=>{this.updatePlayerPosition();if(this.attachCamera===true){PROJECT.DefaultCameraSystem.UpdateFollowTarget()}});TOOLKIT.SceneManager.LogWarning("Starting player controller in physic engine mode for: "+this.transform.name)}else{TOOLKIT.SceneManager.LogWarning("No character controller found for: "+this.transform.name)}}updatePlayerPosition(){if(this.onPlayerPositionObservable&&this.onPlayerPositionObservable.hasObservers()){this.onPlayerPositionObservable.notifyObservers(this.transform)}}updatePlayerController(){this.deltaTime=this.getDeltaSeconds();if(!this.isReady())return;this.m_actualVelocity=this.transform.absolutePosition.subtract(this.m_lastPosition);this.m_linearVelocity.copyFrom(this.m_actualVelocity);this.m_scaledVelocity=(this.m_linearVelocity.length()/this.deltaTime);this.m_linearVelocity.normalize();this.m_linearVelocity.scaleInPlace(this.m_scaledVelocity);if(this.playerDrawVelocity>0){this.m_velocityOffset.copyFrom(this.m_linearVelocity);this.m_velocityOffset.scaleInPlace(this.playerDrawVelocity)}else{this.m_velocityOffset.set(0,0,0)}this.m_lastPosition.copyFrom(this.transform.absolutePosition);if(this.updateStateParams===true&&this.animationState==null){this.attachAnimationController()}if(this.isCharacterGrounded===true&&this.delayJumpTimer>0){this.delayJumpTimer-=this.deltaTime;if(this.delayJumpTimer<0)this.delayJumpTimer=0}this.canPlayerJump=true;if(this.isPerformingAction===true){this.updateAnimationActionState();if(this.onUpdateActionObservable&&this.onUpdateActionObservable.hasObservers()){this.onUpdateActionObservable.notifyObservers(this.transform)}}if(this.enableInput===false){return}const userInputX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Horizontal,this.playerNumber);const userInputZ=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.Vertical,this.playerNumber);const userMouseX=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseX,this.playerNumber);const userMouseY=TOOLKIT.InputController.GetUserInput(TOOLKIT.UserInputAxis.MouseY,this.playerNumber);if(this.smoothAcceleration===true){if(userInputX>0){this.playerInputX+=(this.accelerationSpeed*this.deltaTime);if(this.playerInputX>1)this.playerInputX=1}else if(userInputX<0){this.playerInputX-=(this.accelerationSpeed*this.deltaTime);if(this.playerInputX<-1)this.playerInputX=-1}else{if(this.playerInputX<0){this.playerInputX+=(this.decelerationSpeed*this.deltaTime);if(this.playerInputX>0)this.playerInputX=0}else if(this.playerInputX>0){this.playerInputX-=(this.decelerationSpeed*this.deltaTime);if(this.playerInputX<0)this.playerInputX=0}}if(userInputZ>0){this.playerInputZ+=(this.accelerationSpeed*this.deltaTime);if(this.playerInputZ>1)this.playerInputZ=1}else if(userInputZ<0){this.playerInputZ-=(this.accelerationSpeed*this.deltaTime);if(this.playerInputZ<-1)this.playerInputZ=-1}else{if(this.playerInputZ<0){this.playerInputZ+=(this.decelerationSpeed*this.deltaTime);if(this.playerInputZ>0)this.playerInputZ=0}else if(this.playerInputZ>0){this.playerInputZ-=(this.decelerationSpeed*this.deltaTime);if(this.playerInputZ<0)this.playerInputZ=0}}}else{this.playerInputX=userInputX;this.playerInputZ=userInputZ}this.playerMouseX=userMouseX;this.playerMouseY=userMouseY;if(this.isPerformingAction===true&&this.isActionInterruptable===true){if(this.playerInputX!==0||this.playerInputZ!==0){this.resetActionAnimationState()}}if(this.isPerformingAction===true){this.canPlayerJump=false;this.playerInputX=0;this.playerInputZ=0}if(this.onPlayerInputObservable&&this.onPlayerInputObservable.hasObservers()){this.onPlayerInputObservable.notifyObservers(this.transform)}this.inputMovementVector.set(this.playerInputX,0,this.playerInputZ);if(this.inputMovementVector.length()>1.0)this.inputMovementVector.normalize();this.inputMagnitude=this.inputMovementVector.length();const moveForward=(this.playerInputZ>0);const moveBackward=(this.playerInputZ<0);const moveRight=(this.playerInputX>0);const moveLeft=(this.playerInputX<0);if(moveForward===true){if(moveLeft===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.ForwardLeft}else if(moveRight===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.ForwardRight}else{this.playerMoveDirection=PROJECT.PlayerMoveDirection.Forward}}else if(moveBackward===true){if(moveLeft===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.BackwardLeft}else if(moveRight===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.BackwardRight}else{this.playerMoveDirection=PROJECT.PlayerMoveDirection.Backward}}else if(moveLeft===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.StrafingLeft}else if(moveRight===true){this.playerMoveDirection=PROJECT.PlayerMoveDirection.StrafingRight}else{this.playerMoveDirection=PROJECT.PlayerMoveDirection.Stationary}if(this.onPreUpdateObservable&&this.onPreUpdateObservable.hasObservers()){this.onPreUpdateObservable.notifyObservers(this.transform)}if(this.freeCamera==null)this.freeCamera=PROJECT.DefaultCameraSystem.GetMainCamera(this.scene,false);if(this.freeCamera==null)this.freeCamera=this.scene.activeCamera;this.cameraForwardVector=this.freeCamera.getForwardRay().direction;this.cameraForwardVector.y=0;this.cameraForwardVector.normalize();this.cameraForwardVector.scaleToRef(this.inputMovementVector.z,this.desiredForwardVector);this.cameraRightVector=BABYLON.Vector3.Cross(this.cameraForwardVector,BABYLON.Vector3.Up());this.cameraRightVector.y=0;this.cameraRightVector.normalize();this.cameraRightVector.scaleToRef(-this.inputMovementVector.x,this.desiredRightVector);if(this.movementAllowed===false){this.canPlayerJump=false;this.playerInputX=0;this.playerInputZ=0}this.isRunPressed=(TOOLKIT.InputController.GetKeyboardInput(this.keyboardRun)||TOOLKIT.InputController.GetGamepadButtonInput(this.buttonRun));this.isJumpPressed=(TOOLKIT.InputController.GetKeyboardInput(this.keyboardJump)||TOOLKIT.InputController.GetGamepadButtonInput(this.buttonJump));this.movementSpeed=(this.inputMagnitude*this.moveSpeed*this.speedFactor);if(this.runKeyRequired===true&&this.isRunPressed===false){this.movementSpeed=BABYLON.Scalar.Clamp(this.movementSpeed,0,this.walkSpeed)}if(this.smoothMotionSpeed===true){this.animationSpeed=BABYLON.Scalar.Lerp(this.animationSpeed,this.movementSpeed,(this.deltaTime*this.smoothChangeRate));if(this.animationSpeed<0.01)this.animationSpeed=0}else{this.animationSpeed=this.movementSpeed}this.desiredForwardVector.addToRef(this.desiredRightVector,this.playerMovementVelocity);this.playerLookRotation.copyFrom(this.playerMovementVelocity);this.playerMovementVelocity.scaleInPlace(this.movementSpeed);this.transform.rotationQuaternion.copyFrom(this.lastRotationQuaternion);if(this.movementAllowed==true){if(this.inputMagnitude>0){TOOLKIT.Utilities.LookRotationToRef(this.playerLookRotation,this.playerRotationQuaternion);const forwardTurnRatio=(this.playerLookRotation.length()/this.moveSpeed);const forwardTurnSpeed=BABYLON.Scalar.Lerp(this.highTurnSpeed,this.lowTurnSpeed,forwardTurnRatio);const rotationDelta=Math.abs(BABYLON.Quaternion.Dot(this.transform.rotationQuaternion,this.playerRotationQuaternion));const adaptiveRotationSpeed=rotationDelta<0.85?forwardTurnSpeed*0.85:forwardTurnSpeed;BABYLON.Quaternion.SlerpToRef(this.transform.rotationQuaternion,this.playerRotationQuaternion,(adaptiveRotationSpeed*this.deltaTime),this.transform.rotationQuaternion);this.lastRotationQuaternion.copyFrom(this.transform.rotationQuaternion)}}this.verticalVelocity=this.getVerticalVelocity();this.movementVelocity.copyFrom(this.playerMovementVelocity);this.hasGroundedContact=(this.characterController!=null)?this.characterController.isGrounded():false;this.isCharacterGrounded=false;this.isCharacterSliding=false;this.isCharacterFalling=false;this.isCharacterJumpFrame=false;this.isCharacterNavigating=(this.navigationAgent!=null&&this.navigationAgent.isNavigating());this.navigationAngularSpeed=(this.navigationAgent!=null)?this.navigationAgent.angularSpeed:0;this.updateCharacterController();if(this.animationState!=null&&this.updateStateParams===true){this.validateAnimationStateParams();this.animationState.setInteger(this.animationStateParams.moveDirection,this.playerMoveDirection);this.animationState.setFloat(this.animationStateParams.heightInput,this.verticalVelocity);this.animationState.setBool(this.animationStateParams.jumpFrame,this.isCharacterJumpFrame);this.animationState.setBool(this.animationStateParams.jumpState,this.isCharacterJumping);this.animationState.setInteger(this.animationStateParams.actionState,this.performActionNumber);this.animationState.setBool(this.animationStateParams.fallingState,this.isCharacterFalling);this.animationState.setBool(this.animationStateParams.slidingState,this.isCharacterSliding);this.animationState.setBool(this.animationStateParams.groundedState,this.isCharacterGrounded);if(this.smoothInputTime>0){if(this.smoothInputVectors===true){this.animationState.setSmoothFloat(this.animationStateParams.horizontalInput,this.playerInputX,(this.smoothInputTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.verticalInput,this.playerInputZ,(this.smoothInputTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.mouseXInput,this.playerMouseX,(this.smoothInputTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.mouseYInput,this.playerMouseY,(this.smoothInputTime*this.deltaTime))}else{this.animationState.setFloat(this.animationStateParams.horizontalInput,this.playerInputX);this.animationState.setFloat(this.animationStateParams.verticalInput,this.playerInputZ);this.animationState.setFloat(this.animationStateParams.mouseXInput,this.playerMouseX);this.animationState.setFloat(this.animationStateParams.mouseYInput,this.playerMouseY)}this.animationState.setSmoothFloat(this.animationStateParams.inputMagnitude,this.inputMagnitude,(this.smoothInputTime*this.deltaTime));this.animationState.setSmoothFloat(this.animationStateParams.speedInput,this.animationSpeed,(this.smoothInputTime*this.deltaTime))}else{this.animationState.setFloat(this.animationStateParams.horizontalInput,this.playerInputX);this.animationState.setFloat(this.animationStateParams.verticalInput,this.playerInputZ);this.animationState.setFloat(this.animationStateParams.mouseXInput,this.playerMouseX);this.animationState.setFloat(this.animationStateParams.mouseYInput,this.playerMouseY);this.animationState.setFloat(this.animationStateParams.inputMagnitude,this.inputMagnitude);this.animationState.setFloat(this.animationStateParams.speedInput,this.animationSpeed)}if(this.isCharacterNavigating===true){}if(this.onAnimationStateObservable&&this.onAnimationStateObservable.hasObservers()){this.onAnimationStateObservable.notifyObservers(this.transform)}}if(this.postNetworkAttributes==true&&TOOLKIT.EntityController.HasNetworkEntity(this.transform)){TOOLKIT.EntityController.PostBufferedAttribute(this.transform,0,this.playerMoveDirection);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,1,this.inputMagnitude);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,2,this.playerInputX);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,3,this.playerInputZ);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,4,this.playerMouseX);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,5,this.playerMouseY);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,6,this.verticalVelocity);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,7,this.animationSpeed);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,8,this.performActionNumber);TOOLKIT.EntityController.PostBufferedAttribute(this.transform,9,((this.isCharacterJumpFrame)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,10,((this.isCharacterJumping)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,11,((this.isCharacterFalling)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,12,((this.isCharacterSliding)?1:0));TOOLKIT.EntityController.PostBufferedAttribute(this.transform,13,((this.isCharacterGrounded)?1:0))}if(this.onPostUpdateObservable&&this.onPostUpdateObservable.hasObservers()){this.onPostUpdateObservable.notifyObservers(this.transform)}}afterPlayerController(){}updateCharacterController(){if(this.characterController!=null){this.isCharacterRising=(this.isCharacterJumping==true&&this.verticalVelocity>0);this.isCharacterLanding=(this.isCharacterJumping==true&&this.verticalVelocity<0);if(this.isCharacterRising==true){this.hasGroundedContact=false}const minJumpTimer=this.characterController.getMinJumpTimer();if(this.hasGroundedContact===true&&minJumpTimer<=0){this.isCharacterSliding=false;this.isCharacterGrounded=true}if(this.isCharacterGrounded===true)this.isCharacterJumping=false;this.isCharacterFalling=(this.isCharacterGrounded===false&&this.isCharacterSliding==false&&this.isCharacterJumping==false&&this.verticalVelocity<0&&Math.abs(this.verticalVelocity)>=this.minFallVelocity);if(this.isCharacterFalling===true&&this.isCharacterFallTriggered===false){this.isCharacterFallTriggered=true;if(this.jumpDelay>0)this.delayJumpTimer=this.jumpDelay}if(this.isCharacterGrounded===true)this.isCharacterFallTriggered=false;if(this.useClimbSystem===true){this.castPhysicsClimbingVolumeRay();this.castPhysicsHeightCheckVolumeRay()}if(this.isCharacterNavigating===false&&this.movementAllowed===true){if(this.isCharacterGrounded===true){if(this.delayJumpTimer<=0)this.isCharacterJumpFrame=(this.canPlayerJump===true&&this.isJumpPressed===true);if(this.isPerformingAction===false&&this.isCharacterJumpFrame===true&&this.useClimbSystem===true&&this.climbContact===true&&this.heightContact===true){let climbAction=-1;let rotateSpeed=1;let rotateTowards=false;let matchHeight=false;let startTime=0;let targetTime=0;let targetOffset=0;const hitHeight=parseFloat(this.heightContactPoint.y.toFixed(2));const playerHeight=parseFloat(this.transform.position.y.toFixed(2));const obstacleHeight=parseFloat((hitHeight-playerHeight).toFixed(2));if(obstacleHeight>=this.maxHeightRanges.stepUpRange.minimumHeight&&obstacleHeight<=this.maxHeightRanges.stepUpRange.maximumHeight){climbAction=PROJECT.ActionAnimationType.StepUp;rotateSpeed=this.maxHeightRanges.stepUpRange.rotationSpeed;rotateTowards=this.maxHeightRanges.stepUpRange.rotateTowards;matchHeight=this.maxHeightRanges.stepUpRange.matchHeight;startTime=this.maxHeightRanges.stepUpRange.startTime;targetTime=this.maxHeightRanges.stepUpRange.targetTime;targetOffset=this.maxHeightRanges.stepUpRange.targetOffset}else if(obstacleHeight>=this.maxHeightRanges.jumpUpRange.minimumHeight&&obstacleHeight<=this.maxHeightRanges.jumpUpRange.maximumHeight){climbAction=PROJECT.ActionAnimationType.JumpUp;rotateSpeed=this.maxHeightRanges.jumpUpRange.rotationSpeed;rotateTowards=this.maxHeightRanges.jumpUpRange.rotateTowards;matchHeight=this.maxHeightRanges.jumpUpRange.matchHeight;startTime=this.maxHeightRanges.jumpUpRange.startTime;targetTime=this.maxHeightRanges.jumpUpRange.targetTime;targetOffset=this.maxHeightRanges.jumpUpRange.targetOffset}else if(obstacleHeight>=this.maxHeightRanges.climbUpRange.minimumHeight&&obstacleHeight<=this.maxHeightRanges.climbUpRange.maximumHeight){climbAction=PROJECT.ActionAnimationType.ClimbUp;rotateSpeed=this.maxHeightRanges.climbUpRange.rotationSpeed;rotateTowards=this.maxHeightRanges.climbUpRange.rotateTowards;matchHeight=this.maxHeightRanges.climbUpRange.matchHeight;startTime=this.maxHeightRanges.climbUpRange.startTime;targetTime=this.maxHeightRanges.climbUpRange.targetTime;targetOffset=this.maxHeightRanges.climbUpRange.targetOffset}if(climbAction>=0){if(this.canClimbObstaclePredicate==null||this.canClimbObstaclePredicate(climbAction)===true){this.isCharacterJumpFrame=false;this.isCharacterJumping=false;this.isCharacterLanding=false;this.isCharacterRising=false;this.playActionAnimation(climbAction,false,true);this.playerRotationSpeed=rotateSpeed;this.rotatePlayerTowards=rotateTowards;this.matchTargetHeight=matchHeight;this.matchStartTime=(startTime-PROJECT.ThirdPersonPlayerController.MIN_TIMER_OFFSET);this.matchTargetTime=(targetTime-PROJECT.ThirdPersonPlayerController.MIN_TIMER_OFFSET);this.matchTargetOffset=targetOffset;this.lastTargetHeight=hitHeight;this.lastStartHeight=null;this.lockTargetHeight=false}}}if(this.isCharacterJumpFrame===true&&this.jumpSpeed>0){if(this.airbornTimeout>0)this.characterController.defaultJumpingTimer=(this.airbornTimeout+this.deltaTime);this.isCharacterJumping=true;this.characterController.jump(this.jumpSpeed);if(this.jumpDelay>0)this.delayJumpTimer=this.jumpDelay;this.lastJumpVelocity.set(this.movementVelocity.x,0,this.movementVelocity.z)}if(this.onBeforeMoveObservable&&this.onBeforeMoveObservable.hasObservers()){this.onBeforeMoveObservable.notifyObservers(this.transform)}if(this.animationState!=null&&this.rootMotion===true){const rootMotion=this.getDeltaMotionPosition();this.movementVelocity.set(rootMotion.x,0,rootMotion.z);BABYLON.Vector3.TransformNormalToRef(this.movementVelocity,this.transform.getWorldMatrix(),this.movementVelocity);this.characterController.move(this.movementVelocity)}else{this.characterController.move(this.movementVelocity)}}else{}}else{}}}castPhysicsClimbingVolumeRay(){let raycast=null;this.climbContact=false;this.climbContactNode=null;this.climbContactPoint.set(0,0,0);this.climbContactNormal.set(0,0,0);this.climbContactAngle=0;this.climbContactDistance=0;const playerTransformForwardDirection=TOOLKIT.Utilities.TransformDirection(this.transform,this.forwardDirection);this.offsetClimbRaycastPosition.set(0,this.rayClimbOffset,0);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.startClimbRaycastPosition,this.offsetClimbRaycastPosition);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.endClimbRaycastPosition,this.forwardDirection.scale(this.rayClimbLength));this.endClimbRaycastPosition.y+=this.rayClimbOffset;if(raycast!=null&&raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){const checkTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);if(checkTag===this.climbVolumeTag){this.climbContact=true;this.climbContactNode=raycast.collisionObject.entity;if(raycast.hitPoint!=null)this.climbContactPoint.copyFrom(raycast.hitPoint);if(raycast.hitNormal!=null)this.climbContactNormal.copyFrom(raycast.hitNormal);this.climbContactAngle=(this.climbContactNormal!=null)?Math.abs(TOOLKIT.Utilities.GetAngle(this.climbContactNormal,BABYLON.Vector3.UpReadOnly)):0;this.climbContactDistance=raycast.hitDistance}}if(this.showDebugColliders===true){if(this.climbSensorLine==null)this.climbSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".ClimbingSensorLine",this.scene);if(raycast!=null&&this.climbContact===true){this.climbSensorLine.drawLine([this.startClimbRaycastPosition,raycast.hitPoint],BABYLON.Color3.Red())}else{this.climbSensorLine.drawLine([this.startClimbRaycastPosition,this.endClimbRaycastPosition],BABYLON.Color3.Green())}}}castPhysicsHeightCheckVolumeRay(){let raycast=null;this.heightContact=false;this.heightContactNode=null;this.heightContactPoint.set(0,0,0);this.heightContactNormal.set(0,0,0);this.heightContactAngle=0;this.heightContactDistance=0;const playerTransformHeightDirection=TOOLKIT.Utilities.TransformDirection(this.transform,this.downDirection);if(this.climbContact===true){this.endHeightRaycastPosition.copyFrom(this.climbContactPoint);this.startHeightRaycastPosition.copyFrom(this.climbContactPoint);this.startHeightRaycastPosition.addInPlace(BABYLON.Vector3.UpReadOnly.scale(this.rayHeightLength))}else{this.offsetHeightRaycastPosition.set(0,this.rayHeightOffset,this.rayClimbLength);TOOLKIT.Utilities.GetAbsolutePositionToRef(this.transform,this.startHeightRaycastPosition,this.offsetHeightRaycastPosition);this.endHeightRaycastPosition.copyFrom(this.startHeightRaycastPosition);this.endHeightRaycastPosition.addInPlace(this.downDirection.scale(this.rayHeightLength))}if(raycast!=null&&raycast.hasHit===true&&raycast.collisionObject!=null&&raycast.collisionObject.entity!=null){const checkTag=TOOLKIT.SceneManager.GetTransformTag(raycast.collisionObject.entity);if(checkTag===this.climbVolumeTag){this.heightContact=true;this.heightContactNode=raycast.collisionObject.entity;if(raycast.hitPoint!=null)this.heightContactPoint.copyFrom(raycast.hitPoint);if(raycast.hitNormal!=null)this.heightContactNormal.copyFrom(raycast.hitNormal);this.heightContactAngle=(this.heightContactNormal!=null)?Math.abs(TOOLKIT.Utilities.GetAngle(this.heightContactNormal,BABYLON.Vector3.UpReadOnly)):0;this.heightContactDistance=raycast.hitDistance}}if(this.showDebugColliders===true){if(this.heightSensorLine==null)this.heightSensorLine=new TOOLKIT.LinesMeshRenderer(this.transform.name+".HeightCheckSensorLine",this.scene);if(raycast!=null&&this.heightContact===true){this.heightSensorLine.drawLine([this.startHeightRaycastPosition,raycast.hitPoint],BABYLON.Color3.Red())}else{this.heightSensorLine.drawLine([this.startHeightRaycastPosition,this.endHeightRaycastPosition],BABYLON.Color3.Green())}}}getCheckedVerticalVelocity(){const currentVelocity=(this.characterController!=null)?this.characterController.getVerticalVelocity():0;return(Math.abs(currentVelocity)>=PROJECT.ThirdPersonPlayerController.MIN_VERTICAL_VELOCITY)?currentVelocity:0}destroyPlayerController(){this.animationState=null;this.characterController=null;this.onPreUpdateObservable.clear();this.onPreUpdateObservable=null;this.onBeforeMoveObservable.clear();this.onBeforeMoveObservable=null;this.onPostUpdateObservable.clear();this.onPostUpdateObservable=null}validateAnimationStateParams(){if(this.animationStateParams==null){this.animationStateParams={moveDirection:"Direction",inputMagnitude:"Magnitude",horizontalInput:"Horizontal",verticalInput:"Vertical",mouseXInput:"MouseX",mouseYInput:"MouseY",heightInput:"Height",speedInput:"Speed",jumpFrame:"Jumped",jumpState:"Jump",actionState:"Action",fallingState:"FreeFall",slidingState:"Sliding",groundedState:"Grounded"}}}}PROJECT.ThirdPersonPlayerController=ThirdPersonPlayerController;let ThirdPersonControl;(function(ThirdPersonControl){ThirdPersonControl[ThirdPersonControl["ThirdPersonTurning"]=0]="ThirdPersonTurning";ThirdPersonControl[ThirdPersonControl["ThirdPersonForward"]=1]="ThirdPersonForward"})(ThirdPersonControl=PROJECT.ThirdPersonControl||(PROJECT.ThirdPersonControl={}));TOOLKIT.SceneManager.RegisterClass("PROJECT.ThirdPersonPlayerController",ThirdPersonPlayerController)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class FxParticleSystem extends TOOLKIT.ScriptComponent{getParticleEmitter(){return this.m_particleEmitter}getParticleSystem(){return this.m_particleSystem}constructor(transform,scene,properties={},alias="PROJECT.FxParticleSystem"){super(transform,scene,properties,alias)}m_particleEmitter=null;m_particleSystem=null;awake(){const rootUrl=TOOLKIT.SceneManager.GetRootUrl(this.scene);const classType=this.getProperty("classType",0);const particleText=this.getProperty("base64ParticleSystem");const playOnAwake=this.getProperty("playOnAwake",false);const particleTexture=this.getProperty("particleTexture");this.m_particleEmitter=this.getAbstractMesh();if(this.m_particleEmitter==null){this.m_particleEmitter=BABYLON.MeshBuilder.CreateBox(this.transform.name+".Emitter",{size:0.25},this.scene);this.m_particleEmitter.parent=this.transform;this.m_particleEmitter.position.set(0,0,0);this.m_particleEmitter.isVisible=false;this.m_particleEmitter.isPickable=false;this.m_particleEmitter.material=TOOLKIT.Utilities.GetColliderMaterial(this.scene)}if(particleText!=null&&particleText!==""){const particleJson=window.atob(particleText);if(particleJson!=null&&particleJson!==""){const particleParsed=JSON.parse(particleJson);if(particleParsed!=null){if(particleParsed.texture!=null&&particleTexture!=null){particleParsed.texture.name=particleTexture.filename;particleParsed.texture.url=particleTexture.filename}if(classType===1){this.m_particleSystem=BABYLON.GPUParticleSystem.Parse(particleParsed,this.scene,rootUrl)}else{this.m_particleSystem=BABYLON.ParticleSystem.Parse(particleParsed,this.scene,rootUrl)}if(this.m_particleSystem!=null){if(this.m_particleEmitter!=null)this.m_particleSystem.emitter=this.m_particleEmitter;if(playOnAwake===false)this.m_particleSystem.stop()}}}}}destroy(){this.m_particleEmitter=null;if(this.m_particleSystem!=null){this.m_particleSystem.dispose();this.m_particleSystem=null}}}PROJECT.FxParticleSystem=FxParticleSystem;TOOLKIT.SceneManager.RegisterClass("PROJECT.FxParticleSystem",FxParticleSystem)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SkyMaterialSystem extends TOOLKIT.ScriptComponent{skyfog=false;skysize=1000;probesize=128;reflections=false;reflectlevel=1;skytintcolor=new BABYLON.Color3(1,1,1);getSkyboxMesh(){return this.m_skyboxMesh}getSkyMaterial(){return this.m_skyMaterial}getReflectionProbe(){return this.m_reflectProbe}constructor(transform,scene,properties={},alias="PROJECT.SkyMaterialSystem"){super(transform,scene,properties,alias)}awake(){this.awakeSkyboxMaterial()}start(){}update(){}late(){}after(){}destroy(){this.destroySkyboxMaterial()}m_skyboxMesh=null;m_skyMaterial=null;m_reflectProbe=null;awakeSkyboxMaterial(){this.skyfog=this.getProperty("applyMeshFog",this.skyfog);this.skysize=this.getProperty("boxSize",this.skysize);this.probesize=this.getProperty("probeSize",this.probesize);this.reflections=this.getProperty("reflections",this.reflections);this.reflectlevel=this.getProperty("reflectLevel",this.reflectlevel);const tintColor=this.getProperty("tintColor");if(tintColor!=null)this.skytintcolor=TOOLKIT.Utilities.ParseColor3(tintColor);this.m_skyboxMesh=BABYLON.MeshBuilder.CreateBox("Ambient Skybox",{size:this.skysize},this.scene);this.m_skyboxMesh.position.set(0,0,0);this.m_skyboxMesh.infiniteDistance=true;this.m_skyboxMesh.applyFog=this.skyfog;if(this.scene.useRightHandedSystem===true)this.m_skyboxMesh.scaling.x*=-1;this.m_skyMaterial=new BABYLON.SkyMaterial(this.transform.name+".SkyMaterial",this.scene);this.m_skyMaterial.backFaceCulling=false;this.setSkyboxTintColor(this.skytintcolor);this.m_skyMaterial.luminance=this.getProperty("luminance",this.m_skyMaterial.luminance);this.m_skyMaterial.turbidity=this.getProperty("turbidity",this.m_skyMaterial.turbidity);this.m_skyMaterial.rayleigh=this.getProperty("rayleigh",this.m_skyMaterial.rayleigh);this.m_skyMaterial.mieCoefficient=this.getProperty("mieCoefficient",this.m_skyMaterial.mieCoefficient);this.m_skyMaterial.mieDirectionalG=this.getProperty("mieDirectionalG",this.m_skyMaterial.mieDirectionalG);this.m_skyMaterial.distance=this.getProperty("distance",this.m_skyMaterial.distance);this.m_skyMaterial.inclination=this.getProperty("inclination",this.m_skyMaterial.inclination);this.m_skyMaterial.azimuth=this.getProperty("azimuth",this.m_skyMaterial.azimuth);const camOffsetData=this.getProperty("cameraOffset");if(camOffsetData!=null)this.m_skyMaterial.cameraOffset=TOOLKIT.Utilities.ParseVector3(camOffsetData);this.m_skyMaterial.useSunPosition=this.getProperty("useSunPosition",this.m_skyMaterial.useSunPosition);this.m_skyMaterial.sunPosition=new BABYLON.Vector3(0,50,0);if(this.scene.metadata!=null&&this.scene.metadata.unity!=null&&this.scene.metadata.unity){if(this.scene.metadata.toolkit.sunposition!=null){this.m_skyMaterial.sunPosition=TOOLKIT.Utilities.ParseVector3(this.scene.metadata.toolkit.sunposition)}}this.m_skyboxMesh.material=this.m_skyMaterial;if(this.reflections===true){this.m_reflectProbe=new BABYLON.ReflectionProbe("Skybox-ReflectionProbe",this.probesize,this.scene);this.m_reflectProbe.renderList.push(this.m_skyboxMesh);this.scene.customRenderTargets.push(this.m_reflectProbe.cubeTexture);this.scene.environmentTexture=this.m_reflectProbe.cubeTexture;this.scene.environmentIntensity=this.reflectlevel}}destroySkyboxMaterial(){if(this.m_skyboxMesh!=null){this.m_skyboxMesh.dispose();this.m_skyboxMesh=null}if(this.m_reflectProbe!=null){this.m_reflectProbe.dispose();this.m_reflectProbe=null}if(this.m_skyMaterial!=null){this.m_skyMaterial.dispose();this.m_skyMaterial=null}}setSkyboxTintColor(color){const colors=[];const numVertices=this.m_skyboxMesh.getTotalVertices();for(let i=0;i<numVertices;++i){colors.push(color.r,color.g,color.b,1.0)}this.m_skyboxMesh.setVerticesData("color",colors);this.m_skyboxMesh.useVertexColors=true}}PROJECT.SkyMaterialSystem=SkyMaterialSystem;TOOLKIT.SceneManager.RegisterClass("PROJECT.SkyMaterialSystem",SkyMaterialSystem)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class WaterMaterialSystem extends TOOLKIT.ScriptComponent{waterTag="Water";targetSize=new BABYLON.Vector2(128,128);renderSize=new BABYLON.Vector2(512,512);depthFactor=1.0;reflectSkybox=true;subDivisions=32;heightOffset=1.0;windDirection=new BABYLON.Vector2(0,1);windForce=6;waveSpeed=1.0;waveLength=0.4;waveHeight=0.4;bumpHeight=0.4;bumpSuperimpose;bumpAffectsReflection;waterColor=new BABYLON.Color3(0.1,0.1,0.6);colorBlendFactor=0.2;waterColor2=new BABYLON.Color3(0.1,0.1,0.6);colorBlendFactor2=0.2;disableClipPlane=false;fresnelSeparate;getWaterGeometry(){return this.m_waterGeometry}getWaterMaterial(){return this.m_waterMaterial}m_waterGeometry=null;m_waterMaterial=null;constructor(transform,scene,properties={},alias="PROJECT.WaterMaterialSystem"){super(transform,scene,properties,alias)}awake(){this.waterTag=this.getProperty("waterTag",this.waterTag);this.depthFactor=this.getProperty("depthFactor",this.depthFactor);this.subDivisions=this.getProperty("subDivisions",this.subDivisions);this.heightOffset=this.getProperty("heightOffset",this.heightOffset);this.reflectSkybox=this.getProperty("reflectSkybox",this.reflectSkybox);this.windForce=this.getProperty("windForce",this.windForce);this.waveSpeed=this.getProperty("waveSpeed",this.waveSpeed);this.waveLength=this.getProperty("waveLength",this.waveLength);this.waveHeight=this.getProperty("waveHeight",this.waveHeight);this.bumpHeight=this.getProperty("bumpHeight",this.bumpHeight);this.bumpSuperimpose=this.getProperty("bumpSuperimpose",this.bumpSuperimpose);this.bumpAffectsReflection=this.getProperty("bumpAffectsReflection",this.bumpAffectsReflection);this.colorBlendFactor=this.getProperty("colorBlendFactor",this.colorBlendFactor);this.colorBlendFactor2=this.getProperty("colorBlendFactor2",this.colorBlendFactor2);this.disableClipPlane=this.getProperty("disableClipPlane",this.disableClipPlane);this.fresnelSeparate=this.getProperty("fresnelSeparate",this.fresnelSeparate);const wcolor1=this.getProperty("waterColor");this.waterColor=TOOLKIT.Utilities.ParseColor3(wcolor1);const wcolor2=this.getProperty("waterColor2");this.waterColor2=TOOLKIT.Utilities.ParseColor3(wcolor2);const wdirection=this.getProperty("windDirection");this.windDirection=TOOLKIT.Utilities.ParseVector2(wdirection);const itargetsize=this.getProperty("targetSize");if(itargetsize!=null)this.targetSize=TOOLKIT.Utilities.ParseVector2(itargetsize);const irendersize=this.getProperty("renderSize");if(irendersize!=null)this.renderSize=TOOLKIT.Utilities.ParseVector2(irendersize);let bumpTexture=null;const bumpTextureData=this.getProperty("bumpTexture");if(bumpTextureData!=null)bumpTexture=TOOLKIT.Utilities.ParseTexture(bumpTextureData,this.scene);if(bumpTexture!=null){this.m_waterMaterial=new BABYLON.WaterMaterial(this.transform.name+".Water",this.scene,this.renderSize);this.m_waterMaterial.bumpTexture=bumpTexture;this.m_waterMaterial.windDirection=this.windDirection;this.m_waterMaterial.windForce=this.windForce;this.m_waterMaterial.waveSpeed=this.waveSpeed;this.m_waterMaterial.waveLength=this.waveLength;this.m_waterMaterial.waveHeight=this.waveHeight;this.m_waterMaterial.bumpHeight=this.bumpHeight;this.m_waterMaterial.bumpSuperimpose=this.bumpSuperimpose;this.m_waterMaterial.bumpAffectsReflection=this.bumpAffectsReflection;this.m_waterMaterial.waterColor=this.waterColor;this.m_waterMaterial.colorBlendFactor=this.colorBlendFactor;this.m_waterMaterial.waterColor2=this.waterColor2;this.m_waterMaterial.colorBlendFactor2=this.colorBlendFactor2;this.m_waterMaterial.disableClipPlane=this.disableClipPlane;this.m_waterMaterial.fresnelSeparate=this.fresnelSeparate;if(this.reflectSkybox===true){const skyboxMesh=TOOLKIT.SceneManager.GetDefaultSkybox(this.scene);if(skyboxMesh!=null)this.m_waterMaterial.addToRenderList(skyboxMesh)}if(this.waterTag!=null&&this.waterTag!==""){const waterMeshes=this.scene.getMeshesByTags(this.waterTag);if(waterMeshes!=null&&waterMeshes.length>0){waterMeshes.forEach(mesh=>{this.m_waterMaterial.addToRenderList(mesh)})}}this.m_waterGeometry=BABYLON.MeshBuilder.CreateGround(this.transform.name+".WaterMesh",{width:this.targetSize.x,height:this.targetSize.y,subdivisions:this.subDivisions,updatable:false},this.scene);this.m_waterGeometry.parent=this.transform;this.m_waterGeometry.position.set(0,this.heightOffset,0);if(this.depthFactor>0)this.m_waterGeometry.scaling.y*=this.depthFactor;this.m_waterGeometry.material=this.m_waterMaterial}else{TOOLKIT.SceneManager.LogWarning("No supported water bump texture for: "+this.transform.name)}}start(){}update(){}late(){}after(){}destroy(){}}PROJECT.WaterMaterialSystem=WaterMaterialSystem;TOOLKIT.SceneManager.RegisterClass("PROJECT.WaterMaterialSystem",WaterMaterialSystem)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SnapshotManager extends TOOLKIT.ScriptComponent{static IsSnapshotRenderingEnabled(){return PROJECT.SnapshotManager._HelperEnabled}static EnableSnapshotRendering(){if(PROJECT.SnapshotManager._SnapshotHelper!=null){PROJECT.SnapshotManager._SnapshotHelper.enableSnapshotRendering();PROJECT.SnapshotManager._HelperEnabled=true}}static DisableSnapshotRendering(){if(PROJECT.SnapshotManager._SnapshotHelper!=null){PROJECT.SnapshotManager._SnapshotHelper.disableSnapshotRendering();PROJECT.SnapshotManager._HelperEnabled=false}}static ResetSnapshotHelper(scene){if(PROJECT.SnapshotManager._SnapshotHelper!=null){PROJECT.SnapshotManager._SnapshotHelper.dispose();PROJECT.SnapshotManager._SnapshotHelper=null}PROJECT.SnapshotManager._SnapshotHelper=new BABYLON.SnapshotRenderingHelper(scene,{morphTargetsNumMaxInfluences:20});PROJECT.SnapshotManager._HelperEnabled=false}static GetSnapshotHelper(){return PROJECT.SnapshotManager._SnapshotHelper}static _HelperEnabled=false;static _SnapshotHelper=null;autoStart=false;autoUpdate=true;delayTimeout=3.0;constructor(transform,scene,properties,alias="PROJECT.SnapshotManager"){super(transform,scene,properties,alias);PROJECT.SnapshotManager.ResetSnapshotHelper(scene)}start(){console.warn("*** SnapshotManager Started ***");if(PROJECT.SnapshotManager._SnapshotHelper!=null){PROJECT.SnapshotManager._SnapshotHelper.fixMeshes();console.warn("Snapshot Helper Fixed Meshes.")}this.scene.meshes.forEach(element=>{console.log("Fixup Mesh: "+element.name+" ->: Always Select Mesh: "+element.alwaysSelectAsActiveMesh,element)})}ready(){if(this.autoStart===true){if(this.delayTimeout>0){TOOLKIT.WindowManager.SetTimeout((this.delayTimeout*1000),()=>{PROJECT.SnapshotManager.EnableSnapshotRendering()})}else{PROJECT.SnapshotManager.EnableSnapshotRendering()}}}update(){if(this.autoUpdate===true){if(PROJECT.SnapshotManager._SnapshotHelper!=null&&PROJECT.SnapshotManager._HelperEnabled===true){this.scene.meshes.forEach(mesh=>{mesh.transferToEffect(mesh.computeWorldMatrix(true))})}}}destroy(){PROJECT.SnapshotManager._HelperEnabled=false;if(PROJECT.SnapshotManager._SnapshotHelper!=null){PROJECT.SnapshotManager._SnapshotHelper.dispose();PROJECT.SnapshotManager._SnapshotHelper=null}}}PROJECT.SnapshotManager=SnapshotManager;TOOLKIT.SceneManager.RegisterClass("PROJECT.SnapshotManager",SnapshotManager)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SnapshotRenderer extends TOOLKIT.ScriptComponent{constructor(transform,scene,properties={},alias="PROJECT.SnapshotRenderer"){super(transform,scene,properties,alias)}start(){}}PROJECT.SnapshotRenderer=SnapshotRenderer;TOOLKIT.SceneManager.RegisterClass("PROJECT.SnapshotRenderer",SnapshotRenderer)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class DefaultMuteButton extends TOOLKIT.ScriptComponent{static audioSystemInitialized=false;static IsAudioSystemInitialized(){return DefaultMuteButton.audioSystemInitialized}buttonIdentifier="mute-button";buttonClassname="mute-button-active";buttonContainer="button-container";buttonElement=null;muteIconElement=null;mutedIconElement=null;muteButtonState=true;mutedIconUrl="";muteIconUrl="";toggleEffects=true;autoPlayList=null;audioSources=null;constructor(transform,scene,properties={},alias="PROJECT.DefaultMuteButton"){super(transform,scene,properties,alias)}awake(){}start(){if(this.autoPlayList!=null&&this.autoPlayList.length>0){this.autoPlayList.forEach(transform=>{const audio=TOOLKIT.SceneManager.FindScriptComponent(transform,"TOOLKIT.AudioSource");if(audio!=null){if(this.audioSources==null)this.audioSources=[];this.audioSources.push(audio)}})}}ready(){this.createMuteButton()}createMuteButton(){const buttonContainer=window.document.createElement("div");buttonContainer.className=this.buttonContainer;window.document.body.appendChild(buttonContainer);this.buttonElement=window.document.createElement("button");this.buttonElement.id=this.buttonIdentifier;this.buttonElement.className=this.buttonClassname;buttonContainer.appendChild(this.buttonElement);this.mutedIconElement=window.document.createElement("img");this.mutedIconElement.id="muted-icon";this.mutedIconElement.src=this.mutedIconUrl;this.mutedIconElement.className="";this.buttonElement.appendChild(this.mutedIconElement);this.muteIconElement=window.document.createElement("img");this.muteIconElement.id="mute-icon";this.muteIconElement.src=this.muteIconUrl;this.muteIconElement.className="hidden";this.buttonElement.appendChild(this.muteIconElement);this.buttonElement.onclick=()=>{this.handleButtonClick()}}handleButtonClick(){this.muteButtonState=!this.muteButtonState;this.buttonElement.classList.toggle("mute-button-active");this.muteIconElement.classList.toggle("hidden");this.mutedIconElement.classList.toggle("hidden");if(PROJECT.DefaultMuteButton.audioSystemInitialized===false){PROJECT.DefaultMuteButton.audioSystemInitialized=true;if(this.audioSources!=null&&this.audioSources.length>0){this.audioSources.forEach(source=>{if(source!=null)source.play()})}}else{if(PROJECT.SceneSoundSystem!=null){if(this.muteButtonState===true){if(PROJECT.SceneSoundSystem.MUSIC!=null)PROJECT.SceneSoundSystem.MUSIC.muteAllTracks();if(PROJECT.SceneSoundSystem.SFX!=null&&this.toggleEffects===true)PROJECT.SceneSoundSystem.SFX.muteAllTracks()}else{if(PROJECT.SceneSoundSystem.MUSIC!=null)PROJECT.SceneSoundSystem.MUSIC.unmuteAllTracks();if(PROJECT.SceneSoundSystem.SFX!=null&&this.toggleEffects===true)PROJECT.SceneSoundSystem.SFX.unmuteAllTracks()}}}}}PROJECT.DefaultMuteButton=DefaultMuteButton;TOOLKIT.SceneManager.RegisterClass("PROJECT.DefaultMuteButton",DefaultMuteButton)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SceneSoundSystem extends TOOLKIT.ScriptComponent{static _MUSIC=null;static get MUSIC(){return SceneSoundSystem._MUSIC}static _SFX=null;static get SFX(){return SceneSoundSystem._SFX}constructor(transform,scene,properties={},alias="PROJECT.SceneSoundSystem"){super(transform,scene,properties,alias)}start(){const musicNode=this.getChildNode("MUSIC");if(musicNode!=null)PROJECT.SceneSoundSystem._MUSIC=TOOLKIT.SceneManager.FindScriptComponent(musicNode,"PROJECT.SoundManager");const soundNode=this.getChildNode("SFX");if(soundNode!=null)PROJECT.SceneSoundSystem._SFX=TOOLKIT.SceneManager.FindScriptComponent(soundNode,"PROJECT.SoundManager")}}PROJECT.SceneSoundSystem=SceneSoundSystem;TOOLKIT.SceneManager.RegisterClass("PROJECT.SceneSoundSystem",SceneSoundSystem)})(PROJECT||(PROJECT={}));var PROJECT;(function(PROJECT){class SoundManager extends TOOLKIT.ScriptComponent{groupName=null;cachedVolume=false;volumeProperty="volume";getGroupName(){return this.groupName}m_soundMap=null;m_soundList=null;constructor(transform,scene,properties={},alias="PROJECT.SoundManager"){super(transform,scene,properties,alias)}awake(){this.groupName=this.getProperty("groupName",this.transform.name);this.cachedVolume=this.getProperty("cachedVolume",this.cachedVolume);this.volumeProperty=this.getProperty("volumeProperty",this.volumeProperty);this.m_soundMap=new Map;this.m_soundList=[]}start(){const audioTransforms=this.transform.getChildren(null,true);if(audioTransforms!=null&&audioTransforms.length>0){for(let index=0;index<audioTransforms.length;index++){const audioTrackNode=audioTransforms[index];const audioSource=TOOLKIT.SceneManager.FindScriptComponent(audioTrackNode,"TOOLKIT.AudioSource");if(audioSource!=null){if(this.cachedVolume===true){const volume=window.localStorage.getItem(this.volumeProperty);if(volume!=null&&volume!==""){const volumeLevel=parseFloat(volume);if(volumeLevel!=null){audioSource.setVolume(volumeLevel)}}}this.m_soundMap.set(audioTrackNode.name,audioSource);this.m_soundList.push(audioSource)}}}}update(){}destroy(){this.m_soundList=null;this.m_soundMap.clear();this.m_soundMap=null}isPlaying(name){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.isPlaying():false}isPaused(name){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.isPaused():false}async playTrack(name,time,offset,length){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.play(time,offset,length):false}pauseTrack(name){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.pause():false}pauseAllTracks(){if(this.m_soundList!=null&&this.m_soundList.length>0){for(let index=0;index<this.m_soundList.length;index++){if(this.m_soundList[index]!=null){this.m_soundList[index].pause()}}}}stopTrack(name,time){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.stop(time):false}stopAllTracks(time){if(this.m_soundList!=null&&this.m_soundList.length>0){for(let index=0;index<this.m_soundList.length;index++){if(this.m_soundList[index]!=null){this.m_soundList[index].stop(time)}}}}muteTrack(name,time){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.mute(time):false}unmuteTrack(name,time){const audioSource=this.getAudioSource(name);return(audioSource!=null)?audioSource.unmute(time):false}muteAllTracks(time){if(this.m_soundList!=null&&this.m_soundList.length>0){for(let index=0;index<this.m_soundList.length;index++){if(this.m_soundList[index]!=null){this.m_soundList[index].mute(time)}}}}unmuteAllTracks(time){if(this.m_soundList!=null&&this.m_soundList.length>0){for(let index=0;index<this.m_soundList.length;index++){if(this.m_soundList[index]!=null){this.m_soundList[index].unmute(time)}}}}setGroupVolume(volume,time){if(this.m_soundList!=null&&this.m_soundList.length>0){for(let index=0;index<this.m_soundList.length;index++){if(this.m_soundList[index]!=null){this.m_soundList[index].setVolume(volume,time)}}}}getAudioSource(name){return this.m_soundMap.get(name)}}PROJECT.SoundManager=SoundManager;TOOLKIT.SceneManager.RegisterClass("PROJECT.SoundManager",SoundManager)})(PROJECT||(PROJECT={}));var BABYLON;(function(BABYLON){class WindowsPlatform{static IsXboxLiveUserSignedIn(systemUser=null,player=TOOLKIT.PlayerNumber.One){if(TOOLKIT.WindowManager.IsWindows()){let user=(systemUser!=null)?BABYLON.WindowsPlatform.GetXboxLiveSystemUser(systemUser,player):BABYLON.WindowsPlatform.GetXboxLiveUser(player);return(user!=null&&user.isSignedIn==true)}else{return false}}static XboxLiveUserSignIn(player=TOOLKIT.PlayerNumber.One,oncomplete,onerror,onprogress){if(TOOLKIT.WindowManager.IsWindows()){BABYLON.WindowsPlatform.XboxLiveUserSilentSignIn(player,first=>{if(first.status===Microsoft.Xbox.Services.System.SignInStatus.userInteractionRequired){BABYLON.WindowsPlatform.XboxLiveUserDialogSignIn(player,second=>{if(oncomplete)oncomplete(second)},onerror,onprogress)}else{if(oncomplete)oncomplete(first)}},onerror,onprogress)}}static XboxLiveUserSilentSignIn(player=TOOLKIT.PlayerNumber.One,oncomplete,onerror,onprogress){return(TOOLKIT.WindowManager.IsWindows())?BABYLON.WindowsPlatform.GetXboxLiveUser(player).signInSilentlyAsync(null).then(oncomplete,onerror,onprogress):null}static XboxLiveUserDialogSignIn(player=TOOLKIT.PlayerNumber.One,oncomplete,onerror,onprogress){return(TOOLKIT.WindowManager.IsWindows())?BABYLON.WindowsPlatform.GetXboxLiveUser(player).signInAsync(null).then(oncomplete,onerror,onprogress):null}static LoadXboxLiveUserProfile(player=TOOLKIT.PlayerNumber.One,oncomplete,onerror,onprogress){return(TOOLKIT.WindowManager.IsWindows())?BABYLON.WindowsPlatform.GetXboxLiveUserContext(player).profileService.getUserProfileAsync(BABYLON.WindowsPlatform.GetXboxLiveUser(player).xboxUserId).then(oncomplete,onerror,onprogress):null}static GetXboxLiveUser(player=TOOLKIT.PlayerNumber.One){let user=null;if(TOOLKIT.WindowManager.IsWindows()){switch(player){case TOOLKIT.PlayerNumber.One:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveUserOne();break;case TOOLKIT.PlayerNumber.Two:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveUserTwo();break;case TOOLKIT.PlayerNumber.Three:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveUserThree();break;case TOOLKIT.PlayerNumber.Four:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveUserFour();break}}return user}static GetXboxLiveSystemUser(systemUser,player=TOOLKIT.PlayerNumber.One){let user=null;if(TOOLKIT.WindowManager.IsWindows()){switch(player){case TOOLKIT.PlayerNumber.One:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveSystemUserOne(systemUser);break;case TOOLKIT.PlayerNumber.Two:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveSystemUserTwo(systemUser);break;case TOOLKIT.PlayerNumber.Three:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveSystemUserThree(systemUser);break;case TOOLKIT.PlayerNumber.Four:user=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveSystemUserFour(systemUser);break}}return user}static GetXboxLiveUserContext(player=TOOLKIT.PlayerNumber.One){let context=null;if(TOOLKIT.WindowManager.IsWindows()){switch(player){case TOOLKIT.PlayerNumber.One:context=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveContextOne();break;case TOOLKIT.PlayerNumber.Two:context=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveContextTwo();break;case TOOLKIT.PlayerNumber.Three:context=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveContextThree();break;case TOOLKIT.PlayerNumber.Four:context=window.BabylonToolkit.XboxLive.Plugin.getXboxLiveContextFour();break}}return context}static ResetXboxLiveUserContext(player=TOOLKIT.PlayerNumber.One){if(TOOLKIT.WindowManager.IsWindows()){switch(player){case TOOLKIT.PlayerNumber.One:window.BabylonToolkit.XboxLive.Plugin.resetXboxLiveUserContextOne();break;case TOOLKIT.PlayerNumber.Two:window.BabylonToolkit.XboxLive.Plugin.resetXboxLiveUserContextTwo();break;case TOOLKIT.PlayerNumber.Three:window.BabylonToolkit.XboxLive.Plugin.resetXboxLiveUserContextThree();break;case TOOLKIT.PlayerNumber.Four:window.BabylonToolkit.XboxLive.Plugin.resetXboxLiveUserContextFour();break}}}static GetXboxLiveContextProperty(name){return(TOOLKIT.WindowManager.IsWindows())?window.BabylonToolkit.XboxLive.Plugin.getXboxLiveContextProperty(name):null}static SetXboxLiveContextProperty(name,property){if(TOOLKIT.WindowManager.IsWindows()){window.BabylonToolkit.XboxLive.Plugin.setXboxLiveContextProperty(name,property)}}static ResetXboxLivePropertyContexts(){if(TOOLKIT.WindowManager.IsWindows()){window.BabylonToolkit.XboxLive.Plugin.resetXboxLivePropertyContexts()}}static SetXboxLiveSignOutHandler(handler=null){if(TOOLKIT.WindowManager.IsWindows()){window.BabylonToolkit.XboxLive.Plugin.onusersignout=handler}}}BABYLON.WindowsPlatform=WindowsPlatform})(BABYLON||(BABYLON={}))

