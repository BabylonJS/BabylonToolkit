!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.TOOLKIT=t():e.TOOLKIT=t()}(this,()=>(()=>{"use strict";var e={d:(t,n)=>{for(var i in n)e.o(n,i)&&!e.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:n[i]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},t={};e.d(t,{default:()=>s});var n,i,o=(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function i(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(i.prototype=t.prototype,new i)}),r=function(e,t,n,i){return new(n||(n=Promise))(function(o,r){function a(e){try{s(i.next(e))}catch(e){r(e)}}function l(e){try{s(i.throw(e))}catch(e){r(e)}}function s(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,l)}s((i=i.apply(e,t||[])).next())})},a=function(e,t){var n,i,o,r={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=l(0),a.throw=l(1),a.return=l(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function l(l){return function(s){return function(l){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,l[0]&&(r=0)),r;)try{if(n=1,i&&(o=2&l[0]?i.return:l[0]?i.throw||((o=i.return)&&o.call(i),0):i.next)&&!(o=o.call(i,l[1])).done)return o;switch(i=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return r.label++,{value:l[1],done:!1};case 5:r.label++,i=l[1],l=[0];continue;case 7:l=r.ops.pop(),r.trys.pop();continue;default:if(!((o=(o=r.trys).length>0&&o[o.length-1])||6!==l[0]&&2!==l[0])){r=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){r.label=l[1];break}if(6===l[0]&&r.label<o[1]){r.label=o[1],o=l;break}if(o&&r.label<o[2]){r.label=o[2],r.ops.push(l);break}o[2]&&r.ops.pop(),r.trys.pop();continue}l=t.call(e,r)}catch(e){l=[6,e],i=0}finally{n=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,s])}}},l=function(e,t,n){if(n||2===arguments.length)for(var i,o=0,r=t.length;o<r;o++)!i&&o in t||(i||(i=Array.prototype.slice.call(t,0,o)),i[o]=t[o]);return e.concat(i||Array.prototype.slice.call(t))};!function(e){var t=function(){function t(){}return Object.defineProperty(t,"Version",{get:function(){return"8.33.4 - R1"},enumerable:!1,configurable:!0}),Object.defineProperty(t,"Copyright",{get:function(){return"All rights reserved (c) 2024 Mackey Kinard"},enumerable:!1,configurable:!0}),t.GetEngine=function(e){var t=null,n=e.getEngine();return null!=n&&(n instanceof BABYLON.Engine||n instanceof BABYLON.WebGPUEngine)&&(t=n),t},t.GetClass=function(e){return BABYLON.GetClass(e)},t.RegisterClass=function(e,t){BABYLON.RegisterClass(e,t)},Object.defineProperty(t,"EventBus",{get:function(){return null==e.SceneManager._EventBus&&(e.SceneManager._EventBus=new e.GlobalMessageBus),e.SceneManager._EventBus},enumerable:!1,configurable:!0}),Object.defineProperty(t,"PlaygroundCdn",{get:function(){return"https://cdn.jsdelivr.net/gh/BabylonJS/BabylonToolkit@master/Runtime/"},enumerable:!1,configurable:!0}),Object.defineProperty(t,"PlaygroundRepo",{get:function(){return"https://www.babylontoolkit.com/playground/"},enumerable:!1,configurable:!0}),t.InitializePlayground=function(t){return r(this,arguments,void 0,function(t,n){return void 0===n&&(n=null),a(this,function(i){return[2,e.SceneManager.InitializeRuntime(t,n)]})})},t.InitializeRuntime=function(t){return r(this,arguments,void 0,function(t,n){var i,o,r,l,s,u,c,d;return void 0===n&&(n=null),a(this,function(a){switch(a.label){case 0:BABYLON.Tools.Log("Babylon.js Toolkit v"+e.SceneManager.Version),i=null!=n&&null!=n.hardwareScalingLevel?n.hardwareScalingLevel:e.WindowManager.GetHardwareScalingLevel(),null==n||null==n.initSceneFileLoaders||n.initSceneFileLoaders,null==n||null==n.loadAsyncRuntimeLibs||n.loadAsyncRuntimeLibs,o=e.SceneManager.PlaygroundCdn+"default.playground.js",r=null!=n&&null!=n.loadProjectScriptBundle&&n.loadProjectScriptBundle,l=null!=n&&null!=n.projectScriptBundleUrl?n.projectScriptBundleUrl:o,s=null!=n&&null!=n.showDefaultLoadingScreen&&n.showDefaultLoadingScreen,u=null==n||null==n.hideLoadingUIWithEngine||n.hideLoadingUIWithEngine,c=null!=n&&null!=n.defaultLoadingUIMarginTop?n.defaultLoadingUIMarginTop:"150px",!0===s&&e.SceneManager.ShowLoadingScreen(t,u,c),null!=i&&i>0&&t.setHardwareScalingLevel(i),e.SceneManager.UniversalModuleDefinition=!0;try{e.SceneManager.InitializeSceneLoaderPlugin()}catch(e){console.warn("Babylon Toolkit: Failed to initialize loader plugin:",e)}try{BABYLON&&BABYLON.GLTF2&&BABYLON.GLTF2.registerGLTFExtension?(e.SceneManager.CVTOOLS_NAME_REGISTERED||(BABYLON.GLTF2.registerGLTFExtension(e.SceneManager.CVTOOLS_NAME,!0,function(t){return new e.CVTOOLS_unity_metadata(t)}),e.SceneManager.CVTOOLS_NAME_REGISTERED=!0),e.SceneManager.CVTOOLS_MESH_REGISTERED||(BABYLON.GLTF2.registerGLTFExtension(e.SceneManager.CVTOOLS_MESH,!0,function(t){return new e.CVTOOLS_babylon_mesh(t)}),e.SceneManager.CVTOOLS_MESH_REGISTERED=!0),e.SceneManager.CVTOOLS_HAND_REGISTERED||(BABYLON.GLTF2.registerGLTFExtension(e.SceneManager.CVTOOLS_HAND,!0,function(t){return new e.CVTOOLS_left_handed(t)}),e.SceneManager.CVTOOLS_HAND_REGISTERED=!0)):console.warn("Babylon Toolkit: UMD GLTF Parser not registered because BABYLON.GLTF2 or RegisterGLTFExtension is not available.")}catch(e){console.warn("Babylon Toolkit: Failed to initialize GLTF extensions:",e)}return!0!==r||null==l||""===l?[3,2]:(d=l.substring(l.lastIndexOf("/")+1).toLowerCase(),[4,BABYLON.Tools.LoadScriptAsync(l,d)]);case 1:a.sent(),a.label=2;case 2:return[2]}})})},t.InitializeSceneLoaderPlugin=function(){BABYLON.SceneLoader.OnPluginActivatedObservable.add(function(t){null!=t&&"gltf"===t.name&&t instanceof BABYLON.GLTFFileLoader&&(t.extensions,t.animationStartMode=e.SceneManager.AnimationStartMode,t.targetFps=e.SceneManager.AnimationTargetFps,t.onSkinLoadedObservable&&t.onSkinLoadedObservable.add(function(e){if(null!=e){try{null!=e.skinnedNode&&(e.skinnedNode.id+=".Skin")}catch(e){console.warn(e)}try{null!=e.skinnedNode&&(e.skinnedNode.name+=".Skin")}catch(e){console.warn(e)}try{if(null!=e.node&&null!=e.skinnedNode){var t=BABYLON.Tags.GetTags(e.node);null!=t&&BABYLON.Tags.AddTagsTo(e.skinnedNode,t),e.node._skinnedMesh=e.skinnedNode}else console.warn("Babylon Toolkit: Skinned node not found in scene loader plugin: ",e)}catch(e){console.warn(e)}}}))})},t.LoadRuntimeAssets=function(t,n,i){return r(this,arguments,void 0,function(t,n,i,o,r){return void 0===o&&(o=60),void 0===r&&(r=!1),a(this,function(a){switch(a.label){case 0:return e.SceneManager.SetOnSceneReadyHandler(n,i,o,r),null==t?[3,2]:[4,t.loadAsync()];case 1:a.sent(),a.label=2;case 2:return[2]}})})},t.ShowLoadingScreen=function(t,n,i){if(void 0===n&&(n=!0),void 0===i&&(i="150px"),null!=t.loadingScreen){e.SceneManager._HideLoadingScreen=t.loadingScreen.hideLoadingUI.bind(t.loadingScreen),!1===n&&(t.loadingScreen.hideLoadingUI=function(){});var o=t.loadingScreen;o._loadingDivBackgroundColor="#2A2342",t.displayLoadingUI(),null!=o._loadingTextDiv&&null!=o._loadingTextDiv.style&&(o._loadingTextDiv.style.marginTop=i)}},t.HideLoadingScreen=function(t){t.loadingScreen instanceof BABYLON.DefaultLoadingScreen?null!=e.SceneManager._HideLoadingScreen?e.SceneManager._HideLoadingScreen():t.hideLoadingUI():e.SceneManager.ForceHideLoadingScreen()},t.ForceHideLoadingScreen=function(){try{e.SceneManager.DoForceHideLoadingScreen()}catch(e){console.warn(e)}finally{try{e.SceneManager.DoForceHideLoadingScreen()}catch(e){console.warn(e)}finally{try{e.SceneManager.DoForceHideLoadingScreen()}catch(e){console.warn(e)}}}},t.DoForceHideLoadingScreen=function(){var e=document.getElementById("babylonjsLoadingDiv"),t=document.getElementById("babylonjsLoadingText"),n=document.getElementById("babylonjsLoadingDivStyle");try{null!=t&&(t.remove(),t=null)}catch(e){console.warn(e)}try{null!=e&&(e.remove(),e=null)}catch(e){console.warn(e)}try{null!=n&&n.remove()}catch(e){console.warn(e)}},t.FocusRenderCanvas=function(e){e.getEngine().getRenderingCanvas().focus()},t.SetOnSceneReadyHandler=function(t,n,i,o){void 0===i&&(i=60),void 0===o&&(o=!1),e.SceneManager.SceneLoaderPropertyBag={},e.SceneManager.SceneLoaderHandledFlag=!1,e.SceneManager.SceneLoaderFileNames=t,e.SceneManager.SceneLoaderFileNames.forEach(function(t){e.SceneManager.SceneLoaderPropertyBag[t.toLowerCase()]=!1}),e.SceneManager.OnSceneReadyObservable.clear(),e.SceneManager.OnSceneReadyObservable.add(function(t){if(!0===o&&console.log("OnSceneReady(): "+t),e.SceneManager.SceneLoaderPropertyBag[t.toLowerCase()]=!0,!0===Object.values(e.SceneManager.SceneLoaderPropertyBag).every(function(e){return!0===e}))try{n&&n()}catch(e){console.warn(e)}finally{e.SceneManager.SceneLoaderHandledFlag=!0}}),e.WindowManager.SetTimeout(1e3*i,function(){if(!1===e.SceneManager.SceneLoaderHandledFlag)try{n&&n()}catch(e){console.warn(e)}finally{e.SceneManager.SceneLoaderHandledFlag=!0,e.SceneManager.ForceHideLoadingScreen()}})},t.EnableSceneParsing=function(t){e.SceneManager.SceneParsingEnabled=t},t.IsSceneParsingEnabled=function(){return e.SceneManager.SceneParsingEnabled},t.HasSceneBeenPreLoaded=function(e){var t=e;return null!=t._preloaded&&!0===t._preloaded},t.GetDefaultSkybox=function(e){return e.getMeshById("Default Skybox")},t.GetIntensityFactor=function(){return null!=e.SceneManager.GlobalOptions.intensityFactor?e.SceneManager.GlobalOptions.intensityFactor:2},t.GetRenderQuality=function(){var t=e.RenderQuality.High,n=e.SceneManager.GlobalOptions.renderQuality;return null!=n&&(t=n),t},t.SetRenderQuality=function(t){e.SceneManager.GlobalOptions.renderQuality=t},t.GetEngineVersionString=function(t){var n="Unknown",i=t||e.SceneManager.GetLastCreatedScene();if(null!=i){var o=e.SceneManager.GetEngine(i);if(null!=o){var r=o.getInfo();null!=r&&(n=r.version+" - "+r.renderer)}}return n},t.SetWindowState=function(t,n){e.SceneManager.WindowState[t]=n},t.GetWindowState=function(t){var n=e.SceneManager.WindowState[t];return null!=n?n:null},t.IsDebugMode=function(){return null!=e.SceneManager.GlobalOptions.debugModeEnabled&&!0===e.SceneManager.GlobalOptions.debugModeEnabled},t.ConsoleLog=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];e.SceneManager.IsDebugMode()&&console.log.apply(console,t)},t.ConsoleInfo=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];e.SceneManager.IsDebugMode()&&console.info.apply(console,t)},t.ConsoleWarn=function(){for(var t=[],n=0;n<arguments.length;n++)t[n]=arguments[n];e.SceneManager.IsDebugMode()&&console.warn.apply(console,t)},t.ConsoleError=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];console.error.apply(console,e)},t.LogMessage=function(t){e.SceneManager.IsDebugMode()&&BABYLON.Tools.Log(t)},t.LogWarning=function(t){e.SceneManager.IsDebugMode()&&BABYLON.Tools.Warn(t)},t.LogError=function(e){BABYLON.Tools.Error(e)},t.GetTime=function(){return.001*e.SceneManager.GetTimeMilliseconds()},t.GetTimeMs=function(){return e.SceneManager.GetTimeMilliseconds()},t.GetGameTime=function(){return.001*(e.SceneManager.GetTimeMilliseconds()-e.SceneManager.GameTimeMilliseconds)},t.GetGameTimeMs=function(){return e.SceneManager.GetTimeMilliseconds()-e.SceneManager.GameTimeMilliseconds},t.GetDeltaTime=function(t,n){return void 0===n&&(n=!1),e.SceneManager.GetDeltaSeconds(t,n)},t.GetDeltaSeconds=function(t,n){void 0===n&&(n=!1);var i=t||e.SceneManager.GetLastCreatedScene(),o=.001*Math.max(BABYLON.Scene.MinDeltaTime,Math.min(i.getEngine().getDeltaTime(),BABYLON.Scene.MaxDeltaTime));return!0===n&&(o*=i.getAnimationRatio()),o},t.GetDeltaMilliseconds=function(t,n){void 0===n&&(n=!1);var i=t||e.SceneManager.GetLastCreatedScene(),o=Math.max(BABYLON.Scene.MinDeltaTime,Math.min(i.getEngine().getDeltaTime(),BABYLON.Scene.MaxDeltaTime));return!0===n&&(o*=i.getAnimationRatio()),o},t.GetTimeMilliseconds=function(){var e=0;return"undefined"!=typeof window&&window.performance?e=window.performance.now():"undefined"!=typeof window&&window.Date?e=window.Date.now():null!=Date&&(e=Date.now()),e},t.GetAnimationRatio=function(t){return(t||e.SceneManager.GetLastCreatedScene()).getAnimationRatio()},t.RunOnce=function(e,t,n){e.executeOnceBeforeRender(t,n)},t.DisposeScene=function(e,t){void 0===t&&(t=new BABYLON.Color4(0,0,0,1));var n=e.getEngine();e.dispose(),n.clear(t,!0,!0,!0)},t.SafeDestroy=function(t,n,i){void 0===n&&(n=5),void 0===i&&(i=!1),n>0?(!0===i&&t.setEnabled(!1),e.WindowManager.SetTimeout(n,function(){t.dispose(!1,!1)})):t.dispose(!1,!1)},t.GetRootUrl=function(e){return null!=e._rootUrl&&""!==e._rootUrl?e._rootUrl:"/"},t.SetRootUrl=function(e,t){e._rootUrl=t},t.GetSceneFile=function(e){return null!=e._fileName&&""!==e._fileName?e._fileName:null},t.SetSceneFile=function(e,t){e._fileName=t},t.GetEngineInstances=function(){return BABYLON.EngineStore.Instances},t.GetLastCreatedEngine=function(){return BABYLON.EngineStore.LastCreatedEngine},t.GetLastCreatedScene=function(){return BABYLON.EngineStore.LastCreatedScene},t.AddShadowCaster=function(e,t,n){void 0===n&&(n=!1);var i=(null==e?void 0:e.getShadowGenerator()).getShadowMap();if(null==i.renderList&&(i.renderList=[]),t instanceof BABYLON.AbstractMesh&&i.renderList.indexOf(t)<0&&i.renderList.push(t),!0===n){var o=t.getChildMeshes(!1);null!=o&&o.forEach(function(e){i.renderList.indexOf(e)<0&&i.renderList.push(e)})}},t.IsPhysicsViewerEnabled=function(){return e.SceneManager.PhysicsViewersEnabled},t.TogglePhysicsViewer=function(t){if(e.SceneManager.PhysicsViewersEnabled=!e.SceneManager.PhysicsViewersEnabled,e.SceneManager.PhysicsViewersEnabled){var n=new BABYLON.Debug.PhysicsViewer(t);null==t.reservedDataStore&&(t.reservedDataStore={}),t.reservedDataStore.physicsViewer=n;for(var i=0,o=t.meshes;i<o.length;i++){var r=o[i];r.physicsImpostor?(s=n.showImpostor(r.physicsImpostor,r))&&(s.reservedDataStore={hidden:!0},s.material&&(s.material.reservedDataStore={hidden:!0})):r.physicsBody&&(s=n.showBody(r.physicsBody))&&(s.reservedDataStore={hidden:!0},s.material&&(s.material.reservedDataStore={hidden:!0}))}for(var a=0,l=t.transformNodes;a<l.length;a++){var s,u=l[a];u.physicsBody&&(s=n.showBody(u.physicsBody))&&(s.reservedDataStore={hidden:!0},s.material&&(s.material.reservedDataStore={hidden:!0}))}}else t.reservedDataStore&&t.reservedDataStore.physicsViewer&&(t.reservedDataStore.physicsViewer.dispose(),t.reservedDataStore.physicsViewer=null)},t.GetImportMeshes=function(e,t){return null==e||null==t||""===t?null:null!=e.importMeshes?e.importMeshes.get(t.toLowerCase()):null},t.GetImportMeshesMap=function(e){return null==e?null:null!=e.importMeshes?e.importMeshes:null},t.ClearImportMeshes=function(e){if(null==e)return null;e.importMeshes,e.importMeshes=new Map},t.RegisterImportMeshes=function(e,t,n){null!=e&&null!=t&&""!==t&&null!=n&&(null==e.importMeshes&&(e.importMeshes=new Map),e.importMeshes.set(t.toLowerCase(),n))},t.LoadImportMeshes=function(t,n,i,o,r,a,l,s,u){var c=null,d=n+i,p=e.SceneManager.GetImportMeshes(o,d);return null!=p?r&&r(p):c=BABYLON.SceneLoader.ImportMesh(t,n,i,o,function(t){e.SceneManager.RegisterImportMeshes(o,d,t),r&&r(t)},a,l,s,u),c},t.LoadImportMeshesAsync=function(t,n,i,o,l,s,u){return r(this,void 0,void 0,function(){var r,c,d,p;return a(this,function(a){switch(a.label){case 0:return r=n+i,null==(c=e.SceneManager.GetImportMeshes(o,r))?[3,1]:[2,c];case 1:return d=null,[4,BABYLON.SceneLoader.ImportMeshAsync(t,n,i,o,l,s,u)];case 2:return null!=(p=a.sent())&&null!=p.meshes&&(d=p.meshes),e.SceneManager.RegisterImportMeshes(o,r,d),[2,d]}})})},t.GetAssetContainer=function(e,t){return null==e||null==t||""===t?null:null!=e.assetContainers?e.assetContainers.get(t.toLowerCase()):null},t.GetAssetContainerMap=function(e){return null==e?null:null!=e.assetContainers?e.assetContainers:null},t.ClearAssetContainers=function(e){if(null==e)return null;e.assetContainers,e.assetContainers=new Map},t.RegisterAssetContainer=function(e,t,n){null!=e&&null!=t&&""!==t&&null!=n&&(null==e.assetContainers&&(e.assetContainers=new Map),e.assetContainers.set(t.toLowerCase(),n))},t.LoadAssetContainer=function(t,n,i,o,r,a,l,s){var u=t+n,c=e.SceneManager.GetAssetContainer(i,u);null!=c?o&&o(c):BABYLON.SceneLoader.LoadAssetContainer(t,n,i,function(t){e.SceneManager.RegisterAssetContainer(i,u,t),o&&o(t)},r,a,l,s)},t.LoadAssetContainerAsync=function(t,n,i,o,l,s){return r(this,void 0,void 0,function(){var r,u,c;return a(this,function(a){switch(a.label){case 0:return r=t+n,null==(u=e.SceneManager.GetAssetContainer(i,r))?[3,1]:[2,u];case 1:return[4,BABYLON.SceneLoader.LoadAssetContainerAsync(t,n,i,o,l,s)];case 2:return c=a.sent(),e.SceneManager.RegisterAssetContainer(i,r,c),[2,c]}})})},t.GetMesh=function(e,t){return null==e?null:e.getNodeByName(t)},t.GetMeshByID=function(e,t){return null==e?null:e.getNodeById(t)},t.GetAbstractMesh=function(e,t){return null==e?null:e.getNodeByName(t)},t.GetAbstractMeshByID=function(e,t){return null==e?null:e.getNodeById(t)},t.GetTransformNode=function(e,t){return null==e?null:e.getNodeByName(t)},t.GetTransformNodeByID=function(e,t){return null==e?null:e.getNodeById(t)},t.GetTransformDetailMesh=function(e){var t=null,n=e.name+".Detail",i=e.getChildren(function(e){return e.name===n&&e instanceof BABYLON.AbstractMesh},!0);return null!=i&&i.length>0&&(t=i[0]),t},t.GetSkinnedMesh=function(e){return null!=e._skinnedMesh?e._skinnedMesh:null},t.GetPrimitiveMeshes=function(e){return e.getChildMeshes(!0,function(e){return e.name.indexOf("_primitive")>=0})},t.GetTransformLayer=function(e){return null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.layer?e.metadata.toolkit.layer:0},t.GetTransformLayerMask=function(e){return null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.layermask?e.metadata.toolkit.layermask:1},t.GetTransformLayerName=function(e){return null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.layername&&""!==e.metadata.toolkit.layername?e.metadata.toolkit.layername:"Default"},t.GetTransformTag=function(e){return null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.group&&""!==e.metadata.toolkit.group?e.metadata.toolkit.group:"Untagged"},t.HasTransformTags=function(e,t){return BABYLON.Tags.MatchesQuery(e,t)},t.HasSoundManager=function(){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem},t.IsSoundEffectPlaying=function(e){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.SFX&&PROJECT.SceneSoundSystem.SFX.isPlaying(e)},t.IsMusicTrackPlaying=function(e){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.isPlaying(e)},t.PlayOneShot=function(e,t,n,i){return r(this,void 0,void 0,function(){return a(this,function(o){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.SFX?[2,PROJECT.SceneSoundSystem.SFX.playTrack(e,t,n,i)]:[2,!1]})})},t.PlayMusicTrack=function(e,t,n,i){return r(this,void 0,void 0,function(){return a(this,function(o){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC?[2,PROJECT.SceneSoundSystem.MUSIC.playTrack(e,t,n,i)]:[2,!1]})})},t.PauseMusicTrack=function(e){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.pauseTrack(e)},t.MuteMusicTrack=function(e,t){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.muteTrack(e,t,offset,length)},t.UnmuteMusicTrack=function(e,t){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.unmuteTrack(e,t)},t.StopMusicTrack=function(e,t){return null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.stopTrack(e,t)},t.StopAllMusicTracks=function(){null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.stopAllTracks()},t.PauseAllMusicTracks=function(){null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.pauseAllTracks()},t.MuteAllMusicTracks=function(e){null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.muteAllTracks(e)},t.UnmuteAllMusicTracks=function(e){null!=PROJECT&&null!=PROJECT.SceneSoundSystem&&null!=PROJECT.SceneSoundSystem.MUSIC&&PROJECT.SceneSoundSystem.MUSIC.unmuteAllTracks(e)},t.TextureFloatSupported=function(e){var t=!1,n=!1,i=e.getEngine().getCaps();return i.textureHalfFloatRender&&i.textureHalfFloatLinearFiltering?t=!0:i.textureFloatRender&&i.textureFloatLinearFiltering&&(n=!0),t||n},t.RegisterClickAction=function(e,t,n){var i=null;return null!=t&&(t.isPickable=!0,null==t.actionManager&&(t.actionManager=new BABYLON.ActionManager(e)),i=t.actionManager.registerAction(new BABYLON.ExecuteCodeAction({trigger:BABYLON.ActionManager.OnPickTrigger},n))),i},t.UnregisterClickAction=function(e,t){var n=!1;return null!=e&&null!=t&&(n=e.actionManager.unregisterAction(t)),n},t.GetMaterialWithName=function(e,t){var n=null;if(null!=e.materials&&e.materials.length>0){e.materials.length;for(var i=0;i<e.materials.length;i++){var o=e.materials[i];if(o.name.startsWith(t)){n=o;break}}}return n},t.GetAllMaterialsWithName=function(e,t){var n=null;if(null!=e.materials&&e.materials.length>0){e.materials.length;for(var i=0;i<e.materials.length;i++){var o=e.materials[i];o.name.startsWith(t)&&(null==n&&(n=[]),n.push(o))}}return n},t.InstantiatePrefabFromScene=function(t,n,i,o,r,a,l,s){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=null),void 0===s&&(s=!0);var u=null;if(null!=t&&null!=n&&""!==n){var c=t.getNodeByName(n);if(null!=c)if(null!=(u=c.clone(i,o,!1))){null!=r&&(u.position=r.clone()),null!=a&&(u.rotationQuaternion=a.clone()),null!=l&&(u.scaling=l.clone());var d=null,p=u.getChildren(null,!1);null!=p&&(d=p),null==d?d=[u]:d.unshift(u),d.forEach(function(e){if(e.setEnabled(!0),e instanceof BABYLON.AbstractMesh&&null!=e.metadata&&null!=e.metadata.shadowCastingMode&&0!==e.metadata.shadowCastingMode&&t.lights.forEach(function(t){var n=t.getShadowGenerator();if(null!=n&&!1==(null!=t.includedOnlyMeshes&&t.includedOnlyMeshes.length>0)){var i=n.getShadowMap();null==i.renderList&&(i.renderList=[]),i.renderList.indexOf(e)<0&&i.renderList.push(e)}}),e instanceof BABYLON.Mesh)if(null!=e.source){if(null==e.skeleton&&null!=e.source.skeleton){var n=e.source.skeleton.name+".Skeleton",i=n+"."+e.source.skeleton.id;if(e.skeleton=e.source.skeleton.clone(n,i),null!=e.skeleton&&null!=e.skeleton.bones&&null!=e.source.skeleton.bones&&e.skeleton.bones.length===e.source.skeleton.bones.length)for(var o=e.skeleton.bones.length,r=0;r<o;r++)null==e.skeleton.bones[r].metadata&&null!=e.source.skeleton.bones[r].metadata&&(e.skeleton.bones[r].metadata=e.source.skeleton.bones[r].metadata)}}else BABYLON.Tools.Warn("Babylon.js encountered a null clone source for: "+e.name)});var h=[];if(d.forEach(function(e){h.push(e)}),null!=h&&h.length>0){var m=[];e.Utilities.PostParseSceneComponents(t,h,null,m),t.onAfterRenderObservable.addOnce(function(){if(null!=m&&m.length>0)for(var e=0;e<m.length;e++){var t=m[e];null!=t&&t.delayComponentInstance&&t.delayComponentInstance(t)}})}}else BABYLON.Tools.Warn("Failed to create prefab of: "+n);else BABYLON.Tools.Warn("Failed to lookup prefab map: "+n)}else BABYLON.Tools.Warn("Unable to locate prefab master: "+n);return u},t.InstantiatePrefabFromContainer=function(t,n,i,o,r,a,l,s,u){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=null),void 0===s&&(s=!0),void 0===u&&(u=!1);var c=e.Utilities.CloneAssetContainerItem(t,n,function(e){return e},o,u,s);if(null!=c){null!=i&&""!==i&&(c.name=i),null!=r&&(c.position=r.clone()),null!=a&&(c.rotationQuaternion=a.clone()),null!=l&&(c.scaling=l.clone());var d=[];d.push(c);var p=c.getChildren(null,!1);null!=p&&p.length>0&&p.forEach(function(e){d.push(e)}),d.forEach(function(t){t.id=e.Utilities.CreateGuid(),t.setEnabled(!0)});var h=[];e.Utilities.PostParseSceneComponents(t.scene,d,null,h),t.scene.onAfterRenderObservable.addOnce(function(){if(null!=h&&h.length>0)for(var e=0;e<h.length;e++){var t=h[e];null!=t&&t.delayComponentInstance&&t.delayComponentInstance(t)}})}return c},t.InstantiateModelsFromContainer=function(t,n,i,o,r,a){void 0===n&&(n=null),void 0===i&&(i=!1),void 0===o&&(o=!1),void 0===r&&(r=!1),void 0===a&&(a=null);var s=null,u=t.instantiateModelsToScene(n,o,{doNotInstantiate:!i,predicate:a});if(null!=u&&null!=u.rootNodes&&u.rootNodes.length>0){var c=u.rootNodes[0],d=c.getChildren(null,!1);!0===r&&e.SceneManager.RebuildBoundingBoxInfo(d),s=l([c],d,!0)}return s},t.CreateInstancedModelsFromContainer=function(t,n,i,o,r,a,l,s,u){void 0===n&&(n=null),void 0===i&&(i=null),void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=!0),void 0===s&&(s=!1),void 0===u&&(u=!1);var c=null,d=null,p=null,h=t.instantiateModelsToScene(function(e){return e},s,{doNotInstantiate:!1});if(null!=h&&(null!=h.rootNodes&&h.rootNodes.length>0&&(d=h.rootNodes[0].getChildren(null,!1),!0===u&&e.SceneManager.RebuildBoundingBoxInfo(d)),null!=h.animationGroups&&(p=h.animationGroups)),null!=d){if(c=d[0],null!=i&&(c.parent=i),null!=n&&""!==n&&(c.name=n),null!=o&&(c.position=o.clone()),null!=r&&(c.rotationQuaternion=r.clone()),null!=a&&(c.scaling=a.clone()),d.forEach(function(t){t.id=e.Utilities.CreateGuid(),t.setEnabled(!0)}),!0===l){var m=null;p.forEach(function(e){var t=e,n=null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.source&&""!==t.metadata.toolkit.source?t.metadata.toolkit.source:null;if(null!=n&&""!==n){var i=e.clone(e.name),o=n;null!=t.metadata&&(i.metadata={},i.metadata.toolkit={},i.metadata.toolkit.id=t.metadata.toolkit.id,i.metadata.toolkit.clip=t.metadata.toolkit.clip,i.metadata.toolkit.source=o,i.metadata.toolkit.legacy=t.metadata.toolkit.legacy,i.metadata.toolkit.length=t.metadata.toolkit.length,i.metadata.toolkit.looping=t.metadata.toolkit.looping,i.metadata.toolkit.settings=t.metadata.toolkit.settings,i.metadata.toolkit.behavior=t.metadata.toolkit.behavior,i.metadata.toolkit.wrapmode=t.metadata.toolkit.wrapmode,i.metadata.toolkit.framerate=t.metadata.toolkit.framerate,i.metadata.toolkit.humanmotion=t.metadata.toolkit.humanmotion,i.metadata.toolkit.averagespeed=t.metadata.toolkit.averagespeed,i.metadata.toolkit.averageduration=t.metadata.toolkit.averageduration,i.metadata.toolkit.averageangularspeed=t.metadata.toolkit.averageangularspeed),null==m&&(m=[]),m.push(i)}}),null!=c&&null!=m&&e.Utilities.AssignAnimationGroupsToInstance(c,m)}var f=[];e.Utilities.PostParseSceneComponents(t.scene,d,null,f),t.scene.onAfterRenderObservable.addOnce(function(){if(null!=f&&f.length>0)for(var e=0;e<f.length;e++){var t=f[e];null!=t&&t.delayComponentInstance&&t.delayComponentInstance(t)}})}return h},t.CloneTransformNode=function(t,n,i,o,r,a,l){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=null);var s=e.Utilities.GetAssetContainerNode(t,n).clone(i,o,!0);return null!=s&&(null!=r&&(s.position=r.clone()),null!=a&&(s.rotationQuaternion=a.clone()),null!=l&&(s.scaling=l.clone()),s.setEnabled(!0)),s},t.CloneAbstractMesh=function(t,n,i,o,r,a,l){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=null);var s=e.Utilities.GetAssetContainerMesh(t,n).clone(i,o,!0);return null!=s&&(null!=r&&(s.position=r.clone()),null!=a&&(s.rotationQuaternion=a.clone()),null!=l&&(s.scaling=l.clone()),s.setEnabled(!0)),s},t.CreateInstancedMesh=function(t,n,i,o,r,a,l){void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=null);var s=e.Utilities.GetAssetContainerMesh(t,n).createInstance(i);return null!=s&&(null!=o&&(s.parent=o),null!=r&&(s.position=r.clone()),null!=a&&(s.rotationQuaternion=a.clone()),null!=l&&(s.scaling=l.clone()),s.setEnabled(!0)),s},t.RebuildBoundingBoxInfo=function(e){null!=e&&e.length>0&&e.forEach(function(e){var t,n;if(e instanceof BABYLON.InstancedMesh){var i=null===(t=e.sourceMesh.getBoundingInfo())||void 0===t?void 0:t.boundingBox;null!=i&&null!=i.minimum&&null!=i.maximum&&e.setBoundingInfo(new BABYLON.BoundingInfo(i.minimum,i.maximum))}else if(e instanceof BABYLON.AbstractMesh){var o=null===(n=e.getBoundingInfo())||void 0===n?void 0:n.boundingBox;null!=o&&null!=o.minimum&&null!=o.maximum&&e.setBoundingInfo(new BABYLON.BoundingInfo(o.minimum,o.maximum))}})},t.AttachScriptComponent=function(e,t,n){void 0===n&&(n=!0),null!=e&&e.registerComponentInstance&&e.registerComponentInstance(e,t,n)},t.DestroyScriptComponent=function(e){null!=e&&e.destroyComponentInstance&&e.destroyComponentInstance(e)},t.DestroyGameObject=function(t){if(null!=t){var n=e.SceneManager.FindScriptComponents(t,!0);if(null!=n&&n.length>0)for(var i=0;i<n.length;i++){var o=n[i];e.SceneManager.DestroyScriptComponent(o)}e.SceneManager.SafeDestroy(t)}},t.GetComponent=function(t,n,i){return void 0===i&&(i=!1),e.SceneManager.FindScriptComponent(t,n,i)},t.GetComponents=function(t,n){return void 0===n&&(n=!1),e.SceneManager.FindScriptComponents(t,n)},t.FindGameObject=function(e,t){if(!t||""===t.trim())return null;var n=t.split("/").filter(function(e){return""!==e.trim()});if(0===n.length)return null;for(var i=null,o=e.rootNodes,r=function(e){var t=n[e];if(0===e)i=o.find(function(e){return e.name===t})||null;else{if(!i)return"break";var r=i.getChildren(null,!1);i=r.find(function(e){return e.name===t})||null}if(!i)return"break"},a=0;a<n.length&&"break"!==r(a);a++);if(i&&i instanceof BABYLON.TransformNode)return i;for(var l=0,s=o;l<s.length;l++){var u=s[l];if(u.name&&u.getChildren){var c,d="".concat(u.name,"/").concat(t);if(d!==t&&(c=this.FindGameObjectExactPath(e,d)))return c}}return 1===n.length&&(c=this.FindGameObjectRecursive(e,n[0]))?c:null},t.FindGameObjectExactPath=function(e,t){for(var n=t.split("/").filter(function(e){return""!==e.trim()}),i=null,o=e.rootNodes,r=function(e){var t=n[e];if(0===e)i=o.find(function(e){return e.name===t})||null;else{if(!i)return{value:null};var r=i.getChildren(null,!1);i=r.find(function(e){return e.name===t})||null}if(!i)return{value:null}},a=0;a<n.length;a++){var l=r(a);if("object"==typeof l)return l.value}return i instanceof BABYLON.TransformNode?i:null},t.FindGameObjectRecursive=function(e,t){for(var n=function(e){if(e.name===t&&e instanceof BABYLON.TransformNode)return e;if(e.getChildren)for(var i=0,o=e.getChildren(null,!1);i<o.length;i++){var r=o[i],a=n(r);if(a)return a}return null},i=0,o=e.rootNodes;i<o.length;i++){var r=o[i],a=n(r);if(a)return a}return null},t.DebugSceneHierarchy=function(e,t){void 0===t&&(t=3),console.log("=== SCENE HIERARCHY DEBUG ===");var n=function(e,i,o){if(void 0===o&&(o=""),!(i>t)){var r="  ".repeat(i),a=e instanceof BABYLON.TransformNode?"TransformNode":e instanceof BABYLON.AbstractMesh?"Mesh":e instanceof BABYLON.Camera?"Camera":e instanceof BABYLON.Light?"Light":e.constructor.name;if(console.log("".concat(r).concat(o).concat(e.name," (").concat(a,")")),e instanceof BABYLON.TransformNode||e instanceof BABYLON.AbstractMesh){var l=e.getChildren(null,!1);l.forEach(function(e,t){var o=t===l.length-1;n(e,i+1,o?"└─ ":"├─ ")})}}};console.log("Root nodes:"),e.rootNodes.forEach(function(t,i){var o=i===e.rootNodes.length-1;n(t,0,o?"└─ ":"├─ ")}),console.log("=== END HIERARCHY DEBUG ===")},t.LegacySearchForGameObject=function(e,t){for(var n=t.split("/"),i=null,o=e.rootNodes,r=function(e){var t=n[e];if(0===e)i=o.find(function(e){return e.name===t})||null;else{if(!(i&&i instanceof BABYLON.TransformNode))return{value:null};i=i.getChildren(function(e){return e.name===t},!1)[0]||null}if(!i)return{value:null}},a=0;a<n.length;a++){var l=r(a);if("object"==typeof l)return l.value}return i},t.FindGameObjectWithTag=function(t,n){for(var i=function(t){if(e.SceneManager.GetTransformTag(t)===n)return t;if(t instanceof BABYLON.TransformNode)for(var o=0,r=t.getChildren();o<r.length;o++){var a=r[o];if(a instanceof BABYLON.TransformNode){var l=i(a);if(l)return l}}return null},o=0,r=t.rootNodes;o<r.length;o++){var a=r[o];if(a instanceof BABYLON.TransformNode){var l=i(a);if(l)return l}}return null},t.FindGameObjectsWithTag=function(t,n){for(var i=[],o=function(t){if(e.SceneManager.GetTransformTag(t)===n&&i.push(t),t instanceof BABYLON.TransformNode)for(var r=0,a=t.getChildren();r<a.length;r++){var l=a[r];l instanceof BABYLON.TransformNode&&o(l)}},r=0,a=t.rootNodes;r<a.length;r++){var l=a[r];l instanceof BABYLON.TransformNode&&o(l)}return i},t.FindScriptComponents=function(t,n){if(void 0===n&&(n=!1),null==t)return null;var i=null;if(null!=t.metadata&&t.metadata.toolkit){var o=t.metadata.toolkit;if(null!=o.components&&o.components.length>0)for(var r=0;r<o.components.length;r++){var a=o.components[r];null==i&&(i=[]),i.push(a.instance)}}if(!0===n){var l=t.getChildren(null,!1);if(null!=l)for(var s=0;s<l.length;s++){var u=l[s],c=e.SceneManager.FindScriptComponents(u,!1);null!=c&&(null==i&&(i=[]),i.push.apply(i,c))}}return null!=i?i:null},t.FindScriptComponent=function(t,n,i){if(void 0===i&&(i=!1),null==t)return null;var o=null;if(null!=t.metadata&&t.metadata.toolkit){var r=t.metadata.toolkit;if(null!=r.components&&r.components.length>0)for(var a=0;a<r.components.length;a++){var l=r.components[a];if(null!=l.instance&&l.klass===n){o=l.instance;break}}}if(null==o&&!0===i){var s=t.getChildren(null,!1);if(null!=s)for(var u=0;u<s.length;u++){var c=s[u];if(null!=(o=e.SceneManager.FindScriptComponent(c,n,!1)))break}}return null!=o?o:null},t.FindAllScriptComponents=function(t,n,i){if(void 0===i&&(i=!1),null==t)return null;var o=null;if(null!=t.metadata&&t.metadata.toolkit){var r=t.metadata.toolkit;if(null!=r.components&&r.components.length>0)for(var a=0;a<r.components.length;a++){var l=r.components[a];null!=l.instance&&l.klass===n&&(null==o&&(o=[]),o.push(l.instance))}}if(!0===i){var s=t.getChildren(null,!1);if(null!=s)for(var u=0;u<s.length;u++){var c=s[u],d=e.SceneManager.FindAllScriptComponents(c,n,!1);null!=d&&(null==o&&(o=[]),o.push.apply(o,d))}}return null!=o?o:null},t.FindSceneMetadata=function(e){return null==e?null:null!=e.metadata&&e.metadata.toolkit?e.metadata.toolkit:null},t.FindSceneCameraRig=function(e){return null==e?null:null!=e.cameraRig?e.cameraRig:null},t.FindSceneLightRig=function(e){return null==e?null:null!=e.lightRig?e.lightRig:null},t.FindTransformWithScript=function(t,n){var i=t.getNodes();return e.Utilities.SearchTransformNodeForScript(n,i)},t.FindAllTransformsWithScript=function(t,n){var i=t.getNodes();return e.Utilities.SearchAllTransformNodesForScript(n,i)},t.FindChildTransformNode=function(t,n,i,o,r){if(void 0===i&&(i=e.SearchType.ExactMatch),void 0===o&&(o=!0),void 0===r&&(r=null),null==t)return null;var a=null!=i?i:e.SearchType.ExactMatch,l=t.getChildren(r,o);return e.Utilities.SearchTransformNodes(n,l,a)},t.FindChildTransformWithTags=function(t,n,i,o){if(void 0===i&&(i=!0),void 0===o&&(o=null),null==t)return null;var r=t.getChildren(o,i);return e.Utilities.SearchTransformNodeForTags(n,r)},t.FindAllChildTransformsWithTags=function(t,n,i,o){if(void 0===i&&(i=!0),void 0===o&&(o=null),null==t)return null;var r=t.getChildren(o,i);return e.Utilities.SearchAllTransformNodesForTags(n,r)},t.FindChildTransformWithScript=function(t,n,i,o){if(void 0===i&&(i=!0),void 0===o&&(o=null),null==t)return null;var r=t.getChildren(o,i);return e.Utilities.SearchTransformNodeForScript(n,r)},t.FindAllChildTransformsWithScript=function(t,n,i,o){if(void 0===i&&(i=!0),void 0===o&&(o=null),null==t)return null;var r=t.getChildren(o,i);return e.Utilities.SearchAllTransformNodesForScript(n,r)},t.FindComponentInParent=function(t,n,i){var o=null!=n.parent?[n,n.parent]:[n],r=e.Utilities.SearchTransformNodeForScript(i,o);return e.SceneManager.FindScriptComponent(r,i)},t.FindComponentsInParent=function(t,n,i){var o=null,r=n.getChildren(null,!1),a=null!=r?l([n],r,!0):[n],s=e.Utilities.SearchAllTransformNodesForScript(i,a);return null!=s&&s.length>0&&s.forEach(function(t){var n=e.SceneManager.FindScriptComponent(t,i);null!=n&&(null==o&&(o=[]),o.push(n))}),null!=o?o:null},t.FindComponentInChildren=function(t,n,i){var o=n.getChildren(null,!1),r=null!=o?l([n],o,!0):[n],a=e.Utilities.SearchTransformNodeForScript(i,r);return e.SceneManager.FindScriptComponent(a,i)},t.FindComponentsInChildren=function(t,n,i){var o=null,r=n.getChildren(null,!1),a=null!=r?l([n],r,!0):[n],s=e.Utilities.SearchAllTransformNodesForScript(i,a);return null!=s&&s.length>0&&s.forEach(function(t){var n=e.SceneManager.FindScriptComponent(t,i);null!=n&&(null==o&&(o=[]),o.push(n))}),null!=o?o:null},t.SearchForScriptComponentByName=function(t,n){var i=t.getNodes(),o=e.Utilities.SearchTransformNodeForScript(n,i);return e.SceneManager.FindScriptComponent(o,n)},t.SearchForAllScriptComponentsByName=function(t,n){var i=null,o=t.getNodes(),r=e.Utilities.SearchAllTransformNodesForScript(n,o);return null!=r&&r.length>0&&r.forEach(function(t){var o=e.SceneManager.FindScriptComponent(t,n);null!=o&&(null==i&&(i=[]),i.push(o))}),null!=i?i:null},t.MoveWithCollisions=function(e,t){if(null==e)return null;null!=t&&e.moveWithCollisions(t)},t.MoveWithTranslation=function(e,t){if(null==e)return null;null!=t&&e.position.addInPlace(t)},t.TurnWithRotation=function(e,t,n){if(void 0===n&&(n=BABYLON.Space.LOCAL),null==e)return null;0!=t&&e.rotate(BABYLON.Axis.Y,t,n)},t.GetRecastHeapSize=function(){if("undefined"==typeof Recast)return 0;var e=0;return Recast&&Recast.HEAP8&&Recast.HEAP8.length&&(e=Recast.HEAP8.length/1048576),e},t.GetNavigationTools=function(){if("undefined"!=typeof Recast)return null==e.SceneManager.PluginInstance&&(e.SceneManager.PluginInstance=new e.RecastJSPluginExtension),e.SceneManager.PluginInstance},t.GetCrowdInterface=function(t){if("undefined"==typeof Recast)return null;if(e.SceneManager.HasNavigationData()){var n=e.SceneManager.GetNavigationTools();return null!=n&&null==e.SceneManager.CrowdInterface&&(e.SceneManager.CrowdInterface=n.createCrowd(e.SceneManager.MAX_AGENT_COUNT,e.SceneManager.MAX_AGENT_RADIUS,t)),e.SceneManager.CrowdInterface}return null},t.HasNavigationData=function(){if("undefined"==typeof Recast)return!1;var t=e.SceneManager.GetNavigationTools();return null!=t&&null!=t.navMesh},t.GetNavigationMesh=function(){return"undefined"==typeof Recast?null:e.SceneManager.NavigationMesh},t.BakeNavigationMesh=function(t,n,i,o,r,a,l){void 0===o&&(o=!1),void 0===r&&(r=null),void 0===a&&(a=!1),void 0===l&&(l=0);var s=-1;if("undefined"==typeof Recast)return s;BABYLON.Tools.Log("Recast.js baking navigation mesh data");var u=e.SceneManager.GetNavigationTools();if(null!=u)if(s=u.createNavMesh(n,i),null!=u.navMesh){var c="NavigationMesh",d=t.getMaterialByName(c);null==d&&((d=new BABYLON.PBRMaterial(c,t)).albedoColor=r||new BABYLON.Color3(.2627451,.5960785,.7372549),d.unlit=!0,d.alpha=.5),e.SceneManager.NavigationMesh=u.createDebugNavMesh(t),null!=e.SceneManager.NavigationMesh&&(e.SceneManager.NavigationMesh.position=new BABYLON.Vector3(0,l,0),e.SceneManager.NavigationMesh.material=d,e.SceneManager.NavigationMesh.isPickable=!1,e.SceneManager.NavigationMesh.isVisible=!0,e.SceneManager.NavigationMesh.visibility=!0===o?1:0,e.SceneManager.NavigationMesh.renderingGroupId=e.Utilities.ColliderRenderGroup(),BABYLON.Tags.AddTagsTo(e.SceneManager.NavigationMesh,"Navigation"),e.Utilities.ValidateTransformMetadata(e.SceneManager.NavigationMesh),!0===a&&(e.SceneManager.NavigationMesh.checkCollisions=!0,e.SceneManager.NavigationMesh.metadata.toolkit.physics=e.RigidbodyPhysics.CreatePhysicsMetadata(0,0,.05,new BABYLON.Vector3(0,0,0)),e.SceneManager.NavigationMesh.metadata.toolkit.collision=e.RigidbodyPhysics.CreateCollisionMetadata("MeshCollider",!1,!1,0,.6,.6),e.RigidbodyPhysics.SetupPhysicsComponent(t,e.SceneManager.NavigationMesh))),null!=e.SceneManager.NavigationMesh?!0===e.SceneManager.OnNavMeshReadyObservable.hasObservers()&&e.SceneManager.OnNavMeshReadyObservable.notifyObservers(e.SceneManager.NavigationMesh):BABYLON.Tools.Warn("Failed to generate navigation mesh geometry")}else BABYLON.Tools.Warn("Failed to create navigation mesh data");return s},t.LoadNavigationMesh=function(t,n,i,o,r,a,l){void 0===i&&(i=!1),void 0===o&&(o=null),void 0===r&&(r=0),void 0===a&&(a=!1),void 0===l&&(l=0);var s=-1;if("undefined"==typeof Recast)return s;BABYLON.Tools.Log("Recast.js loading prebaked navigation mesh");var u=e.SceneManager.GetNavigationTools();if(null!=u)if(u.setTimeStep&&u.setTimeStep(r),s=u.buildFromNavmeshData(n),null!=u.navMesh){var c="NavigationMesh",d=t.getMaterialByName(c);null==d&&((d=new BABYLON.PBRMaterial(c,t)).albedoColor=o||new BABYLON.Color3(.2627451,.5960785,.7372549),d.unlit=!0,d.alpha=.5),e.SceneManager.NavigationMesh=u.createDebugNavMesh(t),null!=e.SceneManager.NavigationMesh&&(e.SceneManager.NavigationMesh.position=new BABYLON.Vector3(0,l,0),e.SceneManager.NavigationMesh.material=d,e.SceneManager.NavigationMesh.isPickable=!1,e.SceneManager.NavigationMesh.isVisible=!0,e.SceneManager.NavigationMesh.visibility=!0===i?1:0,e.SceneManager.NavigationMesh.renderingGroupId=e.Utilities.ColliderRenderGroup(),BABYLON.Tags.AddTagsTo(e.SceneManager.NavigationMesh,"Navigation"),e.Utilities.ValidateTransformMetadata(e.SceneManager.NavigationMesh),!0===a&&(e.SceneManager.NavigationMesh.checkCollisions=!0,e.SceneManager.NavigationMesh.metadata.toolkit.physics=e.RigidbodyPhysics.CreatePhysicsMetadata(0,0,.05,new BABYLON.Vector3(0,0,0)),e.SceneManager.NavigationMesh.metadata.toolkit.collision=e.RigidbodyPhysics.CreateCollisionMetadata("MeshCollider",!1,!1,0,.6,.6),e.RigidbodyPhysics.SetupPhysicsComponent(t,e.SceneManager.NavigationMesh))),null!=e.SceneManager.NavigationMesh?!0===e.SceneManager.OnNavMeshReadyObservable.hasObservers()&&e.SceneManager.OnNavMeshReadyObservable.notifyObservers(e.SceneManager.NavigationMesh):BABYLON.Tools.Warn("Failed to generate navigation mesh geometry")}else BABYLON.Tools.Warn("Failed to build navigation mesh data");return s},t.SaveNavigationMesh=function(){if("undefined"==typeof Recast)return null;var t=e.SceneManager.GetNavigationTools();return null!=t&&null!=t.navMesh?t.getNavmeshData():null},t.ComputeNavigationPath=function(t,n,i){if(void 0===i&&(i=!0),"undefined"==typeof Recast)return null;var o=e.SceneManager.GetNavigationTools(),r=!0===i?o.getClosestPoint(t):t,a=!0===i?o.getClosestPoint(n):n;return null!=o&&null!=o.navMesh?o.computePath(r,a):null},t.MoveAlongNavigationPath=function(e,t,n,i,o,r){void 0===o&&(o=null);var a=null;if(n&&n.length>0){for(var l=0,s=[{frame:0,value:t.position}],u=0;u<n.length;u++)l+=BABYLON.Vector3.Distance(s[u].value,n[u]),s.push({frame:l,value:n[u]});a=new BABYLON.Animation("Navigation","position",3,BABYLON.Animation.ANIMATIONTYPE_VECTOR3,BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),null!=o&&a.setEasingFunction(o),a.setKeys(s),t.animations=[a],e.beginAnimation(t,0,l,!1,i,r)}return a},t.AddNavigationCylinderObstacle=function(t,n,i){if("undefined"==typeof Recast)return null;var o=e.SceneManager.GetNavigationTools();return null!=o&&null!=o.navMesh?o.addCylinderObstacle(t,n,i):null},t.AddNavigationBoxObstacle=function(t,n,i){if("undefined"==typeof Recast)return null;var o=e.SceneManager.GetNavigationTools();return null!=o&&null!=o.navMesh?o.addBoxObstacle(t,n,i):null},t.RemoveNavigationObstacle=function(t){if("undefined"==typeof Recast)return null;var n=e.SceneManager.GetNavigationTools();null!=n&&null!=n.navMesh&&n.removeObstacle(t)},t.ToggleFullscreenMode=function(e,t){void 0===t&&(t=!0),e.getEngine().switchFullscreen(t)},t.EnterFullscreenMode=function(t,n){void 0===n&&(n=!0),e.SceneManager.GotoFullscreenBrowser(t,n)},t.ExitFullscreenMode=function(t){e.SceneManager.ExitFromFullscreenBrowser(t)},t.GotoFullscreenBrowser=function(t,n){void 0===n&&(n=!0);var i=document.documentElement;i.requestFullscreen?i.requestFullscreen().then(function(){!0===n&&e.SceneManager.RequestBrowserPointerLock(i)}).catch(function(e){console.error("Error attempting to enable full-screen mode: ".concat(e.message," (").concat(e.name,")"))}):i.mozRequestFullScreen?(i.mozRequestFullScreen(),!0===n&&e.SceneManager.RequestBrowserPointerLock(i)):i.webkitRequestFullscreen?(i.webkitRequestFullscreen(),!0===n&&e.SceneManager.RequestBrowserPointerLock(i)):i.msRequestFullscreen?(i.msRequestFullscreen(),!0===n&&e.SceneManager.RequestBrowserPointerLock(i)):t.getEngine().enterFullscreen(n)},t.RequestBrowserPointerLock=function(e){e.requestPointerLock?e.requestPointerLock():e.mozRequestPointerLock?e.mozRequestPointerLock():e.webkitRequestPointerLock&&e.webkitRequestPointerLock()},t.ExitFromFullscreenBrowser=function(e){var t=document;t.exitFullscreen?t.exitFullscreen():t.mozCancelFullScreen?t.mozCancelFullScreen():t.webkitExitFullscreen?t.webkitExitFullscreen():t.msExitFullscreen?t.msExitFullscreen():e.getEngine().exitFullscreen()},t.CreateEasingFunction=function(e){if(!e)return null;if("string"==typeof e){var t=void 0;switch(e.toLowerCase()){case"linear":case"sineout":default:return(t=new BABYLON.SineEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"sinein":return(t=new BABYLON.SineEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"sineinout":return(t=new BABYLON.SineEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"quadin":return(t=new BABYLON.QuadraticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"quadout":return(t=new BABYLON.QuadraticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"quadinout":return(t=new BABYLON.QuadraticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"cubicin":return(t=new BABYLON.CubicEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"cubicout":return(t=new BABYLON.CubicEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"cubicinout":return(t=new BABYLON.CubicEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"quartin":return(t=new BABYLON.QuarticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"quartout":return(t=new BABYLON.QuarticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"quartinout":return(t=new BABYLON.QuarticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"quintin":return(t=new BABYLON.QuinticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"quintout":return(t=new BABYLON.QuinticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"quintinout":return(t=new BABYLON.QuinticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"expoin":return(t=new BABYLON.ExponentialEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"expoout":return(t=new BABYLON.ExponentialEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"expoinout":return(t=new BABYLON.ExponentialEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"circlein":return(t=new BABYLON.CircleEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"circleout":return(t=new BABYLON.CircleEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"circleinout":return(t=new BABYLON.CircleEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"backin":return(t=new BABYLON.BackEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"backout":return(t=new BABYLON.BackEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"backinout":return(t=new BABYLON.BackEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"elasticin":return(t=new BABYLON.ElasticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"elasticout":return(t=new BABYLON.ElasticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"elasticinout":return(t=new BABYLON.ElasticEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t;case"bouncein":return(t=new BABYLON.BounceEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEIN),t;case"bounceout":return(t=new BABYLON.BounceEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEOUT),t;case"bounceinout":return(t=new BABYLON.BounceEase).setEasingMode(BABYLON.EasingFunction.EASINGMODE_EASEINOUT),t}}return e},t.GetPropertyValue=function(e,t){for(var n=e,i=0,o=t.split(".");i<o.length;i++){var r=o[i];if(!n||"object"!=typeof n||!(r in n))return;n=n[r]}return n},t.SetPropertyValue=function(e,t,n){for(var i=t.split("."),o=e,r=0;r<i.length-1;r++){var a=i[r];a in o&&"object"==typeof o[a]||(o[a]={}),o=o[a]}o[i[i.length-1]]=n},t.IsGUIControl=function(e){if(!e)return!1;if(e.getClassName&&"function"==typeof e.getClassName){var t=e.getClassName();if(t&&t.includes("GUI"))return!0}return!!(e._host&&e._currentMeasure&&e._markAsDirty)||!!(e.constructor&&e.constructor.name&&e.constructor.name.includes("Control"))},t.IsGUIPositionProperty=function(e){return["left","top","width","height","paddingLeft","paddingTop","paddingRight","paddingBottom"].includes(e)},t.ExtractGUINumericValue=function(e,t){if(!e||!t)return 0;var n=t+"InPixels";if(void 0!==e[n]){var i=e[n];if("number"==typeof i&&!isNaN(i))return i}var o=e[t];return"string"==typeof o?o.endsWith("px")||o.endsWith("%")?parseFloat(o):parseFloat(o)||0:"number"==typeof o?o:0},t.CreateGUIAnimationProxy=function(t,n){var i={_control:t,_property:n,animations:[]};return Object.defineProperty(i,n,{get:function(){return e.SceneManager.ExtractGUINumericValue(i._control,i._property)},set:function(e){var t=i._property+"InPixels";void 0!==i._control[t]?i._control[t]=e:i._control[i._property]=e+"px"},enumerable:!0,configurable:!0}),i},t.GetAnimationType=function(e){if("number"==typeof e)return BABYLON.Animation.ANIMATIONTYPE_FLOAT;if(e&&"object"==typeof e){if(void 0!==e.x&&void 0!==e.y)return void 0!==e.z?BABYLON.Animation.ANIMATIONTYPE_VECTOR3:BABYLON.Animation.ANIMATIONTYPE_VECTOR2;if(void 0!==e.r&&void 0!==e.g&&void 0!==e.b)return BABYLON.Animation.ANIMATIONTYPE_COLOR3;if(void 0!==e.w&&void 0!==e.x&&void 0!==e.y&&void 0!==e.z)return BABYLON.Animation.ANIMATIONTYPE_QUATERNION}return BABYLON.Animation.ANIMATIONTYPE_FLOAT},t.CreateTweenAnimations=function(t,n,i,o,r){var a=[],l=[],s=60*(o.duration||1),u=e.SceneManager.IsGUIControl(t);for(var c in o.yoyo&&o.loop||o.yoyo&&o.yoyoCount&&o.yoyoCount>0&&o.yoyoCount,i){var d=i[c],p=n?n[c]:e.SceneManager.GetPropertyValue(t,c),h=t,m=c;if(u&&e.SceneManager.IsGUIPositionProperty(c)){h=e.SceneManager.CreateGUIAnimationProxy(t,c),m=c,p=n?"string"==typeof n[c]?parseFloat(n[c]):n[c]:e.SceneManager.ExtractGUINumericValue(t,c);var f="string"==typeof d?parseFloat(d):d,g=BABYLON.Animation.ANIMATIONTYPE_FLOAT,y=new BABYLON.Animation("tween_".concat(c),m,60,g,o.loop?BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),v=e.SceneManager.CreateEasingFunction(o.ease);v&&y.setEasingFunction(v);var _=[],S=0;if(_.push({frame:S,value:p}),S+=s,_.push({frame:S,value:f}),o.yoyo&&o.loop)S+=s,_.push({frame:S,value:p});else if(o.yoyo&&o.yoyoCount&&o.yoyoCount>0){S+=s,_.push({frame:S,value:p});for(var B=1;B<o.yoyoCount;B++)S+=s,_.push({frame:S,value:f}),S+=s,_.push({frame:S,value:p})}y.setKeys(_),a.push(y),l.push(h)}else if(void 0!==p&&void 0!==d){var b=e.SceneManager.GetAnimationType(d),C=new BABYLON.Animation("tween_".concat(c),c,60,b,o.loop?BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE:BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT),A=e.SceneManager.CreateEasingFunction(o.ease);A&&C.setEasingFunction(A);var M=[],T=0;if(M.push({frame:T,value:p}),T+=s,M.push({frame:T,value:d}),o.yoyo&&o.loop)T+=s,M.push({frame:T,value:p});else if(o.yoyo&&o.yoyoCount&&o.yoyoCount>0)for(T+=s,M.push({frame:T,value:p}),B=1;B<o.yoyoCount;B++)T+=s,M.push({frame:T,value:d}),T+=s,M.push({frame:T,value:p});C.setKeys(M),a.push(C),l.push(h)}}return{animations:a,targets:l}},t.TweenTo=function(t,n,i,o){var r;void 0===i&&(i={}),o=o||e.SceneManager.GetLastCreatedScene();var a,l=e.SceneManager.CreateTweenAnimations(t,null,n,i,o),s=l.animations,u=l.targets,c=e.SceneManager.IsGUIControl(t);if(c)for(var d=0;d<s.length;d++){var p=s[d];(B=u[d])!==t?(B.animations=B.animations||[],B.animations.push(p)):(t.animations=t.animations||[],t.animations.push(p))}else t.animations=t.animations||[],(r=t.animations).push.apply(r,s);var h,m=new Promise(function(e){a=e}),f=function(){i.onComplete&&i.onComplete(),a()},g=1e3*(i.delay||0),y=i.speed||1,v=60*(i.duration||1);i.yoyo&&i.loop?v*=2:i.yoyo&&i.yoyoCount&&i.yoyoCount>0&&(v*=1+i.yoyoCount);var _=[];if(c&&u.some(function(e){return e!==t})){var S=[];if(g>0)setTimeout(function(){i.onStart&&i.onStart();for(var e=0;e<u.length;e++){var t=u[e],n=o.beginAnimation(t,0,v,i.loop||!1,y,e===u.length-1?f:void 0);n&&(S.push(n),_.push(n))}h=S[0]},g);else{for(i.onStart&&i.onStart(),d=0;d<u.length;d++){var B=u[d],b=o.beginAnimation(B,0,v,i.loop||!1,y,d===u.length-1?f:void 0);b&&(S.push(b),_.push(b))}h=S[0]}}else g>0?setTimeout(function(){i.onStart&&i.onStart(),(h=o.beginAnimation(t,0,v,i.loop||!1,y,f))&&_.push(h)},g):(i.onStart&&i.onStart(),(h=o.beginAnimation(t,0,v,i.loop||!1,y,f))&&_.push(h));return{animations:_,finished:m}},t.TweenToAsync=function(t,n){return r(this,arguments,void 0,function(t,n,i,o){return void 0===i&&(i={}),a(this,function(r){return[2,e.SceneManager.TweenTo(t,n,i,o).finished]})})},t.TweenFromTo=function(t,n,i,o,r){for(var a in void 0===o&&(o={}),n)e.SceneManager.SetPropertyValue(t,a,n[a]);return e.SceneManager.TweenTo(t,i,o,r)},t.TweenFromToAsync=function(t,n,i){return r(this,arguments,void 0,function(t,n,i,o,r){return void 0===o&&(o={}),a(this,function(a){return[2,e.SceneManager.TweenFromTo(t,n,i,o,r).finished]})})},t.TweenGroupAsync=function(t){return r(this,arguments,void 0,function(t,n,i){var o,r,l,s,u,c,d,p,h;return void 0===n&&(n={}),a(this,function(a){switch(a.label){case 0:if(i=i||e.SceneManager.GetLastCreatedScene(),o=n.mode||"all",r=n.stagger||0,"sequence"!==o)return[3,7];l=0,s=t,a.label=1;case 1:return l<s.length?(u=s[l],(c=u())&&c.finished?[4,c.finished]:[3,3]):[3,6];case 2:return a.sent(),[3,5];case 3:return c&&c.then?[4,c]:[3,5];case 4:a.sent(),a.label=5;case 5:return l++,[3,1];case 6:return[3,9];case 7:for(d=[],p=function(e){var n=t[e];if(r>0&&e>0)d.push(new Promise(function(t){setTimeout(function(){var e=n();e&&e.finished?e.finished.then(t):e&&e.then?e.then(t):t()},e*r)}));else{var i=n();i&&i.finished?d.push(i.finished):i&&i.then&&d.push(i)}},h=0;h<t.length;h++)p(h);return[4,Promise.all(d)];case 8:a.sent(),a.label=9;case 9:return n.onComplete&&n.onComplete(),[2]}})})},t.GlobalOptions={},t.WindowState={},t.ServerEndPoint="http://127.0.0.1:2567",t.EnableDebugMode=!1,t.EnableUserInput=!0,t.RenderLoopReady=!0,t.PauseRenderLoop=!1,t.LostRenderContext=!1,t.AutoUpdateProgress=!0,t.PhysicsCapsuleShape=0,t.SupportSRGBBuffers=!1,t.AnimationStartMode=0,t.AnimationTargetFps=60,t.DefaultConvexHullMargin=.001,t.DefaultHeightFieldMargin=.001,t.AmbientLightIntensity=1,t.PointLightIntensity=1,t.SpotLightIntensity=1,t.DirectionalLightIntensity=1,t.TerrainColorCorrection=2.2,t.AllowCameraMovement=!0,t.AllowCameraRotation=!0,t.VirtualJoystickEnabled=!1,t.GameTimeMilliseconds=0,t.ParseScriptComponents=!0,t.AutoLoadScriptBundles=!0,t.AutoStripNamespacePrefix=!0,t.UniversalModuleDefinition=!0,t.WaitForSeconds=function(t){return new Promise(function(n){return e.WindowManager.SetTimeout(1e3*t,n)})},t.OnPreRenderLoopObservable=new BABYLON.Observable,t.OnPostRenderLoopObservable=new BABYLON.Observable,t.OnSceneReadyObservable=new BABYLON.Observable,t.OnEngineResizeObservable=new BABYLON.Observable,t.OnLoadCompleteObservable=new BABYLON.Observable,t.OnRebuildContextObservable=new BABYLON.Observable,t.OnAssetManagerProgress=null,t._HideLoadingScreen=null,t.CVTOOLS_NAME="CVTOOLS_unity_metadata",t.CVTOOLS_MESH="CVTOOLS_babylon_mesh",t.CVTOOLS_HAND="CVTOOLS_left_handed",t.CVTOOLS_NAME_REGISTERED=!1,t.CVTOOLS_MESH_REGISTERED=!1,t.CVTOOLS_HAND_REGISTERED=!1,t._EventBus=null,t.SceneLoaderFileNames=[],t.SceneLoaderPropertyBag={},t.SceneLoaderHandledFlag=!1,t.SceneParsingEnabled=!0,t.PhysicsViewersEnabled=!1,t.MAX_AGENT_COUNT=200,t.MAX_AGENT_RADIUS=2,t.NavigationMesh=null,t.CrowdInterface=null,t.PluginInstance=null,t.OnNavMeshReadyObservable=new BABYLON.Observable,t}();e.SceneManager=t}(i||(i={})),i.SceneManager.GameTimeMilliseconds=i.SceneManager.GetTimeMilliseconds(),function(e){var t=function(){function t(t,n,i,o){if(void 0===i&&(i={}),void 0===o&&(o=null),this._update=null,this._late=null,this._step=null,this._fixed=null,this._after=null,this._ready=null,this._lateUpdate=!1,this._properties=null,this._awoken=!1,this._started=!1,this._scene=null,this._delyed=!1,this._transform=null,this._scriptReady=!1,this._registeredClassname=null,this._registerComponentAlias=!0,this._lateUpdateObserver=null,this.resetScriptComponent=null,this._bodyCollisionObserver=null,this._bodyCollisionEndedObserver=null,this._worldTriggerEventObserver=null,this.onCollisionEnterObservable=new BABYLON.Observable,this.onCollisionStayObservable=new BABYLON.Observable,this.onCollisionExitObservable=new BABYLON.Observable,this.onTriggerEnterObservable=new BABYLON.Observable,this.onTriggerExitObservable=new BABYLON.Observable,null==t)throw new Error("Null transform object specified.");if(null==n)throw new Error("Null host scene object specified.");this._scene=n,this._transform=t,this._properties=i||{},null!=this._properties._scriptComponentAlias&&""!==this._properties._scriptComponentAlias?this._registeredClassname=this._properties._scriptComponentAlias:this._registeredClassname=o||this.constructor.name||"Unknown",null!=this._properties._registerComponentAlias?this._registerComponentAlias=this._properties._registerComponentAlias:this._registerComponentAlias=!0;var r=this;r._update=function(){e.ScriptComponent.UpdateInstance(r)},r._late=function(){e.ScriptComponent.LateInstance(r)},r._step=function(){e.ScriptComponent.StepInstance(r)},r._fixed=function(){e.ScriptComponent.FixedInstance(r)},r._after=function(){e.ScriptComponent.AfterInstance(r)},r._ready=function(){e.ScriptComponent.ReadyInstance(r)},r.resetScriptComponent=function(){e.ScriptComponent.ResetInstance(r)},r.registerComponentInstance&&r.destroyComponentInstance||BABYLON.Tools.Warn("Invalid component registration handlers for: "+this._transform.name),!0===this._registerComponentAlias&&null!=r.registerComponentInstance&&r.registerComponentInstance(r,this._registeredClassname,!0)}return t.prototype.isReady=function(){return this._scriptReady},Object.defineProperty(t.prototype,"scene",{get:function(){return this._scene},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"transform",{get:function(){return this._transform},enumerable:!1,configurable:!0}),t.prototype.dispose=function(){},t.prototype.getClassName=function(){return this._registeredClassname},t.prototype.setProperty=function(e,t){null==this._properties&&(this._properties={}),this._properties[e]=t},t.prototype.getProperty=function(e,t){void 0===t&&(t=null);var n=null;return null!=this._properties&&null==(n=this._properties[e])&&(n=this._properties["auto__"+e]),null==n&&(n=t),null!=n?n:null},t.prototype.getTime=function(){return e.SceneManager.GetTime()},t.prototype.getTimeMs=function(){return e.SceneManager.GetTimeMs()},t.prototype.getGameTime=function(){return e.SceneManager.GetGameTime()},t.prototype.getGameTimeMs=function(){return e.SceneManager.GetGameTimeMs()},t.prototype.getDeltaTime=function(){return e.SceneManager.GetDeltaTime(this.scene)},t.prototype.getDeltaSeconds=function(){return e.SceneManager.GetDeltaSeconds(this.scene)},t.prototype.getDeltaMilliseconds=function(){return e.SceneManager.GetDeltaMilliseconds(this.scene)},t.prototype.getAnimationRatio=function(){return e.SceneManager.GetAnimationRatio(this.scene)},t.prototype.hasSkinnedMesh=function(){return null!=this.getSkinnedMesh()},t.prototype.getSkinnedMesh=function(){return e.SceneManager.GetSkinnedMesh(this.transform)},t.prototype.getTransformMesh=function(){return this._transform instanceof BABYLON.Mesh?this._transform:null},t.prototype.getAbstractMesh=function(){return this._transform instanceof BABYLON.AbstractMesh?this._transform:null},t.prototype.getInstancedMesh=function(){return this._transform instanceof BABYLON.InstancedMesh?this._transform:null},t.prototype.getPrimitiveMeshes=function(){return e.SceneManager.GetPrimitiveMeshes(this.transform)},t.prototype.getMetadata=function(){return e.SceneManager.FindSceneMetadata(this._transform)},t.prototype.getComponent=function(t,n){void 0===n&&(n=!1);var i=e.SceneManager.FindScriptComponent(this._transform,t,n);return null!=i?i:null},t.prototype.getComponents=function(t,n){void 0===n&&(n=!1);var i=e.SceneManager.FindAllScriptComponents(this._transform,t,n);return null!=i?i:null},t.prototype.getLightRig=function(){return e.SceneManager.FindSceneLightRig(this._transform)},t.prototype.getCameraRig=function(){return e.SceneManager.FindSceneCameraRig(this._transform)},t.prototype.getTransformTag=function(){return e.SceneManager.GetTransformTag(this.transform)},t.prototype.hasTransformTags=function(t){return e.SceneManager.HasTransformTags(this._transform,t)},t.prototype.getChildNode=function(t,n,i,o){return void 0===n&&(n=e.SearchType.ExactMatch),void 0===i&&(i=!0),void 0===o&&(o=null),e.SceneManager.FindChildTransformNode(this._transform,t,n,i,o)},t.prototype.getChildWithTags=function(t,n,i){return void 0===n&&(n=!0),void 0===i&&(i=null),e.SceneManager.FindChildTransformWithTags(this._transform,t,n,i)},t.prototype.getChildrenWithTags=function(t,n,i){return void 0===n&&(n=!0),void 0===i&&(i=null),e.SceneManager.FindAllChildTransformsWithTags(this._transform,t,n,i)},t.prototype.getChildWithScript=function(t,n,i){return void 0===n&&(n=!0),void 0===i&&(i=null),e.SceneManager.FindChildTransformWithScript(this._transform,t,n,i)},t.prototype.getChildrenWithScript=function(t,n,i){return void 0===n&&(n=!0),void 0===i&&(i=null),e.SceneManager.FindAllChildTransformsWithScript(this._transform,t,n,i)},t.prototype.enableCollisionEvents=function(){var t=this,n=e.Utilities.GetHavokPlugin();if(null!=n&&null!=this.transform.physicsBody){if(this.transform.physicsBody.setCollisionCallbackEnabled(!0),this.transform.physicsBody.setCollisionEndedCallbackEnabled(!0),null==this._bodyCollisionObserver){var i=this.transform.physicsBody.getCollisionObservable();null!=i&&(this._bodyCollisionObserver=i.add(function(e){null!=e.collidedAgainst&&null!=e.collidedAgainst.transformNode&&("COLLISION_STARTED"===e.type?t.onCollisionEnterObservable.notifyObservers(e.collidedAgainst.transformNode):"COLLISION_CONTINUED"===e.type&&t.onCollisionStayObservable.notifyObservers(e.collidedAgainst.transformNode))}))}if(null==this._bodyCollisionEndedObserver){var o=this.transform.physicsBody.getCollisionEndedObservable();null!=o&&(this._bodyCollisionEndedObserver=o.add(function(e){null!=e.collidedAgainst&&null!=e.collidedAgainst.transformNode&&"COLLISION_FINISHED"===e.type&&t.onCollisionExitObservable.notifyObservers(e.collidedAgainst.transformNode)}))}null==this._worldTriggerEventObserver&&(this._worldTriggerEventObserver=n.onTriggerCollisionObservable.add(function(e){if(e.collider===t.transform.physicsBody||e.collidedAgainst===t.transform.physicsBody){var n=e.collider===t.transform.physicsBody?e.collidedAgainst:e.collider;"TRIGGER_ENTERED"===e.type?t.onTriggerEnterObservable.notifyObservers(n.transformNode):"TRIGGER_EXITED"===e.type&&t.onTriggerExitObservable.notifyObservers(n.transformNode)}}))}},t.prototype.disableCollisionEvents=function(){null!=e.Utilities.GetHavokPlugin()&&null!=this.transform.physicsBody&&(this.transform.physicsBody.setCollisionCallbackEnabled(!1),this.transform.physicsBody.setCollisionEndedCallbackEnabled(!1))},t.prototype.setTransformPosition=function(e){this.transform.physicsBody&&0!=this.transform.physicsBody.disablePreStep&&(this.transform.physicsBody.disablePreStep=!1),null!=this.transform.position&&this.transform.position.copyFrom(e)},t.prototype.setTransformRotation=function(e){this.transform.physicsBody&&0!=this.transform.physicsBody.disablePreStep&&(this.transform.physicsBody.disablePreStep=!1),null!=this.transform.rotationQuaternion&&this.transform.rotationQuaternion.copyFrom(e)},t.prototype.registerOnClickAction=function(t){var n=null;return this.transform instanceof BABYLON.AbstractMesh&&(n=e.SceneManager.RegisterClickAction(this.scene,this.transform,t)),n},t.prototype.unregisterOnClickAction=function(t){var n=!1;return this.transform instanceof BABYLON.AbstractMesh&&(n=e.SceneManager.UnregisterClickAction(this.transform,t)),n},t.prototype.registerComponentInstance=function(t,n,i){if(void 0===i&&(i=!0),null!=n&&""!==n&&"Unknown"!==n){if(!0===i){e.Utilities.ValidateTransformMetadata(this._transform);var o={alias:"script",order:0,klass:n,properties:null,instance:t};null==this._transform.metadata.toolkit.components&&(this._transform.metadata.toolkit.components=[]),this._transform.metadata.toolkit.components.push(o)}e.ScriptComponent.RegisterInstance(t),!0===i&&t.scene.onAfterRenderObservable.addOnce(function(){t.delayComponentInstance(t)})}else console.warn("Failed to register unknown component instance: ",t)},t.prototype.delayComponentInstance=function(t){e.WindowManager.SetTimeout(100,function(){t._delyed=!0})},t.prototype.destroyComponentInstance=function(t){e.ScriptComponent.DestroyInstance(t)},t.prototype.setupStepComponentInstance=function(e){e.scene.onBeforePhysicsObservable&&e.scene.onBeforePhysicsObservable.add(e._step)},t.prototype.removeStepComponentInstance=function(e){e.scene.onBeforePhysicsObservable&&e.scene.onBeforePhysicsObservable.removeCallback(e._step)},t.prototype.setupFixedComponentInstance=function(e){e.scene.onAfterPhysicsObservable&&e.scene.onAfterPhysicsObservable.add(e._fixed)},t.prototype.removeFixedComponentInstance=function(e){e.scene.onAfterPhysicsObservable&&e.scene.onAfterPhysicsObservable.removeCallback(e._fixed)},t.RegisterInstance=function(e){null!=e&&(null!=e._update&&e.scene.registerBeforeRender(e._update),e.late&&null!=e._late&&null!=e.scene.onBeforeRenderTargetsRenderObservable&&(e._lateUpdateObserver=e.scene.onBeforeRenderTargetsRenderObservable.add(e._late)),e.after&&null!=e._after&&e.scene.registerAfterRender(e._after),e.step&&null!=e._step&&e.setupStepComponentInstance(e),e.fixed&&null!=e._fixed&&e.setupFixedComponentInstance(e))},t.UpdateInstance=function(t){null!=t&&null!=t.transform&&t.transform.isEnabled(!1)&&(!1===t._awoken?(t._awoken=!0,e.ScriptComponent.ParseAutoProperties(t),t.awake&&t.awake()):!1===t._started?(t._started=!0,t.start&&t.start()):!0===t._awoken&&!0===t._started&&(!0===t._delyed&&(t._delyed=!1,e.ScriptComponent.ReadyInstance(t)),t.update&&t.update(),t._lateUpdate=!0))},t.LateInstance=function(e){null!=e&&null!=e.transform&&e.transform.isEnabled(!1)&&!0===e._lateUpdate&&(e._lateUpdate=!1,!0===e._started&&e.late&&e.late())},t.AfterInstance=function(e){null!=e&&null!=e.transform&&e.transform.isEnabled(!1)&&!0===e._started&&e.after&&e.after()},t.StepInstance=function(e){null!=e&&null!=e.transform&&!0===e._started&&e.step&&e.step()},t.FixedInstance=function(e){null!=e&&null!=e.transform&&!0===e._started&&e.fixed&&e.fixed()},t.ReadyInstance=function(e){null!=e&&null!=e.transform&&!1===e._scriptReady&&(e._scriptReady=!0,e.ready&&e.ready())},t.ResetInstance=function(e){null!=e&&null!=e.transform&&!0===e._started&&e.reset&&e.reset()},t.DestroyInstance=function(t){if(null!=t){t.scene.unregisterBeforeRender(t._update),null!=t._lateUpdateObserver&&null!=t.scene.onBeforeRenderTargetsRenderObservable&&t.scene.onBeforeRenderTargetsRenderObservable.remove(t._lateUpdateObserver),t.after&&null!=t._after&&t.scene.unregisterAfterRender(t._after),t.step&&null!=t._step&&t.removeStepComponentInstance(t),t.fixed&&null!=t._fixed&&t.removeFixedComponentInstance(t);var n=e.Utilities.GetHavokPlugin();if(null!=n){if(null!=t._bodyCollisionObserver)try{t._bodyCollisionObserver.remove()}catch(e){}if(null!=t._bodyCollisionEndedObserver)try{t._bodyCollisionEndedObserver.remove()}catch(e){}if(null!=t._worldTriggerEventObserver)try{n.onTriggerCollisionObservable.remove(t._worldTriggerEventObserver)}catch(e){}}try{t.onCollisionEnterObservable.clear()}catch(e){}try{t.onCollisionStayObservable.clear()}catch(e){}try{t.onCollisionExitObservable.clear()}catch(e){}try{t.onTriggerEnterObservable.clear()}catch(e){}try{t.onTriggerExitObservable.clear()}catch(e){}try{t.destroy&&t.destroy()}catch(e){}t._scriptReady=!1,t._transform=null,t._properties=null,t._started=!1,t._delyed=!1,t._update=null,t._late=null,t._step=null,t._fixed=null,t._after=null,t._ready=null,t._scene=null}},t.ParseAutoProperties=function(t){var n=Object.keys(t._properties);if(null!=n&&n.length>0)for(var i=function(i){var o=n[i];if(e.Utilities.StartsWith(o,"auto__")){var r=o.replace("auto__","");if(e.Utilities.HasOwnProperty(t,r)){var a=t.getProperty(o);if(null!=a){var l=typeof a;if(null!=l&&""!==l)if("object"===l)if(Array.isArray(a)){var s=[];a.forEach(function(n){null!=n&&("object"==typeof n?s.push(e.ScriptComponent.UnpackObjectProperty(n,t.scene)):s.push(n))}),t[r]=s}else{var u=t[r],c=e.ScriptComponent.UnpackObjectProperty(a,t.scene);u instanceof BABYLON.Color3&&c instanceof BABYLON.Color4?t[r]=new BABYLON.Color3(c.r,c.g,c.b):t[r]=c}else t[r]=a;else t[r]=a}else t[r]=a}else BABYLON.Tools.Warn(t.getClassName()||"Unregistered Class: Auto property '"+r+"' not found for transform '"+t.transform.name+"'")}},o=0;o<n.length;o++)i(o)},t.UnpackObjectProperty=function(t,n){var i=null;if(null!=t)if(void 0!==t.x&&void 0!==t.y)i=void 0!==t.z?void 0!==t.w?new BABYLON.Vector4(t.x,t.y,t.z,t.w):new BABYLON.Vector3(t.x,t.y,t.z):new BABYLON.Vector2(t.x,t.y);else if(void 0!==t.r&&void 0!==t.g&&void 0!==t.b){var o=1;void 0!==t.a&&(o=t.a),i=new BABYLON.Color4(t.r,t.g,t.b,o)}else if(void 0!==t.type)switch(t.type){case"UnityEngine.AnimationCurve":var r=t;i=BABYLON.Animation.Parse(r.animation);break;case"UnityEngine.Transform":var a=t;i=e.Utilities.ParseTransformByID(a,n);break;case"UnityEngine.Material":var l=t;i=n.getMaterialByName(l.name);break;case"UnityEngine.Texture2D":var s=t;i=e.Utilities.ParseTexture(s,n);break;case"UnityEngine.Cubemap":var u=t;i=e.Utilities.ParseCubemap(u,n);break;case"UnityEngine.AudioClip":case"UnityEngine.Video.VideoClip":case"UnityEngine.Font":default:i=t;break;case"UnityEngine.TextAsset":var c=t;i=null!=c.base64?!0===c.json?JSON.parse(e.WindowManager.Atob(c.base64)):e.WindowManager.Atob(c.base64):c;break;case"UnityEditor.DefaultAsset":var d=t;i=null!=d.base64?!0===d.json?JSON.parse(e.WindowManager.Atob(d.base64)):e.WindowManager.Atob(d.base64):d}else i=t;return i},t}();e.ScriptComponent=t}(i||(i={})),function(e){var t,n,i,r,a,l,s,u,c,d,p,h,m,f,g,y,v;(v=e.System||(e.System={}))[v.Deg2Rad=2*Math.PI/360]="Deg2Rad",v[v.Rad2Deg=1/e.System.Deg2Rad]="Rad2Deg",v[v.Epsilon=1e-6]="Epsilon",v[v.SingleEpsilon=1401298e-51]="SingleEpsilon",v[v.EpsilonNormalSqrt=1e-15]="EpsilonNormalSqrt",v[v.Kph2Mph=.621371]="Kph2Mph",v[v.Mph2Kph=1.60934]="Mph2Kph",v[v.Mps2Kph=3.6]="Mps2Kph",v[v.Mps2Mph=2.23694]="Mps2Mph",v[v.Meter2Inch=39.3701]="Meter2Inch",v[v.Inch2Meter=.0254]="Inch2Meter",v[v.Gravity=9.81]="Gravity",v[v.Gravity3G=29.400000000000002]="Gravity3G",v[v.SkidFactor=.25]="SkidFactor",v[v.MaxInteger=2147483647]="MaxInteger",v[v.WalkingVelocity=4.4]="WalkingVelocity",v[v.TerminalVelocity=55]="TerminalVelocity",v[v.SmoothDeltaFactor=.2]="SmoothDeltaFactor",v[v.ToLinearSpace=2.2]="ToLinearSpace",v[v.ToGammaSpace=.45454545454545453]="ToGammaSpace",(y=e.Handedness||(e.Handedness={}))[y.Default=-1]="Default",y[y.Right=0]="Right",y[y.Left=1]="Left",(g=e.SearchType||(e.SearchType={}))[g.ExactMatch=0]="ExactMatch",g[g.StartsWith=1]="StartsWith",g[g.EndsWith=2]="EndsWith",g[g.IndexOf=3]="IndexOf",(f=e.PlayerNumber||(e.PlayerNumber={}))[f.Auto=0]="Auto",f[f.One=1]="One",f[f.Two=2]="Two",f[f.Three=3]="Three",f[f.Four=4]="Four",(m=e.PlayerControl||(e.PlayerControl={}))[m.FirstPerson=0]="FirstPerson",m[m.ThirdPerson=1]="ThirdPerson",(h=e.RenderQuality||(e.RenderQuality={}))[h.High=0]="High",h[h.Medium=1]="Medium",h[h.Low=2]="Low",(p=e.GamepadType||(e.GamepadType={}))[p.None=-1]="None",p[p.Generic=0]="Generic",p[p.Xbox360=1]="Xbox360",p[p.DualShock=2]="DualShock",p[p.PoseController=3]="PoseController",(d=e.Xbox360Trigger||(e.Xbox360Trigger={}))[d.Left=0]="Left",d[d.Right=1]="Right",(c=e.MovementType||(e.MovementType={}))[c.DirectVelocity=0]="DirectVelocity",c[c.AppliedForces=1]="AppliedForces",(u=e.CollisionContact||(e.CollisionContact={}))[u.Top=0]="Top",u[u.Left=1]="Left",u[u.Right=2]="Right",u[u.Bottom=3]="Bottom",(s=e.IntersectionPrecision||(e.IntersectionPrecision={}))[s.AABB=0]="AABB",s[s.OBB=1]="OBB",(l=e.CollisionFilters||(e.CollisionFilters={}))[l.DefaultFilter=1]="DefaultFilter",l[l.StaticFilter=2]="StaticFilter",l[l.KinematicFilter=4]="KinematicFilter",l[l.DebrisFilter=8]="DebrisFilter",l[l.SensorTrigger=16]="SensorTrigger",l[l.CharacterFilter=32]="CharacterFilter",l[l.AllFilter=-1]="AllFilter",(a=e.CollisionState||(e.CollisionState={}))[a.ACTIVE_TAG=1]="ACTIVE_TAG",a[a.ISLAND_SLEEPING=2]="ISLAND_SLEEPING",a[a.WANTS_DEACTIVATION=3]="WANTS_DEACTIVATION",a[a.DISABLE_DEACTIVATION=4]="DISABLE_DEACTIVATION",a[a.DISABLE_SIMULATION=5]="DISABLE_SIMULATION",(r=e.CollisionFlags||(e.CollisionFlags={}))[r.CF_STATIC_OBJECT=1]="CF_STATIC_OBJECT",r[r.CF_KINEMATIC_OBJECT=2]="CF_KINEMATIC_OBJECT",r[r.CF_NO_CONTACT_RESPONSE=4]="CF_NO_CONTACT_RESPONSE",r[r.CF_CUSTOM_MATERIAL_CALLBACK=8]="CF_CUSTOM_MATERIAL_CALLBACK",r[r.CF_CHARACTER_OBJECT=16]="CF_CHARACTER_OBJECT",r[r.CF_DISABLE_VISUALIZE_OBJECT=32]="CF_DISABLE_VISUALIZE_OBJECT",r[r.CF_DISABLE_SPU_COLLISION_PROCESSING=64]="CF_DISABLE_SPU_COLLISION_PROCESSING",r[r.CF_HAS_CONTACT_STIFFNESS_DAMPING=128]="CF_HAS_CONTACT_STIFFNESS_DAMPING",r[r.CF_HAS_CUSTOM_DEBUG_RENDERING_COLOR=256]="CF_HAS_CUSTOM_DEBUG_RENDERING_COLOR",r[r.CF_HAS_FRICTION_ANCHOR=512]="CF_HAS_FRICTION_ANCHOR",r[r.CF_HAS_COLLISION_SOUND_TRIGGER=1024]="CF_HAS_COLLISION_SOUND_TRIGGER",(i=e.UserInputPointer||(e.UserInputPointer={}))[i.Left=0]="Left",i[i.Middle=1]="Middle",i[i.Right=2]="Right",(n=e.UserInputAxis||(e.UserInputAxis={}))[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.ClientX=2]="ClientX",n[n.ClientY=3]="ClientY",n[n.MouseX=4]="MouseX",n[n.MouseY=5]="MouseY",n[n.Wheel=6]="Wheel",(t=e.UserInputKey||(e.UserInputKey={}))[t.BackSpace=8]="BackSpace",t[t.Tab=9]="Tab",t[t.Enter=13]="Enter",t[t.Shift=16]="Shift",t[t.Ctrl=17]="Ctrl",t[t.Alt=18]="Alt",t[t.Pause=19]="Pause",t[t.Break=19]="Break",t[t.CapsLock=20]="CapsLock",t[t.Escape=27]="Escape",t[t.SpaceBar=32]="SpaceBar",t[t.PageUp=33]="PageUp",t[t.PageDown=34]="PageDown",t[t.End=35]="End",t[t.Home=36]="Home",t[t.LeftArrow=37]="LeftArrow",t[t.UpArrow=38]="UpArrow",t[t.RightArrow=39]="RightArrow",t[t.DownArrow=40]="DownArrow",t[t.Insert=45]="Insert",t[t.Delete=46]="Delete",t[t.Num0=48]="Num0",t[t.Num1=49]="Num1",t[t.Num2=50]="Num2",t[t.Num3=51]="Num3",t[t.Num4=52]="Num4",t[t.Num5=53]="Num5",t[t.Num6=54]="Num6",t[t.Num7=55]="Num7",t[t.Num8=56]="Num8",t[t.Num9=57]="Num9",t[t.A=65]="A",t[t.B=66]="B",t[t.C=67]="C",t[t.D=68]="D",t[t.E=69]="E",t[t.F=70]="F",t[t.G=71]="G",t[t.H=72]="H",t[t.I=73]="I",t[t.J=74]="J",t[t.K=75]="K",t[t.L=76]="L",t[t.M=77]="M",t[t.N=78]="N",t[t.O=79]="O",t[t.P=80]="P",t[t.Q=81]="Q",t[t.R=82]="R",t[t.S=83]="S",t[t.T=84]="T",t[t.U=85]="U",t[t.V=86]="V",t[t.W=87]="W",t[t.X=88]="X",t[t.Y=89]="Y",t[t.Z=90]="Z",t[t.LeftWindowKey=91]="LeftWindowKey",t[t.RightWindowKey=92]="RightWindowKey",t[t.SelectKey=93]="SelectKey",t[t.Numpad0=96]="Numpad0",t[t.Numpad1=97]="Numpad1",t[t.Numpad2=98]="Numpad2",t[t.Numpad3=99]="Numpad3",t[t.Numpad4=100]="Numpad4",t[t.Numpad5=101]="Numpad5",t[t.Numpad6=102]="Numpad6",t[t.Numpad7=103]="Numpad7",t[t.Numpad8=104]="Numpad8",t[t.Numpad9=105]="Numpad9",t[t.Multiply=106]="Multiply",t[t.Add=107]="Add",t[t.Subtract=109]="Subtract",t[t.DecimalPoint=110]="DecimalPoint",t[t.Divide=111]="Divide",t[t.F1=112]="F1",t[t.F2=113]="F2",t[t.F3=114]="F3",t[t.F4=115]="F4",t[t.F5=116]="F5",t[t.F6=117]="F6",t[t.F7=118]="F7",t[t.F8=119]="F8",t[t.F9=120]="F9",t[t.F10=121]="F10",t[t.F11=122]="F11",t[t.F12=123]="F12",t[t.NumLock=144]="NumLock",t[t.ScrollLock=145]="ScrollLock",t[t.SemiColon=186]="SemiColon",t[t.EqualSign=187]="EqualSign",t[t.Comma=188]="Comma",t[t.Dash=189]="Dash",t[t.Period=190]="Period",t[t.ForwardSlash=191]="ForwardSlash",t[t.GraveAccent=192]="GraveAccent",t[t.OpenBracket=219]="OpenBracket",t[t.BackSlash=220]="BackSlash",t[t.CloseBraket=221]="CloseBraket",t[t.SingleQuote=222]="SingleQuote";var _=function(){function e(){}return e.KeyboardSmoothing=!1,e.KeyboardMoveSensibility=3,e.KeyboardArrowSensibility=1,e.KeyboardMoveDeadZone=.001,e.GamepadDeadStickValue=.15,e.GamepadLStickXInverted=!1,e.GamepadLStickYInverted=!1,e.GamepadRStickXInverted=!1,e.GamepadRStickYInverted=!0,e.GamepadLStickSensibility=1,e.GamepadRStickSensibility=1,e.SupportedInputDevices=null,e.BabylonAngularSensibility=2e3,e.DefaultAngularSensibility=.5,e.PointerWheelDeadZone=.1,e.PointerMouseDeadZone=.1,e.PointerMouseInverted=!0,e.UseCanvasElement=!0,e.UseArrowKeyRotation=!1,e.EnableBabylonRotation=!1,e}();e.UserInputOptions=_;e.RequestHeader=function(){};e.TriggerVolume=function(){this.mesh=null,this.state=0};e.RoomErrorMessage=function(){};var S=function(){function e(e,t,n,i,o){void 0===n&&(n=!0),void 0===i&&(i=null),void 0===o&&(o=null),this.loadingDivId=e,this.loadingUIText=t,this.hideLoadingUIWithEngine=n,this.customInnerHtml=i,this.customInnerCss=o,this.loadingUIBackgroundColor="#000000",null!=this.loadingDivId&&""!==this.loadingDivId||(this.loadingDivId="customLoadingScreen"),null!=this.loadingUIText&&""!==this.loadingUIText||(this.loadingUIText="Please Wait")}return e.prototype.displayLoadingUI=function(){if(this.hasLoadingDiv())this.showLoadingDiv(!0);else{var e=document.createElement("style");e.type="text/css",e.innerHTML=this.customInnerCss||"",document.getElementsByTagName("head")[0].appendChild(e);var t=this.loadingUIText,n=document.createElement("div");n.id=this.loadingDivId,n.innerHTML=this.customInnerHtml||t,document.body.appendChild(n)}},e.prototype.hideLoadingUI=function(){!0===this.hideLoadingUIWithEngine&&this.showLoadingDiv(!1)},e.prototype.showLoadingDiv=function(e){var t=this.getLoadingDiv();null!=t&&(t.style.display=e?"initial":"none")},e.prototype.getLoadingDiv=function(){return document.getElementById(this.loadingDivId)},e.prototype.hasLoadingDiv=function(){return null!=document.getElementById(this.loadingDivId)},e}();e.CustomLoadingScreen=S;var B=function(){function e(){this.ListenerDictionary={}}return e.prototype.OnMessage=function(e,t){var n;null==this.ListenerDictionary[e]?(n=[],this.ListenerDictionary[e]=n):n=this.ListenerDictionary[e],n.findIndex(function(e){return t==e})<0&&n.push(t)},e.prototype.PostMessage=function(e,t){void 0===t&&(t=null);var n=this.ListenerDictionary[e];null!=n&&n.forEach(function(e){try{e&&e(t)}catch(e){console.warn(e)}})},e.prototype.RemoveHandler=function(e,t){var n=this.ListenerDictionary[e];if(null!=n){var i=n.findIndex(function(e){return t==e});i>=0&&n.splice(i,1)}},e.prototype.ResetHandlers=function(){this.ListenerDictionary={}},e.prototype.Dispose=function(){this.ResetHandlers()},e}();e.LocalMessageBus=B;var b=function(){function e(){this.ListenerDictionary={},window&&window.top?(this.HandleWindowMessage=this.HandleWindowMessage.bind(this),window.top.addEventListener("message",this.HandleWindowMessage)):console.warn("GlobalMessageBus: No Top Window Available")}return e.prototype.OnMessage=function(e,t){var n;null==this.ListenerDictionary[e]?(n=[],this.ListenerDictionary[e]=n):n=this.ListenerDictionary[e],n.findIndex(function(e){return t==e})<0&&n.push(t)},e.prototype.PostMessage=function(e,t,n,i){void 0===t&&(t=null),void 0===n&&(n="*"),window&&window.top?window.top.postMessage({source:"eventbus",message:e,data:t},n,i):console.warn("GlobalMessageBus: No Top Window Available")},e.prototype.RemoveHandler=function(e,t){var n=this.ListenerDictionary[e];if(null!=n){var i=n.findIndex(function(e){return t==e});i>=0&&n.splice(i,1)}},e.prototype.ResetHandlers=function(){this.ListenerDictionary={}},e.prototype.Dispose=function(){this.ResetHandlers(),window&&window.top&&window.top.removeEventListener("message",this.HandleWindowMessage)},e.prototype.HandleWindowMessage=function(e){null!=e&&null!=e.data&&null!=e.data.message&&null!=e.data.source&&"eventbus"==e.data.source&&this.OnDispatchMessage(e.data.message,null!=e.data.data?e.data.data:null)},e.prototype.OnDispatchMessage=function(e,t){void 0===t&&(t=null);var n=this.ListenerDictionary[e];null!=n&&n.forEach(function(e){try{e&&e(t)}catch(e){console.warn(e)}})},e}();e.GlobalMessageBus=b;var C=function(){function t(e,t,n,i,o,r){void 0===n&&(n=1),void 0===i&&(i=!0),void 0===o&&(o=!1),void 0===r&&(r=!0),this.prefabName=null,this.allowGrowth=!0,this.assetContainer=null,this.cloneAnimations=!0,this.makeNewMaterials=!1,this.availableInstances=null,this.prefabName=t,this.allowGrowth=i,this.assetContainer=e,this.cloneAnimations=r,this.makeNewMaterials=o,this.availableInstances=[],this.populatePool(n)}return t.prototype.getAvailableCount=function(){return this.availableInstances.length},t.prototype.populatePool=function(e){if(e>0)for(var t=0;t<e;t++){var n=this.createNewInstance();null!=n&&this.freeInstance(n)}},t.prototype.getInstance=function(e,t){void 0===e&&(e=null),void 0===t&&(t=null);var n=this.availableInstances.length>0?this.availableInstances.pop():this.appendNewInstance();return null!=n&&(null!=e?n.position.copyFrom(e):n.position.set(0,0,0),null!=t?null!=n.rotationQuaternion?n.rotationQuaternion.copyFrom(t):n.rotationQuaternion=t.clone():null!=n.rotationQuaternion?n.rotationQuaternion.set(0,0,0,1):n.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1),n.name=this.prefabName+".Instance",n.setEnabled(!0)),n},t.prototype.freeInstance=function(e){null!=e&&(e.setEnabled(!1),e.position.set(0,0,0),null!=e.rotationQuaternion?e.rotationQuaternion.set(0,0,0,1):e.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1),null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.components&&e.metadata.toolkit.components.forEach(function(e){if(null!=e)try{e.resetScriptComponent()}catch(e){}}),e.name=this.prefabName+".Unassigned",this.availableInstances.push(e))},t.prototype.appendNewInstance=function(){var e=null;return!0===this.allowGrowth&&(e=this.createNewInstance()),e},t.prototype.createNewInstance=function(t,n,i,o){void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===o&&(o=null);var r=null;return null!=this.assetContainer&&null!=this.prefabName&&""!==this.prefabName&&(this.assetContainer instanceof BABYLON.AssetContainer?r=e.SceneManager.InstantiatePrefabFromContainer(this.assetContainer,this.prefabName,this.prefabName+".Instance",t,n,i,o,this.cloneAnimations,this.makeNewMaterials):this.assetContainer instanceof BABYLON.Scene&&(r=e.SceneManager.InstantiatePrefabFromScene(this.assetContainer,this.prefabName,this.prefabName+".Instance",t,n,i,o,this.cloneAnimations))),r},t}();e.PrefabObjectPool=C;var A=function(){function e(){this._hit=!1,this._dest=new BABYLON.Vector3(0,0,0),this._origin=new BABYLON.Vector3(0,0,0),this._hitPoint=new BABYLON.Vector3(0,0,0),this._hitNormal=new BABYLON.Vector3(0,0,0),this._hitDistance=0,this._collisionObject=null,this.reset(BABYLON.Vector3.Zero(),BABYLON.Vector3.Zero())}return Object.defineProperty(e.prototype,"hasHit",{get:function(){return this._hit},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hitPoint",{get:function(){return this._hitPoint},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hitNormal",{get:function(){return this._hitNormal},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"hitDistance",{get:function(){return this._hitDistance},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"collisionObject",{get:function(){return this._collisionObject},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rayDestination",{get:function(){return this._dest},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"rayOrigin",{get:function(){return this._origin},enumerable:!1,configurable:!0}),e.prototype.reset=function(e,t){this._hit=!1,this._hitPoint.set(0,0,0),this._hitNormal.set(0,0,0),this._hitDistance=0,this._collisionObject=null,this._origin.copyFrom(e),this._dest.copyFrom(t)},e.prototype.update=function(e,t,n,i,o,r,a,l){void 0===l&&(l=null),this._hit=e,this._hitPoint.set(t,n,i),this._hitNormal.set(o,r,a),this._hitDistance=BABYLON.Vector3.Distance(this._origin,this.hitPoint),this._collisionObject=l},e}();e.RaycastHitResult=A;var M=function(){function t(e,t,n,i){void 0===n&&(n=0),void 0===i&&(i=.5),this._numPoints=-1,this._pointMesh=null,this._pointSize=.5,this._pointType=0,this._linesName="MeshLines",this._linesMesh=null,this._babylonScene=null,this._pointMesh=null,this._linesMesh=null,this._linesName=e,this._babylonScene=t,this._pointType=n,this._pointSize=i}return Object.defineProperty(t.prototype,"pointMesh",{get:function(){return this._pointMesh},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"linesMesh",{get:function(){return this._linesMesh},enumerable:!1,configurable:!0}),t.prototype.dispose=function(e){void 0===e&&(e=!0),this._babylonScene=null,this._linesName=null,null!=this._pointMesh&&(this._pointMesh.dispose(e),this._pointMesh=null),null!=this._linesMesh&&(this._linesMesh.dispose(e),this._linesMesh=null)},t.prototype.hidePoint=function(e){void 0===e&&(e=!0),null!=this._pointMesh&&(this._pointMesh.isVisible=!e)},t.prototype.drawPoint=function(t){null==this._pointMesh&&(1===this._pointType?(this._pointMesh=BABYLON.MeshBuilder.CreateBox(this._linesName+".EndPoint",{size:2*this._pointSize},this._babylonScene),this._pointMesh.renderingGroupId=e.Utilities.DefaultRenderGroup(),this._pointMesh.visibility=.25):(this._pointMesh=BABYLON.MeshBuilder.CreateSphere(this._linesName+".EndPoint",{segments:24,diameter:2*this._pointSize},this._babylonScene),this._pointMesh.renderingGroupId=e.Utilities.DefaultRenderGroup(),this._pointMesh.visibility=.25)),null!=this._pointMesh&&(this._pointMesh.isVisible=!0,this._pointMesh.position.copyFrom(t))},t.prototype.drawLine=function(t,n){void 0===n&&(n=null),null==this._linesMesh?(this._numPoints=t.length,this._linesMesh=BABYLON.MeshBuilder.CreateLines(this._linesName,{points:t,updatable:!0},this._babylonScene),this._linesMesh.renderingGroupId=e.Utilities.DefaultRenderGroup(),null!=n&&(this._linesMesh.color=n),this._linesMesh.refreshBoundingInfo(!1)):t.length===this._numPoints?(this._linesMesh=BABYLON.MeshBuilder.CreateLines(this._linesName,{points:t,instance:this._linesMesh},this._babylonScene),this._linesMesh.renderingGroupId=e.Utilities.DefaultRenderGroup(),null!=n&&(this._linesMesh.color=n),this._linesMesh.refreshBoundingInfo(!1)):BABYLON.Tools.Warn("Dynamic line mesh point count mismatch for "+this._linesName)},t}();e.LinesMeshRenderer=M;var T=function(t){function n(){return null!==t&&t.apply(this,arguments)||this}return o(n,t),n.prototype.addContainerTask=function(e,t,n,i){var o=this,r=new BABYLON.ContainerAssetTask(e,t,n,i),a=r;return a._lengthComputable=0,a._loaded=0,a._total=0,a.runTask=function(e,t,n){BABYLON.SceneLoader.LoadAssetContainer(r.rootUrl,r.sceneFilename,e,function(e){r.loadedContainer=e,r.loadedMeshes=e.meshes,r.loadedParticleSystems=e.particleSystems,r.loadedSkeletons=e.skeletons,r.loadedAnimationGroups=e.animationGroups,t()},function(e){a._lengthComputable=e.lengthComputable,a._loaded=e.loaded,a._total=e.total,o.handlePreloadingProgress()},function(e,t,i){n(t,i)})},this._tasks.push(r),r},n.prototype.addMeshTask=function(e,t,n,i){var o=this,r=new BABYLON.MeshAssetTask(e,t,n,i),a=r;return a._lengthComputable=0,a._loaded=0,a._total=0,a.runTask=function(e,t,n){BABYLON.SceneLoader.ImportMesh(r.meshesNames,r.rootUrl,r.sceneFilename,e,function(e,n,i,o){r.loadedMeshes=e,r.loadedParticleSystems=n,r.loadedSkeletons=i,r.loadedAnimationGroups=o,t()},function(e){a._lengthComputable=e.lengthComputable,a._loaded=e.loaded,a._total=e.total,o.handlePreloadingProgress()},function(e,t,i){n(t,i)})},this._tasks.push(r),r},n.prototype.addTextFileTask=function(e,t){var n=this,i=new BABYLON.TextFileAssetTask(e,t),o=i;return o._lengthComputable=0,o._loaded=0,o._total=0,o.runTask=function(e,t,r){e._loadFile(i.url,function(e){i.text=e,t()},function(e){o._lengthComputable=e.lengthComputable,o._loaded=e.loaded,o._total=e.total,n.handlePreloadingProgress()},!1,!1,function(e,t){e&&r(e.status+" "+e.statusText,t)})},this._tasks.push(i),i},n.prototype.addBinaryFileTask=function(e,t){var n=this,i=new BABYLON.BinaryFileAssetTask(e,t),o=i;return o._lengthComputable=0,o._loaded=0,o._total=0,o.runTask=function(e,t,r){e._loadFile(i.url,function(e){i.data=e,t()},function(e){o._lengthComputable=e.lengthComputable,o._loaded=e.loaded,o._total=e.total,n.handlePreloadingProgress()},!0,!0,function(e,t){e&&r(e.status+" "+e.statusText,t)})},this._tasks.push(i),i},n.prototype.addImageTask=function(e,t){var n=this,i=new BABYLON.ImageAssetTask(e,t),o=i;return o._lengthComputable=0,o._loaded=0,o._total=0,o.runTask=function(e,t,r){var a=new HTMLImageElement;BABYLON.Tools.SetCorsBehavior(i.url,a),a.onload=function(){i.image=a,t()},a.onerror=function(e){r("Error loading image",e)},a.onprogress=function(e){o._lengthComputable=e.lengthComputable,o._loaded=e.loaded,o._total=e.total,n.handlePreloadingProgress()},a.src=i.url},this._tasks.push(i),i},n.prototype.handlePreloadingProgress=function(){var t=!0,n=0,i=0;if(null!=this._tasks&&this._tasks.length>0)for(var o=0;o<this._tasks.length;o++){var r=this._tasks[o];null!=r._lengthComputable&&null!=r._loaded&&null!=r._total&&(t=t&&r._lengthComputable,n+=r._loaded,i+=r._total)}if(null!=e.SceneManager.OnAssetManagerProgress){var a={lengthComputable:t,loaded:n,total:t?i:0};e.SceneManager.OnAssetManagerProgress(a)}},n}(BABYLON.AssetsManager);e.PreloadAssetsManager=T;var O=function(){function e(){}return e.HasNetworkEntity=function(e){return null!=e&&null!=e.networkEntity},e.GetNetworkEntityId=function(e){return null==e?null:null!=e.networkEntity?e.networkEntity.id:null},e.GetNetworkEntityType=function(e){return null==e?0:null!=e.networkEntityType?e.networkEntityType:0},e.GetNetworkEntitySessionId=function(e){return null==e?null:null!=e.networkEntity?e.networkEntity.ownerId:null},e.QueryNetworkAttribute=function(e,t){var n=null;return null!=e&&null!=e.networkEntity&&null!=e.networkEntity.attributes&&(n=e.networkEntity.attributes.get(t)),n},e.QueryBufferedAttribute=function(e,t){var n=0;return null!=e&&null!=e.networkEntityAttributeBuffer&&(n=e.networkEntityAttributeBuffer[t.toFixed(0)]),n},e.PostBufferedAttribute=function(e,t,n){null==e.networkEntityBatch&&(e.networkEntityBatch={}),e.networkEntityBatch[t.toFixed(0)]=n},e}();e.EntityController=O}(i||(i={})),BABYLON.Bone.prototype.linkTransformNode=function(e){e._linkedBone=this,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode--,this._linkedTransformNode=e,this._linkedTransformNode&&this._skeleton._numBonesWithLinkedTransformNode++},function(e){var t;(t=e.MaterialAlphaMode||(e.MaterialAlphaMode={})).OPAQUE="OPAQUE",t.MASK="MASK",t.BLEND="BLEND";e.CubeTextureLoader=function(){};var n=function(){function t(t){this.name=e.SceneManager.CVTOOLS_NAME,this.enabled=!1,this._webgpu=!1,this._babylonScene=null,this._metadataParser=null,this._loaderScene=null,this._assetsManager=null,this._materialMap=null,this._lightmapMap=null,this._reflectionMap=null,this._reflectionCache=null,this._assetContainer=!1,this._activeMeshes=!1,this._parseScene=!1,this._leftHanded=!1,this._disposeRoot=!1,this._sceneParsed=!1,this._preWarmTime=1,this._hideLoader=!1,this._rootUrl=null,this._fileName="Unknown",this._licenseName="Unknown",this._licenseType="standard",this._loader=t,this.enabled=this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_NAME)&&this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_HAND),this._parseScene=this._leftHanded=this._disposeRoot=this._sceneParsed=!1,this._rootUrl=null,this._masterList=null,this._detailList=null,this._parserList=null,this._shaderList=null,this._readyList=null,this._preloadList=null,this._materialMap=null,this._lightmapMap=null,this._preWarmTime=1,this._hideLoader=!1,this._loaderScene=null,this._assetsManager=null,this._reflectionMap=null,this._reflectionCache=null,this._animationGroups=null,this._metadataParser=null,this._babylonScene=null,this.order=100}return t.prototype.dispose=function(){delete this._loader},t.prototype.onLoading=function(){var t=this;e.Utilities.LoadingState=0,this._assetContainer=null!=this._loader._assetContainer,this._metadataParser=null,this._babylonScene=this._loader.babylonScene,this._loaderScene=null,this._assetsManager=null,this._rootUrl=this._loader._uniqueRootUrl?this._loader._uniqueRootUrl:"/",this._fileName=this._loader._fileName?this._loader._fileName:"Unknown",this._fileName.indexOf("?")>=0&&(this._fileName=this._fileName.split("?")[0]),this._loader.parent.onCompleteObservable.addOnce(function(){t.onComplete()}),this._loader.parent.onValidatedObservable.addOnce(function(){t.onValidate()}),this._parseScene=this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_NAME)&&this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_HAND)&&!0===e.SceneManager.IsSceneParsingEnabled(),this._leftHanded=this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_HAND),this._disposeRoot=this._sceneParsed=!1,this._animationGroups=[],this._masterList=[],this._detailList=[],this._parserList=[],this._shaderList=[],this._readyList=[],this._preloadList=[],this._materialMap=new Map,this._lightmapMap=new Map,this._preWarmTime=1,this._hideLoader=!1,this._reflectionMap={},this._reflectionCache={},e.Utilities.ResetLoaderItemsMarkedForDisposal(),this._webgpu=this._babylonScene.getEngine()instanceof BABYLON.WebGPUEngine,this._babylonScene.getEngine().getCaps().supportSRGBBuffers=e.SceneManager.SupportSRGBBuffers,!0===this._leftHanded&&null!=this._loader.rootBabylonMesh&&(this._loader.rootBabylonMesh.rotationQuaternion=BABYLON.Quaternion.Identity(),this._loader.rootBabylonMesh.scaling=BABYLON.Vector3.One()),!0===this._parseScene&&(e.SceneManager.RenderLoopReady=!1,null!=this._loader.rootBabylonMesh&&(this._loader.rootBabylonMesh.name="Root."+this._fileName.replace(".gltf","").replace(".glb","")),this.setupLoader())},t.prototype.onReady=function(){!0===this._parseScene&&!0===this._disposeRoot&&null!=this._loader.rootBabylonMesh&&this._loader.rootBabylonMesh.dispose(!0)},t.prototype.onComplete=function(){this._parseScene,this.finishComplete()},t.prototype.getScriptBundleTag=function(){var e=null,t=this._loaderScene,n=null!=t&&null!=t.extras&&null!=t.extras.metadata?t.extras.metadata:null;if(null!=n){null!=this._rootUrl&&this._rootUrl;var i=null!=n.script?n.script:null,o=null!=n.project?n.project:null;null!=i&&""!==i&&null!=o&&""!==o&&(e=o.toLocaleLowerCase())}return e},t.prototype.getScriptBundleUrl=function(){var e=null,t=this._loaderScene,n=null!=t&&null!=t.extras&&null!=t.extras.metadata?t.extras.metadata:null;if(null!=n){var i=null!=this._rootUrl?this._rootUrl:"/",o=null!=n.script?n.script:null,r=null!=n.project?n.project:null;null!=o&&""!==o&&null!=r&&""!==r&&(e=i+r)}return e},t.prototype.finishComplete=function(){var t=this;!0===this._parseScene&&(this.startParsing(),e.SceneManager.RenderLoopReady=!0,this._babylonScene.onAfterRenderObservable.addOnce(function(){e.Utilities.LoadingState=3,t._processPreloadTimeout()}))},t.prototype.onValidate=function(){this._parseScene},t.prototype.onCleanup=function(){this._fileName=null,this._rootUrl=null,this._parseScene=this._leftHanded=this._disposeRoot=this._sceneParsed=!1,this._masterList=null,this._detailList=null,this._parserList=null,this._shaderList=null,this._preWarmTime=1,this._readyList=null,this._preloadList=null,this._hideLoader=!1,this._animationGroups=null,null!=this._materialMap&&(this._materialMap.clear(),this._materialMap=null),null!=this._lightmapMap&&(this._lightmapMap.clear(),this._lightmapMap=null),this._loaderScene=null,this._assetsManager=null,this._reflectionMap=null,this._reflectionCache=null,this._metadataParser=null,this._babylonScene=null},t.prototype.setupLoader=function(){var t=this,n=this._fileName;!0===this._parseScene&&(this._assetsManager=new e.PreloadAssetsManager(this._babylonScene),this._assetsManager.onProgress=function(t,n,i){if(!0===e.SceneManager.AutoUpdateProgress){var o="LOADING "+(n-t)+" OF "+n+(1===n?" ASSET":" ASSETS");e.WindowManager.UpdateLoaderDetails(o,e.Utilities.LoadingState)}else null!=e.Utilities.OnPreloaderProgress&&e.Utilities.OnPreloaderProgress(t,n,i)},this._assetsManager.onFinish=function(i){e.WindowManager.SetTimeout(100,function(){e.Utilities.LoadingState=4,!0===e.SceneManager.AutoUpdateProgress&&e.WindowManager.UpdateLoaderStatus("PLEASE WAIT","PREPARING SCENE VIEW",e.Utilities.LoadingState);var o=t._preWarmTime>0?1e3*t._preWarmTime:100;e.WindowManager.SetTimeout(o,function(){if(null!=e.Utilities.OnPreloaderComplete&&e.Utilities.OnPreloaderComplete(i),t._processShaderMaterials(t._babylonScene,t._shaderList),e.Utilities.RemoveLoaderItemsMarkedForDisposal(),null!=t._readyList&&t._readyList.length>0)for(var o=0;o<t._readyList.length;o++){var r=t._readyList[o];null!=r&&r._ready&&r._ready()}t._babylonScene.onAfterRenderObservable.addOnce(function(){var i=null!=n&&""!==n?n:"Unknown";null!=e.SceneManager.OnSceneReadyObservable&&e.SceneManager.OnSceneReadyObservable.notifyObservers(i),1==t._hideLoader&&e.WindowManager.HideSceneLoader(),t.onCleanup()})})})})},t.prototype.startParsing=function(){!0===this._parseScene&&(e.Utilities.LoadingState=2,this._processLevelOfDetail(this._babylonScene,this._detailList),this._processActiveMeshes(this._babylonScene,this._activeMeshes),this._processUnityMeshes(this._masterList),null!=this._loaderScene&&(this.preProcessSceneProperties(this._loaderScene,this._babylonScene),this.postProcessSceneProperties(this._rootUrl,this._loaderScene,this._babylonScene)),!1===this._assetContainer&&null!=this._parserList&&this._parserList.length>0&&(this._metadataParser=e.Utilities.PostParseSceneComponents(this._babylonScene,this._parserList,this._preloadList,this._readyList)))},t.prototype._processActiveMeshes=function(e,t){!0===t&&e.freeActiveMeshes()},t.prototype._processUnityMeshes=function(t){null!=t&&t.length>0&&t.forEach(function(t){e.Utilities.RegisterInstancedMeshBuffers(t)})},t.prototype._processPreloadTimeout=function(){if(null!=this._assetsManager){if(null!=this._preloadList&&this._preloadList.length>0)for(var e=0;e<this._preloadList.length;e++){var t=this._preloadList[e];null!=t&&t.addPreloaderTasks&&t.addPreloaderTasks(this._assetsManager)}this._babylonScene._preloaded=!0,this._assetsManager.load()}},t.prototype.loadSceneAsync=function(t,n){var i;return!0===this._parseScene&&(this._loaderScene=n,e.Utilities.LoadingState=1),this._parseScene&&(null===(i=n.extras)||void 0===i?void 0:i.metadata)?this._loadSceneInternalAsync(t,n):null},t.prototype._loadSceneInternalAsync=function(e,t){return r(this,void 0,void 0,function(){var n,i;return a(this,function(o){switch(o.label){case 0:return o.trys.push([0,3,,4]),null!=(n=t.extras.metadata).rawmaterials&&(this._loader,n.rawmaterials),[4,this._loader.loadSceneAsync(e,t)];case 1:return o.sent(),[4,this._loadSceneExAsync(e,t)];case 2:return o.sent(),[3,4];case 3:return i=o.sent(),console.error("CVTOOLS: Error in loadSceneAsync:",i),[3,4];case 4:return[2]}})})},t.prototype._loadSceneExAsync=function(t,n){return r(this,void 0,void 0,function(){var t,n,i,o,r,l,s,u,c,d=this;return a(this,function(a){if(t=this._loader,n=new Array,t._gltf.nodes)for(i=0,o=t._gltf.nodes;i<o.length;i++)(r=o[i])._babylonTransformNode&&this._animationGroups&&e.Utilities.AssignAnimationGroupsToNode(r._babylonTransformNode,this._animationGroups);if(null!=this._reflectionMap&&null!=this._reflectionCache)for(c in l=0,s=function(t){if(l++,u._reflectionMap.hasOwnProperty(t)){var n=t;if(null!=u._assetsManager){var i=u._assetsManager.addBinaryFileTask("Material.ReflectionTextureTask"+l.toFixed(0),n);i.onSuccess=function(t){if(null!=t.data){var i=new Blob([t.data]),o=d._reflectionMap[n];null!=o&&o.forEach(function(t){if(null!=t&&null!=t.mapkey){var n=d._reflectionCache[t.mapkey];if(null!=n)null!=t.material&&e.Utilities.HasOwnProperty(t.material,"reflectionTexture")&&(t.material.reflectionTexture=n);else{var o=d._babylonScene,r=URL.createObjectURL(i),a=function(){URL.revokeObjectURL(r)},l=new BABYLON.CubeTexture(r,o,null,null,null,a,a,null,t.prefiltered,t.extension);l.name=t.name,null!=t.boundingBoxSize&&(l.boundingBoxSize=t.boundingBoxSize),null!=t.boundingBoxPosition&&(l.boundingBoxPosition=t.boundingBoxPosition),d._reflectionCache[t.mapkey]=l,null!=t.material&&e.Utilities.HasOwnProperty(t.material,"reflectionTexture")&&(t.material.reflectionTexture=l)}}})}else console.error("Failed to load reflection texture task: "+n)},i.onError=function(e,t,n){console.error(t,n)}}}},u=this,this._reflectionMap)s(c);return t.logClose(),[2,Promise.all(n).then(function(){})]})})},t.prototype.loadNodeAsync=function(t,n,i){var o,r=this;if(!this._parseScene||!(null===(o=n.extras)||void 0===o?void 0:o.metadata))return null;try{return this._loader.loadNodeAsync(t,n,function(t){try{var o=t,a=n.extras.metadata;null==o.metadata&&(o.metadata={}),o.metadata.toolkit=a,e.Utilities.ValidateTransformGuid(o),e.Utilities.ValidateTransformMetadata(o),e.Utilities.ValidateTransformQuaternion(o),o.isVisible=null==o.metadata.toolkit.visible||o.metadata.toolkit.visible,o.visibility=null!=o.metadata.toolkit.visibility?o.metadata.toolkit.visibility:1,o.billboardMode=null!=o.metadata.toolkit.billboard?o.metadata.toolkit.billboard:0,!0===r._assetContainer&&(o.metadata.toolkit.prefab=!0),!0===o.metadata.toolkit.prefab?o.setEnabled(!1):(r._parserList.push(o),null!=n.extras.metadata.lods&&null!=n.extras.metadata.distances&&null!=r._detailList&&r._detailList.push(o)),r._masterList.push(o),i(o)}catch(e){console.error("CVTOOLS: Error in node assignment callback:",e),i(t)}})}catch(e){return console.error("CVTOOLS: Error in loadNodeAsync:",e),null}},t.prototype.loadMaterialPropertiesAsync=function(e,t,n){return this._parseScene?this._loadMaterialPropertiesInternalAsync(e,t,n):null},t.prototype._loadMaterialPropertiesInternalAsync=function(e,t,n){return r(this,void 0,void 0,function(){var i,o,r,l,s,u,c,d,p,h,m,f;return a(this,function(a){switch(a.label){case 0:return a.trys.push([0,3,,9]),(i=t.index||-1)>=0&&null!=this._materialMap&&(this._materialMap.has(i)||this._materialMap.set(i,n)),n.gltfIndex=i,o=this._loader,m=[],n instanceof BABYLON.NodeMaterial?(r=this._parseNodeMaterialPropertiesAsync("".concat(e,"/nodeMaterial"),t,n))&&m.push(r):n instanceof BABYLON.ShaderMaterial?(l=this._parseShaderMaterialPropertiesAsync("".concat(e,"/shaderMaterial"),t,n))&&m.push(l):n instanceof BABYLON.StandardMaterial?(s=this._parseDiffuseMaterialPropertiesAsync("".concat(e,"/standardMaterial"),t,n))&&m.push(s):(u=o._extensionsLoadMaterialPropertiesAsync(e,t,n))?(m.push(u),this._parseCommonConstantProperties(m,"".concat(e,"/commonConstant"),t,n)):((c=o.loadMaterialBasePropertiesAsync(e,t,n))&&m.push(c),t.pbrMetallicRoughness&&(d=o._loadMaterialMetallicRoughnessPropertiesAsync("".concat(e,"/pbrMetallicRoughness"),t.pbrMetallicRoughness,n))&&m.push(d),o.loadMaterialAlphaProperties(e,t,n),this._parseCommonConstantProperties(m,"".concat(e,"/commonConstant"),t,n)),m.length>0?[4,Promise.all(m)]:[3,2];case 1:a.sent(),a.label=2;case 2:return[3,9];case 3:p=a.sent(),h=(null==n?void 0:n.name)||(null==t?void 0:t.name)||"Unnamed",console.error("CVTOOLS: Error loading material properties for '".concat(h,"':"),p),a.label=4;case 4:return a.trys.push([4,7,,8]),console.warn("CVTOOLS: Attempting graceful degradation for material: ".concat(h)),m=[],this._parseCommonConstantProperties(m,"".concat(e,"/fallback"),t,n),m.length>0?[4,Promise.all(m)]:[3,6];case 5:a.sent(),a.label=6;case 6:return[3,8];case 7:return f=a.sent(),console.error("CVTOOLS: Fallback material loading also failed for '".concat(h,"':"),f),[3,8];case 8:return[3,9];case 9:return[2]}})})},t.prototype._getCachedMaterialByIndex=function(e){var t=null;return e>=0&&null!=this._materialMap&&(t=this._materialMap.get(e)||null),t},t.prototype._getCachedLightmapByIndex=function(e){var t=null;return e>=0&&null!=this._lightmapMap&&(t=this._lightmapMap.get(e)||null),t},t.prototype.createMaterial=function(t,n,i){if(!0===this._parseScene&&n.index){var o=n.index;if(o>=0){var r=this._getCachedMaterialByIndex(o);if(null!=r)return r}}if(!0===this._parseScene){var a=null,l=n.name||"No Name";if(null!=n.extras&&null!=n.extras.metadata&&null!=n.extras.metadata.customMaterial){var s=n.extras.metadata,u=s.customMaterial,c=(s.customShader,e.Utilities.InstantiateClass(u));if(null!=c){var d=new c(l,this._loader.babylonScene);null!=d?!0==d instanceof BABYLON.Material?((a=d).fillMode=i,a instanceof BABYLON.ShaderMaterial&&e.Utilities.InitializeShaderMaterial(a)):BABYLON.Tools.Warn("Non material instantiated class: "+u):BABYLON.Tools.Warn("Failed to instantiate material class: "+u)}else BABYLON.Tools.Warn("Failed to locate material class: "+u)}return a}return null},t.prototype.loadAnimationAsync=function(e,t){if(!0===this._parseScene){this._loader;var n=t;this._babylonScene._blockEntityCollection=!!this._assetContainer;var i=new BABYLON.AnimationGroup(t.name||"animation".concat(n.index),this._babylonScene);i._parentContainer=this._assetContainer,this._babylonScene._blockEntityCollection=!1,n._babylonAnimationGroup=i,this._animationGroups.push(i);var o=new Array;BABYLON.GLTF2.ArrayItem.Assign(n.channels),BABYLON.GLTF2.ArrayItem.Assign(n.samplers);for(var r=0,a=t.channels;r<a.length;r++){var l=a[r],s=l;o.push(this._loader._loadAnimationChannelAsync("".concat(e,"/channels/").concat(s.index),e,t,l,function(e,t){e.animations=e.animations||[],e.animations.push(t),i.addTargetedAnimation(t,e)}))}return Promise.all(o).then(function(){if(null!=t.extras&&null!=t.extras.metadata){var e={};e.toolkit=t.extras.metadata,i.metadata=e,null!=e.label&&""!==e.label&&(i.name=e.label)}return i.normalize(0),i})}return null},t.prototype._loadMeshPrimitiveAsync=function(e,t,n,i,o,r){var a=this;if(!0===this._parseScene){var l=this._loader;l.logOpen("".concat(e));var s,u=0===l._disableInstancedMesh&&l._parent.createInstances&&null==n.skin&&!i.primitives[0].targets,c=void 0;if(u&&o._instanceData)l._babylonScene._blockEntityCollection=!!l._assetContainer,(s=o._instanceData.babylonSourceMesh.createInstance(t))._parentContainer=l._assetContainer,l._babylonScene._blockEntityCollection=!1,c=o._instanceData.promise;else{var d=new Array;l._babylonScene._blockEntityCollection=!!l._assetContainer;var p=new BABYLON.Mesh(t,l._babylonScene);p._parentContainer=l._assetContainer,l._babylonScene._blockEntityCollection=!1,!0===this._leftHanded?p.overrideMaterialSideOrientation=BABYLON.Material.CounterClockWiseSideOrientation:p.overrideMaterialSideOrientation=l._babylonScene.useRightHandedSystem?BABYLON.Material.CounterClockWiseSideOrientation:BABYLON.Material.ClockWiseSideOrientation,l._createMorphTargets(e,n,i,o,p),d.push(l._loadVertexDataAsync(e,o,p).then(function(t){return l._loadMorphTargetsAsync(e,o,p,t).then(function(){l._disposed||(l._babylonScene._blockEntityCollection=!!l._assetContainer,t.applyToMesh(p),a._setupBabylonMesh(p,n,i,o),t._parentContainer=l._assetContainer,l._babylonScene._blockEntityCollection=!1)})}));var h=BABYLON.GLTF2.GLTFLoader._GetDrawMode(e,o.mode);if(null!=o.extras&&null!=o.extras.metadata&&null!=o.extras.metadata.multimaterial&&null!=o.extras.metadata.submeshes)this._setupBabylonMaterials(e,d,h,p,i,o);else if(null==o.material){var m=l._defaultBabylonMaterialData[h];m||(m=l._createDefaultMaterial("__GLTFLoader._default",h),l._parent.onMaterialLoadedObservable.notifyObservers(m),l._defaultBabylonMaterialData[h]=m),p.material=m}else if(!l.parent.skipMaterials){var f=BABYLON.GLTF2.ArrayItem.Get("".concat(e,"/material"),l._gltf.materials,o.material);d.push(l._loadMaterialAsync("/materials/".concat(f.index),f,p,h,function(e){p.material=e}))}c=Promise.all(d),u&&(o._instanceData={babylonSourceMesh:p,promise:c}),s=p}return BABYLON.GLTF2.GLTFLoader.AddPointerMetadata(s,e),l._parent.onMeshLoadedObservable.notifyObservers(s),r(s),l.logClose(),c.then(function(){return s})}return null},t.prototype._setupBabylonMesh=function(e,t,n,i){if(!0===this._parseScene){if(this._loader,null!=i.extras&&null!=i.extras.metadata&&null!=i.extras.metadata.multimaterial&&null!=i.extras.metadata.submeshes){var o=i.extras.metadata.submeshes;e.subMeshes=[];for(var r=0;r<o.length;r++){var a=o[r];BABYLON.SubMesh.AddToMesh(a.materialIndex,a.verticesStart,a.verticesCount,a.indexStart,a.indexCount,e)}}e.computeWorldMatrix(!0)}},t.prototype._setupBabylonMaterials=function(e,t,n,i,o,r){if(!0===this._parseScene){var a=this._loader,l=r.extras.metadata.multimaterial,s=l.materials,u=[],c=l.id||"MM_"+o.name,d=l.name||"MM_"+o.name,p=new BABYLON.MultiMaterial("["+d+"]",a._babylonScene);p.id=c,s.forEach(function(t){if(null!=t){var n=parseInt(t);if(n>=0){var o=BABYLON.GLTF2.ArrayItem.Get("".concat(e,"/material"),a._gltf.materials,n);u.push(o)}else console.warn("Invalid Submesh Material Index Encountered For: "+i.name)}else console.warn("Null Submesh Material Encountered For: "+i.name)}),t.push(this._parseMultiMaterialAsync("/materials/".concat(d),u,i,n,function(e){p.subMaterials=e,i.material=p}))}},t.prototype._processLevelOfDetail=function(t,n){null!=n&&n.length>0&&n.forEach(function(t){if(null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.lods&&null!=t.metadata.toolkit.distances){var n=t.metadata.toolkit,i=n.lods,o=n.distances;if(o.length>=i.length){var r=null,a=null;if(i.forEach(function(n,i){var o="*"===n?t:e.SceneManager.FindChildTransformNode(t,n,e.SearchType.ExactMatch,!1);null!=o&&o instanceof BABYLON.AbstractMesh&&(0===i?r=o:(null==a&&(a=[]),a.push(o)))}),null!=r)if(r instanceof BABYLON.Mesh){var l=o.length>0?o[o.length-1]:0;l>=1/0&&(l=0),null!=a&&a.forEach(function(e,t){r.addLODLevel(o[t],e)}),l>0&&r.addLODLevel(l,null)}else r instanceof BABYLON.InstancedMesh&&null!=a&&a.forEach(function(e,n){try{e.dispose()}catch(e){}BABYLON.Tools.Warn("Destroyed Unused Level Detail: "+e.name+" --\x3e For Transform: "+t.name)})}}})},t.prototype._processShaderMaterials=function(e,t){null!=t&&t.length>0&&t.forEach(function(e){e.freeze()})},t.prototype.preProcessSceneProperties=function(t,n){if(!0!==this._assetContainer&&!1===this._sceneParsed&&null!=t.extras&&null!=t.extras.metadata&&null!=t.extras.metadata.properties&&!0===t.extras.metadata.properties){this._sceneParsed=!0;var i=null!=this._rootUrl?this._rootUrl:"/",o=t.extras.metadata;if(null==n.metadata&&(n.metadata={}),null==n.metadata.toolkit&&(n.metadata.toolkit={}),n.metadata.toolkit=o,this._disposeRoot=null!=o.disposeroot&&!0===o.disposeroot,this._hideLoader=null!=o.hideloader&&!0===o.hideloader,this._preWarmTime=null!=o.prewarmup?o.prewarmup:0,this._licenseType=null!=o.license?o.license:"standard",this._licenseName=null!=o.licensee?o.licensee:"Unknown",e.SceneManager.SetRootUrl(n,i),e.SceneManager.SetSceneFile(n,this._fileName),e.SceneManager.EnableUserInput=!0,null!=this._licenseName&&""!==this._licenseName&&"Unknown"!==this._licenseName&&"DefaultCompany"!==this._licenseName&&"Default Company"!==this._licenseName&&BABYLON.Tools.Log(e.Utilities.MakeProper(this._fileName)+" licensed to "+this._licenseName),e.SceneManager.GlobalOptions.ktxtextures=null!=o.ktxtextures&&o.ktxtextures,e.SceneManager.GlobalOptions.ktxlightmaps=null!=o.ktxlightmaps&&o.ktxlightmaps,e.SceneManager.GlobalOptions.intensityFactor=null!=o.intensity?o.intensity:1,e.SceneManager.GlobalOptions.debugModeEnabled=null!=o.debugging&&o.debugging,e.SceneManager.GlobalOptions.showDebugColliders=null!=o.showdebugcolliders&&o.showdebugcolliders,e.SceneManager.GlobalOptions.colliderVisibility=null!=o.collidervisibility?o.collidervisibility:0,e.SceneManager.GlobalOptions.colliderRenderGroup=null!=o.colliderrendergroup?o.colliderrendergroup:0,e.SceneManager.GlobalOptions.defaultRenderGroup=null!=o.defaultrendergroup?o.defaultrendergroup:0,e.SceneManager.GlobalOptions.collisionWireframe=null!=o.collisionwireframe&&o.collisionwireframe,e.SceneManager.GlobalOptions.useTriangleNormals=null!=o.trianglenormals&&o.trianglenormals,e.SceneManager.GlobalOptions.useConvexTriangles=null==o.convextriangles||o.convextriangles,e.SceneManager.GlobalOptions.colliderInstances=null==o.colliderinstances||o.colliderinstances,e.SceneManager.GlobalOptions.reparentColliders=null==o.reparentcolliders||o.reparentcolliders,e.SceneManager.GlobalOptions.enablelegacyaudio=null!=o.enablelegacyaudio&&o.enablelegacyaudio,e.SceneManager.GlobalOptions.globalillumination=null!=o.globalillumination&&o.globalillumination,null!=o.clearcolor&&(n.clearColor=e.Utilities.ParseColor4(o.clearcolor)),null!=o.autoclear&&!0===o.autoclear&&(n.autoClear=!0,n.autoClearDepthAndStencil=!0),null!=o.rendergroups&&(BABYLON.RenderingManager.MAX_RENDERINGGROUPS=o.rendergroups),null!=o.imageprocessing){var r=o.imageprocessing,a=null!=r.contrast?r.contrast:1,l=null!=r.exposure?r.exposure:1;null!=n.imageProcessingConfiguration&&(n.imageProcessingConfiguration.contrast=a,n.imageProcessingConfiguration.exposure=l)}var s=e.SceneManager.AmbientLightIntensity,u=null!=o.ambientlightmap&&o.ambientlightmap>0?BABYLON.Light.LIGHTMAP_SHADOWSONLY:BABYLON.Light.LIGHTMAP_DEFAULT;if(null!=o.ambientcoloring&&(n.ambientColor=e.Utilities.ParseColor3(o.ambientcoloring)),null!=o.ambientlighting){var c=n;null==c._AmbientLight&&(c._AmbientLight=new BABYLON.HemisphericLight("Ambient Lighting",new BABYLON.Vector3(0,1,0),n),c._AmbientLight.falloffType=BABYLON.Light.FALLOFF_STANDARD,c._AmbientLight.lightmapMode=u),null!=c._AmbientLight&&(null!=o.ambientskycolor&&(c._AmbientLight.diffuse=e.Utilities.ParseColor3(o.ambientskycolor,BABYLON.Color3.Gray())),null!=o.ambientspecularcolor&&(c._AmbientLight.specular=e.Utilities.ParseColor3(o.ambientspecularcolor,BABYLON.Color3.White())),null!=o.ambientgroundcolor&&(c._AmbientLight.groundColor=e.Utilities.ParseColor3(o.ambientgroundcolor,BABYLON.Color3.Gray())),null!=o.ambientlightintensity&&(c._AmbientLight.intensity=o.ambientlightintensity),c._AmbientLight.intensity*=s)}if(null!=o.fogmode){var d=o.fogmode;if(d>0){n.fogMode=d,n.fogEnabled=!0;var p=1;1===d?p=.5:2===d&&(p=.75),null!=o.fogdensity&&(n.fogDensity=o.fogdensity*p),null!=o.fogstart&&(n.fogStart=o.fogstart),null!=o.fogend&&(n.fogEnd=o.fogend),null!=o.fogcolor&&(n.fogColor=e.Utilities.ParseColor3(o.fogcolor))}}var h=new BABYLON.Vector3(0,-9.81,0),m=null!=o.defaultgravity?e.Utilities.ParseVector3(o.defaultgravity,h):h;if(n.gravity=m.clone(),n.collisionsEnabled=!0,null!=o.enablephysics&&!0===o.enablephysics){var f=null==o.ccdenabled||o.ccdenabled,g=null!=o.ccdpenetration?o.ccdpenetration:1e-4,y=null!=o.subtimestep?o.subtimestep:0,v=null!=o.maxworldsweep?o.maxworldsweep:0,_=null==o.deltaworldstep||o.deltaworldstep;e.RigidbodyPhysics.ConfigurePhysicsEngine(n,!_,y,v,f,g,m)}if(null!=o.userinput){var S=o.userinput;e.UserInputOptions.KeyboardSmoothing=S.keyboardSmoothing,e.UserInputOptions.KeyboardMoveSensibility=S.keyboardSensitivity,e.UserInputOptions.KeyboardArrowSensibility=1,e.UserInputOptions.KeyboardMoveDeadZone=S.keyboardDeadZone,e.UserInputOptions.GamepadDeadStickValue=S.padDeadStick,e.UserInputOptions.GamepadLStickXInverted=S.padLStickXInvert,e.UserInputOptions.GamepadLStickYInverted=S.padLStickYInvert,e.UserInputOptions.GamepadRStickXInverted=S.padRStickXInvert,e.UserInputOptions.GamepadRStickYInverted=S.padRStickYInvert,e.UserInputOptions.GamepadLStickSensibility=S.padLStickLevel,e.UserInputOptions.GamepadRStickSensibility=S.padRStickLevel,e.UserInputOptions.SupportedInputDevices=S.supportedDevices,e.UserInputOptions.BabylonAngularSensibility=2e3,e.UserInputOptions.DefaultAngularSensibility=S.mouseSensitivity,e.UserInputOptions.PointerWheelDeadZone=S.wheelDeadZone,e.UserInputOptions.PointerMouseDeadZone=S.mouseDeadZone,e.UserInputOptions.PointerMouseInverted=S.mouseMoveInvert,e.UserInputOptions.UseCanvasElement=S.useCanvasElement,e.UserInputOptions.UseArrowKeyRotation=S.arrowKeyRotation,e.UserInputOptions.EnableBabylonRotation=!1}if(null!=o.enableinput&&!0===o.enableinput){var B={contextMenu:null==o.contextmenu||o.contextmenu,pointerLock:null!=o.pointerlock&&o.pointerlock,preventDefault:null!=o.preventdefault&&o.preventdefault,useCapture:null!=o.usecapture&&o.usecapture};e.InputController.ConfigureUserInput(n.getEngine(),n,B)}null!=o.freezeactivemeshes&&!0===o.freezeactivemeshes&&(this._activeMeshes=!0),null!=o.performancepriority&&(n.performancePriority=o.performancepriority)}},t.prototype.postProcessSceneProperties=function(t,n,i){var o=this;if(!0!==this._assetContainer&&null!=n.extras&&null!=n.extras.metadata&&null!=n.extras.metadata.properties&&!0===n.extras.metadata.properties){var r=n.extras.metadata;if(null!=r.skybox){var a=r.skybox,l=null!=a.skyfog&&a.skyfog,s=null!=a.skytags?a.skytags:"Untagged",u=null!=a.skysize?a.skysize:1e3,c=null!=a.rotation?a.rotation:0,d=null!=a.basename&&""!==a.basename?t+a.basename:null,p=null!=a.skyfaces?a.skyfaces:null,h=null!=a.rendergroup?a.rendergroup:0,m=null!=a.extensions&&a.extensions.length>0?a.extensions:null,f=null!=a.polynomial?a.polynomial:1;try{if(null!=p&&""!==p&&null!=d&&""!==d){var g=null;if("png"===p||"webp"===p)g=new BABYLON.CubeTexture(d,i,m),d.indexOf("_rgbd")>=0?(g.isRGBD=!0,g.gammaSpace=!1):(g.isRGBD=!1,g.gammaSpace=!0);else if("jpg"===p)(g=new BABYLON.CubeTexture(d,i,m)).isRGBD=!1,g.gammaSpace=!0;else if("ktx2"===p)(g=new BABYLON.CubeTexture(d,i,m)).isRGBD=!1,g.gammaSpace=!0;else{var y=d+"."+p;(g=new BABYLON.CubeTexture(y,i,null,!0,null,null,null,null,!0)).gammaSpace=!1}g.name=a.basename,g.coordinatesMode=BABYLON.Texture.SKYBOX_MODE,g.rotationY=BABYLON.Tools.ToRadians(c);var v="Default Skybox",_=BABYLON.MeshBuilder.CreateBox(v,{size:u},i);_.renderingGroupId=e.Utilities.DefaultRenderGroup(),_.id=v,_.infiniteDistance=!0,_.applyFog=l,_.renderingGroupId=h,null!=s&&""!==s&&BABYLON.Tags.AddTagsTo(_,s),!0===i.useRightHandedSystem&&(_.scaling.x*=-1);var S=new BABYLON.StandardMaterial("Skybox-Material",i);S.backFaceCulling=!1,S.disableLighting=!0,S.diffuseColor=new BABYLON.Color3(0,0,0),S.emissiveColor=new BABYLON.Color3(0,0,0),S.specularColor=new BABYLON.Color3(0,0,0),S.ambientColor=new BABYLON.Color3(0,0,0),S.reflectionTexture=g,_.material=S}}catch(e){console.warn(e)}if(null!=a.environment){var B=a.environment;i.environmentIntensity=null!=B.level?BABYLON.Scalar.Clamp(B.level,0,10):1;var b=null!=B.info&&""!==B.info?B.info:null;if(null!=b&&""!==b)try{var C=e.SceneManager.GetRootUrl(i)+b.rooturl+b.name;if(null!=this._assetsManager){var A=this._assetsManager.addBinaryFileTask("Global.EnvironmentTextureTask",C);A.onSuccess=function(e){if(null!=e.data){var t=new Blob([e.data]),n=o._babylonScene,i=URL.createObjectURL(t),r=function(){URL.revokeObjectURL(i)},a=C.toLowerCase().endsWith(".env")?".env":".dds",l=new BABYLON.CubeTexture(i,n,null,null,null,r,r,null,!0,a);n.environmentTexture=l,n.environmentTexture.name="assets/"+b.name,null!=n.environmentTexture&&null!=n.environmentTexture.sphericalPolynomial&&(n.isReady()?n.environmentTexture.sphericalPolynomial.scaleInPlace(f):n.onReadyObservable.addOnce(function(){n.environmentTexture.sphericalPolynomial.scaleInPlace(f)}))}else console.error("Failed to load environment texture task: "+C)},A.onError=function(e,t,n){console.error(t,n)}}}catch(e){console.warn(e)}}}if(null!=r.navigation&&null!=r.navigation.prebaked&&""!==r.navigation.prebaked){var M=null!=r.navigation.collision&&!0===r.navigation.collision,T=null!=r.navigation.showdebug&&!0===r.navigation.showdebug,O=null!=r.navigation.debugcolor?r.navigation.debugcolor:[.2627451,.5960785,.7372549],I=null!=r.navigation.debugoffset?r.navigation.debugoffset:0,L=new BABYLON.Color3(O[0],O[1],O[2]),x=null!=r.navigation.timesteps?r.navigation.timesteps:0;if(null!=this._assetsManager){var N=r.navigation.prebaked,w=this._assetsManager.addBinaryFileTask("System.NavigationMeshTask",N);w.onSuccess=function(t){if(null!=t.data){var n=new Uint8Array(t.data);e.SceneManager.LoadNavigationMesh(i,n,T,L,x,M,I)}else console.error("Failed to load navigation mesh task: "+N)},w.onError=function(e,t,n){console.error(t,n)}}}}},t.prototype._preloadRawMaterialsAsync=function(e,t,n){var i=this._loader,o=new Array,r=BABYLON.Material.TriangleFillMode;return n.forEach(function(n){var a=BABYLON.GLTF2.ArrayItem.Get("".concat(e,"/material"),t,n);if(null!=a){var l=i.createMaterial(e,a,r);BABYLON.GLTF2.GLTFLoader.AddPointerMetadata(l,e),i._parent.onMaterialLoadedObservable.notifyObservers(l),o.push(i.loadMaterialPropertiesAsync(e,a,l))}}),Promise.all(o).then(function(){})},t.prototype._parseMultiMaterialAsync=function(e,t,n,i,o){var r=this;void 0===o&&(o=function(){});var a=this._loader,l=t;l._data=l._data||{};var s=l._data[i];if(!s){a.logOpen("".concat(e," ").concat(n.name||""));var u=[],c=new Array;t.forEach(function(t){var n=null;if(t.index){var o=t.index;o>=0&&(n=r._getCachedMaterialByIndex(o))}null==n&&(n=a.createMaterial(e,t,i),BABYLON.GLTF2.GLTFLoader.AddPointerMetadata(n,e),a._parent.onMaterialLoadedObservable.notifyObservers(n),c.push(a.loadMaterialPropertiesAsync(e,t,n))),u.push(n)}),s={babylonMaterials:u,babylonMeshes:[],promises:c},l._data[i]=s,a.logClose()}return s.babylonMeshes.push(n),n.onDisposeObservable.addOnce(function(){var e=s.babylonMeshes.indexOf(n);-1!==e&&s.babylonMeshes.splice(e,1)}),o(s.babylonMaterials),Promise.all(s.promises).then(function(){return s.babylonMaterials})},t.prototype._parseNodeMaterialPropertiesAsync=function(e,t,n){var i=null!=t.extras&&null!=t.extras.metadata?t.extras.metadata:null,o=n,r=new Array;if(o.backFaceCulling=null==i||null==i.backFaceCulling||i.backFaceCulling,t.doubleSided&&(o.backFaceCulling=!1),t.pbrMetallicRoughness){var a=t.pbrMetallicRoughness;if(a){if(a.baseColorFactor){var l=BABYLON.Color4.FromArray(a.baseColorFactor);o.setVector4("_Color",new BABYLON.Vector4(Math.pow(l.r,1/2.2),Math.pow(l.g,1/2.2),Math.pow(l.b,1/2.2),l.a)),l.a}else o.setVector4("_Color",new BABYLON.Vector4(1,1,1,1));a.baseColorTexture&&r.push(this._loader.loadTextureInfoAsync("".concat(e,"/baseColorTexture"),a.baseColorTexture,function(e){e.name="".concat(n.name," (Base Color)");var t=e;t.level=null!=i&&null!=i.diffuseIntensity?i.diffuseIntensity:1,o.setTexture("_MainTex",t)}))}}if(t.normalTexture&&r.push(this._loader.loadTextureInfoAsync("".concat(e,"/normalTexture"),t.normalTexture,function(e){e.name="".concat(n.name," (Normal)");var i=e;null!=t.normalTexture.scale&&(i.level=t.normalTexture.scale),o.setTexture("_BumpMap",i)})),t.occlusionTexture&&r.push(this._loader.loadTextureInfoAsync("".concat(e,"/occlusionTexture"),t.occlusionTexture,function(e){e.name="".concat(n.name," (Occlusion)");var i=e;null!=t.occlusionTexture.strength&&(i.level=t.occlusionTexture.strength),o.setTexture("_OcclusionMap",i)})),t.emissiveFactor){var s=BABYLON.Color4.FromArray(t.emissiveFactor);(s.r>0||s.g>0||s.b>0)&&o.setVector4("_EmissionColor",new BABYLON.Vector4(Math.pow(s.r,1/2.2),Math.pow(s.g,1/2.2),Math.pow(s.b,1/2.2),s.a))}if(t.emissiveTexture&&r.push(this._loader.loadTextureInfoAsync("".concat(e,"/emissiveTexture"),t.emissiveTexture,function(e){e.name="".concat(n.name," (Emissive)");var t=e;o.setTexture("_EmissionMap",t)})),null!=i){if(o.wireframe=null!=i.useWireframe&&i.useWireframe,o.needDepthPrePass=null!=i.depthPrepass&&i.depthPrepass,i.customTextures){var u=function(t){var a=i.customTextures[t];null!=a&&r.push(c._loader.loadTextureInfoAsync(e+"/"+t,a,function(e){e.name="".concat(n.name,"detailsSampler"===t||"normalsSampler"===t?" (Atlas)":" (Custom)"),o.setTexture(t,e)}))},c=this;for(var d in i.customTextures)u(d)}if(i.customVectors)for(var p in i.customVectors){var h=i.customVectors[p];null!=h&&o.setVector4(p,BABYLON.Vector4.FromArray(h))}if(i.customColors)for(var m in i.customColors){var f=i.customColors[m];null!=f&&o.setVector4(m,BABYLON.Vector4.FromArray(f))}if(i.customFloats)for(var g in i.customFloats){var y=i.customFloats[g];null!=y&&o.setFloat(g,y)}null!=i.freezeMaterial&&!0===i.freezeMaterial&&null!=this._shaderList&&this._shaderList.push(o)}var v=Promise.all(r).then(function(){});return o.compile(),v},t.prototype._parseShaderMaterialPropertiesAsync=function(t,n,i){var o=null!=n.extras&&null!=n.extras.metadata?n.extras.metadata:null,r=i,a=new Array;r.backFaceCulling=null==o||null==o.backFaceCulling||o.backFaceCulling,n.doubleSided&&(r.backFaceCulling=!1),e.Utilities.HasOwnProperty(r,"ambientColor")&&(r.ambientColor=null!=o&&o.ambientColorFactor?BABYLON.Color3.FromArray(o.ambientColorFactor):BABYLON.Color3.Black());var l=1;if(n.pbrMetallicRoughness){var s=n.pbrMetallicRoughness;if(s){if(s.baseColorFactor){var u=BABYLON.Color4.FromArray(s.baseColorFactor);r.setVector4("diffuseColor",new BABYLON.Vector4(Math.pow(u.r,1/2.2),Math.pow(u.g,1/2.2),Math.pow(u.b,1/2.2),u.a)),l=u.a}else r.setVector4("diffuseColor",new BABYLON.Vector4(1,1,1,1));s.baseColorTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/baseColorTexture"),s.baseColorTexture,function(e){e.name="".concat(i.name," (Base Color)");var t=e;t.level=null!=o&&null!=o.diffuseIntensity?o.diffuseIntensity:1,r.setTexture("diffuseTexture",t)}))}}if(n.normalTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/normalTexture"),n.normalTexture,function(e){e.name="".concat(i.name," (Normal)");var t=e;null!=n.normalTexture.scale&&(t.level=n.normalTexture.scale),r.setTexture("bumpTexture",t)})),n.occlusionTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/occlusionTexture"),n.occlusionTexture,function(e){e.name="".concat(i.name," (Occlusion)");var t=e;null!=n.occlusionTexture.strength&&(t.level=n.occlusionTexture.strength),r.setTexture("ambientTexture",t)})),n.emissiveFactor){var c=BABYLON.Color4.FromArray(n.emissiveFactor);(c.r>0||c.g>0||c.b>0)&&r.setVector4("emissiveColor",new BABYLON.Vector4(Math.pow(c.r,1/2.2),Math.pow(c.g,1/2.2),Math.pow(c.b,1/2.2),c.a))}switch(n.emissiveTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/emissiveTexture"),n.emissiveTexture,function(e){e.name="".concat(i.name," (Emissive)");var t=e;r.setTexture("emissiveTexture",t)})),r.alpha=l,n.alphaMode||e.MaterialAlphaMode.OPAQUE){case e.MaterialAlphaMode.OPAQUE:r.alpha=1,r.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_OPAQUE;break;case e.MaterialAlphaMode.MASK:r.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_ALPHATEST;break;case e.MaterialAlphaMode.BLEND:r.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_ALPHABLEND;break;default:throw new Error("".concat(t,"/AlphaMode: Invalid value (").concat(n.alphaMode,")"))}if(null!=o){if(r.wireframe=null!=o.useWireframe&&o.useWireframe,r.needDepthPrePass=null!=o.depthPrepass&&o.depthPrepass,o.customTextures){var d=function(e){var n=o.customTextures[e];null!=n&&a.push(p._loader.loadTextureInfoAsync(t+"/"+e,n,function(t){t.name="".concat(i.name,"detailsSampler"===e||"normalsSampler"===e?" (Atlas)":" (Custom)"),r.setTexture(e,t)}))},p=this;for(var h in o.customTextures)d(h)}if(o.customVectors)for(var m in o.customVectors){var f=o.customVectors[m];null!=f&&r.setVector4(m,BABYLON.Vector4.FromArray(f))}if(o.customColors)for(var g in o.customColors){var y=o.customColors[g];null!=y&&r.setVector4(g,BABYLON.Vector4.FromArray(y))}if(o.customFloats)for(var v in o.customFloats){var _=o.customFloats[v];null!=_&&r.setFloat(v,_)}null!=o.freezeMaterial&&!0===o.freezeMaterial&&null!=this._shaderList&&this._shaderList.push(r)}return Promise.all(a).then(function(){})},t.prototype._parseDiffuseMaterialPropertiesAsync=function(t,n,i){var o=null!=n.extras&&null!=n.extras.metadata?n.extras.metadata:null,r=i,a=new Array;e.Utilities.HasOwnProperty(r,"ambientColor")&&(r.ambientColor=null!=o&&o.ambientColorFactor?BABYLON.Color3.FromArray(o.ambientColorFactor):BABYLON.Color3.Black()),e.Utilities.HasOwnProperty(r,"backFaceCulling")&&(r.backFaceCulling=null==o||null==o.backFaceCulling||o.backFaceCulling),n.doubleSided&&(e.Utilities.HasOwnProperty(r,"twoSidedLighting")&&(r.twoSidedLighting=!0),e.Utilities.HasOwnProperty(r,"backFaceCulling")&&(r.backFaceCulling=!1));var l=1;if(n.pbrMetallicRoughness){var s=n.pbrMetallicRoughness;if(s){if(e.Utilities.HasOwnProperty(r,"diffuseColor"))if(s.baseColorFactor){var u=BABYLON.Color4.FromArray(s.baseColorFactor);r.diffuseColor=new BABYLON.Color3(Math.pow(u.r,1/2.2),Math.pow(u.g,1/2.2),Math.pow(u.b,1/2.2)),l=u.a}else r.diffuseColor=BABYLON.Color3.White();e.Utilities.HasOwnProperty(r,"diffuseTexture")&&s.baseColorTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/baseColorTexture"),s.baseColorTexture,function(e){e.name="".concat(i.name," (Base Color)"),r.diffuseTexture=e,r.diffuseTexture.level=null!=o&&null!=o.diffuseIntensity?o.diffuseIntensity:1}))}}if(e.Utilities.HasOwnProperty(r,"bumpTexture")&&n.normalTexture&&(a.push(this._loader.loadTextureInfoAsync("".concat(t,"/normalTexture"),n.normalTexture,function(e){e.name="".concat(i.name," (Normal)"),r.bumpTexture=e,null!=n.normalTexture.scale&&(r.bumpTexture.level=n.normalTexture.scale)})),e.Utilities.HasOwnProperty(r,"invertNormalMapX")&&(r.invertNormalMapX=!this._loader.babylonScene.useRightHandedSystem),e.Utilities.HasOwnProperty(r,"invertNormalMapY")&&(r.invertNormalMapY=this._loader.babylonScene.useRightHandedSystem)),e.Utilities.HasOwnProperty(r,"ambientTexture")&&n.occlusionTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/occlusionTexture"),n.occlusionTexture,function(e){e.name="".concat(i.name," (Occlusion)"),r.ambientTexture=e,null!=n.occlusionTexture.strength&&(r.ambientTexture.level=n.occlusionTexture.strength)})),e.Utilities.HasOwnProperty(r,"emissiveColor")){var c=n.emissiveFactor?BABYLON.Color4.FromArray(n.emissiveFactor):new BABYLON.Color4(0,0,0,1);r.emissiveColor=new BABYLON.Color3(Math.pow(c.r,1/2.2),Math.pow(c.g,1/2.2),Math.pow(c.b,1/2.2))}switch(e.Utilities.HasOwnProperty(r,"emissiveTexture")&&n.emissiveTexture&&a.push(this._loader.loadTextureInfoAsync("".concat(t,"/emissiveTexture"),n.emissiveTexture,function(t){t.name="".concat(i.name," (Emissive)"),r.emissiveTexture=t,e.Utilities.HasOwnProperty(r,"useEmissiveAsIllumination")&&(r.useEmissiveAsIllumination=null!=o&&null!=o.useEmissiveAsIllumination&&o.useEmissiveAsIllumination)})),e.Utilities.HasOwnProperty(r,"alpha")&&(r.alpha=l),n.alphaMode||e.MaterialAlphaMode.OPAQUE){case e.MaterialAlphaMode.OPAQUE:e.Utilities.HasOwnProperty(r,"alpha")&&(r.alpha=1);break;case e.MaterialAlphaMode.MASK:r.alphaCutOff=null==n.alphaCutoff?.5:n.alphaCutoff,r.diffuseTexture&&e.Utilities.HasOwnProperty(r,"diffuseTexture")&&(r.diffuseTexture.hasAlpha=!0);break;case e.MaterialAlphaMode.BLEND:r.diffuseTexture&&(e.Utilities.HasOwnProperty(r,"diffuseTexture")&&(r.diffuseTexture.hasAlpha=!0),e.Utilities.HasOwnProperty(r,"useAlphaFromDiffuseTexture")&&(r.useAlphaFromDiffuseTexture=!0));break;default:throw new Error("".concat(t,"/AlphaMode: Invalid value (").concat(n.alphaMode,")"))}return this._parseCommonConstantProperties(a,t,n,i),Promise.all(a).then(function(){})},t.prototype._parseCommonConstantProperties=function(t,n,i,o){var r=this,a=null!=i.extras&&null!=i.extras.metadata?i.extras.metadata:null;if(null!=a){var l=o;if(e.Utilities.HasOwnProperty(l,"alphaMode")&&(l.alphaMode=null!=a&&a.alphaMode?a.alphaMode:BABYLON.Engine.ALPHA_COMBINE),e.Utilities.HasOwnProperty(l,"ambientColor")&&(l.ambientColor=null!=a&&a.ambientColorFactor?BABYLON.Color3.FromArray(a.ambientColorFactor):BABYLON.Color3.Black()),e.Utilities.HasOwnProperty(l,"backFaceCulling")&&(l.backFaceCulling=null==a||null==a.backFaceCulling||a.backFaceCulling),o instanceof BABYLON.PBRMaterial){switch(o.useMetallnessFromMetallicTextureBlue=!0,o.useRoughnessFromMetallicTextureGreen=!0,o.useRoughnessFromMetallicTextureAlpha=!1,o.useAmbientOcclusionFromMetallicTextureRed=!1,o.directIntensity=null!=a.directIntensity?a.directIntensity:1,o.specularIntensity=null!=a.specularIntensity?a.specularIntensity:1,o.emissiveIntensity=null!=a.emissiveIntensity?a.emissiveIntensity:1,o.environmentIntensity=null!=a.environmentIntensity?a.environmentIntensity:1,o.indexOfRefraction=null!=a.indexOfRefraction?a.indexOfRefraction:1.5,o.reflectivityColor=(null!=a.isSpecular&&a.isSpecular,BABYLON.Color3.Black()),i.alphaMode||e.MaterialAlphaMode.OPAQUE){case e.MaterialAlphaMode.OPAQUE:o.alpha=1,o.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_OPAQUE;break;case e.MaterialAlphaMode.MASK:o.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_ALPHATESTANDBLEND;break;case e.MaterialAlphaMode.BLEND:o.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_ALPHABLEND;break;default:o.alpha=1,o.transparencyMode=BABYLON.ShaderMaterial.MATERIAL_OPAQUE}var s=null!=a.realtimeFilteringMode?a.realtimeFilteringMode:0,u=null!=a.realtimeFilteringQuality?a.realtimeFilteringQuality:0;if(o.environmentIntensity>0&&s>0){var c=e.WindowManager.IsDesktop(),d=e.WindowManager.IsHighEndMobile(),p=!1;if(1===s?p=c||d:2===s&&(p=!0),!0===p)switch(o.realTimeFiltering=!0,u){case 1:o.realTimeFilteringQuality=d?16:32;break;case 2:o.realTimeFilteringQuality=d?32:64;break;default:o.realTimeFilteringQuality=d?8:16}}var h=null!=a.clearCoatIntensity?a.clearCoatIntensity:0;h>0&&(o.clearCoat.isEnabled=!0,o.clearCoat.intensity=h),null!=a.useAlphaFromAlbedoTexture&&(o.useAlphaFromAlbedoTexture=a.useAlphaFromAlbedoTexture),null!=a.parallaxBias&&a.parallaxBias>0&&(o.useParallax=!0,o.parallaxScaleBias=.9*a.parallaxBias,o.useParallaxOcclusion=null==a.parallaxOcclusion||a.parallaxOcclusion,!0===o.useParallaxOcclusion&&(o.parallaxScaleBias*=.5))}if(e.Utilities.HasOwnProperty(l,"wireframe")&&(l.wireframe=null!=a.useWireframe&&a.useWireframe),e.Utilities.HasOwnProperty(l,"disableLighting")&&(l.disableLighting=null!=a.disableLighting&&a.disableLighting),e.Utilities.HasOwnProperty(l,"maxSimultaneousLights")&&(l.maxSimultaneousLights=null!=a.maxSimultaneousLights?a.maxSimultaneousLights:4),e.Utilities.HasOwnProperty(l,"needDepthPrePass")&&(l.needDepthPrePass=null!=a.depthPrepass&&a.depthPrepass),e.Utilities.HasOwnProperty(l,"lightmapTexture")&&a.lightmapTexture){a.lightmapTexture.nonColorData=!0;var m=!0;e.Utilities.HasOwnProperty(l,"useLightmapAsShadowmap")&&(m=null==a.useLightmapAsShadowmap||a.useLightmapAsShadowmap);var f=null,g=null!=a.lightmapTexture.index?a.lightmapTexture.index:-1;g>=0&&(f=this._getCachedLightmapByIndex(g)),null!=f?(l.lightmapTexture=f,l.useLightmapAsShadowmap=m,e.Utilities.HasOwnProperty(l,"ambientColor")&&(l.ambientColor=BABYLON.Color3.White())):t.push(this._loader.loadTextureInfoAsync(n+"/lightmapTexture",a.lightmapTexture,function(t){t.name="assets/LightmapTexture-".concat(g),t.level=a.lightmapLevel?a.lightmapLevel:1;var n=t;!0==(null!=e.SceneManager.GlobalOptions.ktxlightmaps&&!0===e.SceneManager.GlobalOptions.ktxlightmaps)?t.gammaSpace=!0:(t.gammaSpace=!1,n.onLoadObservable.addOnce(function(){n.isReady()?n.isRGBD=!0:BABYLON.Tools.Warn("Failed to register texture as RGBD: "+n.name)})),l.lightmapTexture=t,g>=0&&null!=r._lightmapMap&&(r._lightmapMap.has(g)||r._lightmapMap.set(g,n)),l.useLightmapAsShadowmap=m,e.Utilities.HasOwnProperty(l,"ambientColor")&&(l.ambientColor=BABYLON.Color3.White())}))}o instanceof BABYLON.PBRMaterial&&a.detailMapTexture&&t.push(this._loader.loadTextureInfoAsync(n+"/detailMapTexture",a.detailMapTexture,function(e){e.name="".concat(o.name," (Detail Map)"),e.level=1,o.detailMap.texture=e,o.detailMap.bumpLevel=a.detailBumpLevel?a.detailBumpLevel:1,o.detailMap.diffuseBlendLevel=a.detailBlendLevel?a.detailBlendLevel:.75,o.detailMap.roughnessBlendLevel=a.detailRoughLevel?a.detailRoughLevel:.5,o.detailMap.isEnabled=!0}));var y=e.SceneManager.GetRenderQuality(),v=y===e.RenderQuality.High||y===e.RenderQuality.Medium;if(!0===v&&e.Utilities.HasOwnProperty(l,"reflectionColor")&&(l.reflectionColor=null!=a&&a.reflectionColorFactor?BABYLON.Color3.FromArray(a.reflectionColorFactor):BABYLON.Color3.White()),!0===v&&e.Utilities.HasOwnProperty(l,"reflectionTexture"))if(0===o.environmentIntensity)o.environmentIntensity=1,o.realTimeFiltering=!1,o.reflectionTexture=e.Utilities.GetNeutralReflectionTexture(this._babylonScene,128,.4);else if(a.reflectionCubemapInfo){var _=(this._loader._rootUrl+a.reflectionCubemapInfo.rooturl+a.reflectionCubemapInfo.name).toLowerCase(),S=_.lastIndexOf("."),B=S>-1?_.substring(S).toLowerCase():"",b=new e.CubeTextureLoader;b.name="assets/"+a.reflectionCubemapInfo.name,b.mapkey=_,b.material=l,b.extension=B,b.prefiltered=!0,a.reflectionCubemapInfo.boundingBoxSize&&(b.boundingBoxSize=BABYLON.Vector3.FromArray(a.reflectionCubemapInfo.boundingBoxSize),b.name+=" ("+b.boundingBoxSize.x.toString()+" "+b.boundingBoxSize.y.toString()+" "+b.boundingBoxSize.z.toString()+")",b.mapkey+="_"+b.boundingBoxSize.x.toString()+"_"+b.boundingBoxSize.y.toString()+"_"+b.boundingBoxSize.z.toString()),a.reflectionCubemapInfo.boundingBoxPosition&&(b.boundingBoxPosition=BABYLON.Vector3.FromArray(a.reflectionCubemapInfo.boundingBoxPosition),b.name+=" ("+b.boundingBoxPosition.x.toString()+" "+b.boundingBoxPosition.y.toString()+" "+b.boundingBoxPosition.z.toString()+")",b.mapkey+="_"+b.boundingBoxPosition.x.toString()+"_"+b.boundingBoxPosition.y.toString()+"_"+b.boundingBoxPosition.z.toString());var C=this._reflectionMap[_];null==C?(C=[b],this._reflectionMap[_]=C):C.push(b)}if(e.Utilities.HasOwnProperty(l,"terrainInfo")&&(l.terrainInfo=null!=a.terrainInfo?a.terrainInfo:null),e.Utilities.HasOwnProperty(o,"universalMaterial")){var A=o;if(a.customTextures){var M=function(e){var i=a.customTextures[e];null!=i&&(A.checkSampler(e),t.push(T._loader.loadTextureInfoAsync(n+"/"+e,i,function(t){t.name="".concat(o.name,"detailsSampler"===e||"normalsSampler"===e?" (Atlas)":" (Custom)"),A.setTextureValue(e,t)})))},T=this;for(var O in a.customTextures)M(O)}if(a.customVectors)for(var I in a.customVectors)null!=(P=a.customVectors[I])&&A.addVector4Uniform(I,BABYLON.Vector4.FromArray(P),!0);if(a.customColors)for(var L in a.customColors)null!=(R=a.customColors[L])&&A.addVector4Uniform(L,BABYLON.Vector4.FromArray(R),!0);if(a.customFloats)for(var x in a.customFloats)null!=(k=a.customFloats[x])&&A.addFloatUniform(x,k,!0)}else{if(a.customTextures){var N=function(i){var r=a.customTextures[i];null!=r&&e.Utilities.HasOwnProperty(l,i)&&t.push(w._loader.loadTextureInfoAsync(n+"/"+i,r,function(e){e.name="".concat(o.name,"detailsSampler"===i||"normalsSampler"===i?" (Atlas)":" (Custom)"),l[i]=e}))},w=this;for(var O in a.customTextures)N(O)}if(a.customVectors)for(var I in a.customVectors){var P;null!=(P=a.customVectors[I])&&e.Utilities.HasOwnProperty(l,I)&&(l[I]=BABYLON.Vector4.FromArray(P))}if(a.customColors)for(var L in a.customColors){var R;null!=(R=a.customColors[L])&&e.Utilities.HasOwnProperty(l,L)&&(l[L]instanceof BABYLON.Vector4?l[L]=BABYLON.Vector4.FromArray(R):l[L]instanceof BABYLON.Color4?l[L]=BABYLON.Color4.FromArray(R):l[L]=BABYLON.Color3.FromArray(R))}if(a.customFloats)for(var x in a.customFloats){var k;null!=(k=a.customFloats[x])&&e.Utilities.HasOwnProperty(l,x)&&(l[x]instanceof Boolean?l[x]=k>0:l[x]=k)}}null!=a.freezeMaterial&&!0===a.freezeMaterial&&null!=this._shaderList&&this._shaderList.push(o)}},t.ScriptBundleCache={},t}();e.CVTOOLS_unity_metadata=n;var i=function(){function t(t){this.name=e.SceneManager.CVTOOLS_MESH,this.enabled=!1,this._loader=t,this.enabled=this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_MESH),this.order=101}return t.prototype.dispose=function(){delete this._loader},t}();e.CVTOOLS_babylon_mesh=i;var o=function(){function t(t){this.name=e.SceneManager.CVTOOLS_HAND,this.enabled=!1,this._loader=t,this.enabled=this._loader.isExtensionUsed(e.SceneManager.CVTOOLS_HAND),this.order=102}return t.prototype.dispose=function(){delete this._loader},t}();e.CVTOOLS_left_handed=o}(i||(i={})),function(e){var t=function(e){function t(t,n){var i=e.call(this,t,n)||this;return i.universalMaterial=!0,i._defines={},i._uniforms=[],i._samplers=[],i._attributes=[],i._textures={},i._vectors4={},i._vectors3={},i._vectors2={},i._floats={},i._bools={},i._ubos=null,i.shader=null,i.plugin=null,i}return o(t,e),t.prototype.getClassName=function(){return"PBRMaterial"},t.prototype.addAttribute=function(e){-1===this._attributes.indexOf(e)&&this._attributes.push(e)},t.prototype.checkUniform=function(e,t,n){void 0===n&&(n=null),-1===this._uniforms.indexOf(e)&&(this._uniforms.push(e),this._defines[e.toUpperCase()]=!0,this.buildUniformProperty(e,t,n))},t.prototype.checkSampler=function(e,t){void 0===t&&(t=null),-1===this._samplers.indexOf(e)&&(this._samplers.push(e),this._defines[e.toUpperCase()]=!0,this.buildUniformProperty(e,"sampler2D",t),this.checkUniform(e+"Infos","vec2",BABYLON.Vector2.Zero()),this.checkUniform(e+"Matrix","mat4",BABYLON.Matrix.Identity()))},t.prototype.addTextureUniform=function(e,t){return this.checkSampler(e,t),this._textures[e]=t,this},t.prototype.setTextureValue=function(e,t){return this._textures[e]=t,this},t.prototype.getTextureValue=function(e){return this._textures[e]},t.prototype.addVector4Uniform=function(e,t){return this.checkUniform(e,"vec4",t),this._vectors4[e]=t,this},t.prototype.setVector4Value=function(e,t){return this._vectors4[e]=t,this},t.prototype.getVector4Value=function(e){return this._vectors4[e]},t.prototype.addVector3Uniform=function(e,t){return this.checkUniform(e,"vec3",t),this._vectors3[e]=t,this},t.prototype.setVector3Value=function(e,t){return this._vectors3[e]=t,this},t.prototype.getVector3Value=function(e){return this._vectors3[e]},t.prototype.addVector2Uniform=function(e,t){return this.checkUniform(e,"vec2",t),this._vectors2[e]=t,this},t.prototype.setVector2Value=function(e,t){return this._vectors2[e]=t,this},t.prototype.getVector2Value=function(e){return this._vectors2[e]},t.prototype.addFloatUniform=function(e,t){return this.checkUniform(e,"float",t),this._floats[e]=t,this},t.prototype.setFloatValue=function(e,t){return this._floats[e]=t,this},t.prototype.getFloatValue=function(e){return this._floats[e]},t.prototype.addBoolUniform=function(e,t){return this.checkUniform(e,"bool",t),this._bools[e]=t,this},t.prototype.setBoolValue=function(e,t){return this._bools[e]=t,this},t.prototype.getBoolValue=function(e){return this._bools[e]},t.prototype.getAnimatables=function(){var t=e.prototype.getAnimatables.call(this);for(var n in this._textures){var i=this._textures[n];i&&i.animations&&i.animations.length>0&&t.push(i)}return t},t.prototype.getActiveTextures=function(){var t=e.prototype.getActiveTextures.call(this);for(var n in this._textures){var i=this._textures[n];i&&t.push(i)}return t},t.prototype.hasTexture=function(t){if(e.prototype.hasTexture.call(this,t))return!0;var n=!1;for(var i in this._textures){var o=this._textures[i];if(o==o){n=!0;break}}return n},t.prototype.getCustomUniforms=function(e){var t=null;return null!=this._ubos&&this._ubos.length>0&&(t=this._ubos.filter(function(e){return"sampler2D"!==e.type})),t},t.prototype.getCustomSamplers=function(){return this._samplers},t.prototype.getCustomAttributes=function(){return this._attributes},t.prototype.getCustomVertexCode=function(e){return null},t.prototype.getCustomFragmentCode=function(e){var t=null;return null!=this._ubos&&this._ubos.length>0&&(t="#ifdef "+this.shader.toUpperCase()+"\n",this._ubos.forEach(function(n){!0===e?"sampler2D"===n.type&&(t+="\tvar "+n.name+": texture_2d<f32>;\n",t+="\tvar "+n.name+"Sampler: sampler;\n"):"float"===n.type||"bool"===n.type||"int"===n.type?t+="\tuniform float "+n.name+";\n":"vec2"===n.type?t+="\tuniform vec2 "+n.name+";\n":"vec3"===n.type?t+="\tuniform vec3 "+n.name+";\n":"vec4"===n.type?t+="\tuniform vec4 "+n.name+";\n":"mat4"===n.type?t+="\tuniform mat4 "+n.name+";\n":"sampler2D"===n.type&&(t+="\tuniform sampler2D "+n.name+";\n")}),t+="#endif\n"),t},t.prototype.prepareCustomDefines=function(e){if(e[this.shader.toUpperCase()]=!0,null!=this._defines){var t=Object.keys(this._defines);if(null!=t&&t.length>0)for(var n=0,i=t;n<i.length;n++){var o=i[n];e[o]=this._defines[o]}}e.isDirty&&e.rebuild()},t.prototype.updateCustomBindings=function(e){var t,n=this.getScene();if(this.update&&this.update(),n.texturesEnabled)for(t in this._textures){var i=this._textures[t];null!=i&&i.isReady&&i.isReady()&&(null==i.isChecked&&(i.isChecked=!0,("detailsSampler"===t||"normalsSampler"===t||t.indexOf("(Atlas)")>=0)&&i.updateSamplingMode(8)),e.setTexture(t,i),e.updateFloat2(t+"Infos",i.coordinatesIndex,i.level),e.updateMatrix(t+"Matrix",i.getTextureMatrix()))}for(t in this._vectors4)e.updateVector4(t,this._vectors4[t]);for(t in this._vectors3)e.updateVector3(t,this._vectors3[t]);for(t in this._vectors2)e.updateFloat2(t,this._vectors2[t].x,this._vectors2[t].y);for(t in this._floats)e.updateFloat(t,this._floats[t]);for(t in this._bools)e.updateFloat(t,this._bools[t]?1:0);e.update()},t.prototype.buildUniformProperty=function(e,t,n){var i=1;switch(t){case"float":case"bool":case"int":i=1;break;case"vec2":i=2;break;case"vec3":i=3;break;case"vec4":i=4;break;case"mat4":i=16}null==this._ubos&&(this._ubos=[]),this._ubos.push({name:e,size:i,type:t})},t}(BABYLON.PBRMaterial);e.CustomShaderMaterial=t,e.SceneManager.RegisterClass("TOOLKIT.CustomShaderMaterial",t);var n=function(e){function t(t,n,i,o,r,a,l){void 0===r&&(r=!0),void 0===a&&(a=!0),void 0===l&&(l=!1);var s=e.call(this,t,n,i,o,r,a,l)||this;return s._isEnabled=!1,s.vertexDefinitions=null,s.fragmentDefinitions=null,s.isEnabled=a,s}return o(t,e),t.prototype.getClassName=function(){return"MaterialPluginBase"},Object.defineProperty(t.prototype,"isEnabled",{get:function(){return this._isEnabled},set:function(e){this._isEnabled!==e&&(this._isEnabled=e,this.markAllDefinesAsDirty(),this._enable(this._isEnabled))},enumerable:!1,configurable:!0}),t.prototype.getCustomShaderMaterial=function(){return this._material},t}(BABYLON.MaterialPluginBase);e.CustomShaderMaterialPlugin=n,e.SceneManager.RegisterClass("TOOLKIT.CustomShaderMaterialPlugin",n)}(i||(i={})),function(e){var t=function(){function t(e){this._babylonScene=e,this._physicList=[],this._shadowList=[],this._scriptList=[],this._freezeList=[]}return t.prototype.parseSceneComponents=function(t){e.MetadataParser.DoParseSceneComponents(this._babylonScene,t,this._physicList,this._shadowList,this._scriptList,this._freezeList)},t.prototype.postProcessSceneComponents=function(t,n){e.MetadataParser.DoProcessPendingPhysics(this._babylonScene,this._physicList),e.MetadataParser.DoProcessPendingShadows(this._babylonScene,this._shadowList),e.MetadataParser.DoProcessPendingScripts(this._babylonScene,this._scriptList,t,n),e.MetadataParser.DoProcessPendingFreezes(this._freezeList),this._babylonScene=null,this._physicList=null,this._shadowList=null,this._scriptList=null,this._freezeList=null},t.DoParseSceneComponents=function(t,n,i,o,r,a){if(null!=n&&null!=n.metadata&&null!=n.metadata.toolkit&&null!=n.metadata.toolkit.parsed&&!1===n.metadata.toolkit.parsed){n.onDisposeObservable.addOnce(function(){e.Utilities.DisposeEntity(n)}),n.metadata.toolkit.parsed=!0,n.metadata.toolkit.prefab=!1;var l=n.metadata.toolkit,s=null==n.metadata.toolkit.visible||n.metadata.toolkit.visible,u=null!=n.metadata.toolkit.visibility?n.metadata.toolkit.visibility:1,c=null!=n.metadata.toolkit.billboard?n.metadata.toolkit.billboard:0,d=n instanceof BABYLON.AbstractMesh,p=(null!=n.metadata.toolkit.lightmapped&&n.metadata.toolkit.lightmapped,l.tags);if(null!=p&&""!==p&&(BABYLON.Tags.AddTagsTo(n,p),p.indexOf("NavigationMesh")>=0&&(n.isVisible=!1,n.isPickable=!1,n.useVertexColors=!1)),null!=l.physics&&null!=i&&i.push(n),null!=l.renderer)if(!0===d)n.isPickable=!0,n.useVertexColors=!1,n.isVisible=s,n.visibility=u,n.billboardMode=c,n.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD,null!=l.renderer.cullingstrategy&&l.renderer.cullingstrategy!==BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD&&(n.cullingStrategy=l.renderer.cullingstrategy),null!=l.renderer.castshadows&&!0===l.renderer.castshadows&&null!=o&&o.push(n),null!=l.renderer.receiveshadows&&!0===l.renderer.receiveshadows&&(n.receiveShadows=!0),null!=l.renderer.checkcollisions&&!0===l.renderer.checkcollisions&&(n.checkCollisions=!0),null!=l.renderer.istriggervolume&&!0===l.renderer.istriggervolume&&(n.collisionResponse=!1),null!=l.renderer.usevertexcolors&&(n.useVertexColors=l.renderer.usevertexcolors),null!=l.renderer.setmeshpickable&&(n.isPickable=l.renderer.setmeshpickable),null!=l.renderer.showboundingbox&&(n.showBoundingBox=l.renderer.showboundingbox),null!=l.renderer.defaultellipsoid&&(n.ellipsoid=e.Utilities.ParseVector3(l.renderer.defaultellipsoid)),null!=l.renderer.ellipsoidoffset&&(n.ellipsoidOffset=e.Utilities.ParseVector3(l.renderer.ellipsoidoffset)),null!=l.renderer.rendergroupid&&(n.renderingGroupId=l.renderer.rendergroupid),null!=l.renderer.freezeworldmatrix&&!0===l.renderer.freezeworldmatrix&&null!=a&&a.push(n),null!=l.renderer.snapshotrendering&&l.renderer.snapshotrendering>0&&(e.Utilities.PrepareSkeletonForRendering(n.skeleton),n.alwaysSelectAsActiveMesh=!0);else{var h=e.SceneManager.GetSkinnedMesh(n);if(null!=h)h.isPickable=!0,h.useVertexColors=!1,h.isVisible=s,h.visibility=u,h.billboardMode=c,h.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD,h.alwaysSelectAsActiveMesh=!0,null!=l.renderer.cullingstrategy&&l.renderer.cullingstrategy!==BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD&&(h.cullingStrategy=l.renderer.cullingstrategy),null!=l.renderer.castshadows&&!0===l.renderer.castshadows&&null!=o&&o.push(h),null!=l.renderer.receiveshadows&&!0===l.renderer.receiveshadows&&(h.receiveShadows=!0),null!=l.renderer.checkcollisions&&!0===l.renderer.checkcollisions&&(h.checkCollisions=!0),null!=l.renderer.istriggervolume&&!0===l.renderer.istriggervolume&&(h.collisionResponse=!1),null!=l.renderer.usevertexcolors&&(h.useVertexColors=l.renderer.usevertexcolors),null!=l.renderer.setmeshpickable&&(h.isPickable=l.renderer.setmeshpickable),null!=l.renderer.showboundingbox&&(h.showBoundingBox=l.renderer.showboundingbox),null!=l.renderer.defaultellipsoid&&(h.ellipsoid=e.Utilities.ParseVector3(l.renderer.defaultellipsoid)),null!=l.renderer.ellipsoidoffset&&(h.ellipsoidOffset=e.Utilities.ParseVector3(l.renderer.ellipsoidoffset)),null!=l.renderer.rendergroupid&&(h.renderingGroupId=l.renderer.rendergroupid),null!=l.renderer.freezeworldmatrix&&!0===l.renderer.freezeworldmatrix&&null!=a&&a.push(h),null!=l.renderer.snapshotrendering&&l.renderer.snapshotrendering>0&&e.Utilities.PrepareSkeletonForRendering(h.skeleton);else{var m=e.SceneManager.GetPrimitiveMeshes(n);null!=m&&m.length>0&&m.forEach(function(t){var n=e.SceneManager.GetSkinnedMesh(t);null!=n?(n.isPickable=!0,n.useVertexColors=!1,n.isVisible=s,n.visibility=u,n.billboardMode=c,n.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD,n.alwaysSelectAsActiveMesh=!0,null!=l.renderer.cullingstrategy&&l.renderer.cullingstrategy!==BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD&&(n.cullingStrategy=l.renderer.cullingstrategy),null!=l.renderer.castshadows&&!0===l.renderer.castshadows&&null!=o&&o.push(n),null!=l.renderer.receiveshadows&&!0===l.renderer.receiveshadows&&(n.receiveShadows=!0),null!=l.renderer.checkcollisions&&!0===l.renderer.checkcollisions&&(n.checkCollisions=!0),null!=l.renderer.istriggervolume&&!0===l.renderer.istriggervolume&&(n.collisionResponse=!1),null!=l.renderer.usevertexcolors&&(n.useVertexColors=l.renderer.usevertexcolors),null!=l.renderer.setmeshpickable&&(n.isPickable=l.renderer.setmeshpickable),null!=l.renderer.showboundingbox&&(n.showBoundingBox=l.renderer.showboundingbox),null!=l.renderer.defaultellipsoid&&(n.ellipsoid=e.Utilities.ParseVector3(l.renderer.defaultellipsoid)),null!=l.renderer.ellipsoidoffset&&(n.ellipsoidOffset=e.Utilities.ParseVector3(l.renderer.ellipsoidoffset)),null!=l.renderer.rendergroupid&&(n.renderingGroupId=l.renderer.rendergroupid),null!=l.renderer.freezeworldmatrix&&!0===l.renderer.freezeworldmatrix&&null!=a&&a.push(n),null!=l.renderer.snapshotrendering&&l.renderer.snapshotrendering>0&&e.Utilities.PrepareSkeletonForRendering(n.skeleton)):(t.isPickable=!0,t.useVertexColors=!1,t.isVisible=s,t.visibility=u,t.billboardMode=c,t.cullingStrategy=BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD,null!=l.renderer.cullingstrategy&&l.renderer.cullingstrategy!==BABYLON.AbstractMesh.CULLINGSTRATEGY_STANDARD&&(t.cullingStrategy=l.renderer.cullingstrategy),null!=l.renderer.castshadows&&!0===l.renderer.castshadows&&null!=o&&o.push(t),null!=l.renderer.receiveshadows&&!0===l.renderer.receiveshadows&&(t.receiveShadows=!0),null!=l.renderer.checkcollisions&&!0===l.renderer.checkcollisions&&(t.checkCollisions=!0),null!=l.renderer.istriggervolume&&!0===l.renderer.istriggervolume&&(t.collisionResponse=!1),null!=l.renderer.usevertexcolors&&(t.useVertexColors=l.renderer.usevertexcolors),null!=l.renderer.setmeshpickable&&(t.isPickable=l.renderer.setmeshpickable),null!=l.renderer.showboundingbox&&(t.showBoundingBox=l.renderer.showboundingbox),null!=l.renderer.defaultellipsoid&&(t.ellipsoid=e.Utilities.ParseVector3(l.renderer.defaultellipsoid)),null!=l.renderer.ellipsoidoffset&&(t.ellipsoidOffset=e.Utilities.ParseVector3(l.renderer.ellipsoidoffset)),null!=l.renderer.rendergroupid&&(t.renderingGroupId=l.renderer.rendergroupid),null!=l.renderer.freezeworldmatrix&&!0===l.renderer.freezeworldmatrix&&null!=a&&a.push(t),null!=l.renderer.snapshotrendering&&l.renderer.snapshotrendering>0&&(e.Utilities.PrepareSkeletonForRendering(t.skeleton),t.alwaysSelectAsActiveMesh=!0))})}}if(null!=l.components){var f=l.components;null!=f&&f.length>0&&f.forEach(function(i){if(null!=i)switch(i.alias){case"camera":e.MetadataParser.SetupCameraComponent(t,n,i);break;case"light":e.MetadataParser.SetupLightComponent(t,n,i);break;case"script":null!=r&&r.push({mesh:n,comp:i})}})}}},t.DoProcessPendingScripts=function(t,n,i,o){null!=n&&n.length>0&&(n.sort(function(e,t){return e.comp.order<t.comp.order?-1:e.comp.order>t.comp.order?1:0}),n.forEach(function(n){if(null!=n.comp.klass&&""!==n.comp.klass){if(!0===e.SceneManager.AutoStripNamespacePrefix&&!1===e.SceneManager.UniversalModuleDefinition){var r=n.comp.klass.lastIndexOf(".");-1!==r&&(n.comp.klass=n.comp.klass.substring(r+1))}if("TOOLKIT.ScriptComponent"!==n.comp.klass){var a=n.comp.klass;null==n.comp.properties&&(n.comp.properties={}),n.comp.properties._scriptComponentAlias=a,n.comp.properties._registerComponentAlias=!1;var l=e.Utilities.InstantiateClass(a);if(null!=l){var s=new l(n.mesh,t,n.comp.properties);null!=s?(n.comp.instance=s,null!=o&&o.push(n.comp.instance),n.comp.instance.addPreloaderTasks&&null!=i&&i.push(n.comp.instance),e.SceneManager.AttachScriptComponent(n.comp.instance,a,!1)):BABYLON.Tools.Warn("Failed to instantiate script class: "+a)}else BABYLON.Tools.Warn("Failed to locate script class: "+a)}}}))},t.DoProcessPendingShadows=function(e,t){null!=t&&t.length>0&&null!=e.lights&&e.lights.length>0&&e.lights.forEach(function(e){var n=e.getShadowGenerator();null!=n&&null!=e.metadata&&null!=e.metadata.toolkit&&!0===e.metadata.toolkit.autorender&&t.forEach(function(t){!0==(!(null!=e.includedOnlyMeshes&&e.includedOnlyMeshes.length>0)||e.includedOnlyMeshes.indexOf(t)>=0)&&n.addShadowCaster(t,!1)})})},t.DoProcessPendingPhysics=function(t,n){if(null!=n&&n.length>0){var i=t.isPhysicsEnabled(),o=!0===i?t.getPhysicsEngine():null;!0==(!0===i&&null!=o)?n.forEach(function(n){e.RigidbodyPhysics.SetupPhysicsComponent(t,n)}):BABYLON.Tools.Warn("Physics engine not loaded. Physics impostors will not be created.")}},t.DoProcessPendingFreezes=function(e){null!=e&&e.length>0&&e.forEach(function(e){e.freezeWorldMatrix()})},t.SetupCameraComponent=function(t,n,i){n.checkCollisions=!1;var o=0,r=n.name+".Rig",a=null!=i.culling?i.culling:-1,l=null!=i.camerabase?i.camerabase:0,s=(null!=i.clearflags&&i.clearflags,null!=i.renderlist?i.renderlist:null),u=null!=i.maincamera&&i.maincamera,c=4===l?new BABYLON.FreeCamera(r,BABYLON.Vector3.Zero(),t):new BABYLON.UniversalCamera(r,BABYLON.Vector3.Zero(),t);switch(c.checkCollisions=!1,c.rotationQuaternion=BABYLON.Quaternion.FromEulerAngles(0,0,0),c.parent=n,!0===u&&(t.activeCamera=c),null!=i.type?i.type:0){case 0:c.mode=BABYLON.Camera.PERSPECTIVE_CAMERA,null!=i.perspectiveyfov&&(c.fov=i.perspectiveyfov),null!=i.perspectiveznear&&(c.minZ=i.perspectiveznear),null!=i.perspectivezfar&&(c.maxZ=i.perspectivezfar);break;case 1:c.mode=BABYLON.Camera.ORTHOGRAPHIC_CAMERA,null!=i.orthoxmag&&(c.orthoLeft=-i.orthoxmag,c.orthoRight=i.orthoxmag),null!=i.orthoymag&&(c.orthoBottom=-i.orthoymag,c.orthoTop=i.orthoymag),null!=i.orthoznear&&(c.minZ=i.orthoznear),null!=i.orthozfar&&(c.maxZ=i.orthozfar)}if(-1===a);else if(0===a);else{var d=s;if(null!=d&&d.length>0){var p=function(){var n=d[o],i=e.SceneManager.GetMeshByID(t,n);if(null!=i){var r=i.name+".Detail",a=i.getChildren(function(e){return e.name===r},!0);null!=a&&a.length}};for(o=0;o<d.length;o++)p()}}n.cameraRig=c},t.SetupLightComponent=function(t,n,i){n.checkCollisions=!1;var o,r=n.name+".Rig",a=0,l=1,s=null!=i.culling?i.culling:-1,u=(null!=i.clearflags&&i.clearflags,null!=i.renderlist?i.renderlist:null),c=null!=i.type?i.type:0,d=e.SceneManager.GetRenderQuality(),p=null!=i.exponentdecayspeed?i.exponentdecayspeed:1,h=!1;switch(c){case 0:var m=BABYLON.Vector3.Forward(),f=null!=i.orthoscale?i.orthoscale:.1,g=null!=i.ortholeft?i.ortholeft:Number.MAX_VALUE,y=null!=i.orthoright?i.orthoright:Number.MAX_VALUE,v=null!=i.orthotop?i.orthotop:Number.MAX_VALUE,_=null!=i.orthobottom?i.orthobottom:Number.MAX_VALUE,S=null!=i.calczbounds&&i.calczbounds,B=null!=i.updateextends&&i.updateextends,b=null!=i.shadowfrustumsize?i.shadowfrustumsize:0,C=new BABYLON.DirectionalLight(r,m,t);C.shadowFrustumSize=b,C.shadowOrthoScale=f,C.autoCalcShadowZBounds=S,C.autoUpdateExtends=B,C.orthoLeft=g,C.orthoRight=y,C.orthoTop=v,C.orthoBottom=_,(o=C).falloffType=BABYLON.Light.FALLOFF_STANDARD,h=d===e.RenderQuality.High||d===e.RenderQuality.Medium,l=e.SceneManager.DirectionalLightIntensity;break;case 1:var A=o=new BABYLON.PointLight(r,BABYLON.Vector3.Zero(),t);(o=A).falloffType=BABYLON.Light.FALLOFF_STANDARD,h=d===e.RenderQuality.High||d===e.RenderQuality.Medium,l=e.SceneManager.PointLightIntensity;break;case 2:m=BABYLON.Vector3.Forward();var M=null!=i.spotangle?i.spotangle:Math.PI/4,T=new BABYLON.SpotLight(r,BABYLON.Vector3.Zero(),m,0,p,t);T.angle=.966*BABYLON.Tools.ToRadians(M),T.innerAngle=.8*T.angle,(o=T).falloffType=BABYLON.Light.FALLOFF_GLTF,h=d===e.RenderQuality.High||d===e.RenderQuality.Medium,l=e.SceneManager.SpotLightIntensity}if(null!=o){var O=null!=i.range?i.range:Number.MAX_VALUE,I=null!=i.color?e.Utilities.ParseColor3(i.color,BABYLON.Color3.White()):BABYLON.Color3.White(),L=null!=i.specular?e.Utilities.ParseColor3(i.specular,BABYLON.Color3.White()):BABYLON.Color3.White(),x=null!=i.lightmapmode?i.lightmapmode:0;null!=i.lightmaptype&&i.lightmaptype,o.parent=n,o.range=O,o.diffuse=I,o.specular=L,o.intensity=(null!=i.intensity?i.intensity:1)*l,o.lightmapMode=x>0?BABYLON.Light.LIGHTMAP_DEFAULT:BABYLON.Light.LIGHTMAP_SHADOWSONLY,o.intensityMode=BABYLON.Light.INTENSITYMODE_AUTOMATIC,o.shadowEnabled=!1;var N=null==i.autorender||i.autorender,w=null!=i.softshadows&&i.softshadows,P=null!=i.numcascades?i.numcascades:0,R=null!=i.cascadelambda?i.cascadelambda:1,k=null!=i.setdepthclamp&&i.setdepthclamp,E=null!=i.blendpertecntage?i.blendpertecntage:1e-8,D=null!=i.boundsrefreshrate?i.boundsrefreshrate:1,U=null!=i.lightcontactratio?i.lightcontactratio:.1,F=null!=i.stabilizecascades&&i.stabilizecascades,Y=null!=i.penumbradarkness?i.penumbradarkness:1,V=null!=i.softshadowsfilter?i.softshadowsfilter:99,G=null!=i.freezeshadows&&i.freezeshadows,H=null!=i.calcdepths&&i.calcdepths,z=null!=i.depthscaling?i.depthscaling:50,W=null!=i.blurscaling?i.blurscaling:2,Q=null==i.kernelblur||i.kernelblur,X=null!=i.blurkernelsize?i.blurkernelsize:1,K=null!=i.blurboxoffset?i.blurboxoffset:1,j=null!=i.shadowmapsize?i.shadowmapsize:1024,Z=null!=i.generateshadows&&i.generateshadows,J=null!=i.shadowbiasfactor?i.shadowbiasfactor:.01,q=null!=i.normalbiasfactor?i.normalbiasfactor:.01,$=null!=i.shadowmapbias?i.shadowmapbias:.05,ee=null!=i.normalmapbias?i.normalmapbias:.4,te=null!=i.shadowstrength?i.shadowstrength:1,ne=null!=i.shadowdistance?i.shadowdistance:150,ie=null!=i.shadownearplane?i.shadownearplane:.2,oe=null!=i.shadowfilterquality?i.shadowfilterquality:"Medium",re=null!=i.transparencyshadow&&i.transparencyshadow,ae=null!=i.softtransparency&&i.softtransparency,le=null==i.forcebackfacesonly||i.forcebackfacesonly,se=null!=i.frustumedgefalloff?i.frustumedgefalloff:0,ue=null!=i.usefullfloatfirst&&i.usefullfloatfirst;if(!0===h&&!0===Z){var ce=o,de=e.SceneManager.GetEngine(t),pe=de instanceof BABYLON.Engine?de.webGLVersion:0,he=de instanceof BABYLON.WebGPUEngine?1:0,me=0===c&&P>=2&&(pe>=2||he>=1),fe=!0===me?new BABYLON.CascadedShadowGenerator(j,o,ue):new BABYLON.ShadowGenerator(j,ce,ue);if(fe.bias=$*J,fe.normalBias=ee*q,fe.depthScale=z,fe.useKernelBlur=Q,fe.blurKernel=X,fe.blurScale=W,fe.blurBoxOffset=K,fe.frustumEdgeFalloff=se,fe.forceBackFacesOnly=le,fe.transparencyShadow=re,fe.enableSoftTransparentShadow=ae,fe.contactHardeningLightSizeUVRatio=U,!0===w)if(pe<=1&&he<=0)fe.usePoissonSampling=!0;else if(!0===me)fe.usePercentageCloserFiltering=!0;else switch(V){case 0:default:fe.usePoissonSampling=!0;break;case 1:fe.useExponentialShadowMap=!0;break;case 2:fe.useBlurExponentialShadowMap=!0;break;case 3:fe.useCloseExponentialShadowMap=!0;break;case 4:fe.useBlurCloseExponentialShadowMap=!0;break;case 5:fe.useContactHardeningShadow=!0;break;case 99:fe.usePercentageCloserFiltering=!0}switch(oe){case"High":fe.filteringQuality=BABYLON.ShadowGenerator.QUALITY_HIGH;break;case"Medium":fe.filteringQuality=BABYLON.ShadowGenerator.QUALITY_MEDIUM;break;case"Low":fe.filteringQuality=BABYLON.ShadowGenerator.QUALITY_LOW}if(!0===me){var ge=fe;ge.lambda=R,ge.depthClamp=k,ge.shadowMaxZ=ne,ge.numCascades=P,ge.penumbraDarkness=Y,ge.autoCalcDepthBounds=H,ge.stabilizeCascades=F,ge.cascadeBlendPercentage=E,ge.autoCalcDepthBoundsRefreshRate=D,ge.freezeShadowCastersBoundingInfo=G,ge.setDarkness(1-BABYLON.Scalar.Clamp(te)),ce.shadowEnabled=!0,ge.splitFrustum()}else fe.setDarkness(1-BABYLON.Scalar.Clamp(te)),ce.shadowEnabled=!0,ce.shadowMinZ=ie,ce.shadowMaxZ=ne;null==o.metadata&&(o.metadata={}),null==o.metadata.toolkit&&(o.metadata.toolkit={}),o.metadata.toolkit.autorender=N}var ye=n.name+".Holder";if(-1===s)o.includedOnlyMeshes=[];else if(0===s)o.includedOnlyMeshes=[new BABYLON.Mesh(ye,t)];else{o.includedOnlyMeshes=[new BABYLON.Mesh(ye,t)];var ve=u;if(null!=ve&&ve.length>0){var _e=function(){var n=ve[a],i=e.SceneManager.GetMeshByID(t,n);if(null!=i){var r=i.name+".Detail",l=i.getChildren(function(e){return e.name===r},!0);null!=l&&l.length>0?o.includedOnlyMeshes.push(l[0]):o.includedOnlyMeshes.push(i)}};for(a=0;a<ve.length;a++)_e()}}n.lightRig=o}},t}();e.MetadataParser=t}(i||(i={})),function(e){var t=function(){function t(e){void 0===e&&(e=Recast),this.bjsRECAST={},this.name="TOOLKIT.RecastJSPluginExtension",this.navMeshes=[],this._maximumSubStepCount=10,this._timeStep=1/60,this._timeFactor=1,this._worker=null,"function"==typeof e?BABYLON.Logger.Error("RecastJS is not ready. Please make sure you await Recast() before using the plugin."):this.bjsRECAST=e,this.isSupported()?(this.setTimeStep(),this._tempVec1=new this.bjsRECAST.Vec3,this._tempVec2=new this.bjsRECAST.Vec3):BABYLON.Logger.Error("RecastJS is not available. Please make sure you included the js file.")}return t.prototype.setWorkerURL=function(e){return!(!window||!window.Worker||(this._worker=new Worker(e),0))},t.prototype.setTimeStep=function(e){void 0===e&&(e=1/60),this._timeStep=e},t.prototype.getTimeStep=function(){return this._timeStep},t.prototype.setMaximumSubStepCount=function(e){void 0===e&&(e=10),this._maximumSubStepCount=e},t.prototype.getMaximumSubStepCount=function(){return this._maximumSubStepCount},Object.defineProperty(t.prototype,"timeFactor",{get:function(){return this._timeFactor},set:function(e){this._timeFactor=Math.max(e,0)},enumerable:!1,configurable:!0}),t.prototype.setActiveNavMesh=function(e){return null!=this.navMeshes&&e>=0&&e<this.navMeshes.length&&(this.navMesh=this.navMeshes[e],!0)},t.prototype.getActiveNavMesh=function(){return this.navMesh},t.prototype.getIndexedNavMesh=function(e){var t=null;return null!=this.navMeshes&&e>=0&&e<this.navMeshes.length&&(t=this.navMeshes[e]),t},t.prototype.getNavMeshCount=function(){return null!=this.navMeshes?this.navMeshes.length:0},t.prototype.getNavMeshArray=function(){return this.navMeshes},t.prototype.createNavMesh=function(e,t,n){this._worker&&!n?BABYLON.Logger.Warn("A worker is avaible but no completion callback. Defaulting to blocking navmesh creation"):!this._worker&&n&&BABYLON.Logger.Warn("A completion callback is avaible but no worker. Defaulting to blocking navmesh creation"),this.navMesh=new this.bjsRECAST.NavMesh,null==this.navMeshes&&(this.navMeshes=[]),this.navMeshes.push(this.navMesh);var i,o,r,a=this.navMeshes.length-1,l=[],s=[],u=0;for(i=0;i<e.length;i++)if(e[i]){var c=e[i],d=c.getIndices();if(!d)continue;var p=c.getVerticesData(BABYLON.VertexBuffer.PositionKind,!1,!1);if(!p)continue;var h=[],m=c.computeWorldMatrix(!0);if(c.hasThinInstances)for(var f=c.thinInstanceGetWorldMatrices(),g=0;g<f.length;g++){var y=new BABYLON.Matrix;f[g].multiplyToRef(m,y),h.push(y)}else h.push(m);for(var v=0;v<h.length;v++){var _=h[v];for(o=0;o<d.length;o++)l.push(d[o]+u);var S=BABYLON.Vector3.Zero(),B=BABYLON.Vector3.Zero();for(r=0;r<p.length;r+=3)BABYLON.Vector3.FromArrayToRef(p,r,B),BABYLON.Vector3.TransformCoordinatesToRef(B,_,S),s.push(S.x,S.y,S.z);u+=p.length/3}}if(this._worker&&n)this._worker.postMessage([s,u,l,l.length,t]),this._worker.onmessage=function(e){n(e.data)};else{var b=new this.bjsRECAST.rcConfig;b.cs=t.cs,b.ch=t.ch,b.borderSize=t.borderSize?t.borderSize:0,b.tileSize=t.tileSize?t.tileSize:0,b.walkableSlopeAngle=t.walkableSlopeAngle,b.walkableHeight=t.walkableHeight,b.walkableClimb=t.walkableClimb,b.walkableRadius=t.walkableRadius,b.maxEdgeLen=t.maxEdgeLen,b.maxSimplificationError=t.maxSimplificationError,b.minRegionArea=t.minRegionArea,b.mergeRegionArea=t.mergeRegionArea,b.maxVertsPerPoly=t.maxVertsPerPoly,b.detailSampleDist=t.detailSampleDist,b.detailSampleMaxError=t.detailSampleMaxError,this.navMesh.build(s,u,l,l.length,b)}return a},t.prototype.createDebugNavMesh=function(e){var t,n,i=this.navMesh.getDebugNavMesh(),o=i.getTriangleCount(),r=[],a=[];for(t=0;t<3*o;t++)r.push(t);for(t=0;t<o;t++)for(n=0;n<3;n++){var l=i.getTriangle(t).getPoint(n);a.push(l.x,l.y,l.z)}var s=new BABYLON.Mesh("NavMeshDebug",e),u=new BABYLON.VertexData;return u.indices=r,u.positions=a,u.applyToMesh(s,!1),s},t.prototype.getClosestPoint=function(e){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;var t=this.navMesh.getClosestPoint(this._tempVec1);return new BABYLON.Vector3(t.x,t.y,t.z)},t.prototype.getClosestPointToRef=function(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;var n=this.navMesh.getClosestPoint(this._tempVec1);t.set(n.x,n.y,n.z)},t.prototype.getRandomPointAround=function(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;var n=this.navMesh.getRandomPointAround(this._tempVec1,t);return new BABYLON.Vector3(n.x,n.y,n.z)},t.prototype.getRandomPointAroundToRef=function(e,t,n){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z;var i=this.navMesh.getRandomPointAround(this._tempVec1,t);n.set(i.x,i.y,i.z)},t.prototype.moveAlong=function(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;var n=this.navMesh.moveAlong(this._tempVec1,this._tempVec2);return new BABYLON.Vector3(n.x,n.y,n.z)},t.prototype.moveAlongToRef=function(e,t,n){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;var i=this.navMesh.moveAlong(this._tempVec1,this._tempVec2);n.set(i.x,i.y,i.z)},t.prototype._convertNavPathPoints=function(e){var t,n=e.getPointCount(),i=[];for(t=0;t<n;t++){var o=e.getPoint(t);i.push(new BABYLON.Vector3(o.x,o.y,o.z))}return i},t.prototype.computePath=function(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;var n=this.navMesh.computePath(this._tempVec1,this._tempVec2);return this._convertNavPathPoints(n)},t.prototype.computePathSmooth=function(e,t){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z;var n=this.navMesh.computePathSmooth(this._tempVec1,this._tempVec2);return this._convertNavPathPoints(n)},t.prototype.createCrowd=function(t,n,i){return new e.RecastJSCrowdExtension(this,t,n,i)},t.prototype.setDefaultQueryExtent=function(e){this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this.navMesh.setDefaultQueryExtent(this._tempVec1)},t.prototype.getDefaultQueryExtent=function(){var e=this.navMesh.getDefaultQueryExtent();return new BABYLON.Vector3(e.x,e.y,e.z)},t.prototype.buildFromNavmeshData=function(e){var t=e.length*e.BYTES_PER_ELEMENT,n=this.bjsRECAST._malloc(t),i=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,n,t);i.set(e);var o=new this.bjsRECAST.NavmeshData;o.dataPointer=i.byteOffset,o.size=e.length,this.navMesh=new this.bjsRECAST.NavMesh,null==this.navMeshes&&(this.navMeshes=[]),this.navMeshes.push(this.navMesh);var r=this.navMeshes.length-1;return this.navMesh.buildFromNavmeshData(o),this.bjsRECAST._free(i.byteOffset),r},t.prototype.getNavmeshData=function(){var e=this.navMesh.getNavmeshData(),t=new Uint8Array(this.bjsRECAST.HEAPU8.buffer,e.dataPointer,e.size),n=new Uint8Array(e.size);return n.set(t),this.navMesh.freeNavmeshData(e),n},t.prototype.getDefaultQueryExtentToRef=function(e){var t=this.navMesh.getDefaultQueryExtent();e.set(t.x,t.y,t.z)},t.prototype.dispose=function(){},t.prototype.addCylinderObstacle=function(e,t,n){return this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this.navMesh.addCylinderObstacle(this._tempVec1,t,n)},t.prototype.addBoxObstacle=function(e,t,n){return this._tempVec1.x=e.x,this._tempVec1.y=e.y,this._tempVec1.z=e.z,this._tempVec2.x=t.x,this._tempVec2.y=t.y,this._tempVec2.z=t.z,this.navMesh.addBoxObstacle(this._tempVec1,this._tempVec2,n)},t.prototype.removeObstacle=function(e){this.navMesh.removeObstacle(e)},t.prototype.isSupported=function(){return void 0!==this.bjsRECAST},t.prototype.getRandomSeed=function(){return this.bjsRECAST._getRandomSeed()},t.prototype.setRandomSeed=function(e){this.bjsRECAST._setRandomSeed(e)},t}();e.RecastJSPluginExtension=t;var n=function(){function e(e,t,n,i){var o=this;this.recastCrowd={},this.transforms=new Array,this.agents=new Array,this.reachRadii=new Array,this._agentDestinationArmed=new Array,this._agentDestination=new Array,this._onBeforeAnimationsObserver=null,this.onReachTargetObservable=new BABYLON.Observable,this.bjsRECASTPlugin=e,this.recastCrowd=new this.bjsRECASTPlugin.bjsRECAST.Crowd(t,n,this.bjsRECASTPlugin.navMesh.getNavMesh()),this._scene=i,this._onBeforeAnimationsObserver=i.onBeforeAnimationsObservable.add(function(){o.update(.001*i.getEngine().getDeltaTime()*e.timeFactor)})}return e.prototype.addAgent=function(e,t,n){var i=new this.bjsRECASTPlugin.bjsRECAST.dtCrowdAgentParams;i.radius=t.radius,i.height=t.height,i.maxAcceleration=t.maxAcceleration,i.maxSpeed=t.maxSpeed,i.collisionQueryRange=t.collisionQueryRange,i.pathOptimizationRange=t.pathOptimizationRange,i.separationWeight=t.separationWeight,i.updateFlags=7,i.obstacleAvoidanceType=0,i.queryFilterType=0,i.userData=0;var o=this.recastCrowd.addAgent(new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z),i);return this.transforms.push(n),this.agents.push(o),this.reachRadii.push(t.reachRadius?t.reachRadius:t.radius),this._agentDestinationArmed.push(!1),this._agentDestination.push(new BABYLON.Vector3(0,0,0)),o},e.prototype.getAgentPosition=function(e){var t=this.recastCrowd.getAgentPosition(e);return new BABYLON.Vector3(t.x,t.y,t.z)},e.prototype.getAgentPositionToRef=function(e,t){var n=this.recastCrowd.getAgentPosition(e);t.set(n.x,n.y,n.z)},e.prototype.getAgentVelocity=function(e){var t=this.recastCrowd.getAgentVelocity(e);return new BABYLON.Vector3(t.x,t.y,t.z)},e.prototype.getAgentVelocityToRef=function(e,t){var n=this.recastCrowd.getAgentVelocity(e);t.set(n.x,n.y,n.z)},e.prototype.getAgentNextTargetPath=function(e){var t=this.recastCrowd.getAgentNextTargetPath(e);return new BABYLON.Vector3(t.x,t.y,t.z)},e.prototype.getAgentNextTargetPathToRef=function(e,t){var n=this.recastCrowd.getAgentNextTargetPath(e);t.set(n.x,n.y,n.z)},e.prototype.getAgentState=function(e){return this.recastCrowd.getAgentState(e)},e.prototype.overOffmeshConnection=function(e){return this.recastCrowd.overOffmeshConnection(e)},e.prototype.agentGoto=function(e,t){this.recastCrowd.agentGoto(e,new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z));var n=this.agents.indexOf(e);n>-1&&(this._agentDestinationArmed[n]=!0,this._agentDestination[n].set(t.x,t.y,t.z))},e.prototype.agentTeleport=function(e,t){this.recastCrowd.agentTeleport(e,new this.bjsRECASTPlugin.bjsRECAST.Vec3(t.x,t.y,t.z))},e.prototype.updateAgentParameters=function(e,t){var n=this.recastCrowd.getAgentParameters(e);void 0!==t.radius&&(n.radius=t.radius),void 0!==t.height&&(n.height=t.height),void 0!==t.maxAcceleration&&(n.maxAcceleration=t.maxAcceleration),void 0!==t.maxSpeed&&(n.maxSpeed=t.maxSpeed),void 0!==t.collisionQueryRange&&(n.collisionQueryRange=t.collisionQueryRange),void 0!==t.pathOptimizationRange&&(n.pathOptimizationRange=t.pathOptimizationRange),void 0!==t.separationWeight&&(n.separationWeight=t.separationWeight),this.recastCrowd.setAgentParameters(e,n)},e.prototype.removeAgent=function(e){this.recastCrowd.removeAgent(e);var t=this.agents.indexOf(e);t>-1&&(this.agents.splice(t,1),this.transforms.splice(t,1),this.reachRadii.splice(t,1),this._agentDestinationArmed.splice(t,1),this._agentDestination.splice(t,1))},e.prototype.getAgents=function(){return this.agents},e.prototype.update=function(e){if(this.bjsRECASTPlugin.navMesh.update(),!(e<=BABYLON.Epsilon)){var t=this.bjsRECASTPlugin.getTimeStep(),n=this.bjsRECASTPlugin.getMaximumSubStepCount();if(t<=BABYLON.Epsilon)this.recastCrowd.update(e);else{var i=Math.floor(e/t);n&&i>n&&(i=n),i<1&&(i=1);for(var o=e/i,r=0;r<i;r++)this.recastCrowd.update(o)}for(var a=0;a<this.agents.length;a++){var l=this.agents[a],s=this.getAgentPosition(l);if(this.transforms[a].position=s,this._agentDestinationArmed[a]){var u=s.x-this._agentDestination[a].x,c=s.z-this._agentDestination[a].z,d=this.reachRadii[a],p=this._agentDestination[a].y-this.reachRadii[a],h=this._agentDestination[a].y+this.reachRadii[a],m=u*u+c*c;s.y>p&&s.y<h&&m<d*d&&(this._agentDestinationArmed[a]=!1,this.onReachTargetObservable.notifyObservers({agentIndex:l,destination:this._agentDestination[a]}))}}}},e.prototype.setDefaultQueryExtent=function(e){var t=new this.bjsRECASTPlugin.bjsRECAST.Vec3(e.x,e.y,e.z);this.recastCrowd.setDefaultQueryExtent(t)},e.prototype.getDefaultQueryExtent=function(){var e=this.recastCrowd.getDefaultQueryExtent();return new BABYLON.Vector3(e.x,e.y,e.z)},e.prototype.getDefaultQueryExtentToRef=function(e){var t=this.recastCrowd.getDefaultQueryExtent();e.set(t.x,t.y,t.z)},e.prototype.getCorners=function(e){var t,n=this.recastCrowd.getCorners(e),i=n.getPointCount(),o=[];for(t=0;t<i;t++){var r=n.getPoint(t);o.push(new BABYLON.Vector3(r.x,r.y,r.z))}return o},e.prototype.dispose=function(){this.recastCrowd.destroy(),this._scene.onBeforeAnimationsObservable.remove(this._onBeforeAnimationsObserver),this._onBeforeAnimationsObserver=null,this.onReachTargetObservable.clear()},e}();e.RecastJSCrowdExtension=n}(i||(i={})),function(e){var t=function(){function e(){}return e.fastFloor=function(e){return 0|Math.floor(e)},e.createNoise2D=function(t){void 0===t&&(t=Math.random);var n=e.buildPermutationTable(t),i=new Float64Array(n).map(function(t){return e.grad2[t%12*2]}),o=new Float64Array(n).map(function(t){return e.grad2[t%12*2+1]});return function(t,r){var a,l,s=0,u=0,c=0,d=(t+r)*e.F2,p=e.fastFloor(t+d),h=e.fastFloor(r+d),m=(p+h)*e.G2,f=t-(p-m),g=r-(h-m);f>g?(a=1,l=0):(a=0,l=1);var y=f-a+e.G2,v=g-l+e.G2,_=f-1+2*e.G2,S=g-1+2*e.G2,B=255&p,b=255&h,C=.5-f*f-g*g;if(C>=0){var A=B+n[b];s=(C*=C)*C*(i[A]*f+o[A]*g)}var M=.5-y*y-v*v;if(M>=0){var T=B+a+n[b+l];u=(M*=M)*M*(i[T]*y+o[T]*v)}var O=.5-_*_-S*S;if(O>=0){var I=B+1+n[b+1];c=(O*=O)*O*(i[I]*_+o[I]*S)}return 70*(s+u+c)}},e.createNoise3D=function(t){void 0===t&&(t=Math.random);var n=e.buildPermutationTable(t),i=new Float64Array(n).map(function(t){return e.grad3[t%12*3]}),o=new Float64Array(n).map(function(t){return e.grad3[t%12*3+1]}),r=new Float64Array(n).map(function(t){return e.grad3[t%12*3+2]});return function(t,a,l){var s,u,c,d,p,h,m,f,g,y,v=(t+a+l)*e.F3,_=e.fastFloor(t+v),S=e.fastFloor(a+v),B=e.fastFloor(l+v),b=(_+S+B)*e.G3,C=t-(_-b),A=a-(S-b),M=l-(B-b);C>=A?A>=M?(p=1,h=0,m=0,f=1,g=1,y=0):C>=M?(p=1,h=0,m=0,f=1,g=0,y=1):(p=0,h=0,m=1,f=1,g=0,y=1):A<M?(p=0,h=0,m=1,f=0,g=1,y=1):C<M?(p=0,h=1,m=0,f=0,g=1,y=1):(p=0,h=1,m=0,f=1,g=1,y=0);var T=C-p+e.G3,O=A-h+e.G3,I=M-m+e.G3,L=C-f+2*e.G3,x=A-g+2*e.G3,N=M-y+2*e.G3,w=C-1+3*e.G3,P=A-1+3*e.G3,R=M-1+3*e.G3,k=255&_,E=255&S,D=255&B,U=.6-C*C-A*A-M*M;if(U<0)s=0;else{var F=k+n[E+n[D]];s=(U*=U)*U*(i[F]*C+o[F]*A+r[F]*M)}var Y=.6-T*T-O*O-I*I;if(Y<0)u=0;else{var V=k+p+n[E+h+n[D+m]];u=(Y*=Y)*Y*(i[V]*T+o[V]*O+r[V]*I)}var G=.6-L*L-x*x-N*N;if(G<0)c=0;else{var H=k+f+n[E+g+n[D+y]];c=(G*=G)*G*(i[H]*L+o[H]*x+r[H]*N)}var z=.6-w*w-P*P-R*R;if(z<0)d=0;else{var W=k+1+n[E+1+n[D+1]];d=(z*=z)*z*(i[W]*w+o[W]*P+r[W]*R)}return 32*(s+u+c+d)}},e.createNoise4D=function(t){void 0===t&&(t=Math.random);var n=e.buildPermutationTable(t),i=new Float64Array(n).map(function(t){return e.grad4[t%32*4]}),o=new Float64Array(n).map(function(t){return e.grad4[t%32*4+1]}),r=new Float64Array(n).map(function(t){return e.grad4[t%32*4+2]}),a=new Float64Array(n).map(function(t){return e.grad4[t%32*4+3]});return function(t,l,s,u){var c,d,p,h,m,f=(t+l+s+u)*e.F4,g=e.fastFloor(t+f),y=e.fastFloor(l+f),v=e.fastFloor(s+f),_=e.fastFloor(u+f),S=(g+y+v+_)*e.G4,B=t-(g-S),b=l-(y-S),C=s-(v-S),A=u-(_-S),M=0,T=0,O=0,I=0;B>b?M++:T++,B>C?M++:O++,B>A?M++:I++,b>C?T++:O++,b>A?T++:I++,C>A?O++:I++;var L=M>=3?1:0,x=T>=3?1:0,N=O>=3?1:0,w=I>=3?1:0,P=M>=2?1:0,R=T>=2?1:0,k=O>=2?1:0,E=I>=2?1:0,D=M>=1?1:0,U=T>=1?1:0,F=O>=1?1:0,Y=I>=1?1:0,V=B-L+e.G4,G=b-x+e.G4,H=C-N+e.G4,z=A-w+e.G4,W=B-P+2*e.G4,Q=b-R+2*e.G4,X=C-k+2*e.G4,K=A-E+2*e.G4,j=B-D+3*e.G4,Z=b-U+3*e.G4,J=C-F+3*e.G4,q=A-Y+3*e.G4,$=B-1+4*e.G4,ee=b-1+4*e.G4,te=C-1+4*e.G4,ne=A-1+4*e.G4,ie=255&g,oe=255&y,re=255&v,ae=255&_,le=.6-B*B-b*b-C*C-A*A;if(le<0)c=0;else{var se=ie+n[oe+n[re+n[ae]]];c=(le*=le)*le*(i[se]*B+o[se]*b+r[se]*C+a[se]*A)}var ue=.6-V*V-G*G-H*H-z*z;if(ue<0)d=0;else{var ce=ie+L+n[oe+x+n[re+N+n[ae+w]]];d=(ue*=ue)*ue*(i[ce]*V+o[ce]*G+r[ce]*H+a[ce]*z)}var de=.6-W*W-Q*Q-X*X-K*K;if(de<0)p=0;else{var pe=ie+P+n[oe+R+n[re+k+n[ae+E]]];p=(de*=de)*de*(i[pe]*W+o[pe]*Q+r[pe]*X+a[pe]*K)}var he=.6-j*j-Z*Z-J*J-q*q;if(he<0)h=0;else{var me=ie+D+n[oe+U+n[re+F+n[ae+Y]]];h=(he*=he)*he*(i[me]*j+o[me]*Z+r[me]*J+a[me]*q)}var fe=.6-$*$-ee*ee-te*te-ne*ne;if(fe<0)m=0;else{var ge=ie+1+n[oe+1+n[re+1+n[ae+1]]];m=(fe*=fe)*fe*(i[ge]*$+o[ge]*ee+r[ge]*te+a[ge]*ne)}return 27*(c+d+p+h+m)}},e.buildPermutationTable=function(e){for(var t=new Uint8Array(512),n=0;n<256;n++)t[n]=n;for(n=0;n<255;n++){var i=n+~~(e()*(256-n)),o=t[n];t[n]=t[i],t[i]=o}for(n=256;n<512;n++)t[n]=t[n-256];return t},e.F2=.5*(Math.sqrt(3)-1),e.G2=(3-Math.sqrt(3))/6,e.F3=1/3,e.G3=1/6,e.F4=(Math.sqrt(5)-1)/4,e.G4=(5-Math.sqrt(5))/20,e.grad2=new Float64Array([1,1,-1,1,1,-1,-1,-1,1,0,-1,0,1,0,-1,0,0,1,0,-1,0,1,0,-1]),e.grad3=new Float64Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),e.grad4=new Float64Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),e}();e.SimplexNoise=t}(i||(i={})),function(e){var t=function(){function t(){}return t.ZeroPad=function(e,t){var n=t-e.toString().length+1;return Array(+(n>0&&n)).join("0")+e},t.ShiftArray=function(e,t){return t?e.unshift(e.pop()):e.push(e.shift()),e},t.GetLayerMask=function(e){return 1<<e},t.IsLayerMasked=function(e,t){return!!(e&1<<t)},t.GetHavokPlugin=function(){return globalThis.HKP},t.GetLoadingState=function(){return e.Utilities.LoadingState},t.GetRandomRange=function(e,t,n,i){void 0===n&&(n=null),void 0===i&&(i=null);var o=BABYLON.Scalar.RandomRange(e,t);if(null!=n){var r=null!=i?i:100;if(o===n)for(var a=0;a<r&&(o=BABYLON.Scalar.RandomRange(e,t))===n;a++);}return o},t.GetRandomFloat=function(t,n,i,o){return void 0===i&&(i=null),void 0===o&&(o=null),parseFloat(e.Utilities.GetRandomRange(t,n,i,o).toFixed(2))},t.GetRandomInteger=function(t,n,i,o){return void 0===i&&(i=null),void 0===o&&(o=null),parseInt(e.Utilities.GetRandomRange(t,n,i,o).toFixed(0))},t.Approximately=function(t,n){return Math.abs(n-t)<Math.max(e.System.Epsilon*Math.max(Math.abs(t),Math.abs(n)),8*e.System.SingleEpsilon)},t.GetVertexDataFromMesh=function(e){var t=e.computeWorldMatrix(!0),n=BABYLON.VertexData.ExtractFromMesh(e,!0,!0);return n.transform(t),n},t.CalculateDestinationPoint=function(t,n,i){var o=new BABYLON.Vector3(0,0,0);return e.Utilities.CalculateDestinationPointToRef(t,n,i,o),o},t.CalculateDestinationPointToRef=function(t,n,i,o){null==e.Utilities.TempDirectionBuffer&&(e.Utilities.TempDirectionBuffer=new BABYLON.Vector3(0,0,0)),e.Utilities.TempDirectionBuffer.set(0,0,0),n.scaleToRef(i,e.Utilities.TempDirectionBuffer),t.addToRef(e.Utilities.TempDirectionBuffer,o)},t.UpdateAbstractMeshMaterial=function(e,t,n){if(null!=e)if(!1==e instanceof BABYLON.InstancedMesh){var i=e.material;if(i instanceof BABYLON.MultiMaterial){var o=i.clone(i.name+".Clone");o.subMaterials[n]=t,e.material=o}else e.material=t}else console.warn("Instanced mesh not supported as a node material on mesh: "+e.name);else console.warn("Null source mesh for mesh: "+e.name)},t.HermiteVector3=function(t,n,i,o,r){var a=new BABYLON.Vector3(0,0,0);return e.Utilities.HermiteVector3ToRef(t,n,i,o,r,a),a},t.HermiteVector3ToRef=function(e,t,n,i,o,r){var a=o*o,l=o*a,s=2*l-3*a+1,u=-2*l+3*a,c=l-2*a+o,d=l-a,p=e._x*s+n._x*u+t._x*c+i._x*d,h=e._y*s+n._y*u+t._y*c+i._y*d,m=e._z*s+n._z*u+t._z*c+i._z*d;r.set(p,h,m)},t.LerpLog=function(e,t,n){var i=Math.min(Math.max(n,0),1);return e+(t-e)*Math.sin(i*Math.PI*.5)},t.LerpExp=function(e,t,n){var i=Math.min(Math.max(n,0),1);return e+(t-e)*(1-Math.cos(i*Math.PI*.5))},t.LerpUnclamped=function(e,t,n){return e+(t-e)*n},t.LerpUnclampedColor3=function(t,n,i){var o=new BABYLON.Color3(0,0,0);return e.Utilities.LerpUnclampedColor3ToRef(t,n,i,o),o},t.LerpUnclampedColor3ToRef=function(e,t,n,i){i.set(e.r+(t.r-e.r)*n,e.g+(t.g-e.g)*n,e.b+(t.b-e.b)*n)},t.LerpUnclampedColor4=function(t,n,i){var o=new BABYLON.Color4(0,0,0,1);return e.Utilities.LerpUnclampedColor4ToRef(t,n,i,o),o},t.LerpUnclampedColor4ToRef=function(e,t,n,i){i.set(e.r+(t.r-e.r)*n,e.g+(t.g-e.g)*n,e.b+(t.b-e.b)*n,e.a+(t.a-e.a)*n)},t.LerpUnclampedVector2=function(t,n,i){var o=new BABYLON.Vector2(0,0);return e.Utilities.LerpUnclampedVector2ToRef(t,n,i,o),o},t.LerpUnclampedVector2ToRef=function(e,t,n,i){i.set(e.x+(t.x-e.x)*n,e.y+(t.y-e.y)*n)},t.LerpUnclampedVector3=function(t,n,i){var o=new BABYLON.Vector3(0,0,0);return e.Utilities.LerpUnclampedVector3ToRef(t,n,i,o),o},t.LerpUnclampedVector3ToRef=function(e,t,n,i){i.set(e.x+(t.x-e.x)*n,e.y+(t.y-e.y)*n,e.z+(t.z-e.z)*n)},t.LerpUnclampedVector4=function(t,n,i){var o=new BABYLON.Vector4(0,0,0,0);return e.Utilities.LerpUnclampedVector4ToRef(t,n,i,o),o},t.LerpUnclampedVector4ToRef=function(e,t,n,i){i.set(e.x+(t.x-e.x)*n,e.y+(t.y-e.y)*n,e.z+(t.z-e.z)*n,e.w+(t.w-e.w)*n)},t.IsEqualUsingDot=function(t){return t>1-e.System.Epsilon},t.QuaternionAngle=function(t,n){var i=Math.min(Math.abs(BABYLON.Quaternion.Dot(t,n)),1);return e.Utilities.IsEqualUsingDot(i)?0:2*Math.acos(i)*e.System.Rad2Deg},t.QuaternionLengthSquared=function(e){return e.x*e.x+e.y*e.y+e.z*e.z+e.w*e.w},t.QuaternionRotateTowards=function(t,n,i){var o=new BABYLON.Quaternion(0,0,0,1);return e.Utilities.QuaternionRotateTowardsToRef(t,n,i,o),o},t.QuaternionRotateTowardsToRef=function(t,n,i,o){var r=e.Utilities.QuaternionAngle(t,n);0==r?o.copyFrom(n):e.Utilities.QuaternionSlerpUnclampedToRef(t,n,Math.min(1,i/r),o)},t.QuaternionSlerpUnclamped=function(t,n,i){var o=new BABYLON.Quaternion(0,0,0,1);return e.Utilities.QuaternionSlerpUnclampedToRef(t,n,i,o),o},t.QuaternionSlerpUnclampedToRef=function(e,t,n,i){},t.MoveTowardsVector2=function(t,n,i){var o=new BABYLON.Vector2(0,0);return e.Utilities.MoveTowardsVector2ToRef(t,n,i,o),o},t.MoveTowardsVector2ToRef=function(e,t,n,i){var o=t.x-e.x,r=t.y-e.y,a=o*o+r*r;if(0==a||n>=0&&a<=n*n)i.set(t.x,t.y);else{var l=Math.sqrt(a);i.set(e.x+o/l*n,e.y+r/l*n)}},t.MoveTowardsVector3=function(t,n,i){var o=new BABYLON.Vector3(0,0,0);return e.Utilities.MoveTowardsVector3ToRef(t,n,i,o),o},t.MoveTowardsVector3ToRef=function(e,t,n,i){var o=t.x-e.x,r=t.y-e.y,a=t.z-e.z,l=o*o+r*r+a*a;if(0==l||n>=0&&l<=n*n)i.set(t.x,t.y,t.z);else{var s=Math.sqrt(l);i.set(e.x+o/s*n,e.y+r/s*n,e.z+a/s*n)}},t.MoveTowardsVector4=function(t,n,i){var o=new BABYLON.Vector4(0,0,0,0);return e.Utilities.MoveTowardsVector4ToRef(t,n,i,o),o},t.MoveTowardsVector4ToRef=function(e,t,n,i){var o=t.x-e.x,r=t.y-e.y,a=t.z-e.z,l=t.w-e.w,s=o*o+r*r+a*a+l*l;if(0==s||n>=0&&s<=n*n)i.set(t.x,t.y,t.z,t.w);else{var u=Math.sqrt(s);i.set(e.x+o/u*n,e.y+r/u*n,e.z+a/u*n,e.w+l/u*n)}},t.ClampMagnitudeVector2=function(t,n){var i=new BABYLON.Vector2(0,0);return e.Utilities.ClampMagnitudeVector2ToRef(t,n,i),i},t.ClampMagnitudeVector2ToRef=function(e,t,n){var i=e.lengthSquared();if(i>t*t){var o=Math.sqrt(i),r=e.x/o,a=e.y/o;n.set(r*t,a*t)}},t.ClampMagnitudeVector3=function(t,n){var i=new BABYLON.Vector3(0,0,0);return e.Utilities.ClampMagnitudeVector3ToRef(t,n,i),i},t.ClampMagnitudeVector3ToRef=function(e,t,n){var i=e.lengthSquared();if(i>t*t){var o=Math.sqrt(i),r=e.x/o,a=e.y/o,l=e.z/o;n.set(r*t,a*t,l*t)}},t.GetAngle=function(t,n){return e.Utilities.GetAngleRadians(t,n)*e.System.Rad2Deg},t.GetAngleRadians=function(e,t){return Math.acos(BABYLON.Vector3.Dot(e,t))},t.ClampAngle=function(e,t,n){var i=e;do{i<-360&&(i+=360),i>360&&(i-=360)}while(i<-360||i>360);return BABYLON.Scalar.Clamp(i,t,n)},t.ClampAngle180=function(e,t,n){return e>180&&(e-=360),(e=BABYLON.Scalar.Clamp(e,t,n))<0&&(e+=360),e},t.ClampAngle360=function(e,t,n){return(e<90||e>270)&&(e>180&&(e-=360),n>180&&(n-=360),t>180&&(t-=360)),(e=BABYLON.Scalar.Clamp(e,t,n))<0&&(e+=360),e},t.SmoothDamp=function(e,t,n,i,o,r){if(!r)return 0;var a=e-t,l=Math.max(1e-4,n),s=2/l,u=s*o,c=1/(1+u+.48*u*u+.235*u*u*u),d=t,p=i*l,h=e-(a=BABYLON.Scalar.Clamp(a,-p,p)),m=(r.x+s*a)*o;r.x=(r.x-s*m)*c;var f=h+(a+m)*c;return d-e>0==f>d&&(f=d,r.x=(f-d)/o),f},t.SmoothDampAngle=function(t,n,i,o,r,a){var l=t+BABYLON.Scalar.DeltaAngle(t,n);return e.Utilities.SmoothDamp(t,l,i,o,r,a)},t.SmoothDampVector2=function(t,n,i,o,r,a){var l=new BABYLON.Vector2(0,0);return e.Utilities.SmoothDampVector2ToRef(t,n,i,o,r,a,l),l},t.SmoothDampVector2ToRef=function(e,t,n,i,o,r,a){var l=2/(n=Math.max(1e-4,n)),s=l*o,u=1/(1+s+.48*s*s+.235*s*s*s),c=e.x-t.x,d=e.y-t.y,p=t.clone(),h=i*n,m=c*c+d*d;if(m>h*h){var f=Math.sqrt(m);c=c/f*h,d=d/f*h}t.x=e.x-c,t.y=e.y-d;var g=(r.x+l*c)*o,y=(r.y+l*d)*o;r.x=(r.x-l*g)*u,r.y=(r.y-l*y)*u;var v=t.x+(c+g)*u,_=t.y+(d+y)*u,S=p.x-e.x,B=p.y-e.y;S*(v-p.x)+B*(_-p.y)>0&&(v=p.x,_=p.y,r.x=(v-p.x)/o,r.y=(_-p.y)/o),a.set(v,_)},t.SmoothDampVector3=function(t,n,i,o,r,a){var l=new BABYLON.Vector3(0,0,0);return e.Utilities.SmoothDampVector3ToRef(t,n,i,o,r,a,l),l},t.SmoothDampVector3ToRef=function(e,t,n,i,o,r,a){var l=0,s=0,u=0,c=2/(n=Math.max(1e-4,n)),d=c*o,p=1/(1+d+.48*d*d+.235*d*d*d),h=e.x-t.x,m=e.y-t.y,f=e.z-t.z,g=t.clone(),y=i*n,v=h*h+m*m+f*f;if(v>y*y){var _=Math.sqrt(v);h=h/_*y,m=m/_*y,f=f/_*y}t.x=e.x-h,t.y=e.y-m,t.z=e.z-f;var S=(r.x+c*h)*o,B=(r.y+c*m)*o,b=(r.z+c*f)*o;r.x=(r.x-c*S)*p,r.y=(r.y-c*B)*p,r.z=(r.z-c*b)*p,l=t.x+(h+S)*p,s=t.y+(m+B)*p,u=t.z+(f+b)*p;var C=g.x-e.x,A=g.y-e.y,M=g.z-e.z;C*(l-g.x)+A*(s-g.y)+M*(u-g.z)>0&&(l=g.x,s=g.y,u=g.z,r.x=(l-g.x)/o,r.y=(s-g.y)/o,r.z=(u-g.z)/o),a.set(l,s,u)},t.ToMatrix=function(e,t,n){return BABYLON.Matrix.RotationYawPitchRoll(BABYLON.Tools.ToRadians(t),BABYLON.Tools.ToRadians(e),BABYLON.Tools.ToRadians(n))},t.ToMatrixToRef=function(e,t,n,i){BABYLON.Matrix.RotationYawPitchRollToRef(BABYLON.Tools.ToRadians(t),BABYLON.Tools.ToRadians(e),BABYLON.Tools.ToRadians(n),i)},t.FastMatrixLerp=function(e,t,n,i){BABYLON.Matrix.LerpToRef(e,t,n,i)},t.FastMatrixSlerp=function(e,t,n,i){BABYLON.Matrix.DecomposeLerpToRef(e,t,n,i)},t.ToEuler=function(e){var t=e.toEulerAngles();return t.x=BABYLON.Tools.ToDegrees(t.x),t.y=BABYLON.Tools.ToDegrees(t.y),t.z=BABYLON.Tools.ToDegrees(t.z),t},t.ToEulerToRef=function(e,t){e.toEulerAnglesToRef(t),t.x=BABYLON.Tools.ToDegrees(t.x),t.y=BABYLON.Tools.ToDegrees(t.y),t.z=BABYLON.Tools.ToDegrees(t.z)},t.FromEuler=function(e,t,n){return BABYLON.Quaternion.FromEulerAngles(BABYLON.Tools.ToRadians(e),BABYLON.Tools.ToRadians(t),BABYLON.Tools.ToRadians(n))},t.FromEulerToRef=function(e,t,n,i){BABYLON.Quaternion.FromEulerAnglesToRef(BABYLON.Tools.ToRadians(e),BABYLON.Tools.ToRadians(t),BABYLON.Tools.ToRadians(n),i)},t.QuaternionDiff=function(t,n){var i=new BABYLON.Quaternion(0,0,0,1);return e.Utilities.QuaternionDiffToRef(t,n,i),i},t.QuaternionDiffToRef=function(t,n,i){BABYLON.Quaternion.InverseToRef(n,e.Utilities.TempQuaternion),e.Utilities.TempQuaternion.multiplyToRef(t,i)},t.QuaternionSubtractToRef=function(e,t,n){n.set(e._x-t._x,e._y-t._y,e._z-t._z,e._w-t._w)},t.RotateVector=function(e,t){var n=2*(t.y*e.z-t.z*e.y),i=2*(t.z*e.x-t.x*e.z),o=2*(t.x*e.y-t.y*e.x);return new BABYLON.Vector3(e.x+t.w*n+(t.y*o-t.z*i),e.y+t.w*i+(t.z*n-t.x*o),e.z+t.w*o+(t.x*i-t.y*n))},t.RotateVectorToRef=function(e,t,n){var i=2*(t.y*e.z-t.z*e.y),o=2*(t.z*e.x-t.x*e.z),r=2*(t.x*e.y-t.y*e.x);n.x=e.x+t.w*i+(t.y*r-t.z*o),n.y=e.y+t.w*o+(t.z*i-t.x*r),n.z=e.z+t.w*r+(t.x*o-t.y*i)},t.LookRotation=function(t){var n=BABYLON.Quaternion.Zero();return e.Utilities.LookRotationToRef(t,n),n},t.LookRotationToRef=function(e,t){BABYLON.Quaternion.FromLookDirectionRHToRef(e,BABYLON.Vector3.Up(),t)},t.Vector3Rad2Deg=function(t){var n=BABYLON.Vector3.Zero();return e.Utilities.Vector3Rad2DegToRef(t,n),n},t.Vector3Rad2DegToRef=function(e,t){t.x=BABYLON.Tools.ToDegrees(e.x),t.y=BABYLON.Tools.ToDegrees(e.y),t.z=BABYLON.Tools.ToDegrees(e.z)},t.MultiplyQuaternionByVector=function(t,n){var i=new BABYLON.Vector3(0,0,0);return e.Utilities.MultiplyQuaternionByVectorToRef(t,n,i),i},t.MultiplyQuaternionByVectorToRef=function(e,t,n){var i=2*e.x,o=2*e.y,r=2*e.z,a=e.x*i,l=e.y*o,s=e.z*r,u=e.x*o,c=e.x*r,d=e.y*r,p=e.w*i,h=e.w*o,m=e.w*r;n.x=(1-(l+s))*t.x+(u-m)*t.y+(c+h)*t.z,n.y=(u+m)*t.x+(1-(a+s))*t.y+(d-p)*t.z,n.z=(c-h)*t.x+(d+p)*t.y+(1-(a+l))*t.z},t.ValidateTransformRotation=function(e){null!=e.rotationQuaternion&&(e.rotation=e.rotationQuaternion.toEulerAngles(),e.rotationQuaternion=null)},t.ValidateTransformQuaternion=function(e){null==e.rotationQuaternion&&null!=e.rotation&&(e.rotationQuaternion=BABYLON.Quaternion.FromEulerAngles(e.rotation.x,e.rotation.y,e.rotation.z),e.rotation.set(0,0,0))},t.GetKeyboardInputValue=function(t,n,i){var o=i;return!0===e.UserInputOptions.KeyboardSmoothing&&(o=BABYLON.Scalar.MoveTowards(n,i,e.UserInputOptions.KeyboardMoveSensibility*e.SceneManager.GetDeltaSeconds(t)),Math.abs(o)<e.UserInputOptions.KeyboardMoveDeadZone&&(o=0)),o},t.GenerateRandonNumber=function(e,t,n){void 0===n&&(n=2);var i=(Math.random()*(t-e)+e).toFixed(n);return parseFloat(i)},t.ProjectVector=function(t,n){var i=new BABYLON.Vector3(0,0,0);return e.Utilities.ProjectVectorToRef(t,n,i),i},t.ProjectVectorToRef=function(t,n,i){var o=BABYLON.Vector3.Dot(n,n);if(o<e.System.Epsilon)i.set(0,0,0);else{var r=BABYLON.Vector3.Dot(t,n);i.set(n.x*r/o,n.y*r/o,n.z*r/o)}},t.ProjectVectorOnPlane=function(t,n){var i=new BABYLON.Vector3(0,0,0);return e.Utilities.ProjectVectorOnPlaneToRef(t,n,i),i},t.ProjectVectorOnPlaneToRef=function(t,n,i){var o=BABYLON.Vector3.Dot(n,n);if(o<e.System.Epsilon)i.copyFrom(t);else{var r=BABYLON.Vector3.Dot(t,n);i.set(t.x-n.x*r/o,t.y-n.y*r/o,t.z-n.z*r/o)}},t.AreVectorsEqual=function(e,t,n){return Math.abs(e.x-t.x)<n&&Math.abs(e.y-t.y)<n&&Math.abs(e.z-t.z)<n},t.GetVerticalSlopeAngle=function(t,n){void 0===n&&(n=0);var i=Math.atan(Math.abs(t.y/Math.sqrt(t.x*t.x+t.z*t.z)))*e.System.Rad2Deg;return i=null!=i&&!1===Number.isNaN(i)?i:0,n>0&&i>=n&&(i=0),i},t.DownloadEnvironment=function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=null),BABYLON.EnvironmentTextureTools.CreateEnvTextureAsync(e).then(function(n){var i=e.name||"Environment",o=new Blob([n],{type:"octet/stream"});BABYLON.Tools.Download(o,i+".env"),null!=t&&t()}).catch(function(e){console.error(e),null!=n&&n()})},t.HasOwnProperty=function(e,t){return null!=e&&null!=t&&""!==t&&t in e},t.FindMeshCollider=function(e,t){var n=null;if(t instanceof BABYLON.TransformNode&&!0==(null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.renderer&&null!=t.metadata.toolkit.renderer.hasmeshcollider&&!0===t.metadata.toolkit.renderer.hasmeshcollider)){var i=t.id+"-collider";n=e.getMeshById(i)}return n},t.ColliderInstances=function(){return null==e.SceneManager.GlobalOptions.colliderInstances||e.SceneManager.GlobalOptions.colliderInstances},t.ReparentColliders=function(){return null==e.SceneManager.GlobalOptions.reparentColliders||e.SceneManager.GlobalOptions.reparentColliders},t.UseTriangleNormals=function(){return null!=e.SceneManager.GlobalOptions.useTriangleNormals&&e.SceneManager.GlobalOptions.useTriangleNormals},t.UseConvexTriangles=function(){return null!=e.SceneManager.GlobalOptions.useConvexTriangles&&e.SceneManager.GlobalOptions.useConvexTriangles},t.DefaultRenderGroup=function(){return null!=e.SceneManager.GlobalOptions.defaultRenderGroup?e.SceneManager.GlobalOptions.defaultRenderGroup:0},t.ShowDebugColliders=function(){return!0===e.SceneManager.EnableDebugMode||null!=e.SceneManager.GlobalOptions.showDebugColliders&&e.SceneManager.GlobalOptions.showDebugColliders},t.ColliderVisibility=function(){return null!=e.SceneManager.GlobalOptions.colliderVisibility?e.SceneManager.GlobalOptions.colliderVisibility:0},t.ColliderRenderGroup=function(){return null!=e.SceneManager.GlobalOptions.colliderRenderGroup?e.SceneManager.GlobalOptions.colliderRenderGroup:0},t.CollisionWireframe=function(){return null!=e.SceneManager.GlobalOptions.collisionWireframe&&e.SceneManager.GlobalOptions.collisionWireframe},t.GetColliderMaterial=function(t){var n="Collider-Material",i=t.getMaterialByName(n);if(null==i){var o=new BABYLON.PBRMaterial(n,t);o.albedoColor=new BABYLON.Color3(0,.75,0),o.wireframe=e.Utilities.CollisionWireframe(),o.unlit=!0,i=o}return i},t.CalculateCombinedFriction=function(e,t){var n=e*t;return n<-10&&(n=-10),n>10&&(n=10),n},t.CalculateCombinedRestitution=function(e,t){return e*t},t.AddLoaderItemMarkedForDisposal=function(t){null==e.Utilities.LoaderItemsMarkedForDisposal&&(e.Utilities.LoaderItemsMarkedForDisposal=[]),e.Utilities.LoaderItemsMarkedForDisposal.push(t)},t.ResetLoaderItemsMarkedForDisposal=function(){e.Utilities.LoaderItemsMarkedForDisposal=[]},t.RemoveLoaderItemsMarkedForDisposal=function(){null!=e.Utilities.LoaderItemsMarkedForDisposal&&e.Utilities.LoaderItemsMarkedForDisposal.length>0&&e.Utilities.LoaderItemsMarkedForDisposal.forEach(function(e){try{e.dispose()}catch(e){console.warn(e)}}),e.Utilities.ResetLoaderItemsMarkedForDisposal()},t.GetDirectTargetAngle=function(t,n){return e.Utilities.TempVector3.set(0,0,0),e.Utilities.InverseTransformPointToRef(t,n,e.Utilities.TempVector3),Math.atan2(e.Utilities.TempVector3.x,e.Utilities.TempVector3.z)},t.GetSmoothTargetAngle=function(t,n){return e.Utilities.TempVector3.set(0,0,0),e.Utilities.InverseTransformPointToRef(t,n,e.Utilities.TempVector3),e.Utilities.TempVector3.x/e.Utilities.TempVector3.length()},t.CalculatCatmullRom=function(t,n,i,o,r){var a=new BABYLON.Vector3(0,0,0);return e.Utilities.CalculatCatmullRomToRef(t,n,i,o,r,a),a},t.CalculatCatmullRomToRef=function(e,t,n,i,o,r){},t.MakeProper=function(e){return e.charAt(0).toUpperCase()+e.slice(1).toLowerCase()},t.StartsWith=function(e,t){return 0===e.lastIndexOf(t,0)},t.EndsWith=function(e,t){return-1!==e.indexOf(t,e.length-t.length)},t.ReplaceAll=function(e,t,n){return e.replace(new RegExp(t,"g"),n)},t.IsNullOrEmpty=function(e){return null==e||""===e},t.SafeStringPush=function(e,t){-1===e.indexOf(t)&&e.push(t)},t.ParseColor3=function(e,t,n){return void 0===t&&(t=null),void 0===n&&(n=!1),null!=e&&null!=e.r&&null!=e.g&&null!=e.b?!0===n?new BABYLON.Color3(e.r,e.g,e.b).toLinearSpace():new BABYLON.Color3(e.r,e.g,e.b):t},t.ParseColor4=function(e,t,n){void 0===t&&(t=null),void 0===n&&(n=!1);var i=null;if(null!=e&&null!=e.r&&null!=e.g&&null!=e.b){var o=null!=e.a?e.a:1;i=!0===n?new BABYLON.Color4(e.r,e.g,e.b,o).toLinearSpace():new BABYLON.Color4(e.r,e.g,e.b,o)}else i=t;return i},t.ParseVector2=function(e,t){return void 0===t&&(t=null),null!=e&&null!=e.x&&null!=e.y?new BABYLON.Vector2(e.x,e.y):t},t.ParseVector3=function(e,t){return void 0===t&&(t=null),null!=e&&null!=e.x&&null!=e.y&&null!=e.z?new BABYLON.Vector3(e.x,e.y,e.z):t},t.ParseVector4=function(e,t){return void 0===t&&(t=null),null!=e&&null!=e.x&&null!=e.y&&null!=e.z&&null!=e.w?new BABYLON.Vector4(e.x,e.y,e.z,e.w):t},t.ParseSound=function(t,n,i,o,l){return r(this,void 0,void 0,function(){var r,s,u;return a(this,function(a){switch(a.label){case 0:return r=null,null==t||null==t.filename||""===t.filename?[3,2]:(s=e.SceneManager.GetRootUrl(n),u=t.filename,[4,e.AudioSource.CreateStaticSound(i,s+u,l)]);case 1:r=a.sent(),null!=o&&o(),a.label=2;case 2:return[2,r]}})})},t.ParseTexture=function(t,n,i,o,r,a,l,s,u,c){var d=null;if(null!=t&&null!=t.filename&&""!==t.filename){var p=e.SceneManager.GetRootUrl(n),h=t.filename;d=new BABYLON.Texture(p+h,n,i,o,r,a,l,s,u,c)}return d},t.ParseCubemap=function(t,n){var i=null;if(null!=t&&null!=t.info){var o=e.SceneManager.GetRootUrl(n)+t.info.rooturl;null!=(i=BABYLON.CubeTexture.Parse(t.info,n,o))&&(i.gammaSpace=!1)}return i},t.ParseTextAsset=function(t,n){return void 0===n&&(n=null),null!=t&&null!=t.base64&&""!==t.base64?e.WindowManager.Atob(t.base64):n},t.ParseJsonAsset=function(t,n,i){void 0===n&&(n=null),void 0===i&&(i=null);var o=e.Utilities.ParseTextAsset(t,n);return null!=o&&""!==o?JSON.parse(o,i):null},t.ParseTransformByID=function(t,n,i){return void 0===i&&(i=null),null!=t&&null!=t.id?e.SceneManager.GetTransformNodeByID(n,t.id):i},t.ParseTransformByName=function(t,n,i){return void 0===i&&(i=null),null!=t&&null!=t.id?e.SceneManager.GetTransformNode(n,t.id):i},t.ParseChildTransform=function(t,n,i){return void 0===i&&(i=null),null!=n&&null!=n.name?e.SceneManager.FindChildTransformNode(t,n.name,e.SearchType.IndexOf,!1):i},t.SetAbsolutePosition=function(e,t){e.setAbsolutePosition(t)},t.GetAbsolutePosition=function(t,n,i){void 0===n&&(n=null),void 0===i&&(i=!0);var o=new BABYLON.Vector3(0,0,0);return e.Utilities.GetAbsolutePositionToRef(t,o,n,i),o},t.GetAbsolutePositionToRef=function(e,t,n,i){void 0===n&&(n=null),void 0===i&&(i=!0),!0===i&&e.computeWorldMatrix(!0),t.copyFrom(e.getAbsolutePosition()),null!=n&&t.addInPlace(n)},t.SetAbsoluteRotation=function(t,n){null==t.rotationQuaternion&&(t.rotationQuaternion=t.rotation.toQuaternion()),null!=t.parent&&t.parent instanceof BABYLON.TransformNode?(e.Utilities.TempQuaternion2.set(0,0,0,1),e.Utilities.GetAbsoluteRotationToRef(t.parent,e.Utilities.TempQuaternion2),BABYLON.Quaternion.InverseToRef(e.Utilities.TempQuaternion2,e.Utilities.TempQuaternion2),e.Utilities.TempQuaternion2.multiplyInPlace(n),t.rotationQuaternion.copyFrom(e.Utilities.TempQuaternion2)):t.rotationQuaternion.copyFrom(n)},t.GetAbsoluteRotation=function(t){var n=new BABYLON.Quaternion(0,0,0,1);return e.Utilities.GetAbsoluteRotationToRef(t,n),n},t.GetAbsoluteRotationToRef=function(e,t){null!=e.absoluteRotationQuaternion&&t.copyFrom(e.absoluteRotationQuaternion)},t.TransformPoint=function(e,t,n){return void 0===n&&(n=!0),!0===n&&e.computeWorldMatrix(),BABYLON.Vector3.TransformCoordinates(t,e.getWorldMatrix())},t.InverseTransformPoint=function(t,n,i){return void 0===i&&(i=!0),!0===i&&t.computeWorldMatrix(),e.Utilities.TempMatrix.reset(),t.getWorldMatrix().invertToRef(e.Utilities.TempMatrix),BABYLON.Vector3.TransformCoordinates(n,e.Utilities.TempMatrix)},t.TransformPointToRef=function(e,t,n,i){void 0===i&&(i=!0),!0===i&&e.computeWorldMatrix(),BABYLON.Vector3.TransformCoordinatesToRef(t,e.getWorldMatrix(),n)},t.InverseTransformPointToRef=function(t,n,i,o){void 0===o&&(o=!0),!0===o&&t.computeWorldMatrix(),e.Utilities.TempMatrix.reset(),t.getWorldMatrix().invertToRef(e.Utilities.TempMatrix),BABYLON.Vector3.TransformCoordinatesToRef(n,e.Utilities.TempMatrix,i)},t.TransformDirection=function(e,t,n){return void 0===n&&(n=!0),!0===n&&e.computeWorldMatrix(),BABYLON.Vector3.TransformNormal(t,e.getWorldMatrix())},t.InverseTransformDirection=function(t,n,i){return void 0===i&&(i=!0),!0===i&&t.computeWorldMatrix(),e.Utilities.TempMatrix.reset(),t.getWorldMatrix().invertToRef(e.Utilities.TempMatrix),BABYLON.Vector3.TransformNormal(n,e.Utilities.TempMatrix)},t.TransformDirectionToRef=function(e,t,n,i){void 0===i&&(i=!0),!0===i&&e.computeWorldMatrix(),BABYLON.Vector3.TransformNormalToRef(t,e.getWorldMatrix(),n)},t.InverseTransformDirectionToRef=function(t,n,i,o){void 0===o&&(o=!0),!0===o&&t.computeWorldMatrix(),e.Utilities.TempMatrix.reset(),t.getWorldMatrix().invertToRef(e.Utilities.TempMatrix),BABYLON.Vector3.TransformNormalToRef(n,e.Utilities.TempMatrix,i)},t.RecomputeCenterPivotPoint=function(e){var t=e.getBoundingInfo().boundingSphere.center;e.setPivotMatrix(BABYLON.Matrix.Translation(-t.x,-t.y,-t.z))},t.GetDirectionVector=function(e,t){return e.getDirection(t)},t.GetDirectionVectorToRef=function(e,t,n){e.getDirectionToRef(t,n)},t.GetForwardVector=function(e){return e.getDirection(BABYLON.Vector3.Forward())},t.GetForwardVectorToRef=function(e,t){e.getDirectionToRef(BABYLON.Vector3.Forward(),t)},t.GetRightVector=function(e){return e.getDirection(BABYLON.Vector3.Right())},t.GetRightVectorToRef=function(e,t){e.getDirectionToRef(BABYLON.Vector3.Right(),t)},t.GetUpVector=function(e){return e.getDirection(BABYLON.Vector3.Up())},t.GetUpVectorToRef=function(e,t){e.getDirectionToRef(BABYLON.Vector3.Up(),t)},t.BlendFloatValue=function(e,t,n){var i=BABYLON.Scalar.Clamp(n,0,1);return i>0?BABYLON.Scalar.Lerp(e,t,i):e},t.BlendVector2Value=function(e,t,n){var i=BABYLON.Scalar.Clamp(n,0,1);if(i>0){var o=BABYLON.Vector2.Lerp(e,t,i);e.copyFrom(o)}},t.BlendVector3Value=function(e,t,n){var i=BABYLON.Scalar.Clamp(n,0,1);i>0&&BABYLON.Vector3.LerpToRef(e,t,i,e)},t.BlendQuaternionValue=function(e,t,n){var i=BABYLON.Scalar.Clamp(n,0,1);i>0&&BABYLON.Quaternion.SlerpToRef(e,t,i,e)},t.SetAnimationTargetProperty=function(e,t){null!=e&&(e.targetProperty=t,e.targetPropertyPath=e.targetProperty.split("."))},t.SampleAnimationFloat=function(t,n,i,o){void 0===i&&(i=BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),void 0===o&&(o=!1);var r=0;return null!=t&&t.dataType===BABYLON.Animation.ANIMATIONTYPE_FLOAT&&(null==t._state&&(t._state={key:0,repeatCount:0,loopMode:i,workValue:BABYLON.Matrix.Zero()}),r=e.Utilities.InterpolateAnimation(t,n,t._state,o)),r},t.SampleAnimationVector2=function(t,n,i,o){void 0===i&&(i=BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),void 0===o&&(o=!1);var r=null;return null!=t&&t.dataType===BABYLON.Animation.ANIMATIONTYPE_VECTOR2&&(null==t._state&&(t._state={key:0,repeatCount:0,loopMode:i,workValue:BABYLON.Matrix.Zero()}),r=e.Utilities.InterpolateAnimation(t,n,t._state,o)),r},t.SampleAnimationVector3=function(t,n,i,o){void 0===i&&(i=BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),void 0===o&&(o=!1);var r=null;return null!=t&&t.dataType===BABYLON.Animation.ANIMATIONTYPE_VECTOR3&&(null==t._state&&(t._state={key:0,repeatCount:0,loopMode:i,workValue:BABYLON.Matrix.Zero()}),r=e.Utilities.InterpolateAnimation(t,n,t._state,o)),r},t.SampleAnimationQuaternion=function(t,n,i,o){void 0===i&&(i=BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),void 0===o&&(o=!1);var r=null;return null!=t&&t.dataType===BABYLON.Animation.ANIMATIONTYPE_QUATERNION&&(null==t._state&&(t._state={key:0,repeatCount:0,loopMode:i,workValue:BABYLON.Matrix.Zero()}),r=e.Utilities.InterpolateAnimation(t,n,t._state,o)),r},t.SampleAnimationMatrix=function(t,n,i,o){void 0===i&&(i=BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE),void 0===o&&(o=!1);var r=null;return null!=t&&t.dataType===BABYLON.Animation.ANIMATIONTYPE_MATRIX&&(null==t._state&&(t._state={key:0,repeatCount:0,loopMode:i,workValue:BABYLON.Matrix.Zero()}),r=e.Utilities.InterpolateAnimation(t,n,t._state,o)),r},t.GetLastKeyFrameIndex=function(e){var t=0;if(null!=e){var n=e.getKeys();if(null!=n&&n.length>0){var i=n[n.length-1];null!=i&&(t=i.frame)}}return t},t.InterpolateAnimation=function(t,n,i,o){void 0===o&&(o=!1);var r=!0===o?n*e.SceneManager.AnimationTargetFps:n;return t._interpolate(r,i)},t.UpdateLoopBlendPositionSettings=function(e,t,n){var i=e;null!=i.metadata&&null!=i.metadata.toolkit&&null!=i.metadata.toolkit.settings&&(i.metadata.toolkit.settings.loopblendpositiony=t,i.metadata.toolkit.settings.loopblendpositionxz=n)},t.TakeScreenSnapshot=function(e,t,n,i,o){if(e&&t){var r=e.activeCamera;if(r){var a=t.getRenderWidth(),l=t.getRenderHeight(),s=a,u=l;if(n)if(n.width&&n.height)s=Math.max(1,n.width),u=Math.max(1,n.height);else if(n.width){s=Math.max(1,n.width);var c=l/Math.max(1,a);u=Math.round(s*c)}else if(n.height)u=Math.max(1,n.height),c=a/Math.max(1,l),s=Math.round(u*c);else if(n.precision){var d=Math.max(.05,n.precision);s=Math.round(a*d),u=Math.round(l*d)}BABYLON.CreateScreenshotUsingRenderTarget(t,r,{width:s,height:u},void 0,void 0,void 0,!1,void 0,!1,!1,!0,void 0,void 0,function(e,t,n,r,a,l,s){try{var u=n,c=new Uint8ClampedArray(u.buffer.slice(u.byteOffset,u.byteOffset+u.byteLength));if(s)for(var d=4*e,p=Math.floor(t/2),h=new Uint8ClampedArray(d),m=0;m<p;m++){var f=m*d,g=(t-1-m)*d;h.set(c.subarray(f,f+d)),c.copyWithin(f,g,g+d),c.set(h,g)}var y=void 0;if("OffscreenCanvas"in window)y=new OffscreenCanvas(e,t);else{var v=document.createElement("canvas");v.width=e,v.height=t,y=v}var _=y.getContext("2d");if(!_)return void(o&&o(null));var S=_.createImageData(e,t);if(S.data.set(c),_.putImageData(S,0,0),!o)return;y instanceof OffscreenCanvas&&"function"==typeof y.transferToImageBitmap?o(y.transferToImageBitmap()):"function"==typeof createImageBitmap?createImageBitmap(y,i).then(function(e){return o(e)}).catch(function(){return o(null)}):o(null)}catch(e){o&&o(null)}})}else o&&o(null)}else o&&o(null)},t.DownloadImageBitmap=function(e,t,n,i){if(void 0===t&&(t="image.png"),void 0===n&&(n="image/png"),!e)return null;var o=e.width,r=e.height,a="OffscreenCanvas"in window?new OffscreenCanvas(o,r):Object.assign(document.createElement("canvas"),{width:o,height:r});a.getContext("2d").drawImage(e,0,0);var l=function(e){if(e){var n=URL.createObjectURL(e),i=document.createElement("a");i.href=n,i.download=t,i.click(),setTimeout(function(){return URL.revokeObjectURL(n)},2e3)}};return"convertToBlob"in a?a.convertToBlob({type:n,quality:i}).then(l):a.toBlob(l,n,i),a},t.InitializeShaderMaterial=function(t,n,i){void 0===n&&(n=!0),void 0===i&&(i=!1);var o=t,r=e.Utilities.HasOwnProperty(o,"getShaderName")?o.getShaderName():"glsl",a=!!e.Utilities.HasOwnProperty(o,"getAlphaBlending")&&o.getAlphaBlending(),l=!!e.Utilities.HasOwnProperty(o,"getAlphaTesting")&&o.getAlphaTesting(),s=e.Utilities.HasOwnProperty(o,"getDefaultDefines")?o.getDefaultDefines():null,u=e.Utilities.HasOwnProperty(o,"getDefaultAttributes")?o.getDefaultAttributes():null,c=e.Utilities.HasOwnProperty(o,"getDefaultUniforms")?o.getDefaultUniforms():null;(null==s||s.length<=0)&&(s=["#define GAMETIME","#define DELTATIME","#define DIFFUSECOLOR","#define DIFFUSETEXTURE"]),(null==u||u.length<=0)&&(u=["position","normal","uv","uv2","color"]),(null==c||c.length<=0)&&(c=["world","worldView","worldViewProjection","view","projection","viewProjection","gameTime","deltaTime","diffuseColor","diffuseTexture","diffuseTextureInfos","diffuseTextureMatrix"]);var d={vertex:r,fragment:r},p={needAlphaBlending:a,needAlphaTesting:l,attributes:u,uniforms:c,defines:s,useClipPlane:i,samplers:[],uniformBuffers:[],externalTextures:[],samplerObjects:[],storageBuffers:[]};o._shaderPath=d,o._options=p,!0===n&&(o.fn_afterBind=o.bind,o.bind=function(e,n,i){if(void 0===i&&(i=null),null!=o.updateGlobalTime&&o.updateGlobalTime(),o.after&&o.after(),o.fn_afterBind)try{o.fn_afterBind(e,n,i)}catch(e){}var r=null!=i?i:o.getEffect();if(t.getScene().texturesEnabled&&null!=r)for(var a in o._textures){var l=o._textures[a];null!=l&&(r.setFloat2(a+"Infos",l.coordinatesIndex,l.level),r.setMatrix(a+"Matrix",l.getTextureMatrix()))}}),o.awake&&o.awake()},t.WorldToScreenPoint=function(e,t,n){void 0===n&&(n=null);var i=null,o=null!=n?n.viewport:null!=e.activeCamera?e.activeCamera.viewport:null;return null!=o&&(i=BABYLON.Vector3.Project(t,BABYLON.Matrix.Identity(),e.getTransformMatrix(),o.toGlobal(e.getEngine().getRenderWidth(),e.getEngine().getRenderHeight()))),i},t.ScreenToWorldPoint=function(e,t){return BABYLON.Vector3.Unproject(t,e.getEngine().getRenderWidth(),e.getEngine().getRenderHeight(),BABYLON.Matrix.Identity(),e.getViewMatrix(),e.getProjectionMatrix())},t.LoadTextFile=function(e,t,n,i){return BABYLON.Tools.LoadFile(e,t,n,null,!1,i)},t.LoadTextFileAsync=function(e){return BABYLON.Tools.LoadFileAsync(e,!1)},t.GetHttpRequest=function(e,t,n,i,o,r,a){void 0===t&&(t=null),void 0===n&&(n=null),void 0===i&&(i=null),void 0===o&&(o=null),void 0===r&&(r=!1),void 0===a&&(a=null);var l=new XMLHttpRequest;return l.open("GET",e,!0),!0===r&&(l.responseType="arraybuffer"),null!=a&&l.overrideMimeType(a),null!=t&&t.forEach(function(e){null!=e&&null!=e.name&&""!==e.name&&l.setRequestHeader(e.name,e.value)}),l.onreadystatechange=function(){l.readyState===XMLHttpRequest.DONE&&null!=n&&n(l)},l.onprogress=function(e){null!=o&&o(e)},l.onerror=function(){null!=i&&i("Failed to get data from server.")},l.onabort=function(){null!=i&&i("Aborted get data from server.")},l.send(null),l},t.GetHttpRequestAsync=function(t,n,i,o,r){return void 0===n&&(n=null),void 0===i&&(i=null),void 0===o&&(o=!1),void 0===r&&(r=null),new Promise(function(a,l){e.Utilities.GetHttpRequest(t,n,function(e){a(e)},function(e){l(e)},i,o,r)})},t.PostHttpRequest=function(e,t,n,i,o,r,a,l,s){void 0===n&&(n=null),void 0===i&&(i="application/x-www-form-urlencoded"),void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=!1),void 0===s&&(s=null);var u=new XMLHttpRequest;return u.open("POST",e,!0),!0===l&&(u.responseType="arraybuffer"),null!=s&&u.overrideMimeType(s),null!=n&&n.forEach(function(e){null!=e&&null!=e.name&&""!==e.name&&u.setRequestHeader(e.name,e.value)}),u.setRequestHeader("Content-Type",i),u.onreadystatechange=function(){u.readyState===XMLHttpRequest.DONE&&null!=o&&o(u)},u.onprogress=function(e){null!=a&&a(e)},u.onerror=function(){null!=r&&r("Failed to post data to server.")},u.onabort=function(){null!=r&&r("Aborted post data to server.")},u.send(t),u},t.PostHttpRequestAsync=function(t,n,i,o,r,a,l){return void 0===i&&(i=null),void 0===o&&(o="application/x-www-form-urlencoded"),void 0===r&&(r=null),void 0===a&&(a=!1),void 0===l&&(l=null),new Promise(function(s,u){e.Utilities.PostHttpRequest(t,n,i,o,function(e){s(e)},function(e){u(e)},r,a,l)})},t.RemapValueToRange=function(e,t,n,i,o){return i+(e-t)*(o-i)/(n-t)},t.CloneSkeletonPrefab=function(e,t,n,i,o){void 0===o&&(o=null);var r=new BABYLON.Skeleton(n,i||n,e);r.needInitialSkinMatrix=t.needInitialSkinMatrix;for(var a=0;a<t.bones.length;a++){var l=t.bones[a],s=null,u=l.getParent();if(u){var c=t.bones.indexOf(u);s=r.bones[c]}var d=new BABYLON.Bone(l.name,r,s,l.getBaseMatrix().clone(),l.getRestPose().clone());d._index=l._index,d.metadata=l.metadata,l._linkedTransformNode&&d.linkTransformNode(l._linkedTransformNode),BABYLON.DeepCopier.DeepCopy(l.animations,d.animations)}var p=r,h=t;if(h._ranges)for(var m in p._ranges={},h._ranges){var f=h._ranges[m];f&&(p._ranges[m]=f.clone())}return h._isDirty=!0,r},t.GetSceneTransforms=function(e){var t=null;return null!=e.transformNodes&&e.transformNodes.length>0&&e.transformNodes.forEach(function(e){null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.prefab&&!1===e.metadata.toolkit.prefab&&(null==t&&(t=[]),t.push(e))}),null!=e.meshes&&e.meshes.length>0&&e.meshes.forEach(function(e){null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.prefab&&!1===e.metadata.toolkit.prefab&&(null==t&&(t=[]),t.push(e))}),t},t.PostParseSceneComponents=function(t,n,i,o){var r=new e.MetadataParser(t);return null!=n&&n.length>0&&(n.forEach(function(e){r.parseSceneComponents(e)}),r.postProcessSceneComponents(i,o)),r},t.GetDefaultReflectionTexture=function(e){if(!e._DefaultCube){var t=document.createElement("canvas");t.width=t.height=1;var n=t.getContext("2d");n.fillStyle="rgba(128,128,128,1)",n.fillRect(0,0,1,1);var i=t.toDataURL("image/png"),o=[i,i,i,i,i,i],r=BABYLON.CubeTexture.CreateFromImages(o,e,!0);r.name="DefaultReflection",r.gammaSpace=!1,r.coordinatesMode=BABYLON.Texture.CUBIC_MODE,r.level=.1,e._DefaultCube=r}return e._DefaultCube},t.GetNeutralReflectionTexture=function(e,t,n){void 0===t&&(t=128),void 0===n&&(n=.4);var i="_NeutralCube_".concat(t,"_").concat(n);if(!e[i]){var o=document.createElement("canvas");o.width=o.height=1;var r=o.getContext("2d");r.fillStyle="rgba(".concat(t,",").concat(t,",").concat(t,",1)"),r.fillRect(0,0,1,1);var a=o.toDataURL("image/png"),l=[a,a,a,a,a,a],s=BABYLON.CubeTexture.CreateFromImages(l,e,!0);s.name="NeutralReflection",s.gammaSpace=!1,s.coordinatesMode=BABYLON.Texture.CUBIC_MODE,s.level=n,e[i]=s}return e[i]},t.GetAssetContainerMesh=function(e,t){var n=null,i=t.toLowerCase();if(null==n&&null!=e.meshes&&e.meshes.length>0)for(var o=0;o<e.meshes.length;o++){var r=e.meshes[o];if(r instanceof BABYLON.Mesh&&r.name.toLowerCase()===i){n=r;break}}return n},t.GetAssetContainerNode=function(e,t){var n=null,i=t.toLowerCase();if(null==n&&null!=e.transformNodes&&e.transformNodes.length>0)for(var o=0;o<e.transformNodes.length;o++){var r=e.transformNodes[o];if(r.name.toLowerCase()===i){n=r;break}}return n},t.CloneAssetContainerItem=function(t,n,i,o,r,a){void 0===o&&(o=null),void 0===r&&(r=!1),void 0===a&&(a=!0);var l=null,s={},u={},c={},d=null,p=null,h=[],m=[],f=n.toLowerCase(),g=null,y=function(t,n){null==g&&(g=n),s[t.uniqueId]=n.uniqueId,u[n.uniqueId]=n,i&&(n.name=i(t.name)),null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.entity&&(n.metadata=e.Utilities.CloneEntityMetadata(t.metadata));var o=null!=n.metadata&&null!=n.metadata.toolkit&&null!=n.metadata.toolkit.animator?n.metadata.toolkit.animator:null;if(null!=o&&""!==o&&(null==d&&(d=[]),d.indexOf(o)<0&&d.push(o),n.metadata.toolkit.animator=e.Utilities.CreateGuid(),c[o]=n.metadata.toolkit.animator),t instanceof BABYLON.AbstractMesh&&null!=t.skeleton&&(null==p&&(p=[]),p.indexOf(t.skeleton)<0&&p.push(t.skeleton)),n instanceof BABYLON.Mesh){var r=n;if(r.morphTargetManager){var a=t.morphTargetManager;r.morphTargetManager=a.clone();for(var l=0;l<a.numTargets;l++){var h=a.getTarget(l),m=r.morphTargetManager.getTarget(l);s[h.uniqueId]=m.uniqueId,u[m.uniqueId]=m}}}};if(null==l&&null!=t.transformNodes&&t.transformNodes.length>0)for(var v=0;v<t.transformNodes.length;v++){var _=t.transformNodes[v];if(_.name.toLowerCase()===f){var S=e.Utilities.InstantiateHierarchy(_,o,function(e,t){y(e,t)});if(S){l=S;break}}}if(null==l&&null!=t.meshes&&t.meshes.length>0){var B=function(n){var a=t.meshes[n];if(a.name.toLowerCase()===f){var c=e.Utilities.InstantiateHierarchy(a,o,function(e,n){y(e,n);var o=n;if(!0===a.isWorldMatrixFrozen&&o.freezeWorldMatrix&&o.freezeWorldMatrix(),n.material&&o.material)if(!0===r){var l=e.material;if(-1===m.indexOf(l)){var c=l.clone(i?i(l.name):"Clone of "+l.name);if(!0===l.isFrozen&&c.freeze&&c.freeze(),m.push(l),s[l.uniqueId]=c.uniqueId,u[c.uniqueId]=c,"MultiMaterial"===l.getClassName())for(var d=0,p=l.subMaterials;d<p.length;d++){var h=p[d];h&&(c=h.clone(i?i(h.name):"Clone of "+h.name),!0===h.isFrozen&&c.freeze&&c.freeze(),m.push(h),s[h.uniqueId]=c.uniqueId,u[c.uniqueId]=c)}}o.material=u[s[l.uniqueId]]}else"MultiMaterial"===o.material.getClassName()?-1===t.scene.multiMaterials.indexOf(o.material)&&t.scene.addMultiMaterial(o.material):-1===t.scene.materials.indexOf(o.material)&&t.scene.addMaterial(o.material)});if(c)return l=c,"break"}};for(v=0;v<t.meshes.length&&"break"!==B(v);v++);}if(null!=p&&p.length>0&&p.forEach(function(n){for(var o=i?i(n.name):"Clone of "+n.name,r=e.Utilities.CloneSkeletonPrefab(t.scene,n,o,o,g),a=0,l=t.meshes;a<l.length;a++){var c=l[a];if(c.skeleton===n&&!c.isAnInstance){if(u[s[c.uniqueId]].skeleton=r,-1!==h.indexOf(r))continue;h.push(r);for(var d=0,p=r.bones;d<p.length;d++){var m=p[d];m._linkedTransformNode&&(m._linkedTransformNode=u[s[m._linkedTransformNode.uniqueId]])}}}}),!0===a){var b=null;t.animationGroups.forEach(function(e){var t=e,n=null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.source&&""!==t.metadata.toolkit.source?t.metadata.toolkit.source:null;if(null!=n&&""!==n&&null!=d&&d.indexOf(n)>=0){var i=e.clone(e.name,function(e){return u[s[e.uniqueId]]||e}),o=c[n]||n;null!=t.metadata&&(i.metadata={},i.metadata.toolkit={},i.metadata.toolkit.id=t.metadata.toolkit.id,i.metadata.toolkit.clip=t.metadata.toolkit.clip,i.metadata.toolkit.source=o,i.metadata.toolkit.legacy=t.metadata.toolkit.legacy,i.metadata.toolkit.length=t.metadata.toolkit.length,i.metadata.toolkit.looping=t.metadata.toolkit.looping,i.metadata.toolkit.settings=t.metadata.toolkit.settings,i.metadata.toolkit.behavior=t.metadata.toolkit.behavior,i.metadata.toolkit.wrapmode=t.metadata.toolkit.wrapmode,i.metadata.toolkit.framerate=t.metadata.toolkit.framerate,i.metadata.toolkit.humanmotion=t.metadata.toolkit.humanmotion,i.metadata.toolkit.averagespeed=t.metadata.toolkit.averagespeed,i.metadata.toolkit.averageduration=t.metadata.toolkit.averageduration,i.metadata.toolkit.averageangularspeed=t.metadata.toolkit.averageangularspeed),null==b&&(b=[]),b.push(i)}}),null!=l&&null!=b&&e.Utilities.AssignAnimationGroupsToInstance(l,b)}return l},t.AssignAnimationGroupsToInstance=function(t,n){e.Utilities.AssignAnimationGroupsToNode(t,n);var i=t.getChildren(null,!1);null!=i&&i.length>0&&i.forEach(function(t){e.Utilities.AssignAnimationGroupsToNode(t,n)})},t.AssignAnimationGroupsToNode=function(t,n){if(null!=t&&null!=t.metadata&&t.metadata.toolkit){var i=t.metadata.toolkit;if(null!=i.components&&i.components.length>0)for(var o=0;o<i.components.length;o++){var r=i.components[o].klass;if(null!=r&&""!==r){if(!0===e.SceneManager.AutoStripNamespacePrefix&&!1===e.SceneManager.UniversalModuleDefinition){var a=r.lastIndexOf(".");-1!==a&&(r=r.substring(a+1))}"TOOLKIT.AnimationState"===r&&(t.metadata.toolkit.sourceAnimationGroups=n)}}}},t.UnitySlopeAngleToCosine=function(e){return Math.cos(e*Math.PI/180)},t.InstantiateHierarchy=function(t,n,i){if(void 0===n&&(n=null),t instanceof BABYLON.Mesh){var o=null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.instance&&!0===t.metadata.toolkit.instance;return e.Utilities.InstantiateMeshHierarchy(t,n,o,i)}return e.Utilities.InstantiateNodeHierarchy(t,n,i)},t.InstantiateNodeHierarchy=function(t,n,i){void 0===n&&(n=null);var o=t.clone("Clone of "+(t.name||t.id),n,!0);o&&i&&i(t,o);for(var r=0,a=t.getChildTransformNodes(!0);r<a.length;r++){var l=a[r];e.Utilities.InstantiateHierarchy(l,o,i)}return o},t.InstantiateMeshHierarchy=function(t,n,i,o){void 0===n&&(n=null);var r=t.getTotalVertices()>0&&!0===i?t.createInstance("Instance of "+(t.name||t.id)):t.clone("Clone of "+(t.name||t.id),n||t.parent,!0);r&&(r.parent=n,r.position=t.position.clone(),r.scaling=t.scaling.clone(),t.rotationQuaternion?r.rotationQuaternion=t.rotationQuaternion.clone():r.rotation=t.rotation.clone(),o&&o(t,r));for(var a=0,l=t.getChildTransformNodes(!0);a<l.length;a++){var s=l[a];e.Utilities.InstantiateHierarchy(s,r,o)}return r},t.PrepareSkeletonForRendering=function(e,t){void 0===t&&(t=!1),null!=e&&e.prepare(t)},t.RetargetAnimationGroupSkeleton=function(e,t,n){void 0===n&&(n=null),null!=e&&null!=t&&e.targetedAnimations.forEach(function(e,i){if(null!=e.target&&null!=e.target.name){var o=t.bones.filter(function(t){return t.name.toLowerCase()===e.target.name.toLowerCase()})[0];null!=o?null!=o.getTransformNode()&&(e.target=o.getTransformNode()):"Armature"===e.target.name&&null!=n?e.target=n:console.warn("Failed to locate matching animation cloning target: "+e.target.name)}})},t.RetargetAnimationGroupBlendShapes=function(e,t){null!=e&&null!=t&&e.targetedAnimations.forEach(function(e,t){null!=e.target&&e.target.name})},t.LinkSkeletonMeshes=function(t,n){if(null!=t&&null!=t.bones&&t.bones.length>0&&null!=n&&null!=n.bones&&n.bones.length>0)for(var i=n.bones.length,o=0;o<i;o++){var r=n.bones[o];if(null!=r){var a=e.Utilities.FindBoneByName(t,r.name);null!=a?r._linkedTransformNode=a._linkedTransformNode:console.warn("Failed to locate bone on mater rig: "+r.name)}}},t.FindBoneByName=function(e,t){var n=null;if(null!=e&&null!=e.bones)for(var i=0;i<e.bones.length;i++){var o=e.bones[i];if(o.name.toLowerCase().replace("mixamo:","").replace("left_","left").replace("right_","right")===t.toLowerCase().replace("mixamo:","").replace("left_","left").replace("right_","right")){n=o;break}}return n},t.SwitchHandednessVector3=function(e){return new BABYLON.Vector3(e.x,e.y,-e.z)},t.SwitchHandednessVector4=function(e){return new BABYLON.Vector4(e.x,e.y,-e.z,-e.w)},t.SwitchHandednessQuaternion=function(e){return new BABYLON.Quaternion(e.x,e.y,-e.z,-e.w)},t.ComputeBlendingSpeed=function(e,t,n){void 0===n&&(n=!1);var i=1/(e*t);return!0===n&&(i*=.5),i},t.CalculateCameraDistance=function(e,t,n){return void 0===n&&(n=1),Math.round(e*n*t*1)},t.InstantiateClass=function(t){try{var n=e.SceneManager.GetClass(t);if(n)return n;var i=t.split("."),o=void 0;if("undefined"!=typeof window)o=window;else if("undefined"!=typeof globalThis)o=globalThis;else{if(void 0===globalThis.global)throw new Error("No global object available");o=globalThis.global}for(var r=0;r<i.length;r++)if(!(o=o[i[r]]))throw new Error("Class not found: ".concat(t));return"function"==typeof o?o:null}catch(e){return console.error("Failed to resolve class: ".concat(t),e),null}},t.GetSimpleClassName=function(e){if(e&&e.constructor&&e.constructor.toString){var t=e.constructor.toString().match(/function\s*(\w+)/);if(t&&2==t.length)return t[1]}},t.DisposeEntity=function(t){if(null!=t){if(null!=t.metadata&&t.metadata.toolkit){var n=t.metadata.toolkit;null!=n.components&&n.components.length>0&&n.components.forEach(function(t){if(null!=t.instance){try{e.SceneManager.DestroyScriptComponent(t.instance)}catch(e){}t.instance=null}}),delete t.metadata.toolkit}if(null!=t.metadata&&t.metadata.mixer&&delete t.metadata.mixer,null!=t.metadata&&null!=t.metadata.clone&&delete t.metadata.clone,null!=t.physicsImpostor){var i=t.physicsImpostor;null!=i.onCollideEvent&&(i.onCollideEvent=null),null!=i.tmpCollisionObjects&&delete i.tmpCollisionObjects,null!=t.physicsImpostor.physicsBody&&(null!=t.physicsImpostor.physicsBody.entity&&delete t.physicsImpostor.physicsBody.entity,null!=t.physicsImpostor.physicsBody.triangleMapInfo&&delete t.physicsImpostor.physicsBody.triangleMapInfo),t.physicsImpostor.dispose(),t.physicsImpostor=null}null!=t.skeleton&&(null!=t.skeleton._sockets&&delete t.skeleton._sockets,null!=t.skeleton.bones&&t.skeleton.bones.length>0&&t.skeleton.bones.forEach(function(e){null!=e&&null!=e.metadata&&(e.metadata=null)})),null!=t.cameraRig&&(t.cameraRig.dispose&&t.cameraRig.dispose(),delete t.cameraRig),null!=t.lightRig&&(t.lightRig.dispose&&t.lightRig.dispose(),delete t.lightRig),null!=t.shadowBox&&(t.shadowBox.dispose&&t.shadowBox.dispose(),delete t.shadowBox),null!=t._debugCollider&&(t._debugCollider.dispose&&t._debugCollider.dispose(),delete t._debugCollider),null!=t._meshCollider&&(t._meshCollider=null),null!=t._colliderType&&delete t._colliderType,null!=t._skinnedMesh&&delete t._skinnedMesh}},t.SearchTransformNodes=function(t,n,i){void 0===i&&(i=e.SearchType.ExactMatch);var o=null,r=null!=i?i:e.SearchType.ExactMatch;if(null!=n&&n.length>0)for(var a=0;a<n.length;a++){var l=n[a];if(r===e.SearchType.ExactMatch){if(l.name===t){o=l;break}}else if(r===e.SearchType.StartsWith){if(e.Utilities.StartsWith(l.name,t)){o=l;break}}else if(r===e.SearchType.EndsWith){if(e.Utilities.EndsWith(l.name,t)){o=l;break}}else if(r===e.SearchType.IndexOf){if(l.name.indexOf(t)>=0){o=l;break}}else if(l.name===t){o=l;break}}return o},t.SearchTransformNodeForTags=function(e,t){var n=null;if(null!=t&&t.length>0)for(var i=0;i<t.length;i++){var o=t[i];if(o instanceof BABYLON.TransformNode&&BABYLON.Tags.MatchesQuery(o,e)){n=o;break}}return n},t.SearchAllTransformNodesForTags=function(e,t){var n=null;if(null!=t&&t.length>0)for(var i=0;i<t.length;i++){var o=t[i];o instanceof BABYLON.TransformNode&&BABYLON.Tags.MatchesQuery(o,e)&&(null==n&&(n=[]),n.push(o))}return n},t.SearchTransformNodeForScript=function(t,n){var i=null;if(null!=n&&n.length>0)for(var o=0;o<n.length;o++){var r=n[o];if(r instanceof BABYLON.TransformNode&&null!=e.SceneManager.FindScriptComponent(r,t)){i=r;break}}return i},t.SearchAllTransformNodesForScript=function(t,n){var i=null;if(null!=n&&n.length>0)for(var o=0;o<n.length;o++){var r=n[o];r instanceof BABYLON.TransformNode&&null!=e.SceneManager.FindScriptComponent(r,t)&&(null==i&&(i=[]),i.push(r))}return i},t.CreateGuid=function(t){void 0===t&&(t=null);var n=BABYLON.Tools.RandomId();return e.Utilities.IsNullOrEmpty(t)||(n+="-"+t),n},t.ValidateTransformGuid=function(e){if(null!=e&&null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.guid&&""!==e.metadata.toolkit.guid){var t=e.metadata.toolkit.guid;e.id!==t&&(e.id=t),delete e.metadata.toolkit.guid}},t.AddShadowCastersToLight=function(e,t,n){void 0===n&&(n=!1);var i=e.getShadowGenerator();if(null!=i){var o=i.getShadowMap();if(null!=o)for(var r=0;r<t.length;r++){var a=t[r];if(a instanceof BABYLON.AbstractMesh&&(null!=e.includedOnlyMeshes&&e.includedOnlyMeshes.length>0&&e.includedOnlyMeshes.indexOf(a)<0&&e.includedOnlyMeshes.push(a),null==o.renderList&&(o.renderList=[]),o.renderList.indexOf(a)<0&&o.renderList.push(a)),!0===n){var l=a.getChildMeshes();null!=l&&l.length>0&&l.forEach(function(t){null!=e.includedOnlyMeshes&&e.includedOnlyMeshes.length>0&&e.includedOnlyMeshes.indexOf(t)<0&&e.includedOnlyMeshes.push(t),null==o.renderList&&(o.renderList=[]),o.renderList.indexOf(t)<0&&o.renderList.push(t)})}}}},t.RegisterInstancedMeshBuffers=function(e){var t=null!=e.metadata&&null!=e.metadata.toolkit&&null!=e.metadata.toolkit.buffers?e.metadata.toolkit.buffers:null;null!=t&&(null!=t.floats&&t.floats.length>0&&t.floats.forEach(function(t){null!=t.kind&&""!==t.kind&&null!=t.value&&(e.registerInstancedBuffer(t.kind,1),e.instancedBuffers[t.kind]=t.value)}),null!=t.colors&&t.colors.length>0&&t.colors.forEach(function(t){null!=t.kind&&""!==t.kind&&null!=t.value&&(e.registerInstancedBuffer(t.kind,4),e.instancedBuffers[t.kind]=new BABYLON.Color4(t.value.r||0,t.value.g||0,t.value.b||0,t.value.a||1).toLinearSpace())}),null!=t.vector2&&t.vector2.length>0&&t.vector2.forEach(function(t){null!=t.kind&&""!==t.kind&&null!=t.value&&(e.registerInstancedBuffer(t.kind,2),e.instancedBuffers[t.kind]=new BABYLON.Vector2(t.value.x||0,t.value.y||0))}),null!=t.vector3&&t.vector3.length>0&&t.vector3.forEach(function(t){null!=t.kind&&""!==t.kind&&null!=t.value&&(e.registerInstancedBuffer(t.kind,3),e.instancedBuffers[t.kind]=new BABYLON.Vector3(t.value.x||0,t.value.y||0,t.value.z||0))}),null!=t.vector4&&t.vector4.length>0&&t.vector4.forEach(function(t){null!=t.kind&&""!==t.kind&&null!=t.value&&(e.registerInstancedBuffer(t.kind,4),e.instancedBuffers[t.kind]=new BABYLON.Vector4(t.value.x||0,t.value.y||0,t.value.z||0,t.value.w||0))}))},t.CloneValue=function(e,t){return e?e instanceof BABYLON.Mesh?null:e instanceof BABYLON.SubMesh?e.clone(t):e.clone?e.clone():e:null},t.CloneEntityMetadata=function(t){var n=null;if(null!=t){var i=null;if(null!=t.toolkit){var o=null!=t.toolkit.instance&&t.toolkit.instance,r=null==t.toolkit.visible||t.toolkit.visible,a=null!=t.toolkit.visibility?t.toolkit.visibility:1,l=null!=t.toolkit.billboard?t.toolkit.billboard:0,s=null!=t.toolkit.tags?t.toolkit.tags:"Untagged Layer0",u=null!=t.toolkit.skin&&t.toolkit.skin,c=null!=t.toolkit.bone?t.toolkit.bone:null,d=null!=t.toolkit.rootbone&&t.toolkit.rootbone,p=null!=t.toolkit.rootpos?t.toolkit.rootpos:null,h=null!=t.toolkit.rootrot?t.toolkit.rootrot:null,m=null!=t.toolkit.group?t.toolkit.group:"Untagged",f=null!=t.toolkit.layer?t.toolkit.layer:0,g=null!=t.toolkit.layername?t.toolkit.layername:"Default",y=null!=t.toolkit.navigation?t.toolkit.navigation:null,v=null!=t.toolkit.lightmapped&&t.toolkit.lightmapped,_=null!=t.toolkit.lightmapuvs?t.toolkit.lightmapuvs:null,S=null!=t.toolkit.animator?t.toolkit.animator:null,B=null,b=null,C=null,A=null;t.toolkit.physics&&(B={},e.Utilities.DeepCopyProperties(t.toolkit.physics,B)),t.toolkit.renderer&&(b={},e.Utilities.DeepCopyProperties(t.toolkit.renderer,b)),t.toolkit.collision&&(C={},e.Utilities.DeepCopyProperties(t.toolkit.collision,C)),t.toolkit.properties&&(A={},e.Utilities.DeepCopyProperties(t.toolkit.properties,A));var M=null;null!=t.toolkit.wheels&&t.toolkit.wheels.length>0&&(M=[],t.toolkit.wheels.forEach(function(t){if(null!=t){var n={};e.Utilities.DeepCopyProperties(t,n),M.push(n)}}));var T=null;null!=t.toolkit.components&&t.toolkit.components.length>0&&(T=[],t.toolkit.components.forEach(function(t){if(null!=t){var n=e.Utilities.FastJsonCopy(t);n.instance=null,T.push(n)}})),(i={}).parsed=!1,i.prefab=!1,i.buffers=null,i.lods=null,i.coverages=null,i.distances=null,i.handlers=null,i.instance=o,i.visible=r,i.visibility=a,i.billboard=l,i.tags=s,i.skin=u,i.bone=c,i.rootbone=d,i.rootpos=p,i.rootrot=h,i.group=m,i.layer=f,i.layername=g,i.navigation=y,i.lightmapped=v,i.lightmapuvs=_,i.animator=S,i.renderer=b,i.physics=B,i.wheels=M,i.collision=C,i.properties=A,i.components=T}null!=i&&(n={toolkit:i})}return n},t.FastJsonCopy=function(t){if(!t)return t;if(Array.isArray(t)){for(var n=[],i=t.length,o=0;o<i;o++)n.push(e.Utilities.FastJsonCopy(t[o]));return n}if("object"==typeof t){var r=Object.keys(t),a={};for(o=r.length-1;o>-1;o--){var l=r[o];a[l]=e.Utilities.FastJsonCopy(t[l])}return a}return t},t.DeepCopyProperties=function(t,n,i,o){for(var r in t)if(("_"!==r[0]||o&&-1!==o.indexOf(r))&&(!i||-1===i.indexOf(r))){var a=t[r],l=typeof a;if("function"!==l)if("object"===l)if(a instanceof Array){if(n[r]=[],a.length>0)if("object"==typeof a[0])for(var s=0;s<a.length;s++){var u=e.Utilities.CloneValue(a[s],n);-1===n[r].indexOf(u)&&n[r].push(u)}else n[r]=a.slice(0)}else n[r]=e.Utilities.CloneValue(a,n);else n[r]=a}},t.ValidateTransformMetadata=function(t){null==t.metadata&&(t.metadata={}),null==t.metadata.toolkit&&(t.metadata.toolkit={});var n=t.metadata.toolkit;e.Utilities.HasOwnProperty(n,"entity")||(t.metadata.toolkit.entity=!0),e.Utilities.HasOwnProperty(n,"parsed")||(t.metadata.toolkit.parsed=!1),e.Utilities.HasOwnProperty(n,"prefab")||(t.metadata.toolkit.prefab=!1),e.Utilities.HasOwnProperty(n,"instance")||(t.metadata.toolkit.instance=!1),e.Utilities.HasOwnProperty(n,"buffers")||(t.metadata.toolkit.buffers=null),e.Utilities.HasOwnProperty(n,"visible")||(t.metadata.toolkit.visible=!0),e.Utilities.HasOwnProperty(n,"visibility")||(t.metadata.toolkit.visibility=1),e.Utilities.HasOwnProperty(n,"billboard")||(t.metadata.toolkit.billboard=0),e.Utilities.HasOwnProperty(n,"tags")||(t.metadata.toolkit.tags="Untagged Layer0"),e.Utilities.HasOwnProperty(n,"skin")||(t.metadata.toolkit.skin=!1),e.Utilities.HasOwnProperty(n,"bone")||(t.metadata.toolkit.bone=null),e.Utilities.HasOwnProperty(n,"rootbone")||(t.metadata.toolkit.rootbone=!1),e.Utilities.HasOwnProperty(n,"rootpos")||(t.metadata.toolkit.rootpos=null),e.Utilities.HasOwnProperty(n,"rootrot")||(t.metadata.toolkit.rootrot=null),e.Utilities.HasOwnProperty(n,"group")||(t.metadata.toolkit.group="Untagged"),e.Utilities.HasOwnProperty(n,"layer")||(t.metadata.toolkit.layer=0),e.Utilities.HasOwnProperty(n,"layername")||(t.metadata.toolkit.layername="Default"),e.Utilities.HasOwnProperty(n,"navigation")||(t.metadata.toolkit.navigation=null),e.Utilities.HasOwnProperty(n,"lightmapped")||(t.metadata.toolkit.lightmapped=!1),e.Utilities.HasOwnProperty(n,"lightmapuvs")||(t.metadata.toolkit.lightmapuvs=!1),e.Utilities.HasOwnProperty(n,"animator")||(t.metadata.toolkit.animator=null),e.Utilities.HasOwnProperty(n,"lods")||(t.metadata.toolkit.lods=null),e.Utilities.HasOwnProperty(n,"coverages")||(t.metadata.toolkit.coverages=null),e.Utilities.HasOwnProperty(n,"distances")||(t.metadata.toolkit.distances=null),e.Utilities.HasOwnProperty(n,"handlers")||(t.metadata.toolkit.handlers=null),e.Utilities.HasOwnProperty(n,"physics")||(t.metadata.toolkit.physics=null),e.Utilities.HasOwnProperty(n,"wheels")||(t.metadata.toolkit.wheels=null),e.Utilities.HasOwnProperty(n,"renderer")||(t.metadata.toolkit.renderer=null),e.Utilities.HasOwnProperty(n,"collision")||(t.metadata.toolkit.collision=null),e.Utilities.HasOwnProperty(n,"properties")||(t.metadata.toolkit.properties=null),e.Utilities.HasOwnProperty(n,"components")||(t.metadata.toolkit.components=null)},t.UpVector=BABYLON.Vector3.Up(),t.AuxVector=BABYLON.Vector3.Zero(),t.ZeroVector=BABYLON.Vector3.Zero(),t.TempMatrix=BABYLON.Matrix.Zero(),t.TempMatrix2=BABYLON.Matrix.Zero(),t.TempVector2=BABYLON.Vector2.Zero(),t.TempVector3=BABYLON.Vector3.Zero(),t.TempQuaternion=BABYLON.Quaternion.Zero(),t.TempQuaternion2=BABYLON.Quaternion.Zero(),t.TempQuaternion3=BABYLON.Quaternion.Zero(),t.TempDirectionBuffer=BABYLON.Vector3.Zero(),t.LoadingState=-1,t.OnPreloaderProgress=null,t.OnPreloaderComplete=null,t.LoaderItemsMarkedForDisposal=[],t}();e.Utilities=t}(i||(i={})),function(e){var t=function(t){function n(n,i){var o=t.call(this,n,i)||this;return o.terrainInfo=null,o.shader=o.getClassName(),o.plugin=new e.UniversalTerrainMaterialPlugin(o,o.shader),o}return o(n,t),n.prototype.update=function(){},n.prototype.getClassName=function(){return"UniversalTerrainMaterial"},n.prototype.getTerrainInfo=function(){return this.terrainInfo},n}(e.CustomShaderMaterial);e.UniversalTerrainMaterial=t,e.SceneManager.RegisterClass("TOOLKIT.UniversalTerrainMaterial",t);var n=function(t){function n(e,n){var i=t.call(this,e,n,100,{UNIVERSALTERRAINMATERIAL:!1})||this;return i.colorName="surfaceAlbedo",i.splatmapSampler="splatmapSampler",i.detailsSampler="detailsSampler",i.normalsSampler="normalsSampler",i.GLSL_CustomFragment=null,i.GLSL_CustomVertex=null,i.GLSL_VertexMainEnd=null,i.GLSL_FragmentUpdateColor=null,i.WGSL_CustomFragment=null,i.WGSL_CustomVertex=null,i.WGSL_VertexMainEnd=null,i.WGSL_FragmentUpdateColor=null,i}return o(n,t),n.prototype.isCompatible=function(e){return e===BABYLON.ShaderLanguage.WGSL||e===BABYLON.ShaderLanguage.GLSL},n.prototype.getClassName=function(){return"UniversalTerrainMaterialPlugin"},n.prototype.getCustomCode=function(t,n){var i=this.getCustomShaderMaterial().getTerrainInfo();if("vertex"===t){if(n===BABYLON.ShaderLanguage.WGSL)return null==this.WGSL_CustomVertex&&(this.WGSL_CustomVertex=this.WGSL_FormatTerrainVertexDefintions(i)),null==this.WGSL_VertexMainEnd&&(this.WGSL_VertexMainEnd=this.WGSL_FormatTerrainVertexMainEnd(i)),{CUSTOM_VERTEX_DEFINITIONS:this.WGSL_CustomVertex,CUSTOM_VERTEX_MAIN_END:this.WGSL_VertexMainEnd};if(n===BABYLON.ShaderLanguage.GLSL)return null==this.GLSL_CustomVertex&&(this.GLSL_CustomVertex=this.GLSL_FormatTerrainVertexDefintions(i)),null==this.GLSL_VertexMainEnd&&(this.GLSL_VertexMainEnd=this.GLSL_FormatTerrainVertexMainEnd(i)),{CUSTOM_VERTEX_DEFINITIONS:this.GLSL_CustomVertex,CUSTOM_VERTEX_MAIN_END:this.GLSL_VertexMainEnd}}else if("fragment"===t){if(n===BABYLON.ShaderLanguage.WGSL)return null==this.WGSL_CustomFragment&&(this.WGSL_CustomFragment=this.WGSL_FormatTerrainFragmentDefintions(i,this.splatmapSampler,this.detailsSampler,this.normalsSampler)),null==this.WGSL_FragmentUpdateColor&&(this.WGSL_FragmentUpdateColor=this.WGSL_FormatTerrainFragmentUpdateColor(i,this.colorName,this.splatmapSampler,this.detailsSampler,this.normalsSampler,e.SceneManager.TerrainColorCorrection)),{CUSTOM_FRAGMENT_DEFINITIONS:this.WGSL_CustomFragment,CUSTOM_FRAGMENT_BEFORE_LIGHTS:this.WGSL_FragmentUpdateColor};if(n===BABYLON.ShaderLanguage.GLSL)return null==this.GLSL_CustomFragment&&(this.GLSL_CustomFragment=this.GLSL_FormatTerrainFragmentDefintions(i,this.splatmapSampler,this.detailsSampler,this.normalsSampler)),null==this.GLSL_FragmentUpdateColor&&(this.GLSL_FragmentUpdateColor=this.GLSL_FormatTerrainFragmentUpdateColor(i,this.colorName,this.splatmapSampler,this.detailsSampler,this.normalsSampler,e.SceneManager.TerrainColorCorrection)),{CUSTOM_FRAGMENT_DEFINITIONS:this.GLSL_CustomFragment,CUSTOM_FRAGMENT_BEFORE_LIGHTS:this.GLSL_FragmentUpdateColor}}return null},n.prototype.getUniforms=function(e){var t=e===BABYLON.ShaderLanguage.WGSL;return this.vertexDefinitions=this.getCustomShaderMaterial().getCustomVertexCode(t),this.fragmentDefinitions=this.getCustomShaderMaterial().getCustomFragmentCode(t),this.getCustomShaderMaterial().getCustomUniforms(t)},n.prototype.getSamplers=function(e){var t=this.getCustomShaderMaterial().getCustomSamplers();null!=t&&t.length>0&&e.push.apply(e,t)},n.prototype.getAttributes=function(e,t,n){var i=this.getCustomShaderMaterial().getCustomAttributes();null!=i&&i.length>0&&e.push.apply(e,i)},n.prototype.prepareDefines=function(e,t,n){this.isEnabled&&this.getCustomShaderMaterial().prepareCustomDefines(e)},n.prototype.bindForSubMesh=function(e,t,n,i){this.isEnabled&&this.getCustomShaderMaterial().updateCustomBindings(e)},n.prototype.WGSL_FormatTerrainVertexDefintions=function(e){var t="";return null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0&&(t="\r\n#define TERRAIN_VERTEX_DEFINITIONS\r\n\r\nvarying vSplatmapUV: vec2<f32>;\r\n\r\n"),t},n.prototype.WGSL_FormatTerrainVertexMainEnd=function(e){var t="";return null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0&&(t="\r\n#define TERRAIN_VERTEX_MAIN_END\r\n\r\n#ifdef UV1\r\nvertexOutputs.vSplatmapUV = uvUpdated;\r\n#endif\r\n\r\n"),t},n.prototype.WGSL_FormatTerrainFragmentDefintions=function(e,t,n,i){var o="";return null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0&&(o="\r\n#define TERRAIN_FRAGMENT_DEFNITIONS\r\n\r\nvarying vSplatmapUV: vec2<f32>;\r\nvar "+t+":texture_2d<f32>;\r\nvar "+t+"Sampler: sampler;\r\nvar "+n+":texture_2d<f32>;\r\nvar "+n+"Sampler: sampler;\r\nvar "+i+":texture_2d<f32>;\r\nvar "+i+"Sampler: sampler;\r\n\r\nfn srgb_to_linear(c: vec3<f32>) -> vec3<f32>\r\n{\r\n    return pow(c, vec3<f32>(2.2));\r\n}\r\n\r\nfn linear_to_srgb(c: vec3<f32>) -> vec3<f32>\r\n{\r\n    return pow(c, vec3<f32>(1.0 / 2.2));\r\n}\r\n\r\nfn calculateMipmapLevel(uvs: vec2<f32>, size: vec2<f32>) -> f32\r\n{\r\n    let dx: vec2<f32> = dpdx(uvs * size.x);\r\n    let dy: vec2<f32> = dpdy(uvs * size.y);\r\n    let d: f32 = max(dot(dx, dx), dot(dy, dy));\r\n    return (0.4 * log2(d));\r\n}\r\n\r\nfn sampleTextureAtlas2D(atlas: texture_2d<f32>, sampler: sampler, gamma: f32, tile: vec2<f32>, rect: vec4<f32>, uvs: vec2<f32>, lod: f32) -> vec4<f32>\r\n{\r\n    var level: f32 = lod;\r\n    if (level < 0.0) {\r\n        level = clamp(calculateMipmapLevel(uvs, vec2(tile.x, tile.x)), 0.0, tile.y);\r\n    }\r\n    let size: f32 = pow(2.0, tile.y - level);\r\n    let sizex: f32 = size / rect.z;\r\n    let sizey: f32 = size / rect.w;\r\n    var uv: vec2<f32> = fract(uvs);\r\n    uv.x = uv.x * ((sizex * rect.z - 1.0) / sizex) + 0.5 / sizex + rect.z * rect.x;\r\n    uv.y = uv.y * ((sizey * rect.w - 1.0) / sizey) + 0.5 / sizey + rect.w * rect.y;\r\n    var color: vec4<f32> = textureSampleLevel(atlas, sampler, uv, level);\r\n    if (gamma != 1.0) {\r\n        color.r = pow(color.r, gamma);\r\n        color.g = pow(color.g, gamma);\r\n        color.b = pow(color.b, gamma);\r\n    }\r\n    return color;\r\n}\r\n\r\nfn sampleSplatmapAtlas2D(atlas: texture_2d<f32>, sampler: sampler, tile: vec2<f32>, rect: vec4<f32>, uvs: vec2<f32>) -> vec4<f32>\r\n{\r\n    let size: f32 = pow(2.0, tile.y);\r\n\t   let sizex: f32 = size / rect.z;\r\n\t   let sizey: f32 = size / rect.w;\r\n\t   var uv: vec2<f32> = uvs;\r\n\t   uv.x = uv.x * ((sizex * rect.z - 1.0) / sizex) + 0.5 / sizex + rect.z * rect.x;\r\n\t   uv.y = uv.y * ((sizey * rect.w - 1.0) / sizey) + 0.5 / sizey + rect.w * rect.y;\r\n    return textureSample(atlas, sampler, uv);\r\n}\r\n\r\nfn blendSplatmapAtlasColors(splatmap: vec4<f32>, color1: vec4<f32>, color2: vec4<f32>, color3: vec4<f32>, color4: vec4<f32>, mixbuffer: vec3<f32>) -> vec3<f32>\r\n{\r\n    let buffer1: vec3<f32> = mix(mixbuffer, color1.rgb, splatmap.r);\r\n    let buffer2: vec3<f32> = mix(buffer1, color2.rgb, splatmap.g);\r\n    let buffer3: vec3<f32> = mix(buffer2, color3.rgb, splatmap.b);\r\n    return mix(buffer3, color4.rgb, splatmap.a);\r\n}\r\n\r\nfn perturbNormalSamplerColor(cotangentFrame: mat3x3<f32>, samplerColor: vec3<f32>, scale: f32) -> vec3<f32>\r\n{\r\n    var map: vec3<f32> = samplerColor.xyz;\r\n    map = map * 2.00787402 - 1.00787402;\r\n    #ifdef NORMALXYSCALE\r\n        map = normalize(map * vec3<f32>(scale, scale, 1.0));\r\n    #endif\r\n    return normalize(cotangentFrame * map);\r\n}\r\n\r\n\r\n"),o},n.prototype.WGSL_FormatTerrainFragmentUpdateColor=function(e,t,n,i,o,r){void 0===r&&(r=1);var a="";if(null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0){if(a="\r\n#define TERRAIN_FRAGMENT_UPDATE_COLOR\r\n\r\nvar normalsColor: vec3<f32> = vec3<f32>(0.5, 0.5, 1.0);\r\nvar normalsBuffer: vec3<f32> = normalW.rgb;\r\nvar splatmapBuffer: vec3<f32> = "+t+".rgb;\r\nvar autoMipMapLevel: f32 = -1.0;\r\nvar normalCorrection: f32 = 1.0;\r\nvar detailCorrection: f32 = "+r.toFixed(4)+";\r\n\r\n#if defined(ALBEDO) && defined("+n.toUpperCase()+") && defined("+i.toUpperCase()+")\r\n\r\n// Reset Normal Values\r\n#if defined(BUMP) || defined(PARALLAX) || defined(ANISOTROPIC)\r\n    uvOffset = vec2<f32>(0.0, 0.0);\r\n    #ifdef NORMAL\r\n        normalW = normalize(input.vNormalW);\r\n    #else\r\n        normalW = normalize(cross(dpdx(input.vPositionW), dpdy(input.vPositionW))) * scene.vEyePosition.w;\r\n    #endif\r\n    #ifdef CLEARCOAT\r\n        clearCoatNormalW = normalW;\r\n    #endif\r\n    #if defined(BUMP) || defined(PARALLAX)\r\n        #if defined(CLEARCOAT_BUMP) && defined(TANGENT) && defined(NORMAL)\r\n            TBN = vTBN;\r\n        #else\r\n            TBN = cotangent_frame(normalW, input.vPositionW, fragmentInputs.vSplatmapUV, vec2<f32>(1.0, 1.0));\r\n        #endif\r\n    #elif defined(ANISOTROPIC)\r\n        #if defined(CLEARCOAT_BUMP) && defined(TANGENT) && defined(NORMAL)\r\n            TBN = vTBN;\r\n        #else\r\n            TBN = cotangent_frame(normalW, input.vPositionW, fragmentInputs.vSplatmapUV, vec2<f32>(1.0, 1.0));\r\n        #endif\r\n    #endif\r\n    #ifdef PARALLAX\r\n        invTBN = transposeMat3(TBN);\r\n    #endif\r\n    normalW = perturbNormalSamplerColor(TBN, normalsColor, 1.0);\r\n#endif\r\n\r\n// Global Atlas Values\r\nlet splatTileSize: f32 = "+e.splatmapAtlas[2].toFixed(4)+";\r\nlet splatTileBits: f32 = "+e.splatmapAtlas[3].toFixed(4)+";\r\nlet detailTileSize: f32 = "+e.textureAtlas[2].toFixed(4)+";\r\nlet detailTileBits: f32 = "+e.textureAtlas[3].toFixed(4)+";\r\n\r\n// Sample splatmap textures\r\n",e.splatmapCount>0){var l=0;a+="normalsBuffer = vec3<f32>(0.0,0.0,0.0);\r\n";for(var s=0;s<e.splatmapCount;s++){l=4*s;var u=e["splatmapRect"+s];if(a+="var splatmapRect"+s+": vec4<f32> = vec4<f32>("+u[0].toFixed(4)+", "+u[1].toFixed(4)+", "+u[2].toFixed(4)+", "+u[3].toFixed(4)+");\r\n",a+="var splatmapAlbedo"+s+": vec4<f32> = sampleSplatmapAtlas2D("+n+", "+n+"Sampler, vec2<f32>(splatTileSize, splatTileBits), splatmapRect"+s+", (fragmentInputs.vSplatmapUV + uvOffset));\r\n",a+="var textureAlbedo"+(l+0)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",a+="var textureAlbedo"+(l+1)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",a+="var textureAlbedo"+(l+2)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",a+="var textureAlbedo"+(l+3)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",e["textureRect"+(l+0)]){var c=e["textureRect"+(l+0)],d=e["textureInfo"+(l+0)];a+="var textureRect"+(l+0)+": vec4<f32> = vec4<f32>("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="var textureScale"+(l+0)+": vec2<f32> = vec2<f32>("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="var textureOffset"+(l+0)+": vec2<f32> = vec2<f32>("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="var textureTileUV"+(l+0)+": vec2<f32> = ((fragmentInputs.vSplatmapUV + textureOffset"+(l+0)+") * textureScale"+(l+0)+");\r\n",a+="textureAlbedo"+(l+0)+" = sampleTextureAtlas2D("+i+", "+i+"Sampler, detailCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+0)+", textureTileUV"+(l+0)+", autoMipMapLevel);\r\n"}e["textureRect"+(l+1)]&&(c=e["textureRect"+(l+1)],d=e["textureInfo"+(l+1)],a+="var textureRect"+(l+1)+": vec4<f32> = vec4<f32>("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="var textureScale"+(l+1)+": vec2<f32> = vec2<f32>("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="var textureOffset"+(l+1)+": vec2<f32> = vec2<f32>("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="var textureTileUV"+(l+1)+": vec2<f32> = ((fragmentInputs.vSplatmapUV + textureOffset"+(l+1)+") * textureScale"+(l+1)+");\r\n",a+="textureAlbedo"+(l+1)+" = sampleTextureAtlas2D("+i+", "+i+"Sampler, detailCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+1)+", textureTileUV"+(l+1)+", autoMipMapLevel);\r\n"),e["textureRect"+(l+2)]&&(c=e["textureRect"+(l+2)],d=e["textureInfo"+(l+2)],a+="var textureRect"+(l+2)+": vec4<f32> = vec4<f32>("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="var textureScale"+(l+2)+": vec2<f32> = vec2<f32>("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="var textureOffset"+(l+2)+": vec2<f32> = vec2<f32>("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="var textureTileUV"+(l+2)+": vec2<f32> = ((fragmentInputs.vSplatmapUV + textureOffset"+(l+2)+") * textureScale"+(l+2)+");\r\n",a+="textureAlbedo"+(l+2)+" = sampleTextureAtlas2D("+i+", "+i+"Sampler, detailCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+2)+", textureTileUV"+(l+2)+", autoMipMapLevel);\r\n"),e["textureRect"+(l+3)]&&(c=e["textureRect"+(l+3)],d=e["textureInfo"+(l+3)],a+="var textureRect"+(l+3)+": vec4<f32> = vec4<f32>("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="var textureScale"+(l+3)+": vec2<f32> = vec2<f32>("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="var textureOffset"+(l+3)+": vec2<f32> = vec2<f32>("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="var textureTileUV"+(l+3)+": vec2<f32> = ((fragmentInputs.vSplatmapUV + textureOffset"+(l+3)+") * textureScale"+(l+3)+");\r\n",a+="textureAlbedo"+(l+3)+" = sampleTextureAtlas2D("+i+", "+i+"Sampler, detailCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+3)+", textureTileUV"+(l+3)+", autoMipMapLevel);\r\n"),a+="splatmapBuffer = blendSplatmapAtlasColors(splatmapAlbedo"+s+", textureAlbedo"+(l+0)+", textureAlbedo"+(l+1)+", textureAlbedo"+(l+2)+", textureAlbedo"+(l+3)+", splatmapBuffer);\r\n",a+="#if defined(BUMP) || defined(PARALLAX) || defined(ANISOTROPIC)\r\n",a+="    #if defined("+o.toUpperCase()+")\r\n",a+="        var normalColor"+(l+0)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",a+="        var normalColor"+(l+1)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",a+="        var normalColor"+(l+2)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",a+="        var normalColor"+(l+3)+": vec4<f32> = vec4<f32>(0.0, 0.0, 0.0, 1.0);\r\n",e["textureRect"+(l+0)]&&(a+="        var normalScale"+(l+0)+": f32 = "+e["normalsScale"+(l+0)].toFixed(4)+";\r\n",a+="        normalColor"+(l+0)+" = sampleTextureAtlas2D("+o+", "+o+"Sampler, normalCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+0)+", textureTileUV"+(l+0)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+0)+" = vec4<f32>(perturbNormalSamplerColor(TBN, normalColor"+(l+0)+".rgb, normalScale"+(l+0)+"), 1.0);\r\n"),e["textureRect"+(l+1)]&&(a+="        var normalScale"+(l+1)+": f32 = "+e["normalsScale"+(l+1)].toFixed(4)+";\r\n",a+="        normalColor"+(l+1)+" = sampleTextureAtlas2D("+o+", "+o+"Sampler, normalCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+1)+", textureTileUV"+(l+1)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+1)+" = vec4<f32>(perturbNormalSamplerColor(TBN, normalColor"+(l+1)+".rgb, normalScale"+(l+1)+"), 1.0);\r\n"),e["textureRect"+(l+2)]&&(a+="        var normalScale"+(l+2)+": f32 = "+e["normalsScale"+(l+2)].toFixed(4)+";\r\n",a+="        normalColor"+(l+2)+" = sampleTextureAtlas2D("+o+", "+o+"Sampler, normalCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+2)+", textureTileUV"+(l+2)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+2)+" = vec4<f32>(perturbNormalSamplerColor(TBN, normalColor"+(l+2)+".rgb, normalScale"+(l+2)+"), 1.0);\r\n"),e["textureRect"+(l+3)]&&(a+="        var normalScale"+(l+3)+": f32 = "+e["normalsScale"+(l+3)].toFixed(4)+";\r\n",a+="        normalColor"+(l+3)+" = sampleTextureAtlas2D("+o+", "+o+"Sampler, normalCorrection, vec2<f32>(detailTileSize, detailTileBits), textureRect"+(l+3)+", textureTileUV"+(l+3)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+3)+" = vec4<f32>(perturbNormalSamplerColor(TBN, normalColor"+(l+3)+".rgb, normalScale"+(l+3)+"), 1.0);\r\n"),a+="        normalsBuffer = blendSplatmapAtlasColors(splatmapAlbedo"+s+", normalColor"+(l+0)+", normalColor"+(l+1)+", normalColor"+(l+2)+", normalColor"+(l+3)+", normalsBuffer);\r\n",a+="    #endif\r\n",a+="#endif\r\n",a+="\r\n"}}a+="// Update Color Values\r\n"+t+" = splatmapBuffer.rgb;\r\n#if defined(BUMP) || defined(PARALLAX) || defined(ANISOTROPIC)\r\n    #if defined("+o.toUpperCase()+")\r\n        normalW = normalsBuffer.rgb;\r\n    #endif\r\n    #if defined(FORCENORMALFORWARD) && defined(NORMAL)\r\n        var faceNormal: vec3<f32> = normalize(cross(dpdx(input.vPositionW), dpdy(input.vPositionW))) * scene.vEyePosition.w;\r\n        #if defined(TWOSIDEDLIGHTING)\r\n            faceNormal = select(-faceNormal, faceNormal, fragmentInputs.frontFacing)\r\n        #endif\r\n        normalW *= sign(dot(normalW, faceNormal));\r\n    #endif\r\n    #if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\r\n        normalW = select(-normalW, normalW, fragmentInputs.frontFacing);\r\n    #endif\r\n#endif\r\n\r\n#endif\r\n\r\n"}return a},n.prototype.GLSL_FormatTerrainVertexDefintions=function(e){var t="";return null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0&&(t="\r\n#define TERRAIN_VERTEX_DEFINITIONS\r\n\r\nvarying vec2 vSplatmapUV;\r\n\r\n"),t},n.prototype.GLSL_FormatTerrainVertexMainEnd=function(e){var t="";return null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0&&(t="\r\n#define TERRAIN_VERTEX_MAIN_END\r\n\r\n#ifdef UV1\r\nvSplatmapUV = uv;\r\n#endif\r\n\r\n"),t},n.prototype.GLSL_FormatTerrainFragmentDefintions=function(e,t,n,i){var o="";return null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0&&(o="\r\n#define TERRAIN_FRAGMENT_DEFNITIONS\r\n\r\nvarying vec2 vSplatmapUV;\r\nuniform sampler2D "+t+";\r\nuniform sampler2D "+n+";\r\nuniform sampler2D "+i+";\r\n\r\nvec3 srgb_to_linear(const in vec3 c)\r\n{\r\n    return pow(c, vec3(2.2));\r\n}\r\n\r\nvec3 linear_to_srgb(const in vec3 c)\r\n{\r\n    return pow(c, vec3(1.0 / 2.2));\r\n}\r\n\r\nfloat calculateMipmapLevel(const in vec2 uvs, const in vec2 size)\r\n{\r\n    vec2 dx = dFdx(uvs * size.x);\r\n    vec2 dy = dFdy(uvs * size.y);\r\n    float d = max(dot(dx, dx), dot(dy, dy));\r\n    return 0.4 * log2(d);\r\n}\r\n\r\nvec4 sampleTextureAtlas2D(const in sampler2D atlas, const in float gamma, const in vec2 tile, const in vec4 rect, in vec2 uvs, in float lod)\r\n{\r\n    if (lod < 0.0) lod = clamp(calculateMipmapLevel(uvs, vec2(tile.x, tile.x)), 0.0, tile.y);   // Tile Info (tile.xy)\r\n    float size = pow(2.0, tile.y - lod);                                                        // Tile Bits (tile.y)\r\n    float sizex = size / rect.z;                                                                // Tile Width (rect.z)\r\n    float sizey = size / rect.w;                                                                // Tile Height (rect.w)\r\n    uvs = fract(uvs);                                                                           // Perfrom Tiling (fract)\r\n    uvs.x = uvs.x * ((sizex * rect.z - 1.0) / sizex) + 0.5 / sizex + rect.z * rect.x;           // Tile Position X (rect.x)\r\n    uvs.y = uvs.y * ((sizey * rect.w - 1.0) / sizey) + 0.5 / sizey + rect.w * rect.y;           // Tile Position Y (rect.y)\r\n    vec4 color = texture2DLodEXT(atlas, uvs, lod);\r\n    if (gamma != 1.0) {\r\n        color.r = pow(color.r, gamma);\r\n        color.g = pow(color.g, gamma);\r\n        color.b = pow(color.b, gamma);\r\n    }\r\n    return color;\r\n}\r\n\r\nvec4 sampleSplatmapAtlas2D(const in sampler2D atlas, const in vec2 tile, const in vec4 rect, in vec2 uvs)\r\n{\r\n    float size = pow(2.0, tile.y);                                                              // Tile Bits (tile.y)\r\n\t   float sizex = size / rect.z;                                                                // Tile Width (rect.z)\r\n\t   float sizey = size / rect.w;                                                                // Tile Height (rect.w)\r\n\t   uvs.x = uvs.x * ((sizex * rect.z - 1.0) / sizex) + 0.5 / sizex + rect.z * rect.x;           // Tile Position X (rect.x)\r\n\t   uvs.y = uvs.y * ((sizey * rect.w - 1.0) / sizey) + 0.5 / sizey + rect.w * rect.y;           // Tile Position Y (rect.y)\r\n    return texture2D(atlas, uvs);\r\n}\r\n\r\nvec3 blendSplatmapAtlasColors(const in vec4 splatmap, in vec4 color1, in vec4 color2, in vec4 color3, in vec4 color4, in vec3 mixbuffer)\r\n{\r\n    vec3 buffer1 = mix(mixbuffer, color1.rgb, splatmap.r);\r\n    vec3 buffer2 = mix(buffer1, color2.rgb, splatmap.g);\r\n    vec3 buffer3 = mix(buffer2, color3.rgb, splatmap.b);\r\n    return mix(buffer3, color4.rgb, splatmap.a);\r\n}\r\n\r\nvec3 perturbNormalSamplerColor(mat3 cotangentFrame, vec3 samplerColor, float scale)\r\n{\r\n    vec3 map = samplerColor.xyz;\r\n    map = map * 2.00787402 - 1.00787402;\r\n    #ifdef NORMALXYSCALE\r\n        map = normalize(map * vec3(scale, scale, 1.0));\r\n    #endif\r\n    return normalize(cotangentFrame * map);\r\n}\r\n\r\n\r\n"),o},n.prototype.GLSL_FormatTerrainFragmentUpdateColor=function(e,t,n,i,o,r){void 0===r&&(r=1);var a="";if(null!=e&&null!=e.textureAtlas&&null!=e.splatmapAtlas&&e.splatmapCount>0){if(a="\r\n#define TERRAIN_FRAGMENT_UPDATE_COLOR\r\n\r\nvec3 normalsColor = vec3(0.5, 0.5, 1.0);\r\nvec3 normalsBuffer = normalW.rgb;\r\nvec3 splatmapBuffer = "+t+".rgb;\r\nfloat autoMipMapLevel = -1.0;\r\nfloat normalCorrection = 1.0;\r\nfloat detailCorrection = "+r.toFixed(4)+";\r\n\r\n#if defined(ALBEDO) && defined("+n.toUpperCase()+") && defined("+i.toUpperCase()+")\r\n\r\n// Reset Normal Values\r\n#if defined(BUMP) || defined(PARALLAX) || defined(ANISOTROPIC)\r\n    uvOffset = vec2(0.0, 0.0);\r\n    #ifdef NORMAL\r\n        normalW = normalize(vNormalW);\r\n    #else\r\n        normalW = normalize(cross(dFdx(vPositionW), dFdy(vPositionW))) * vEyePosition.w;\r\n    #endif\r\n    #ifdef CLEARCOAT\r\n        clearCoatNormalW = normalW;\r\n    #endif\r\n    #if defined(BUMP) || defined(PARALLAX)\r\n        #if defined(TANGENT) && defined(NORMAL)\r\n            TBN = vTBN;\r\n        #else\r\n            TBN = cotangent_frame(normalW, vPositionW, vSplatmapUV);\r\n        #endif\r\n    #elif defined(ANISOTROPIC)\r\n        #if defined(TANGENT) && defined(NORMAL)\r\n            TBN = vTBN;\r\n        #else\r\n            TBN = cotangent_frame(normalW, vPositionW, vSplatmapUV, vec2(1.0, 1.0));\r\n        #endif\r\n    #endif\r\n    #ifdef PARALLAX\r\n        invTBN = transposeMat3(TBN);\r\n    #endif\r\n    normalW = perturbNormalSamplerColor(TBN, normalsColor, 1.0);\r\n#endif\r\n\r\n// Global Atlas Values\r\nfloat splatTileSize = "+e.splatmapAtlas[2].toFixed(4)+";\r\nfloat splatTileBits = "+e.splatmapAtlas[3].toFixed(4)+";\r\nfloat detailTileSize = "+e.textureAtlas[2].toFixed(4)+";\r\nfloat detailTileBits = "+e.textureAtlas[3].toFixed(4)+";\r\n\r\n// Sample splatmap textures\r\n",e.splatmapCount>0){var l=0;a+="normalsBuffer = vec3(0.0,0.0,0.0);\r\n";for(var s=0;s<e.splatmapCount;s++){l=4*s;var u=e["splatmapRect"+s];if(a+="vec4 splatmapRect"+s+" = vec4("+u[0].toFixed(4)+", "+u[1].toFixed(4)+", "+u[2].toFixed(4)+", "+u[3].toFixed(4)+");\r\n",a+="vec4 splatmapAlbedo"+s+" = sampleSplatmapAtlas2D("+n+", vec2(splatTileSize, splatTileBits), splatmapRect"+s+", (vSplatmapUV + uvOffset));\r\n",a+="vec4 textureAlbedo"+(l+0)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",a+="vec4 textureAlbedo"+(l+1)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",a+="vec4 textureAlbedo"+(l+2)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",a+="vec4 textureAlbedo"+(l+3)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",e["textureRect"+(l+0)]){var c=e["textureRect"+(l+0)],d=e["textureInfo"+(l+0)];a+="vec4 textureRect"+(l+0)+" = vec4("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="vec2 textureScale"+(l+0)+" = vec2("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="vec2 textureOffset"+(l+0)+" = vec2("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="vec2 textureTileUV"+(l+0)+" = ((vSplatmapUV + textureOffset"+(l+0)+") * textureScale"+(l+0)+");\r\n",a+="textureAlbedo"+(l+0)+" = sampleTextureAtlas2D("+i+", detailCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+0)+", textureTileUV"+(l+0)+", autoMipMapLevel);\r\n"}e["textureRect"+(l+1)]&&(c=e["textureRect"+(l+1)],d=e["textureInfo"+(l+1)],a+="vec4 textureRect"+(l+1)+" = vec4("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="vec2 textureScale"+(l+1)+" = vec2("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="vec2 textureOffset"+(l+1)+" = vec2("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="vec2 textureTileUV"+(l+1)+" = ((vSplatmapUV + textureOffset"+(l+1)+") * textureScale"+(l+1)+");\r\n",a+="textureAlbedo"+(l+1)+" = sampleTextureAtlas2D("+i+", detailCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+1)+", textureTileUV"+(l+1)+", autoMipMapLevel);\r\n"),e["textureRect"+(l+2)]&&(c=e["textureRect"+(l+2)],d=e["textureInfo"+(l+2)],a+="vec4 textureRect"+(l+2)+" = vec4("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="vec2 textureScale"+(l+2)+" = vec2("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="vec2 textureOffset"+(l+2)+" = vec2("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="vec2 textureTileUV"+(l+2)+" = ((vSplatmapUV + textureOffset"+(l+2)+") * textureScale"+(l+2)+");\r\n",a+="textureAlbedo"+(l+2)+" = sampleTextureAtlas2D("+i+", detailCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+2)+", textureTileUV"+(l+2)+", autoMipMapLevel);\r\n"),e["textureRect"+(l+3)]&&(c=e["textureRect"+(l+3)],d=e["textureInfo"+(l+3)],a+="vec4 textureRect"+(l+3)+" = vec4("+c[0].toFixed(4)+", "+c[1].toFixed(4)+", "+c[2].toFixed(4)+", "+c[3].toFixed(4)+");\r\n",a+="vec2 textureScale"+(l+3)+" = vec2("+d[0].toFixed(4)+", "+d[1].toFixed(4)+");\r\n",a+="vec2 textureOffset"+(l+3)+" = vec2("+d[2].toFixed(4)+", "+d[3].toFixed(4)+");\r\n",a+="vec2 textureTileUV"+(l+3)+" = ((vSplatmapUV + textureOffset"+(l+3)+") * textureScale"+(l+3)+");\r\n",a+="textureAlbedo"+(l+3)+" = sampleTextureAtlas2D("+i+", detailCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+3)+", textureTileUV"+(l+3)+", autoMipMapLevel);\r\n"),a+="splatmapBuffer = blendSplatmapAtlasColors(splatmapAlbedo"+s+", textureAlbedo"+(l+0)+", textureAlbedo"+(l+1)+", textureAlbedo"+(l+2)+", textureAlbedo"+(l+3)+", splatmapBuffer);\r\n",a+="#if defined(BUMP) || defined(PARALLAX) || defined(ANISOTROPIC)\r\n",a+="    #if defined("+o.toUpperCase()+")\r\n",a+="        vec4 normalColor"+(l+0)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",a+="        vec4 normalColor"+(l+1)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",a+="        vec4 normalColor"+(l+2)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",a+="        vec4 normalColor"+(l+3)+" = vec4(0.0, 0.0, 0.0, 1.0);\r\n",e["textureRect"+(l+0)]&&(a+="        float normalScale"+(l+0)+" = "+e["normalsScale"+(l+0)].toFixed(4)+";\r\n",a+="        normalColor"+(l+0)+" = sampleTextureAtlas2D("+o+", normalCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+0)+", textureTileUV"+(l+0)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+0)+".rgb = perturbNormalSamplerColor(TBN, normalColor"+(l+0)+".rgb, normalScale"+(l+0)+");\r\n"),e["textureRect"+(l+1)]&&(a+="        float normalScale"+(l+1)+" = "+e["normalsScale"+(l+1)].toFixed(4)+";\r\n",a+="        normalColor"+(l+1)+" = sampleTextureAtlas2D("+o+", normalCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+1)+", textureTileUV"+(l+1)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+1)+".rgb = perturbNormalSamplerColor(TBN, normalColor"+(l+1)+".rgb, normalScale"+(l+1)+");\r\n"),e["textureRect"+(l+2)]&&(a+="        float normalScale"+(l+2)+" = "+e["normalsScale"+(l+2)].toFixed(4)+";\r\n",a+="        normalColor"+(l+2)+" = sampleTextureAtlas2D("+o+", normalCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+2)+", textureTileUV"+(l+2)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+2)+".rgb = perturbNormalSamplerColor(TBN, normalColor"+(l+2)+".rgb, normalScale"+(l+2)+");\r\n"),e["textureRect"+(l+3)]&&(a+="        float normalScale"+(l+3)+" = "+e["normalsScale"+(l+3)].toFixed(4)+";\r\n",a+="        normalColor"+(l+3)+" = sampleTextureAtlas2D("+o+", normalCorrection, vec2(detailTileSize, detailTileBits), textureRect"+(l+3)+", textureTileUV"+(l+3)+", autoMipMapLevel);\r\n",a+="        normalColor"+(l+3)+".rgb = perturbNormalSamplerColor(TBN, normalColor"+(l+3)+".rgb, normalScale"+(l+3)+");\r\n"),a+="        normalsBuffer = blendSplatmapAtlasColors(splatmapAlbedo"+s+", normalColor"+(l+0)+", normalColor"+(l+1)+", normalColor"+(l+2)+", normalColor"+(l+3)+", normalsBuffer);\r\n",a+="    #endif\r\n",a+="#endif\r\n",a+="\r\n"}}a+="// Update Color Values\r\n"+t+" = splatmapBuffer.rgb;\r\n#if defined(BUMP) || defined(PARALLAX) || defined(ANISOTROPIC)\r\n    #if defined("+o.toUpperCase()+")\r\n        normalW = normalsBuffer.rgb;\r\n    #endif\r\n    #if defined(FORCENORMALFORWARD) && defined(NORMAL)\r\n        vec3 faceNormal = normalize(cross(dFdx(vPositionW), dFdy(vPositionW))) * vEyePosition.w;\r\n        #if defined(TWOSIDEDLIGHTING)\r\n            faceNormal = gl_FrontFacing ? faceNormal : -faceNormal;\r\n        #endif\r\n        normalW *= sign(dot(normalW, faceNormal));\r\n    #endif\r\n    #if defined(TWOSIDEDLIGHTING) && defined(NORMAL)\r\n        normalW = gl_FrontFacing ? normalW : -normalW;\r\n    #endif\r\n#endif\r\n\r\n#endif\r\n\r\n"}return a},n}(e.CustomShaderMaterialPlugin);e.UniversalTerrainMaterialPlugin=n}(i||(i={})),function(e){var t,n,i,o;(o=e.DragDirection||(e.DragDirection={}))[o.None=0]="None",o[o.Up=1]="Up",o[o.Down=2]="Down",o[o.Right=3]="Right",o[o.Left=4]="Left",(i=e.PinchZoomState||(e.PinchZoomState={}))[i.None=0]="None",i[i.ZoomIn=1]="ZoomIn",i[i.ZoomOut=2]="ZoomOut",(n=e.MouseButtonMode||(e.MouseButtonMode={}))[n.Pan=0]="Pan",n[n.Look=1]="Look",n[n.Move=2]="Move",(t=e.TouchMouseButton||(e.TouchMouseButton={}))[t.Any=-1]="Any",t[t.Left=0]="Left",t[t.Right=1]="Right";var r=function(){function t(){}return t.GetMouseButtonsDown=function(){return e.InputController.mouseButtonsDown},t.GetLeftButtonDown=function(){return e.InputController.leftButtonDown},t.GetMiddleButtonDown=function(){return e.InputController.middleButtonDown},t.GetRightButtonDown=function(){return e.InputController.rightButtonDown},t.GetMouseDownTarget=function(){return e.InputController.mouseDownTarget},t.GetMouseDragTarget=function(){return e.InputController.mouseDragTarget},t.GetPinchZoomState=function(){return e.InputController.pinchZoomState},t.EnableUserInput=function(t,n,i){void 0===i&&(i=null),e.InputController.ConfigureUserInput(t,n,i)},t.ConfigureUserInput=function(t,n,i){void 0===i&&(i=null);var o=null==i||null==i.contextMenu||i.contextMenu,r=null!=i&&null!=i.pointerLock&&i.pointerLock,a=null!=i&&null!=i.preventDefault&&i.preventDefault,l=null!=i&&null!=i.useCapture&&i.useCapture;if(e.InputController.resetUserInput(),!e.InputController.input){document.documentElement.tabIndex=1,document.documentElement.addEventListener("keyup",e.InputController.inputKeyUpHandler,l),document.documentElement.addEventListener("pointerup",e.InputController.inputPointerUpHandler,l),document.documentElement.addEventListener("pointerout",e.InputController.inputPointerUpHandler,l),document.documentElement.addEventListener("pointerleave",e.InputController.inputPointerUpHandler,l),document.documentElement.addEventListener("pointercancel",e.InputController.inputPointerUpHandler,l);var s=document.getElementById("renderingCanvas")||t.getRenderingCanvas();null!=s&&(s.oncontextmenu=!0===o?null:function(e){e.preventDefault(),e.stopPropagation()}),!0===e.UserInputOptions.UseCanvasElement?(s.tabIndex=2,s.addEventListener("focusout",e.InputController.resetKeyMapHandler,l),s.addEventListener("keydown",e.InputController.inputKeyDownHandler,l),s.addEventListener("pointerdown",e.InputController.inputPointerDownHandler,l),s.addEventListener("pointermove",e.InputController.inputPointerMoveHandler,l),s.addEventListener("onwheel"in document?"wheel":"mousewheel",e.InputController.inputPointerWheelHandler,l)):(document.documentElement.addEventListener("focusout",e.InputController.resetKeyMapHandler,l),document.documentElement.addEventListener("keydown",e.InputController.inputKeyDownHandler,l),document.documentElement.addEventListener("pointerdown",e.InputController.inputPointerDownHandler,l),document.documentElement.addEventListener("pointermove",e.InputController.inputPointerMoveHandler,l),document.documentElement.addEventListener("onwheel"in document?"wheel":"mousewheel",e.InputController.inputPointerWheelHandler,l)),e.InputController.preventDefault=a,null==e.InputController.GamepadManager&&(e.InputController.GamepadManager=new BABYLON.GamepadManager,e.InputController.GamepadManager.onGamepadConnectedObservable.add(e.InputController.inputManagerGamepadConnected),e.InputController.GamepadManager.onGamepadDisconnectedObservable.add(e.InputController.inputManagerGamepadDisconnected)),e.InputController.input=!0,document.documentElement.focus(),!0===r&&e.InputController.LockMousePointer(n,!0)}n.registerAfterRender(function(){e.InputController.updateUserInput(n)})},t.SetLeftJoystickBuffer=function(t,n,i){void 0===i&&(i=!0),e.InputController.j_horizontal=t,e.InputController.j_vertical=!0===i?-n:n},t.SetRightJoystickBuffer=function(t,n,i){void 0===i&&(i=!0),e.InputController.j_mousex=t,e.InputController.j_mousey=!0===i?-n:n},t.DisableUserInput=function(t,n){void 0===n&&(n=!1),e.InputController.LockMousePointer(t,!1),e.InputController.resetUserInput()},t.LockMousePointer=function(t,n){!0===n?e.InputController.LockMousePointerObserver=t.onPointerObservable.add(function(n,i){var o;n.type==BABYLON.PointerEventTypes.POINTERDOWN&&(document.pointerLockElement||null===(o=e.SceneManager.GetEngine(t))||void 0===o||o.enterPointerlock())}):e.InputController.IsPointerLockHandled()&&(t.onPointerObservable.remove(e.InputController.LockMousePointerObserver),e.InputController.LockMousePointerObserver=null)},t.IsPointerLocked=function(){return e.InputController.PointerLockedFlag},t.IsPointerLockHandled=function(){return null!=e.InputController.LockMousePointerObserver},t.GetUserInput=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=0;if(e.InputController.input)switch(t){case e.UserInputAxis.Vertical:case e.UserInputAxis.Horizontal:i=n===e.PlayerNumber.Four?t===e.UserInputAxis.Horizontal?e.InputController.horizontal4:e.InputController.vertical4:n===e.PlayerNumber.Three?t===e.UserInputAxis.Horizontal?e.InputController.horizontal3:e.InputController.vertical3:n===e.PlayerNumber.Two?t===e.UserInputAxis.Horizontal?e.InputController.horizontal2:e.InputController.vertical2:t===e.UserInputAxis.Horizontal?e.InputController.horizontal:e.InputController.vertical;break;case e.UserInputAxis.MouseX:case e.UserInputAxis.MouseY:i=n===e.PlayerNumber.Four?t===e.UserInputAxis.MouseX?e.InputController.mousex4:e.InputController.mousey4:n===e.PlayerNumber.Three?t===e.UserInputAxis.MouseX?e.InputController.mousex3:e.InputController.mousey3:n===e.PlayerNumber.Two?t===e.UserInputAxis.MouseX?e.InputController.mousex2:e.InputController.mousey2:t===e.UserInputAxis.MouseX?e.InputController.mousex:e.InputController.mousey;break;case e.UserInputAxis.Wheel:n===e.PlayerNumber.One&&(i=e.InputController.wheel)}return i},t.OnKeyboardUp=function(t){e.InputController.input&&e.InputController.keyButtonUp.push(t)},t.OnKeyboardDown=function(t){e.InputController.input&&e.InputController.keyButtonDown.push(t)},t.OnKeyboardPress=function(t,n){e.InputController.input&&e.InputController.keyButtonPress.push({index:t,action:n})},t.GetKeyboardInput=function(t){var n=!1;if(e.InputController.input){var i="k:"+t.toString();if(null!=e.InputController.keymap[i]){var o=e.InputController.keymap[i];n=null!=o.result&&o.result}}return n},t.IsKeyboardButtonHeld=function(t){var n=!1;if(e.InputController.input){var i="k:"+t.toString();if(null!=e.InputController.keymap[i]){var o=e.InputController.keymap[i];null!=o.pressTime&&null!=o.releaseTime&&!0===(null!=o.result&&o.result)&&o.pressTime>0&&0===o.releaseTime&&(n=e.SceneManager.GetTimeMs()-o.pressTime>=e.InputController.TAP_THRESHOLD_MS)}}return n},t.WasKeyboardButtonTapped=function(t,n){void 0===n&&(n=!0);var i=!1;if(e.InputController.input){var o="k:"+t.toString();if(null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!1===(null!=r.result&&r.result)&&r.pressTime>0&&r.releaseTime>0&&(i=r.releaseTime-r.pressTime<e.InputController.TAP_THRESHOLD_MS)}!0===n&&e.InputController.ResetKeyboardButtonTapped(t)}return i},t.ResetKeyboardButtonTapped=function(t){if(e.InputController.input){var n="k:"+t.toString();null!=e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0})}},t.OnPointerUp=function(t){e.InputController.input&&e.InputController.mouseButtonUp.push(t)},t.OnPointerDown=function(t){e.InputController.input&&e.InputController.mouseButtonDown.push(t)},t.OnPointerPress=function(t,n){e.InputController.input&&e.InputController.mouseButtonPress.push({index:t,action:n})},t.GetPointerInput=function(t){var n=!1;if(e.InputController.input){var i="p:"+t.toString();if(null!=e.InputController.keymap[i]){var o=e.InputController.keymap[i];n=null!=o.result&&o.result}}return n},t.IsPointerButtonHeld=function(t){var n=!1;if(e.InputController.input){var i="p:"+t.toString();if(null!=e.InputController.keymap[i]){var o=e.InputController.keymap[i];null!=o.pressTime&&null!=o.releaseTime&&!0===(null!=o.result&&o.result)&&o.pressTime>0&&0===o.releaseTime&&(n=e.SceneManager.GetTimeMs()-o.pressTime>=e.InputController.TAP_THRESHOLD_MS)}}return n},t.WasPointerButtonTapped=function(t,n){void 0===n&&(n=!0);var i=!1;if(e.InputController.input){var o="p:"+t.toString();if(null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!1===(null!=r.result&&r.result)&&r.pressTime>0&&r.releaseTime>0&&(i=r.releaseTime-r.pressTime<e.InputController.TAP_THRESHOLD_MS)}!0===n&&e.InputController.ResetPointerButtonTapped(t)}return i},t.ResetPointerButtonTapped=function(t){if(e.InputController.input){var n="p:"+t.toString();null!=e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0})}},t.GetPointerDragDirection=function(t,n,i){return!0===i?0===t&&0===n||(Math.abs(t)>Math.abs(n)?t>0?e.InputController.dragDirection=e.DragDirection.Right:t<0&&(e.InputController.dragDirection=e.DragDirection.Left):n>0?e.InputController.dragDirection=e.DragDirection.Up:n<0&&(e.InputController.dragDirection=e.DragDirection.Down)):e.InputController.dragDirection=e.DragDirection.None,e.InputController.dragDirection},t.ResetPinchZoomTracking=function(){e.InputController.pinchZoomState=0,e.InputController.pinchZoomEvents=[],e.InputController.pinchZoomDistance=null},t.GetMousePosition=function(t,n){void 0===n&&(n=!1);var i=e.InputController.IsPointerLocked(),o=i?e.InputController.virtualClientX:e.InputController.lastClientX||0,r=i?e.InputController.virtualClientY:e.InputController.lastClientY||0,a=t.getEngine().getRenderingCanvas();if(a){var l=a.getBoundingClientRect(),s=o-l.left,u=r-l.top;if(!0===n){var c=l.height-u;e.InputController.LastMousePosition.set(s,c,0)}else e.InputController.LastMousePosition.set(s,u,0);return e.InputController.LastMousePosition}return!0===n?e.InputController.LastMousePosition.set(o,window.innerHeight-r,0):e.InputController.LastMousePosition.set(o,r,0),e.InputController.LastMousePosition},t.IsWheelScrolling=function(){return 0!==e.InputController.scroll},t.OnGamepadButtonUp=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input)switch(n){case e.PlayerNumber.One:e.InputController.gamepad1ButtonUp.push(t);break;case e.PlayerNumber.Two:e.InputController.gamepad2ButtonUp.push(t);break;case e.PlayerNumber.Three:e.InputController.gamepad3ButtonUp.push(t);break;case e.PlayerNumber.Four:e.InputController.gamepad4ButtonUp.push(t)}},t.OnGamepadButtonDown=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input)switch(n){case e.PlayerNumber.One:e.InputController.gamepad1ButtonDown.push(t);break;case e.PlayerNumber.Two:e.InputController.gamepad2ButtonDown.push(t);break;case e.PlayerNumber.Three:e.InputController.gamepad3ButtonDown.push(t);break;case e.PlayerNumber.Four:e.InputController.gamepad4ButtonDown.push(t)}},t.OnGamepadButtonPress=function(t,n,i){if(void 0===i&&(i=e.PlayerNumber.One),e.InputController.input)switch(i){case e.PlayerNumber.One:e.InputController.gamepad1ButtonPress.push({index:t,action:n});break;case e.PlayerNumber.Two:e.InputController.gamepad2ButtonPress.push({index:t,action:n});break;case e.PlayerNumber.Three:e.InputController.gamepad3ButtonPress.push({index:t,action:n});break;case e.PlayerNumber.Four:e.InputController.gamepad4ButtonPress.push({index:t,action:n})}},t.GetGamepadButtonInput=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="b1:"+t.toString();break;case e.PlayerNumber.Two:o="b2:"+t.toString();break;case e.PlayerNumber.Three:o="b3:"+t.toString();break;case e.PlayerNumber.Four:o="b4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];i=null!=r.result&&r.result}}return i},t.IsGamepadButtonHeld=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="b1:"+t.toString();break;case e.PlayerNumber.Two:o="b2:"+t.toString();break;case e.PlayerNumber.Three:o="b3:"+t.toString();break;case e.PlayerNumber.Four:o="b4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!0===(null!=r.result&&r.result)&&r.pressTime>0&&0===r.releaseTime&&(i=e.SceneManager.GetTimeMs()-r.pressTime>=e.InputController.TAP_THRESHOLD_MS)}}return i},t.IsGamepadButtonTapped=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="b1:"+t.toString();break;case e.PlayerNumber.Two:o="b2:"+t.toString();break;case e.PlayerNumber.Three:o="b3:"+t.toString();break;case e.PlayerNumber.Four:o="b4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!1===(null!=r.result&&r.result)&&r.pressTime>0&&r.releaseTime>0&&(i=r.releaseTime-r.pressTime<e.InputController.TAP_THRESHOLD_MS)}}return i},t.ResetGamepadButtonTapped=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input){var i=null;switch(n){case e.PlayerNumber.One:i="b1:"+t.toString();break;case e.PlayerNumber.Two:i="b2:"+t.toString();break;case e.PlayerNumber.Three:i="b3:"+t.toString();break;case e.PlayerNumber.Four:i="b4:"+t.toString()}null!=i&&null!=e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0})}},t.OnGamepadDirectionUp=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input)switch(n){case e.PlayerNumber.One:e.InputController.gamepad1DpadUp.push(t);break;case e.PlayerNumber.Two:e.InputController.gamepad2DpadUp.push(t);break;case e.PlayerNumber.Three:e.InputController.gamepad3DpadUp.push(t);break;case e.PlayerNumber.Four:e.InputController.gamepad4DpadUp.push(t)}},t.OnGamepadDirectionDown=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input)switch(n){case e.PlayerNumber.One:e.InputController.gamepad1DpadDown.push(t);break;case e.PlayerNumber.Two:e.InputController.gamepad2DpadDown.push(t);break;case e.PlayerNumber.Three:e.InputController.gamepad3DpadDown.push(t);break;case e.PlayerNumber.Four:e.InputController.gamepad4DpadDown.push(t)}},t.OnGamepadDirectionPress=function(t,n,i){if(void 0===i&&(i=e.PlayerNumber.One),e.InputController.input)switch(i){case e.PlayerNumber.One:e.InputController.gamepad1DpadPress.push({index:t,action:n});break;case e.PlayerNumber.Two:e.InputController.gamepad2DpadPress.push({index:t,action:n});break;case e.PlayerNumber.Three:e.InputController.gamepad3DpadPress.push({index:t,action:n});break;case e.PlayerNumber.Four:e.InputController.gamepad4DpadPress.push({index:t,action:n})}},t.GetGamepadDirectionInput=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="d1:"+t.toString();break;case e.PlayerNumber.Two:o="d2:"+t.toString();break;case e.PlayerNumber.Three:o="d3:"+t.toString();break;case e.PlayerNumber.Four:o="d4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];i=null!=r.result&&r.result}}return i},t.IsGamepadDirectionHeld=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="d1:"+t.toString();break;case e.PlayerNumber.Two:o="d2:"+t.toString();break;case e.PlayerNumber.Three:o="d3:"+t.toString();break;case e.PlayerNumber.Four:o="d4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!0===(null!=r.result&&r.result)&&r.pressTime>0&&0===r.releaseTime&&(i=e.SceneManager.GetTimeMs()-r.pressTime>=e.InputController.TAP_THRESHOLD_MS)}}return i},t.IsGamepadDirectionTapped=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="d1:"+t.toString();break;case e.PlayerNumber.Two:o="d2:"+t.toString();break;case e.PlayerNumber.Three:o="d3:"+t.toString();break;case e.PlayerNumber.Four:o="d4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!1===(null!=r.result&&r.result)&&r.pressTime>0&&r.releaseTime>0&&(i=r.releaseTime-r.pressTime<e.InputController.TAP_THRESHOLD_MS)}}return i},t.ResetGamepadDirectionTapped=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input){var i=null;switch(n){case e.PlayerNumber.One:i="d1:"+t.toString();break;case e.PlayerNumber.Two:i="d2:"+t.toString();break;case e.PlayerNumber.Three:i="d3:"+t.toString();break;case e.PlayerNumber.Four:i="d4:"+t.toString()}null!=i&&null!=e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0})}},t.OnGamepadTriggerLeft=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input)switch(n){case e.PlayerNumber.One:e.InputController.gamepad1LeftTrigger.push(t);break;case e.PlayerNumber.Two:e.InputController.gamepad2LeftTrigger.push(t);break;case e.PlayerNumber.Three:e.InputController.gamepad3LeftTrigger.push(t);break;case e.PlayerNumber.Four:e.InputController.gamepad4LeftTrigger.push(t)}},t.OnGamepadTriggerRight=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input)switch(n){case e.PlayerNumber.One:e.InputController.gamepad1RightTrigger.push(t);break;case e.PlayerNumber.Two:e.InputController.gamepad2RightTrigger.push(t);break;case e.PlayerNumber.Three:e.InputController.gamepad3RightTrigger.push(t);break;case e.PlayerNumber.Four:e.InputController.gamepad4RightTrigger.push(t)}},t.GetGamepadTriggerInput=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=0;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="t1:"+t.toString();break;case e.PlayerNumber.Two:o="t2:"+t.toString();break;case e.PlayerNumber.Three:o="t3:"+t.toString();break;case e.PlayerNumber.Four:o="t4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];i=null!=r.result?r.result:0}}return i},t.IsGamepadTriggerHeld=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="t1:"+t.toString();break;case e.PlayerNumber.Two:o="t2:"+t.toString();break;case e.PlayerNumber.Three:o="t3:"+t.toString();break;case e.PlayerNumber.Four:o="t4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!0===(null!=r.result&&r.result)&&r.pressTime>0&&0===r.releaseTime&&(i=e.SceneManager.GetTimeMs()-r.pressTime>=e.InputController.TAP_THRESHOLD_MS)}}return i},t.IsGamepadTriggerTapped=function(t,n){void 0===n&&(n=e.PlayerNumber.One);var i=!1;if(e.InputController.input){var o=null;switch(n){case e.PlayerNumber.One:o="t1:"+t.toString();break;case e.PlayerNumber.Two:o="t2:"+t.toString();break;case e.PlayerNumber.Three:o="t3:"+t.toString();break;case e.PlayerNumber.Four:o="t4:"+t.toString()}if(null!=o&&null!=e.InputController.keymap[o]){var r=e.InputController.keymap[o];null!=r.pressTime&&null!=r.releaseTime&&!1===(null!=r.result&&r.result)&&r.pressTime>0&&r.releaseTime>0&&(i=r.releaseTime-r.pressTime<e.InputController.TAP_THRESHOLD_MS)}}return i},t.ResetGamepadTriggerTapped=function(t,n){if(void 0===n&&(n=e.PlayerNumber.One),e.InputController.input){var i=null;switch(n){case e.PlayerNumber.One:i="t1:"+t.toString();break;case e.PlayerNumber.Two:i="t2:"+t.toString();break;case e.PlayerNumber.Three:i="t3:"+t.toString();break;case e.PlayerNumber.Four:i="t4:"+t.toString()}null!=i&&null!=e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0})}},t.GetGamepadType=function(t){void 0===t&&(t=e.PlayerNumber.One);var n=e.GamepadType.None;if(e.InputController.input)switch(t){case e.PlayerNumber.One:n=e.InputController.gamepad1Type;break;case e.PlayerNumber.Two:n=e.InputController.gamepad2Type;break;case e.PlayerNumber.Three:n=e.InputController.gamepad3Type;break;case e.PlayerNumber.Four:n=e.InputController.gamepad4Type}return n},t.GetGamepad=function(t){void 0===t&&(t=e.PlayerNumber.One);var n=null;if(e.InputController.input)switch(t){case e.PlayerNumber.One:n=e.InputController.gamepad1;break;case e.PlayerNumber.Two:n=e.InputController.gamepad2;break;case e.PlayerNumber.Three:n=e.InputController.gamepad3;break;case e.PlayerNumber.Four:n=e.InputController.gamepad4}return n},t.InputKeyDownHandler=function(t,n){if(void 0===n&&(n=null),null==t||!1===e.SceneManager.EnableUserInput)return!1;n&&n.preventDefault();var i="k:"+t.toString(),o=!1;if(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]){var r=e.InputController.keymap[i];!1===(o=null!=r.result&&r.result)&&(r.result=!0,r.pressTime=e.SceneManager.GetTimeMs(),r.releaseTime=0)}return null!=e.InputController.keyButtonDown&&e.InputController.keyButtonDown.length>0&&e.InputController.keyButtonDown.forEach(function(e){e(t)}),o||null!=e.InputController.keyButtonPress&&e.InputController.keyButtonPress.length>0&&e.InputController.keyButtonPress.forEach(function(e){e.index===t&&e.action()}),!0},t.InputKeyUpHandler=function(t,n){if(void 0===n&&(n=null),null==t||!1===e.SceneManager.EnableUserInput)return!1;var i="k:"+t.toString();if(null!=e.InputController.keymap[i]){var o=e.InputController.keymap[i];!0===(null!=o.result&&o.result)&&(o.result=!1,o.releaseTime=e.SceneManager.GetTimeMs())}return null!=e.InputController.keyButtonUp&&e.InputController.keyButtonUp.length>0&&e.InputController.keyButtonUp.forEach(function(e){e(t)}),!0},t.tickKeyboardInput=function(t){if(!1!==e.SceneManager.EnableUserInput){var n=e.InputController.GetKeyboardInput(e.UserInputKey.W)||e.InputController.GetKeyboardInput(e.UserInputKey.UpArrow),i=e.InputController.GetKeyboardInput(e.UserInputKey.A),o=e.InputController.GetKeyboardInput(e.UserInputKey.S)||e.InputController.GetKeyboardInput(e.UserInputKey.DownArrow),r=e.InputController.GetKeyboardInput(e.UserInputKey.D),a=e.InputController.GetKeyboardInput(e.UserInputKey.LeftArrow),l=e.InputController.GetKeyboardInput(e.UserInputKey.RightArrow);e.InputController.k_vertical=!0===n?e.Utilities.GetKeyboardInputValue(t,e.InputController.k_vertical,1):!0===o?e.Utilities.GetKeyboardInputValue(t,e.InputController.k_vertical,-1):0,!0===e.UserInputOptions.UseArrowKeyRotation?(e.InputController.k_horizontal=!0===r?e.Utilities.GetKeyboardInputValue(t,e.InputController.k_horizontal,1):!0===i?e.Utilities.GetKeyboardInputValue(t,e.InputController.k_horizontal,-1):0,e.InputController.a_mousex=!0===l?1*e.UserInputOptions.KeyboardArrowSensibility:!0===a?-1*e.UserInputOptions.KeyboardArrowSensibility:0):e.InputController.k_horizontal=!0===r||!0===l?e.Utilities.GetKeyboardInputValue(t,e.InputController.k_horizontal,1):!0===i||!0===a?e.Utilities.GetKeyboardInputValue(t,e.InputController.k_horizontal,-1):0}},t.updateUserInput=function(t){var n=e.InputController.GetMouseButtonsDown();e.InputController.leftButtonDown=!(1&~n),e.InputController.middleButtonDown=!(4&~n),e.InputController.rightButtonDown=!(2&~n),!1!==e.SceneManager.EnableUserInput&&(e.InputController.PointerLockedFlag=t.getEngine().isPointerLock,e.InputController.tickKeyboardInput(t),e.InputController.x_horizontal=0,e.InputController.x_vertical=0,e.InputController.x_mousex=0,e.InputController.x_mousey=0,0!==e.InputController.j_horizontal?e.InputController.x_horizontal=e.InputController.j_horizontal:0!==e.InputController.g_horizontal1?e.InputController.x_horizontal=e.InputController.g_horizontal1:0!==e.InputController.k_horizontal&&(e.InputController.x_horizontal=e.InputController.k_horizontal),0!==e.InputController.j_vertical?e.InputController.x_vertical=e.InputController.j_vertical:0!==e.InputController.g_vertical1?e.InputController.x_vertical=e.InputController.g_vertical1:0!==e.InputController.k_vertical&&(e.InputController.x_vertical=e.InputController.k_vertical),0!==e.InputController.j_mousex?e.InputController.x_mousex=e.InputController.j_mousex:0!==e.InputController.g_mousex1?e.InputController.x_mousex=e.InputController.g_mousex1:0!==e.InputController.a_mousex?e.InputController.x_mousex=e.InputController.a_mousex:0!==e.InputController.k_mousex&&(e.InputController.x_mousex=e.InputController.k_mousex),0!==e.InputController.j_mousey?e.InputController.x_mousey=e.InputController.j_mousey:0!==e.InputController.g_mousey1?e.InputController.x_mousey=e.InputController.g_mousey1:0!==e.InputController.k_mousey&&(e.InputController.x_mousey=e.InputController.k_mousey),e.InputController.horizontal=e.InputController.x_horizontal,e.InputController.vertical=e.InputController.x_vertical,e.InputController.mousex=e.InputController.x_mousex,e.InputController.mousey=e.InputController.x_mousey,e.InputController.scroll=e.InputController.x_scroll,e.InputController.wheel=e.InputController.x_wheel,e.InputController.horizontal2=e.InputController.g_horizontal2,e.InputController.vertical2=e.InputController.g_vertical2,e.InputController.mousex2=e.InputController.g_mousex2,e.InputController.mousey2=e.InputController.g_mousey2,e.InputController.horizontal3=e.InputController.g_horizontal3,e.InputController.vertical3=e.InputController.g_vertical3,e.InputController.mousex3=e.InputController.g_mousex3,e.InputController.mousey3=e.InputController.g_mousey3,e.InputController.horizontal4=e.InputController.g_horizontal4,e.InputController.vertical4=e.InputController.g_vertical4,e.InputController.mousex4=e.InputController.g_mousex4,e.InputController.mousey4=e.InputController.g_mousey4,e.InputController.k_mousex=0,e.InputController.k_mousey=0,e.InputController.x_mousey=0,e.InputController.x_scroll=0)},t.resetUserInput=function(){e.InputController.input=!1,e.InputController.keymap={},e.InputController.scroll=0,e.InputController.wheel=0,e.InputController.mousex=0,e.InputController.mousey=0,e.InputController.vertical=0,e.InputController.horizontal=0,e.InputController.mousex2=0,e.InputController.mousey2=0,e.InputController.vertical2=0,e.InputController.horizontal2=0,e.InputController.mousex3=0,e.InputController.mousey3=0,e.InputController.vertical3=0,e.InputController.horizontal3=0,e.InputController.mousex4=0,e.InputController.mousey4=0,e.InputController.vertical4=0,e.InputController.horizontal4=0,e.InputController.a_mousex=0,e.InputController.x_scroll=0,e.InputController.x_wheel=0,e.InputController.x_mousex=0,e.InputController.x_mousey=0,e.InputController.x_vertical=0,e.InputController.x_horizontal=0,e.InputController.k_mousex=0,e.InputController.k_mousey=0,e.InputController.k_vertical=0,e.InputController.k_horizontal=0,e.InputController.j_mousex=0,e.InputController.j_mousey=0,e.InputController.j_vertical=0,e.InputController.j_horizontal=0,e.InputController.g_mousex1=0,e.InputController.g_mousey1=0,e.InputController.g_vertical1=0,e.InputController.g_horizontal1=0,e.InputController.g_mousex2=0,e.InputController.g_mousey2=0,e.InputController.g_vertical2=0,e.InputController.g_horizontal2=0,e.InputController.g_mousex3=0,e.InputController.g_mousey3=0,e.InputController.g_vertical3=0,e.InputController.g_horizontal3=0,e.InputController.g_mousex4=0,e.InputController.g_mousey4=0,e.InputController.g_vertical4=0,e.InputController.g_horizontal4=0,e.InputController.dragDirection=0,e.InputController.pinchZoomState=0,e.InputController.pinchZoomEvents=[],e.InputController.pinchZoomDistance=null,e.InputController.preventDefault=!1,e.InputController.leftButtonDown=!1,e.InputController.middleButtonDown=!1,e.InputController.rightButtonDown=!1,e.InputController.mouseDownTarget=null,e.InputController.mouseDragTarget=null,e.InputController.mouseButtonsDown=0,e.InputController.mouseButtonUp=[],e.InputController.mouseButtonDown=[],e.InputController.mouseButtonPress=[],e.InputController.keyButtonUp=[],e.InputController.keyButtonDown=[],e.InputController.keyButtonPress=[],e.InputController.gamepad1ButtonUp=[],e.InputController.gamepad1ButtonDown=[],e.InputController.gamepad1ButtonPress=[],e.InputController.gamepad1DpadUp=[],e.InputController.gamepad1DpadDown=[],e.InputController.gamepad1DpadPress=[],e.InputController.gamepad1LeftTrigger=[],e.InputController.gamepad1RightTrigger=[],e.InputController.gamepad2ButtonUp=[],e.InputController.gamepad2ButtonDown=[],e.InputController.gamepad2ButtonPress=[],e.InputController.gamepad2DpadUp=[],e.InputController.gamepad2DpadDown=[],e.InputController.gamepad2DpadPress=[],e.InputController.gamepad2LeftTrigger=[],e.InputController.gamepad2RightTrigger=[],e.InputController.gamepad3ButtonUp=[],e.InputController.gamepad3ButtonDown=[],e.InputController.gamepad3ButtonPress=[],e.InputController.gamepad3DpadUp=[],e.InputController.gamepad3DpadDown=[],e.InputController.gamepad3DpadPress=[],e.InputController.gamepad3LeftTrigger=[],e.InputController.gamepad3RightTrigger=[],e.InputController.gamepad4ButtonUp=[],e.InputController.gamepad4ButtonDown=[],e.InputController.gamepad4ButtonPress=[],e.InputController.gamepad4DpadUp=[],e.InputController.gamepad4DpadDown=[],e.InputController.gamepad4DpadPress=[],e.InputController.gamepad4LeftTrigger=[],e.InputController.gamepad4RightTrigger=[],e.InputController.previousPosition=null,e.InputController.lastClientX=0,e.InputController.lastClientY=0,e.InputController.virtualClientX=0,e.InputController.virtualClientY=0},t.resetKeyMapHandler=function(t){e.InputController.keymap={}},t.getPinchZoomDistance=function(e,t){var n=t.clientX-e.clientX,i=t.clientY-e.clientY;return Math.sqrt(n*n+i*i)},t.cachePinchZoomPointer=function(t){!0===e.InputController.EnablePinchZoomTracking&&e.InputController.pinchZoomEvents.push(t)},t.removePinchZoomPointer=function(t){if(!0===e.InputController.EnablePinchZoomTracking){for(var n=0;n<e.InputController.pinchZoomEvents.length;n++)if(e.InputController.pinchZoomEvents[n].pointerId===t.pointerId){e.InputController.pinchZoomEvents.splice(n,1);break}e.InputController.pinchZoomEvents.length<2&&(e.InputController.pinchZoomDistance=null)}},t.processPinchZoomTracking=function(t){if(!0===e.InputController.EnablePinchZoomTracking){for(var n=0;n<e.InputController.pinchZoomEvents.length;n++)if(e.InputController.pinchZoomEvents[n].pointerId===t.pointerId){e.InputController.pinchZoomEvents[n]=t;break}if(e.InputController.pinchZoomState=e.PinchZoomState.None,2===e.InputController.pinchZoomEvents.length){var i=e.InputController.getPinchZoomDistance(e.InputController.pinchZoomEvents[0],e.InputController.pinchZoomEvents[1]);i!==e.InputController.pinchZoomDistance&&(i>e.InputController.pinchZoomDistance?e.InputController.pinchZoomState=e.PinchZoomState.ZoomIn:i<e.InputController.pinchZoomDistance&&(e.InputController.pinchZoomState=e.PinchZoomState.ZoomOut),e.InputController.pinchZoomDistance=i)}}},t.inputKeyDownHandler=function(t){return e.InputController.InputKeyDownHandler(t.keyCode,t)},t.inputKeyUpHandler=function(t){return e.InputController.InputKeyUpHandler(t.keyCode,t)},t.inputPointerWheelHandler=function(t){if(!1===e.SceneManager.EnableUserInput)return!1;var n=t.deltaY?-t.deltaY:t.wheelDelta/40;return e.InputController.x_scroll=1,e.InputController.x_wheel=Math.abs(n)>e.UserInputOptions.PointerWheelDeadZone?0+n:0,e.InputController.preventDefault&&t.preventDefault(),!0},t.inputPointerDownHandler=function(t){if(e.InputController.mouseDownTarget=t.target,e.InputController.mouseButtonsDown=t.buttons,e.InputController.lastClientX=t.clientX||0,e.InputController.lastClientY=t.clientY||0,e.InputController.virtualClientX=e.InputController.lastClientX,e.InputController.virtualClientY=e.InputController.lastClientY,e.InputController.cachePinchZoomPointer(t),!1===e.SceneManager.EnableUserInput)return!1;e.InputController.previousPosition={x:t.clientX,y:t.clientY};var n="p:"+t.button.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}return null!=e.InputController.mouseButtonDown&&e.InputController.mouseButtonDown.length>0&&e.InputController.mouseButtonDown.forEach(function(e){e(t.button)}),i||null!=e.InputController.mouseButtonPress&&e.InputController.mouseButtonPress.length>0&&e.InputController.mouseButtonPress.forEach(function(e){e.index===t.button&&e.action()}),e.InputController.preventDefault&&t.preventDefault(),!0},t.inputPointerUpHandler=function(t){if(e.InputController.mouseDownTarget=null,e.InputController.mouseDragTarget=null,e.InputController.mouseButtonsDown=t.buttons,e.InputController.lastClientX=t.clientX||0,e.InputController.lastClientY=t.clientY||0,e.InputController.virtualClientX=e.InputController.lastClientX,e.InputController.virtualClientY=e.InputController.lastClientY,e.InputController.removePinchZoomPointer(t),!1===e.SceneManager.EnableUserInput)return!1;e.InputController.previousPosition=null,e.InputController.k_mousex=0,e.InputController.k_mousey=0;var n="p:"+t.button.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}return null!=e.InputController.mouseButtonUp&&e.InputController.mouseButtonUp.length>0&&e.InputController.mouseButtonUp.forEach(function(e){e(t.button)}),e.InputController.preventDefault&&t.preventDefault(),!0},t.inputPointerMoveHandler=function(t){if(e.InputController.mouseDragTarget=t.target,e.InputController.mouseButtonsDown=t.buttons,e.InputController.lastClientX=t.clientX||0,e.InputController.lastClientY=t.clientY||0,e.InputController.IsPointerLocked()){var n=t.movementX||t.mozMovementX||t.webkitMovementX||t.msMovementX||0,i=t.movementY||t.mozMovementY||t.webkitMovementY||t.msMovementY||0;e.InputController.virtualClientX+=n,e.InputController.virtualClientY+=i}else e.InputController.virtualClientX=e.InputController.lastClientX,e.InputController.virtualClientY=e.InputController.lastClientY;if(e.InputController.processPinchZoomTracking(t),!1===e.SceneManager.EnableUserInput)return!1;if(!1===e.SceneManager.VirtualJoystickEnabled){var o=0,r=0;if(e.InputController.IsPointerLocked()?(o=t.movementX||t.mozMovementX||t.webkitMovementX||t.msMovementX||0,r=t.movementY||t.mozMovementY||t.webkitMovementY||t.msMovementY||0,e.InputController.previousPosition=null):null!=e.InputController.previousPosition&&(o=t.clientX-e.InputController.previousPosition.x,r=t.clientY-e.InputController.previousPosition.y,e.InputController.previousPosition={x:t.clientX,y:t.clientY}),!0===e.UserInputOptions.PointerMouseInverted&&(o*=-1,r*=-1),!0===e.InputController.rightHanded&&(o*=-1),!0===e.UserInputOptions.EnableBabylonRotation)e.InputController.k_mousex=o/e.UserInputOptions.BabylonAngularSensibility,e.InputController.k_mousey=r/e.UserInputOptions.BabylonAngularSensibility;else{var a=o*e.UserInputOptions.DefaultAngularSensibility*e.InputController.MOUSE_DAMPENER,l=r*e.UserInputOptions.DefaultAngularSensibility*e.InputController.MOUSE_DAMPENER;Math.abs(o)<=e.UserInputOptions.PointerMouseDeadZone&&(a=0),Math.abs(r)<=e.UserInputOptions.PointerMouseDeadZone&&(l=0),e.InputController.k_mousex+=a,e.InputController.k_mousey+=l,e.InputController.k_mousex=BABYLON.Scalar.Clamp(e.InputController.k_mousex,-1,1),e.InputController.k_mousey=BABYLON.Scalar.Clamp(e.InputController.k_mousey,-1,1)}}return e.InputController.preventDefault&&t.preventDefault(),!0},t.inputOneButtonDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n="b1:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad1ButtonDown&&e.InputController.gamepad1ButtonDown.length>0&&e.InputController.gamepad1ButtonDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad1ButtonPress&&e.InputController.gamepad1ButtonPress.length>0&&e.InputController.gamepad1ButtonPress.forEach(function(e){e.index===t&&e.action()})}},t.inputOneButtonUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n="b1:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad1ButtonUp&&e.InputController.gamepad1ButtonUp.length>0&&e.InputController.gamepad1ButtonUp.forEach(function(e){e(t)})}},t.inputOneXboxDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n="d1:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad1DpadDown&&e.InputController.gamepad1DpadDown.length>0&&e.InputController.gamepad1DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad1DpadPress&&e.InputController.gamepad1DpadPress.length>0&&e.InputController.gamepad1DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputOneShockDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n="d1:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad1DpadDown&&e.InputController.gamepad1DpadDown.length>0&&e.InputController.gamepad1DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad1DpadPress&&e.InputController.gamepad1DpadPress.length>0&&e.InputController.gamepad1DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputOneXboxDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n="d1:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad1DpadUp&&e.InputController.gamepad1DpadUp.length>0&&e.InputController.gamepad1DpadUp.forEach(function(e){e(t)})}},t.inputOneShockDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n="d1:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad1DpadUp&&e.InputController.gamepad1DpadUp.length>0&&e.InputController.gamepad1DpadUp.forEach(function(e){e(t)})}},t.inputOneXboxLeftTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n,i="t1:0";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad1LeftTrigger&&e.InputController.gamepad1LeftTrigger.length>0&&e.InputController.gamepad1LeftTrigger.forEach(function(e){e(t)})}},t.inputOneXboxRightTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n,i="t1:1";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad1RightTrigger&&e.InputController.gamepad1RightTrigger.length>0&&e.InputController.gamepad1RightTrigger.forEach(function(e){e(t)})}},t.inputOneLeftStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n=t,i=n.x*e.UserInputOptions.GamepadLStickSensibility,o=n.y*e.UserInputOptions.GamepadLStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_horizontal1=e.UserInputOptions.GamepadLStickXInverted?-n.x:n.x,e.InputController.g_vertical1=e.UserInputOptions.GamepadLStickYInverted?n.y:-n.y}},t.inputOneRightStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad1){var n=t,i=n.x*e.UserInputOptions.GamepadRStickSensibility,o=n.y*e.UserInputOptions.GamepadRStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_mousex1=e.UserInputOptions.GamepadRStickXInverted?-n.x:n.x,e.InputController.g_mousey1=e.UserInputOptions.GamepadRStickYInverted?-n.y:n.y}},t.inputTwoButtonDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n="b2:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad2ButtonDown&&e.InputController.gamepad2ButtonDown.length>0&&e.InputController.gamepad2ButtonDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad2ButtonPress&&e.InputController.gamepad2ButtonPress.length>0&&e.InputController.gamepad2ButtonPress.forEach(function(e){e.index===t&&e.action()})}},t.inputTwoButtonUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n="b2:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad2ButtonUp&&e.InputController.gamepad2ButtonUp.length>0&&e.InputController.gamepad2ButtonUp.forEach(function(e){e(t)})}},t.inputTwoXboxDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n="d2:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad2DpadDown&&e.InputController.gamepad2DpadDown.length>0&&e.InputController.gamepad2DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad2DpadPress&&e.InputController.gamepad2DpadPress.length>0&&e.InputController.gamepad2DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputTwoShockDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n="d2:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad2DpadDown&&e.InputController.gamepad2DpadDown.length>0&&e.InputController.gamepad2DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad2DpadPress&&e.InputController.gamepad2DpadPress.length>0&&e.InputController.gamepad2DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputTwoXboxDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n="d2:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad2DpadUp&&e.InputController.gamepad2DpadUp.length>0&&e.InputController.gamepad2DpadUp.forEach(function(e){e(t)})}},t.inputTwoShockDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n="d2:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad2DpadUp&&e.InputController.gamepad2DpadUp.length>0&&e.InputController.gamepad2DpadUp.forEach(function(e){e(t)})}},t.inputTwoXboxLeftTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n,i="t2:0";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad2LeftTrigger&&e.InputController.gamepad2LeftTrigger.length>0&&e.InputController.gamepad2LeftTrigger.forEach(function(e){e(t)})}},t.inputTwoXboxRightTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n,i="t2:1";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad2RightTrigger&&e.InputController.gamepad2RightTrigger.length>0&&e.InputController.gamepad2RightTrigger.forEach(function(e){e(t)})}},t.inputTwoLeftStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n=t,i=n.x*e.UserInputOptions.GamepadLStickSensibility,o=n.y*e.UserInputOptions.GamepadLStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_horizontal2=e.UserInputOptions.GamepadLStickXInverted?-n.x:n.x,e.InputController.g_vertical2=e.UserInputOptions.GamepadLStickYInverted?n.y:-n.y}},t.inputTwoRightStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad2){var n=t,i=n.x*e.UserInputOptions.GamepadRStickSensibility,o=n.y*e.UserInputOptions.GamepadRStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_mousex2=e.UserInputOptions.GamepadRStickXInverted?-n.x:n.x,e.InputController.g_mousey2=e.UserInputOptions.GamepadRStickYInverted?-n.y:n.y}},t.inputThreeButtonDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n="b3:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad3ButtonDown&&e.InputController.gamepad3ButtonDown.length>0&&e.InputController.gamepad3ButtonDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad3ButtonPress&&e.InputController.gamepad3ButtonPress.length>0&&e.InputController.gamepad3ButtonPress.forEach(function(e){e.index===t&&e.action()})}},t.inputThreeButtonUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n="b3:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad3ButtonUp&&e.InputController.gamepad3ButtonUp.length>0&&e.InputController.gamepad3ButtonUp.forEach(function(e){e(t)})}},t.inputThreeXboxDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n="d3:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad3DpadDown&&e.InputController.gamepad3DpadDown.length>0&&e.InputController.gamepad3DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad3DpadPress&&e.InputController.gamepad3DpadPress.length>0&&e.InputController.gamepad3DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputThreeShockDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n="d3:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad3DpadDown&&e.InputController.gamepad3DpadDown.length>0&&e.InputController.gamepad3DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad3DpadPress&&e.InputController.gamepad3DpadPress.length>0&&e.InputController.gamepad3DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputThreeXboxDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n="d3:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad3DpadUp&&e.InputController.gamepad3DpadUp.length>0&&e.InputController.gamepad3DpadUp.forEach(function(e){e(t)})}},t.inputThreeShockDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n="d3:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad3DpadUp&&e.InputController.gamepad3DpadUp.length>0&&e.InputController.gamepad3DpadUp.forEach(function(e){e(t)})}},t.inputThreeXboxLeftTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n,i="t3:0";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad3LeftTrigger&&e.InputController.gamepad3LeftTrigger.length>0&&e.InputController.gamepad3LeftTrigger.forEach(function(e){e(t)})}},t.inputThreeXboxRightTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n,i="t3:1";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad3RightTrigger&&e.InputController.gamepad3RightTrigger.length>0&&e.InputController.gamepad3RightTrigger.forEach(function(e){e(t)})}},t.inputThreeLeftStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n=t,i=n.x*e.UserInputOptions.GamepadLStickSensibility,o=n.y*e.UserInputOptions.GamepadLStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_horizontal3=e.UserInputOptions.GamepadLStickXInverted?-n.x:n.x,e.InputController.g_vertical3=e.UserInputOptions.GamepadLStickYInverted?n.y:-n.y}},t.inputThreeRightStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad3){var n=t,i=n.x*e.UserInputOptions.GamepadRStickSensibility,o=n.y*e.UserInputOptions.GamepadRStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_mousex3=e.UserInputOptions.GamepadRStickXInverted?-n.x:n.x,e.InputController.g_mousey3=e.UserInputOptions.GamepadRStickYInverted?-n.y:n.y}},t.inputFourButtonDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n="b4:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad4ButtonDown&&e.InputController.gamepad4ButtonDown.length>0&&e.InputController.gamepad4ButtonDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad4ButtonPress&&e.InputController.gamepad4ButtonPress.length>0&&e.InputController.gamepad4ButtonPress.forEach(function(e){e.index===t&&e.action()})}},t.inputFourButtonUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n="b4:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad4ButtonUp&&e.InputController.gamepad4ButtonUp.length>0&&e.InputController.gamepad4ButtonUp.forEach(function(e){e(t)})}},t.inputFourXboxDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n="d4:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad4DpadDown&&e.InputController.gamepad4DpadDown.length>0&&e.InputController.gamepad4DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad4DpadPress&&e.InputController.gamepad4DpadPress.length>0&&e.InputController.gamepad4DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputFourShockDPadDownHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n="d4:"+t.toString(),i=!1;if(null==e.InputController.keymap[n]&&(e.InputController.keymap[n]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[n]){var o=e.InputController.keymap[n];!1===(i=null!=o.result&&o.result)&&(o.result=!0,o.pressTime=e.SceneManager.GetTimeMs(),o.releaseTime=0)}null!=e.InputController.gamepad4DpadDown&&e.InputController.gamepad4DpadDown.length>0&&e.InputController.gamepad4DpadDown.forEach(function(e){e(t)}),i||null!=e.InputController.gamepad4DpadPress&&e.InputController.gamepad4DpadPress.length>0&&e.InputController.gamepad4DpadPress.forEach(function(e){e.index===t&&e.action()})}},t.inputFourXboxDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n="d4:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad4DpadUp&&e.InputController.gamepad4DpadUp.length>0&&e.InputController.gamepad4DpadUp.forEach(function(e){e(t)})}},t.inputFourShockDPadUpHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n="d4:"+t.toString();if(null!=e.InputController.keymap[n]){var i=e.InputController.keymap[n];!0===(null!=i.result&&i.result)&&(i.result=!1,i.releaseTime=e.SceneManager.GetTimeMs())}null!=e.InputController.gamepad4DpadUp&&e.InputController.gamepad4DpadUp.length>0&&e.InputController.gamepad4DpadUp.forEach(function(e){e(t)})}},t.inputFourXboxLeftTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n,i="t4:0";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad4LeftTrigger&&e.InputController.gamepad4LeftTrigger.length>0&&e.InputController.gamepad4LeftTrigger.forEach(function(e){e(t)})}},t.inputFourXboxRightTriggerHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n,i="t4:1";t>0?(null==e.InputController.keymap[i]&&(e.InputController.keymap[i]={result:!1,pressTime:0,releaseTime:0}),null!=e.InputController.keymap[i]&&!1===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!0,n.pressTime=e.SceneManager.GetTimeMs(),n.releaseTime=0)):null!=e.InputController.keymap[i]&&!0===(null!=(n=e.InputController.keymap[i]).result&&n.result)&&(n.result=!1,n.releaseTime=e.SceneManager.GetTimeMs()),null!=e.InputController.gamepad4RightTrigger&&e.InputController.gamepad4RightTrigger.length>0&&e.InputController.gamepad4RightTrigger.forEach(function(e){e(t)})}},t.inputFourLeftStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n=t,i=n.x*e.UserInputOptions.GamepadLStickSensibility,o=n.y*e.UserInputOptions.GamepadLStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_horizontal4=e.UserInputOptions.GamepadLStickXInverted?-n.x:n.x,e.InputController.g_vertical4=e.UserInputOptions.GamepadLStickYInverted?n.y:-n.y}},t.inputFourRightStickHandler=function(t){if(!1!==e.SceneManager.EnableUserInput&&null!=e.InputController.gamepad4){var n=t,i=n.x*e.UserInputOptions.GamepadRStickSensibility,o=n.y*e.UserInputOptions.GamepadRStickSensibility;n.x=Math.abs(i)>e.UserInputOptions.GamepadDeadStickValue?i:0,n.y=Math.abs(o)>e.UserInputOptions.GamepadDeadStickValue?o:0,n.x=BABYLON.Scalar.Clamp(n.x,-1,1),n.y=BABYLON.Scalar.Clamp(n.y,-1,1),e.InputController.g_mousex4=e.UserInputOptions.GamepadRStickXInverted?-n.x:n.x,e.InputController.g_mousey4=e.UserInputOptions.GamepadRStickYInverted?-n.y:n.y}},t.inputManagerGamepadConnected=function(t,n){if(null==e.InputController.gamepad1&&0===t.index)if(e.InputController.gamepad1=t,BABYLON.Tools.Log("Gamepad One Connected: "+e.InputController.gamepad1.id),e.InputController.gamepad1 instanceof BABYLON.Xbox360Pad){e.InputController.gamepad1Type=e.GamepadType.Xbox360;var i=e.InputController.gamepad1;i.onbuttonup(e.InputController.inputOneButtonUpHandler),i.onbuttondown(e.InputController.inputOneButtonDownHandler),i.onleftstickchanged(e.InputController.inputOneLeftStickHandler),i.onrightstickchanged(e.InputController.inputOneRightStickHandler),i.ondpadup(e.InputController.inputOneXboxDPadUpHandler),i.ondpaddown(e.InputController.inputOneXboxDPadDownHandler),i.onlefttriggerchanged(e.InputController.inputOneXboxLeftTriggerHandler),i.onrighttriggerchanged(e.InputController.inputOneXboxRightTriggerHandler)}else if(e.InputController.gamepad1 instanceof BABYLON.DualShockPad){e.InputController.gamepad1Type=e.GamepadType.DualShock;var o=e.InputController.gamepad1;o.onbuttonup(e.InputController.inputOneButtonUpHandler),o.onbuttondown(e.InputController.inputOneButtonDownHandler),o.onleftstickchanged(e.InputController.inputOneLeftStickHandler),o.onrightstickchanged(e.InputController.inputOneRightStickHandler),o.ondpadup(e.InputController.inputOneShockDPadUpHandler),o.ondpaddown(e.InputController.inputOneShockDPadDownHandler),o.onlefttriggerchanged(e.InputController.inputOneXboxLeftTriggerHandler),o.onrighttriggerchanged(e.InputController.inputOneXboxRightTriggerHandler)}else{e.InputController.gamepad1Type=e.GamepadType.Generic;var r=e.InputController.gamepad1;r.onbuttonup(e.InputController.inputOneButtonUpHandler),r.onbuttondown(e.InputController.inputOneButtonDownHandler),r.onleftstickchanged(e.InputController.inputOneLeftStickHandler),r.onrightstickchanged(e.InputController.inputOneRightStickHandler)}if(null==e.InputController.gamepad2&&1===t.index)if(e.InputController.gamepad2=t,BABYLON.Tools.Log("Gamepad Two Connected: "+e.InputController.gamepad2.id),e.InputController.gamepad2 instanceof BABYLON.Xbox360Pad){e.InputController.gamepad2Type=e.GamepadType.Xbox360;var a=e.InputController.gamepad2;a.onbuttonup(e.InputController.inputTwoButtonUpHandler),a.onbuttondown(e.InputController.inputTwoButtonDownHandler),a.onleftstickchanged(e.InputController.inputTwoLeftStickHandler),a.onrightstickchanged(e.InputController.inputTwoRightStickHandler),a.ondpadup(e.InputController.inputTwoXboxDPadUpHandler),a.ondpaddown(e.InputController.inputTwoXboxDPadDownHandler),a.onlefttriggerchanged(e.InputController.inputTwoXboxLeftTriggerHandler),a.onrighttriggerchanged(e.InputController.inputTwoXboxRightTriggerHandler)}else if(e.InputController.gamepad2 instanceof BABYLON.DualShockPad){e.InputController.gamepad2Type=e.GamepadType.DualShock;var l=e.InputController.gamepad2;l.onbuttonup(e.InputController.inputOneButtonUpHandler),l.onbuttondown(e.InputController.inputOneButtonDownHandler),l.onleftstickchanged(e.InputController.inputOneLeftStickHandler),l.onrightstickchanged(e.InputController.inputOneRightStickHandler),l.ondpadup(e.InputController.inputOneShockDPadUpHandler),l.ondpaddown(e.InputController.inputOneShockDPadDownHandler),l.onlefttriggerchanged(e.InputController.inputOneXboxLeftTriggerHandler),l.onrighttriggerchanged(e.InputController.inputOneXboxRightTriggerHandler)}else{e.InputController.gamepad2Type=e.GamepadType.Generic;var s=e.InputController.gamepad2;s.onbuttonup(e.InputController.inputTwoButtonUpHandler),s.onbuttondown(e.InputController.inputTwoButtonDownHandler),s.onleftstickchanged(e.InputController.inputTwoLeftStickHandler),s.onrightstickchanged(e.InputController.inputTwoRightStickHandler)}if(null==e.InputController.gamepad3&&2===t.index)if(e.InputController.gamepad3=t,BABYLON.Tools.Log("Gamepad Three Connected: "+e.InputController.gamepad3.id),e.InputController.gamepad3 instanceof BABYLON.Xbox360Pad){e.InputController.gamepad3Type=e.GamepadType.Xbox360;var u=e.InputController.gamepad3;u.onbuttonup(e.InputController.inputThreeButtonUpHandler),u.onbuttondown(e.InputController.inputThreeButtonDownHandler),u.onleftstickchanged(e.InputController.inputThreeLeftStickHandler),u.onrightstickchanged(e.InputController.inputThreeRightStickHandler),u.ondpadup(e.InputController.inputThreeXboxDPadUpHandler),u.ondpaddown(e.InputController.inputThreeXboxDPadDownHandler),u.onlefttriggerchanged(e.InputController.inputThreeXboxLeftTriggerHandler),u.onrighttriggerchanged(e.InputController.inputThreeXboxRightTriggerHandler)}else if(e.InputController.gamepad3 instanceof BABYLON.DualShockPad){var c=e.InputController.gamepad3;c.onbuttonup(e.InputController.inputOneButtonUpHandler),c.onbuttondown(e.InputController.inputOneButtonDownHandler),c.onleftstickchanged(e.InputController.inputOneLeftStickHandler),c.onrightstickchanged(e.InputController.inputOneRightStickHandler),c.ondpadup(e.InputController.inputOneShockDPadUpHandler),c.ondpaddown(e.InputController.inputOneShockDPadDownHandler),c.onlefttriggerchanged(e.InputController.inputOneXboxLeftTriggerHandler),c.onrighttriggerchanged(e.InputController.inputOneXboxRightTriggerHandler)}else{e.InputController.gamepad3Type=e.GamepadType.Generic;var d=e.InputController.gamepad3;d.onbuttonup(e.InputController.inputThreeButtonUpHandler),d.onbuttondown(e.InputController.inputThreeButtonDownHandler),d.onleftstickchanged(e.InputController.inputThreeLeftStickHandler),d.onrightstickchanged(e.InputController.inputThreeRightStickHandler)}if(null==e.InputController.gamepad4&&3===t.index)if(e.InputController.gamepad4=t,BABYLON.Tools.Log("Gamepad Four Connected: "+e.InputController.gamepad4.id),e.InputController.gamepad4 instanceof BABYLON.Xbox360Pad){e.InputController.gamepad4Type=e.GamepadType.Xbox360;var p=e.InputController.gamepad4;p.onbuttonup(e.InputController.inputFourButtonUpHandler),p.onbuttondown(e.InputController.inputFourButtonDownHandler),p.onleftstickchanged(e.InputController.inputFourLeftStickHandler),p.onrightstickchanged(e.InputController.inputFourRightStickHandler),p.ondpadup(e.InputController.inputFourXboxDPadUpHandler),p.ondpaddown(e.InputController.inputFourXboxDPadDownHandler),p.onlefttriggerchanged(e.InputController.inputFourXboxLeftTriggerHandler),p.onrighttriggerchanged(e.InputController.inputFourXboxRightTriggerHandler)}else if(e.InputController.gamepad4 instanceof BABYLON.DualShockPad){var h=e.InputController.gamepad4;h.onbuttonup(e.InputController.inputOneButtonUpHandler),h.onbuttondown(e.InputController.inputOneButtonDownHandler),h.onleftstickchanged(e.InputController.inputOneLeftStickHandler),h.onrightstickchanged(e.InputController.inputOneRightStickHandler),h.ondpadup(e.InputController.inputOneShockDPadUpHandler),h.ondpaddown(e.InputController.inputOneShockDPadDownHandler),h.onlefttriggerchanged(e.InputController.inputOneXboxLeftTriggerHandler),h.onrighttriggerchanged(e.InputController.inputOneXboxRightTriggerHandler)}else{e.InputController.gamepad4Type=e.GamepadType.Generic;var m=e.InputController.gamepad4;m.onbuttonup(e.InputController.inputFourButtonUpHandler),m.onbuttondown(e.InputController.inputFourButtonDownHandler),m.onleftstickchanged(e.InputController.inputFourLeftStickHandler),m.onrightstickchanged(e.InputController.inputFourRightStickHandler)}null!=e.InputController.GamepadConnected&&e.InputController.GamepadConnected(t,n)},t.inputManagerGamepadDisconnected=function(t,n){null!=e.InputController.GamepadDisconnected&&e.InputController.GamepadDisconnected(t,n)},t.MOUSE_DAMPENER=.5,t.TAP_THRESHOLD_MS=200,t.GamepadManager=null,t.GamepadConnected=null,t.GamepadDisconnected=null,t.AllowMobileControls=!0,t.MobileControlsActive=!1,t.EnablePinchZoomTracking=!1,t.LastMousePosition=new BABYLON.Vector3(0,0,0),t.PointerLockedFlag=!1,t.LockMousePointerObserver=null,t.input=!1,t.keymap={},t.scroll=0,t.wheel=0,t.mousex=0,t.mousey=0,t.vertical=0,t.horizontal=0,t.mousex2=0,t.mousey2=0,t.vertical2=0,t.horizontal2=0,t.mousex3=0,t.mousey3=0,t.vertical3=0,t.horizontal3=0,t.mousex4=0,t.mousey4=0,t.vertical4=0,t.horizontal4=0,t.a_mousex=0,t.x_scroll=0,t.x_wheel=0,t.x_mousex=0,t.x_mousey=0,t.x_vertical=0,t.x_horizontal=0,t.k_mousex=0,t.k_mousey=0,t.k_vertical=0,t.k_horizontal=0,t.j_mousex=0,t.j_mousey=0,t.j_vertical=0,t.j_horizontal=0,t.g_mousex1=0,t.g_mousey1=0,t.g_vertical1=0,t.g_horizontal1=0,t.g_mousex2=0,t.g_mousey2=0,t.g_vertical2=0,t.g_horizontal2=0,t.g_mousex3=0,t.g_mousey3=0,t.g_vertical3=0,t.g_horizontal3=0,t.g_mousex4=0,t.g_mousey4=0,t.g_vertical4=0,t.g_horizontal4=0,t.dragDirection=0,t.pinchZoomState=0,t.pinchZoomEvents=[],t.pinchZoomDistance=null,t.mouseDownTarget=null,t.mouseDragTarget=null,t.leftButtonDown=!1,t.middleButtonDown=!1,t.rightButtonDown=!1,t.mouseButtonsDown=0,t.mouseButtonPress=[],t.mouseButtonDown=[],t.mouseButtonUp=[],t.keyButtonPress=[],t.keyButtonDown=[],t.keyButtonUp=[],t.previousPosition=null,t.preventDefault=!1,t.lastClientX=0,t.lastClientY=0,t.virtualClientX=0,t.virtualClientY=0,t.rightHanded=!0,t.gamepad1=null,t.gamepad1Type=-1,t.gamepad1ButtonPress=[],t.gamepad1ButtonDown=[],t.gamepad1ButtonUp=[],t.gamepad1DpadPress=[],t.gamepad1DpadDown=[],t.gamepad1DpadUp=[],t.gamepad1LeftTrigger=[],t.gamepad1RightTrigger=[],t.gamepad2=null,t.gamepad2Type=-1,t.gamepad2ButtonPress=[],t.gamepad2ButtonDown=[],t.gamepad2ButtonUp=[],t.gamepad2DpadPress=[],t.gamepad2DpadDown=[],t.gamepad2DpadUp=[],t.gamepad2LeftTrigger=[],t.gamepad2RightTrigger=[],t.gamepad3=null,t.gamepad3Type=-1,t.gamepad3ButtonPress=[],t.gamepad3ButtonDown=[],t.gamepad3ButtonUp=[],t.gamepad3DpadPress=[],t.gamepad3DpadDown=[],t.gamepad3DpadUp=[],t.gamepad3LeftTrigger=[],t.gamepad3RightTrigger=[],t.gamepad4=null,t.gamepad4Type=-1,t.gamepad4ButtonPress=[],t.gamepad4ButtonDown=[],t.gamepad4ButtonUp=[],t.gamepad4DpadPress=[],t.gamepad4DpadDown=[],t.gamepad4DpadUp=[],t.gamepad4LeftTrigger=[],t.gamepad4RightTrigger=[],t}();e.InputController=r;var a=function(){function t(e,t,n,i,o,r){void 0===i&&(i=!0),void 0===o&&(o=-1),void 0===r&&(r=null);var a=this;this.isFixed=!0,this.touchId=null,this.pointerId=null,this.dragStart=null,this.mouseButton=-1,this.maxDistance=48,this.deadZone=2,this.xvalue=0,this.yvalue=0,this.stick=null,this.base=null,this.active=!1,this.enabled=!0,this.updateElements=!0,this.preventDefault=!0,this.stopPropagation=!0,this.baseElementOpacity="1",this.stickElementOpacity="1",this.onHandleDown=null,this.onHandleMove=null,this.onHandleUp=null,this.isFixed=i,this.deadZone=n,this.maxDistance=t,this.mouseButton=o,r&&(this.base=document.getElementById(r)),e&&(this.stick=document.getElementById(e)),this.base&&(this.base.oncontextmenu=function(e){return!1}),this.stick&&(this.stick.oncontextmenu=function(e){return!1}),this.isFixed?this.stick?this.stick.addEventListener("pointerdown",function(e){return a.handleDown(e)}):console.warn("Failed to locate fixed joystick element: "+e):(this.base&&(this.base.style.opacity="0"),this.stick&&(this.stick.style.opacity="0"),document.documentElement.addEventListener("pointerdown",function(e){return a.handleDown(e)})),document.documentElement.addEventListener("pointermove",function(e){return a.handleMove(e)},{passive:!1}),document.documentElement.addEventListener("pointerup",function(e){return a.handleUp(e)})}return t.prototype.dispose=function(){},t.prototype.isActive=function(){return this.active},t.prototype.getValueX=function(){return this.xvalue},t.prototype.getValueY=function(){return this.yvalue},t.prototype.getMouseButton=function(){return this.mouseButton},t.prototype.getBaseElement=function(){return this.base},t.prototype.getStickElement=function(){return this.stick},t.prototype.isFixedJoystick=function(){return this.isFixed},t.prototype.handleDown=function(t){if(this.enabled){var n=!(1&~t.buttons),i=!(2&~t.buttons);(this.mouseButton!==e.TouchMouseButton.Left||n)&&(this.mouseButton!==e.TouchMouseButton.Right||i)&&(this.active=!0,this.pointerId=t.pointerId,this.showBaseElement(t),this.stick&&(this.stick.style.transition="0s"),this.active&&this.preventDefault&&t.preventDefault(),t.changedTouches?(this.dragStart={x:t.changedTouches[0].clientX,y:t.changedTouches[0].clientY},this.touchId=t.changedTouches[0].identifier):this.dragStart={x:t.clientX,y:t.clientY},this.onHandleDown&&this.onHandleDown(t),this.stopPropagation&&t.stopPropagation())}},t.prototype.handleMove=function(e){if(this.enabled&&this.active&&e.pointerId===this.pointerId){if(e.changedTouches){for(var t=null,n=0;n<e.changedTouches.length;n++)this.touchId===e.changedTouches[n].identifier&&(t=n,e.clientX=e.changedTouches[n].clientX,e.clientY=e.changedTouches[n].clientY);if(null===t)return}var i=e.clientX-this.dragStart.x,o=e.clientY-this.dragStart.y,r=Math.atan2(o,i),a=Math.min(this.maxDistance,Math.hypot(i,o)),l=a*Math.cos(r),s=a*Math.sin(r);this.stick&&(this.stick.style.transform="translate3d(".concat(l,"px, ").concat(s,"px, 0px)"));var u=a<this.deadZone?0:this.maxDistance/(this.maxDistance-this.deadZone)*(a-this.deadZone),c=u*Math.cos(r),d=u*Math.sin(r),p=parseFloat((c/this.maxDistance).toFixed(4)),h=parseFloat((d/this.maxDistance).toFixed(4));this.xvalue=p,this.yvalue=h,this.onHandleMove&&this.onHandleMove(e),this.stopPropagation&&e.stopPropagation()}},t.prototype.handleUp=function(e){this.enabled&&this.active&&e.pointerId===this.pointerId&&(e.changedTouches&&this.touchId!==e.changedTouches[0].identifier||(this.stick&&(this.stick.style.transition=".2s",this.stick.style.transform="translate3d(0px, 0px, 0px)"),this.xvalue=0,this.yvalue=0,this.touchId=null,this.pointerId=null,this.active=!1,this.hideBaseElement(),this.onHandleUp&&this.onHandleUp(e),this.stopPropagation&&e.stopPropagation()))},t.prototype.showBaseElement=function(e){if(!this.isFixed&&this.updateElements){if(this.base&&this.base.style.opacity!==this.baseElementOpacity){var t=this.base.getBoundingClientRect();this.base.style.left=e.clientX-t.width/2+"px",this.base.style.top=e.clientY-t.height/2+"px",this.base.style.opacity=this.baseElementOpacity}this.stick&&this.stick.style.opacity!==this.stickElementOpacity&&(this.stick.style.opacity=this.stickElementOpacity)}else this.isFixed||this.updateElements||this.hideBaseElement()},t.prototype.hideBaseElement=function(){this.isFixed||(this.base&&"0"!==this.base.style.opacity&&(this.base.style.opacity="0",this.base.style.left="-1000px",this.base.style.top="-1000px"),this.stick&&"0"!==this.stick.style.opacity&&(this.stick.style.opacity="0"))},t}();e.TouchJoystickHandler=a}(i||(i={})),function(e){var t=function(){function t(){}return t.IsWindows=function(){return"undefined"!=typeof Windows&&void 0!==Windows.UI&&void 0!==Windows.System&&void 0!==Windows.Foundation},t.IsCordova=function(){return null!=window.cordova},t.IsWebAssembly=function(){return window.WebAssembly},t.IsOculusBrowser=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/OculusBrowser/i)&&(e=!0),e},t.IsSamsungBrowser=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/SamsungBrowser/i)&&(e=!0),e},t.IsWindowsPhone=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/Windows Phone/i)&&(e=!0),e},t.IsBlackBerry=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/BlackBerry/i)&&(e=!0),e},t.IsOperaMini=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/Opera Mini/i)&&(e=!0),e},t.IsAndroid=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/Android/i)&&(e=!0),e},t.IsWebOS=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/webOS/i)&&(e=!0),e},t.IsIOS=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/iPhone|iPad|iPod/i)&&(e=!0),e},t.IsIPHONE=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/iPhone/i)&&(e=!0),e},t.IsIPAD=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/iPad/i)&&(e=!0),e},t.IsIPOD=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/iPod/i)&&(e=!0),e},t.IsIE11=function(){return void 0!==navigator.maxTouchPoints},t.IsMobile=function(){var e,t,n,i;if("undefined"==typeof navigator||"undefined"==typeof window)return!1;var o=!0===(null===(e=navigator.userAgentData)||void 0===e?void 0:e.mobile),r=null!==(i=null===(n=null===(t=window.matchMedia)||void 0===t?void 0:t.call(window,"(pointer: coarse)"))||void 0===n?void 0:n.matches)&&void 0!==i&&i,a=Math.min(window.innerWidth,window.innerHeight)<=820,l=navigator.userAgent||"",s=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini|Windows Phone/i.test(l);return o||r&&a||s},t.IsHighEndMobile=function(){var e;if(!this.IsMobile())return!1;var t=window.__HEM_CACHE__;if("boolean"==typeof t)return t;var n=0,i=null!==(e=navigator.hardwareConcurrency)&&void 0!==e?e:0;i>=8?n+=3:i>=6?n+=2:i>=4&&(n+=1);var o=navigator.deviceMemory;"number"==typeof o&&(o>=8?n+=3:o>=6?n+=2:o>=4&&(n+=1));var r=window.devicePixelRatio||1;r>=3&&(n+=1);var a=null;try{var l=document.createElement("canvas");if(a=l.getContext("webgl2")||l.getContext("webgl")||l.getContext("experimental-webgl")||null){a.getParameter&&l.getContext("webgl2")&&(n+=2);var s=a.getParameter(a.MAX_TEXTURE_SIZE);s>=8192?n+=2:s>=4096&&(n+=1)}}catch(e){}try{screen.width*r*(screen.height*r)>=25e5&&(n+=1)}catch(e){}var u=n>=6;return window.__HEM_CACHE__=u,u},t.IsHighEndMobileAsync=function(){return r(this,void 0,void 0,function(){var e,t,n,i;return a(this,function(o){for(e=this.IsHighEndMobile(),t=performance.now(),n=0;n<75e4;n++);return(i=performance.now()-t)<18?e=!0:i>45&&(e=!1),[2,e]})})},t.IsDesktop=function(){return!e.WindowManager.IsMobile()},t.IsPlaystation=function(){var e=!1;return null!=navigator&&null!=navigator.userAgent&&navigator.userAgent.match(/Playstation/i)&&(e=!0),e},t.IsXboxConsole=function(){var t=!1;return e.WindowManager.IsWindows()&&void 0!==Windows.System.Profile&&void 0!==Windows.System.Profile.AnalyticsInfo&&void 0!==Windows.System.Profile.AnalyticsInfo.versionInfo&&void 0!==Windows.System.Profile.AnalyticsInfo.versionInfo.deviceFamily&&Windows.System.Profile.AnalyticsInfo.versionInfo.deviceFamily.match(/Xbox/i)&&(t=!0),t},t.IsXboxLive=function(){return e.WindowManager.IsWindows()&&"undefined"!=typeof Microsoft&&void 0!==Microsoft.Xbox&&void 0!==Microsoft.Xbox.Services},t.IsFrameWindow=function(){return null!=window.parent&&window!==window.parent},t.IsPortraitWindow=function(){return"portrait"===e.WindowManager.GetOrientation()},t.IsLandscapeWindow=function(){return"landscape"===e.WindowManager.GetOrientation()},t.IsStandaloneWindow=function(){return!!window.navigator.standalone||!(!window.matchMedia||!window.matchMedia("(display-mode: standalone)").matches)},t.IsFullscreenWindow=function(){return!!window.navigator.standalone||!(!window.matchMedia||!window.matchMedia("(display-mode: fullscreen)").matches)},t.IsProgressiveWindow=function(){return e.WindowManager.IsStandaloneWindow()||e.WindowManager.IsFullscreenWindow()},t.GetDisplayMode=function(){if(window.navigator.standalone)return"standalone";if(window.matchMedia){if(window.matchMedia("(display-mode: fullscreen)").matches)return"fullscreen";if(window.matchMedia("(display-mode: standalone)").matches)return"standalone";if(window.matchMedia("(display-mode: minimal-ui)").matches)return"minimal-ui"}return"browser"},t.GetOrientation=function(){var e="portrait";if(window.screen&&window.screen.orientation){var t=window.screen.orientation.type;t.includes("portrait")?e="portrait":t.includes("landscape")&&(e="landscape")}else if(window.orientation){var n=window.orientation;0===n||180===n?e="portrait":90!==n&&-90!==n||(e="landscape")}return e},t.AlertMessage=function(t,n){void 0===n&&(n="Babylon Toolkit");var i=null;return e.WindowManager.IsWindows()?i=new Windows.UI.Popups.MessageDialog(t,n).showAsync():window.alert(t),i},t.GetQueryStringParam=function(e,t){t||(t=window.location.href),e=e.replace(/[\[\]]/g,"\\$&");var n=new RegExp("[?&]"+e+"(=([^&#]*)|&|#|$)").exec(t);return n?n[2]?decodeURIComponent(n[2].replace(/\+/g," ")):"":null},t.PostWindowMessage=function(e,t,n){void 0===t&&(t="*"),void 0===n&&(n=!1),!0===n?window.postMessage(e,t):window.top?window.top.postMessage(e,t):console.warn("No Valid Top Window")},t.LoadLevel=function(e,t){if(void 0===t&&(t=null),null!=window.BJS&&"engine.html"===window.BJS){var n=window.location.protocol+"//"+window.location.host+":"+window.location.port+window.location.pathname+"?scene="+e;null!=t&&""!==t&&(n+=t),window.location.replace(n)}else BABYLON.Tools.Warn("Scene viewer engine.html required to load level: "+e);return!1},t.ShowSceneLoader=function(){window.showSceneLoader&&window.showSceneLoader()},t.HideSceneLoader=function(){window.hideSceneLoader&&window.hideSceneLoader()},t.UpdateLoaderStatus=function(e,t,n){window.updateStatus&&window.updateStatus(e,t,n)},t.UpdateLoaderDetails=function(e,t){window.updateDetails&&window.updateDetails(e,t)},t.UpdateLoaderProgress=function(e,t){window.updateProgress&&window.updateProgress(e,t)},t.ShowPageErrorMessage=function(e,t,n){void 0===t&&(t="Error"),void 0===n&&(n=0),window.showErrorMessage&&window.showErrorMessage(e,t,n)},t.SetTimeout=function(e,t){return window.setTimeout(t,e)},t.ClearTimeout=function(e){window.clearTimeout(e)},t.SetInterval=function(e,t){return window.setInterval(t,e)},t.ClearInterval=function(e){window.clearInterval(e)},t.Atob=function(e){return window.atob(e)},t.Btoa=function(e){return window.btoa(e)},t.PopupDebug=function(e){e.debugLayer&&(e.debugLayer.hide(),e.debugLayer.show({enablePopup:!0,globalRoot:null}))},t.ToggleDebug=function(t,n,i){if(void 0===n&&(n=!1),void 0===i&&(i=null),t.debugLayer){var o=window;!0===e.WindowManager.debugLayerVisible?(e.WindowManager.debugLayerVisible=!1,o.METER&&o.METER.show&&o.METER.show(),t.debugLayer.hide()):(e.WindowManager.debugLayerVisible=!0,o.METER&&o.METER.hide&&o.METER.hide(),t.debugLayer.show({embedMode:n,globalRoot:i}))}},t.GetLocalStorageItem=function(e){return null!=window.localStorage?window.localStorage.getItem(e):null},t.SetLocalStorageItem=function(e,t){null!=window.localStorage&&window.localStorage.setItem(e,t)},t.GetSessionStorageItem=function(e){return null!=window.sessionStorage?window.sessionStorage.getItem(e):null},t.SetSessionStorageItem=function(e,t){null!=window.sessionStorage&&window.sessionStorage.setItem(e,t)},t.GetFilenameFromUrl=function(e){return e.substring(e.lastIndexOf("/")+1)},t.GetUrlParameter=function(e){var t=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]"),n=new RegExp("[\\?&]"+t+"=([^&#]*)").exec(window.location.search);return null!==n?decodeURIComponent(n[1].replace(/\+/g," ")):null},t.GetVirtualRealityEnabled=function(){var t=e.WindowManager.GetLocalStorageItem("virtualReality");return null!=t&&"true"===t},t.SetVirtualRealityEnabled=function(t){e.WindowManager.SetLocalStorageItem("virtualReality",t.toString().toLowerCase())},t.SetWindowsLaunchMode=function(t){void 0===t&&(t=1),e.WindowManager.IsWindows()&&void 0!==Windows.UI.ViewManagement&&void 0!==Windows.UI.ViewManagement.ApplicationView&&(Windows.UI.ViewManagement.ApplicationView.preferredLaunchWindowingMode=t)},t.GetHardwareScalingLevel=function(){return 1/window.devicePixelRatio},t.QuitWindowsApplication=function(){e.WindowManager.IsWindows()&&window.close()},t.PrintToScreen=function(t,n){if(void 0===n&&(n="white"),e.WindowManager.PrintElement=document.getElementById("print"),null==e.WindowManager.PrintElement){var i=document.createElement("div");i.id="print",i.style.position="absolute",i.style.left="6px",i.style.bottom="3px",i.style.fontSize="12px",i.style.zIndex="10000",i.style.color="#0c0",i.style.pointerEvents="none",document.body.appendChild(i),e.WindowManager.PrintElement=i}null!=e.WindowManager.PrintElement&&e.WindowManager.PrintElement.innerHTML!==t&&(e.WindowManager.PrintElement.style.color!==n&&(e.WindowManager.PrintElement.style.color=n),e.WindowManager.PrintElement.innerHTML=t)},t.debugLayerVisible=!1,t.PrintElement=null,t}();e.WindowManager=t}(i||(i={})),i.WindowManager.IsWindows()&&void 0!==Windows.UI.ViewManagement&&void 0!==Windows.UI.ViewManagement.ApplicationViewBoundsMode&&void 0!==Windows.UI.ViewManagement.ApplicationViewBoundsMode.useCoreWindow&&Windows.UI.ViewManagement.ApplicationView.getForCurrentView().setDesiredBoundsMode(Windows.UI.ViewManagement.ApplicationViewBoundsMode.useCoreWindow),i.WindowManager.IsXboxConsole()&&navigator.gamepadInputEmulation&&(navigator.gamepadInputEmulation="gamepad"),function(e){var t=function(t){function n(n,i,o,r){void 0===o&&(o={}),void 0===r&&(r="TOOLKIT.AnimationState");var a=t.call(this,n,i,o,r)||this;return a._looptime=!1,a._loopblend=!1,a._frametime=0,a._layercount=0,a._updatemode=0,a._hasrootmotion=!1,a._animationplaying=!1,a._initialtargetblending=!1,a._hastransformhierarchy=!1,a._leftfeetbottomheight=0,a._rightfeetbottomheight=0,a._runtimecontroller=null,a._executed=!1,a._awakened=!1,a._initialized=!1,a._checkers=new e.TransitionCheck,a._source="",a._machine=null,a._animationmode=0,a._animationrig=null,a._deltaPosition=new BABYLON.Vector3(0,0,0),a._deltaRotation=new BABYLON.Quaternion(0,0,0,0),a._angularVelocity=new BABYLON.Vector3(0,0,0),a._rootMotionSpeed=0,a._lastMotionSpeed=0,a._loopMotionSpeed=0,a._lastRotateSpeed=0,a._loopRotateSpeed=0,a._lastMotionRotation=new BABYLON.Quaternion(0,0,0,0),a._lastMotionPosition=new BABYLON.Vector3(0,0,0),a._positionWeight=!1,a._rootBoneWeight=!1,a._rotationWeight=!1,a._rootQuatWeight=!1,a._rootBoneTransform=null,a._positionHolder=new BABYLON.Vector3(0,0,0),a._rootBoneHolder=new BABYLON.Vector3(0,0,0),a._rotationHolder=new BABYLON.Quaternion(0,0,0,0),a._rootQuatHolder=new BABYLON.Quaternion(0,0,0,0),a._rootMotionMatrix=BABYLON.Matrix.Zero(),a._rootMotionScaling=new BABYLON.Vector3(0,0,0),a._rootMotionRotation=new BABYLON.Quaternion(0,0,0,0),a._rootMotionPosition=new BABYLON.Vector3(0,0,0),a._dirtyMotionMatrix=null,a._dirtyBlenderMatrix=null,a._targetPosition=new BABYLON.Vector3(0,0,0),a._targetRotation=new BABYLON.Quaternion(0,0,0,0),a._targetScaling=new BABYLON.Vector3(1,1,1),a._updateMatrix=BABYLON.Matrix.Zero(),a._blenderMatrix=BABYLON.Matrix.Zero(),a._blendWeights=new e.BlendingWeights,a._emptyScaling=new BABYLON.Vector3(1,1,1),a._emptyPosition=new BABYLON.Vector3(0,0,0),a._emptyRotation=new BABYLON.Quaternion(0,0,0,0),a._ikFrameEanbled=!1,a._data=new Map,a._anims=new Map,a._clips=null,a._numbers=new Map,a._booleans=new Map,a._triggers=new Map,a._parameters=new Map,a.speedRatio=1,a.delayUpdateUntilReady=!0,a.enableAnimations=!0,a.applyRootMotion=!1,a.onAnimationAwakeObservable=new BABYLON.Observable,a.onAnimationInitObservable=new BABYLON.Observable,a.onAnimationIKObservable=new BABYLON.Observable,a.onAnimationEndObservable=new BABYLON.Observable,a.onAnimationLoopObservable=new BABYLON.Observable,a.onAnimationEventObservable=new BABYLON.Observable,a.onAnimationUpdateObservable=new BABYLON.Observable,a.onAnimationTransitionObservable=new BABYLON.Observable,a.m_zeroVector=new BABYLON.Vector3(0,0,0),a.m_defaultGroup=null,a.m_animationTargets=null,a.m_rotationIdentity=new BABYLON.Quaternion(0,0,0,0),a.delayStart=0,a.sourceAnimationGroups=null,a}return o(n,t),n.prototype.awakened=function(){return this._awakened},n.prototype.initialized=function(){return this._initialized},n.prototype.hasRootMotion=function(){return this._hasrootmotion},n.prototype.isFirstFrame=function(){return 0===this._frametime},n.prototype.isLastFrame=function(){return this._frametime>=.985},n.prototype.ikFrameEnabled=function(){return this._ikFrameEanbled},n.prototype.getAnimationTime=function(){return this._frametime},n.prototype.getFrameLoopTime=function(){return this._looptime},n.prototype.getFrameLoopBlend=function(){return this._loopblend},n.prototype.getAnimationPlaying=function(){return this._animationplaying},n.prototype.getRuntimeController=function(){return this._runtimecontroller},n.prototype.getRootBoneTransform=function(){return this._rootBoneTransform},n.prototype.getDeltaRootMotionAngle=function(){return this._angularVelocity.y},n.prototype.getDeltaRootMotionSpeed=function(){return this._rootMotionSpeed},n.prototype.getDeltaRootMotionPosition=function(){return this._deltaPosition},n.prototype.getDeltaRootMotionRotation=function(){return this._deltaRotation},n.prototype.getFixedRootMotionPosition=function(){return null!=this._dirtyMotionMatrix?this._rootMotionPosition:null},n.prototype.getFixedRootMotionRotation=function(){return null!=this._dirtyMotionMatrix?this._rootMotionRotation:null},n.prototype.awake=function(){this.awakeStateMachine()},n.prototype.update=function(){this.updateStateMachine()},n.prototype.destroy=function(){this.destroyStateMachine()},n.prototype.playDefaultAnimation=function(t,n,i){void 0===t&&(t=0),void 0===n&&(n=0),void 0===i&&(i=null);var o=!1;if(!0===this._initialized)if(null!=this._machine&&null!=this._machine.layers&&this._machine.layers.length>n){var r=this._machine.layers[n],a=null!=r.animationStateMachine&&r.animationStateMachine.rate||e.AnimationState.FPS,l=t>0?e.Utilities.ComputeBlendingSpeed(i||a,t):0;this.playCurrentAnimationState(r,r.entry,l),o=!0}else BABYLON.Tools.Warn("No animation state layers on "+this.transform.name);else BABYLON.Tools.Warn("Animation state machine not initialized for "+this.transform.name);return o},n.prototype.playAnimation=function(t,n,i,o){void 0===n&&(n=0),void 0===i&&(i=0),void 0===o&&(o=null);var r=!1;if(!0===this._initialized)if(null!=this._machine&&null!=this._machine.layers&&this._machine.layers.length>i){var a=this._machine.layers[i],l=null!=a.animationStateMachine&&a.animationStateMachine.rate||e.AnimationState.FPS,s=n>0?e.Utilities.ComputeBlendingSpeed(o||l,n):0;this.playCurrentAnimationState(a,t,s),r=!0}else BABYLON.Tools.Warn("No animation state layers on "+this.transform.name);else BABYLON.Tools.Warn("Animation state machine not initialized for "+this.transform.name);return r},n.prototype.stopAnimation=function(e){void 0===e&&(e=0);var t=!1;if(!0===this._initialized)if(null!=this._machine&&null!=this._machine.layers&&this._machine.layers.length>e){var n=this._machine.layers[e];this.stopCurrentAnimationState(n),t=!0}else BABYLON.Tools.Warn("No animation state layers on "+this.transform.name);else BABYLON.Tools.Warn("Animation state machine not initialized for "+this.transform.name);return t},n.prototype.killAnimations=function(){var e=this,t=!1;return!0===this._initialized?null!=this._machine&&null!=this._machine.layers?this._machine.layers.forEach(function(n){e.stopCurrentAnimationState(n),t=!0}):BABYLON.Tools.Warn("No animation state layers on "+this.transform.name):BABYLON.Tools.Warn("Animation state machine not initialized for "+this.transform.name),t},n.prototype.hasBool=function(e){return null!=this._booleans.get(e)},n.prototype.getBool=function(e){return this._booleans.get(e)||!1},n.prototype.setBool=function(e,t){this._booleans.set(e,t)},n.prototype.hasFloat=function(e){return null!=this._numbers.get(e)},n.prototype.getFloat=function(e){return this._numbers.get(e)||0},n.prototype.setFloat=function(e,t){this._numbers.set(e,t)},n.prototype.hasInteger=function(e){return null!=this._numbers.get(e)},n.prototype.getInteger=function(e){return this._numbers.get(e)||0},n.prototype.setInteger=function(e,t){this._numbers.set(e,t)},n.prototype.hasTrigger=function(e){return null!=this._triggers.get(e)},n.prototype.getTrigger=function(e){return this._triggers.get(e)||!1},n.prototype.setTrigger=function(e){this._triggers.set(e,!0)},n.prototype.resetTrigger=function(e){this._triggers.set(e,!1)},n.prototype.setSmoothFloat=function(e,t,n){var i=BABYLON.Scalar.Lerp(this.getFloat(e),t,Math.min(n,1));this.setFloat(e,i)},n.prototype.setSmoothInteger=function(e,t,n){var i=BABYLON.Scalar.Lerp(this.getInteger(e),t,Math.min(n,1));this.setInteger(e,i)},n.prototype.getMachineState=function(e){return this._data.get(e)},n.prototype.setMachineState=function(e,t){this._data.set(e,t)},n.prototype.getCurrentState=function(e){return null!=this._machine.layers&&this._machine.layers.length>e?this._machine.layers[e].animationStateMachine:null},n.prototype.getDefaultClips=function(){return this._clips},n.prototype.getDefaultSource=function(){return this._source},n.prototype.setLayerWeight=function(e,t){},n.prototype.fixAnimationGroup=function(e){var t=null;if(null!=this._clips&&this._clips.length>0)for(var n=0;n<this._clips.length;n++){var i=this._clips[n];if(null!=i.clip){var o=("."+i.clip).toLowerCase();if(e.name.toLowerCase().endsWith(o)){null==e.metadata&&(e.metadata={}),null==e.metadata.toolkit&&(e.metadata.toolkit=i),e.metadata.toolkit.source=this._source,t=i;break}}}return t},n.prototype.getAnimationGroup=function(e){return this._anims.get(e)},n.prototype.getAnimationGroups=function(){return this.sourceAnimationGroups},n.prototype.setAnimationGroups=function(e){null==this.transform.metadata&&(this.transform.metadata={}),null==this.transform.metadata.toolkit&&(this.transform.metadata.toolkit={}),this.transform.metadata.toolkit.sourceAnimationGroups=e,this.setupSourceAnimationGroups()},n.prototype.updateAnimationGroups=function(t){var n=this;null!=t&&t.length>0&&(this._anims=new Map,this.m_animationTargets=[],this.m_defaultGroup=null,this.sourceAnimationGroups=null,t.forEach(function(t){var i=!1,o=t;if(null!=o&&null!=o.metadata&&null!=o.metadata.toolkit&&null!=o.metadata.toolkit.source&&""!==o.metadata.toolkit.source&&o.metadata.toolkit.source===n._source&&(i=!0),!0===i&&null!=o&&null!=o.metadata&&null!=o.metadata.toolkit&&null!=o.metadata.toolkit.clip&&""!==o.metadata.toolkit.clip){try{t.stop()}catch(e){}null==n.sourceAnimationGroups&&(n.sourceAnimationGroups=[]),n.sourceAnimationGroups.push(t),n._anims.set(o.metadata.toolkit.clip,t),null==n.m_defaultGroup&&(n.m_defaultGroup=t),null!=t.targetedAnimations&&t.targetedAnimations.length>0&&t.targetedAnimations.forEach(function(t){for(var i=-1,o=0;o<n.m_animationTargets.length;o++)if(n.m_animationTargets[o].target===t.target){i=o;break}if(i<0)if(n.m_animationTargets.push(t),null==t.target.metadata&&(t.target.metadata={}),t.target instanceof BABYLON.TransformNode){e.Utilities.ValidateTransformQuaternion(t.target);for(var r=[],a=0;a<n._layercount;a++){var l=new e.AnimationMixer;l.positionBuffer=null,l.rotationBuffer=null,l.scalingBuffer=null,l.originalMatrix=null,l.blendingFactor=0,l.blendingSpeed=0,l.rootPosition=null,l.rootRotation=null,r.push(l)}t.target.metadata.mixer=r}else if(t.target instanceof BABYLON.MorphTarget){var s=[];for(a=0;a<n._layercount;a++){var u=new e.AnimationMixer;u.influenceBuffer=null,s.push(u)}t.target.metadata.mixer=s}})}}))},n.prototype.awakeStateMachine=function(){var t=this;e.Utilities.ValidateTransformQuaternion(this.transform),this.m_animationTargets=[],this.m_defaultGroup=null,this.m_rotationIdentity=BABYLON.Quaternion.Identity(),this._source=null!=this.transform.metadata&&null!=this.transform.metadata.toolkit&&null!=this.transform.metadata.toolkit.animator&&""!==this.transform.metadata.toolkit.animator?this.transform.metadata.toolkit.animator:null,this._clips=this.getProperty("clips",this._clips),this._machine=this.getProperty("machine",this._machine),this._updatemode=this.getProperty("updatemode",this._updatemode),this._animationrig=this.getProperty("animationrig",this._animationrig),this._animationmode=this.getProperty("animationmode",this._animationmode),this._hasrootmotion=this.getProperty("hasrootmotion",this._hasrootmotion),this._runtimecontroller=this.getProperty("runtimecontroller",this._runtimecontroller),this._hastransformhierarchy=this.getProperty("hastransformhierarchy",this._hastransformhierarchy),this._leftfeetbottomheight=this.getProperty("leftfeetbottomheight",this._leftfeetbottomheight),this._rightfeetbottomheight=this.getProperty("rightfeetbottomheight",this._rightfeetbottomheight),this.applyRootMotion=this.getProperty("applyrootmotion",this.applyRootMotion),null!=this._machine&&(null!=this._machine.owner&&null!=this._machine.owner&&""!==this._machine.owner&&"*"!==this._machine.owner||(this._machine.owner=null!=this.transform.parent?this.transform.parent.name:this.transform.name),null!=this._machine.speed&&(this.speedRatio=this._machine.speed),null!=this._machine.parameters&&this._machine.parameters.length>0&&this._machine.parameters.forEach(function(n){var i=n.name,o=n.type,r=(n.curve,n.defaultFloat),a=n.defaultBool,l=n.defaultInt;t._parameters.set(i,o),o===e.AnimatorParameterType.Bool?t.setBool(i,a):o===e.AnimatorParameterType.Float?t.setFloat(i,r):o===e.AnimatorParameterType.Int?t.setInteger(i,l):o===e.AnimatorParameterType.Trigger&&t.resetTrigger(i)}),null!=this._machine.layers&&this._machine.layers.length>0&&(this._layercount=this._machine.layers.length,this._machine.layers.sort(function(e,t){return e.index<t.index?-1:e.index>t.index?1:0}),this._machine.layers.forEach(function(e){if(null==e.owner||null==e.owner||""===e.owner||e.owner,e.animationMaskMap=new Map,null!=e.avatarMask&&null!=e.avatarMask.transformPaths&&e.avatarMask.transformPaths.length>0)for(var t=0;t<e.avatarMask.transformPaths.length;t++)e.animationMaskMap.set(e.avatarMask.transformPaths[t],t)}))),this._awakened=!0,this.onAnimationAwakeObservable&&this.onAnimationAwakeObservable.hasObservers()&&this.onAnimationAwakeObservable.notifyObservers(this.transform)},n.prototype.updateStateMachine=function(e){var t=this;if(void 0===e&&(e=null),(!1===this.delayUpdateUntilReady||!0===this.delayUpdateUntilReady&&this.isReady())&&(null==this.sourceAnimationGroups&&this.setupSourceAnimationGroups(),null!=this.sourceAnimationGroups&&(!1===this._executed&&(this._executed=!0,null!=this._machine.layers&&this._machine.layers.length>0&&this._machine.layers.forEach(function(e){t.playCurrentAnimationState(e,e.entry,0)}),this._initialized=!0,this.onAnimationInitObservable&&this.onAnimationInitObservable.hasObservers()&&this.onAnimationInitObservable.notifyObservers(this.transform)),!0===this.enableAnimations))){var n=e||this.getDeltaSeconds();this.updateAnimationState(n),this.updateAnimationTargets(n),this.onAnimationUpdateObservable&&this.onAnimationUpdateObservable.hasObservers()&&this.onAnimationUpdateObservable.notifyObservers(this.transform)}},n.prototype.setupSourceAnimationGroups=function(){var e=this,t=null!=this.transform.metadata&&null!=this.transform.metadata.toolkit&&null!=this.transform.metadata.toolkit.sourceAnimationGroups?this.transform.metadata.toolkit.sourceAnimationGroups:null;null!=t&&(this.updateAnimationGroups(t),null!=this.sourceAnimationGroups&&null!=this._machine&&null!=this._machine.states&&this._machine.states.length>0&&this._machine.states.forEach(function(t){null!=t&&null!=t.name&&(null!=t.ccurves&&t.ccurves.length>0&&t.ccurves.forEach(function(e){if(null!=e.animation){var n=BABYLON.Animation.Parse(e.animation);null!=n&&(null==t.tcurves&&(t.tcurves=[]),t.tcurves.push(n))}}),e.setupTreeBranches(t.blendtree),e.setMachineState(t.name,t))}))},n.prototype.destroyStateMachine=function(){this._data=null,this._clips=null,this._anims=null,this._numbers=null,this._booleans=null,this._triggers=null,this._parameters=null,this._checkers=null,this._machine=null,this.sourceAnimationGroups=null,this.onAnimationAwakeObservable.clear(),this.onAnimationAwakeObservable=null,this.onAnimationInitObservable.clear(),this.onAnimationInitObservable=null,this.onAnimationIKObservable.clear(),this.onAnimationIKObservable=null,this.onAnimationEndObservable.clear(),this.onAnimationEndObservable=null,this.onAnimationLoopObservable.clear(),this.onAnimationLoopObservable=null,this.onAnimationEventObservable.clear(),this.onAnimationEventObservable=null,this.onAnimationUpdateObservable.clear(),this.onAnimationUpdateObservable=null,this.onAnimationTransitionObservable.clear(),this.onAnimationTransitionObservable=null},n.prototype.updateAnimationState=function(e){var t=this;null!=this._machine.layers&&this._machine.layers.length>0&&this._machine.layers.forEach(function(n){t.checkStateMachine(n,e)})},n.prototype.updateAnimationTargets=function(t){var n=this;this._looptime=!1,this._loopblend=!1,this._ikFrameEanbled=!1,this._animationplaying=!1,null!=this._machine.layers&&this._machine.layers.length>0&&this._machine.layers.forEach(function(i){if(0===i.index&&(n._frametime=i.animationTime),null!=i.animationStateMachine&&null!=i.animationStateMachine.blendtree){!0===i.animationStateMachine.iKOnFeet&&(n._ikFrameEanbled=!0),!0===i.iKPass&&n.onAnimationIKObservable&&n.onAnimationIKObservable.hasObservers()&&n.onAnimationIKObservable.notifyObservers(i.index);var o=i.animationStateMachine;if(o.type===e.MotionType.Clip&&-1!==o.played&&(o.played+=t),null!=o.blendtree.children&&o.blendtree.children.length>0){var r=o.blendtree.children[0];if(null!=r)if(o.blendtree.blendType==e.BlendTreeType.Clip){var a=r.track;if(null!=a){var l=a.metadata.toolkit.length,s=l>0?e.AnimationState.TIME/l:0;i.animationTime+=t*s*Math.abs(o.speed)*Math.abs(n.speedRatio),i.animationTime>e.AnimationState.TIME&&(i.animationTime=e.AnimationState.TIME);var u=i.animationTime>0?BABYLON.Scalar.Clamp(i.animationTime/e.AnimationState.TIME,0,1):0,c=o.speed<0!=n.speedRatio<0;i.animationNormal=c?1-u:u;var d=i.animationNormal>=.99?1:i.animationNormal,p=(parseFloat(d.toFixed(3)),l*i.animationNormal),h=0,m=0,f=0,g=!1,y=!1,v=0,_=!0,S=!0,B=!0,b=a;if(null!=b.metadata&&null!=b.metadata.toolkit&&(null!=b.metadata.toolkit.averagespeed&&(m=null!=b.metadata.toolkit.averagespeed.x?b.metadata.toolkit.averagespeed.x:0,f=null!=b.metadata.toolkit.averagespeed.z?b.metadata.toolkit.averagespeed.z:0),null!=b.metadata.toolkit.settings&&(h=null!=b.metadata.toolkit.settings.level?b.metadata.toolkit.settings.level:0,g=null!=b.metadata.toolkit.settings.looptime&&b.metadata.toolkit.settings.looptime,y=null!=b.metadata.toolkit.settings.loopblend&&b.metadata.toolkit.settings.loopblend,v=null!=b.metadata.toolkit.settings.orientationoffsety?b.metadata.toolkit.settings.orientationoffsety:0,_=null==b.metadata.toolkit.settings.loopblendorientation||b.metadata.toolkit.settings.loopblendorientation,S=null==b.metadata.toolkit.settings.loopblendpositiony||b.metadata.toolkit.settings.loopblendpositiony,B=null==b.metadata.toolkit.settings.loopblendpositionxz||b.metadata.toolkit.settings.loopblendpositionxz)),0===i.index&&(n._looptime=g,n._loopblend=y),v=BABYLON.Tools.ToRadians(v),m=Math.abs(m),f=Math.abs(f),h*=-1,i.animationTime>=e.AnimationState.TIME&&(i.animationFirstRun=!1,i.animationLoopFrame=!0,!0===g?(i.animationLoopCount++,n.onAnimationLoopObservable&&n.onAnimationLoopObservable.hasObservers()&&n.onAnimationLoopObservable.notifyObservers(i.index)):!1===i.animationEndFrame&&(i.animationEndFrame=!0,n.onAnimationEndObservable&&n.onAnimationEndObservable.hasObservers()&&n.onAnimationEndObservable.notifyObservers(i.index))),!0!==i.animationFirstRun&&!0!==g||(n._animationplaying=!0,a.targetedAnimations.forEach(function(t){if(t.target instanceof BABYLON.TransformNode){var o=t.target;if(0===i.index||null==i.avatarMask||n.filterTargetAvatarMask(i,o)){var r=null!=o.metadata&&null!=o.metadata.toolkit&&null!=o.metadata.toolkit.rootbone&&o.metadata.toolkit.rootbone;if(!0===r&&null==n._rootBoneTransform&&(n._rootBoneTransform=o),null!=o.metadata&&null!=o.metadata.mixer){var a=o.metadata.mixer[i.index];if(null!=a)if("position"===t.animation.targetProperty)n._targetPosition=e.Utilities.SampleAnimationVector3(t.animation,p,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0),!0===r&&null!=n._rootBoneTransform?(n._positionWeight=!0,n._positionHolder.set(0,0,0),n._rootBoneWeight=!1,n._rootBoneHolder.set(0,0,0),!0===n.applyRootMotion?!0===S&&!0===B?(n._positionWeight=!0,n._positionHolder.set(n._targetPosition.x,n._targetPosition.y+h,n._targetPosition.z)):!1===S&&!1===B?(n._rootBoneWeight=!0,n._rootBoneHolder.set(n._targetPosition.x,n._targetPosition.y+h,n._targetPosition.z)):!0===S&&!1===B?(n._positionWeight=!0,n._positionHolder.set(n.m_zeroVector.x,n._targetPosition.y+h,n.m_zeroVector.z),n._rootBoneWeight=!0,n._rootBoneHolder.set(n._targetPosition.x,n.m_zeroVector.y,n._targetPosition.z)):!0===B&&!1===S&&(n._positionWeight=!0,n._positionHolder.set(n._targetPosition.x,n.m_zeroVector.y,n._targetPosition.z),n._rootBoneWeight=!0,n._rootBoneHolder.set(n.m_zeroVector.x,n._targetPosition.y+h,n.m_zeroVector.z)):(n._positionWeight=!0,n._positionHolder.set(n._targetPosition.x,n._targetPosition.y+h,n._targetPosition.z)),!0===n._positionWeight&&(null==a.positionBuffer&&(a.positionBuffer=new BABYLON.Vector3(0,0,0)),e.Utilities.BlendVector3Value(a.positionBuffer,n._positionHolder,1)),!0===n._rootBoneWeight&&(null==a.rootPosition&&(a.rootPosition=new BABYLON.Vector3(0,0,0)),e.Utilities.BlendVector3Value(a.rootPosition,n._rootBoneHolder,1))):(null==a.positionBuffer&&(a.positionBuffer=new BABYLON.Vector3(0,0,0)),e.Utilities.BlendVector3Value(a.positionBuffer,n._targetPosition,1));else if("rotationQuaternion"===t.animation.targetProperty)if(n._targetRotation=e.Utilities.SampleAnimationQuaternion(t.animation,p,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0),!0===r&&null!=n._rootBoneTransform){n._rotationWeight=!1,n._rotationHolder.copyFrom(n.m_rotationIdentity),n._rootQuatWeight=!1,n._rootQuatHolder.copyFrom(n.m_rotationIdentity);var l=n._targetRotation.toEulerAngles(),s=l.y;!0===n.applyRootMotion?!0===_?(n._rotationWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(l.x,s+v,l.z,n._rotationHolder)):(n._rotationWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(l.x,n.m_zeroVector.y,l.z,n._rotationHolder),n._rootQuatWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(n.m_zeroVector.x,s+v,n.m_zeroVector.z,n._rootQuatHolder)):(n._rotationWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(l.x,s+v,l.z,n._rotationHolder)),!0===n._rotationWeight&&(null==a.rotationBuffer&&(a.rotationBuffer=new BABYLON.Quaternion(0,0,0,0)),e.Utilities.BlendQuaternionValue(a.rotationBuffer,n._rotationHolder,1)),!0===n._rootQuatWeight&&(null==a.rootRotation&&(a.rootRotation=new BABYLON.Quaternion(0,0,0,0)),e.Utilities.BlendQuaternionValue(a.rootRotation,n._rootQuatHolder,1))}else null==a.rotationBuffer&&(a.rotationBuffer=new BABYLON.Quaternion(0,0,0,0)),e.Utilities.BlendQuaternionValue(a.rotationBuffer,n._targetRotation,1);else"scaling"===t.animation.targetProperty&&(n._targetScaling=e.Utilities.SampleAnimationVector3(t.animation,p,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0),null==a.scalingBuffer&&(a.scalingBuffer=new BABYLON.Vector3(1,1,1)),e.Utilities.BlendVector3Value(a.scalingBuffer,n._targetScaling,1))}}}else if(t.target instanceof BABYLON.MorphTarget){var u=t.target;if(null!=u.metadata&&null!=u.metadata.mixer){var c=u.metadata.mixer[i.index];if("influence"===t.animation.targetProperty){var d=e.Utilities.SampleAnimationFloat(t.animation,p,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0);null==c.influenceBuffer&&(c.influenceBuffer=0),c.influenceBuffer=e.Utilities.BlendFloatValue(c.influenceBuffer,d,1)}}}})),1==n._animationplaying&&(null!=i.animationStateMachine.tcurves&&i.animationStateMachine.tcurves.length>0&&i.animationStateMachine.tcurves.forEach(function(t){if(null!=t.targetProperty&&""!==t.targetProperty){var o=e.Utilities.SampleAnimationFloat(t,i.animationNormal,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0);n.setFloat(t.targetProperty,o)}}),null!=i.animationStateMachine.events&&i.animationStateMachine.events.length>0)){for(var C=void 0!==i._prevAnimationNormal?i._prevAnimationNormal:i.animationNormal,A=i.animationNormal,M=o.speed<0!=n.speedRatio<0?-1:1,T=function(e,t,n,i){return 1===i?e<=t?e<n&&n<=t:e<n&&n<=1||0<=n&&n<=t:e>=t?t<=n&&n<e:0<=n&&n<e||t<=n&&n<=1},O=0,I=i.animationStateMachine.events;O<I.length;O++)if(T(C,A,(G=I[O]).time,M)){var L=G.function+"_"+G.time;null==i.animationLoopEvents&&(i.animationLoopEvents={}),i.animationLoopEvents[L]||(i.animationLoopEvents[L]=!0,n.onAnimationEventObservable&&n.onAnimationEventObservable.hasObservers()&&n.onAnimationEventObservable.notifyObservers(G))}i._prevAnimationNormal=A}!0===i.animationLoopFrame&&(i.animationTime=0,i.animationNormal=0,i.animationLoopFrame=!1,i.animationLoopEvents=null)}}else{n._animationplaying=!0,n._blendWeights.primary=null,n._blendWeights.secondary=null;var x=[],N=o.blendtree;n.parseTreeBranches(i,N,1,x),s=n.computeWeightedFrameRatio(x),i.animationTime+=t*s*Math.abs(o.speed)*Math.abs(n.speedRatio),i.animationTime>e.AnimationState.TIME&&(i.animationTime=e.AnimationState.TIME),u=i.animationTime>0?BABYLON.Scalar.Clamp(i.animationTime/e.AnimationState.TIME,0,1):0,c=o.speed<0!=n.speedRatio<0,i.animationNormal=c?1-u:u,d=i.animationNormal>=.99?1:i.animationNormal,parseFloat(d.toFixed(3));var w=i.animationNormal;i.animationTime>=e.AnimationState.TIME&&(i.animationFirstRun=!1,i.animationLoopFrame=!0,i.animationLoopCount++);var P=null!=x&&x.length>0&&null!=x[0].track?x[0].track:null;if(null!=P)for(var R=P.targetedAnimations.length,k=0;k<R;k++){var E=P.targetedAnimations[k];if(E.target instanceof BABYLON.TransformNode){var D=E.target;if(0===i.index||null==i.avatarMask||n.filterTargetAvatarMask(i,D)){var U=null!=D.metadata&&null!=D.metadata.toolkit&&null!=D.metadata.toolkit.rootbone&&D.metadata.toolkit.rootbone;if(!0===U&&null==n._rootBoneTransform&&(n._rootBoneTransform=D),null!=D.metadata&&null!=D.metadata.mixer){n._initialtargetblending=!0;var F=D.metadata.mixer[i.index];n.updateBlendableTargets(t,i,N,E,k,F,w,U,D)}}}}if(null!=i.animationStateMachine.tcurves&&i.animationStateMachine.tcurves.length>0&&i.animationStateMachine.tcurves.forEach(function(t){if(null!=t.targetProperty&&""!==t.targetProperty){var o=e.Utilities.SampleAnimationFloat(t,i.animationNormal,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0);n.setFloat(t.targetProperty,o)}}),null!=i.animationStateMachine.events&&i.animationStateMachine.events.length>0){A=w,C=void 0!==i._prevBlendingNormal?i._prevBlendingNormal:A,M=o.speed<0!=n.speedRatio<0?-1:1,T=function(e,t,n,i){return 1===i?e<=t?e<n&&n<=t:e<n&&n<=1||0<=n&&n<=t:e>=t?t<=n&&n<e:0<=n&&n<e||t<=n&&n<=1};for(var Y=0,V=i.animationStateMachine.events;Y<V.length;Y++){var G;T(C,A,(G=V[Y]).time,M)&&(L=G.function+"_"+G.time,null==i.animationLoopEvents&&(i.animationLoopEvents={}),i.animationLoopEvents[L]||(i.animationLoopEvents[L]=!0,n.onAnimationEventObservable&&n.onAnimationEventObservable.hasObservers()&&n.onAnimationEventObservable.notifyObservers(G)))}i._prevBlendingNormal=A}!0===i.animationLoopFrame&&(i.animationTime=0,i.animationNormal=0,i.animationLoopFrame=!1,i.animationLoopEvents=null)}}}}),this.finalizeAnimationTargets(t)},n.prototype.updateBlendableTargets=function(t,n,i,o,r,a,l,s,u){if(null!=a&&null!=i.children&&i.children.length>0)for(var c=0;c<i.children.length;c++){var d=i.children[c];if(d.weight>0)if(d.type===e.MotionType.Clip){if(null!=d.track){var p=0,h=0,m=0,f=!1,g=0,y=!0,v=!0,_=!0,S=d.track;null!=S.metadata&&null!=S.metadata.toolkit&&(null!=S.metadata.toolkit.averagespeed&&(h=null!=S.metadata.toolkit.averagespeed.x?S.metadata.toolkit.averagespeed.x:0,m=null!=S.metadata.toolkit.averagespeed.z?S.metadata.toolkit.averagespeed.z:0),null!=S.metadata.toolkit.settings&&(p=null!=S.metadata.toolkit.settings.level?S.metadata.toolkit.settings.level:0,f=null!=S.metadata.toolkit.settings.loopblend&&S.metadata.toolkit.settings.loopblend,g=null!=S.metadata.toolkit.settings.orientationoffsety?S.metadata.toolkit.settings.orientationoffsety:0,y=null==S.metadata.toolkit.settings.loopblendorientation||S.metadata.toolkit.settings.loopblendorientation,v=null==S.metadata.toolkit.settings.loopblendpositiony||S.metadata.toolkit.settings.loopblendpositiony,_=null==S.metadata.toolkit.settings.loopblendpositionxz||S.metadata.toolkit.settings.loopblendpositionxz)),0===n.index&&(this._looptime=!0,this._loopblend=f),g=BABYLON.Tools.ToRadians(g),h=Math.abs(h),m=Math.abs(m),p*=-1;var B=d.track.targetedAnimations[r],b=!0===this._initialtargetblending?1:parseFloat(d.weight.toFixed(2));if(this._initialtargetblending=!1,B.target===o.target&&B.animation.targetProperty===o.animation.targetProperty){var C=l;d.timescale<0&&(C=1-C);var A=d.track.metadata.toolkit.length*C;if("position"===o.animation.targetProperty)this._targetPosition=e.Utilities.SampleAnimationVector3(B.animation,A,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0),!0===s&&null!=this._rootBoneTransform?(this._positionWeight=!0,this._positionHolder.set(0,0,0),this._rootBoneWeight=!1,this._rootBoneHolder.set(0,0,0),!0===this.applyRootMotion?!0===v&&!0===_?(this._positionWeight=!0,this._positionHolder.set(this._targetPosition.x,this._targetPosition.y+p,this._targetPosition.z)):!1===v&&!1===_?(this._rootBoneWeight=!0,this._rootBoneHolder.set(this._targetPosition.x,this._targetPosition.y+p,this._targetPosition.z)):!0===v&&!1===_?(this._positionWeight=!0,this._positionHolder.set(this.m_zeroVector.x,this._targetPosition.y+p,this.m_zeroVector.z),this._rootBoneWeight=!0,this._rootBoneHolder.set(this._targetPosition.x,this.m_zeroVector.y,this._targetPosition.z)):!0===_&&!1===v&&(this._positionWeight=!0,this._positionHolder.set(this._targetPosition.x,this.m_zeroVector.y,this._targetPosition.z),this._rootBoneWeight=!0,this._rootBoneHolder.set(this.m_zeroVector.x,this._targetPosition.y+p,this.m_zeroVector.z)):(this._positionWeight=!0,this._positionHolder.set(this._targetPosition.x,this._targetPosition.y+p,this._targetPosition.z)),!0===this._positionWeight&&(null==a.positionBuffer&&(a.positionBuffer=new BABYLON.Vector3(0,0,0)),e.Utilities.BlendVector3Value(a.positionBuffer,this._positionHolder,b)),!0===this._rootBoneWeight&&(null==a.rootPosition&&(a.rootPosition=new BABYLON.Vector3(0,0,0)),e.Utilities.BlendVector3Value(a.rootPosition,this._rootBoneHolder,b))):(null==a.positionBuffer&&(a.positionBuffer=new BABYLON.Vector3(0,0,0)),e.Utilities.BlendVector3Value(a.positionBuffer,this._targetPosition,b));else if("rotationQuaternion"===o.animation.targetProperty)if(this._targetRotation=e.Utilities.SampleAnimationQuaternion(B.animation,A,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0),!0===s&&null!=this._rootBoneTransform){this._rotationWeight=!1,this._rotationHolder.copyFrom(this.m_rotationIdentity),this._rootQuatWeight=!1,this._rootQuatHolder.copyFrom(this.m_rotationIdentity);var M=this._targetRotation.toEulerAngles(),T=M.y;!0===this.applyRootMotion?!0===y?(this._rotationWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(M.x,T+g,M.z,this._rotationHolder)):(this._rotationWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(M.x,this.m_zeroVector.y,M.z,this._rotationHolder),this._rootQuatWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(this.m_zeroVector.x,T+g,this.m_zeroVector.z,this._rootQuatHolder)):(this._rotationWeight=!0,BABYLON.Quaternion.FromEulerAnglesToRef(M.x,T+g,M.z,this._rotationHolder)),!0===this._rotationWeight&&(null==a.rotationBuffer&&(a.rotationBuffer=new BABYLON.Quaternion(0,0,0,0)),e.Utilities.BlendQuaternionValue(a.rotationBuffer,this._rotationHolder,b)),!0===this._rootQuatWeight&&(null==a.rootRotation&&(a.rootRotation=new BABYLON.Quaternion(0,0,0,0)),e.Utilities.BlendQuaternionValue(a.rootRotation,this._rootQuatHolder,b))}else null==a.rotationBuffer&&(a.rotationBuffer=new BABYLON.Quaternion(0,0,0,0)),e.Utilities.BlendQuaternionValue(a.rotationBuffer,this._targetRotation,b);else"scaling"===o.animation.targetProperty&&(this._targetScaling=e.Utilities.SampleAnimationVector3(B.animation,A,BABYLON.Animation.ANIMATIONLOOPMODE_CYCLE,!0),null==a.scalingBuffer&&(a.scalingBuffer=new BABYLON.Vector3(1,1,1)),e.Utilities.BlendVector3Value(a.scalingBuffer,this._targetScaling,b))}}}else d.type===e.MotionType.Tree&&this.updateBlendableTargets(t,n,d.subtree,o,r,a,l,s,u)}},n.prototype.finalizeAnimationTargets=function(t){var n=this;if(this._deltaPosition.set(0,0,0),this._deltaRotation.set(0,0,0,0),this._angularVelocity.set(0,0,0),this._rootMotionSpeed=0,this._rootMotionMatrix.reset(),this._dirtyMotionMatrix=null,this._rootMotionPosition.set(0,0,0),this._rootMotionRotation.set(0,0,0,0),null!=this.m_animationTargets&&this.m_animationTargets.length>0&&this.m_animationTargets.forEach(function(t){var i=t.target;null!=i.metadata&&null!=i.metadata.mixer&&null!=n._machine.layers&&n._machine.layers.length>0&&(n._blenderMatrix.reset(),n._dirtyBlenderMatrix=null,n._machine.layers.forEach(function(t){var o=i.metadata.mixer[t.index];if(null!=o)if(i instanceof BABYLON.TransformNode){if(null==o.positionBuffer&&null==o.rotationBuffer&&null==o.scalingBuffer||(BABYLON.Matrix.ComposeToRef(o.scalingBuffer||i.scaling,o.rotationBuffer||i.rotationQuaternion,o.positionBuffer||i.position,n._updateMatrix),o.blendingSpeed>0&&(o.blendingFactor<=1&&null==o.originalMatrix&&(o.originalMatrix=BABYLON.Matrix.Compose(i.scaling,i.rotationQuaternion,i.position)),o.blendingFactor<=1&&null!=o.originalMatrix&&(e.Utilities.FastMatrixSlerp(o.originalMatrix,n._updateMatrix,o.blendingFactor,n._updateMatrix),o.blendingFactor+=o.blendingSpeed)),e.Utilities.FastMatrixSlerp(n._blenderMatrix,n._updateMatrix,t.defaultWeight,n._blenderMatrix),n._dirtyBlenderMatrix=!0,o.positionBuffer=null,o.rotationBuffer=null,o.scalingBuffer=null),n._emptyPosition.set(0,0,0),n._emptyRotation.set(0,0,0,0),n._emptyScaling.set(1,1,1),null!=o.rootPosition||null!=o.rootRotation){var r=n._emptyPosition,a=o.rootRotation?o.rootRotation.clone():n._emptyRotation,l=o.rootPosition?o.rootPosition.clone():n._emptyPosition;BABYLON.Matrix.ComposeToRef(r,a,l,n._updateMatrix),e.Utilities.FastMatrixSlerp(n._rootMotionMatrix,n._updateMatrix,t.defaultWeight,n._rootMotionMatrix),n._dirtyMotionMatrix=!0,o.rootPosition=null,o.rootRotation=null}}else i instanceof BABYLON.MorphTarget&&null!=o.influenceBuffer&&(i.influence=BABYLON.Scalar.Lerp(i.influence,o.influenceBuffer,t.defaultWeight),o.influenceBuffer=null)}),null!=n._dirtyBlenderMatrix&&n._blenderMatrix.decompose(i.scaling,i.rotationQuaternion,i.position))}),!0===this.applyRootMotion&&null!=this._dirtyMotionMatrix){if(this._rootMotionMatrix.decompose(this._rootMotionScaling,this._rootMotionRotation,this._rootMotionPosition),!0===this.isFirstFrame())this._deltaPosition.copyFrom(this._rootMotionPosition),this._deltaRotation.copyFrom(this._rootMotionRotation);else if(!0===this.isLastFrame()){if(this._rootMotionPosition.subtractToRef(this._lastMotionPosition,this._deltaPosition),e.Utilities.QuaternionDiffToRef(this._rootMotionRotation,this._lastMotionRotation,this._deltaRotation),!0===this._looptime&&!0===this._loopblend){var i=this._loopMotionSpeed+this._lastMotionSpeed;0!==i&&(i/=2),this._deltaPosition.normalize(),this._deltaPosition.scaleInPlace(i*t);var o=this._loopRotateSpeed+this._lastRotateSpeed;0!==o&&(o/=2),this._deltaRotation.toEulerAnglesToRef(this._angularVelocity),BABYLON.Quaternion.FromEulerAnglesToRef(this._angularVelocity.x,o,this._angularVelocity.z,this._deltaRotation)}}else this._rootMotionPosition.subtractToRef(this._lastMotionPosition,this._deltaPosition),e.Utilities.QuaternionDiffToRef(this._rootMotionRotation,this._lastMotionRotation,this._deltaRotation);var r=this._deltaPosition.length();this._rootMotionSpeed=r>0?r/t:r,this._deltaRotation.toEulerAnglesToRef(this._angularVelocity),this._lastMotionPosition.copyFrom(this._rootMotionPosition),this._lastMotionRotation.copyFrom(this._rootMotionRotation),this._lastMotionSpeed=this._rootMotionSpeed,this._lastRotateSpeed=this._angularVelocity.y,0===this._frametime&&(this._loopMotionSpeed=this._rootMotionSpeed,this._loopRotateSpeed=this._angularVelocity.y)}},n.prototype.checkStateMachine=function(e,t){var n=this;this._checkers.result=null,this._checkers.offest=0,this._checkers.blending=0,this._checkers.triggered=[],null!=e.animationStateMachine&&(e.animationStateMachine.time+=t,this.checkStateTransitions(e,e.animationStateMachine.transitions),null==this._checkers.result&&null!=this._machine.transitions&&this.checkStateTransitions(e,this._machine.transitions)),null!=this._checkers.triggered&&this._checkers.triggered.length>0&&(this._checkers.triggered.forEach(function(e){n.resetTrigger(e)}),this._checkers.triggered=null),null!=this._checkers.result&&(this.onAnimationTransitionObservable&&this.onAnimationTransitionObservable.hasObservers()&&this.onAnimationTransitionObservable.notifyObservers(this.transform),this.playCurrentAnimationState(e,this._checkers.result,this._checkers.blending,this._checkers.offest))},n.prototype.checkStateTransitions=function(t,n){var i=this,o=t.animationStateMachine.rate,r=t.animationStateMachine.length;if(null!=n&&n.length>0){var a=0,l=-1;for(a=0;a<n.length;a++)if(!0===n[a].solo&&!1===n[a].mute){l=a;break}var s=function(){var s=n[a];if(s.layerIndex!==t.index)return"continue";if(!0===s.mute)return"continue";if(l>=0&&l!==a)return"continue";var c=!1,d=0,p=!0;if(s.exitTime>0&&(d=r*s.exitTime/u.speedRatio,p=!0!==s.hasExitTime||t.animationStateMachine.time>=d),!0===s.hasExitTime&&s.intSource==e.InterruptionSource.None&&!1===p)return"continue";if(null!=s.conditions&&s.conditions.length>0){var h=0,m=s.conditions.length;s.conditions.forEach(function(t){var n=i._parameters.get(t.parameter);if(null!=n)if(n==e.AnimatorParameterType.Float||n==e.AnimatorParameterType.Int){var o=parseFloat(i.getFloat(t.parameter).toFixed(2));(t.mode===e.ConditionMode.Greater&&o>t.threshold||t.mode===e.ConditionMode.Less&&o<t.threshold||t.mode===e.ConditionMode.Equals&&o===t.threshold||t.mode===e.ConditionMode.NotEqual&&o!==t.threshold)&&h++}else if(n==e.AnimatorParameterType.Bool){var r=i.getBool(t.parameter);(t.mode===e.ConditionMode.If&&!0===r||t.mode===e.ConditionMode.IfNot&&!1===r)&&h++}else if(n==e.AnimatorParameterType.Trigger&&!0===i.getTrigger(t.parameter)){h++;for(var a=-1,l=0;l<i._checkers.triggered.length;l++)if(i._checkers.triggered[l]===t.parameter){a=l;break}a<0&&i._checkers.triggered.push(t.parameter)}}),c=!0===s.hasExitTime?!0===p&&h===m:h===m}else c=!0===s.hasExitTime&&!0===p;if(!0===c){!0===s.hasExitTime&&!0===p&&u.onAnimationEndObservable&&u.onAnimationEndObservable.hasObservers()&&u.onAnimationEndObservable.notifyObservers(t.index);var f=o>0?o:e.AnimationState.FPS,g=!1===s.isExit?s.destination:e.AnimationState.EXIT,y=!0===s.fixedDuration?s.duration:BABYLON.Scalar.Denormalize(s.duration,0,r),v=e.Utilities.ComputeBlendingSpeed(f,y),_=s.offset;return u._checkers.result=g,u._checkers.offest=_,u._checkers.blending=v,"break"}},u=this;for(a=0;a<n.length&&"break"!==s();a++);}},n.prototype.playCurrentAnimationState=function(t,n,i,o){if(void 0===o&&(o=0),null!=t&&null!=n&&""!==n&&n!==e.AnimationState.EXIT&&(null==t.animationStateMachine||t.animationStateMachine.name!==n)){null!=this.m_animationTargets&&this.m_animationTargets.length>0&&this.m_animationTargets.forEach(function(e){var n=e.target;if(null!=n.metadata&&null!=n.metadata.mixer){var o=n.metadata.mixer[t.index];null!=o&&(o.originalMatrix=null,o.blendingFactor=0,o.blendingSpeed=i)}});var r=this.getMachineState(n);null!=r&&r.layerIndex===t.index&&(r.time=0,r.played=0,r.interrupted=!1,t.animationTime=BABYLON.Scalar.Clamp(o),t.animationNormal=0,t.animationFirstRun=!0,t.animationEndFrame=!1,t.animationLoopFrame=!1,t.animationLoopCount=0,t.animationLoopEvents=null,t.animationStateMachine=r,this._deltaPosition.set(0,0,0),this._deltaRotation.set(0,0,0,0),this._angularVelocity.set(0,0,0),this._rootMotionSpeed=0,this._rootMotionMatrix.reset(),this._dirtyMotionMatrix=null,this._rootMotionPosition.set(0,0,0),this._rootMotionRotation.set(0,0,0,0),this._lastMotionPosition.set(0,0,0),this._lastMotionRotation.set(0,0,0,0))}},n.prototype.stopCurrentAnimationState=function(e){null!=e&&(null!=this.m_animationTargets&&this.m_animationTargets.length>0&&this.m_animationTargets.forEach(function(t){var n=t.target;if(null!=n.metadata&&null!=n.metadata.mixer){var i=n.metadata.mixer[e.index];null!=i&&(i.originalMatrix=null,i.blendingFactor=0,i.blendingSpeed=0)}}),e.animationTime=0,e.animationNormal=0,e.animationFirstRun=!0,e.animationEndFrame=!1,e.animationLoopFrame=!1,e.animationLoopCount=0,e.animationLoopEvents=null,e.animationStateMachine=null,this._deltaPosition.set(0,0,0),this._deltaRotation.set(0,0,0,0),this._angularVelocity.set(0,0,0),this._rootMotionSpeed=0,this._rootMotionMatrix.reset(),this._dirtyMotionMatrix=null,this._rootMotionPosition.set(0,0,0),this._rootMotionRotation.set(0,0,0,0),this._lastMotionPosition.set(0,0,0),this._lastMotionRotation.set(0,0,0,0))},n.prototype.checkAvatarTransformPath=function(e,t){var n=!1;if(null!=e.animationMaskMap){var i=e.animationMaskMap.get(t);null!=i&&i>=0&&(n=!0)}return n},n.prototype.filterTargetAvatarMask=function(e,t){var n=!1;if(null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.bone&&""!==t.metadata.toolkit.bone){var i=t.metadata.toolkit.bone;n=this.checkAvatarTransformPath(e,i)}return n},n.prototype.sortWeightedBlendingList=function(e){null!=e&&e.length>0&&e.sort(function(e,t){return e.weight<t.weight?1:e.weight>t.weight?-1:0})},n.prototype.computeWeightedFrameRatio=function(e){var t=1;if(null!=e&&e.length>0)if(this.sortWeightedBlendingList(e),this._blendWeights.primary=e[0],this._blendWeights.primary.weight<1&&e.length>1&&(this._blendWeights.secondary=e[1]),null!=this._blendWeights.primary&&null!=this._blendWeights.secondary){var n=BABYLON.Scalar.Clamp(this._blendWeights.primary.weight);t=BABYLON.Scalar.Lerp(this._blendWeights.secondary.ratio,this._blendWeights.primary.ratio,n)}else null!=this._blendWeights.primary&&null==this._blendWeights.secondary&&(t=this._blendWeights.primary.ratio);return t},n.prototype.setupTreeBranches=function(t){var n=this;null!=t&&null!=t.children&&t.children.length>0&&t.children.forEach(function(t){if(t.type===e.MotionType.Tree)n.setupTreeBranches(t.subtree);else if(t.type===e.MotionType.Clip&&null!=t.motion&&""!==t.motion&&(t.weight=0,t.ratio=0,t.track=n.getAnimationGroup(t.motion),null!=t.track)){var i=t.track.metadata.toolkit.length;t.ratio=e.AnimationState.TIME/i}})},n.prototype.parseTreeBranches=function(t,n,i,o){if(null!=n)switch(n.valueParameterX=null!=n.blendParameterX?parseFloat(this.getFloat(n.blendParameterX).toFixed(2)):0,n.valueParameterY=null!=n.blendParameterY?parseFloat(this.getFloat(n.blendParameterY).toFixed(2)):0,n.blendType){case e.BlendTreeType.Simple1D:this.parse1DSimpleTreeBranches(t,n,i,o);break;case e.BlendTreeType.SimpleDirectional2D:this.parse2DSimpleDirectionalTreeBranches(t,n,i,o);break;case e.BlendTreeType.FreeformDirectional2D:this.parse2DFreeformDirectionalTreeBranches(t,n,i,o);break;case e.BlendTreeType.FreeformCartesian2D:this.parse2DFreeformCartesianTreeBranches(t,n,i,o)}},n.prototype.parse1DSimpleTreeBranches=function(t,n,i,o){var r=this;if(null!=n&&null!=n.children&&n.children.length>0){var a=[];n.children.forEach(function(e){e.weight=0;var t={source:e,motion:e.motion,posX:e.threshold,posY:e.threshold,weight:e.weight};a.push(t)}),e.BlendTreeSystem.Calculate1DSimpleBlendTree(n.valueParameterX,a),a.forEach(function(e){null!=e.source&&(e.source.weight=e.weight)}),n.children.forEach(function(n){n.weight*=i,n.type===e.MotionType.Clip&&n.weight>0&&o.push(n),n.type===e.MotionType.Tree&&r.parseTreeBranches(t,n.subtree,n.weight,o)})}},n.prototype.parse2DSimpleDirectionalTreeBranches=function(t,n,i,o){var r=this;if(null!=n&&null!=n.children&&n.children.length>0){var a=[];n.children.forEach(function(e){e.weight=0;var t={source:e,motion:e.motion,posX:e.positionX,posY:e.positionY,weight:e.weight};a.push(t)}),e.BlendTreeSystem.Calculate2DFreeformDirectional(n.valueParameterX,n.valueParameterY,a),a.forEach(function(e){null!=e.source&&(e.source.weight=e.weight)}),n.children.forEach(function(n){n.weight*=i,n.type===e.MotionType.Clip&&n.weight>0&&o.push(n),n.type===e.MotionType.Tree&&r.parseTreeBranches(t,n.subtree,n.weight,o)})}},n.prototype.parse2DFreeformDirectionalTreeBranches=function(t,n,i,o){var r=this;if(null!=n&&null!=n.children&&n.children.length>0){var a=[];n.children.forEach(function(e){e.weight=0;var t={source:e,motion:e.motion,posX:e.positionX,posY:e.positionY,weight:e.weight};a.push(t)}),e.BlendTreeSystem.Calculate2DFreeformDirectional(n.valueParameterX,n.valueParameterY,a),a.forEach(function(e){null!=e.source&&(e.source.weight=e.weight)}),n.children.forEach(function(n){n.weight*=i,n.type===e.MotionType.Clip&&n.weight>0&&o.push(n),n.type===e.MotionType.Tree&&r.parseTreeBranches(t,n.subtree,n.weight,o)})}},n.prototype.parse2DFreeformCartesianTreeBranches=function(t,n,i,o){var r=this;if(null!=n&&null!=n.children&&n.children.length>0){var a=[];n.children.forEach(function(e){e.weight=0;var t={source:e,motion:e.motion,posX:e.positionX,posY:e.positionY,weight:e.weight};a.push(t)}),e.BlendTreeSystem.Calculate2DFreeformCartesian(n.valueParameterX,n.valueParameterY,a),a.forEach(function(e){null!=e.source&&(e.source.weight=e.weight)}),n.children.forEach(function(n){n.weight*=i,n.type===e.MotionType.Clip&&n.weight>0&&o.push(n),n.type===e.MotionType.Tree&&r.parseTreeBranches(t,n.subtree,n.weight,o)})}},n.FPS=30,n.EXIT="[EXIT]",n.TIME=1,n}(e.ScriptComponent);e.AnimationState=t;e.BlendTreeValue=function(e){this.source=e.source,this.motion=e.motion,this.posX=e.posX||0,this.posY=e.posY||0,this.weight=e.weight||0};var n=function(){function e(){}return e.ClampValue=function(e,t,n){return e<=t?t:e>=n?n:e},e.GetSignedAngle=function(e,t){return Math.atan2(e.x*t.y-e.y*t.x,e.x*t.x+e.y*t.y)},e.GetLinearInterpolation=function(e,t,n,i,o){return t+(i-t)/(n-e)*(o-e)},e.GetRightNeighbourIndex=function(e,t){t.sort(function(e,t){return e.posX-t.posX});for(var n=0;n<t.length;++n)if(t[n].posX>e)return n;return-1},e}();e.BlendTreeUtils=n;var i=function(){function t(){}return t.Calculate1DSimpleBlendTree=function(t,n){var i=n[0],o=n[n.length-1];if(t<=i.posX)i.weight=1;else if(t>=o.posX)o.weight=1;else{var r=e.BlendTreeUtils.GetRightNeighbourIndex(t,n),a=n[r-1],l=n[r],s=e.BlendTreeUtils.GetLinearInterpolation(a.posX,1,l.posX,0,t);a.weight=s,l.weight=1-a.weight}},t.Calculate2DFreeformDirectional=function(t,n,i){e.BlendTreeSystem.TempVector2_IP.set(t,n),e.BlendTreeSystem.TempVector2_POSI.set(0,0),e.BlendTreeSystem.TempVector2_POSJ.set(0,0),e.BlendTreeSystem.TempVector2_POSIP.set(0,0),e.BlendTreeSystem.TempVector2_POSIJ.set(0,0);for(var o=0,r=e.BlendTreeSystem.TempVector2_IP.length(),a=0;a<i.length;++a){var l=i[a];e.BlendTreeSystem.TempVector2_POSI.set(l.posX,l.posY);for(var s=e.BlendTreeSystem.TempVector2_POSI.length(),u=r-s,c=e.BlendTreeUtils.GetSignedAngle(e.BlendTreeSystem.TempVector2_POSI,e.BlendTreeSystem.TempVector2_IP),d=1,p=0;p<i.length;++p)if(p!==a){e.BlendTreeSystem.TempVector2_POSJ.set(i[p].posX,i[p].posY);var h=e.BlendTreeSystem.TempVector2_POSJ.length(),m=(s+h)/2,f=u/m,g=(h-s)/m,y=e.BlendTreeUtils.GetSignedAngle(e.BlendTreeSystem.TempVector2_POSI,e.BlendTreeSystem.TempVector2_POSJ);e.BlendTreeSystem.TempVector2_POSIP.set(f,2*c),e.BlendTreeSystem.TempVector2_POSIJ.set(g,2*y);var v=e.BlendTreeSystem.TempVector2_POSIJ.lengthSquared(),_=BABYLON.Vector2.Dot(e.BlendTreeSystem.TempVector2_POSIP,e.BlendTreeSystem.TempVector2_POSIJ)/v;_=1-_,_=e.BlendTreeUtils.ClampValue(_,0,1),d=Math.min(_,d)}l.weight=d,o+=d}for(var S=0,B=i;S<B.length;S++)(l=B[S]).weight/=o},t.Calculate2DFreeformCartesian=function(t,n,i){e.BlendTreeSystem.TempVector2_IP.set(t,n),e.BlendTreeSystem.TempVector2_POSI.set(0,0),e.BlendTreeSystem.TempVector2_POSJ.set(0,0),e.BlendTreeSystem.TempVector2_POSIP.set(0,0),e.BlendTreeSystem.TempVector2_POSIJ.set(0,0);for(var o=0,r=0;r<i.length;++r){var a=i[r];e.BlendTreeSystem.TempVector2_POSI.set(a.posX,a.posY),e.BlendTreeSystem.TempVector2_IP.subtractToRef(e.BlendTreeSystem.TempVector2_POSI,e.BlendTreeSystem.TempVector2_POSIP);for(var l=1,s=0;s<i.length;++s)if(s!==r){e.BlendTreeSystem.TempVector2_POSJ.set(i[s].posX,i[s].posY),e.BlendTreeSystem.TempVector2_POSJ.subtractToRef(e.BlendTreeSystem.TempVector2_POSI,e.BlendTreeSystem.TempVector2_POSIJ);var u=e.BlendTreeSystem.TempVector2_POSIJ.lengthSquared(),c=BABYLON.Vector2.Dot(e.BlendTreeSystem.TempVector2_POSIP,e.BlendTreeSystem.TempVector2_POSIJ)/u;c=1-c,c=e.BlendTreeUtils.ClampValue(c,0,1),l=Math.min(l,c)}a.weight=l,o+=l}for(var d=0,p=i;d<p.length;d++)(a=p[d]).weight/=o},t.TempVector2_IP=new BABYLON.Vector2(0,0),t.TempVector2_POSI=new BABYLON.Vector2(0,0),t.TempVector2_POSJ=new BABYLON.Vector2(0,0),t.TempVector2_POSIP=new BABYLON.Vector2(0,0),t.TempVector2_POSIJ=new BABYLON.Vector2(0,0),t}();e.BlendTreeSystem=i;e.MachineState=function(){};e.TransitionCheck=function(){};e.AnimationMixer=function(){};var r,a,l,s,u,c;e.BlendingWeights=function(){},(c=e.MotionType||(e.MotionType={}))[c.Clip=0]="Clip",c[c.Tree=1]="Tree",(u=e.ConditionMode||(e.ConditionMode={}))[u.If=1]="If",u[u.IfNot=2]="IfNot",u[u.Greater=3]="Greater",u[u.Less=4]="Less",u[u.Equals=6]="Equals",u[u.NotEqual=7]="NotEqual",(s=e.InterruptionSource||(e.InterruptionSource={}))[s.None=0]="None",s[s.Source=1]="Source",s[s.Destination=2]="Destination",s[s.SourceThenDestination=3]="SourceThenDestination",s[s.DestinationThenSource=4]="DestinationThenSource",(l=e.BlendTreeType||(e.BlendTreeType={}))[l.Simple1D=0]="Simple1D",l[l.SimpleDirectional2D=1]="SimpleDirectional2D",l[l.FreeformDirectional2D=2]="FreeformDirectional2D",l[l.FreeformCartesian2D=3]="FreeformCartesian2D",l[l.Direct=4]="Direct",l[l.Clip=5]="Clip",(a=e.BlendTreePosition||(e.BlendTreePosition={}))[a.Lower=0]="Lower",a[a.Upper=1]="Upper",(r=e.AnimatorParameterType||(e.AnimatorParameterType={}))[r.Float=1]="Float",r[r.Int=3]="Int",r[r.Bool=4]="Bool",r[r.Trigger=9]="Trigger",e.SceneManager.RegisterClass("TOOLKIT.AnimationState",t)}(i||(i={})),function(e){var t=function(t){function n(e,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.AudioSource");var r=t.call(this,e,n,i,o)||this;return r._audio=null,r._name=null,r._loop=!1,r._mute=!1,r._pitch=1,r._volume=1,r._preload=!1,r._playonawake=!0,r._spatialblend=0,r._preloaderUrl=null,r._lastmutedvolume=null,r._priority=128,r._panstereo=0,r._mindistance=0,r._maxdistance=50,r._reverbzonemix=1,r._bypasseffects=!1,r._bypassreverbzones=!1,r._bypasslistenereffects=!1,r._enablelegacyaudio=!1,r._initializedReadyInstance=!1,r._isAudioPlaying=!1,r._isAudioPaused=!1,r.onReadyObservable=new BABYLON.Observable,r}return o(n,t),n.prototype.getSoundClip=function(){return this._audio},n.prototype.awake=function(){this.awakeAudioSource()},n.prototype.start=function(){this.startAudioSource()},n.prototype.destroy=function(){this.destroyAudioSource()},n.prototype.awakeAudioSource=function(){return r(this,void 0,void 0,function(){var t,n,i;return a(this,function(o){switch(o.label){case 0:return this._name=this.getProperty("name",this._name),this._loop=this.getProperty("loop",this._loop),this._mute=this.getProperty("mute",this._mute),this._pitch=this.getProperty("pitch",this._pitch),this._volume=this.getProperty("volume",this._volume),this._preload=this.getProperty("preload",this._preload),this._priority=this.getProperty("priority",this._priority),this._panstereo=this.getProperty("panstereo",this._panstereo),this._playonawake=this.getProperty("playonawake",this._playonawake),this._mindistance=this.getProperty("mindistance",this._mindistance),this._maxdistance=this.getProperty("maxdistance",this._maxdistance),this._spatialblend=this.getProperty("spatialblend",this._spatialblend),this._reverbzonemix=this.getProperty("reverbzonemix",this._reverbzonemix),this._bypasseffects=this.getProperty("bypasseffects",this._bypasseffects),this._bypassreverbzones=this.getProperty("bypassreverbzones",this._bypassreverbzones),this._bypasslistenereffects=this.getProperty("bypasslistenereffects",this._bypasslistenereffects),this._enablelegacyaudio=this.getProperty("enablelegacyaudio",this._enablelegacyaudio),null!=this._name&&""!==this._name||(this._name="Unknown"),null==(t=this.getProperty("file"))||""===t?[3,4]:(n=e.SceneManager.GetRootUrl(this.scene),null==(i=n+t)||""===i?[3,4]:!0!==this._preload?[3,1]:(this._preloaderUrl=i,[3,4]));case 1:return!0!==this._enablelegacyaudio?[3,2]:(this.setLegacyDataSource(i),[3,4]);case 2:return[4,this.setAudioDataSource(i)];case 3:o.sent(),o.label=4;case 4:return[2]}})})},n.prototype.startAudioSource=function(){this._volume>=e.AudioSource.MAX_VOLUME&&(this._volume=e.AudioSource.DEFAULT_LEVEL)},n.prototype.destroyAudioSource=function(){this.onReadyObservable.clear(),this.onReadyObservable=null,null!=this._audio&&(this._audio.dispose(),this._audio=null)},n.prototype.isReady=function(){return null!=this._audio},n.prototype.isLegacy=function(){return this._enablelegacyaudio},n.prototype.isPlaying=function(){return this._isAudioPlaying},n.prototype.isPaused=function(){return this._isAudioPaused},n.prototype.play=function(t,n,i){return r(this,void 0,void 0,function(){return a(this,function(o){switch(o.label){case 0:return[4,e.AudioSource.UnlockAudioEngine()];case 1:return o.sent(),this.internalPlay(t,n,i),[2,!0]}})})},n.prototype.internalPlay=function(e,t,n){var i=this;null!=this._audio&&(!0===this._initializedReadyInstance?(this._audio instanceof BABYLON.StaticSound?this._audio.play({waitTime:e,startOffset:t,duration:n}):this._audio instanceof BABYLON.Sound&&this._audio.play(e,t,n),this._isAudioPlaying=!0,this._isAudioPaused=!1):this.onReadyObservable.addOnce(function(){i._audio instanceof BABYLON.StaticSound?i._audio.play({waitTime:e,startOffset:t,duration:n}):i._audio instanceof BABYLON.Sound&&i._audio.play(e,t,n),i._isAudioPlaying=!0,i._isAudioPaused=!1}))},n.prototype.pause=function(){var e=!1;return null!=this._audio&&(this._audio.pause(),this._isAudioPlaying=!1,this._isAudioPaused=!0,e=!0),e},n.prototype.stop=function(e){var t=!1;return null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?this._audio.stop({waitTime:e}):this._audio instanceof BABYLON.Sound&&this._audio.stop(e),this._isAudioPlaying=!1,this._isAudioPaused=!1,t=!0),t},n.prototype.mute=function(t){var n=this;return null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?null!=t&&t>0?e.WindowManager.SetTimeout(t/1e3,function(){n._lastmutedvolume=n._audio.volume,n._audio.volume=0}):(this._lastmutedvolume=this._audio.volume,this._audio.volume=0):this._audio instanceof BABYLON.Sound&&(this._lastmutedvolume=this._audio.getVolume(),this._audio.setVolume(0,t))),!1},n.prototype.unmute=function(t){var n=this;return null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?null!=t&&t>0?e.WindowManager.SetTimeout(t/1e3,function(){null!=n._lastmutedvolume&&(n._audio.volume=n._lastmutedvolume,n._lastmutedvolume=null)}):null!=this._lastmutedvolume&&(this._audio.volume=this._lastmutedvolume,this._lastmutedvolume=null):this._audio instanceof BABYLON.Sound&&null!=this._lastmutedvolume&&(this._audio.setVolume(this._lastmutedvolume,t),this._lastmutedvolume=null)),!1},n.prototype.getPitch=function(){return null==this._audio?0:this._audio instanceof BABYLON.StaticSound?this._audio.playbackRate:this._audio instanceof BABYLON.Sound?this._audio.getPlaybackRate():void 0},n.prototype.setPitch=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?this._audio.playbackRate=e:this._audio instanceof BABYLON.Sound&&this._audio.setPlaybackRate(e))},n.prototype.getVolume=function(){var e=0;return null!=this._audio?this._audio instanceof BABYLON.StaticSound?e=this._audio.volume:this._audio instanceof BABYLON.Sound&&(e=this._audio.getVolume()):e=this._volume,e},n.prototype.setVolume=function(t,n){var i=this;return this._volume=t,null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?null!=n&&n>0?e.WindowManager.SetTimeout(n/1e3,function(){i._audio.volume=i._volume}):this._audio.volume=this._volume:this._audio instanceof BABYLON.Sound&&this._audio.setVolume(this._volume,n)),!0},n.prototype.setPosition=function(e){this._audio instanceof BABYLON.StaticSound?this._audio.spatial.position=e:this._audio instanceof BABYLON.Sound&&this._audio.setPosition(e)},n.prototype.getPlaybackSpeed=function(){return null==this._audio?0:this._audio instanceof BABYLON.StaticSound?this._audio.playbackRate:this._audio instanceof BABYLON.Sound?this._audio.getPlaybackRate():void 0},n.prototype.setPlaybackSpeed=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?this._audio.playbackRate=e:this._audio instanceof BABYLON.Sound&&this._audio.setPlaybackRate(e))},n.prototype.setRolloffMode=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound&&("linear"===e||"inverse"===e||"exponential"===e)?this._audio.spatial.distanceModel=e:this._audio instanceof BABYLON.Sound&&(this._audio.distanceModel=e))},n.prototype.setMinDistance=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?this._audio.spatial.minDistance=e:this._audio instanceof BABYLON.Sound&&(this._audio.refDistance=e))},n.prototype.setMaxDistance=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?this._audio.spatial.maxDistance=e:this._audio instanceof BABYLON.Sound&&(this._audio.maxDistance=e))},n.prototype.setSpatialBlend=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound||(this._audio,BABYLON.Sound))},n.prototype.hasSpatialSound=function(){var e=!1;return null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?e=null!=this._audio.spatial:this._audio instanceof BABYLON.Sound&&(e=this._audio.spatialSound)),e},n.prototype.getSpatialSound=function(){var e=null;return null!=this._audio&&this._audio instanceof BABYLON.StaticSound&&(e=this._audio.spatial),e},n.prototype.setSpatialSound=function(e){null!=this._audio&&this._audio instanceof BABYLON.StaticSound&&(this._audio.spatial=e)},n.prototype.attachToSpatialNode=function(e){null!=this._audio&&(this._audio instanceof BABYLON.StaticSound?this._audio.spatial.attach(e):this._audio instanceof BABYLON.Sound&&this._audio.attachToMesh(e))},n.prototype.getCurrentTrackTime=function(){var e=0;return null!=this._audio&&(e=this._audio.currentTime),e},n.prototype.setAudioDataSource=function(t){return r(this,void 0,void 0,function(){var n,i;return a(this,function(o){switch(o.label){case 0:return null!=this._audio&&(this._audio.dispose(),this._audio=null),n=this._spatialblend>=.1,this._initializedReadyInstance=!1,this._lastmutedvolume=this._volume,i=this,[4,e.AudioSource.CreateStaticSound(this._name,t,{loop:this._loop,volume:!0===this._mute?0:this._volume,autoplay:!1,playbackRate:this._pitch,spatialEnabled:n,spatialAutoUpdate:!0,spatialPosition:this.transform.absolutePosition.clone(),spatialDistanceModel:"linear",spatialMinDistance:this._mindistance,spatialMaxDistance:this._maxdistance,spatialRolloffFactor:e.AudioSource.DEFAULT_ROLLOFF})];case 1:return i._audio=o.sent(),null!=this._audio&&(this._initializedReadyInstance=!0,!0===n&&null!=this._audio.spatial&&this._audio.spatial.attach(this.transform),this.onReadyObservable&&this.onReadyObservable.hasObservers()&&this.onReadyObservable.notifyObservers(this._audio),!0===this._playonawake&&this.play()),[2]}})})},n.prototype.setLegacyDataSource=function(t){var n=this;null!=this._audio&&(this._audio.dispose(),this._audio=null);var i=this._spatialblend>=.1,o=null!=this.transform.metadata&&null!=this.transform.metadata.vtt&&!0===this.transform.metadata.vtt;this._initializedReadyInstance=!1,this._audio=new BABYLON.Sound(this._name,t,this.scene,function(){n._lastmutedvolume=n._volume,n._audio.setVolume(!0===n._mute?0:n._volume),n._audio.setPlaybackRate(n._pitch),n._audio.setPosition(n.transform.absolutePosition.clone()),n._initializedReadyInstance=!0,!0===i&&n._audio.attachToMesh(n.transform),n.onReadyObservable&&n.onReadyObservable.hasObservers()&&n.onReadyObservable.notifyObservers(n._audio),!0===n._playonawake&&n.play()},{loop:this._loop,autoplay:!1,refDistance:this._mindistance,maxDistance:this._maxdistance,rolloffFactor:e.AudioSource.DEFAULT_ROLLOFF,spatialSound:i,distanceModel:"linear",streaming:o})},n.prototype.addPreloaderTasks=function(e){var t=this;!0===this._preload&&(e.addBinaryFileTask(this.transform.name+".AudioTask",this._preloaderUrl).onSuccess=function(e){return r(t,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return!0!==this._enablelegacyaudio?[3,1]:(this.setLegacyDataSource(e.data),[3,3]);case 1:return[4,this.setAudioDataSource(e.data)];case 2:t.sent(),t.label=3;case 3:return[2]}})})})},n.IsLegacyEngine=function(){return null!=e.SceneManager.GlobalOptions.enablelegacyaudio&&e.SceneManager.GlobalOptions.enablelegacyaudio},n.GetAudioOptions=function(){return e.AudioSource.AUDIO_ENGINE_V2_OPTIONS},n.SetAudioOptions=function(t){e.AudioSource.AUDIO_ENGINE_V2_OPTIONS=t},n.GetAudioEngine=function(){return r(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return null!=e.AudioSource.AUDIO_ENGINE_V2?[3,2]:(t=e.AudioSource,[4,BABYLON.CreateAudioEngineAsync(e.AudioSource.AUDIO_ENGINE_V2_OPTIONS||{listenerAutoUpdate:!0,listenerEnabled:!1,resumeOnInteraction:!0,resumeOnPause:!0})]);case 1:t.AUDIO_ENGINE_V2=n.sent(),n.label=2;case 2:return[2,e.AudioSource.AUDIO_ENGINE_V2]}})})},n.UnlockLegacyAudio=function(){null==BABYLON.Engine.audioEngine||BABYLON.Engine.audioEngine.unlocked||BABYLON.Engine.audioEngine.unlock()},n.UnlockAudioEngine=function(){return r(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,e.AudioSource.GetAudioEngine()];case 1:return null==(t=n.sent())?[3,3]:[4,t.unlockAsync()];case 2:n.sent(),n.label=3;case 3:return[2]}})})},n.AttachSpatialCamera=function(t){return r(this,void 0,void 0,function(){var n;return a(this,function(i){switch(i.label){case 0:return[4,e.AudioSource.GetAudioEngine()];case 1:return null!=(n=i.sent())&&null!=n.listener&&n.listener.attach(t),[2]}})})},n.DetachSpatialCamera=function(){return r(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return[4,e.AudioSource.GetAudioEngine()];case 1:return null!=(t=n.sent())&&null!=t.listener&&t.listener.detach(),[2]}})})},n.UpdateSpatialCamera=function(t,n){return r(this,void 0,void 0,function(){var i;return a(this,function(o){switch(o.label){case 0:return[4,e.AudioSource.GetAudioEngine()];case 1:return null!=(i=o.sent())&&null!=i.listener&&(null!=t&&i.listener.position.copyFrom(t),null==i.listener.rotationQuaternion&&(i.listener.rotationQuaternion=new BABYLON.Quaternion(0,0,0,1)),null!=n&&i.listener.rotationQuaternion.copyFrom(n),i.listener.update()),[2]}})})},n.CreateSoundBuffer=function(t,n){return r(this,void 0,void 0,function(){var i,o;return a(this,function(r){switch(r.label){case 0:return i=null,[4,e.AudioSource.GetAudioEngine()];case 1:return null==(o=r.sent())?[3,3]:[4,o.createSoundBufferAsync(t,n)];case 2:i=r.sent(),r.label=3;case 3:return[2,i]}})})},n.CreateStaticSound=function(t,n,i){return r(this,void 0,void 0,function(){var o,r;return a(this,function(a){switch(a.label){case 0:return o=null,[4,e.AudioSource.GetAudioEngine()];case 1:return null==(r=a.sent())?[3,3]:[4,r.createSoundAsync(t,n,i)];case 2:o=a.sent(),a.label=3;case 3:return[2,o]}})})},n.CreateStreamingSound=function(t,n,i){return r(this,void 0,void 0,function(){var o,r;return a(this,function(a){switch(a.label){case 0:return o=null,[4,e.AudioSource.GetAudioEngine()];case 1:return null==(r=a.sent())?[3,3]:[4,r.createStreamingSoundAsync(t,n,i)];case 2:o=a.sent(),a.label=3;case 3:return[2,o]}})})},n.MAX_VOLUME=1,n.DEFAULT_LEVEL=1,n.DEFAULT_ROLLOFF=1,n.AUDIO_ENGINE_V2=null,n.AUDIO_ENGINE_V2_OPTIONS={listenerAutoUpdate:!0,listenerEnabled:!1,resumeOnInteraction:!0,resumeOnPause:!0},n}(e.ScriptComponent);e.AudioSource=t,e.SceneManager.RegisterClass("TOOLKIT.AudioSource",t)}(i||(i={})),function(e){var t=function(t){function n(e,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.CharacterController");var r=t.call(this,e,n,i,o)||this;return r._avatarRadius=.28,r._avatarHeight=1.8,r._centerOffset=new BABYLON.Vector3(0,.94,0),r._slopeLimit=45,r._skinWidth=.025,r._stepHeight=.25,r._minMoveDistance=.001,r._slopeSlideSpeed=10,r._slopeAngleRadians=0,r._slopeAngleDegrees=0,r._slopeMoveDirection=0,r._verticalVelocity=0,r._verticalStepSpeed=1,r._minimumStepHeight=.15,r._collisionEvents=!0,r._targetRotation=new BABYLON.Quaternion(0,0,0,1),r._targetVelocity=new BABYLON.Vector3,r._currentVelocity=new BABYLON.Vector3(0,0,0),r._inputVelocity=new BABYLON.Vector3(0,0,0),r._gravityFactor=3,r._minJumpTimer=0,r._maxSlopeTimer=0,r._isSliding=!1,r._isGrounded=!1,r._isSteppingUp=!1,r._stepUpStartPosition=new BABYLON.Vector3(0,0,0),r._stepUpTargetPosition=new BABYLON.Vector3(0,0,0),r._stepUpProgress=0,r._stepUpDuration=.2,r._stepUpVerticalVelocity=0,r._stepCheckDistance=.1,r._stepCheckShape=null,r._stepLocalRaycastResult=null,r._stepForwardRaycastResult=null,r._stepHeightRaycastResult=null,r._stepLandingRaycastResult=null,r._lastStepDebugLogTime=0,r._stepDebugLogIntervalMs=250,r._hitColor=new BABYLON.Color3(0,1,0),r._noHitColor=new BABYLON.Color3(1,0,0),r._groundRay=null,r._groundRayHelper=null,r._groundHitPointMesh=null,r._stepCheckOriginMesh=null,r._stepCheckHitPointMesh=null,r._stepCheckDestinationMesh=null,r._stepCheckRayHelper=null,r._stepCheckRay=null,r._stepDebugHitMaterial=null,r._stepDebugNoHitMaterial=null,r._stepHeightOriginMesh=null,r._stepHeightHitPointMesh=null,r._stepClearanceOriginMesh=null,r._stepClearanceHitPointMesh=null,r._stepForwardLine=null,r._stepHeightLine=null,r._stepClearanceLine=null,r._stepCheckRaycastOrigin=new BABYLON.Vector3(0,0,0),r._stepCheckRaycastDestination=new BABYLON.Vector3(0,0,0),r._stepCheckRaycastHitPoint=new BABYLON.Vector3(0,0,0),r._stepCheckRaycastResult=null,r._groundRaycastShape=null,r._groundCollisionNode=null,r._groundRaycastOffset=new BABYLON.Vector3(0,0,0),r._groundRaycastOrigin=new BABYLON.Vector3(0,0,0),r._groundRaycastDirection=new BABYLON.Vector3(0,-1,0),r._groundRaycastDestination=new BABYLON.Vector3(0,0,0),r._localGroundShapecastResult=null,r._worldGroundShapecastResult=null,r.m_moveDeltaX=0,r.m_moveDeltaZ=0,r.m_havokplugin=null,r.onUpdatePositionObservable=new BABYLON.Observable,r.onUpdateVelocityObservable=new BABYLON.Observable,r.enableGravity=!0,r.downwardForce=0,r.raycastLength=.01,r.enableStepOffset=!1,r.showRaycasts=!1,r}return o(n,t),n.prototype.getAvatarRadius=function(){return this._avatarRadius},n.prototype.getAvatarHeight=function(){return this._avatarHeight},n.prototype.getCenterOffset=function(){return this._centerOffset},n.prototype.getSkinWidth=function(){return this._skinWidth},n.prototype.getStepHeight=function(){return this._stepHeight},n.prototype.getGravityFactor=function(){return this._gravityFactor},n.prototype.setGravityFactor=function(e){this._gravityFactor=e},n.prototype.getInputVelocity=function(){return this._inputVelocity},n.prototype.getVerticalVelocity=function(){return!0===this.isGrounded()?0:this._currentVelocity.y},n.prototype.getSlopeAngleRadians=function(){return this._slopeAngleRadians},n.prototype.getSlopeAngleDegrees=function(){return this._slopeAngleDegrees},n.prototype.getGroundCollisionNode=function(){return this._groundCollisionNode},n.prototype.getVerticalStepSpeed=function(){return this._verticalStepSpeed},n.prototype.setVerticalStepSpeed=function(e){this._verticalStepSpeed=e},n.prototype.getMinimumStepHeight=function(){return this._minimumStepHeight},n.prototype.setMinimumStepHeight=function(e){this._minimumStepHeight=e},n.prototype.getMinMoveDistance=function(){return this._minMoveDistance},n.prototype.setMinMoveDistance=function(e){this._minMoveDistance=e},n.prototype.getSlopeSlideSpeed=function(){return this._slopeSlideSpeed},n.prototype.setSlopeSlideSpeed=function(e){this._slopeSlideSpeed=e},n.prototype.getSlopeLimit=function(){return this._slopeLimit},n.prototype.setSlopeLimit=function(e){this._slopeLimit=e},n.prototype.isSteppingUp=function(){return this._isSteppingUp},n.prototype.isGrounded=function(){return this._isGrounded},n.prototype.isSliding=function(){return this._isSliding},n.prototype.canSlide=function(){return this._slopeAngleDegrees>0&&(this._slopeMoveDirection<=0||this._slopeMoveDirection>0&&this._maxSlopeTimer>=e.CharacterController.DEFAULT_SLIDING_TIMER)},n.prototype.canJump=function(){return!0===this.isGrounded()&&!this._isSteppingUp},n.prototype.getStepUpProgress=function(){return this._stepUpProgress},n.prototype.getStepUpDuration=function(){return this._stepUpDuration},n.prototype.setStepUpDuration=function(e){this._stepUpDuration=Math.max(.05,e)},n.prototype.getStepCheckDistance=function(){return this._stepCheckDistance},n.prototype.setStepCheckDistance=function(e){this._stepCheckDistance=Math.max(.01,e)},n.prototype.awake=function(){this._avatarRadius=this.getProperty("avatarRadius",this._avatarRadius),this._avatarHeight=this.getProperty("avatarHeight",this._avatarHeight),this._slopeLimit=this.getProperty("slopeLimit",this._slopeLimit),this._skinWidth=this.getProperty("skinWidth",this._skinWidth),this._stepHeight=this.getProperty("stepOffset",this._stepHeight),this._minMoveDistance=this.getProperty("minMoveDistance",this._minMoveDistance),this._collisionEvents=this.getProperty("collisionEvents",this._collisionEvents);var t=this.getProperty("centerOffset");null!=t&&(this._centerOffset=e.Utilities.ParseVector3(t)),this.enableStepOffset=this.getProperty("enableStepOffset",this.enableStepOffset),this._stepCheckDistance=this._skinWidth+.05,this._stepUpDuration=1/this._verticalStepSpeed,this.createPhysicsBodyAndShape(e.CharacterController.DEFAULT_CHARACTER_MASS,e.Utilities.GetLayerMask(31),-1),this.enableCollisionEvents(),this.onCollisionEnterObservable.add(function(e){}),this.onCollisionStayObservable.add(function(e){}),this.onCollisionExitObservable.add(function(e){})},n.prototype.update=function(){var e=this.getDeltaSeconds();this._minJumpTimer>0&&(this._minJumpTimer-=e,this._minJumpTimer<0&&(this._minJumpTimer=0)),this._slopeAngleDegrees>0?this._maxSlopeTimer+=e:this._maxSlopeTimer=0},n.prototype.fixed=function(){var e,t;if(null!=this.transform){null!=this.transform.physicsBody?this.transform.physicsBody.getLinearVelocityToRef(this._currentVelocity):this._currentVelocity.set(0,0,0),this.m_moveDeltaX=this._targetVelocity.x,this.m_moveDeltaZ=this._targetVelocity.z,Math.abs(this.m_moveDeltaX)<this._minMoveDistance&&(this.m_moveDeltaX>0?this.m_moveDeltaX=this._minMoveDistance:this.m_moveDeltaX<0&&(this.m_moveDeltaX=-this._minMoveDistance)),Math.abs(this.m_moveDeltaZ)<this._minMoveDistance&&(this.m_moveDeltaZ>0?this.m_moveDeltaZ=this._minMoveDistance:this.m_moveDeltaZ<0&&(this.m_moveDeltaZ=-this._minMoveDistance)),this._inputVelocity.set(this.m_moveDeltaX,0,this.m_moveDeltaZ),this.enableStepOffset&&this._inputVelocity.length()>0&&this.handleStepOffset(this._inputVelocity),this.updateStepUpAnimation();var n=null;if(this._isSteppingUp||(n=this.updateGroundedState(),this.updateSlopesAndSlides(null===(e=null==n?void 0:n.world)||void 0===e?void 0:e.hasHit,null===(t=null==n?void 0:n.world)||void 0===t?void 0:t.hitNormal)),this.onUpdateVelocityObservable&&this.onUpdateVelocityObservable.hasObservers()&&this.onUpdateVelocityObservable.notifyObservers(this.transform),this._isSteppingUp?this._inputVelocity.y=this._stepUpVerticalVelocity:this._inputVelocity.y=!0===this.enableGravity?this._verticalVelocity+this.downwardForce:this.downwardForce,null!=this.transform.physicsBody)try{this.transform.physicsBody.setLinearVelocity(this._inputVelocity)}catch(e){console.warn("Failed to set linear velocity on physics body: ",e)}else console.warn("No physics body attached to character controller transform: "+this.transform.name);this.onUpdatePositionObservable&&this.onUpdatePositionObservable.hasObservers()&&this.onUpdatePositionObservable.notifyObservers(this.transform)}},n.prototype.shouldAttemptStepOffset=function(e){return!(!this.enableStepOffset||!this.isGrounded()||this._isSteppingUp||e.length()<this._minMoveDistance)},n.prototype.detectStepObstacle=function(t){if(!this.shouldAttemptStepOffset(t))return!1;var n=new BABYLON.Vector3(t.x,0,t.z).normalize(),i=this._stepCheckDistance+this._avatarRadius+this._skinWidth,o=this.transform.absolutePosition.clone();o.y+=this._centerOffset.y-this._avatarHeight/2;var r=o.clone();r.y+=this._minimumStepHeight+this._skinWidth;var a=r.add(n.scale(i)),l=.8*this._avatarRadius;null==this._stepCheckShape&&(this._stepCheckShape=new BABYLON.PhysicsShapeSphere(new BABYLON.Vector3(0,0,0),l,this.scene));var s={shape:this._stepCheckShape,rotation:this.transform.rotationQuaternion,startPosition:r,endPosition:a,ignoreBody:this.transform.physicsBody,shouldHitTriggers:!1};if(null==this._stepLocalRaycastResult&&(this._stepLocalRaycastResult=new BABYLON.ShapeCastResult),null==this._stepForwardRaycastResult&&(this._stepForwardRaycastResult=new BABYLON.ShapeCastResult),this._stepLocalRaycastResult.reset(),this._stepForwardRaycastResult.reset(),e.RigidbodyPhysics.ShapecastToRef(s,this._stepLocalRaycastResult,this._stepForwardRaycastResult),this.showRaycasts||e.Utilities.ShowDebugColliders()){null==this._stepDebugHitMaterial&&(this._stepDebugHitMaterial=new BABYLON.StandardMaterial("StepDebugHitMat",this.scene),this._stepDebugHitMaterial.diffuseColor=new BABYLON.Color3(0,1,0),this._stepDebugHitMaterial.alpha=.6),null==this._stepDebugNoHitMaterial&&(this._stepDebugNoHitMaterial=new BABYLON.StandardMaterial("StepDebugNoHitMat",this.scene),this._stepDebugNoHitMaterial.diffuseColor=new BABYLON.Color3(1,0,0),this._stepDebugNoHitMaterial.alpha=.25),null==this._stepCheckOriginMesh&&(this._stepCheckOriginMesh=BABYLON.MeshBuilder.CreateSphere("StepCheckOrigin",{diameter:.05},this.scene),this._stepCheckOriginMesh.isPickable=!1,this._stepCheckOriginMesh.material=this._stepDebugNoHitMaterial),null==this._stepCheckDestinationMesh&&(this._stepCheckDestinationMesh=BABYLON.MeshBuilder.CreateSphere("StepCheckDest",{diameter:.05},this.scene),this._stepCheckDestinationMesh.isPickable=!1,this._stepCheckDestinationMesh.material=this._stepDebugNoHitMaterial),null==this._stepCheckHitPointMesh&&(this._stepCheckHitPointMesh=BABYLON.MeshBuilder.CreateSphere("StepCheckHit",{diameter:.06},this.scene),this._stepCheckHitPointMesh.isPickable=!1,this._stepCheckHitPointMesh.material=this._stepDebugHitMaterial),this._stepCheckOriginMesh.position.copyFrom(r),this._stepCheckDestinationMesh.position.copyFrom(a);var u=[r,a];if(null!=this._stepForwardLine){try{this._stepForwardLine.dispose()}catch(e){}this._stepForwardLine=null}this._stepForwardLine=BABYLON.MeshBuilder.CreateLines("StepForwardLine",{points:u,updatable:!1},this.scene),this._stepForwardRaycastResult.hasHit?(this._stepCheckHitPointMesh.position.copyFrom(this._stepForwardRaycastResult.hitPoint),this._stepCheckHitPointMesh.isVisible=!0,this._stepCheckOriginMesh.material=this._stepDebugNoHitMaterial,this._stepCheckDestinationMesh.material=this._stepDebugNoHitMaterial):this._stepCheckHitPointMesh.isVisible=!1}return!0===this._stepForwardRaycastResult.hasHit},n.prototype.validateStepHeight=function(t,n){var i=new BABYLON.Vector3(t.x,0,t.z).normalize(),o=this.transform.absolutePosition.clone();o.y+=this._centerOffset.y-this._avatarHeight/2;var r=i.scale(.5*this._avatarRadius),a=n.clone().add(r),l=a.clone();l.y=o.y+this._stepHeight;var s=a.clone();s.y=o.y-.1;var u={shape:this._stepCheckShape,rotation:this.transform.rotationQuaternion,startPosition:l,endPosition:s,ignoreBody:this.transform.physicsBody,shouldHitTriggers:!1};if(null==this._stepLocalRaycastResult&&(this._stepLocalRaycastResult=new BABYLON.ShapeCastResult),null==this._stepHeightRaycastResult&&(this._stepHeightRaycastResult=new BABYLON.ShapeCastResult),this._stepLocalRaycastResult.reset(),this._stepHeightRaycastResult.reset(),e.RigidbodyPhysics.ShapecastToRef(u,this._stepLocalRaycastResult,this._stepHeightRaycastResult),!this._stepHeightRaycastResult.hasHit)return this.showRaycasts||e.Utilities.ShowDebugColliders(),{canStep:!1,stepHeight:0,debugReason:"heightRaycast_miss"};var c=this._stepHeightRaycastResult.hitPoint,d=c.y-o.y;if(d<this._minimumStepHeight||d>this._stepHeight)return this.showRaycasts||e.Utilities.ShowDebugColliders(),{canStep:!1,stepHeight:d,debugReason:"height_out_of_range"};var p=Math.max(.02,this._skinWidth+.01),h=Math.max(.03,this._skinWidth+.01),m=Math.min(.06,.12*this._avatarRadius),f=c.clone(),g=i.scale(-m);f.addInPlace(g),f.y+=h;var y=f.clone();y.y+=this._avatarHeight+p;var v={shape:this._stepCheckShape,rotation:this.transform.rotationQuaternion,startPosition:f,endPosition:y,ignoreBody:this.transform.physicsBody,shouldHitTriggers:!1};if(null==this._stepLocalRaycastResult&&(this._stepLocalRaycastResult=new BABYLON.ShapeCastResult),null==this._stepLandingRaycastResult&&(this._stepLandingRaycastResult=new BABYLON.ShapeCastResult),this._stepLocalRaycastResult.reset(),this._stepLandingRaycastResult.reset(),e.RigidbodyPhysics.ShapecastToRef(v,this._stepLocalRaycastResult,this._stepLandingRaycastResult),this.showRaycasts||e.Utilities.ShowDebugColliders()){null==this._stepHeightOriginMesh&&(this._stepHeightOriginMesh=BABYLON.MeshBuilder.CreateSphere("StepHeightOrigin",{diameter:.05},this.scene),this._stepHeightOriginMesh.isPickable=!1,this._stepHeightOriginMesh.material=this._stepDebugNoHitMaterial),null==this._stepHeightHitPointMesh&&(this._stepHeightHitPointMesh=BABYLON.MeshBuilder.CreateSphere("StepHeightHit",{diameter:.06},this.scene),this._stepHeightHitPointMesh.isPickable=!1,this._stepHeightHitPointMesh.material=this._stepDebugHitMaterial),null==this._stepClearanceOriginMesh&&(this._stepClearanceOriginMesh=BABYLON.MeshBuilder.CreateSphere("StepClearOrigin",{diameter:.04},this.scene),this._stepClearanceOriginMesh.isPickable=!1,this._stepClearanceOriginMesh.material=this._stepDebugNoHitMaterial),null==this._stepClearanceHitPointMesh&&(this._stepClearanceHitPointMesh=BABYLON.MeshBuilder.CreateSphere("StepClearHit",{diameter:.06},this.scene),this._stepClearanceHitPointMesh.isPickable=!1,this._stepClearanceHitPointMesh.material=this._stepDebugHitMaterial);var _=l,S=s;if(null!=this._stepHeightLine){try{this._stepHeightLine.dispose()}catch(e){}this._stepHeightLine=null}this._stepHeightLine=BABYLON.MeshBuilder.CreateLines("StepHeightLine",{points:[_,S],updatable:!1},this.scene),this._stepHeightOriginMesh.position.copyFrom(_),this._stepHeightRaycastResult.hasHit?(this._stepHeightHitPointMesh.position.copyFrom(this._stepHeightRaycastResult.hitPoint),this._stepHeightHitPointMesh.isVisible=!0):this._stepHeightHitPointMesh.isVisible=!1;var B=f,b=y;if(null!=this._stepClearanceLine){try{this._stepClearanceLine.dispose()}catch(e){}this._stepClearanceLine=null}this._stepClearanceLine=BABYLON.MeshBuilder.CreateLines("StepClearanceLine",{points:[B,b],updatable:!1},this.scene),this._stepClearanceOriginMesh.position.copyFrom(B),this._stepLandingRaycastResult.hasHit?(this._stepClearanceHitPointMesh.position.copyFrom(this._stepLandingRaycastResult.hitPoint),this._stepClearanceHitPointMesh.isVisible=!0):this._stepClearanceHitPointMesh.isVisible=!1}return this._stepLandingRaycastResult.hasHit?(this.showRaycasts||e.Utilities.ShowDebugColliders(),{canStep:!1,stepHeight:d,debugReason:"clearance_blocked"}):{canStep:!0,stepHeight:d,landingPoint:c.add(i.scale(this._avatarRadius+this._skinWidth)),debugReason:"ok"}},n.prototype.executeStepUp=function(e){this._isSteppingUp=!0,this._stepUpStartPosition.copyFrom(this.transform.absolutePosition),this._stepUpTargetPosition.copyFrom(e),this._stepUpProgress=0,this._stepUpTargetPosition.y+=this._centerOffset.y-this._avatarHeight/2},n.prototype.updateStepUpAnimation=function(){if(this._isSteppingUp){var e=this.getDeltaSeconds();if(this._stepUpProgress+=e/this._stepUpDuration,this._stepUpProgress>=1){this._stepUpProgress=1,this._isSteppingUp=!1;try{this.transform.position.copyFrom(this._stepUpTargetPosition)}catch(e){}this._stepUpVerticalVelocity=0}}},n.prototype.smoothStep=function(e){return e*e*(3-2*e)},n.prototype.handleStepOffset=function(t){if(!this.detectStepObstacle(t))return(this.showRaycasts||e.Utilities.ShowDebugColliders())&&(n=Date.now())-this._lastStepDebugLogTime>=this._stepDebugLogIntervalMs&&(this._lastStepDebugLogTime=n),!1;var n,i=this._stepForwardRaycastResult.hitPoint;(this.showRaycasts||e.Utilities.ShowDebugColliders())&&(n=Date.now())-this._lastStepDebugLogTime>=this._stepDebugLogIntervalMs&&(this._lastStepDebugLogTime=n);var o=this.validateStepHeight(t,i);if(this.showRaycasts||e.Utilities.ShowDebugColliders(),!o.canStep)return!1;var r=new BABYLON.Vector3(this._inputVelocity.x,0,this._inputVelocity.z),a=r.length(),l=new BABYLON.Vector3(this.transform.absolutePosition.x,0,this.transform.absolutePosition.z),s=new BABYLON.Vector3(o.landingPoint.x,0,o.landingPoint.z),u=.06,c=BABYLON.Vector3.Distance(l,s)/Math.max(.01,a);(!isFinite(c)||c<=0)&&(c=u),c=Math.max(u,Math.min(.6,c)),c=Math.max(u,.9*c);var d=o.stepHeight,p=d/Math.max(.001,c),h=Math.min(20,Math.max(2,2.5*a));p=Math.min(p,h);var m=o.landingPoint.clone();m.y+=Math.min(.04,.35*d);var f=r.scale(-Math.min(.04,.1*this._avatarRadius));return m.addInPlace(f),this._stepUpDuration=c,this._stepUpVerticalVelocity=p,this.executeStepUp(m),!0},n.prototype.set=function(e,t,n,i,o,r,a){void 0===i&&(i=null),void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),null!=this.transform&&(null!=this.transform.position&&null!=e&&null!=t&&null!=n&&this.transform.position.set(e,t,n),null!=this.transform.rotationQuaternion&&null!=i&&null!=o&&null!=r&&null!=a&&this.transform.rotationQuaternion.set(i,o,r,a))},n.prototype.move=function(e,t){void 0===t&&(t=!0),null!=e&&this._targetVelocity.copyFrom(e)},n.prototype.jump=function(t){var n;if(this.canJump()&&(this._isSteppingUp&&(this._isSteppingUp=!1,this._stepUpProgress=0),this._isGrounded=!1,this._minJumpTimer=e.CharacterController.DEFAULT_JUMPING_TIMER,this._verticalVelocity=t,null===(n=this.transform)||void 0===n?void 0:n.physicsBody)){var i=new BABYLON.Vector3;this.transform.physicsBody.getLinearVelocityToRef(i),i.y=t,this.transform.physicsBody.setLinearVelocity(i)}},n.prototype.turn=function(e){null!=this.transform&&this.transform.addRotation(0,e,0)},n.prototype.rotate=function(e,t,n,i){null!=this.transform&&null!=this.transform.rotationQuaternion&&(this._targetRotation.set(e,t,n,i),this.transform.rotationQuaternion.copyFrom(this._targetRotation))},n.prototype.setRigidBodyMass=function(e){if(null!=this.transform&&null!=this.transform.physicsBody){var t=this.transform.physicsBody.getMassProperties();t.mass=e>=1e-7?e:1e-7,this.transform.physicsBody.setMassProperties(t)}},n.prototype.setCollisionState=function(e){null!=this.transform&&null!=this.transform.physicsBody&&null!=this.transform.physicsBody.shape&&(this.transform.physicsBody.shape.isTrigger=!e)},n.prototype.updateGroundedState=function(){this._groundRaycastOffset.set(0,this._avatarHeight/2,0),this.transform.absolutePosition.addToRef(this._groundRaycastOffset,this._groundRaycastOrigin);var t=.2*this._avatarRadius,n=this._avatarHeight/2+this.raycastLength+e.CharacterController.MIN_GROUND_CHECK_SKINWIDTH;this.isGrounded()&&(n+=this._stepHeight+e.CharacterController.MIN_GROUND_CHECK_DISTANCE),e.Utilities.CalculateDestinationPointToRef(this._groundRaycastOrigin,this._groundRaycastDirection,n,this._groundRaycastDestination),null==this._groundRaycastShape&&(this._groundRaycastShape=new BABYLON.PhysicsShapeSphere(new BABYLON.Vector3(0,0,0),t,this.scene));var i={shape:this._groundRaycastShape,rotation:this.transform.rotationQuaternion,startPosition:this._groundRaycastOrigin,endPosition:this._groundRaycastDestination,ignoreBody:this.transform.physicsBody,shouldHitTriggers:!1};return null==this._stepCheckRaycastResult&&(this._stepCheckRaycastResult=new BABYLON.PhysicsRaycastResult),null==this._localGroundShapecastResult&&(this._localGroundShapecastResult=new BABYLON.ShapeCastResult),null==this._worldGroundShapecastResult&&(this._worldGroundShapecastResult=new BABYLON.ShapeCastResult),this._stepCheckRaycastResult.reset(),this._localGroundShapecastResult.reset(),this._worldGroundShapecastResult.reset(),e.RigidbodyPhysics.ShapecastToRef(i,this._localGroundShapecastResult,this._worldGroundShapecastResult),this._isGrounded=this._minJumpTimer<=0&&null!=this._worldGroundShapecastResult&&!0===this._worldGroundShapecastResult.hasHit&&null!=this._worldGroundShapecastResult.body,this._isGrounded&&this._verticalVelocity>0&&(this._isGrounded=!1),this._groundCollisionNode=!0===this.isGrounded()&&null!=this._worldGroundShapecastResult.body?this._worldGroundShapecastResult.body.transformNode:null,(1==this.showRaycasts||e.Utilities.ShowDebugColliders())&&(null==this._groundRay&&(this._groundRay=new BABYLON.Ray(this._groundRaycastOrigin,this._groundRaycastDirection,n)),this._groundRay.origin=this._groundRaycastOrigin,this._groundRay.direction=this._groundRaycastDirection,this._groundRay.length=n,null==this._groundRayHelper&&(this._groundRayHelper=new BABYLON.RayHelper(this._groundRay)),this._groundRayHelper.ray=this._groundRay,this._groundRayHelper.show(this.scene,this.isGrounded()?this._hitColor:this._noHitColor),null==this._groundHitPointMesh&&(this._groundHitPointMesh=BABYLON.MeshBuilder.CreateSphere("GroundHitMesh",{diameter:2*t},this.scene),this._groundHitPointMesh.visibility=.5,this._groundHitPointMesh.material=new BABYLON.StandardMaterial("GroundHitMat",this.scene),this._groundHitPointMesh.material.diffuseColor=new BABYLON.Color3(0,0,1)),this.isGrounded()?this._groundHitPointMesh.position.copyFrom(this._worldGroundShapecastResult.hitPoint):this._groundHitPointMesh.position.copyFrom(this._groundRaycastDestination)),{local:this._localGroundShapecastResult,world:this._worldGroundShapecastResult}},n.prototype.updateSlopesAndSlides=function(t,n){var i=!0;if(this._isSliding=!1,this._slopeAngleRadians=0,this._slopeAngleDegrees=0,this._slopeMoveDirection=0,this.isGrounded()&&(this._verticalVelocity<=-e.CharacterController.DEFAULT_GRAVITY_FORCE&&(this._verticalVelocity=-e.CharacterController.DEFAULT_GRAVITY_FORCE,i=!1),null!=n)){this._slopeAngleRadians=Math.acos(BABYLON.Vector3.Dot(n,BABYLON.Vector3.UpReadOnly)),this._slopeAngleDegrees=BABYLON.Tools.ToDegrees(this._slopeAngleRadians);var o=BABYLON.Vector3.Cross(n,BABYLON.Vector3.UpReadOnly).normalize(),r=BABYLON.Vector3.Cross(o,n).normalize();if(this._slopeMoveDirection=BABYLON.Vector3.Dot(this._currentVelocity.normalize(),r),this._slopeAngleDegrees>=e.CharacterController.MIN_GROUND_CHECK_SLOPEANGLE&&this._slopeAngleDegrees<=this._slopeLimit)this._inputVelocity.length()<=0?this._verticalVelocity<=-e.CharacterController.STATIC_GRAVITY_FORCE&&(this._verticalVelocity=-e.CharacterController.STATIC_GRAVITY_FORCE,i=!1):this._slopeMoveDirection>0?(this._verticalVelocity=-e.CharacterController.UPHILL_GRAVITY_FORCE,i=!1):this._slopeMoveDirection<0&&(this._verticalVelocity=-e.CharacterController.SLOPE_GRAVITY_FORCE,i=!1);else if(this._slopeAngleDegrees>=e.CharacterController.MIN_GROUND_CHECK_SLOPEANGLE&&this._slopeAngleDegrees>this._slopeLimit&&this.canSlide()){var a=new BABYLON.Vector3(0,-1,0),l=BABYLON.Vector3.Cross(BABYLON.Vector3.Cross(n,a),n).normalize().scale(this._slopeSlideSpeed);this._inputVelocity.x=l.x,this._inputVelocity.z=l.z,this._verticalVelocity=l.y,this._isSliding=!0,i=!1}}if(!0===i){var s=this.getDeltaSeconds();this._verticalVelocity-=Math.abs(this.scene.gravity.y)*this._gravityFactor*s,Math.abs(this._verticalVelocity)>e.CharacterController.TERMINAL_VELOCITY&&(this._verticalVelocity=-e.CharacterController.TERMINAL_VELOCITY)}},n.prototype.createPhysicsBodyAndShape=function(t,n,i){var o=this.transform;e.Utilities.ReparentColliders()||o.setParent(null,!0,!0);var r=this._avatarRadius*parseFloat(o.scaling.x.toFixed(4)),a=this._avatarHeight*parseFloat(o.scaling.y.toFixed(4)),l=this.createPhysicsShapeCapsule(r,a);l.filterMembershipMask=n,l.filterCollideMask=i;var s=new BABYLON.Quaternion(0,0,0,1),u=this._centerOffset.x*parseFloat(o.scaling.x.toFixed(4)),c=this._centerOffset.y*parseFloat(o.scaling.y.toFixed(4)),d=this._centerOffset.z*parseFloat(o.scaling.z.toFixed(4)),p=new BABYLON.Vector3(u,c,d),h=new BABYLON.PhysicsShapeContainer(this.scene);h.material={friction:0,staticFriction:0,restitution:0,frictionCombine:0,restitutionCombine:0},h.addChild(l,p,s,new BABYLON.Vector3(1,1,1));var m=new BABYLON.PhysicsBody(o,BABYLON.PhysicsMotionType.DYNAMIC,!1,this.scene);if(m.shape=h,m.setMassProperties({mass:t,centerOfMass:new BABYLON.Vector3(0,0,0),inertia:new BABYLON.Vector3(0,0,0)}),m.setGravityFactor(0),m.setLinearDamping(.1),m.setAngularDamping(.99),m.disablePreStep=!1,!0===this._collisionEvents&&(m.setCollisionCallbackEnabled(!0),m.setCollisionEndedCallbackEnabled(!0)),e.Utilities.ShowDebugColliders()&&console.log("Setup character controller physics collider for: "+o.name,o),!e.Utilities.ShowDebugColliders()){var f=o;null!=f.material&&"CenterBox-Material"===f.material.name&&(f.isVisible=!1)}e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(m))},n.prototype.createPhysicsShapeCapsule=function(e,t){var n=-.5*(t-.5),i=.5*(t-.5);return new BABYLON.PhysicsShapeCapsule(new BABYLON.Vector3(0,n,0),new BABYLON.Vector3(0,i,0),e,this.scene)},n.TERMINAL_VELOCITY=55,n.SLOPE_GRAVITY_FORCE=3,n.UPHILL_GRAVITY_FORCE=1,n.STATIC_GRAVITY_FORCE=0,n.DEFAULT_GRAVITY_FORCE=1,n.DEFAULT_JUMPING_TIMER=.1,n.DEFAULT_SLIDING_TIMER=.15,n.DEFAULT_CHARACTER_MASS=85,n.MIN_GROUND_CHECK_DISTANCE=.25,n.MIN_GROUND_CHECK_SKINWIDTH=.001,n.MIN_GROUND_CHECK_SLOPEANGLE=1,n}(e.ScriptComponent);e.CharacterController=t;var n=function(e){function t(t,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.SimpleCharacterController");var r=e.call(this,t,n,i,o)||this;return r._eulerAngles=new BABYLON.Vector3(0,0,0),r}return o(t,e),t.prototype.start=function(){},t.prototype.set=function(e,t,n,i,o,r,a,l){void 0===i&&(i=null),void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=!0),null!=this.transform&&(null!=this.transform.position&&null!=e&&null!=t&&null!=n&&this.transform.position.set(e,t,n),null!=this.transform.rotationQuaternion&&null!=i&&null!=o&&null!=r&&null!=a&&this.transform.rotationQuaternion.set(i,o,r,a))},t.prototype.move=function(e,t){void 0===t&&(t=!0),null!=e&&null!=this.transform&&this.transform instanceof BABYLON.AbstractMesh&&this.transform.moveWithCollisions(e)},t.prototype.jump=function(e){},t.prototype.turn=function(e){null!=this.transform&&this.transform.addRotation(0,e,0)},t.prototype.rotate=function(e,t,n,i){null!=this.transform&&null!=this.transform.rotationQuaternion&&this.transform.rotationQuaternion.set(e,t,n,i)},t}(e.ScriptComponent);e.SimpleCharacterController=n;var i=function(e){function t(t,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.RecastCharacterController");var r=e.call(this,t,n,i,o)||this;return r._eulerAngles=new BABYLON.Vector3(0,0,0),r._teleportVector=new BABYLON.Vector3(0,0,0),r._navigationAgent=null,r}return o(t,e),t.prototype.getNavigationAgent=function(){return this._navigationAgent},t.prototype.setNavigationAgent=function(e){this._navigationAgent=e},t.prototype.setDestinationPoint=function(e,t){void 0===t&&(t=!0),null!=this._navigationAgent&&this._navigationAgent.setDestination(e,t)},t.prototype.start=function(){this._navigationAgent=this.getComponent("TOOLKIT.NavigationAgent")},t.prototype.set=function(e,t,n,i,o,r,a,l){void 0===i&&(i=null),void 0===o&&(o=null),void 0===r&&(r=null),void 0===a&&(a=null),void 0===l&&(l=!0),null!=this.transform&&null!=this._navigationAgent&&(null!=this.transform.position&&null!=e&&null!=t&&null!=n&&(this._teleportVector.set(e,t,n),this._navigationAgent.teleport(this._teleportVector,l)),null!=this.transform.rotationQuaternion&&null!=i&&null!=o&&null!=r&&null!=a&&this.transform.rotationQuaternion.set(i,o,r,a))},t.prototype.move=function(e,t){void 0===t&&(t=!0),null!=e&&null!=this._navigationAgent&&this._navigationAgent.move(e,t)},t.prototype.jump=function(e){console.warn("Jump is not supported by the navigation mesh character controller.")},t.prototype.turn=function(e){null!=this.transform&&this.transform.addRotation(0,e,0)},t.prototype.rotate=function(e,t,n,i){null!=this.transform&&null!=this.transform.rotationQuaternion&&null!=this._navigationAgent&&this.transform.rotationQuaternion.set(e,t,n,i)},t}(e.ScriptComponent);e.RecastCharacterController=i,e.SceneManager.RegisterClass("TOOLKIT.CharacterController",t),e.SceneManager.RegisterClass("TOOLKIT.SimpleCharacterController",n),e.SceneManager.RegisterClass("TOOLKIT.RecastCharacterController",i)}(i||(i={})),function(e){var t=function(){function t(e){this.chassisBody=null,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=0,this.indexForwardAxis=2,this.indexUpAxis=1,this.minimumWheelContacts=4,this.smoothFlyingImpulse=0,this.stabilizingForce=0,this.maxImpulseForce=0,this.enableFrictionUpdates=!0,this.maxVisualExtensionLimit=1,this.maxVisualCompressionLimit=1,this.currentVehicleSpeedKmHour=0,this.skiddingFrictionUpdateSpeed=.2,this.burnoutFrictionUpdateSpeed=.01,this.handbrakeWheelStiffness=1,this.burnoutWheelStiffness=.9,this.driftWheelStiffness=.8,this.stabilizeVelocity=!1,this.multiRaycastEnabled=!1,this.multiRaycastMultiplier=2,this.enableRoughTrackLogging=!1,this.frameCounter=0,this.isArcadeBurnoutModeActive=!1,this.isArcadeDonutModeActive=!1,this.isArcadeHandBrakeActive=!1,this.isArcadeWheelSkidActive=!1,this.arcadeFrontSideFactor=.7,this.arcadeRearSideFactor=.2,this.arcadeWheelSkidLimit=1,this.arcadeWheelSkidTimer=0,this.arcadeHandBrakingDelay=.05,this.arcadeHandBrakingTimer=0,this.arcadeHandBrakeTransitionFactor=0,this.minPenaltySpeed=55,this.penaltyWheelSlip=.175,this.penaltyGroundTag="Offroad",this.frontLeftContactTag="",this.frontRightContactTag="",this.rearLeftContactTag="",this.rearRightContactTag="",this.isDriftModeEnabled=!1,this.driftSpeedThreshold=40,this.driftMaxSpeed=120,this.driftSteeringThreshold=.3,this.driftGripReduction=.4,this.driftTransitionSpeed=.08,this.driftIntensity=0,this.previousSteeringInput=0,this.steeringChangeRate=0,this.driftDirection=0,this.arcadeSteerAssistFactor=8.5,this.handBrakePreserveFactor=.85,this.donutModeTransitionFactor=0,this.donutEngineMultiplier=1,this.donutTransitionSpeed=.05,this.donutTurnRadius=6,this.donutModeEngaged=!1,this.donutModeEngineBoost=0,this.defaultBurnoutCoefficient=15,this.burnoutCoefficient=1,this.burnoutTargetCoefficient=1,this.burnoutTransitionSpeed=.01,this.burnoutFrictionSlip=.8,this.burnoutFrictionGrip=1.2,this.burnoutCooldownDuration=1,this.burnoutCooldownTimer=0,this.burnoutModeEngaged=!1,this.burnoutPowerBoost=0,this.baseRotationBoost=6,this.donutRotationBoost=8,this.currentRotationBoost=0,this.launchBoostEnabled=!0,this.launchBoostMultiplier=.8,this.launchBoostDuration=1.2,this.launchBoostDecaySpeed=.008,this.burnoutKickStrength=.7,this.kickEnergyBuildup=.8,this.currentLaunchBoost=0,this.launchBoostActive=!1,this.launchBoostAccumulation=0,this.currentSteeringInput=0,this.handbrakeAngularVelocity=new BABYLON.Vector3,this.handbrakeEngaged=!1,this.raycastResult=null,this.skipFrictionSlipUpdate=!1,this.chassisBody=e.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=void 0!==e.indexRightAxis?e.indexRightAxis:0,this.indexForwardAxis=void 0!==e.indexForwardAxis?e.indexForwardAxis:2,this.indexUpAxis=void 0!==e.indexUpAxis?e.indexUpAxis:1}return t.prototype.addToWorld=function(e){this.world=e},t.prototype.addWheel=function(t){t=t||{};var n=new e.HavokWheelInfo(t),i=this.wheelInfos.length;return this.wheelInfos.push(n),i},t.prototype.getNumWheels=function(){return this.wheelInfos.length},t.prototype.getWheelInfo=function(e){return this.wheelInfos[e]},t.prototype.getSteeringValue=function(e){return this.wheelInfos[e].steering},t.prototype.setSteeringValue=function(e,t){this.wheelInfos[t].steering=e},t.prototype.applyEngineForce=function(e,t){var n=e;if(this.launchBoostActive||this.currentLaunchBoost>0){var i=Math.max(.1,this.currentLaunchBoost),o=this.launchBoostMultiplier*this.burnoutKickStrength;n=e*(1+Math.pow(i,.8)*o)}this.wheelInfos[t].engineForce=n},t.prototype.setHandBrake=function(e,t){this.wheelInfos[t].brake=e},t.prototype.setWheelRotationBoost=function(e,t){e>=0&&e<this.wheelInfos.length&&(this.wheelInfos[e].rotationBoost=t)},t.prototype.setAllWheelsRotationBoost=function(e){for(var t=0;t<this.wheelInfos.length;t++)this.wheelInfos[t].rotationBoost=e},t.prototype.setRearWheelsRotationBoost=function(e){for(var t=2;t<this.wheelInfos.length;t++)this.wheelInfos[t].rotationBoost=e},t.prototype.setFrontWheelsRotationBoost=function(e){for(var t=0;t<Math.min(2,this.wheelInfos.length);t++)this.wheelInfos[t].rotationBoost=e},t.prototype.setArcadeSteeringInput=function(e){this.currentSteeringInput=Math.max(-1,Math.min(1,e))},t.prototype.setisArcadeHandBrakeActive=function(e){!1===e&&(this.arcadeWheelSkidTimer=0,this.arcadeHandBrakingTimer=0),this.isArcadeHandBrakeActive=e},t.prototype.getisArcadeHandBrakeActive=function(){return this.isArcadeHandBrakeActive},t.prototype.setIsArcadeWheelSkidActive=function(e){!1===this.isArcadeWheelSkidActive&&!0===e&&(this.arcadeWheelSkidTimer=this.arcadeWheelSkidLimit,this.arcadeHandBrakingTimer=this.arcadeHandBrakingDelay),this.isArcadeWheelSkidActive=e},t.prototype.getIsArcadeWheelSkidActive=function(){return this.isArcadeWheelSkidActive},t.prototype.setEnableFrictionUpdates=function(e){this.enableFrictionUpdates=e},t.prototype.getEnableFrictionUpdates=function(){return this.enableFrictionUpdates},t.prototype.setLaunchBoostEnabled=function(e){this.launchBoostEnabled=e},t.prototype.getLaunchBoostEnabled=function(){return this.launchBoostEnabled},t.prototype.setLaunchBoostDuration=function(e){this.launchBoostDuration=e},t.prototype.getLaunchBoostDuration=function(){return this.launchBoostDuration},t.prototype.setLaunchBoostMultiplier=function(e){this.launchBoostMultiplier=e},t.prototype.getLaunchBoostMultiplier=function(){return this.launchBoostMultiplier},t.prototype.setLaunchBoostDecaySpeed=function(e){this.launchBoostDecaySpeed=e},t.prototype.getLaunchBoostDecaySpeed=function(){return this.launchBoostDecaySpeed},t.prototype.setBurnoutKickStrength=function(e){this.burnoutKickStrength=e},t.prototype.getBurnoutKickStrength=function(){return this.burnoutKickStrength},t.prototype.setIsArcadeBurnoutModeActive=function(e){var t=this.isArcadeBurnoutModeActive;if(!0===(!e&&t)){this.burnoutCooldownTimer=this.burnoutCooldownDuration;for(var n=0;n<this.wheelInfos.length;n++){var i=this.wheelInfos[n];i.frictionSlip=BABYLON.Scalar.Clamp(this.burnoutFrictionGrip,this.burnoutFrictionSlip,i.defaultFriction),i.frictionLerping=!1,i.frictionPenalty=!1}if(this.skipFrictionSlipUpdate=!0,this.launchBoostEnabled&&this.launchBoostAccumulation>.2){this.launchBoostActive=!0;var o=Math.abs(.621371*this.currentVehicleSpeedKmHour),r=this.kickEnergyBuildup*this.burnoutKickStrength,a=1.2*this.launchBoostAccumulation,l=Math.min(.5,o/20);this.currentLaunchBoost=Math.max(.6,r+a+l)}}this.isArcadeBurnoutModeActive=e,e&&(this.launchBoostAccumulation=0)},t.prototype.getIsArcadeBurnoutModeActive=function(){return this.isArcadeBurnoutModeActive},t.prototype.setIsArcadeDonutModeActive=function(e){this.isArcadeDonutModeActive=e,e&&!this.donutModeEngaged?(this.donutModeEngaged=!0,this.donutModeEngineBoost=0):!e&&this.donutModeEngaged&&(this.donutModeEngaged=!1)},t.prototype.setArcadeFrontSideFactor=function(e){this.arcadeFrontSideFactor=e},t.prototype.setArcadeRearSideFactor=function(e){this.arcadeRearSideFactor=e},t.prototype.getDonutModeTransitionFactor=function(){return this.donutModeTransitionFactor},t.prototype.getEasedDonutModeTransitionFactor=function(){return this.getEasedDonutTransitionFactor()},t.prototype.getDonutModeEngineBoost=function(){return this.donutModeEngineBoost},t.prototype.isDonutModeEngaged=function(){return this.donutModeEngaged},t.prototype.setDonutEngineMultiplier=function(e){this.donutEngineMultiplier=e},t.prototype.setDonutTurnRadius=function(e){this.donutTurnRadius=e},t.prototype.setDonutTransitionSpeed=function(e){this.donutTransitionSpeed=e},t.prototype.setBurnoutWheelStiffness=function(e){this.burnoutWheelStiffness=Math.max(.1,Math.min(5,e))},t.prototype.getBurnoutWheelStiffness=function(){return this.burnoutWheelStiffness},t.prototype.setHandbrakeWheelStiffness=function(e){this.handbrakeWheelStiffness=Math.max(.1,Math.min(5,e))},t.prototype.getHandbrakeWheelStiffness=function(){return this.handbrakeWheelStiffness},t.prototype.setDriftWheelStiffness=function(e){this.driftWheelStiffness=Math.max(.1,Math.min(5,e))},t.prototype.getDriftWheelStiffness=function(){return this.driftWheelStiffness},t.prototype.setDefaultBurnoutCoefficient=function(e){this.defaultBurnoutCoefficient=e},t.prototype.getDefaultBurnoutCoefficient=function(){return this.defaultBurnoutCoefficient},t.prototype.setActiveBurnoutCoefficient=function(e){this.burnoutTargetCoefficient=Math.max(1,e),e>1&&!this.burnoutModeEngaged?this.burnoutModeEngaged=!0:e<=1&&this.burnoutModeEngaged&&(this.burnoutModeEngaged=!1)},t.prototype.getActiveBurnoutCoefficient=function(){return this.burnoutCoefficient},t.prototype.getBurnoutPowerBoost=function(){return this.burnoutPowerBoost},t.prototype.isBurnoutModeEngaged=function(){return this.burnoutModeEngaged},t.prototype.setBurnoutFrictionSlip=function(e){this.burnoutFrictionSlip=e},t.prototype.getBurnoutFrictionSlip=function(){return this.burnoutFrictionSlip},t.prototype.setBurnoutFrictionGrip=function(e){this.burnoutFrictionGrip=e},t.prototype.getBurnoutFrictionGrip=function(){return this.burnoutFrictionGrip},t.prototype.getBurnoutTransitionSpeed=function(){return this.burnoutTransitionSpeed},t.prototype.setBurnoutTransitionSpeed=function(e){this.burnoutTransitionSpeed=Math.max(0,e)},t.prototype.setBaseRotationBoost=function(e){this.baseRotationBoost=Math.max(0,e)},t.prototype.setDonutRotationBoost=function(e){this.donutRotationBoost=Math.max(0,e)},t.prototype.getBaseRotationBoost=function(){return this.baseRotationBoost},t.prototype.getDonutRotationBoost=function(){return this.donutRotationBoost},t.prototype.getCurrentRotationBoost=function(){return this.currentRotationBoost},t.prototype.getArcadeWheelSkidTimer=function(){return this.arcadeWheelSkidTimer},t.prototype.getArcadeHandBrakingTimer=function(){return this.arcadeHandBrakingTimer},t.prototype.setBurnoutCooldownTime=function(e){this.burnoutCooldownDuration=e},t.prototype.getBurnoutCooldownTime=function(){return this.burnoutCooldownDuration},t.prototype.setArcadeWheelSkidLimit=function(e){this.arcadeWheelSkidLimit=e},t.prototype.getArcadeWheelSkidLimit=function(){return this.arcadeWheelSkidLimit},t.prototype.setArcadeHandBrakeDelay=function(e){this.arcadeHandBrakingDelay=e},t.prototype.getArcadeHandBrakeDelay=function(){return this.arcadeHandBrakingDelay},t.prototype.getMinPenaltySpeed=function(){return this.minPenaltySpeed},t.prototype.setMinPenaltySpeed=function(e){this.minPenaltySpeed=e},t.prototype.getPenaltyWheelSlip=function(){return this.penaltyWheelSlip},t.prototype.setPenaltyWheelSlip=function(e){this.penaltyWheelSlip=e},t.prototype.getPenaltyGroundTag=function(){return this.penaltyGroundTag},t.prototype.setPenaltyGroundTag=function(e){this.penaltyGroundTag=e},t.prototype.setLoggingEnabled=function(e){this.enableRoughTrackLogging=e},t.prototype.getLoggingEnabled=function(){return this.enableRoughTrackLogging},t.prototype.setMultiRaycastEnabled=function(e){this.multiRaycastEnabled=e},t.prototype.getMultiRaycastEnabled=function(){return this.multiRaycastEnabled},t.prototype.setMultiRaycastRadiusScale=function(e){this.multiRaycastMultiplier=Math.max(1,Math.min(100,e))},t.prototype.getMultiRaycastRadiusScale=function(){return this.multiRaycastMultiplier},t.prototype.setStabilizeVelocityEnabled=function(e){this.stabilizeVelocity=e},t.prototype.getStabilizeVelocityEnabled=function(){return this.stabilizeVelocity},t.prototype.setSkipFrictionSlipUpdate=function(e){this.skipFrictionSlipUpdate=e},t.prototype.getSkipFrictionSlipUpdate=function(){return this.skipFrictionSlipUpdate},t.prototype.applyVelocityBasedStabilization=function(t,n){if(t.raycastResult.body){var i=new BABYLON.Vector3;e.HavokVehicleUtilities.velocityAt(this.chassisBody,t.chassisConnectionPointWorld,i);var o=BABYLON.Vector3.Dot(i,t.directionWorld);if(Math.abs(o)>5){var r=t.directionWorld.scale(.3*-o);e.HavokVehicleUtilities.addImpulseAt(this.chassisBody,r,t.raycastResult.hitPointWorld),t.suspensionRelativeVelocity*=.7,this.enableRoughTrackLogging&&console.log("[VELOCITY STABILIZATION] Wheel ".concat(n,": Applied damping for vertical velocity=").concat(o.toFixed(2),"m/s"))}}},t.prototype.applyPredictiveNormalStabilization=function(t,n){if(t.raycastResult.body){var i=e.HavokVehicleUtilities.bodyLinearVelocity(this.chassisBody,new BABYLON.Vector3),o=t.chassisConnectionPointWorld.add(i.scale(1/60)),r=this.performSingleRaycast(t,o);if(r&&r.body){var a=t.raycastResult.hitNormalWorld,l=r.hitNormalWorld,s=BABYLON.Vector3.Dot(a,l);if(s>.6){var u=new BABYLON.Vector3;BABYLON.Vector3.LerpToRef(a,l,.3,u),u.normalize(),t.raycastResult.hitNormalWorld.copyFrom(u),this.enableRoughTrackLogging&&this.frameCounter%30==0&&console.log("[PREDICTIVE STABILIZATION] Wheel ".concat(n,": Blended normal, dot=").concat(s.toFixed(3)))}}}},t.prototype.updateBurnoutCoefficient=function(){if(this.burnoutCoefficient!==this.burnoutTargetCoefficient){var e=this.burnoutTargetCoefficient-this.burnoutCoefficient;if(this.burnoutTargetCoefficient>this.burnoutCoefficient){var t=.5*e;this.burnoutCoefficient+=t}else t=e*this.burnoutTransitionSpeed,Math.abs(t)>Math.abs(e)?this.burnoutCoefficient=this.burnoutTargetCoefficient:this.burnoutCoefficient+=t;this.burnoutCoefficient=Math.max(.1,Math.min(20,this.burnoutCoefficient))}if(this.isArcadeBurnoutModeActive&&this.launchBoostEnabled){var n=Math.max(.2,Math.min(.8,this.burnoutCoefficient/15)),i=Math.abs(.621371*this.currentVehicleSpeedKmHour),o=n*Math.max(.7,Math.min(1.3,i/12+.7));this.launchBoostAccumulation=Math.min(1,this.launchBoostAccumulation+.08*o)}this.launchBoostActive&&(this.currentLaunchBoost-=this.launchBoostDecaySpeed,this.currentLaunchBoost<=0&&(this.currentLaunchBoost=0,this.launchBoostActive=!1,this.launchBoostAccumulation=0)),this.burnoutPowerBoost=this.burnoutCoefficient-1},t.prototype.updateBurnoutDriveState=function(){var e=this.wheelInfos[0],t=this.wheelInfos[1],n=this.wheelInfos[2],i=this.wheelInfos[3];if(!0===this.isArcadeWheelSkidActive)this.setActiveBurnoutCoefficient(1),!0===this.enableFrictionUpdates&&this.arcadeWheelSkidTimer>0&&(null!=e&&(e.frictionSlip=0),null!=t&&(t.frictionSlip=0),null!=n&&(n.frictionSlip=0),null!=i&&(i.frictionSlip=0),null!=e&&(e.frictionPenalty=!1),null!=t&&(t.frictionPenalty=!1),null!=n&&(n.frictionPenalty=!1),null!=i&&(i.frictionPenalty=!1),this.skipFrictionSlipUpdate=!0);else if(!0===this.isArcadeBurnoutModeActive)this.setActiveBurnoutCoefficient(this.defaultBurnoutCoefficient),!0===this.enableFrictionUpdates&&(null!=e&&(e.frictionSlip=this.burnoutFrictionSlip),null!=t&&(t.frictionSlip=this.burnoutFrictionSlip),null!=n&&(n.frictionSlip=this.burnoutFrictionSlip),null!=i&&(i.frictionSlip=this.burnoutFrictionSlip),null!=e&&(e.frictionPenalty=!1),null!=t&&(t.frictionPenalty=!1),null!=n&&(n.frictionPenalty=!1),null!=i&&(i.frictionPenalty=!1),this.skipFrictionSlipUpdate=!0);else if(this.setActiveBurnoutCoefficient(1),!0===this.enableFrictionUpdates&&.621371*this.currentVehicleSpeedKmHour>=this.minPenaltySpeed&&this.penaltyWheelSlip>0){if(!1===e.frictionLerping&&null!=this.frontLeftContactTag&&""!==this.frontLeftContactTag&&this.frontLeftContactTag===this.penaltyGroundTag&&null!=e&&null!=e.defaultFriction){var o=e.defaultFriction*(1.25*this.penaltyWheelSlip);e.frictionSlip=o,e.frictionPenalty=!0,this.skipFrictionSlipUpdate=!0}if(!1===t.frictionLerping&&null!=this.frontRightContactTag&&""!==this.frontRightContactTag&&this.frontRightContactTag===this.penaltyGroundTag&&null!=t&&null!=t.defaultFriction){var r=t.defaultFriction*(1.25*this.penaltyWheelSlip);t.frictionSlip=r,t.frictionPenalty=!0,this.skipFrictionSlipUpdate=!0}if(!1===n.frictionLerping&&null!=this.rearLeftContactTag&&""!==this.rearLeftContactTag&&this.rearLeftContactTag===this.penaltyGroundTag&&null!=n&&null!=n.defaultFriction){var a=n.defaultFriction*this.penaltyWheelSlip;n.frictionSlip=a,n.frictionPenalty=!0,this.skipFrictionSlipUpdate=!0}if(!1===i.frictionLerping&&null!=this.rearRightContactTag&&""!==this.rearRightContactTag&&this.rearRightContactTag===this.penaltyGroundTag&&null!=i&&null!=i.defaultFriction){var l=i.defaultFriction*this.penaltyWheelSlip;i.frictionSlip=l,i.frictionPenalty=!0,this.skipFrictionSlipUpdate=!0}}},t.prototype.updateWheelRotationBoost=function(){var e=0;this.isArcadeDonutModeActive?e=this.donutRotationBoost:this.burnoutModeEngaged&&this.burnoutCoefficient>1.1&&(e=this.baseRotationBoost);for(var t=2;t<this.wheelInfos.length;t++)this.wheelInfos[t].rotationBoost=e;for(t=0;t<Math.min(2,this.wheelInfos.length);t++);},t.prototype.updateCurrentFrictionSlip=function(e){var t=this;if(!1!==this.enableFrictionUpdates&&!0!==this.skipFrictionSlipUpdate){var n=this.burnoutCooldownTimer>0?.01*this.burnoutFrictionUpdateSpeed:.1*this.skiddingFrictionUpdateSpeed,i=function(e,i,o){var r=BABYLON.Scalar.Clamp(n,1e-4,1),a=o-0,l=Math.max(0,Math.min(1,i/a)),s=t.isArcadeHandBrakeActive||t.arcadeHandBrakingTimer>0,u=t.burnoutCooldownTimer>0,c=0;if(l<.12)c=s?.08:.12;else if(l<.22)c=s?.15:.25;else if(l<.35){var d=(l-.22)/.13,p=s?.15:.25;c=p+d*d*((s?.45:.65)-p)}else if(l<.55){var h=(l-.35)/.2;c=s?.45+1.1*h:.65+1.3*h}else if(l<.78){var m=(l-.55)/.23,f=1-Math.pow(1-m,1.4);c=s?1.55+2.5*f:1.95+3*f}else{var g=(l-.78)/.22;c=4+8*(1-Math.pow(1-g,2.2))}return c*=s?t.handbrakeWheelStiffness:u?t.burnoutWheelStiffness:t.driftWheelStiffness,r*Math.max(.01,c)},o=this.wheelInfos[0],r=this.wheelInfos[1],a=this.wheelInfos[2],l=this.wheelInfos[3];if(null!=o&&null!=o.defaultFriction){var s=o.frictionSlip;if(s<o.defaultFriction-.1){o.frictionLerping=!0;var u=i(0,s,o.defaultFriction),c=!0===o.frictionPenalty?2*u:u;s=BABYLON.Scalar.Lerp(s,o.defaultFriction,c),o.frictionSlip=s}else o.frictionPenalty=!1,o.frictionLerping=!1,o.frictionSlip=o.defaultFriction}if(null!=r&&null!=r.defaultFriction){var d=r.frictionSlip;if(d<r.defaultFriction-.1){r.frictionLerping=!0;var p=i(0,d,r.defaultFriction);c=!0===r.frictionPenalty?2*p:p,d=BABYLON.Scalar.Lerp(d,r.defaultFriction,c),r.frictionSlip=d}else r.frictionPenalty=!1,r.frictionLerping=!1,r.frictionSlip=r.defaultFriction}if(null!=a&&null!=a.defaultFriction){var h=a.frictionSlip;if(h<a.defaultFriction-.1){a.frictionLerping=!0;var m=i(0,h,a.defaultFriction);c=!0===a.frictionPenalty?2*m:m,h=BABYLON.Scalar.Lerp(h,a.defaultFriction,c),a.frictionSlip=h}else a.frictionPenalty=!1,a.frictionLerping=!1,a.frictionSlip=a.defaultFriction}if(null!=l&&null!=l.defaultFriction){var f=l.frictionSlip;if(f<l.defaultFriction-.1){l.frictionLerping=!0;var g=i(0,f,l.defaultFriction);c=!0===l.frictionPenalty?2*g:g,f=BABYLON.Scalar.Lerp(f,l.defaultFriction,c),l.frictionSlip=f}else l.frictionPenalty=!1,l.frictionLerping=!1,l.frictionSlip=l.defaultFriction}}},t.prototype.resetDefaultFrictionSlip=function(){for(var e=0;e<this.wheelInfos.length;e++){var t=this.wheelInfos[e];t.frictionSlip=t.defaultFriction||10,t.frictionLerping=!1,t.frictionPenalty=!1}this.skipFrictionSlipUpdate=!0},t.prototype.getAngularDampingReduction=function(){return.8*this.getEasedDonutTransitionFactor()},t.prototype.getEasedDonutTransitionFactor=function(){var e=this.donutModeTransitionFactor;return e*e*e*(6*e*e-15*e+10)},t.prototype.getVehicleAxisWorld=function(t,n){return n.set(0===t?1:0,1===t?1:0,2===t?1:0),BABYLON.Vector3.TransformCoordinatesToRef(n,e.HavokVehicleUtilities.bodyTransform(this.chassisBody,new BABYLON.Matrix),n),n},t.prototype.getCurrentSpeedKmHour=function(){return this.currentVehicleSpeedKmHour},t.prototype.calculateSteeringChangeRate=function(e){this.steeringChangeRate=Math.abs(this.currentSteeringInput-this.previousSteeringInput)/e,this.previousSteeringInput=this.currentSteeringInput},t.prototype.isDriftSystemEnabled=function(){return this.isDriftModeEnabled},t.prototype.setDriftSystemEnabled=function(e){this.isDriftModeEnabled=e},t.prototype.setDriftMaxSpeed=function(e){this.driftMaxSpeed=e},t.prototype.getDriftMaxSpeed=function(){return this.driftMaxSpeed},t.prototype.setDriftSpeedThreshold=function(e){this.driftSpeedThreshold=e},t.prototype.getDriftSpeedThreshold=function(){return this.driftSpeedThreshold},t.prototype.setDriftGripReduction=function(e){this.driftGripReduction=Math.max(0,Math.min(1,e))},t.prototype.getDriftGripReduction=function(){return this.driftGripReduction},t.prototype.setDriftSteeringThreshold=function(e){this.driftSteeringThreshold=e},t.prototype.getDriftSteeringThreshold=function(){return this.driftSteeringThreshold},t.prototype.setDriftSettings=function(e){void 0!==e.maxSpeed&&(this.driftMaxSpeed=e.maxSpeed),void 0!==e.speedThreshold&&(this.driftSpeedThreshold=e.speedThreshold),void 0!==e.gripReduction&&(this.driftGripReduction=Math.max(0,Math.min(1,e.gripReduction))),void 0!==e.steeringThreshold&&(this.driftSteeringThreshold=e.steeringThreshold)},t.prototype.getDriftIntensity=function(){return this.driftIntensity},t.prototype.isDrifting=function(){return this.driftIntensity>.1},t.prototype.updateDriftState=function(e){if(this.isDriftModeEnabled){var t=Math.abs(this.currentVehicleSpeedKmHour),n=Math.abs(this.currentSteeringInput),i=0;t>this.driftSpeedThreshold&&(i=Math.min(1,(t-this.driftSpeedThreshold)/(this.driftMaxSpeed-this.driftSpeedThreshold)));var o=i*Math.max(0,(n-this.driftSteeringThreshold)/(1-this.driftSteeringThreshold))*Math.min(1,2*this.steeringChangeRate);o>this.driftIntensity?this.driftIntensity=Math.min(o,this.driftIntensity+this.driftTransitionSpeed):this.driftIntensity=Math.max(o,this.driftIntensity-.5*this.driftTransitionSpeed),this.driftIntensity>.1&&(this.driftDirection=this.currentSteeringInput>0?1:-1)}else this.driftIntensity=Math.max(0,this.driftIntensity-this.driftTransitionSpeed)},t.prototype.updateVehicle=function(t){this.frameCounter++,this.skipFrictionSlipUpdate=!1,this.burnoutCooldownTimer>0&&(this.burnoutCooldownTimer-=t,this.burnoutCooldownTimer<0&&(this.burnoutCooldownTimer=0)),this.arcadeWheelSkidTimer>0&&(this.arcadeWheelSkidTimer-=t,this.arcadeWheelSkidTimer<0&&(this.arcadeWheelSkidTimer=0)),this.arcadeHandBrakingTimer>0&&(this.arcadeHandBrakingTimer-=t,this.arcadeHandBrakingTimer<0&&(this.arcadeHandBrakingTimer=0));for(var n=this.wheelInfos,i=n.length,o=this.chassisBody,r=0;r<i;r++)this.updateWheelTransform(r);var a=e.HavokVehicleUtilities.bodyLinearVelocity(o,new BABYLON.Vector3),l=BABYLON.Vector3.TransformNormalToRef(a,e.HavokVehicleUtilities.bodyTransform(o,new BABYLON.Matrix).invert(),new BABYLON.Vector3);for(this.currentVehicleSpeedKmHour=3.6*l.z,this.calculateSteeringChangeRate(t),this.updateDriftState(t),this.updateBurnoutDriveState(),this.updateWheelRotationBoost(),this.updateCurrentFrictionSlip(t),r=0;r<i;r++)this.performCasting(n[r]);var s=0;for(r=0;r<i;r++)(h=n[r]).raycastResult.body&&s++;0==s&&this.smoothFlyingImpulse,this.updateSuspension(t);var u=new BABYLON.Vector3;for(r=0;r<i;r++){var c=(h=n[r]).suspensionForce;c>h.maxSuspensionForce&&(c=h.maxSuspensionForce),u.copyFrom(h.raycastResult.hitNormalWorld).scaleInPlace(c*t),e.HavokVehicleUtilities.addImpulseAt(o,u,h.raycastResult.hitPointWorld)}this.updateFriction(t),this.stabilizingForce>0&&this.minimumWheelContacts>0&&this.minimumWheelContacts;var d=new BABYLON.Vector3,p=new BABYLON.Vector3;for(r=0;r<i;r++){var h=n[r];if(e.HavokVehicleUtilities.velocityAt(o,h.chassisConnectionPointWorld,p),h.isInContact){var m=e.HavokVehicleUtilities.bodyTransform(o,new BABYLON.Matrix),f=new BABYLON.Vector3;BABYLON.Vector3.TransformNormalToRef(p,m.invert(),f);var g=f.z,y=h.raycastResult.hitNormalWorld,v=new BABYLON.Vector3(0,0,1);BABYLON.Vector3.TransformNormalToRef(v,m,v);var _=BABYLON.Vector3.Dot(v,y);d.copyFrom(y).scaleInPlace(_),v.subtractToRef(d,v);var S=g/h.radius*t;if(h.rotationBoost>0){var B=0;Math.abs(h.engineForce)>.001&&(B=h.engineForce>0?-1:1);var b=3,C=B*h.rotationBoost*b*t;0!==B?(0!=(A=h.deltaRotation>0?1:h.deltaRotation<0?-1:0)&&A!==B&&(h.rotation=0),h.deltaRotation=C):(h.rotation=0,h.deltaRotation=S)}else h.deltaRotation=S}else{var A;if(h.rotationBoost>0&&Math.abs(h.engineForce)>.001)b=3,C=(B=h.engineForce>0?-1:1)*h.rotationBoost*b*t,0!=(A=h.deltaRotation>0?1:h.deltaRotation<0?-1:0)&&A!==B&&(h.rotation=0),h.deltaRotation=C;else h.deltaRotation=0;h.rotation+=h.deltaRotation}if((h.sliding||!h.isInContact)&&0!==h.engineForce&&h.useCustomSlidingRotationalSpeed){var M=(h.engineForce>0?1:-1)*h.customSlidingRotationalSpeed*t;h.deltaRotation=M,h.rotation+=M}h.deltaRotation*=.99,!0===h.locked?h.deltaRotation=0:h.rotation+=h.deltaRotation}},t.prototype.updateSuspension=function(t){for(var n=this.chassisBody,i=e.HavokVehicleUtilities.bodyMass(n),o=this.wheelInfos,r=o.length,a=0;a<r;a++){var l=o[a];if(l.isInContact){var s=0,u=(i=e.HavokVehicleUtilities.bodyMass(n),l.suspensionRestLength-l.suspensionLength),c=l.suspensionStiffness,d=Math.abs(u)/l.maxSuspensionTravel;d>.7&&(c*=1+2*(d-.7)),s=c*u*l.clippedInvContactDotSuspension;var p=l.suspensionRelativeVelocity,h=p<0?l.dampingCompression:l.dampingRelaxation,m=this.calculateSurfaceRoughness(l,a),f=(s-=(h*=1-.4*m)*p)*i,g=50*i;f=Math.max(-g,Math.min(g,f));var y=.85;if(m>.3&&(y=Math.max(.6,.85-.3*m)),Math.abs(this.currentSteeringInput)>.2){var v=Math.abs(this.currentSteeringInput);y=Math.max(.7,y-.15*v)}if(this.currentVehicleSpeedKmHour>10){var _=Math.min(.2,this.currentVehicleSpeedKmHour/50);y=Math.max(.65,y-_)}l.suspensionForce=l.suspensionForce*(1-y)+f*y,l.suspensionForce<0&&(l.suspensionForce=0)}else l.suspensionForce=0}},t.prototype.removeFromWorld=function(e){e.removeBody(this.chassisBody),this.world=null},t.prototype.calculateSurfaceRoughness=function(t,n){if(!t.raycastResult.body)return 0;var i=t.raycastResult.hitNormalWorld,o=t.directionWorld.scale(-1),r=1-BABYLON.Vector3.Dot(i,o),a=Math.abs(t.suspensionLength-t.suspensionRestLength)/t.maxSuspensionTravel,l=new BABYLON.Vector3;e.HavokVehicleUtilities.velocityAt(this.chassisBody,t.raycastResult.hitPointWorld,l);var s=Math.abs(BABYLON.Vector3.Dot(l,t.directionWorld)),u=.5*r+.3*a+.2*Math.min(1,s/3);return Math.min(1,u)},t.prototype.isValidDrivableSurface=function(e,t){if(this.calculateSurfaceAngle(e)>45)return!1;var n=new BABYLON.Vector3(0,1,0);return!(BABYLON.Vector3.Dot(e,n)<.5)},t.prototype.calculateSurfaceAngle=function(e){var t=new BABYLON.Vector3(0,1,0),n=Math.max(-1,Math.min(1,BABYLON.Vector3.Dot(e,t)));return Math.acos(n)*(180/Math.PI)},t.prototype.performCasting=function(t){this.updateWheelTransformWorld(t);var n=-1,i=this.chassisBody,o=this.wheelInfos.indexOf(t),r=this.performThinMultiRaycast(t,o);if(t.raycastResult.groundObject=0,r){t.raycastResult.body=r.body,t.raycastResult.hitPointWorld.copyFrom(r.hitPointWorld),t.raycastResult.hitNormalWorld.copyFrom(r.hitNormalWorld),t.raycastResult.hitNormal.copyFrom(r.hitNormalWorld),n=r.distance,!0===this.stabilizeVelocity&&this.applyPredictiveNormalStabilization(t,o),t.raycastResult.distance=n,t.suspensionLength=n-t.radius,t.isInContact=!0;var a=t.suspensionRestLength-t.maxSuspensionTravel,l=t.suspensionRestLength+t.maxSuspensionTravel;t.suspensionLength<a&&(t.suspensionLength=a),t.suspensionLength>l&&(t.suspensionLength=l,t.raycastResult.reset());var s=BABYLON.Vector3.Dot(t.raycastResult.hitNormalWorld,t.directionWorld),u=new BABYLON.Vector3;e.HavokVehicleUtilities.velocityAt(i,t.raycastResult.hitPointWorld,u);var c=BABYLON.Vector3.Dot(t.raycastResult.hitNormalWorld,u);if(s>=-.1)t.suspensionRelativeVelocity=0,t.clippedInvContactDotSuspension=10;else{var d=-1/s;t.suspensionRelativeVelocity=c*d,t.clippedInvContactDotSuspension=d}!0===this.stabilizeVelocity&&this.applyVelocityBasedStabilization(t,o)}else t.suspensionLength=t.suspensionRestLength+0*t.maxSuspensionTravel,t.suspensionRelativeVelocity=0,t.directionWorld.scaleToRef(-1,t.raycastResult.hitNormalWorld),t.clippedInvContactDotSuspension=1;return n},t.prototype.updateWheelTransformWorld=function(t){t.isInContact=!1;var n=this.chassisBody,i=e.HavokVehicleUtilities.bodyTransform(n,new BABYLON.Matrix);BABYLON.Vector3.TransformCoordinatesToRef(t.chassisConnectionPointLocal,i,t.chassisConnectionPointWorld),BABYLON.Vector3.TransformNormalToRef(t.directionLocal,i,t.directionWorld),BABYLON.Vector3.TransformNormalToRef(t.axleLocal,i,t.axleWorld)},t.prototype.updateWheelTransform=function(t){var n=e.HavokVehicleUtilities.tmpVec4,i=e.HavokVehicleUtilities.tmpVec5,o=e.HavokVehicleUtilities.tmpVec6,r=this.wheelInfos[t];this.updateWheelTransformWorld(r),r.directionLocal.scaleToRef(-1,n),i.copyFrom(r.axleLocal),BABYLON.Vector3.CrossToRef(n,i,o),o.normalize(),i.normalize();var a=r.steering,l=new BABYLON.Quaternion;BABYLON.Quaternion.RotationAxisToRef(n,a,l);var s=new BABYLON.Quaternion;BABYLON.Quaternion.RotationAxisToRef(i,r.rotation,s);var u=r.worldTransform.rotationQuaternion;e.HavokVehicleUtilities.bodyOrientation(this.chassisBody,new BABYLON.Quaternion).multiplyToRef(l,u),u.multiplyToRef(s,u),u.normalize();var c=r.worldTransform.position;c.copyFrom(r.directionWorld),c.scaleToRef(r.suspensionLength,c),c.addToRef(r.chassisConnectionPointWorld,c),r.worldTransform.computeWorldMatrix(!0)},t.prototype.getWheelTransformWorld=function(e){return this.wheelInfos[e].worldTransform},t.prototype.updateFriction=function(t){for(var n=e.HavokVehicleUtilities.updateFriction_surfNormalWS_scaled_proj,i=this.wheelInfos,o=i.length,r=this.chassisBody,a=e.HavokVehicleUtilities.updateFriction_forwardWS,l=e.HavokVehicleUtilities.updateFriction_axle,s=0,u=0;u<o;u++)(f=(P=i[u]).raycastResult.body)&&s++,P.sideImpulse=0,P.forwardImpulse=0,a[u]||(a[u]=new BABYLON.Vector3),l[u]||(l[u]=new BABYLON.Vector3);for(u=0;u<o;u++)if(f=(P=i[u]).raycastResult.body){var c=l[u],d=this.getWheelTransformWorld(u);BABYLON.Vector3.TransformNormalToRef(e.HavokVehicleUtilities.directions[this.indexRightAxis],d.getWorldMatrix(),c);var p=P.raycastResult.hitNormalWorld,h=BABYLON.Vector3.Dot(c,p);if(p.scaleToRef(h,n),c.subtractToRef(n,c),c.normalize(),BABYLON.Vector3.CrossToRef(p,c,a[u]),a[u].normalize(),P.sideImpulse=e.HavokVehicleUtilities.resolveSingleBilateral(r,P.raycastResult.hitPointWorld,f,P.raycastResult.hitPointWorld,c),P.sideImpulse*=e.HavokVehicleUtilities.sideFrictionStiffness2,this.isArcadeHandBrakeActive&&this.handbrakeEngaged){var m=.3+.4*this.arcadeHandBrakeTransitionFactor;P.sideImpulse*=1-m}}for(this.sliding=!1,u=0;u<o;u++){var f=(P=i[u]).raycastResult.body,g=0,y=1,v=.5;if(this.isArcadeHandBrakeActive){this.handbrakeEngaged||(this.handbrakeEngaged=!0,e.HavokVehicleUtilities.bodyAngularVelocity(r,this.handbrakeAngularVelocity),this.handbrakeAngularVelocity.scaleInPlace(.8)),this.arcadeHandBrakeTransitionFactor=Math.min(this.arcadeHandBrakeTransitionFactor+.15,1);var _=this.arcadeHandBrakeTransitionFactor;if(u>=2)y=1-_*(1-this.arcadeRearSideFactor);else{var S=this.arcadeFrontSideFactor-.3*Math.abs(this.currentSteeringInput);y=1-_*(1-(S=Math.max(.2,S)))}}else if(this.handbrakeEngaged&&(this.handbrakeEngaged=!1,this.handbrakeAngularVelocity.setAll(0)),this.arcadeHandBrakeTransitionFactor=Math.max(this.arcadeHandBrakeTransitionFactor-.08,0),this.isDriftModeEnabled&&this.driftIntensity>0){var B=this.driftIntensity*this.driftGripReduction;y*=u>=2?1-.8*B:1-.3*B,v*=1+.2*B}if(this.isArcadeDonutModeActive){this.donutModeTransitionFactor=Math.min(this.donutModeTransitionFactor+this.donutTransitionSpeed,1);var b=this.getEasedDonutTransitionFactor();this.donutModeEngineBoost=b*(this.donutEngineMultiplier-1);var C=b;y*=u>=2?1-C*(.05+(10-Math.max(.1,Math.min(10,this.donutTurnRadius)))/10*.93):1-C*(.1+(10-Math.max(.1,Math.min(10,this.donutTurnRadius)))/10*.7)}else this.donutModeTransitionFactor=Math.max(this.donutModeTransitionFactor-this.donutTransitionSpeed,0),b=this.getEasedDonutTransitionFactor(),this.donutModeEngineBoost=b*(this.donutEngineMultiplier-1);if(this.updateBurnoutCoefficient(),f)if(Math.abs(P.engineForce)>0){var A=this.burnoutCoefficient;this.burnoutTargetCoefficient<=1&&this.burnoutCoefficient>1&&(A=1),g=P.engineForce*(1+this.donutModeEngineBoost)*A*t}else{var M=P.brake?P.brake:0;g=e.HavokVehicleUtilities.calcRollingFriction(r,f,P.raycastResult.hitPointWorld,a[u],M,s)}if(P.forwardImpulse=0,P.skidInfo=1,f){P.skidInfo=1;var T=P.suspensionForce*t*P.frictionSlip,O=T*T;P.forwardImpulse=g;var I=P.forwardImpulse*v,L=P.sideImpulse*y,x=I*I+L*L;if(P.sliding=!1,x>O){this.sliding=!0,P.sliding=!0;var N=T/Math.sqrt(x);P.skidInfo*=N}}}if(this.isArcadeHandBrakeActive&&this.isArcadeDonutModeActive){for(u=2;u<o;u++)if((P=i[u]).raycastResult.body){P.sliding=!0;var w=.1+.2*this.arcadeHandBrakeTransitionFactor;P.skidInfo=Math.min(P.skidInfo,w),this.sliding=!0}}else if(this.isArcadeHandBrakeActive);else if(this.isDriftModeEnabled&&this.driftIntensity>.3)for(u=2;u<o;u++)(P=i[u]).raycastResult.body&&(P.sliding=!0,w=.3+.4*this.driftIntensity,P.skidInfo=Math.min(P.skidInfo,w),this.sliding=!0);if(this.sliding)for(u=0;u<o;u++)0!==(P=i[u]).sideImpulse&&P.skidInfo<1&&(P.forwardImpulse*=P.skidInfo,P.sideImpulse*=P.skidInfo);for(u=0;u<o;u++){var P=i[u],R=new BABYLON.Vector3;if(P.raycastResult.hitPointWorld.subtractToRef(e.HavokVehicleUtilities.bodyPosition(r,new BABYLON.Vector3),R),0!==P.forwardImpulse){var k=new BABYLON.Vector3;k.copyFrom(a[u]).scaleInPlace(P.forwardImpulse),e.HavokVehicleUtilities.addImpulseAt(r,k,P.raycastResult.hitPointWorld)}if(0!==P.sideImpulse){f=P.raycastResult.body;var E=new BABYLON.Vector3;P.raycastResult.hitPointWorld.subtractToRef(e.HavokVehicleUtilities.bodyPosition(f,new BABYLON.Vector3),E);var D=new BABYLON.Vector3;D.copyFrom(l[u]).scaleInPlace(P.sideImpulse),BABYLON.Vector3.TransformNormalToRef(R,e.HavokVehicleUtilities.bodyTransform(r,new BABYLON.Matrix).invert(),R),R["xyz"[this.indexUpAxis]]*=P.rollInfluence,BABYLON.Vector3.TransformNormalToRef(R,e.HavokVehicleUtilities.bodyTransform(r,new BABYLON.Matrix),R),e.HavokVehicleUtilities.addImpulseAt(r,D,e.HavokVehicleUtilities.bodyPosition(r,new BABYLON.Vector3).add(R)),D.scaleToRef(-1,D),e.HavokVehicleUtilities.addImpulseAt(f,D,P.raycastResult.hitPointWorld)}}if(this.isArcadeHandBrakeActive&&this.handbrakeEngaged){this.handbrakeAngularVelocity.scaleInPlace(.985);var U=e.HavokVehicleUtilities.bodyAngularVelocity(r,new BABYLON.Vector3);if(Math.abs(this.currentSteeringInput)>.1){var F=Math.abs(this.currentVehicleSpeedKmHour),Y=Math.min(F/80,1),V=this.currentSteeringInput*this.arcadeSteerAssistFactor*Y*t;this.donutModeTransitionFactor>0&&(V*=1+.1*this.getEasedDonutTransitionFactor()),(z=new BABYLON.Vector3).copyFrom(U),z.y+=V,r.setAngularVelocity(z),this.handbrakeAngularVelocity.y=.8*z.y}else if(Math.abs(this.handbrakeAngularVelocity.y)>.2&&Math.abs(this.handbrakeAngularVelocity.y)-Math.abs(U.y)>.8){var G=new BABYLON.Vector3(0,this.handbrakeAngularVelocity.y*this.handBrakePreserveFactor*t*.02,0),H=new BABYLON.Vector3;U.scaleToRef(.95,H),H.y+=G.y,r.setAngularVelocity(H)}}else if(this.isDriftModeEnabled&&this.driftIntensity>.2){U=e.HavokVehicleUtilities.bodyAngularVelocity(r,new BABYLON.Vector3);var z,W=Math.min(1.5,Math.abs(this.currentVehicleSpeedKmHour)/60),Q=this.currentSteeringInput*this.driftIntensity*3*W*t;(z=new BABYLON.Vector3).copyFrom(U),z.y+=Q,r.setAngularVelocity(z)}},t.prototype.performSingleRaycast=function(t,n){var i=new BABYLON.Vector3,o=new BABYLON.Vector3,r=t.suspensionRestLength+t.radius;if(t.directionWorld.scaleToRef(r,i),n.addToRef(i,o),null==this.raycastResult&&(this.raycastResult=new BABYLON.PhysicsRaycastResult),this.raycastResult.reset(),e.RigidbodyPhysics.RaycastToRef(n,o,this.raycastResult),this.raycastResult.body){var a=BABYLON.Vector3.Distance(n,this.raycastResult.hitPointWorld);return{hit:!0,body:this.raycastResult.body,normal:this.raycastResult.hitNormalWorld.clone(),distance:a,hitPoint:this.raycastResult.hitPointWorld.clone(),suspensionLength:a-t.radius,hitPointWorld:this.raycastResult.hitPointWorld.clone(),hitNormalWorld:this.raycastResult.hitNormalWorld.clone()}}return{hit:!1}},t.prototype.performThinMultiRaycast=function(t,n){for(var i=!0===this.multiRaycastEnabled?5:1,o=t.suspensionRestLength+t.radius,r=[],a=0;a<i;a++){var l=new BABYLON.Vector3;if(i>1){Math.PI;var s=t.radius*this.multiRaycastMultiplier;if(0===a)l.set(0,0,0);else{var u=(a-1)/(i-1)*Math.PI*2;l.x=Math.cos(u)*s,l.z=Math.sin(u)*s}}var c=new BABYLON.Vector3;if(l.lengthSquared()>0){var d=e.HavokVehicleUtilities.bodyTransform(this.chassisBody,new BABYLON.Matrix),p=new BABYLON.Vector3,h=new BABYLON.Vector3;BABYLON.Vector3.TransformNormalToRef(e.HavokVehicleUtilities.directions[this.indexRightAxis],d,p),BABYLON.Vector3.TransformNormalToRef(e.HavokVehicleUtilities.directions[this.indexForwardAxis],d,h),c=p.scale(l.x).add(h.scale(l.z))}var m=t.chassisConnectionPointWorld.add(c),f=t.directionWorld.scale(o),g=m.add(f);if(null==this.raycastResult&&(this.raycastResult=new BABYLON.PhysicsRaycastResult),this.raycastResult.reset(),e.RigidbodyPhysics.RaycastToRef(m,g,this.raycastResult),this.raycastResult.body){var y=BABYLON.Vector3.Distance(m,this.raycastResult.hitPointWorld);this.isValidDrivableSurface(this.raycastResult.hitNormalWorld,n)&&r.push({body:this.raycastResult.body,hitPointWorld:this.raycastResult.hitPointWorld.clone(),hitNormalWorld:this.raycastResult.hitNormalWorld.clone(),distance:y,weight:0===a?2:1})}}if(0===r.length)return null;if(1===r.length)return{body:(C=r[0]).body,hitPointWorld:C.hitPointWorld,hitNormalWorld:C.hitNormalWorld,distance:C.distance};var v=0,_=BABYLON.Vector3.Zero(),S=BABYLON.Vector3.Zero(),B=0,b=r[0].body;for(a=0;a<r.length;a++){var C,A=(C=r[a]).weight;_.addInPlace(C.hitPointWorld.scale(A)),S.addInPlace(C.hitNormalWorld.scale(A)),B+=C.distance*A,v+=A}return v>0?(_.scaleInPlace(1/v),S.scaleInPlace(1/v),S.normalize(),{body:b,hitPointWorld:_,hitNormalWorld:S,distance:B/=v}):null},t.WHEEL_SPEED_SCALE=1,t.MUSTANG_GT_FRONT_WHEEL_CONFIG={suspensionRestLength:.35,maxSuspensionTravel:30,radius:.33,suspensionStiffness:25,dampingCompression:4.5,dampingRelaxation:3.8,frictionSlip:18.5,rollInfluence:.08,maxSuspensionForce:12e3,isFrontWheel:!0,invertDirection:!1},t.MUSTANG_GT_REAR_WHEEL_CONFIG={suspensionRestLength:.32,maxSuspensionTravel:35,radius:.34,suspensionStiffness:22,dampingCompression:3.8,dampingRelaxation:4.2,frictionSlip:15.5,rollInfluence:.06,maxSuspensionForce:14e3,isFrontWheel:!1,invertDirection:!1},t}();e.HavokRaycastVehicle=t;var n=function(){function t(t){this.maxSuspensionTravel=0,this.customSlidingRotationalSpeed=0,this.useCustomSlidingRotationalSpeed=0,this.sliding=!1,this.frictionPenalty=!1,this.frictionLerping=!1,this.visualTravelRange=0,this.invertDirection=!1,this.isInContact=!1,this.hub=null,this.spinner=null,this.defaultFriction=18.5,this.steeringAngle=0,this.rotationBoost=0,this.locked=!1,t=e.HavokVehicleUtilities.Utilsdefaults(t,{chassisConnectionPointLocal:new BABYLON.Vector3,chassisConnectionPointWorld:new BABYLON.Vector3,directionLocal:new BABYLON.Vector3,directionWorld:new BABYLON.Vector3,axleLocal:new BABYLON.Vector3,axleWorld:new BABYLON.Vector3,suspensionRestLength:.35,suspensionMaxLength:.5,radius:.33,suspensionStiffness:25,dampingCompression:4.5,dampingRelaxation:3.8,frictionSlip:18.5,frictionPenalty:!1,frictionLerping:!1,steering:0,rotation:0,deltaRotation:0,rollInfluence:.08,maxSuspensionForce:12e3,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,physicsShape:null,invertDirection:!1,suspensionLength:0,maxSuspensionTravel:30,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=t.maxSuspensionTravel,this.customSlidingRotationalSpeed=t.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=t.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=t.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=t.chassisConnectionPointLocal.clone(),this.directionLocal=t.directionLocal.clone(),this.directionWorld=t.directionLocal.clone(),this.axleLocal=t.axleLocal.clone(),this.axleWorld=t.axleLocal.clone(),this.suspensionRestLength=t.suspensionRestLength,this.suspensionMaxLength=t.suspensionMaxLength,this.radius=t.radius,this.suspensionStiffness=t.suspensionStiffness,this.dampingCompression=t.dampingCompression,this.dampingRelaxation=t.dampingRelaxation,this.frictionSlip=t.frictionSlip,this.frictionLerping=t.frictionLerping,this.frictionPenalty=t.frictionPenalty,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=t.rollInfluence,this.maxSuspensionForce=t.maxSuspensionForce,this.invertDirection=t.invertDirection,this.engineForce=0,this.brake=0,this.isFrontWheel=t.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.skidinfo=1,this.skidThreshold=t.skidThreshold||.1,this.lateralImpulse=0,this.forwardImpulse=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.physicsShape=null,this.raycastResult=new BABYLON.PhysicsRaycastResult,this.raycastResult.directionWorld=new BABYLON.Vector3,this.worldTransform=new BABYLON.TransformNode(""),this.worldTransform.rotationQuaternion=new BABYLON.Quaternion,this.isInContact=!1}return t.prototype.updateWheel=function(t){var n=this.raycastResult;if(this.isInContact){var i=BABYLON.Vector3.Dot(n.hitNormalWorld,this.raycastResult.directionWorld);n.hitPointWorld.subtractToRef(e.HavokVehicleUtilities.bodyPosition(t,new BABYLON.Vector3),e.HavokVehicleUtilities.relpos),e.HavokVehicleUtilities.velocityAt(t,e.HavokVehicleUtilities.relpos,e.HavokVehicleUtilities.chassis_velocity_at_contactPoint);var o=BABYLON.Vector3.Dot(n.hitNormalWorld,e.HavokVehicleUtilities.chassis_velocity_at_contactPoint);if(i>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=10;else{var r=-1/i;this.suspensionRelativeVelocity=o*r,this.clippedInvContactDotSuspension=r}}else this.raycastResult.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,n.hitNormalWorld.copyFrom(this.raycastResult.directionWorld).scaleInPlace(-1),this.clippedInvContactDotSuspension=1},t}();e.HavokWheelInfo=n;var i=function(){function t(){}return t.calcRollingFriction=function(t,n,i,o,r,a){void 0===a&&(a=1);var l=0,s=i,u=e.HavokVehicleUtilities.calcRollingFriction_vel1,c=e.HavokVehicleUtilities.calcRollingFriction_vel2,d=e.HavokVehicleUtilities.calcRollingFriction_vel;return e.HavokVehicleUtilities.velocityAt(t,s,u),e.HavokVehicleUtilities.velocityAt(n,s,c),u.subtractToRef(c,d),r<(l=-BABYLON.Vector3.Dot(o,d)*(1/(e.HavokVehicleUtilities.computeImpulseDenominator(t,i,o)+e.HavokVehicleUtilities.computeImpulseDenominator(n,i,o)))/a)&&(l=r),l<-r&&(l=-r),l},t.computeImpulseDenominator=function(t,n,i){var o=e.HavokVehicleUtilities.computeImpulseDenominator_r0,r=e.HavokVehicleUtilities.computeImpulseDenominator_c0,a=e.HavokVehicleUtilities.computeImpulseDenominator_vec,l=e.HavokVehicleUtilities.computeImpulseDenominator_m;return n.subtractToRef(e.HavokVehicleUtilities.bodyPosition(t,new BABYLON.Vector3),o).normalize(),BABYLON.Vector3.CrossToRef(o,i,r),e.HavokVehicleUtilities.bodyInertiaWorld(t,new BABYLON.Vector3).multiplyToRef(r,l),BABYLON.Vector3.CrossToRef(l,o,a),e.HavokVehicleUtilities.bodyInvMass(t)+BABYLON.Vector3.Dot(i,a)},t.resolveSingleBilateral=function(t,n,i,o,r){if(r.lengthSquared()>1.1)return 0;var a=e.HavokVehicleUtilities.resolveSingleBilateral_vel1,l=e.HavokVehicleUtilities.resolveSingleBilateral_vel2,s=e.HavokVehicleUtilities.resolveSingleBilateral_vel;return e.HavokVehicleUtilities.velocityAt(t,n,a),e.HavokVehicleUtilities.velocityAt(i,o,l),a.subtractToRef(l,s),-.1*BABYLON.Vector3.Dot(r,s)*(1/(e.HavokVehicleUtilities.bodyInvMass(t)+e.HavokVehicleUtilities.bodyInvMass(i)))},t.directions=[new BABYLON.Vector3(1,0,0),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,0,1)],t.calcRollingFriction_vel1=new BABYLON.Vector3,t.calcRollingFriction_vel2=new BABYLON.Vector3,t.calcRollingFriction_vel=new BABYLON.Vector3,t.updateFriction_surfNormalWS_scaled_proj=new BABYLON.Vector3,t.updateFriction_axle=[],t.updateFriction_forwardWS=[],t.sideFrictionStiffness2=1,t.castRay_rayvector=new BABYLON.Vector3,t.castRay_target=new BABYLON.Vector3,t.torque=new BABYLON.Vector3,t.tmpVec1=new BABYLON.Vector3,t.tmpVec2=new BABYLON.Vector3,t.tmpVec3=new BABYLON.Vector3,t.tmpVec4=new BABYLON.Vector3,t.tmpVec5=new BABYLON.Vector3,t.tmpVec6=new BABYLON.Vector3,t.tmpVel2=new BABYLON.Vector3,t.tmpMat1=new BABYLON.Matrix,t.velocityAt=function(t,n,i){return t.getObjectCenterWorldToRef(e.HavokVehicleUtilities.tmpVel2),n.subtractToRef(e.HavokVehicleUtilities.tmpVel2,i),t.getAngularVelocityToRef(e.HavokVehicleUtilities.tmpVel2),BABYLON.Vector3.CrossToRef(e.HavokVehicleUtilities.tmpVel2,i,i),t.getLinearVelocityToRef(e.HavokVehicleUtilities.tmpVel2),i.addInPlace(e.HavokVehicleUtilities.tmpVel2),i},t.bodyPosition=function(e,t){return e.getObjectCenterWorldToRef(t),t},t.bodyLinearVelocity=function(e,t){return e.getLinearVelocityToRef(t),t},t.bodyAngularVelocity=function(e,t){return e.getAngularVelocityToRef(t),t},t.bodyTransform=function(e,t){return t.copyFrom(e.transformNode.getWorldMatrix()),t},t.addImpulseAt=function(e,t,n){e.applyImpulse(t,n)},t.addForceAt=function(e,t,n){e.applyForce(t,n)},t.bodyOrientation=function(e,t){return t.copyFrom(e.transformNode.rotationQuaternion),t},t.bodyMass=function(e){return e.getMassProperties().mass},t.bodyInvMass=function(e){var t=e.getMassProperties().mass;return t>0?1/t:0},t.bodyInertiaWorld=function(e,t){var n=e.getMassProperties();return t.copyFrom(n.inertia),BABYLON.Vector3.TransformNormalToRef(t,e.transformNode.getWorldMatrix(),t),t.x=t.x>0?1/t.x:0,t.y=t.y>0?1/t.y:0,t.z=t.z>0?1/t.z:0,t},t.computeImpulseDenominator_r0=new BABYLON.Vector3,t.computeImpulseDenominator_c0=new BABYLON.Vector3,t.computeImpulseDenominator_vec=new BABYLON.Vector3,t.computeImpulseDenominator_m=new BABYLON.Vector3,t.bodyPositionVec=new BABYLON.Vector3,t.bodyInertiaVec=new BABYLON.Vector3,t.resolveSingleBilateral_vel1=new BABYLON.Vector3,t.resolveSingleBilateral_vel2=new BABYLON.Vector3,t.resolveSingleBilateral_vel=new BABYLON.Vector3,t.chassis_velocity_at_contactPoint=new BABYLON.Vector3,t.relpos=new BABYLON.Vector3,t.Utilsdefaults=function(e,t){for(var n in e=e||{},t)n in e||(e[n]=t[n]);return e},t}();e.HavokVehicleUtilities=i}(i||(i={})),function(e){var t,n=function(t){function n(e,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.NavigationAgent");var r=t.call(this,e,n,i,o)||this;return r.crowd=null,r.distanceToTarget=0,r.teleporting=!1,r.moveDirection=new BABYLON.Vector3(0,0,0),r.resetPosition=new BABYLON.Vector3(0,0,0),r.lastPosition=new BABYLON.Vector3(0,0,0),r.distancePosition=new BABYLON.Vector3(0,0,0),r.currentPosition=new BABYLON.Vector3(0,0,0),r.currentRotation=new BABYLON.Quaternion(0,0,0,1),r.currentVelocity=new BABYLON.Vector3(0,0,0),r.currentWaypoint=new BABYLON.Vector3(0,0,0),r.heightOffset=0,r.angularSpeed=0,r.updatePosition=!0,r.updateRotation=!0,r.distanceEpsilon=.1,r.velocityEpsilon=1.1,r.offMeshVelocity=1.5,r.stoppingDistance=0,r.onReadyObservable=new BABYLON.Observable,r.onPreUpdateObservable=new BABYLON.Observable,r.onPostUpdateObservable=new BABYLON.Observable,r.onNavCompleteObservable=new BABYLON.Observable,r.m_agentState=0,r.m_agentIndex=-1,r.m_agentReady=!1,r.m_agentGhost=null,r.m_agentParams=null,r.m_agentMovement=new BABYLON.Vector3(0,0,0),r.m_agentDirection=new BABYLON.Vector3(0,0,1),r.m_agentQuaternion=new BABYLON.Quaternion(0,0,0,1),r.m_agentDestination=null,r}return o(n,t),n.prototype.isReady=function(){return this.m_agentReady},n.prototype.isNavigating=function(){return null!=this.m_agentDestination},n.prototype.isTeleporting=function(){return this.teleporting},n.prototype.isOnOffMeshLink=function(){return this.m_agentState===e.CrowdAgentState.DT_CROWDAGENT_STATE_OFFMESH},n.prototype.getAgentType=function(){return this.type},n.prototype.getAgentState=function(){return this.m_agentState},n.prototype.getAgentIndex=function(){return this.m_agentIndex},n.prototype.getAgentOffset=function(){return this.baseOffset},n.prototype.getTargetDistance=function(){return this.distanceToTarget},n.prototype.getCurrentPosition=function(){return this.currentPosition},n.prototype.getCurrentRotation=function(){return this.currentRotation},n.prototype.getCurrentVelocity=function(){return this.currentVelocity},n.prototype.getAgentParameters=function(){return this.m_agentParams},n.prototype.setAgentParameters=function(e){this.m_agentParams=e,this.updateAgentParameters()},n.prototype.awake=function(){this.awakeNavigationAgent()},n.prototype.update=function(){this.updateNavigationAgent()},n.prototype.destroy=function(){this.destroyNavigationAgent()},n.prototype.awakeNavigationAgent=function(){this.type=this.getProperty("type",this.type),this.speed=this.getProperty("speed",this.speed),this.baseOffset=this.getProperty("offset",this.baseOffset),this.angularSpeed=this.getProperty("angularspeed",this.angularSpeed),this.acceleration=this.getProperty("acceleration",this.acceleration),this.stoppingDistance=this.getProperty("stoppingdistance",this.stoppingDistance),this.autoBraking=this.getProperty("autobraking",this.autoBraking),this.avoidRadius=this.getProperty("avoidradius",this.avoidRadius),this.avoidHeight=this.getProperty("avoidheight",this.avoidHeight),this.obstacleAvoidanceType=this.getProperty("avoidquality",this.obstacleAvoidanceType),this.avoidancePriority=this.getProperty("avoidpriority",this.avoidancePriority),this.autoTraverseOffMeshLink=this.getProperty("autotraverse",this.autoTraverseOffMeshLink),this.autoRepath=this.getProperty("autopepath",this.autoRepath),this.areaMask=this.getProperty("areamask",this.areaMask),e.Utilities.ValidateTransformQuaternion(this.transform),this.m_agentGhost=new BABYLON.TransformNode(this.transform.name+".Agent",this.scene),this.m_agentGhost.position=new BABYLON.Vector3(0,0,0),this.m_agentGhost.rotation=new BABYLON.Vector3(0,0,0),e.Utilities.ValidateTransformQuaternion(this.m_agentGhost),this.m_agentGhost.position.copyFrom(this.transform.position),this.lastPosition.copyFrom(this.transform.position)},n.prototype.updateNavigationAgent=function(){if(null==this.crowd){var t=e.SceneManager.GetNavigationTools();if(null==t||null==t.navMesh)return;!0===e.NavigationAgent.GLOBAL_CROWD_INSTANCE?this.crowd=e.SceneManager.GetCrowdInterface(this.scene):this.crowd=t.createCrowd(e.SceneManager.MAX_AGENT_COUNT,e.SceneManager.MAX_AGENT_RADIUS,this.scene)}if(null!=this.crowd){if(this.m_agentIndex<0)return this.m_agentParams={radius:this.avoidRadius,height:this.avoidHeight,maxSpeed:this.speed,maxAcceleration:this.acceleration},e.Utilities.GetAbsolutePositionToRef(this.transform,this.resetPosition),this.m_agentIndex=this.crowd.addAgent(this.resetPosition,this.m_agentParams,this.m_agentGhost),void(this.m_agentIndex>=0&&(this.m_agentReady=!0,this.onReadyObservable&&this.onReadyObservable.hasObservers()&&this.onReadyObservable.notifyObservers(this.transform)));if(this.m_agentState=this.crowd.getAgentState(this.m_agentIndex),this.getAgentWaypointToRef(this.currentWaypoint),this.getAgentPositionToRef(this.currentPosition),this.distancePosition.copyFrom(this.currentPosition),this.isOnOffMeshLink()?(this.currentPosition.subtractToRef(this.lastPosition,this.currentVelocity),this.currentVelocity.scaleInPlace(this.speed*this.offMeshVelocity)):this.getAgentVelocityToRef(this.currentVelocity),this.onPreUpdateObservable&&this.onPreUpdateObservable.hasObservers()&&this.onPreUpdateObservable.notifyObservers(this.transform),this.currentPosition.y+=this.baseOffset+this.heightOffset,this.currentVelocity.length()>=this.velocityEpsilon){this.currentVelocity.normalize();var n=this.angularSpeed*e.NavigationAgent.ANGULAR_SPEED_RATIO*this.getDeltaSeconds();if(this.isOnOffMeshLink()){this.moveDirection.copyFrom(this.m_agentDirection),this.m_agentDirection.set(this.moveDirection.x+(this.currentVelocity.x-this.moveDirection.x),this.moveDirection.y+(this.currentVelocity.y-this.moveDirection.y),this.moveDirection.z+(this.currentVelocity.z-this.moveDirection.z)),this.m_agentDirection.normalize();var i=e.NavigationAgent.TARGET_ANGLE_FACTOR-Math.atan2(this.m_agentDirection.x,this.m_agentDirection.z);BABYLON.Quaternion.FromEulerAnglesToRef(0,i,0,this.currentRotation),this.isNavigating()&&!0===this.updateRotation&&BABYLON.Quaternion.SlerpToRef(this.transform.rotationQuaternion,this.currentRotation,n,this.transform.rotationQuaternion)}else this.m_agentQuaternion.copyFrom(this.transform.rotationQuaternion),this.isNavigating()&&!0===this.updateRotation&&this.transform.lookAt(this.currentWaypoint),this.transform.rotationQuaternion.toEulerAnglesToRef(this.m_agentDirection),BABYLON.Quaternion.FromEulerAnglesToRef(0,this.m_agentDirection.y,0,this.currentRotation),this.isNavigating()&&!0===this.updateRotation&&BABYLON.Quaternion.SlerpToRef(this.m_agentQuaternion,this.currentRotation,n,this.transform.rotationQuaternion)}this.isNavigating()&&!0===this.updatePosition&&this.transform.position.copyFrom(this.currentPosition),this.isNavigating()?(this.distanceToTarget=BABYLON.Vector3.Distance(this.distancePosition,this.m_agentDestination),this.distanceToTarget<=Math.max(this.distanceEpsilon,this.stoppingDistance)&&(this.cancelNavigation(),this.onNavCompleteObservable&&this.onNavCompleteObservable.hasObservers()&&this.onNavCompleteObservable.notifyObservers(this.transform))):this.distanceToTarget=0,this.lastPosition.copyFrom(this.currentPosition),this.onPostUpdateObservable&&this.onPostUpdateObservable.hasObservers()&&this.onPostUpdateObservable.notifyObservers(this.transform),this.teleporting=!1}},n.prototype.updateAgentParameters=function(){null!=this.crowd&&this.m_agentIndex>=0&&this.crowd.updateAgentParameters(this.m_agentIndex,this.m_agentParams)},n.prototype.destroyNavigationAgent=function(){this.m_agentIndex=-1,this.m_agentReady=!1,this.m_agentMovement=null,this.m_agentDirection=null,this.m_agentDestination=null,this.moveDirection=null,this.resetPosition=null,this.lastPosition=null,this.currentPosition=null,this.currentRotation=null,this.currentVelocity=null,this.currentWaypoint=null,this.onReadyObservable.clear(),this.onReadyObservable=null,this.onPreUpdateObservable.clear(),this.onPreUpdateObservable=null,this.onPostUpdateObservable.clear(),this.onPostUpdateObservable=null,this.onNavCompleteObservable.clear(),this.onNavCompleteObservable=null,null!=this.m_agentGhost&&(this.m_agentGhost.dispose(),this.m_agentGhost=null)},n.prototype.move=function(t,n){void 0===n&&(n=!0);var i=e.SceneManager.GetNavigationTools();null!=i&&null!=this.crowd?(this.crowd.getAgentPosition(this.m_agentIndex).addToRef(t,this.m_agentMovement),this.m_agentDestination=!0===n?i.getClosestPoint(this.m_agentMovement):this.m_agentMovement.clone(),this.m_agentIndex>=0&&this.crowd.agentGoto(this.m_agentIndex,this.m_agentDestination)):BABYLON.Tools.Warn("No recast navigation mesh or crowd interface data available!")},n.prototype.teleport=function(t,n){void 0===n&&(n=!0);var i=e.SceneManager.GetNavigationTools();null!=i&&null!=this.crowd?(this.teleporting=!0,this.m_agentDestination=!0===n?i.getClosestPoint(t):t.clone(),this.m_agentIndex>=0&&this.crowd.agentTeleport(this.m_agentIndex,this.m_agentDestination)):BABYLON.Tools.Warn("No recast navigation mesh or crowd interface data available!")},n.prototype.setDestination=function(t,n){void 0===n&&(n=!0);var i=e.SceneManager.GetNavigationTools();null!=i&&null!=this.crowd?(this.m_agentDestination=!0===n?i.getClosestPoint(t):t.clone(),this.m_agentIndex>=0&&this.crowd.agentGoto(this.m_agentIndex,this.m_agentDestination)):BABYLON.Tools.Warn("No recast navigation mesh or crowd interface data available!")},n.prototype.setAcceleration=function(e){null!=this.m_agentParams&&(this.acceleration=e,this.m_agentParams.maxAcceleration=this.acceleration,this.updateAgentParameters())},n.prototype.setMovementSpeed=function(e){null!=this.m_agentParams&&(this.speed=e,this.m_agentParams.maxSpeed=this.speed,this.updateAgentParameters())},n.prototype.setSeparationWeight=function(e){null!=this.m_agentParams&&(this.m_agentParams.separationWeight=e,this.updateAgentParameters())},n.prototype.setOptimizationRange=function(e){null!=this.m_agentParams&&(this.m_agentParams.pathOptimizationRange=e,this.updateAgentParameters())},n.prototype.setCollisionQueryRange=function(e){null!=this.m_agentParams&&(this.m_agentParams.collisionQueryRange=e,this.updateAgentParameters())},n.prototype.setAgentRadius=function(e){null!=this.m_agentParams&&(this.m_agentParams.radius=e,this.updateAgentParameters())},n.prototype.setAgentHeight=function(e){null!=this.m_agentParams&&(this.m_agentParams.height=e,this.updateAgentParameters())},n.prototype.getAgentVelocity=function(){return null!=this.crowd&&this.m_agentIndex>=0?this.crowd.getAgentVelocity(this.m_agentIndex):null},n.prototype.getAgentVelocityToRef=function(e){null!=this.crowd&&this.m_agentIndex>=0&&this.crowd.getAgentVelocityToRef(this.m_agentIndex,e)},n.prototype.getAgentPosition=function(){return null!=this.crowd&&this.m_agentIndex>=0?this.crowd.getAgentPosition(this.m_agentIndex):null},n.prototype.getAgentPositionToRef=function(e){null!=this.crowd&&this.m_agentIndex>=0&&this.crowd.getAgentPositionToRef(this.m_agentIndex,e)},n.prototype.getAgentWaypoint=function(){return null!=this.crowd&&this.m_agentIndex>=0?this.crowd.getAgentNextTargetPath(this.m_agentIndex):null},n.prototype.getAgentWaypointToRef=function(e){null!=this.crowd&&this.m_agentIndex>=0&&this.crowd.getAgentNextTargetPathToRef(this.m_agentIndex,e)},n.prototype.cancelNavigation=function(){this.m_agentDestination=null;var e=this.getAgentPosition();null!=e&&null!=this.crowd&&this.m_agentIndex>=0&&this.crowd.agentTeleport(this.m_agentIndex,e)},n.TARGET_ANGLE_FACTOR=.5*Math.PI,n.ANGULAR_SPEED_RATIO=.05,n.GLOBAL_CROWD_INSTANCE=!1,n}(e.ScriptComponent);e.NavigationAgent=n,(t=e.CrowdAgentState||(e.CrowdAgentState={}))[t.DT_CROWDAGENT_STATE_INVALID=0]="DT_CROWDAGENT_STATE_INVALID",t[t.DT_CROWDAGENT_STATE_WALKING=1]="DT_CROWDAGENT_STATE_WALKING",t[t.DT_CROWDAGENT_STATE_OFFMESH=2]="DT_CROWDAGENT_STATE_OFFMESH",e.SceneManager.RegisterClass("TOOLKIT.NavigationAgent",n)}(i||(i={})),function(e){var t=function(){function t(t,n,i){this._centerMass=new BABYLON.Vector3(0,0,0),this._chassisMesh=null,this._tempVectorPos=new BABYLON.Vector3(0,0,0),this._lockedWheelIndexes=null,this.m_vehicleColliders=null,this.m_vehicle=null,this.m_scene=null,this._chassisMesh=n,this._centerMass=i,this.m_vehicleColliders=null!=this._chassisMesh.metadata&&null!=this._chassisMesh.metadata.toolkit&&null!=this._chassisMesh.metadata.toolkit.wheels?this._chassisMesh.metadata.toolkit.wheels:null,this.m_vehicle=new e.HavokRaycastVehicle({chassisBody:this._chassisMesh.physicsBody}),this.m_scene=t,this.setupWheelInformation();var o=this.m_scene.getPhysicsEngine();null!=o&&this.m_vehicle.addToWorld(o)}return t.prototype.getPhysicsBody=function(){if(null!=this._chassisMesh)return this._chassisMesh.physicsBody},t.prototype.getNumWheels=function(){if(null!=this.m_vehicle)return this.m_vehicle.getNumWheels()},t.prototype.getWheelInfo=function(e){if(null!=this.m_vehicle)return this.m_vehicle.getWheelInfo(e)},t.prototype.getWheelTransform=function(e){if(null!=this.m_vehicle)return this.m_vehicle.getWheelTransformWorld(e)},t.prototype.updateWheelTransform=function(e){null!=this.m_vehicle&&this.m_vehicle.updateWheelTransform(e)},t.prototype.getRawCurrentSpeedKph=function(){if(null!=this.m_vehicle)return this.m_vehicle.getCurrentSpeedKmHour()},t.prototype.getRawCurrentSpeedMph=function(){if(null!=this.m_vehicle)return this.m_vehicle.getCurrentSpeedKmHour()*e.System.Kph2Mph},t.prototype.getAbsCurrentSpeedKph=function(){if(null!=this.m_vehicle)return Math.abs(this.m_vehicle.getCurrentSpeedKmHour())},t.prototype.getAbsCurrentSpeedMph=function(){if(null!=this.m_vehicle)return Math.abs(this.m_vehicle.getCurrentSpeedKmHour())*e.System.Kph2Mph},t.prototype.dispose=function(){this.deleteWheelInformation(),this.m_vehicleColliders=null},t.prototype.setHandBrake=function(e,t){null!=this.m_vehicle&&this.m_vehicle.setHandBrake(e,t)},t.prototype.setEngineForce=function(e,t){null!=this.m_vehicle&&this.m_vehicle.applyEngineForce(-e,t)},t.prototype.applyEngineBrake=function(e,t){var n,i,o;if(void 0===t&&(t=1),t<1){var r=BABYLON.Scalar.Clamp(t,0,1),a=null===(n=this.getPhysicsBody())||void 0===n?void 0:n.getLinearDamping(),l=BABYLON.Scalar.Lerp(a,e,r);null===(i=this.getPhysicsBody())||void 0===i||i.setLinearDamping(l)}else null===(o=this.getPhysicsBody())||void 0===o||o.setLinearDamping(e)},t.prototype.getWheelIndexByID=function(e){var t=-1;if(null!=this.m_vehicleColliders&&this.m_vehicleColliders.length>0)for(var n=0;n<this.m_vehicleColliders.length;n++){var i=this.m_vehicleColliders[n];if(e.toLowerCase()===i.id.toLowerCase()){t=n;break}}return t},t.prototype.getWheelIndexByName=function(e){var t=-1;if(null!=this.m_vehicleColliders&&this.m_vehicleColliders.length>0)for(var n=0;n<this.m_vehicleColliders.length;n++){var i=this.m_vehicleColliders[n];if(e.toLowerCase()===i.name.toLowerCase()){t=n;break}}return t},t.prototype.getWheelColliderInfo=function(e){var t=-1;return null!=this.m_vehicleColliders&&this.m_vehicleColliders.length>0&&this.m_vehicleColliders.length>e&&(t=this.m_vehicleColliders[e]),t},t.prototype.getVisualSteeringAngle=function(e){var t=0,n=this.getWheelInfo(e);return null!=n&&null!=n.steeringAngle&&(t=n.steeringAngle),t},t.prototype.setVisualSteeringAngle=function(e,t){var n=this.getWheelInfo(t);null!=n&&(n.steeringAngle=e)},t.prototype.getPhysicsSteeringAngle=function(e){if(null!=this.m_vehicle)return Math.abs(this.m_vehicle.getSteeringValue(e))},t.prototype.setPhysicsSteeringAngle=function(e,t){null!=this.m_vehicle&&this.m_vehicle.setSteeringValue(e,t)},t.prototype.resetDefaultFrictionSlip=function(){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.resetDefaultFrictionSlip()},t.prototype.setEnableFrictionUpdates=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setEnableFrictionUpdates(e)},t.prototype.getEnableFrictionUpdates=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.getEnableFrictionUpdates()},t.prototype.getSkiddingFrictionUpdateSpeed=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.skiddingFrictionUpdateSpeed),e},t.prototype.setSkiddingFrictionUpdateSpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.skiddingFrictionUpdateSpeed=e)},t.prototype.getBurnoutFrictionUpdateSpeed=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.burnoutFrictionUpdateSpeed),e},t.prototype.setBurnoutFrictionUpdateSpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.burnoutFrictionUpdateSpeed=e)},t.prototype.setBurnoutCooldownTime=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBurnoutCooldownTime(e)},t.prototype.getBurnoutCooldownTime=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutCooldownTime():0},t.prototype.setBurnoutWheelStiffness=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBurnoutWheelStiffness(e)},t.prototype.getBurnoutWheelStiffness=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutWheelStiffness():1},t.prototype.setHandbrakeWheelStiffness=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setHandbrakeWheelStiffness(e)},t.prototype.getHandbrakeWheelStiffness=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getHandbrakeWheelStiffness():1},t.prototype.setDriftWheelStiffness=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDriftWheelStiffness(e)},t.prototype.getDriftWheelStiffness=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDriftWheelStiffness():1},t.prototype.setLockedWheelIndexes=function(e){this._lockedWheelIndexes=e},t.prototype.getLockedWheelIndexes=function(){return this._lockedWheelIndexes},t.prototype.getAngularDampingReduction=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getAngularDampingReduction()),e},t.prototype.setWheelRotationBoost=function(e,t){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setWheelRotationBoost(e,t)},t.prototype.setAllWheelsRotationBoost=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setAllWheelsRotationBoost(e)},t.prototype.setRearWheelsRotationBoost=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setRearWheelsRotationBoost(e)},t.prototype.setFrontWheelsRotationBoost=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setFrontWheelsRotationBoost(e)},t.prototype.setArcadeSteeringInput=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setArcadeSteeringInput(e)},t.prototype.getArcadeSteerAssistFactor=function(){var e=-1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.arcadeSteerAssistFactor),e},t.prototype.setArcadeSteerAssistFactor=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.arcadeSteerAssistFactor=e)},t.prototype.getArcadeMomentumPreserveFactor=function(){var e=-1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.handBrakePreserveFactor),e},t.prototype.setArcadeMomentumPreserveFactor=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.handBrakePreserveFactor=e)},t.prototype.getisArcadeHandBrakeActive=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.isArcadeHandBrakeActive),e},t.prototype.setisArcadeHandBrakeActive=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.isArcadeHandBrakeActive=e)},t.prototype.getIsArcadeBurnoutModeActive=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getIsArcadeBurnoutModeActive()),e},t.prototype.setIsArcadeBurnoutModeActive=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setIsArcadeBurnoutModeActive(e)},t.prototype.setIsArcadeWheelSkidActive=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setIsArcadeWheelSkidActive(e)},t.prototype.getIsArcadeWheelSkidActive=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getIsArcadeWheelSkidActive()),e},t.prototype.getIsArcadeDonutModeActive=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.isArcadeDonutModeActive),e},t.prototype.setIsArcadeDonutModeActive=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setIsArcadeDonutModeActive(e)},t.prototype.setArcadeHandBrakeDelay=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setArcadeHandBrakeDelay(e)},t.prototype.getArcadeHandBrakeDelay=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getArcadeHandBrakeDelay()),e},t.prototype.setArcadeWheelSkidLimit=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setArcadeWheelSkidLimit(e)},t.prototype.getArcadeWheelSkidLimit=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getArcadeWheelSkidLimit()),e},t.prototype.getArcadeWheelSkidTimer=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getArcadeWheelSkidTimer()),e},t.prototype.getArcadeHandBrakingTimer=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getArcadeHandBrakingTimer()),e},t.prototype.getArcadeFrontSideFactor=function(){var e=-1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.arcadeFrontSideFactor),e},t.prototype.setArcadeFrontSideFactor=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.arcadeFrontSideFactor=e)},t.prototype.getArcadeRearSideFactor=function(){var e=-1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.arcadeRearSideFactor),e},t.prototype.setArcadeRearSideFactor=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.arcadeRearSideFactor=e)},t.prototype.getDonutModeTransitionFactor=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getDonutModeTransitionFactor()),e},t.prototype.getEasedDonutModeTransitionFactor=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getEasedDonutModeTransitionFactor()),e},t.prototype.getDonutModeEngineBoost=function(){var e=0;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getDonutModeEngineBoost()),e},t.prototype.isDonutModeEngaged=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.isDonutModeEngaged()),e},t.prototype.setDonutEngineMultiplier=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDonutEngineMultiplier(e)},t.prototype.setDonutTurnRadius=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDonutTurnRadius(e)},t.prototype.setDonutTransitionSpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDonutTransitionSpeed(e)},t.prototype.isDriftSystemEnabled=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.isDriftSystemEnabled()},t.prototype.setDriftSystemEnabled=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDriftSystemEnabled(e)},t.prototype.setDriftMaxSpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDriftMaxSpeed(e)},t.prototype.getDriftMaxSpeed=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDriftMaxSpeed():0},t.prototype.setDriftSpeedThreshold=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDriftSpeedThreshold(e)},t.prototype.getDriftSpeedThreshold=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDriftSpeedThreshold():0},t.prototype.setDriftGripReduction=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDriftGripReduction(Math.max(0,Math.min(1,e)))},t.prototype.getDriftGripReduction=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDriftGripReduction():0},t.prototype.setDriftSteeringThreshold=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDriftSteeringThreshold(e)},t.prototype.getDriftSteeringThreshold=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDriftSteeringThreshold():0},t.prototype.setLaunchBoostEnabled=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setLaunchBoostEnabled(e)},t.prototype.getLaunchBoostEnabled=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.getLaunchBoostEnabled()},t.prototype.setLaunchBoostDuration=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setLaunchBoostDuration(e)},t.prototype.getLaunchBoostDuration=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getLaunchBoostDuration():0},t.prototype.setLaunchBoostMultiplier=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setLaunchBoostMultiplier(e)},t.prototype.getLaunchBoostMultiplier=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getLaunchBoostMultiplier():0},t.prototype.setLaunchBoostDecaySpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setLaunchBoostDecaySpeed(e)},t.prototype.getLaunchBoostDecaySpeed=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getLaunchBoostDecaySpeed():0},t.prototype.setBurnoutKickStrength=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBurnoutKickStrength(e)},t.prototype.getBurnoutKickStrength=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutKickStrength():0},t.prototype.isBurnoutModeEngaged=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.isBurnoutModeEngaged()},t.prototype.setBurnoutFrictionSlip=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBurnoutFrictionSlip(e)},t.prototype.getBurnoutFrictionSlip=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutFrictionSlip():0},t.prototype.setBurnoutFrictionGrip=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBurnoutFrictionGrip(e)},t.prototype.getBurnoutFrictionGrip=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutFrictionGrip():0},t.prototype.getMinPenaltySpeed=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getMinPenaltySpeed():0},t.prototype.setMinPenaltySpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setMinPenaltySpeed(e)},t.prototype.getPenaltyWheelSlip=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getPenaltyWheelSlip():0},t.prototype.setPenaltyWheelSlip=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setPenaltyWheelSlip(e)},t.prototype.getPenaltyGroundTag=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getPenaltyGroundTag():""},t.prototype.setPenaltyGroundTag=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setPenaltyGroundTag(e)},t.prototype.setBaseRotationBoost=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBaseRotationBoost(e)},t.prototype.getBaseRotationBoost=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBaseRotationBoost():0},t.prototype.setDonutRotationBoost=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDonutRotationBoost(e)},t.prototype.getDonutRotationBoost=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDonutRotationBoost():0},t.prototype.getBurnoutPowerBoost=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutPowerBoost():0},t.prototype.setBurnoutTransitionSpeed=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setBurnoutTransitionSpeed(e)},t.prototype.getBurnoutTransitionSpeed=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getBurnoutTransitionSpeed():0},t.prototype.setBurnoutCoefficient=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setDefaultBurnoutCoefficient(e)},t.prototype.getBurnoutCoefficient=function(){return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody?this.m_vehicle.getDefaultBurnoutCoefficient():0},t.prototype.getStabilizingForce=function(){var e=-1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.stabilizingForce),e},t.prototype.setStabilizingForce=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(this.m_vehicle.stabilizingForce=e)},t.prototype.getSmoothFlyingImpulse=function(){var e=-1;return null!=this.m_vehicle&&(e=this.m_vehicle.smoothFlyingImpulse),e},t.prototype.setSmoothFlyingImpulse=function(e){null!=this.m_vehicle&&(this.m_vehicle.smoothFlyingImpulse=e)},t.prototype.getMaxVisualExtensionLimit=function(){var e=-1;return null!=this.m_vehicle&&(e=this.m_vehicle.maxVisualExtensionLimit),e},t.prototype.setMaxVisualExtensionLimit=function(e){null!=this.m_vehicle&&(this.m_vehicle.maxVisualExtensionLimit=e)},t.prototype.getMaxVisualCompressionLimit=function(){var e=-1;return null!=this.m_vehicle&&(e=this.m_vehicle.maxVisualCompressionLimit),e},t.prototype.setMaxVisualCompressionLimit=function(e){null!=this.m_vehicle&&(this.m_vehicle.maxVisualCompressionLimit=e)},t.prototype.setLoggingEnabled=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setLoggingEnabled(e)},t.prototype.getLoggingEnabled=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getLoggingEnabled()),e},t.prototype.setMultiRaycastEnabled=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setMultiRaycastEnabled(e)},t.prototype.getMultiRaycastEnabled=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getMultiRaycastEnabled()),e},t.prototype.setMultiRaycastRadiusScale=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setMultiRaycastRadiusScale(e)},t.prototype.getMultiRaycastRadiusScale=function(){var e=1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getMultiRaycastRadiusScale()),e},t.prototype.setStabilizeVelocityEnabled=function(e){null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&this.m_vehicle.setStabilizeVelocityEnabled(e)},t.prototype.getStabilizeVelocityEnabled=function(){var e=!1;return null!=this.m_vehicle&&null!=this.m_vehicle.chassisBody&&(e=this.m_vehicle.getStabilizeVelocityEnabled()),e},t.prototype.setupWheelInformation=function(){if(null!=this.m_vehicle&&null!=this.m_vehicleColliders&&this.m_vehicleColliders.length>0){var e=-1,t=0,n=!1,i=0;for(e=0;e<this.m_vehicleColliders.length;e++){var o=this.m_vehicleColliders[e],r=null!=o.name?o.name:"Unknown",a=null!=o.radius?o.radius:.35,l=null!=o.position&&o.position.length>=3?o.position[0]:1,s=null!=o.position&&o.position.length>=3?o.position[2]:-1,u=null!=o.wheelconnectionpoint?o.wheelconnectionpoint:.5,c=null!=o.suspensionrestlength?o.suspensionrestlength:.3,d=null!=o.frontwheel||r.toLowerCase().indexOf("front")>=0,p=s,h=l,m=-this._centerMass.x,f=-this._centerMass.z;t=null!=o.frictionslip?o.frictionslip:10;var g=null!=o.totalsuspensionforces?o.totalsuspensionforces:1e5,y=null!=o.suspensiontravelcm?o.suspensiontravelcm:100,v=null!=o.rollinfluence?o.rollinfluence:.2,_=null!=o.suspensionstiffness?o.suspensionstiffness:50,S=null!=o.dampingcompression?o.dampingcompression:2.5,B=null!=o.dampingrelaxation?o.dampingrelaxation:4.5,b=new BABYLON.Vector3(h+m,u,p+f);i=null!=o.maxVisualTravelRange?o.maxVisualTravelRange:0,n=null!=o.invertWheelDirection&&o.invertWheelDirection,this.m_vehicle.addWheel({radius:a,isFrontWheel:d,directionLocal:new BABYLON.Vector3(0,-1,0),suspensionStiffness:_,suspensionRestLength:c,frictionSlip:t,dampingRelaxation:B,dampingCompression:S,maxSuspensionForce:g,rollInfluence:v,axleLocal:new BABYLON.Vector3(-1,0,0),chassisConnectionPointLocal:b,maxSuspensionTravel:y,steeringAngle:0,defaultFriction:t,invertDirection:n,visualTravelRange:i})}}},t.prototype.tickVehicleController=function(e){null!=this.m_vehicle&&this.m_vehicle.updateVehicle(e)},t.prototype.updateWheelInformation=function(){this.m_vehicle.getCurrentSpeedKmHour();var t=this.getNumWheels();if(t>0)for(var n=0;n<t;n++){var i=this.getWheelInfo(n);if(null!=i){i.locked=this.lockedWheelInformation(n),this.updateWheelTransform(n);var o=this.getWheelTransform(n);if(null!=o&&this._tempVectorPos.copyFrom(o.position),null!=i.hub){var r=i.hub;if(null!=r.parent){e.Utilities.InverseTransformPointToRef(r.parent,this._tempVectorPos,this._tempVectorPos),r.position.y=this._tempVectorPos.y,i.visualTravelRange>0&&(r.position.y=BABYLON.Scalar.Clamp(r.position.y,-Math.abs(i.visualTravelRange),Math.abs(i.visualTravelRange)));var a=null!=i.steeringAngle?i.steeringAngle:0;BABYLON.Quaternion.FromEulerAnglesToRef(0,a,0,r.rotationQuaternion),null!=i.spinner&&null!=i.rotation&&(!0===i.invertDirection?BABYLON.Quaternion.FromEulerAnglesToRef(-i.rotation,0,0,i.spinner.rotationQuaternion):BABYLON.Quaternion.FromEulerAnglesToRef(i.rotation,0,0,i.spinner.rotationQuaternion))}}}}},t.prototype.lockedWheelInformation=function(e){var t=!1;if(null!=this._lockedWheelIndexes&&this._lockedWheelIndexes.length>0)for(var n=0;n<this._lockedWheelIndexes.length;n++)if(this._lockedWheelIndexes[n]===e){t=!0;break}return t},t.prototype.deleteWheelInformation=function(){var e=this.getNumWheels();if(e>0)for(var t=0;t<e;t++){var n=this.getWheelInfo(t);null!=n&&(n.hub=null,n.spinner=null,n.steeringAngle=0,n.rotationBoost=0,n.defaultFriction=0)}},t}();e.RaycastVehicle=t}(i||(i={})),function(e){var t=function(t){function n(e,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.RigidbodyPhysics");var r=t.call(this,e,n,i,o)||this;return r._isKinematic=!1,r._centerOfMass=new BABYLON.Vector3(0,0,0),r.m_raycastVehicle=null,r}return o(n,t),n.prototype.awake=function(){this.awakeRigidbodyState()},n.prototype.update=function(){this.updateRigidbodyState()},n.prototype.late=function(){this.lateRigidbodyState()},n.prototype.destroy=function(){this.destroyRigidbodyState()},n.prototype.awakeRigidbodyState=function(){this._isKinematic=this.getProperty("isKinematic",this._isKinematic),null!=this.transform.metadata&&null!=this.transform.metadata.toolkit&&null!=this.transform.metadata.toolkit.physics&&(this._centerOfMass=null!=this.transform.metadata.toolkit.physics.center?e.Utilities.ParseVector3(this.transform.metadata.toolkit.physics.center,this._centerOfMass):this._centerOfMass),this.hasWheelColliders()&&(this.m_raycastVehicle=new e.RaycastVehicle(this.scene,this.transform,this._centerOfMass),e.Utilities.ShowDebugColliders()&&console.log("Raycase Vehicle Created For: "+this.transform.name))},n.prototype.updateRigidbodyState=function(){null!=this.m_raycastVehicle&&this.m_raycastVehicle.updateWheelInformation()},n.prototype.lateRigidbodyState=function(){null!=this.m_raycastVehicle&&this.m_raycastVehicle.tickVehicleController(e.RigidbodyPhysics.PHYSICS_STEP_TIME)},n.prototype.destroyRigidbodyState=function(){null!=this.m_raycastVehicle&&(this.m_raycastVehicle.dispose(),this.m_raycastVehicle=null)},n.prototype.isKinematic=function(){return this._isKinematic},n.prototype.hasWheelColliders=function(){return null!=this.transform.metadata&&null!=this.transform.metadata.toolkit&&null!=this.transform.metadata.toolkit.wheels},n.prototype.getRaycastVehicle=function(){return this.m_raycastVehicle},n.GetHavokInstance=function(){return globalThis.HK},n.Raycast=function(t,n,i,o){return null==e.RigidbodyPhysics.RaycastResult&&(e.RigidbodyPhysics.RaycastResult=new BABYLON.PhysicsRaycastResult),null==e.RigidbodyPhysics.RaycastDestination&&(e.RigidbodyPhysics.RaycastDestination=new BABYLON.Vector3(0,0,0)),e.RigidbodyPhysics.RaycastResult.reset(),e.RigidbodyPhysics.RaycastDestination.set(0,0,0),e.Utilities.CalculateDestinationPointToRef(t,n,i,e.RigidbodyPhysics.RaycastDestination),e.RigidbodyPhysics.RaycastToRef(t,e.RigidbodyPhysics.RaycastDestination,e.RigidbodyPhysics.RaycastResult,o),e.RigidbodyPhysics.RaycastResult},n.Shapecast=function(t){return null==e.RigidbodyPhysics.LocalShapeResult&&(e.RigidbodyPhysics.LocalShapeResult=new BABYLON.ShapeCastResult),null==e.RigidbodyPhysics.WorldShapeResult&&(e.RigidbodyPhysics.WorldShapeResult=new BABYLON.ShapeCastResult),e.RigidbodyPhysics.LocalShapeResult.reset(),e.RigidbodyPhysics.WorldShapeResult.reset(),e.RigidbodyPhysics.ShapecastToRef(t,e.RigidbodyPhysics.LocalShapeResult,e.RigidbodyPhysics.WorldShapeResult),{local:e.RigidbodyPhysics.LocalShapeResult,world:e.RigidbodyPhysics.WorldShapeResult}},n.RaycastToRef=function(t,n,i,o){var r=e.Utilities.GetHavokPlugin();if(r){null==e.RigidbodyPhysics.RaycastResult&&(e.RigidbodyPhysics.RaycastResult=new BABYLON.PhysicsRaycastResult),null==e.RigidbodyPhysics.RaycastDestination&&(e.RigidbodyPhysics.RaycastDestination=new BABYLON.Vector3(0,0,0)),e.RigidbodyPhysics.RaycastResult.reset(),e.RigidbodyPhysics.RaycastDestination.set(0,0,0);var a=null!=i?i:e.RigidbodyPhysics.RaycastResult;r.raycast(t,n,a,o)}else BABYLON.Tools.Warn("Havok.js physics library not loaded")},n.ShapecastToRef=function(t,n,i){var o=e.Utilities.GetHavokPlugin();if(o){null==e.RigidbodyPhysics.LocalShapeResult&&(e.RigidbodyPhysics.LocalShapeResult=new BABYLON.ShapeCastResult),null==e.RigidbodyPhysics.WorldShapeResult&&(e.RigidbodyPhysics.WorldShapeResult=new BABYLON.ShapeCastResult),e.RigidbodyPhysics.LocalShapeResult.reset(),e.RigidbodyPhysics.WorldShapeResult.reset();var r=null!=n?n:e.RigidbodyPhysics.LocalShapeResult,a=null!=i?i:e.RigidbodyPhysics.WorldShapeResult;o.shapeCast(t,r,a)}else BABYLON.Tools.Warn("Havok.js physics library not loaded")},n.SetMaxVelocities=function(t,n){var i=e.Utilities.GetHavokPlugin();if(i){var o=i._hknp.HEAP8.buffer,r=new Int32Array(o,Number(i.world),100),a=new Int32Array(o,r[8],500),l=new Int32Array(o,a[428],100),s=new Float32Array(o,l[8],300);s[32]=t,s[33]=n,s[60]=t,s[61]=n,s[88]=t,s[89]=n,s[144]=t,s[145]=n,s[172]=t,s[173]=n,s[200]=t,s[201]=n,s[228]=t}else BABYLON.Tools.Warn("Havok.js physics library not loaded")},n.ConfigurePhysicsEngine=function(t){return r(this,arguments,void 0,function(t,n,i,o,r,l,s){var u,c,d,p,h,m,f;return void 0===n&&(n=!0),void 0===i&&(i=0),void 0===o&&(o=0),void 0===r&&(r=!0),void 0===l&&(l=1e-4),void 0===s&&(s=null),a(this,function(o){switch(o.label){case 0:if(!BABYLON.HavokPlugin)return[3,7];BABYLON.Tools.Log("Havok.js physics engine initializing..."),o.label=1;case 1:return o.trys.push([1,5,6,7]),t.isPhysicsEnabled()?[3,4]:null!=(u=e.RigidbodyPhysics.GetHavokInstance())?[3,3]:(c=globalThis,[4,BABYLON.HavokPhysics()]);case 2:c.HK=o.sent(),u=globalThis.HK,o.label=3;case 3:return d=new BABYLON.Vector3(0,-9.81,0),p=null!=s?s:d,globalThis.HKP=new BABYLON.HavokPlugin(!n,u),t.enablePhysics(p,globalThis.HKP),[3,4];case 4:return[3,7];case 5:return h=o.sent(),console.warn(h),[3,7];case 6:e.RigidbodyPhysics.PhysicsShapeCache={},e.RigidbodyPhysics.NewPhysicsShapeCount=0,e.RigidbodyPhysics.CachedPhysicsShapeCount=0;try{null===(f=t.getPhysicsEngine())||void 0===f||f.setSubTimeStep(i),BABYLON.Tools.Log("Havok.js initialized with sub time step: "+i),m=e.RigidbodyPhysics.GetPhysicsHeapSize(),BABYLON.Tools.Log("Havok.js initialized with a heap size of "+m+" MB")}catch(e){console.warn(e)}try{null!=e.RigidbodyPhysics.OnSetupPhysicsPlugin&&e.RigidbodyPhysics.OnSetupPhysicsPlugin(t)}catch(e){console.warn(e)}return[7];case 7:return[2]}})})},n.SetupPhysicsComponent=function(t,n){var i=null!=n.metadata&&null!=n.metadata.toolkit?n.metadata.toolkit:null,o=null!=i.layermask?i.layermask:-1;if(null!=i&&(null!=i.physics||null!=i.collision)){var r=null!=i.physics,a=null!=i.physics&&null!=i.physics.filter?i.physics.filter:-1,l=null!=i.physics&&null!=i.physics.vehicle&&i.physics.vehicle,s=null!=i.physics&&null!=i.physics.root&&i.physics.root,u=null!=i.collision&&null!=i.collision.compoundcolliders,c=null!=i.physics&&null!=i.physics.mass?i.physics.mass:0,d=null!=i.physics&&null!=i.physics.center?i.physics.center:{x:0,y:0,z:0},p=null==i.physics||null==i.physics.kinematic||i.physics.kinematic,h=null==i.physics||null==i.physics.truestatic||i.physics.truestatic,m=BABYLON.PhysicsMotionType.DYNAMIC;if(m=!0===h?BABYLON.PhysicsMotionType.STATIC:!0===p?BABYLON.PhysicsMotionType.ANIMATED:BABYLON.PhysicsMotionType.DYNAMIC,!0===r){if(l){var f=null,g=n.getChildren(null,!1);null!=g&&g.length>0&&g.forEach(function(t){if(null!=t.metadata&&null!=t.metadata.toolkit&&null!=t.metadata.toolkit.collision){var i=t.metadata.toolkit.collision,o=null!=i.wheelinformation?i.wheelinformation:null;null!=o&&(e.Utilities.ShowDebugColliders()&&console.log("Setup raycast wheel collider: "+t.name+" --\x3e on to: "+n.name,n),null==f&&(f=[]),f.push(o))}}),null!=f&&f.length>0&&(null==n.metadata&&(n.metadata={}),null==n.metadata.toolkit&&(n.metadata.toolkit={}),n.metadata.toolkit.wheels=f)}if(u){var y=i.collision.compoundcolliders;if(null!=y&&y.length>0){var v=0,_=0,S=0,B=!1,b=[];if(y.forEach(function(i){if(null!=i){var r=null!=i.type?i.type:"BoxCollider",l=null!=i.restitutioncombine?e.RigidbodyPhysics.GetPhysicsMaterialCombine(i.restitutioncombine):0,s=null!=i.frictioncombine?e.RigidbodyPhysics.GetPhysicsMaterialCombine(i.frictioncombine):0,u=null!=i.dynamicfriction?i.dynamicfriction:.6,c=null!=i.staticfriction?i.staticfriction:.6,d=null!=i.restitution?i.restitution:0,p=null!=i.trigger&&i.trigger;u>v&&(v=u),c>_&&(_=c),d>S&&(S=d),1==p&&(B=!0);var h=e.RigidbodyPhysics.BoxImpostor;h="MeshCollider"===r?e.RigidbodyPhysics.ConvexHullImpostor:"CapsuleCollider"===r?e.RigidbodyPhysics.CapsuleImpostor:"SphereCollider"===r?e.RigidbodyPhysics.SphereImpostor:e.RigidbodyPhysics.BoxImpostor;var m=i,f=null!=m.center?m.center:{x:0,y:0,z:0},g=null!=m.persist&&m.persist,y=new e.PhyscisContainerData;e.Utilities.ShowDebugColliders()&&console.log("Setup simple compound child collider type ("+r+") --\x3e on to: "+n.name,n),e.RigidbodyPhysics.CreateCompoundPhysicsShapeAndBody(t,n,n,m,h,c,u,d,s,l,b,y,f,!1,p,g,o,a)}}),b.length>0){e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var C=new BABYLON.Vector3(d.x,d.y,d.z),A=new BABYLON.PhysicsShapeContainer(t);b.forEach(function(e){A.addChild(e.shape,e.translation,e.rotation,e.scale)}),A.material=b[0].shape.material;var M=new BABYLON.PhysicsBody(n,m,!1,t);M.shape=A,e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,B,i.physics,c,C),e.Utilities.ShowDebugColliders()||null!=(k=n).material&&"CenterBox-Material"===k.material.name&&(k.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(M))}}}else if(s){var T=0,O=0,I=0,L=!1,x=[],N=null!=i.physics&&null!=i.physics.center?e.Utilities.ParseVector3(i.physics.center,BABYLON.Vector3.Zero()):BABYLON.Vector3.Zero(),w=n.getChildren(null,!0);null!=w&&w.length>0&&w.forEach(function(e){e.position.subtractInPlace(N)});var P=n.getChildren(null,!1);if(null!=P&&P.length>0&&P.forEach(function(i){if(null!=i.metadata&&null!=i.metadata.toolkit&&null!=i.metadata.toolkit.collision){var r=i.metadata.toolkit.collision,l=null!=r.restitutioncombine?e.RigidbodyPhysics.GetPhysicsMaterialCombine(r.restitutioncombine):0,u=null!=r.frictioncombine?e.RigidbodyPhysics.GetPhysicsMaterialCombine(r.frictioncombine):0,c=null!=r.dynamicfriction?r.dynamicfriction:.6,d=null!=r.staticfriction?r.staticfriction:.6,p=null!=r.restitution?r.restitution:0,h=null!=r.trigger&&r.trigger,m=null!=r.type?r.type:"BoxCollider";c>T&&(T=c),d>O&&(O=d),p>I&&(I=p),1==h&&(L=!0);var f=e.RigidbodyPhysics.BoxImpostor;f="MeshCollider"===m?e.RigidbodyPhysics.ConvexHullImpostor:"CapsuleCollider"===m?e.RigidbodyPhysics.CapsuleImpostor:"SphereCollider"===m?e.RigidbodyPhysics.SphereImpostor:e.RigidbodyPhysics.BoxImpostor;var g=r,y=null!=g.center?g.center:{x:0,y:0,z:0},v=null!=g.persist&&g.persist,_=new e.PhyscisContainerData;e.Utilities.ShowDebugColliders()&&console.log("Setup complex compound child collider type ("+m+") --\x3e on to: "+n.name,n),e.RigidbodyPhysics.CreateCompoundPhysicsShapeAndBody(t,n,i,g,f,d,c,p,u,l,x,_,y,s,h,v,o,a)}}),x.length>0){e.Utilities.ReparentColliders()||n.setParent(null,!0,!0),C=new BABYLON.Vector3(d.x,d.y,d.z);var R=new BABYLON.PhysicsShapeContainer(t);R.material=x[0].shape.material,x.forEach(function(e){R.addChild(e.shape,e.translation,e.rotation,e.scale)});var k,E=new BABYLON.PhysicsBody(n,m,!1,t);E.shape=R,e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,L,i.physics,c,C),e.Utilities.ShowDebugColliders()||null!=(k=n).material&&"CenterBox-Material"===k.material.name&&(k.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(E))}}else if(null!=i.collision){var D=null!=i.collision.type?i.collision.type:"BoxCollider",U=null!=i.collision.convexmesh&&i.collision.convexmesh,F=null!=i.collision.restitutioncombine?e.RigidbodyPhysics.GetPhysicsMaterialCombine(i.collision.restitutioncombine):0,Y=null!=i.collision.frictioncombine?e.RigidbodyPhysics.GetPhysicsMaterialCombine(i.collision.frictioncombine):0,V=null!=i.collision.dynamicfriction?i.collision.dynamicfriction:.6,G=null!=i.collision.staticfriction?i.collision.staticfriction:.6,H=null!=i.collision.restitution?i.collision.restitution:0,z=null!=i.collision.terraindata?i.collision.terraindata:null,W=null!=i.collision.trigger&&i.collision.trigger,Q=null!=i.collision.persist&&i.collision.persist,X=e.RigidbodyPhysics.BoxImpostor;X="MeshCollider"===D?!0===U?e.RigidbodyPhysics.ConvexHullImpostor:e.RigidbodyPhysics.MeshImpostor:"TerrainCollider"===D?e.RigidbodyPhysics.HeightmapImpostor:"CapsuleCollider"===D?e.RigidbodyPhysics.CapsuleImpostor:"SphereCollider"===D?e.RigidbodyPhysics.SphereImpostor:e.RigidbodyPhysics.BoxImpostor,e.RigidbodyPhysics.CreateStandardPhysicsShapeAndBody(t,n,i,X,W,h,m,c,G,V,H,Y,F,z,d,Q,o,a)}}null!=n&&null!=n.physicsBody&&!0===p&&(n.physicsBody.disablePreStep=!1)}},n.GetPhysicsMaterialCombine=function(e){switch(e){case 0:default:return BABYLON.PhysicsMaterialCombineMode.ARITHMETIC_MEAN;case 1:return BABYLON.PhysicsMaterialCombineMode.MULTIPLY;case 2:return BABYLON.PhysicsMaterialCombineMode.MINIMUM;case 3:return BABYLON.PhysicsMaterialCombineMode.MAXIMUM}},n.GetCachedPhysicsMeshShape=function(t,n,i,o,r,a,l,s,u,c){if(null==i||""===i)return console.warn("Invalid mesh key specfifed for child collider: "+n.name),null;i+="_SF"+o+"_DF"+r+"_R"+a+"_T0_L"+u+"_X"+c;var d=e.RigidbodyPhysics.PhysicsShapeCache[i];return null==d?((d=new BABYLON.PhysicsShapeMesh(n,t)).material={friction:r,staticFriction:o,restitution:a,frictionCombine:l,restitutionCombine:s},d.isTrigger=!1,d.filterMembershipMask=u,d.filterCollideMask=c,e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[i]=d):e.RigidbodyPhysics.CachedPhysicsShapeCount++,d},n.GetCachedPhysicsConvexHullShape=function(t,n,i,o,r,a,l,s,u,c){if(null==i||""===i)return console.warn("Invalid mesh key specfifed for child collider: "+n.name),null;i+="_SF"+o+"_DF"+r+"_R"+a+"_T0_L"+u+"_X"+c;var d=e.RigidbodyPhysics.PhysicsShapeCache[i];return null==d?((d=new BABYLON.PhysicsShapeConvexHull(n,t)).material={friction:r,staticFriction:o,restitution:a,frictionCombine:l,restitutionCombine:s},d.isTrigger=!1,d.filterMembershipMask=u,d.filterCollideMask=c,e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[i]=d):e.RigidbodyPhysics.CachedPhysicsShapeCount++,d},n.GetCachedPhysicsBoxShape=function(t,n,i,o,r,a,l,s,u){var c="SHAPE_BOX_SF"+i+"_DF"+o+"_R"+r+"_T"+(1==n?"1":"0")+"_L"+s+"_X"+u,d=e.RigidbodyPhysics.PhysicsShapeCache[c];return null==d?((d=new BABYLON.PhysicsShapeBox(new BABYLON.Vector3(0,0,0),new BABYLON.Quaternion(0,0,0,1),new BABYLON.Vector3(1,1,1),t)).material={friction:o,staticFriction:i,restitution:r,frictionCombine:a,restitutionCombine:l},d.isTrigger=n,d.filterMembershipMask=s,d.filterCollideMask=u,e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[c]=d):e.RigidbodyPhysics.CachedPhysicsShapeCount++,d},n.GetCachedPhysicsSphereShape=function(t,n,i,o,r,a,l,s,u){var c="SHAPE_SPHERE_SF"+i+"_DF"+o+"_R"+r+"_T"+(1==n?"1":"0")+"_L"+s+"_X"+u,d=e.RigidbodyPhysics.PhysicsShapeCache[c];return null==d?((d=new BABYLON.PhysicsShapeSphere(new BABYLON.Vector3(0,0,0),1,t)).material={friction:o,staticFriction:i,restitution:r,frictionCombine:a,restitutionCombine:l},d.isTrigger=n,d.filterMembershipMask=s,d.filterCollideMask=u,e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[c]=d):e.RigidbodyPhysics.CachedPhysicsShapeCount++,d},n.GetCachedPhysicsCapsuleShape=function(t,n,i,o,r,a,l,s,u){var c="SHAPE_CAPSULE_SF"+i+"_DF"+o+"_R"+r+"_T"+(1==n?"1":"0")+"_L"+s+"_X"+u,d=e.RigidbodyPhysics.PhysicsShapeCache[c];return null==d?((d=new BABYLON.PhysicsShapeCapsule(new BABYLON.Vector3(0,-1,0),new BABYLON.Vector3(0,1,0),1,t)).material={friction:o,staticFriction:i,restitution:r,frictionCombine:a,restitutionCombine:l},d.isTrigger=n,d.filterMembershipMask=s,d.filterCollideMask=u,e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[c]=d):e.RigidbodyPhysics.CachedPhysicsShapeCount++,d},n.GetCachedPhysicsCylinderShape=function(t,n,i,o,r,a,l,s,u){var c="SHAPE_CYLINDER_SF"+i+"_DF"+o+"_R"+r+"_T"+(1==n?"1":"0")+"_L"+s+"_X"+u,d=e.RigidbodyPhysics.PhysicsShapeCache[c];return null==d?((d=new BABYLON.PhysicsShapeCylinder(new BABYLON.Vector3(0,-.5,0),new BABYLON.Vector3(0,.5,0),1,t)).material={friction:o,staticFriction:i,restitution:r,frictionCombine:a,restitutionCombine:l},d.isTrigger=n,d.filterMembershipMask=s,d.filterCollideMask=u,e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[c]=d):e.RigidbodyPhysics.CachedPhysicsShapeCount++,d},n.CreateStandardPhysicsShapeAndBody=function(t,n,i,o,r,a,l,s,u,c,d,p,h,m,f,g,y,v){var _=i.collision,S=null!=_.meshkey?_.meshkey:null,B=null!=_.center?_.center:{x:0,y:0,z:0};if(o==e.RigidbodyPhysics.HeightmapImpostor)if(null!=m){e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var b=n,C=m.index,A=m.segments,M=m.resolution,T=m.width,O=(m.height,m.length);if(1===(null!=m.collider?m.collider:0)){var I=1,L=1,x=0,N=0;if(1===A)x=.5*(T+(I=T/(M-1))),N=.5*(O-(L=O/(M-1)));else if(2===A){var w=T/A,P=O/A;I=T/(M-1),L=O/(M-1),0===C?(x=.5*(w+I)+0,N=.5*(P-L)+0):1===C?(x=.5*(1*w+I)+0,N=.5*(P-L)+P):2===C?(x=.5*(1*w+I)+w,N=.5*(P-L)+0):3===C&&(x=.5*(1*w+I)+w,N=.5*(P-L)+P)}var R=e.RigidbodyPhysics.CreateHeightFieldTerrainShapeFromMesh(b,I,L),k=new BABYLON.PhysicsShape({type:BABYLON.PhysicsShapeType.HEIGHTFIELD,pluginData:R},t);k.filterMembershipMask=y,k.filterCollideMask=v,k.material={friction:c,staticFriction:u,restitution:d,frictionCombine:p,restitutionCombine:h};var E="TERRAIN_MESH_ID"+b.uniqueId+"_SF"+u+"_DF"+c+"_R"+d+"_T0_L"+y+"_X"+v;e.RigidbodyPhysics.NewPhysicsShapeCount++,e.RigidbodyPhysics.PhysicsShapeCache[E]=k;var D=new BABYLON.Vector3(x,0,N),U=new BABYLON.Quaternion(0,0,0,1),F=new BABYLON.Vector3(1,1,1),Y=new BABYLON.PhysicsShapeContainer(t);Y.material=k.material,e.Utilities.FromEulerToRef(0,90,0,U),k.isTrigger=!1,Y.addChild(k,D,U,F);var V=new BABYLON.PhysicsBody(n,BABYLON.PhysicsMotionType.STATIC,!1,t);V.shape=Y,e.Utilities.ShowDebugColliders()&&console.log("Setup standard terrain heightmap physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,r,i.physics,0,new BABYLON.Vector3(f.x,f.y,f.z)),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(V))}else(z=new BABYLON.PhysicsShapeMesh(b,t)).filterMembershipMask=y,z.filterCollideMask=v,z.material={friction:c,staticFriction:u,restitution:d,frictionCombine:p,restitutionCombine:h},(H=new BABYLON.PhysicsBody(n,BABYLON.PhysicsMotionType.STATIC,!1,t)).shape=z,e.Utilities.ShowDebugColliders()&&console.log("Setup terrain mesh physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,r,i.physics,0,new BABYLON.Vector3(f.x,f.y,f.z)),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(H))}else BABYLON.Tools.Warn("No terrain collision data found for: "+n.name+". No terrain collision impostor will be created.");else if(o==e.RigidbodyPhysics.MeshImpostor){var G=e.SceneManager.FindChildTransformNode(n,n.name+".Collider",e.SearchType.ExactMatch,!0);if(null!=G){!1===g&&e.Utilities.AddLoaderItemMarkedForDisposal(G),e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var H=new BABYLON.PhysicsBody(n,BABYLON.PhysicsMotionType.STATIC,!1,t),z=e.RigidbodyPhysics.GetCachedPhysicsMeshShape(t,G,S,u,c,d,p,h,y,v),W=new BABYLON.PhysicsShapeContainer(t);W.material=z.material,e.RigidbodyPhysics.AddChildShapeFromParent(W,n,z,G),H.shape=W,e.Utilities.ShowDebugColliders()&&console.log("Setup standard mesh physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,r,i.physics,0,new BABYLON.Vector3(f.x,f.y,f.z)),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(H))}else BABYLON.Tools.Warn("No mesh collider found for: "+n.name+".")}else if(o==e.RigidbodyPhysics.ConvexHullImpostor){var Q=e.SceneManager.FindChildTransformNode(n,n.name+".Collider",e.SearchType.ExactMatch,!0);if(null!=Q){!1===g&&e.Utilities.AddLoaderItemMarkedForDisposal(Q),e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var X=e.RigidbodyPhysics.GetCachedPhysicsConvexHullShape(t,Q,S,u,c,d,p,h,y,v),K=new BABYLON.PhysicsShapeContainer(t);K.material=X.material,e.RigidbodyPhysics.AddChildShapeFromParent(K,n,X,Q);var j=new BABYLON.PhysicsBody(n,l,!1,t);j.shape=K,e.Utilities.ShowDebugColliders()&&console.log("Setup standard convex hull physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!0,!1,i.physics,s,new BABYLON.Vector3(f.x,f.y,f.z)),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(j))}else BABYLON.Tools.Warn("No convex hull child mesh collider found for: "+n.name+".")}else if(o==e.RigidbodyPhysics.BoxImpostor){e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var Z=null!=_.boxsize?_.boxsize:{x:1,y:1,z:1},J=Z.x*parseFloat(n.scaling.x.toFixed(4)),q=Z.y*parseFloat(n.scaling.y.toFixed(4)),$=Z.z*parseFloat(n.scaling.z.toFixed(4)),ee=B.x*parseFloat(n.scaling.x.toFixed(4)),te=B.y*parseFloat(n.scaling.y.toFixed(4)),ne=B.z*parseFloat(n.scaling.z.toFixed(4)),ie=new BABYLON.Vector3(ee,te,ne),oe=e.RigidbodyPhysics.GetCachedPhysicsBoxShape(t,r,u,c,d,p,h,y,v),re=new BABYLON.PhysicsShapeContainer(t);re.material=oe.material,re.addChild(oe,ie,new BABYLON.Quaternion(0,0,0,1),new BABYLON.Vector3(J,q,$));var ae=new BABYLON.PhysicsBody(n,l,!1,t);ae.shape=re,e.Utilities.ShowDebugColliders()&&console.log("Setup standard box physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,!1,i.physics,s,ie.add(new BABYLON.Vector3(f.x,f.y,f.z))),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(ae))}else if(o==e.RigidbodyPhysics.SphereImpostor){e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var le=null!=_.sphereradius?_.sphereradius:.5,se=parseFloat(n.scaling.x.toFixed(4)),ue=parseFloat(n.scaling.y.toFixed(4)),ce=parseFloat(n.scaling.z.toFixed(4)),de=Math.max(se,ue,ce)*le,pe=(ee=B.x*parseFloat(n.scaling.x.toFixed(4)),te=B.y*parseFloat(n.scaling.y.toFixed(4)),ne=B.z*parseFloat(n.scaling.z.toFixed(4)),ie=new BABYLON.Vector3(ee,te,ne),e.RigidbodyPhysics.GetCachedPhysicsSphereShape(t,r,u,c,d,p,h,y,v)),he=new BABYLON.PhysicsShapeContainer(t);he.material=pe.material,he.addChild(pe,ie,new BABYLON.Quaternion(0,0,0,1),new BABYLON.Vector3(de,de,de));var me=new BABYLON.PhysicsBody(n,l,!1,t);me.shape=he,e.Utilities.ShowDebugColliders()&&console.log("Setup standard sphere physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,!1,i.physics,s,ie.add(new BABYLON.Vector3(f.x,f.y,f.z))),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(me))}else if(o==e.RigidbodyPhysics.CapsuleImpostor){e.Utilities.ReparentColliders()||n.setParent(null,!0,!0);var fe=null!=_.cylinder&&_.cylinder,ge=null!=_.capsulesize?_.capsulesize:{x:.5,y:2,z:1},ye=ge.x*parseFloat(n.scaling.x.toFixed(4)),ve=ge.y*parseFloat(n.scaling.y.toFixed(4)),_e=parseFloat(n.scaling.z.toFixed(4));_e=!0===fe?e.RigidbodyPhysics.GetCachedPhysicsCylinderShape(t,r,u,c,d,p,h,y,v):e.RigidbodyPhysics.GetCachedPhysicsCapsuleShape(t,r,u,c,d,p,h,y,v);var Se=new BABYLON.Quaternion(0,0,0,1);0!==ge.z&&2!==ge.z||(0===ge.z?e.Utilities.FromEulerToRef(0,0,90,Se):2===ge.z&&e.Utilities.FromEulerToRef(90,0,0,Se)),ee=B.x*parseFloat(n.scaling.x.toFixed(4)),te=B.y*parseFloat(n.scaling.y.toFixed(4)),ne=B.z*parseFloat(n.scaling.z.toFixed(4)),ie=new BABYLON.Vector3(ee,te,ne);var Be=new BABYLON.PhysicsShapeContainer(t);Be.material=_e.material,Be.addChild(_e,ie,Se,new BABYLON.Vector3(ye,ve,ye));var be,Ce=new BABYLON.PhysicsBody(n,l,!1,t);Ce.shape=Be,e.Utilities.ShowDebugColliders()&&console.log("Setup standard "+(!0===fe?"cylinder":"capsule")+" physics collider for: "+n.name,n),e.RigidbodyPhysics.ConfigRigidbodyPhysics(t,n,!1,!1,i.physics,s,ie.add(new BABYLON.Vector3(f.x,f.y,f.z))),e.Utilities.ShowDebugColliders()||null!=(be=n).material&&"CenterBox-Material"===be.material.name&&(be.isVisible=!1),e.Utilities.ShowDebugColliders()&&(null==e.RigidbodyPhysics.DebugPhysicsViewer&&(e.RigidbodyPhysics.DebugPhysicsViewer=new BABYLON.Debug.PhysicsViewer),null!=e.RigidbodyPhysics.DebugPhysicsViewer&&e.RigidbodyPhysics.DebugPhysicsViewer.showBody(Ce))}},n.CreateCompoundPhysicsShapeAndBody=function(t,n,i,o,r,a,l,s,u,c,d,p,h,m,f,g,y,v){var _=0,S=0,B=0,b=new BABYLON.Vector3(0,0,0),C=new BABYLON.Quaternion(0,0,0,1),A=new BABYLON.Vector3(1,1,1);if(!1===g&&!0===m&&e.Utilities.AddLoaderItemMarkedForDisposal(i),r==e.RigidbodyPhysics.ConvexHullImpostor){var M=e.SceneManager.FindChildTransformNode(i,i.name+".Collider",e.SearchType.ExactMatch,!0);if(null!=M){var T=1,O=1,I=1;if(M instanceof BABYLON.InstancedMesh){!0===m&&(T*=parseFloat(n.scaling.x.toFixed(4)),O*=parseFloat(n.scaling.y.toFixed(4)),I*=parseFloat(n.scaling.z.toFixed(4))),A.set(T,O,I);var L=M.sourceMesh;if(null!=L){var x=null!=M.metadata&&null!=M.metadata.toolkit&&null!=M.metadata.toolkit.collision&&null!=M.metadata.toolkit.collision.sourcescale?M.metadata.toolkit.collision.sourcescale:null,N=null!=L.metadata&&null!=L.metadata.toolkit&&null!=L.metadata.toolkit.collision&&null!=L.metadata.toolkit.collision.sourcescale?L.metadata.toolkit.collision.sourcescale:null;if(null!=N&&null!=x){var w=new BABYLON.Vector3(1,1,1),P=new BABYLON.Vector3(x.x,x.y,x.z),R=new BABYLON.Vector3(N.x,N.y,N.z);P.divideToRef(R,w),A.multiplyInPlace(w)}}}else A.set(T,O,I);var k=null!=o.meshkey?o.meshkey:null,E=e.RigidbodyPhysics.GetCachedPhysicsConvexHullShape(t,M,k,a,l,s,u,c,y,v);if(!0===m){var D=i.position.x*parseFloat(n.scaling.x.toFixed(4)),U=i.position.y*parseFloat(n.scaling.y.toFixed(4)),F=i.position.z*parseFloat(n.scaling.z.toFixed(4));b.set(D,U,F),C.multiplyInPlace(i.rotationQuaternion)}else _=h.x*parseFloat(i.scaling.x.toFixed(4)),S=h.y*parseFloat(i.scaling.y.toFixed(4)),B=h.z*parseFloat(i.scaling.z.toFixed(4)),b.set(_,S,B);p.shape=E,p.translation=b,p.rotation=C,p.scale=A,d.push(p)}}else if(r==e.RigidbodyPhysics.CapsuleImpostor){var Y=null!=o.cylinder&&o.cylinder,V=null!=o.capsulesize?o.capsulesize:{x:.5,y:2,z:1},G=V.x*parseFloat(i.scaling.x.toFixed(4)),H=V.y*parseFloat(i.scaling.y.toFixed(4));parseFloat(i.scaling.z.toFixed(4)),!0===m&&(G*=parseFloat(n.scaling.x.toFixed(4)),H*=parseFloat(n.scaling.y.toFixed(4)),parseFloat(n.scaling.z.toFixed(4))),A.set(G,H,G);var z;z=!0===Y?e.RigidbodyPhysics.GetCachedPhysicsCylinderShape(t,f,a,l,s,u,c,y,v):e.RigidbodyPhysics.GetCachedPhysicsCapsuleShape(t,f,a,l,s,u,c,y,v),0!==V.z&&2!==V.z||(0===V.z?e.Utilities.FromEulerToRef(0,0,90,C):2===V.z&&e.Utilities.FromEulerToRef(90,0,0,C)),!0===m?(0===h.x&&0===h.y&&0===h.z||console.warn("WARNING: Center offset not supported for complex compound item: "+i.name),D=i.position.x*parseFloat(n.scaling.x.toFixed(4)),U=i.position.y*parseFloat(n.scaling.y.toFixed(4)),F=i.position.z*parseFloat(n.scaling.z.toFixed(4)),b.set(D,U,F),C.multiplyInPlace(i.rotationQuaternion)):(_=h.x*parseFloat(i.scaling.x.toFixed(4)),S=h.y*parseFloat(i.scaling.y.toFixed(4)),B=h.z*parseFloat(i.scaling.z.toFixed(4)),b.set(_,S,B)),p.shape=z,p.translation=b,p.rotation=C,p.scale=A,d.push(p)}else if(r==e.RigidbodyPhysics.SphereImpostor){var W=null!=o.sphereradius?o.sphereradius:.5,Q=parseFloat(i.scaling.x.toFixed(4)),X=parseFloat(i.scaling.y.toFixed(4)),K=parseFloat(i.scaling.z.toFixed(4)),j=Math.max(Q,X,K)*W;if(!0===m){var Z=parseFloat(n.scaling.x.toFixed(4)),J=parseFloat(n.scaling.y.toFixed(4)),q=parseFloat(n.scaling.z.toFixed(4));j*=Math.max(Z,J,q)}A.set(j,j,j);var $=e.RigidbodyPhysics.GetCachedPhysicsSphereShape(t,f,a,l,s,u,c,y,v);!0===m?(0===h.x&&0===h.y&&0===h.z||console.warn("WARNING: Center offset not supported for complex compound item: "+i.name),D=i.position.x*parseFloat(n.scaling.x.toFixed(4)),U=i.position.y*parseFloat(n.scaling.y.toFixed(4)),F=i.position.z*parseFloat(n.scaling.z.toFixed(4)),b.set(D,U,F),C.multiplyInPlace(i.rotationQuaternion)):(_=h.x*parseFloat(i.scaling.x.toFixed(4)),S=h.y*parseFloat(i.scaling.y.toFixed(4)),B=h.z*parseFloat(i.scaling.z.toFixed(4)),b.set(_,S,B)),p.shape=$,p.translation=b,p.rotation=C,p.scale=A,d.push(p)}else if(r==e.RigidbodyPhysics.BoxImpostor){var ee=null!=o.boxsize?o.boxsize:{x:1,y:1,z:1},te=ee.x*parseFloat(i.scaling.x.toFixed(4)),ne=ee.y*parseFloat(i.scaling.y.toFixed(4)),ie=ee.z*parseFloat(i.scaling.z.toFixed(4));!0===m&&(te*=parseFloat(n.scaling.x.toFixed(4)),ne*=parseFloat(n.scaling.y.toFixed(4)),ie*=parseFloat(n.scaling.z.toFixed(4))),A.set(te,ne,ie);var oe=e.RigidbodyPhysics.GetCachedPhysicsBoxShape(t,f,a,l,s,u,c,y,v);!0===m?(0===h.x&&0===h.y&&0===h.z||console.warn("WARNING: Center offset not supported for complex compound item: "+i.name),D=i.position.x*parseFloat(n.scaling.x.toFixed(4)),U=i.position.y*parseFloat(n.scaling.y.toFixed(4)),F=i.position.z*parseFloat(n.scaling.z.toFixed(4)),b.set(D,U,F),C.multiplyInPlace(i.rotationQuaternion)):(_=h.x*parseFloat(i.scaling.x.toFixed(4)),S=h.y*parseFloat(i.scaling.y.toFixed(4)),B=h.z*parseFloat(i.scaling.z.toFixed(4)),b.set(_,S,B)),p.shape=oe,p.translation=b,p.rotation=C,p.scale=A,d.push(p)}},n.CreateHeightFieldTerrainShapeFromMesh=function(t,n,i){var o=e.RigidbodyPhysics.GetHavokInstance();if(!o)return BABYLON.Tools.Warn("Havok.js physics library not loaded"),null;var r=t.getVerticesData(BABYLON.VertexBuffer.PositionKind),a=r.length/3,l=o._malloc(4*a),s=Math.sqrt(a),u=s;if(s%1!=0)return console.error("Terrain mesh does not seem to be a regular square grid: "+t.name),null;for(var c=0,d=u-1;d>=0;d--)for(var p=0;p<s;p++){var h=d*s+p;o.HEAPF32[l+c>>2]=r[3*h+1],c+=4}var m=o.HP_Shape_CreateHeightField(s,u,[n,1,i],l)[1];return o._free(l),m},n.GetPhysicsHeapSize=function(){var t=e.RigidbodyPhysics.GetHavokInstance();if(!t)return BABYLON.Tools.Warn("Havok.js physics library not loaded"),0;var n=0;return t.HEAP8&&t.HEAP8.length&&(n=t.HEAP8.length/1048576),n},n.ConfigRigidbodyPhysics=function(e,t,n,i,o,r,a){if(null!=t&&null!=t.physicsBody){!1===(null==o||null==o.gravity||o.gravity)&&t.physicsBody.setGravityFactor(0);var l=null!=o&&null!=o.ldrag?o.ldrag:0,s=null!=o&&null!=o.adrag?o.adrag:.05;t.physicsBody.setLinearDamping(l),t.physicsBody.setAngularDamping(s);var u=null!=o&&null!=o.freeze?o.freeze:null,c=1,d=1,p=1;null!=u&&(null!=u.positionx&&u.positionx,null!=u.positiony&&u.positiony,null!=u.positionz&&u.positionz,c=null!=u.rotationx&&!0===u.rotationx?0:1,d=null!=u.rotationy&&!0===u.rotationy?0:1,p=null!=u.rotationz&&!0===u.rotationz?0:1),t.physicsBody.setMassProperties({mass:r,centerOfMass:a,inertia:new BABYLON.Vector3(c,d,p)})}},n.CreatePhysicsMetadata=function(e,t,n,i){void 0===t&&(t=0),void 0===n&&(n=.05),void 0===i&&(i=null);var o=null!=i?i:new BABYLON.Vector3(0,0,0);return{type:"rigidbody",mass:e,ldrag:t,adrag:n,center:{x:o.x,y:o.y,z:o.z}}},n.CreateCollisionMetadata=function(e,t,n,i,o,r){return void 0===t&&(t=!1),void 0===n&&(n=!1),void 0===i&&(i=0),void 0===o&&(o=.6),void 0===r&&(r=.6),{type:e,trigger:t,convexmesh:n,restitution:i,dynamicfriction:o,staticfriction:r,wheelinformation:null}},n.CreatePhysicsProperties=function(e,t,n,i,o){return void 0===t&&(t=0),void 0===n&&(n=.05),void 0===i&&(i=!0),void 0===o&&(o=!1),{mass:e,drag:t,angularDrag:n,useGravity:i,isKinematic:o}},n.AddChildShapeFromParent=function(t,n,i,o){var r,a=o.computeWorldMatrix(!0),l=n.computeWorldMatrix(!0),s=BABYLON.TmpVectors.Matrix[0];a.multiplyToRef(BABYLON.Matrix.Invert(l),s);var u=BABYLON.TmpVectors.Vector3[0],c=BABYLON.TmpVectors.Quaternion[0],d=BABYLON.TmpVectors.Vector3[1];s.decompose(d,c,u);var p=new BABYLON.Vector3(d.x,d.y,d.z);if(o instanceof BABYLON.InstancedMesh){var h=o.sourceMesh;if(null!=h){var m=null!=o.metadata&&null!=o.metadata.toolkit&&null!=o.metadata.toolkit.collision&&null!=o.metadata.toolkit.collision.sourcescale?o.metadata.toolkit.collision.sourcescale:null,f=null!=h.metadata&&null!=h.metadata.toolkit&&null!=h.metadata.toolkit.collision&&null!=h.metadata.toolkit.collision.sourcescale?h.metadata.toolkit.collision.sourcescale:null;if(null!=f&&null!=m){var g=new BABYLON.Vector3(1,1,1),y=new BABYLON.Vector3(m.x,m.y,m.z),v=new BABYLON.Vector3(f.x,f.y,f.z);y.divideToRef(v,g),p.multiplyInPlace(g)}}}null===(r=e.Utilities.GetHavokPlugin())||void 0===r||r.addChild(t,i,u,c,p)},n.PHYSICS_STEP_TIME=.016,n.RaycastResult=null,n.LocalShapeResult=null,n.WorldShapeResult=null,n.RaycastDestination=null,n.PhysicsShapeCache={},n.NewPhysicsShapeCount=0,n.CachedPhysicsShapeCount=0,n.DebugPhysicsViewer=null,n.OnSetupPhysicsPlugin=null,n.NoImpostor=0,n.SphereImpostor=1,n.BoxImpostor=2,n.PlaneImpostor=3,n.MeshImpostor=4,n.CapsuleImpostor=6,n.CylinderImpostor=7,n.ParticleImpostor=8,n.HeightmapImpostor=9,n.ConvexHullImpostor=10,n.CustomImpostor=100,n.RopeImpostor=101,n.ClothImpostor=102,n.SoftbodyImpostor=103,n}(e.ScriptComponent);e.RigidbodyPhysics=t;e.PhyscisContainerData=function(){},e.SceneManager.RegisterClass("TOOLKIT.RigidbodyPhysics",t)}(i||(i={})),function(e){var t=function(t){function n(e,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.ShurikenParticles");var r=t.call(this,e,n,i,o)||this;return r.m_particleSystem=null,r.m_emitterMesh=null,r.m_systemProperties=null,r.m_isInitialized=!1,r.m_playOnAwake=!0,r.m_autoStart=!0,r.m_systemTime=0,r.m_isLooping=!0,r.m_duration=5,r.m_emissionTimer=0,r.m_burstTimers=[],r.m_prewarm=!1,r.m_startDelay=null,r.m_simulationSpeed=1,r.m_scalingMode=0,r.m_emitterVelocityMode=0,r.m_customSimulationSpace=0,r.m_emitterVelocity=new BABYLON.Vector3(0,0,0),r.m_gravitySource=0,r.m_useUnscaledTime=!1,r.m_reportedDeltaTime=0,r.m_isSystemRunning=!1,r.m_cullingMode=0,r.m_isVisible=!0,r.m_pausedTime=0,r.m_lastVisibilityCheck=0,r.m_animationCurves=new Map,r.m_gradients=new Map,r}return o(n,t),n.prototype.getParticleSystem=function(){return this.m_particleSystem},n.prototype.getEmitterMesh=function(){return this.m_emitterMesh},n.prototype.internalPlay=function(){var e=this;if(this.m_particleSystem){if(this.m_prewarm&&this.m_isLooping&&this.m_duration>0)if(this.m_systemTime=this.m_duration,this.m_emissionTimer=this.m_duration,this.m_particleSystem instanceof BABYLON.ParticleSystem){var t=this.m_particleSystem.emitRate,n=Math.min(Math.ceil(t*this.m_duration),this.m_particleSystem.getCapacity());this.m_particleSystem.emitRate=60*n,this.m_particleSystem.start(),setTimeout(function(){e.m_particleSystem instanceof BABYLON.ParticleSystem&&(e.m_particleSystem.emitRate=t)},16)}else this.m_particleSystem.start();else this.m_systemTime=0,this.m_emissionTimer=0,this.m_particleSystem.start();this.m_isSystemRunning=!0,this.resetBurstTimers()}},n.prototype.play=function(){var t=this,n=this.calculateStartDelay();n>0?(this.m_systemTime=0,this.m_emissionTimer=0,this.m_isSystemRunning=!1,e.WindowManager.SetTimeout(1e3*n,function(){t.internalPlay()})):(this.m_systemTime=0,this.m_emissionTimer=0,this.internalPlay())},n.prototype.stop=function(){this.m_particleSystem&&(this.m_particleSystem.stop(),this.m_isSystemRunning=!1)},n.prototype.pause=function(){var e,t;this.m_particleSystem&&(this.m_particleSystem instanceof BABYLON.ParticleSystem?this.m_particleSystem.stop():null===(t=(e=this.m_particleSystem).pause)||void 0===t||t.call(e),this.m_isSystemRunning=!1)},n.prototype.reset=function(){this.m_particleSystem&&(this.m_particleSystem.reset(),this.m_systemTime=0,this.m_emissionTimer=0,this.resetBurstTimers(),this.m_isSystemRunning=!1)},n.prototype.isPlaying=function(){return this.m_isSystemRunning&&this.m_isInitialized},n.prototype.getParticleCount=function(){return this.m_particleSystem?this.m_particleSystem.getActiveCount():0},n.prototype.getCustomSimulationSpace=function(){return this.m_customSimulationSpace},n.prototype.getEmitterVelocity=function(){return this.m_emitterVelocity.clone()},n.prototype.getGravitySource=function(){return this.m_gravitySource},n.prototype.getUseUnscaledTime=function(){return this.m_useUnscaledTime},n.prototype.getCustomDeltaTime=function(){return this.m_reportedDeltaTime},n.prototype.getReportedDeltaTime=function(){return this.m_reportedDeltaTime},n.prototype.getEffectiveDeltaTime=function(){return(this.m_useUnscaledTime?this.scene.getEngine().getDeltaTime()/1e3:this.getDeltaTime())*this.m_simulationSpeed},n.prototype.calculateStartDelay=function(){var e,t,n=0;if(null!=this.m_startDelay){var i=this.convertMinMaxCurve(this.m_startDelay);switch(null!==(e=this.m_startDelay.mode)&&void 0!==e?e:0){case 0:case 1:default:n=i.value;break;case 2:case 3:n=Math.random()*(i.max-i.min)+i.min}void 0!==(null===(t=this.m_systemProperties.main)||void 0===t?void 0:t.startDelayMultiplier)&&(n*=this.m_systemProperties.main.startDelayMultiplier)}return parseFloat(Math.max(0,n).toFixed(2))},n.prototype.awake=function(){this.initializeParticleSystem()},n.prototype.start=function(){this.m_isInitialized&&this.m_autoStart&&this.m_playOnAwake&&this.play()},n.prototype.ready=function(){},n.prototype.update=function(){if(this.m_particleSystem&&this.m_systemProperties&&this.m_isSystemRunning){if(!this.shouldSimulateThisFrame()){if(1===this.m_cullingMode){var e=this.m_useUnscaledTime?this.scene.getEngine().getDeltaTime()/1e3:this.getDeltaTime();this.m_pausedTime+=e}return}var t=(this.m_useUnscaledTime?this.scene.getEngine().getDeltaTime()/1e3:this.getDeltaTime())*this.m_simulationSpeed;this.updateSystem(t),this.updateEmission(t),this.updateAnimationProperties(),this.updateBursts(t),this.updateEmitterVelocityInheritance(t),this.updateCustomSimulationSpace(t),this.updateRingBufferMode(t),!this.m_isLooping&&this.m_duration>0&&this.m_systemTime>=this.m_duration&&this.handleStopAction()}},n.prototype.shouldSimulateThisFrame=function(){switch(this.m_cullingMode){case 0:case 1:case 2:default:return this.m_isVisible;case 3:return!0}},n.prototype.late=function(){},n.prototype.step=function(){},n.prototype.fixed=function(){},n.prototype.after=function(){},n.prototype.destroy=function(){this.disposeParticleSystem()},n.mergeWithDefaults=function(e){return e?n.deepMerge(JSON.parse(JSON.stringify(n.DEFAULT_PARTICLE_PROPERTIES)),e):JSON.parse(JSON.stringify(n.DEFAULT_PARTICLE_PROPERTIES))},n.deepMerge=function(e,t){if(!t||"object"!=typeof t)return e;if(!e||"object"!=typeof e)return t;for(var i in t)t.hasOwnProperty(i)&&(t[i]&&"object"==typeof t[i]&&!Array.isArray(t[i])?e[i]=n.deepMerge(e[i]||{},t[i]):e[i]=t[i]);return e},n.getPropertyWithDefault=function(e,t){for(var i=e.split("."),o=t,r=n.DEFAULT_PARTICLE_PROPERTIES,a=0,l=i;a<l.length;a++){var s=l[a];o=null==o?void 0:o[s],r=null==r?void 0:r[s]}return void 0!==o?o:r},n.getMinimalSerializationData=function(e){if(!e)return{};var t=n.DEFAULT_PARTICLE_PROPERTIES;return n.extractDifferences(e,t)},n.extractDifferences=function(e,t){if(!e||"object"!=typeof e)return e;if(!t||"object"!=typeof t)return e;var i={};for(var o in e)if(e.hasOwnProperty(o)){var r=e[o],a=t[o];if(void 0!==r)if(Array.isArray(r))Array.isArray(a)&&r.length===a.length&&n.arraysEqual(r,a)||(i[o]=r);else if(r&&"object"==typeof r){var l=n.extractDifferences(r,a);Object.keys(l).length>0&&(i[o]=l)}else r!==a&&(i[o]=r)}return i},n.arraysEqual=function(e,t){if(e.length!==t.length)return!1;for(var i=0;i<e.length;i++){var o=e[i],r=t[i];if(Array.isArray(o)&&Array.isArray(r)){if(!n.arraysEqual(o,r))return!1}else if(o&&"object"==typeof o&&r&&"object"==typeof r){var a=n.extractDifferences(o,r);if(Object.keys(a).length>0)return!1}else if(o!==r)return!1}return!0},n.getDefaultProperties=function(){return JSON.parse(JSON.stringify(n.DEFAULT_PARTICLE_PROPERTIES))},n.prototype.initializeParticleSystem=function(){try{var e=this._properties;if(this.m_systemProperties=n.mergeWithDefaults(e),!this.m_systemProperties)return void BABYLON.Tools.Warn("ShurikenParticles: Failed to create merged particle system properties");if(!this.m_systemProperties.main)return void BABYLON.Tools.Warn("### ShurikenParticles: No main module found in merged properties");this.createEmitterMesh(),this.shouldUseGPUParticles()?this.createGPUParticleSystem():this.createCPUParticleSystem(),this.configureMainModule(),this.configureEmissionModule(),this.configureShapeModule(),this.configureRendererModule(),this.configureVelocityOverLifetimeModule(),this.configureLimitVelocityOverLifetimeModule(),this.configureColorOverLifetimeModule(),this.configureSizeOverLifetimeModule(),this.configureRotationOverLifetimeModule(),this.configureTextureSheetAnimationModule(),this.configureNoiseModule(),this.configureCollisionModule(),this.configureTrailsModule(),this.configureSubEmittersModule(),this.ensureBasicConfiguration(),this.m_isInitialized=!0}catch(e){BABYLON.Tools.Error("ShurikenParticles: Failed to initialize particle system: "+e)}},n.prototype.shouldUseGPUParticles=function(){var e,t,n,i,o,r,a=null!==(t=null===(e=this.m_systemProperties.main)||void 0===e?void 0:e.maxParticles)&&void 0!==t?t:1e3,l=(null===(n=this.m_systemProperties.noise)||void 0===n?void 0:n.enabled)||(null===(i=this.m_systemProperties.collision)||void 0===i?void 0:i.enabled)||(null===(o=this.m_systemProperties.trails)||void 0===o?void 0:o.enabled)||(null===(r=this.m_systemProperties.subEmitters)||void 0===r?void 0:r.enabled);return a>5e3&&!l},n.prototype.createEmitterMesh=function(){this.m_emitterMesh=BABYLON.MeshBuilder.CreateBox(this.transform.name+"_ParticleProxy",{size:.1},this.scene);var e=null!=n.EMITTER_POSITION_OFFSET?n.EMITTER_POSITION_OFFSET:new BABYLON.Vector3(0,0,0),t=null!=n.EMITTER_ROTATION_OFFSET?n.EMITTER_ROTATION_OFFSET:new BABYLON.Vector3(0,0,0);this.m_emitterMesh.parent=this.transform,this.m_emitterMesh.position.copyFrom(e),this.m_systemProperties.shape,t.set(90,0,0),this.m_emitterMesh.rotationQuaternion=BABYLON.Quaternion.FromEulerAngles(BABYLON.Tools.ToRadians(t.x),BABYLON.Tools.ToRadians(t.y),BABYLON.Tools.ToRadians(t.z)),this.m_emitterMesh.isVisible=!1,this.m_emitterMesh.isPickable=!1},n.prototype.createDefaultParticleTexture=function(){if(null!=e.ShurikenParticles.DefaultParticleTexture)return e.ShurikenParticles.DefaultParticleTexture;var t=64,n=document.createElement("canvas");n.width=t,n.height=t;var i=n.getContext("2d");i.clearRect(0,0,t,t);var o=i.createRadialGradient(32,32,0,32,32,32);o.addColorStop(0,"rgba(255, 255, 255, 1.0)"),o.addColorStop(.15,"rgba(255, 255, 255, 0.95)"),o.addColorStop(.3,"rgba(255, 255, 255, 0.7)"),o.addColorStop(.6,"rgba(255, 255, 255, 0.2)"),o.addColorStop(.85,"rgba(255, 255, 255, 0.05)"),o.addColorStop(1,"rgba(255, 255, 255, 0.0)"),i.fillStyle=o,i.fillRect(0,0,t,t);var r=n.toDataURL("image/png"),a=new BABYLON.Texture(r,this.scene);return a.name=this.transform.name+"_DefaultParticleTexture",a.hasAlpha=!0,a.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,a.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE,e.ShurikenParticles.DefaultParticleTexture=a,e.ShurikenParticles.DefaultParticleTexture},n.prototype.createCPUParticleSystem=function(){var e,t,n=null!==(t=null===(e=this.m_systemProperties.main)||void 0===e?void 0:e.maxParticles)&&void 0!==t?t:1e3;this.m_particleSystem=new BABYLON.ParticleSystem(this.transform.name+"_ParticleSystem",n,this.scene),this.m_particleSystem.emitter=this.m_emitterMesh,this.m_particleSystem.particleTexture||(this.m_particleSystem.particleTexture=this.createDefaultParticleTexture()),this.m_particleSystem.blendMode=BABYLON.ParticleSystem.BLENDMODE_STANDARD,this.m_particleSystem.particleTexture&&(this.m_particleSystem.particleTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,this.m_particleSystem.particleTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE),this.m_particleSystem.color1=new BABYLON.Color4(1,1,1,1),this.m_particleSystem.color2=new BABYLON.Color4(1,1,1,1),this.m_particleSystem.colorDead=new BABYLON.Color4(1,1,1,0),this.m_particleSystem.minSize=1,this.m_particleSystem.maxSize=1,this.m_particleSystem.minInitialRotation=0,this.m_particleSystem.maxInitialRotation=0,this.m_particleSystem.minAngularSpeed=0,this.m_particleSystem.maxAngularSpeed=0},n.prototype.createGPUParticleSystem=function(){var e,t,n=null!==(t=null===(e=this.m_systemProperties.main)||void 0===e?void 0:e.maxParticles)&&void 0!==t?t:1e3;this.m_particleSystem=new BABYLON.GPUParticleSystem(this.transform.name+"_GPUParticleSystem",{capacity:n},this.scene),this.m_particleSystem.emitter=this.m_emitterMesh,this.m_particleSystem.particleTexture||(this.m_particleSystem.particleTexture=this.createDefaultParticleTexture()),this.m_particleSystem.blendMode=BABYLON.GPUParticleSystem.BLENDMODE_STANDARD,this.m_particleSystem.particleTexture&&(this.m_particleSystem.particleTexture.wrapU=BABYLON.Texture.CLAMP_ADDRESSMODE,this.m_particleSystem.particleTexture.wrapV=BABYLON.Texture.CLAMP_ADDRESSMODE),this.m_particleSystem.color1=new BABYLON.Color4(1,1,1,1),this.m_particleSystem.color2=new BABYLON.Color4(1,1,1,1),this.m_particleSystem.colorDead=new BABYLON.Color4(1,1,1,0),this.m_particleSystem.minSize=.25,this.m_particleSystem.maxSize=.25,this.m_particleSystem.minInitialRotation=0,this.m_particleSystem.maxInitialRotation=0,this.m_particleSystem.minAngularSpeed=0,this.m_particleSystem.maxAngularSpeed=0},n.prototype.configureMainModule=function(){var e,t,i,o,r,a,l,s,u,c,d,p,h,m,f,g,y,v,_,S,B,b;if(this.m_systemProperties.main&&this.m_particleSystem){var C=this.m_systemProperties.main;if(void 0!==C.loop&&(this.m_isLooping=C.loop),void 0!==C.duration&&(this.m_duration=C.duration),this.m_isLooping&&(this.m_duration=0),C.prewarm&&C.loop?this.m_prewarm=!0:this.m_prewarm=!1,C.startDelay?this.m_startDelay=C.startDelay:this.m_startDelay=null,void 0!==C.playOnAwake&&(this.m_playOnAwake=C.playOnAwake,this.m_autoStart=C.playOnAwake),C.maxParticles,void 0!==C.scalingMode){var A=C.scalingMode;this.m_scalingMode=A}if(void 0!==C.emitterVelocityMode){var M=C.emitterVelocityMode;this.m_emitterVelocityMode=M}if(void 0!==C.emitterVelocity){var T=C.emitterVelocity;this.m_emitterVelocity.set(T.x||0,T.y||0,T.z||0),this.m_emitterVelocity.length()}if(void 0!==C.customSimulationSpace){var O=C.customSimulationSpace;this.m_customSimulationSpace=O}if(void 0!==C.stopAction&&C.stopAction,void 0!==C.ringBufferMode)C.ringBufferMode>0&&C.ringBufferLoopRange&&C.ringBufferLoopRange;var I=this.convertMinMaxGradient(C.startColor),L=null!==(t=null===(e=C.startColor)||void 0===e?void 0:e.mode)&&void 0!==t?t:0,x=(null===(i=C.startColor)||void 0===i?void 0:i.color)||{r:1,g:1,b:1,a:1};0===L?(this.m_particleSystem.color1=new BABYLON.Color4(x.r,x.g,x.b,x.a),this.m_particleSystem.color2=new BABYLON.Color4(x.r,x.g,x.b,x.a),this.m_particleSystem.colorDead=new BABYLON.Color4(x.r,x.g,x.b,n.UNITY_TO_BABYLON_DEATH_FADE_ALPHA)):(this.m_particleSystem.color1=I.colorMin,this.m_particleSystem.color2=I.colorMax,this.m_particleSystem.colorDead=new BABYLON.Color4(I.colorMin.r,I.colorMin.g,I.colorMin.b,n.UNITY_TO_BABYLON_DEATH_FADE_ALPHA));var N=this.convertMinMaxCurve(C.startLifetime);0===(null!==(r=null===(o=C.startLifetime)||void 0===o?void 0:o.mode)&&void 0!==r?r:0)?(this.m_particleSystem.minLifeTime=N.value*n.UNITY_TO_BABYLON_LIFETIME_RATIO,this.m_particleSystem.maxLifeTime=N.value*n.UNITY_TO_BABYLON_LIFETIME_RATIO):(this.m_particleSystem.minLifeTime=N.min*n.UNITY_TO_BABYLON_LIFETIME_RATIO,this.m_particleSystem.maxLifeTime=N.max*n.UNITY_TO_BABYLON_LIFETIME_RATIO);var w=this.convertMinMaxCurve(C.startSpeed),P=null!==(l=null===(a=C.startSpeed)||void 0===a?void 0:a.mode)&&void 0!==l?l:0;if(0===w.min&&0===w.max?(this.m_particleSystem.minEmitPower=0,this.m_particleSystem.maxEmitPower=0):0===P?(this.m_particleSystem.minEmitPower=w.value*n.UNITY_TO_BABYLON_EMIT_POWER_RATIO,this.m_particleSystem.maxEmitPower=w.value*n.UNITY_TO_BABYLON_EMIT_POWER_RATIO):(this.m_particleSystem.minEmitPower=w.min*n.UNITY_TO_BABYLON_EMIT_POWER_RATIO,this.m_particleSystem.maxEmitPower=w.max*n.UNITY_TO_BABYLON_EMIT_POWER_RATIO),C.startSize3D){var R=this.convertMinMaxCurve(C.startSizeX),k=this.convertMinMaxCurve(C.startSizeY),E=this.convertMinMaxCurve(C.startSizeZ),D=null!==(u=null===(s=C.startSizeX)||void 0===s?void 0:s.mode)&&void 0!==u?u:0,U=null!==(d=null===(c=C.startSizeY)||void 0===c?void 0:c.mode)&&void 0!==d?d:0,F=null!==(h=null===(p=C.startSizeZ)||void 0===p?void 0:p.mode)&&void 0!==h?h:0,Y=void 0,V=void 0;0===D&&0===U&&0===F?V=Y=Math.max(R.value,k.value,E.value):(Y=Math.max(R.min,k.min,E.min),V=Math.max(R.max,k.max,E.max)),this.m_particleSystem.minSize=Y*n.UNITY_TO_BABYLON_SIZE_RATIO,this.m_particleSystem.maxSize=V*n.UNITY_TO_BABYLON_SIZE_RATIO}else{var G=this.convertMinMaxCurve(C.startSize);0===(null!==(f=null===(m=C.startSize)||void 0===m?void 0:m.mode)&&void 0!==f?f:0)?(this.m_particleSystem.minSize=G.value*n.UNITY_TO_BABYLON_SIZE_RATIO,this.m_particleSystem.maxSize=G.value*n.UNITY_TO_BABYLON_SIZE_RATIO):(this.m_particleSystem.minSize=G.min*n.UNITY_TO_BABYLON_SIZE_RATIO,this.m_particleSystem.maxSize=G.max*n.UNITY_TO_BABYLON_SIZE_RATIO)}if(C.startRotation3D){this.convertMinMaxCurve(C.startRotationX),this.convertMinMaxCurve(C.startRotationY);var H=this.convertMinMaxCurve(C.startRotationZ),z=(null===(g=C.startRotationX)||void 0===g?void 0:g.mode,void(null===(y=C.startRotationY)||void 0===y?void 0:y.mode)),W=void 0;0===(null!==(_=null===(v=C.startRotationZ)||void 0===v?void 0:v.mode)&&void 0!==_?_:0)?(z=H.value,W=H.value):(z=H.min,W=H.max),this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.minInitialRotation=z,this.m_particleSystem.maxInitialRotation=W)}else{var Q=this.convertMinMaxCurve(C.startRotation);0===(null!==(B=null===(S=C.startRotation)||void 0===S?void 0:S.mode)&&void 0!==B?B:0)?this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.minInitialRotation=Q.value,this.m_particleSystem.maxInitialRotation=Q.value):this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.minInitialRotation=Q.min,this.m_particleSystem.maxInitialRotation=Q.max)}if(C.flipRotation&&C.flipRotation>0){if(this.m_particleSystem instanceof BABYLON.ParticleSystem){var X=this.m_particleSystem.minAngularSpeed||0,K=this.m_particleSystem.maxAngularSpeed||0,j=Math.max(Math.abs(X),Math.abs(K));this.m_particleSystem.minAngularSpeed=-j*C.flipRotation,this.m_particleSystem.maxAngularSpeed=j*C.flipRotation}}else this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.minAngularSpeed=0,this.m_particleSystem.maxAngularSpeed=0);if(void 0!==C.cullingMode){var Z=C.cullingMode;this.m_cullingMode=Z,3!==Z?this.setupCullingVisibilityCheck():this.m_isVisible=!0}var J,q=this.convertMinMaxCurve(C.gravityModifier);if(null===(b=C.gravityModifier)||void 0===b?void 0:b.mode,J=q.value*n.UNITY_TO_BABYLON_GRAVITY_RATIO,this.m_particleSystem.gravity=new BABYLON.Vector3(0,-9.81*J,0),void 0!==C.gravitySource){var $=C.gravitySource;this.m_gravitySource=$}if(void 0!==C.gravitySource&&1===this.m_gravitySource){var ee=this.m_particleSystem.gravity;this.m_particleSystem.gravity=new BABYLON.Vector3(0,ee.y,0)}this.m_particleSystem.worldOffset=BABYLON.Vector3.Zero(),1===C.simulationSpace?this.m_particleSystem.emitter=this.m_emitterMesh.getAbsolutePosition().clone():this.m_particleSystem.emitter=this.m_emitterMesh;var te=C.simulationSpeed||1;if(this.m_simulationSpeed=1!==te?te:1,void 0!==C.useUnscaledTime){var ne=C.useUnscaledTime;this.m_useUnscaledTime=ne}void 0!==C.deltaTime?this.m_reportedDeltaTime=C.deltaTime:this.m_reportedDeltaTime=0}},n.prototype.configureEmissionModule=function(){var e,t;if(this.m_systemProperties.emission&&this.m_particleSystem){var i=this.m_systemProperties.emission;if(i.enabled){if(i.rateOverTime){var o=this.convertMinMaxCurve(i.rateOverTime),r=(null===(e=i.rateOverTime)||void 0===e?void 0:e.mode,o.value*n.UNITY_TO_BABYLON_EMIT_RATE_RATIO);this.m_particleSystem.emitRate=r}else this.m_particleSystem.emitRate=0;if(i.rateOverDistance){var a=this.convertMinMaxCurve(i.rateOverDistance);null===(t=i.rateOverDistance)||void 0===t?void 0:t.mode,a.value,void 0!==i.rateOverDistanceMultiplier&&i.rateOverDistanceMultiplier}if(i.bursts&&i.bursts.length>0){var l=i.bursts.filter(function(e){return e&&"number"==typeof e.time&&void 0!==e.count});l.length>0&&(this.setupBursts(l),void 0!==i.burstCount&&(i.burstCount,l.length))}else i.burstCount&&i.burstCount}else this.m_particleSystem.emitRate=0;i.enabled&&this.m_particleSystem.emitRate>0&&this.m_particleSystem.emitRate<.1&&(this.m_particleSystem.emitRate=.1)}},n.prototype.configureShapeModule=function(){var e;if(this.m_systemProperties.shape&&this.m_particleSystem){var t=this.m_systemProperties.shape;if(t.enabled)this.configureEmissionShape(t);else if(this.m_particleSystem instanceof BABYLON.ParticleSystem){var i=this.m_systemProperties.shape,o=null!==(e=null==i?void 0:i.radius)&&void 0!==e?e:n.DEFAULT_PARTICLE_PROPERTIES.shape.radius;this.createSphereShapeEmitter(o,0,0)}}},n.prototype.configureRendererModule=function(){var e,t;if(this.m_systemProperties.renderer&&this.m_particleSystem){var n=this.m_systemProperties.renderer;if(void 0!==n.renderMode)switch(n.renderMode){case 0:break;case 1:void 0!==n.lengthScale&&n.lengthScale>0&&this.implementStretchRendering(n.lengthScale,n.velocityScale,n.freeformStretching);break;case 2:this.implementConstrainedBillboarding("horizontal");break;case 3:this.implementConstrainedBillboarding("vertical");break;case 4:this.implementMeshRendering(n);break;case 5:this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.renderingGroupId=-1)}if(void 0!==n.minParticleSize||void 0!==n.maxParticleSize){var i=null!==(e=n.minParticleSize)&&void 0!==e?e:0,o=null!==(t=n.maxParticleSize)&&void 0!==t?t:.5;this.m_particleSystem.minSize<i&&(this.m_particleSystem.minSize=i),this.m_particleSystem.maxSize>o&&(this.m_particleSystem.maxSize=o)}void 0!==n.sortMode&&this.implementParticleSorting(n.sortMode,n.sortingFudge),void 0!==n.alignment&&this.implementParticleAlignment(n.alignment),!n.flip||0===n.flip.x&&0===n.flip.y||this.implementParticleFlipping(n.flip),!n.pivot||0===n.pivot.x&&0===n.pivot.y&&0===n.pivot.z||this.implementParticlePivot(n.pivot),void 0!==n.allowRoll&&this.implementParticleRoll(n.allowRoll),void 0!==n.velocityScale&&n.velocityScale>0&&this.implementVelocityScaling(n.velocityScale,n.cameraVelocityScale),void 0!==n.normalDirection&&this.implementNormalDirection(n.normalDirection),void 0!==n.freeformStretching&&this.implementFreeformStretching(n.freeformStretching),void 0!==n.maskInteraction&&n.maskInteraction>0&&this.implementMaskInteraction(n.maskInteraction),void 0!==n.rotateWithStretchDirection&&this.implementStretchRotation(n.rotateWithStretchDirection),void 0!==n.shadowBias&&0!==n.shadowBias&&this.implementShadowBias(n.shadowBias),void 0!==n.meshCount&&n.meshCount>1&&n.meshes&&this.implementMultiMeshRendering(n.meshes,n.meshDistribution),void 0!==n.activeVertexStreamsCount&&n.activeVertexStreamsCount>0&&this.implementCustomVertexStreams(n.activeVertexStreamsCount),n.trailMaterial&&this.implementTrailMaterial(n.trailMaterial),n.materials&&n.materials.length>0&&this.implementMaterialConfiguration(n.materials),void 0===n.shadowCastingMode&&void 0===n.receiveShadows||this.implementShadowConfiguration(n.shadowCastingMode,n.receiveShadows),void 0===n.lightProbeUsage&&void 0===n.reflectionProbeUsage||this.implementProbeConfiguration(n.lightProbeUsage,n.reflectionProbeUsage),void 0===n.enableGPUInstancing&&void 0===n.supportsMeshInstancing||this.implementGPUInstancing(n.enableGPUInstancing,n.supportsMeshInstancing),void 0===n.sortingLayerID&&void 0===n.sortingOrder||this.implementSortingLayer(n.sortingLayerID,n.sortingOrder)}},n.prototype.implementStretchRendering=function(e,t,n){this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.stretchSettings={lengthScale:e,velocityScale:null!=t?t:1,freeform:null!=n&&n})},n.prototype.implementConstrainedBillboarding=function(e){this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.billboardConstraint=e)},n.prototype.implementMeshRendering=function(e){e.mesh&&(this.m_particleSystem,BABYLON.GPUParticleSystem)},n.prototype.implementParticleSorting=function(e,t){switch(e){case 1:this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.blendMode=BABYLON.ParticleSystem.BLENDMODE_ONEONE);break;case 2:case 3:this.m_particleSystem.customSortMode=e,void 0!==t&&(this.m_particleSystem.sortingFudge=t)}},n.prototype.implementParticleAlignment=function(e){switch(e){case 1:this.m_particleSystem.worldAlignment=!0;break;case 2:this.m_particleSystem.localAlignment=!0;break;case 3:case 4:this.m_particleSystem.velocityAlignment=!0}},n.prototype.implementParticleFlipping=function(e){this.m_particleSystem.flipSettings={x:e.x,y:e.y}},n.prototype.implementParticlePivot=function(e){this.m_particleSystem.pivotOffset=new BABYLON.Vector3(e.x,e.y,e.z)},n.prototype.implementParticleRoll=function(e){this.m_particleSystem.allowRoll=e},n.prototype.implementVelocityScaling=function(e,t){this.m_particleSystem.velocityScaling={scale:e,cameraScale:null!=t?t:1}},n.prototype.implementNormalDirection=function(e){this.m_particleSystem.normalDirection=e},n.prototype.implementFreeformStretching=function(e){this.m_particleSystem.freeformStretching=e},n.prototype.implementMaskInteraction=function(e){switch(e){case 1:this.m_particleSystem.maskMode="inside";break;case 2:this.m_particleSystem.maskMode="outside"}},n.prototype.implementStretchRotation=function(e){this.m_particleSystem.rotateWithStretch=e},n.prototype.implementShadowBias=function(e){this.m_particleSystem.shadowBias=e},n.prototype.implementMultiMeshRendering=function(e,t){this.m_particleSystem.multiMeshSettings={meshes:e,distribution:t}},n.prototype.implementCustomVertexStreams=function(e){this.m_particleSystem.customVertexStreams=e},n.prototype.implementTrailMaterial=function(e){this.m_particleSystem.trailMaterial=e},n.prototype.implementMaterialConfiguration=function(e){if(e.length>0){var t=e[0];t&&t.name,e.length>1&&(this.m_particleSystem.additionalMaterials=e.slice(1))}},n.prototype.implementShadowConfiguration=function(e,t){void 0!==e&&(this.m_particleSystem.shadowCastingMode=e),void 0!==t&&(this.m_particleSystem.receiveShadows=t)},n.prototype.implementProbeConfiguration=function(e,t){void 0!==e&&(this.m_particleSystem.lightProbeUsage=e),void 0!==t&&(this.m_particleSystem.reflectionProbeUsage=t)},n.prototype.implementGPUInstancing=function(e,t){void 0!==e&&(this.m_particleSystem.gpuInstancesEnabled=e),void 0!==t&&(this.m_particleSystem.meshInstancingSupported=t)},n.prototype.implementSortingLayer=function(e,t){void 0!==e&&(this.m_particleSystem.sortingLayerID=e),void 0!==t&&(this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.renderingGroupId=Math.max(0,Math.min(3,t))),this.m_particleSystem.sortingOrder=t)},n.prototype.configureVelocityOverLifetimeModule=function(){var e,t,n,i,o,r,a,l,s,u,c;if(this.m_systemProperties.velocityOverLifetime&&this.m_particleSystem){var d=this.m_systemProperties.velocityOverLifetime;d.enabled&&(this.convertMinMaxCurve(d.x),this.convertMinMaxCurve(d.y),this.convertMinMaxCurve(d.z),null===(e=d.x)||void 0===e?void 0:e.mode,null===(t=d.y)||void 0===t?void 0:t.mode,null===(n=d.z)||void 0===n?void 0:n.mode,(d.orbitalX||d.orbitalY||d.orbitalZ)&&(this.convertMinMaxCurve(d.orbitalX),this.convertMinMaxCurve(d.orbitalY),this.convertMinMaxCurve(d.orbitalZ),null===(i=d.orbitalX)||void 0===i?void 0:i.mode,null===(o=d.orbitalY)||void 0===o?void 0:o.mode,null===(r=d.orbitalZ)||void 0===r?void 0:r.mode),(d.orbitalOffsetX||d.orbitalOffsetY||d.orbitalOffsetZ)&&(this.convertMinMaxCurve(d.orbitalOffsetX),this.convertMinMaxCurve(d.orbitalOffsetY),this.convertMinMaxCurve(d.orbitalOffsetZ),null===(a=d.orbitalOffsetX)||void 0===a?void 0:a.mode,null===(l=d.orbitalOffsetY)||void 0===l?void 0:l.mode,null===(s=d.orbitalOffsetZ)||void 0===s?void 0:s.mode),d.radial&&(this.convertMinMaxCurve(d.radial),null===(u=d.radial)||void 0===u?void 0:u.mode),d.speedModifier&&(this.convertMinMaxCurve(d.speedModifier),null===(c=d.speedModifier)||void 0===c?void 0:c.mode),this.setupVelocityOverLifetime(d))}},n.prototype.configureLimitVelocityOverLifetimeModule=function(){if(this.m_systemProperties.limitVelocityOverLifetime&&this.m_particleSystem){var e=this.m_systemProperties.limitVelocityOverLifetime;e.enabled&&this.setupLimitVelocity(e)}},n.prototype.configureColorOverLifetimeModule=function(){if(this.m_systemProperties.colorOverLifetime&&this.m_particleSystem){var e=this.m_systemProperties.colorOverLifetime;if(e.enabled&&e.color&&this.m_particleSystem instanceof BABYLON.ParticleSystem){var t=this.convertMinMaxGradient(e.color);if(this.m_particleSystem.addColorGradient(0,t.colorMin),this.m_particleSystem.addColorGradient(1,t.colorMax),e.color.gradient&&e.color.gradient.colorKeys){this.m_particleSystem.removeColorGradient(0),this.m_particleSystem.removeColorGradient(1);for(var n=0,i=e.color.gradient.colorKeys;n<i.length;n++){var o=i[n],r=this.convertColor(o.color);this.m_particleSystem.addColorGradient(o.time,r)}if(e.color.gradient.alphaKeys)for(var a=0,l=e.color.gradient.alphaKeys;a<l.length;a++)l[a]}}else e.enabled}},n.prototype.configureSizeOverLifetimeModule=function(){var e,t,n,i,o;if(this.m_systemProperties.sizeOverLifetime&&this.m_particleSystem){var r=this.m_systemProperties.sizeOverLifetime;if(r.enabled&&this.m_particleSystem instanceof BABYLON.ParticleSystem)if(r.separateAxes){var a=this.convertMinMaxCurve(r.x),l=this.convertMinMaxCurve(r.y),s=this.convertMinMaxCurve(r.z),u=(null===(e=r.x)||void 0===e?void 0:e.mode,null===(t=r.y)||void 0===t?void 0:t.mode,null===(n=r.z)||void 0===n?void 0:n.mode,Math.max(a.min,l.min,s.min)),c=Math.max(a.max,l.max,s.max);this.m_particleSystem.addSizeGradient(0,u),this.m_particleSystem.addSizeGradient(1,c)}else{var d=this.convertMinMaxCurve(r.size);u=void 0,c=void 0,0===(null!==(o=null===(i=r.size)||void 0===i?void 0:i.mode)&&void 0!==o?o:0)?(u=d.value,c=d.value):(u=d.min,c=d.max),this.m_particleSystem.addSizeGradient(0,u),this.m_particleSystem.addSizeGradient(1,c)}else r.enabled}},n.prototype.configureRotationOverLifetimeModule=function(){var e,t,n,i,o,r;if(this.m_systemProperties.rotationOverLifetime&&this.m_particleSystem){var a=this.m_systemProperties.rotationOverLifetime;if(a.enabled&&this.m_particleSystem instanceof BABYLON.ParticleSystem)if(a.separateAxes){this.convertMinMaxCurve(a.x),this.convertMinMaxCurve(a.y);var l=this.convertMinMaxCurve(a.z),s=(null===(e=a.x)||void 0===e?void 0:e.mode,void(null===(t=a.y)||void 0===t?void 0:t.mode)),u=void 0;0===(null!==(i=null===(n=a.z)||void 0===n?void 0:n.mode)&&void 0!==i?i:0)?(s=l.value,u=l.value):(s=l.min,u=l.max),this.m_particleSystem.addAngularSpeedGradient(0,s),this.m_particleSystem.addAngularSpeedGradient(1,u)}else{var c=this.convertMinMaxCurve(a.z);s=void 0,u=void 0,0===(null!==(r=null===(o=a.z)||void 0===o?void 0:o.mode)&&void 0!==r?r:0)?(s=c.value,u=c.value):(s=c.min,u=c.max),this.m_particleSystem.addAngularSpeedGradient(0,s),this.m_particleSystem.addAngularSpeedGradient(1,u)}}},n.prototype.configureTextureSheetAnimationModule=function(){if(this.m_systemProperties.textureSheetAnimation&&this.m_particleSystem){var e=this.m_systemProperties.textureSheetAnimation;e.enabled&&this.m_particleSystem instanceof BABYLON.ParticleSystem?(this.m_particleSystem.spriteCellChangeSpeed=e.fps||1,this.m_particleSystem.spriteCellWidth=1/(e.numTilesX||1),this.m_particleSystem.spriteCellHeight=1/(e.numTilesY||1),this.m_particleSystem.spriteRandomStartCell=e.useRandomRow||!1,e.frameOverTime&&this.convertMinMaxCurve(e.frameOverTime),e.startFrame&&this.convertMinMaxCurve(e.startFrame),e.speedRange):e.enabled}},n.prototype.ensureBasicConfiguration=function(){var e;if(this.m_particleSystem&&(this.m_particleSystem.emitRate<0&&(this.m_particleSystem.emitRate=0),this.m_particleSystem.minLifeTime<=0&&(this.m_particleSystem.minLifeTime=5*n.UNITY_TO_BABYLON_LIFETIME_RATIO,this.m_particleSystem.maxLifeTime=5*n.UNITY_TO_BABYLON_LIFETIME_RATIO),this.m_particleSystem.minSize<=0&&(this.m_particleSystem.minSize=1*n.UNITY_TO_BABYLON_SIZE_RATIO,this.m_particleSystem.maxSize=1*n.UNITY_TO_BABYLON_SIZE_RATIO),this.m_particleSystem instanceof BABYLON.ParticleSystem&&(!this.m_particleSystem.direction1||!this.m_particleSystem.direction2||this.m_particleSystem.direction1.equals(new BABYLON.Vector3(-1,1,-1))&&this.m_particleSystem.direction2.equals(new BABYLON.Vector3(1,1,1))))){var t=this.m_systemProperties.shape,i=null!==(e=null==t?void 0:t.radius)&&void 0!==e?e:n.DEFAULT_PARTICLE_PROPERTIES.shape.radius;this.createSphereShapeEmitter(i,0,0)}},n.prototype.convertMinMaxCurve=function(e){var t,n,i,o,r,a,l,s;if(!e)return console.warn("### ShurikenParticles: ERROR - No curve data provided from Unity export"),{min:0,max:0,value:0};var u=null!==(t=e.mode)&&void 0!==t?t:0;(u<0||u>3)&&console.warn("### ShurikenParticles: WARNING - Invalid Unity curve mode:",u,"using mode 0 (Constant)");var c=e.multiplier||1;switch(u){case 0:var d=null!==(n=e.constant)&&void 0!==n?n:0;return{min:d,max:d,value:d};case 1:if(e.curve&&e.curve.keys&&e.curve.keys.length>0){var p=this.evaluateCurveAtTime(e.curve,0)*c,h=this.evaluateCurveAtTime(e.curve,.5)*c,m=this.evaluateCurveAtTime(e.curve,1)*c;return{min:Math.min(p,h,m),max:Math.max(p,h,m),value:(p+h+m)/3}}var f=(null!==(i=e.constant)&&void 0!==i?i:1)*c;return{min:f,max:f,value:f};case 2:var g=null!==(o=e.constantMin)&&void 0!==o?o:0,y=null!==(r=e.constantMax)&&void 0!==r?r:0;return{min:g,max:y,value:(g+y)/2};case 3:if(e.curveMin&&e.curveMax&&e.curveMin.keys&&e.curveMax.keys){var v=this.evaluateCurveAtTime(e.curveMin,0)*c,_=this.evaluateCurveAtTime(e.curveMin,.5)*c,S=this.evaluateCurveAtTime(e.curveMin,1)*c,B=this.evaluateCurveAtTime(e.curveMax,0)*c,b=this.evaluateCurveAtTime(e.curveMax,.5)*c,C=this.evaluateCurveAtTime(e.curveMax,1)*c,A=Math.min(v,_,S,B,b,C),M=Math.max(v,_,S,B,b,C);return{min:A,max:M,value:(A+M)/2}}var T=(null!==(a=e.constantMin)&&void 0!==a?a:0)*c,O=(null!==(l=e.constantMax)&&void 0!==l?l:0)*c;return{min:T,max:O,value:(T+O)/2};default:var I=null!==(s=e.constant)&&void 0!==s?s:0;return{min:I,max:I,value:I}}},n.prototype.convertMinMaxGradient=function(e){if(!e){var t=new BABYLON.Color4(1,1,1,1);return{colorMin:t,colorMax:t}}var n,i;switch(e.mode){case 0:var o=this.convertColor(e.color);n=o,i=o;break;case 2:n=this.convertColor(e.colorMin),i=this.convertColor(e.colorMax);break;case 1:if(e.gradient&&e.gradient.colorKeys&&e.gradient.colorKeys.length>0){var r=e.gradient.colorKeys[0],a=e.gradient.colorKeys[e.gradient.colorKeys.length-1];n=this.convertColor(r.color),i=this.convertColor(a.color)}else if(e.color)n=s=this.convertColor(e.color),i=s;else{var l=new BABYLON.Color4(1,1,1,1);n=l,i=l}break;case 3:e.gradientMin&&e.gradientMax&&e.gradientMin.colorKeys&&e.gradientMin.colorKeys.length>0&&e.gradientMax.colorKeys&&e.gradientMax.colorKeys.length>0?(n=this.convertColor(e.gradientMin.colorKeys[0].color),i=this.convertColor(e.gradientMax.colorKeys[0].color)):(n=this.convertColor(e.colorMin),i=this.convertColor(e.colorMax));break;case 4:e.gradient&&e.gradient.colorKeys&&e.gradient.colorKeys.length>0?(r=e.gradient.colorKeys[0],a=e.gradient.colorKeys[e.gradient.colorKeys.length-1],n=this.convertColor(r.color),i=this.convertColor(a.color)):(n=this.convertColor(e.colorMin),i=this.convertColor(e.colorMax));break;default:var s;e.color?(n=s=this.convertColor(e.color),i=s):(n=this.convertColor(e.colorMin),i=this.convertColor(e.colorMax))}return{colorMin:n,colorMax:i}},n.prototype.convertColor=function(e){if(!e)return new BABYLON.Color4(1,1,1,1);var t="number"==typeof e.r&&!isNaN(e.r)&&isFinite(e.r)?e.r:1,n="number"==typeof e.g&&!isNaN(e.g)&&isFinite(e.g)?e.g:1,i="number"==typeof e.b&&!isNaN(e.b)&&isFinite(e.b)?e.b:1,o="number"==typeof e.a&&!isNaN(e.a)&&isFinite(e.a)?e.a:1;return 1!==t||1!==n||1!==i||1!==o||1===e.r&&1===e.g&&1===e.b&&1===e.a?new BABYLON.Color4(t,n,i,o):new BABYLON.Color4(1,1,1,1)},n.prototype.colorsEqual=function(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;var n=1e-4;return Math.abs(e.r-t.r)<n&&Math.abs(e.g-t.g)<n&&Math.abs(e.b-t.b)<n&&Math.abs(e.a-t.a)<n},n.prototype.applyUnityGradientToBabylon=function(e,t){if(!e||!e.colorKeys||0===e.colorKeys.length)return!1;t.removeColorGradient(0),t.removeColorGradient(1);for(var n=0,i=e.colorKeys;n<i.length;n++){var o=i[n],r=this.convertColor(o.color);t.addColorGradient(o.time,r)}return e.alphaKeys&&e.alphaKeys.length>0&&console.warn("### ShurikenParticles: Alpha keys detected but not fully supported yet"),!0},n.prototype.convertVector3=function(e){return e?new BABYLON.Vector3(e.x,e.y,e.z):BABYLON.Vector3.Zero()},n.prototype.evaluateCurveAtTime=function(e,t){if(!e||!e.keys||0===e.keys.length)return 1;var n=e.keys;if(t<=n[0].time)return n[0].value;if(t>=n[n.length-1].time)return n[n.length-1].value;for(var i=0;i<n.length-1;i++){var o=n[i],r=n[i+1];if(t>=o.time&&t<=r.time){var a=(t-o.time)/(r.time-o.time);return o.value+a*(r.value-o.value)}}return n[0].value},n.prototype.setupBursts=function(e){if(this.m_burstTimers=[],e&&e.length>0)for(var t=0;t<e.length;t++){var n=e[t];this.m_burstTimers.push(-n.time)}},n.prototype.resetBurstTimers=function(){var e;if((null===(e=this.m_systemProperties.emission)||void 0===e?void 0:e.bursts)&&this.m_burstTimers)for(var t=0;t<this.m_systemProperties.emission.bursts.length;t++){var n=this.m_systemProperties.emission.bursts[t];this.m_burstTimers[t]=-n.time}},n.prototype.updateSystem=function(e){this.m_systemTime+=e},n.prototype.updateEmission=function(e){this.m_emissionTimer+=e},n.prototype.updateAnimationProperties=function(){},n.prototype.updateBursts=function(e){var t,n,i;if(null===(t=this.m_systemProperties.emission)||void 0===t?void 0:t.bursts)for(var o=0;o<this.m_systemProperties.emission.bursts.length;o++){var r=this.m_systemProperties.emission.bursts[o];if(this.m_systemTime>=r.time&&this.m_burstTimers[o]<0){var a=void 0!==r.probability?r.probability:1;if(Math.random()>a){this.m_burstTimers[o]=this.m_systemTime;continue}var l=this.convertMinMaxCurve(r.count),s=void 0;switch(null!==(i=null===(n=r.count)||void 0===n?void 0:n.mode)&&void 0!==i?i:0){case 0:case 1:default:s=l.value;break;case 2:case 3:s=Math.random()*(l.max-l.min)+l.min}(s=Math.max(0,Math.round(s)))>0&&this.triggerBurst(s),this.m_burstTimers[o]=this.m_systemTime;var u=void 0!==r.cycleCount?r.cycleCount:1;(-1===u||u>1)&&void 0!==r.repeatInterval&&r.repeatInterval}}},n.prototype.triggerBurst=function(e){var t=this;if(this.m_particleSystem instanceof BABYLON.ParticleSystem){var n=this.m_particleSystem.emitRate;this.m_particleSystem.emitRate=60*e,setTimeout(function(){t.m_particleSystem&&(t.m_particleSystem.emitRate=n)},16)}},n.prototype.configureEmissionShape=function(e){var t,n,i;if(e.radiusSpeed&&(this.convertMinMaxCurve(e.radiusSpeed),null===(t=e.radiusSpeed)||void 0===t?void 0:t.mode),e.meshSpawnSpeed&&(this.convertMinMaxCurve(e.meshSpawnSpeed),null===(n=e.meshSpawnSpeed)||void 0===n?void 0:n.mode),e.arcSpeed&&(this.convertMinMaxCurve(e.arcSpeed),null===(i=e.arcSpeed)||void 0===i?void 0:i.mode),e.rotation&&this.m_emitterMesh){var o=this.convertVector3(e.rotation),r=BABYLON.Quaternion.FromEulerAngles(BABYLON.Tools.ToRadians(o.x),BABYLON.Tools.ToRadians(o.y),BABYLON.Tools.ToRadians(o.z)),a=this.m_emitterMesh.rotationQuaternion||BABYLON.Quaternion.Identity();this.m_emitterMesh.rotationQuaternion=a.multiply(r)}switch(e.shapeType){case 4:case 7:case 8:case 9:var l=e.radius||1,s=e.angle||25,u=(e.length,e.arc,e.radiusSpread,e.scale||{x:1,y:1,z:1}),c=(e.radiusMode,l*((u.x+u.z)/2)),d=Math.max(.1,s*Math.PI/180),p=Math.max(.5,c);this.createConeShapeEmitter(p,d);break;case 0:case 1:var h=e.radius||1,m=e.scale||{x:1,y:1,z:1},f=e.radiusSpread||0,g=e.radiusMode||0,y=(e.donutRadius,h);2===g&&f>0&&(y=h*(1+.5*f));var v=y*((m.x+m.y+m.z)/3);e.shapeType,this.m_particleSystem.createSphereEmitter(v);break;case 2:case 3:var _=e.radius||1,S=e.scale||{x:1,y:1,z:1},B=e.radiusSpread||0,b=e.radiusMode||0,C=(e.donutRadius,e.arc,_);2===b&&B>0&&(C=_*(1+.5*B));var A=C*((S.x+S.y+S.z)/3);e.shapeType,this.m_particleSystem.createHemisphericEmitter(A);break;case 10:case 11:var M=e.radius||1,T=e.scale||{x:1,y:1,z:1},O=(e.arc,e.donutRadius,e.radiusSpread||0),I=e.radiusMode||0,L=(e.length,M);2===I&&O>0&&(L=M*(1+.5*O));var x=L*((T.x+T.z)/2);T.y,this.m_particleSystem.createDirectedSphereEmitter(x,new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,1,0));break;case 5:case 15:case 16:var N=e.scale||{x:1,y:1,z:1},w=e.boxThickness||{x:0,y:0,z:0};15!==e.shapeType&&16!==e.shapeType||(N={x:Math.max(.1,N.x-w.x),y:Math.max(.1,N.y-w.y),z:Math.max(.1,N.z-w.z)}),this.m_particleSystem.createBoxEmitter(new BABYLON.Vector3(-N.x/2,-N.y/2,-N.z/2),new BABYLON.Vector3(N.x/2,N.y/2,N.z/2),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,1,0));break;case 17:var P=e.radius||1,R=e.donutRadius||.2,k=e.scale||{x:1,y:1,z:1},E=(e.arc,e.radiusSpread||0),D=P;2===(e.radiusMode||0)&&E>0&&(D=P*(1+.5*E));var U=(k.x+k.z)/2,F=(D*U+R*U)/2;this.m_particleSystem.createDirectedSphereEmitter(F,new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,1,0));break;case 18:var Y=e.scale||{x:1,y:1,z:1},V=e.length||1,G=(e.arc,Y.x),H=Y.z,z=V*Y.y;this.m_particleSystem.createBoxEmitter(new BABYLON.Vector3(-G/2,-z/2,-H/2),new BABYLON.Vector3(G/2,z/2,H/2),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,1,0));break;case 12:var W=e.length||1,Q=e.scale||{x:1,y:1,z:1},X=e.radius||.1,K=W*Q.x,j=X*Math.max(Q.y,Q.z);this.m_particleSystem.createBoxEmitter(new BABYLON.Vector3(-K/2,-j/2,-j/2),new BABYLON.Vector3(K/2,j/2,j/2),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,1,0));break;default:if(6===e.shapeType||13===e.shapeType||14===e.shapeType){var Z=e.radius||1,J=e.scale||{x:1,y:1,z:1},q=Z*((J.x+J.y+J.z)/3);this.m_particleSystem.createSphereEmitter(q)}else if(19===e.shapeType||20===e.shapeType){var $=e.scale||{x:1,y:1,z:1};this.m_particleSystem.createBoxEmitter(new BABYLON.Vector3(-$.x/2,-$.y/2,-.1),new BABYLON.Vector3($.x/2,$.y/2,.1),new BABYLON.Vector3(0,0,1),new BABYLON.Vector3(0,0,1))}else{var ee=e.radius||1,te=(e.angle||25)*Math.PI/180,ne=e.length||1,ie=e.scale||{x:1,y:1,z:1},oe=te,re=(ee+(ee+ne*Math.tan(oe)))/2,ae=3*ee;(re*=(ie.x+ie.z)/2)>ae&&(re=ae);var le=Math.min(oe,Math.PI/4);this.createConeShapeEmitter(re,le)}}if(e.position&&(0!==e.position.x||0!==e.position.y||0!==e.position.z)){var se=this.convertVector3(e.position);this.m_emitterMesh&&(this.m_emitterMesh.position.clone(),this.m_emitterMesh.position.addInPlace(se))}!e.rotation||0===e.rotation.x&&0===e.rotation.y&&0===e.rotation.z||this.m_emitterMesh,e.randomDirectionAmount,e.randomPositionAmount,e.sphericalDirectionAmount,e.alignToDirection,e.arc,void 0!==e.normalOffset&&e.normalOffset},n.prototype.setupVelocityOverLifetime=function(e){},n.prototype.setupLimitVelocity=function(e){},n.prototype.createColorGradient=function(e){return this.convertMinMaxGradient(e)},n.prototype.setupSpriteAnimation=function(e){this.m_particleSystem instanceof BABYLON.ParticleSystem&&(this.m_particleSystem.spriteCellChangeSpeed=e.fps||1,this.m_particleSystem.spriteCellWidth=1/e.numTilesX,this.m_particleSystem.spriteCellHeight=1/e.numTilesY,this.m_particleSystem.spriteRandomStartCell=e.useRandomRow)},n.prototype.createBoxShapeEmitter=function(e,t){if(this.m_particleSystem instanceof BABYLON.ParticleSystem){var n=e||{x:1,y:1,z:1};this.m_particleSystem.createBoxEmitter(new BABYLON.Vector3(-n.x/2,-n.y/2,-n.z/2),new BABYLON.Vector3(n.x/2,n.y/2,n.z/2),new BABYLON.Vector3(0,1,0),new BABYLON.Vector3(0,1,0))}},n.prototype.createSphereShapeEmitter=function(e,t,n){if(this.m_particleSystem instanceof BABYLON.ParticleSystem){var i=e||1;this.m_particleSystem.createSphereEmitter(i)}},n.prototype.createConeShapeEmitter=function(e,t){if(this.m_particleSystem instanceof BABYLON.ParticleSystem){var i=e||1,o=t||Math.PI/7.2,r=this.m_particleSystem.createConeEmitter(i*n.UNITY_TO_BABYLON_CONE_SCALE_RATIO,o*n.UNITY_TO_BABYLON_CONE_SCALE_RATIO);r.radiusRange=1,r.heightRange=1,r.directionRandomizer=1,r.emitFromSpawnPointOnly=!1}},n.prototype.configureNoiseModule=function(){},n.prototype.configureCollisionModule=function(){},n.prototype.configureTrailsModule=function(){},n.prototype.configureSubEmittersModule=function(){},n.prototype.updateEmitterVelocityInheritance=function(e){var t;this.m_emitterVelocity.length()>0&&void 0!==(null===(t=this.m_systemProperties.main)||void 0===t?void 0:t.emitterVelocityMode)&&this.m_systemProperties.main.emitterVelocityMode},n.prototype.updateCustomSimulationSpace=function(e){this.m_customSimulationSpace},n.prototype.updateRingBufferMode=function(e){var t=this.m_systemProperties.main;(null==t?void 0:t.ringBufferMode)&&t.ringBufferMode>0&&t.ringBufferLoopRange&&(t.ringBufferLoopRange,2===t.ringBufferMode||t.ringBufferMode)},n.prototype.handleStopAction=function(){var e=this,t=this.m_systemProperties.main;void 0!==(null==t?void 0:t.stopAction)?1===t.stopAction?setTimeout(function(){e.transform&&e.transform.dispose&&e.transform.dispose()},0):this.stop():this.stop()},n.prototype.setupCullingVisibilityCheck=function(){var e=this,t=function(){if(e.m_isInitialized&&e.m_emitterMesh){var t=Date.now();if(!(t-e.m_lastVisibilityCheck<100)){e.m_lastVisibilityCheck=t;var n=e.m_isVisible;e.m_isVisible=e.isEmitterVisible(),n!==e.m_isVisible&&e.handleVisibilityChange(n,e.m_isVisible)}}};this.scene.registerBeforeRender(t);var n=this.disposeParticleSystem.bind(this);this.disposeParticleSystem=function(){e.scene.unregisterBeforeRender(t),n()}},n.prototype.isEmitterVisible=function(){if(!this.m_emitterMesh||!this.scene.activeCamera)return!0;var e=this.m_emitterMesh.getBoundingInfo();if(!e)return!0;var t=this.scene.activeCamera;if(t.isInFrustum&&e.boundingBox)return t.isInFrustum(e.boundingBox);var n=this.m_emitterMesh.getAbsolutePosition(),i=t.position;return BABYLON.Vector3.Distance(n,i)<=1e3},n.prototype.handleVisibilityChange=function(e,t){var n=this.m_cullingMode;!e&&t?1===n&&this.m_pausedTime>0&&(this.m_pausedTime=0):e&&!t&&(this.m_pausedTime=0)},n.prototype.disposeParticleSystem=function(){this.m_particleSystem&&(this.m_particleSystem.dispose(),this.m_particleSystem=null),this.m_emitterMesh&&this.m_emitterMesh.parent===this.transform&&(this.m_emitterMesh.dispose(),this.m_emitterMesh=null),this.m_animationCurves.clear(),this.m_gradients.clear(),this.m_isInitialized=!1},n.DefaultParticleTexture=null,n.DEFAULT_PARTICLE_PROPERTIES={isPlaying:!0,isPaused:!1,isStopped:!1,isEmitting:!0,particleCount:50,time:0,randomSeed:0,useAutoRandomSeed:!0,name:"",instanceId:0,enabled:!0,transformPosition:{x:0,y:0,z:0},transformRotation:{x:0,y:0,z:0},transformScale:{x:1,y:1,z:1},main:{duration:5,loop:!0,prewarm:!0,startDelay:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},startDelayMultiplier:0,startLifetime:{mode:0,constant:5,constantMin:0,constantMax:5,multiplier:1},startLifetimeMultiplier:5,startSpeed:{mode:0,constant:5,constantMin:0,constantMax:5,multiplier:1},startSpeedMultiplier:5,startSize3D:!1,startSize:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},startSizeMultiplier:1,startSizeX:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},startSizeXMultiplier:1,startSizeY:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},startSizeYMultiplier:1,startSizeZ:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},startSizeZMultiplier:1,startRotation3D:!1,startRotation:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},startRotationMultiplier:0,startRotationX:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},startRotationXMultiplier:0,startRotationY:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},startRotationYMultiplier:0,startRotationZ:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},startRotationZMultiplier:0,flipRotation:0,startColor:{mode:0,color:{r:1,g:1,b:1,a:1},colorMin:{r:0,g:0,b:0,a:0},colorMax:{r:1,g:1,b:1,a:1}},gravityModifier:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},gravityModifierMultiplier:0,simulationSpace:0,simulationSpeed:1,deltaTime:0,scalingMode:1,playOnAwake:!0,emitterVelocityMode:1,maxParticles:1e3,stopAction:0,cullingMode:0,ringBufferMode:0,ringBufferLoopRange:{x:0,y:1},customSimulationSpace:0,emitterVelocity:{x:0,y:0,z:0},gravitySource:0,useUnscaledTime:!1},emission:{enabled:!0,rateOverTime:{mode:0,constant:10,constantMin:0,constantMax:10,multiplier:1},rateOverTimeMultiplier:10,rateOverDistance:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},rateOverDistanceMultiplier:0,burstCount:0,bursts:[]},shape:{enabled:!0,shapeType:0,angle:25,radius:.025,radiusMode:0,radiusSpread:0,radiusSpeed:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},radiusSpeedMultiplier:1,donutRadius:.2,position:{x:0,y:0,z:0},rotation:{x:0,y:0,z:0},scale:{x:1,y:1,z:1},alignToDirection:!1,randomDirectionAmount:0,sphericalDirectionAmount:0,randomPositionAmount:0,biasOnTriangles:!1,useMeshMaterialIndex:!1,meshMaterialIndex:0,useMeshColors:!0,normalOffset:0,meshSpawnMode:0,meshSpawnSpread:0,meshSpawnSpeed:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},meshSpawnSpeedMultiplier:1,arc:360,arcMode:0,arcSpread:0,arcSpeed:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},arcSpeedMultiplier:1,length:5,boxThickness:{x:0,y:0,z:0}},renderer:{enabled:!0,materials:[],renderMode:0,cameraVelocityScale:0,velocityScale:0,lengthScale:2,normalDirection:1,sortMode:0,sortingFudge:0,minParticleSize:0,maxParticleSize:.5,alignment:0,flip:{x:0,y:0},allowRoll:!0,pivot:{x:0,y:0,z:0},shadowCastingMode:1,receiveShadows:!0,motionVectorGenerationMode:1,lightProbeUsage:1,reflectionProbeUsage:1,enableGPUInstancing:!0,mesh:null,sortingLayerID:0,sortingOrder:0,freeformStretching:!1,maskInteraction:0,meshCount:0,meshDistribution:0,rotateWithStretchDirection:!1,shadowBias:0,supportsMeshInstancing:!0,activeVertexStreamsCount:0,activeTrailVertexStreamsCount:0,meshes:[],trailMaterial:null},velocityOverLifetime:{enabled:!1,space:0,x:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},y:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},z:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},xMultiplier:0,yMultiplier:0,zMultiplier:0,orbitalX:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},orbitalY:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},orbitalZ:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},orbitalXMultiplier:0,orbitalYMultiplier:0,orbitalZMultiplier:0,orbitalOffsetX:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},orbitalOffsetY:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},orbitalOffsetZ:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},orbitalOffsetXMultiplier:0,orbitalOffsetYMultiplier:0,orbitalOffsetZMultiplier:0,radial:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},radialMultiplier:0,speedModifier:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},speedModifierMultiplier:1},limitVelocityOverLifetime:{enabled:!1,limitX:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},limitY:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},limitZ:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},limitXMultiplier:1,limitYMultiplier:1,limitZMultiplier:1,limit:{mode:0,constant:1,constantMin:0,constantMax:1,multiplier:1},limitMultiplier:1,dampen:0,separateAxes:!1,space:0,drag:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},dragMultiplier:0,multiplyDragByParticleSize:!0,multiplyDragByParticleVelocity:!0},colorOverLifetime:{enabled:!1,color:{mode:1,color:{r:0,g:0,b:0,a:0},colorMin:{r:0,g:0,b:0,a:0},colorMax:{r:0,g:0,b:0,a:0}}},sizeOverLifetime:{enabled:!1,size:{mode:1,constant:0,constantMin:0,constantMax:0,multiplier:1},sizeMultiplier:1,x:{mode:1,constant:0,constantMin:0,constantMax:0,multiplier:1},xMultiplier:1,y:{mode:1,constant:0,constantMin:0,constantMax:0,multiplier:1},yMultiplier:1,z:{mode:1,constant:0,constantMin:0,constantMax:0,multiplier:1},zMultiplier:1,separateAxes:!1},rotationOverLifetime:{enabled:!1,x:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},xMultiplier:0,y:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},yMultiplier:0,z:{mode:0,constant:.7853982,constantMin:0,constantMax:.7853982,multiplier:1},zMultiplier:.7853982,separateAxes:!1},textureSheetAnimation:{enabled:!1,mode:0,timeMode:0,fps:30,numTilesX:1,numTilesY:1,animation:0,useRandomRow:!0,frameOverTime:{mode:1,constant:0,constantMin:0,constantMax:0,multiplier:.9999},frameOverTimeMultiplier:.9999,startFrame:{mode:0,constant:0,constantMin:0,constantMax:0,multiplier:1},startFrameMultiplier:0,cycleCount:1,rowIndex:0,rowMode:1,uvChannelMask:-1,flipU:0,flipV:0,speedRange:{x:0,y:1}}},n.UNITY_TO_BABYLON_SIZE_RATIO=1,n.UNITY_TO_BABYLON_GRAVITY_RATIO=1,n.UNITY_TO_BABYLON_EMIT_RATE_RATIO=2,n.UNITY_TO_BABYLON_EMIT_POWER_RATIO=2,n.UNITY_TO_BABYLON_CONE_SCALE_RATIO=2,n.UNITY_TO_BABYLON_LIFETIME_RATIO=.65,n.UNITY_TO_BABYLON_DEATH_FADE_ALPHA=.2,n.EMITTER_POSITION_OFFSET=new BABYLON.Vector3(0,0,0),n.EMITTER_ROTATION_OFFSET=new BABYLON.Vector3(90,0,0),n}(e.ScriptComponent);e.ShurikenParticles=t,e.SceneManager.RegisterClass("TOOLKIT.ShurikenParticles",t)}(i||(i={})),function(e){var t=function(e){function t(t,n,i,o){return void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.TerrainGenerator"),e.call(this,t,n,i,o)||this}return o(t,e),t.prototype.awake=function(){},t.prototype.start=function(){},t.prototype.ready=function(){},t.prototype.update=function(){},t.prototype.late=function(){},t.prototype.step=function(){},t.prototype.fixed=function(){},t.prototype.after=function(){},t.prototype.destroy=function(){},t}(e.ScriptComponent);e.TerrainGenerator=t,e.SceneManager.RegisterClass("TOOLKIT.TerrainGenerator",t)}(i||(i={})),function(e){var t=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return o(t,e),t}(BABYLON.GUI.Slider);e.UnitySlider=t;var n=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t._direction="LeftToRight",t}return o(t,e),Object.defineProperty(t.prototype,"direction",{get:function(){return this._direction},set:function(e){this._direction=e,this._markAsDirty()},enumerable:!1,configurable:!0}),t.prototype._getThumbPosition=function(){var e=(this.value-this.minimum)/(this.maximum-this.minimum),t=this.isVertical?this._currentMeasure.height-this._effectiveThumbThickness:this._currentMeasure.width-this._effectiveThumbThickness,n=e*t;return"RightToLeft"!==this._direction||this.isVertical?"TopToBottom"===this._direction&&this.isVertical&&(n=t-n):n=t-n,n},t.prototype.serialize=function(t){e.prototype.serialize.call(this,t),t.direction=this._direction},t.prototype._parseFromContent=function(t,n){e.prototype._parseFromContent.call(this,t,n),t.direction&&(this._direction=t.direction)},t}(BABYLON.GUI.ScrollBar);e.UnityScrollBar=n;var i=function(e){function t(t){var n=e.call(this,t||"dropdownMenu")||this;n._button=null,n._popup=null,n._options=[],n._selectedIndex=0,n.width="150px",n.height="30px",n.thickness=1,n.cornerRadius=3,n.color="#333333",n.background="transparent",console.warn("DropdownMenu is a custom control and may not be fully supported in all environments."),n._button=BABYLON.GUI.Button.CreateSimpleButton((n.name||"")+"_btn",""),n._button.width="100%",n._button.height="100%",n._button.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,n._button.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_CENTER,n._button.cornerRadius=3,n._button.thickness=0,n._button.color="#000000",n._button.background="#ffffff00";var i=new BABYLON.GUI.TextBlock((n.name||"")+"_label","");i.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,i.paddingLeft="8px",i.resizeToFit=!1,i.text="",i.color="#000000",i.fontSize="14px",i.textWrapping=!0,n._button.addControl(i);var o=new BABYLON.GUI.TextBlock((n.name||"")+"_arrow","▼");o.width="24px",o.textHorizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER,o.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT,o.paddingRight="6px",o.color="#222222",n._button.addControl(o),n._popup=new BABYLON.GUI.Container((n.name||"")+"_popup"),n._popup.width="150px",n._popup.isVisible=!1,n._popup.background="#ffffff",n._popup.thickness=1,n._popup.cornerRadius=3,n._popup.zIndex=1e3,n._popup.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;var r=new BABYLON.GUI.StackPanel((n.name||"")+"_stack");return r.isVertical=!0,n._popup.addControl(r),n._button.onPointerUpObservable.add(function(){n._popup&&(n._popup.isVisible=!n._popup.isVisible)}),n.addControl(n._button),n.addControl(n._popup),n}return o(t,e),Object.defineProperty(t.prototype,"selectedIndex",{get:function(){return this._selectedIndex},set:function(e){this._selectedIndex=e,this._updateSelectedText()},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"options",{set:function(e){this._options=e||[],this._rebuildOptions()},enumerable:!1,configurable:!0}),t.prototype._updateSelectedText=function(){if(this._button){var e=this._button.getChildByName((this.name||"")+"_label");if(e){var t=this._options[this._selectedIndex];e.text=t?t.text:""}}},t.prototype._rebuildOptions=function(){var e=this;if(this._popup){this._popup.dispose(),this._popup=new BABYLON.GUI.Container((this.name||"")+"_popup"),this._popup.width="150px",this._popup.isVisible=!1,this._popup.background="#ffffff",this._popup.thickness=1,this._popup.cornerRadius=3,this._popup.zIndex=1e3,this._popup.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP;var t=new BABYLON.GUI.StackPanel((this.name||"")+"_stack");t.isVertical=!0,this._popup.addControl(t);for(var n=function(n){var o=i._options[n],r=BABYLON.GUI.Button.CreateSimpleButton((i.name||"")+"_opt_"+n,o.text||"");r.width="100%",r.height="28px",r.thickness=0,r.cornerRadius=0,r.color="#000000",r.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,r.onPointerUpObservable.add(function(){e.selectedIndex=n,e._popup&&(e._popup.isVisible=!1),e.onSelectionChanged&&e.onSelectionChanged(n)}),t.addControl(r)},i=this,o=0;o<this._options.length;o++)n(o);this.addControl(this._popup),this._updateSelectedText()}},t.prototype.serialize=function(){var e={};try{var t=BABYLON.GUI.Container.prototype.serialize;"function"==typeof t&&(e=t.call(this)||{})}catch(t){e={}}return(e=e||{}).className="UnityDropdownMenu",e.options=this._options.map(function(e){return{text:e.text,imageSource:e.imageSource}}),e.selectedIndex=this._selectedIndex,e},t.Parse=function(e,n,i){var o=new t(e.name||"dropdownMenu");try{Array.isArray(e.options)&&(o.options=e.options.map(function(e){return{text:e.text||"",imageSource:e.imageSource}})),"number"==typeof e.selectedIndex&&(o.selectedIndex=e.selectedIndex)}catch(e){console.warn(e)}return o},t}(BABYLON.GUI.Container);e.UnityDropdownMenu=i,e.SceneManager.RegisterClass("BABYLON.GUI.UnitySlider",t),e.SceneManager.RegisterClass("BABYLON.GUI.UnityScrollBar",n),e.SceneManager.RegisterClass("BABYLON.GUI.UnityDropdownMenu",i)}(i||(i={})),function(e){var t=function(t){function n(e,n,i,o){return void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.UserInterface"),t.call(this,e,n,i,o)||this}return o(n,t),n.prototype.start=function(){return r(this,void 0,void 0,function(){var t,n,i,o,r;return a(this,function(a){switch(a.label){case 0:return null==(t=this.getProperty("gui"))?[3,2]:(n=e.SceneManager.GetRootUrl(this.scene)||"",i=!1,o=!0,r=this.extractRequiredFonts(t),[4,this.loadRequiredFonts(r,n)]);case 1:if(a.sent(),this.parseNodeObject(t.root||t.controls,n),e.UserInterface.LoadForegroundInterfaceData(this.scene,t,BABYLON.Texture.BILINEAR_SAMPLINGMODE,o,null,i),e.UserInterface.OnInterfaceLoaded&&e.UserInterface.OnInterfaceLoaded.hasObservers())try{e.UserInterface.OnInterfaceLoaded.notifyObservers(this.transform.name)}catch(e){console.warn(e instanceof Error?e.message:String(e))}a.label=2;case 2:return[2]}})})},n.prototype.parseNodeObject=function(e,t){var i=this;if(null!=e&&(this.processNodeSources(e,t),null!=e.children&&Array.isArray(e.children)&&e.children.forEach(function(e){i.parseNodeObject(e,t)}),n.OnParseNodeObject&&n.OnParseNodeObject.hasObservers()))try{n.OnParseNodeObject.notifyObservers(e)}catch(e){console.warn(e instanceof Error?e.message:String(e))}},n.prototype.processNodeSources=function(e,t){if(null!=e&&"object"==typeof e){if(e.source&&"string"==typeof e.source&&e.source.startsWith("assets/")){var n=t&&!t.endsWith("/")?t+"/":t;e.source,e.source=n+e.source}for(var i in e)e.hasOwnProperty(i)&&"object"==typeof e[i]&&null!==e[i]&&"children"!==i&&this.processNodeSources(e[i],t)}},n.prototype.extractRequiredFonts=function(e){var t=new Set,n=function(e){e.fontFamily&&"Arial"!==e.fontFamily&&"sans-serif"!==e.fontFamily&&t.add(e.fontFamily),e.children&&Array.isArray(e.children)&&e.children.forEach(n)};return e.root&&n(e.root),Array.from(t)},n.prototype.loadRequiredFonts=function(e,t){return r(this,void 0,void 0,function(){var n,i,o=this;return a(this,function(r){switch(r.label){case 0:return e&&0!==e.length?[4,this.loadFontManifest(t)]:[2];case 1:return n=r.sent(),i=e.map(function(e){return o.loadSingleFont(e,n,t)}),[4,Promise.allSettled(i)];case 2:return r.sent().forEach(function(t,n){"fulfilled"===t.status||console.warn("✗ Font failed: ".concat(e[n]),t.reason)}),[4,document.fonts.ready];case 3:return r.sent(),[2]}})})},n.prototype.loadFontManifest=function(e){return r(this,void 0,void 0,function(){var t;return a(this,function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),[4,fetch(e+"font-manifest.json")];case 1:return(t=n.sent()).ok?[4,t.json()]:[3,3];case 2:return[2,n.sent()];case 3:return[3,5];case 4:return n.sent(),console.warn("No Font Manifest Found, Using Web Fonts Fallback"),[3,5];case 5:return[2,[]]}})})},n.prototype.loadSingleFont=function(e,t,n){return r(this,void 0,void 0,function(){var i;return a(this,function(o){switch(o.label){case 0:return(i=t.find(function(t){return t.family===e}))?[4,this.loadUnityFont(i,n)]:[3,2];case 1:case 3:return o.sent(),[2];case 2:return this.isGoogleFont(e)?[4,this.loadGoogleFont(e)]:[3,4];case 4:return this.isSystemFontAvailable(e)||console.warn("Font Not Available: ".concat(e)),[2]}})})},n.prototype.loadUnityFont=function(e,t){return r(this,void 0,void 0,function(){var n,i,o;return a(this,function(r){switch(r.label){case 0:n=t+e.path,r.label=1;case 1:return r.trys.push([1,3,,4]),[4,(i=new FontFace(e.family,"url('".concat(n,"') format('truetype')"),{style:e.style||"normal",weight:e.weight||"normal",display:"swap"})).load()];case 2:return r.sent(),document.fonts.add(i),[3,4];case 3:return o=r.sent(),console.warn("Failed To Load Unity Font: ".concat(e.family),o),[3,4];case 4:return[2]}})})},n.prototype.loadGoogleFont=function(e){return r(this,void 0,void 0,function(){return a(this,function(t){return[2,new Promise(function(t,n){var i=document.createElement("link");i.rel="stylesheet",i.href="https://fonts.googleapis.com/css2?family=".concat(encodeURIComponent(e),":wght@400;700&display=swap"),i.onload=function(){t()},i.onerror=function(){return n(new Error("Failed To Load Google Font: ".concat(e)))},document.head.appendChild(i)})]})})},n.prototype.isGoogleFont=function(e){return["Roboto","Open Sans","Lato","Montserrat","Source Sans Pro","Oswald","Raleway","Poppins","Merriweather","Nunito","Ubuntu","Playfair Display","Work Sans","Fira Sans","Noto Sans","PT Sans","Crimson Text","Inter"].includes(e)},n.prototype.isSystemFontAvailable=function(e){var t=document.createElement("canvas").getContext("2d"),n="mmmmmmmmmmlli";t.font="72px monospace";var i=t.measureText(n).width;return t.font='72px "'.concat(e,'", monospace'),t.measureText(n).width!==i},n.CreateInternalUserInterface=function(e,t,n,i){return 1==t?(e._foregroundTexture=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("Default-Screen-UI",!0,e,n,i),e._foregroundTexture):(e._backgroundTexture=BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("Background-Screen-UI",!1,e,n,i),e._backgroundTexture)},n.LoadForegroundInterfaceData=function(t,n,i,o,r,a){if(null==t._foregroundTexture&&(t._foregroundTexture=e.UserInterface.CreateInternalUserInterface(t,!0,i,a)),null!=n){var l=t._foregroundTexture&&null!=t._foregroundTexture._textureInitialized&&!0===t._foregroundTexture._textureInitialized;e.UserInterface.ParseUserInterfaceObject(t,t._foregroundTexture,n,o,r,l),t._foregroundTexture._textureInitialized=!0}t.getEngine().resize(!0)},n.LoadBackgroundInterfaceData=function(t,n,i,o,r,a){if(null==t._backgroundTexture&&(t._backgroundTexture=e.UserInterface.CreateInternalUserInterface(t,!1,i,a)),null!=n){var l=t._backgroundTexture&&null!=t._backgroundTexture._textureInitialized&&!0===t._backgroundTexture._textureInitialized;e.UserInterface.ParseUserInterfaceObject(t,t._backgroundTexture,n,o,r,l),t._backgroundTexture._textureInitialized=!0}t.getEngine().resize(!0)},n.ParseUserInterfaceObject=function(t,n,i,o,r,a){if(i&&n){e.UserInterface.FixUserInterfacePrototypes();var l=t.getEngine().getHardwareScalingLevel()||1,s=Number.isFinite(+i.canvasScalerMode)?+i.canvasScalerMode:1,u=Number.isFinite(+i.renderScaleFactor)&&+i.renderScaleFactor>0?+i.renderScaleFactor:1,c=Number.isFinite(+i.fallbackScreenDpi)&&+i.fallbackScreenDpi>0?+i.fallbackScreenDpi:72,d=Number.isFinite(+i.defaultSpriteDpi)&&+i.defaultSpriteDpi>0?+i.defaultSpriteDpi:72,p=Number.isFinite(+i.referencePixelsPerUnit)&&+i.referencePixelsPerUnit>0?+i.referencePixelsPerUnit:100,h=Number.isFinite(+i.pixelScaleFactor)&&+i.pixelScaleFactor>0?+i.pixelScaleFactor:1,m=e.UserInterface.PHYSICAL_SIZE_POINT_FACTOR,f=Number(i.width),g=Number(i.height),y=Number.isFinite(f)&&f>0&&Number.isFinite(g)&&g>0,v=y?f:1920,_=y?g:1080,S=function(e){e.width="100%",e.height="100%",e.left="0px",e.top="0px",e.horizontalAlignment=BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_LEFT,e.verticalAlignment=BABYLON.GUI.Control.VERTICAL_ALIGNMENT_TOP},B=function(e){return JSON.parse(JSON.stringify(e))},b=function(e){if("number"==typeof e)return Number.isFinite(e);if("string"==typeof e){var t=e.trim().toLowerCase();return!t.endsWith("%")&&(t.endsWith("px")?Number.isFinite(parseFloat(t)):/^-?\d+(\.\d+)?$/.test(t))}return!1},C=function(e,t){if(e&&"object"==typeof e){var n=new Set(["left","top","width","height","minWidth","minHeight","maxWidth","maxHeight","marginLeft","marginRight","marginTop","marginBottom","paddingLeft","paddingRight","paddingTop","paddingBottom","fontSize","thickness","cornerRadius","shadowOffsetX","shadowOffsetY","shadowBlur","linkOffsetX","linkOffsetY"]),i=new Set(["cornerRadiusX","cornerRadiusY","cornerRadiusZ","cornerRadiusW"]),o=function(e){if(null==e)return e;if("number"==typeof e)return Math.round(e*t);if("string"==typeof e){var n=e.trim();if(n.endsWith("%"))return e;if(n.toLowerCase().endsWith("px")){var i=parseFloat(n);return Number.isFinite(i)?"".concat(Math.round(i*t),"px"):e}return/^-?\d+(\.\d+)?$/.test(n)?(i=parseFloat(n),Number.isFinite(i)?"".concat(Math.round(i*t),"px"):e):e}if("object"==typeof e){for(var r=0,a=["left","top","right","bottom","x","y","w","h","value"];r<a.length;r++){var l=a[r];l in e&&b(e[l])&&(e[l]=o(e[l]))}return e}return e};for(var r in e)(n.has(r)||i.has(r))&&(e[r]=o(e[r]));if(e.style&&"object"==typeof e.style)for(var r in e.style)(n.has(r)||i.has(r))&&(e.style[r]=o(e.style[r]));var a=e.children;if(Array.isArray(a))for(var l=0,s=a;l<s.length;l++){var u=s[l];C(u,t)}}};if(!0!==a){if(1===s){var A=Number(i.idealWidth),M=Number(i.idealHeight),T=Number.isFinite(A)&&A>0?A:NaN,O=Number.isFinite(M)&&M>0?M:NaN;!Number.isFinite(T)&&Number.isFinite(O)&&y?T=Math.round(O*v/_):!Number.isFinite(O)&&Number.isFinite(T)&&y&&(O=Math.round(T*_/v)),n.renderScale=1/l*u,Number.isFinite(T)&&Number.isFinite(O)?(n.idealWidth=T,n.idealHeight=O,n.useSmallestIdeal=!!i.useSmallestIdeal,n.renderAtIdealSize=!0):y?(n.idealWidth=v,n.idealHeight=_,n.useSmallestIdeal=!0,n.renderAtIdealSize=!0):n.renderAtIdealSize=!1;var I=BABYLON.GUI.Control.Parse(i.root,n,r);return S(I),n._rootContainer=I,e.UserInterface.ProcessTextSpacingProperties(I,i.root),e.UserInterface.ProcessHdrColors(I,i.root),e.UserInterface.ApplyHdrVisualEnhancements(I),e.UserInterface.ProcessPreserveAspectRatio(I,i.root),e.UserInterface.ProcessControlEvents(t,I,i.root),n.__canvasScalerMode=s,n.__cpsScale=1,n.__defaultSpriteDpi=d,n.__fallbackScreenDpi=c,n.__referencePixelsPerUnit=p,o&&!n.renderAtIdealSize&&n.scaleTo(v,_),void n.markAsDirty()}n.renderScale=1,n.renderAtIdealSize=!1,n.idealWidth=void 0,n.idealHeight=void 0,n.useSmallestIdeal=void 0;var L=0===s?h:m,x=B(i.root);Number.isFinite(L)&&1!==L&&C(x,L);var N=BABYLON.GUI.Control.Parse(x,n,r);S(N),n._rootContainer=N,e.UserInterface.ProcessTextSpacingProperties(N,i.root),e.UserInterface.ProcessHdrColors(N,i.root),e.UserInterface.ApplyHdrVisualEnhancements(N),e.UserInterface.ProcessPreserveAspectRatio(N,i.root),e.UserInterface.ProcessControlEvents(t,N,i.root),n.__canvasScalerMode=s,n.__cpsScale=0===s?h:1,n.__defaultSpriteDpi=d,n.__fallbackScreenDpi=c,n.__referencePixelsPerUnit=p,n.markAsDirty()}else{for(var w=null!=i.root&&null!=i.root.children&&i.root.children.length>0?i.root.children[0]:i.root,P=0===s?h:2===s?m:1,R=0,k=Array.isArray(null==w?void 0:w.children)&&(null==w?void 0:w.typeName)?w.children:[w];R<k.length;R++){var E=k[R],D=E;1===P||0!==s&&2!==s||(D=B(E),C(D,P));var U=BABYLON.GUI.Control.Parse(D,n,r);U&&(n.addControl(U),e.UserInterface.ProcessTextSpacingProperties(U,E),e.UserInterface.ProcessHdrColors(U,E),e.UserInterface.ApplyHdrVisualEnhancements(U),e.UserInterface.ProcessPreserveAspectRatio(U,E),e.UserInterface.ProcessControlEvents(t,U,E))}n.markAsDirty()}}},n.FixUserInterfacePrototypes=function(){var t=globalThis||window,n=t&&t.BABYLON,i=n&&n.GUI,o=i&&i.Image,r=i&&i.Control;r&&(r.__prototypeFunctionsPatched||(r.__prototypeFunctionsPatched=!0,r.prototype.getScene=function(){var e;return null===(e=this._host)||void 0===e?void 0:e.getScene()},o.prototype._renderNinePatch=function(t,n,i,o,r){var a,l,s,u,c,d,p,h,m,f,g,y,v,_=null!==(l=null===(a=this.host)||void 0===a?void 0:a.__canvasScalerMode)&&void 0!==l?l:1,S=null!==(u=null===(s=this.host)||void 0===s?void 0:s.__cpsScale)&&void 0!==u?u:1,B=null!==(d=null===(c=this.host)||void 0===c?void 0:c.__referencePixelsPerUnit)&&void 0!==d?d:100,b=null!==(h=null===(p=this.host)||void 0===p?void 0:p.__defaultSpriteDpi)&&void 0!==h?h:96,C=(null===(m=this.host)||void 0===m?void 0:m.__fallbackScreenDpi,null!==(g=null===(f=this.metadata)||void 0===f?void 0:f.spritePixelsPerUnit)&&void 0!==g?g:B),A=this.host.idealWidth?this._currentMeasure.width/this.host.idealWidth:this.host.idealHeight?this._currentMeasure.height/this.host.idealHeight:1;0===_?(A*=S,A*=B/C):1===_?(A=null!==(v=null===(y=this.host)||void 0===y?void 0:y.idealRatio)&&void 0!==v?v:1,A*=B/C):2===_&&(A*=e.UserInterface.PHYSICAL_SIZE_SLICE_FACTOR,A*=B/C,A*=1/(b/96*1));var M=this._sliceLeft,T=this._sliceTop,O=o-this._sliceRight,I=r-this._sliceBottom,L=this._sliceRight-this._sliceLeft,x=this._sliceBottom-this._sliceTop,N=Math.round(M*A),w=Math.round(T*A),P=Math.round(I*A),R=Math.round(O*A),k=Math.max(0,Math.round(this._currentMeasure.width)-R-N+2),E=Math.max(0,Math.round(this._currentMeasure.height)-P-w+2),D=Math.round(this._currentMeasure.left)+N-1,U=Math.round(this._currentMeasure.top)+w-1,F=Math.round(this._currentMeasure.left+this._currentMeasure.width)-R,Y=Math.round(this._currentMeasure.top+this._currentMeasure.height)-P;this._drawImage(t,n,i,M,T,this._currentMeasure.left,this._currentMeasure.top,N,w),this._drawImage(t,n+this._sliceLeft,i,L,T,D+1,this._currentMeasure.top,k-2,w),this._drawImage(t,n+this._sliceRight,i,O,T,F,this._currentMeasure.top,R,w),this._drawImage(t,n,i+this._sliceTop,M,x,this._currentMeasure.left,U+1,N,E-2),this._drawImage(t,n+this._sliceLeft,i+this._sliceTop,L,x,D+1,U+1,k-2,E-2),this._drawImage(t,n+this._sliceRight,i+this._sliceTop,O,x,F,U+1,R,E-2),this._drawImage(t,n,i+this._sliceBottom,M,I,this._currentMeasure.left,Y,N,P),this._drawImage(t,n+this._sliceLeft,i+this._sliceBottom,L,I,D+1,Y,k-2,P),this._drawImage(t,n+this._sliceRight,i+this._sliceBottom,O,I,F,Y,R,P)}))},n.ProcessControlEvents=function(e,t,n){var i=this,o=function(t,n){n&&t&&(i.processUnityUIEvents(e,t,n),i.processUIToolkitEvents(e,t,n),t instanceof BABYLON.GUI.Container&&t.children.forEach(function(e,t){var i=n&&n.children?n.children[t]:null;o(e,i)}))};o(t,n)},n.processUnityUIEvents=function(e,t,n){n.onClick&&this.isUnityUIEvent(n.onClick)&&this.wireUnityUIButtonEvents(e,t,n.onClick),n.onValueChanged&&this.isUnityUIEvent(n.onValueChanged)&&"Toggle"===n.className&&this.wireUnityUIToggleEvents(e,t,n.onValueChanged),n.onValueChanged&&this.isUnityUIEvent(n.onValueChanged)&&"Slider"===n.className&&this.wireUnityUISliderEvents(e,t,n.onValueChanged),n.onValueChanged&&this.isUnityUIEvent(n.onValueChanged)&&"Dropdown"===n.className&&this.wireUnityUIDropdownEvents(e,t,n.onValueChanged),n.onValueChanged&&this.isUnityUIEvent(n.onValueChanged)&&"ScrollRect"===n.className&&this.wireUnityUIScrollRectEvents(e,t,n.onValueChanged),"InputField"===n.className&&this.wireUnityUIInputFieldEvents(e,t,n)},n.processUIToolkitEvents=function(e,t,n){n.isUIToolkit&&(n.events&&"Button"===n.className&&this.wireUIToolkitButtonEvents(e,t,n),n.events&&"Toggle"===n.className&&this.wireUIToolkitToggleEvents(e,t,n),!n.events||"Slider"!==n.className&&"SliderInt"!==n.className||this.wireUIToolkitSliderEvents(e,t,n),n.events&&"DropdownField"===n.className&&this.wireUIToolkitDropdownEvents(e,t,n))},n.isUnityUIEvent=function(e){return e&&e.events&&Array.isArray(e.events)&&e.events.some(function(e){return e.targetName||e.targetType||e.methodName})},n.wireUnityUIButtonEvents=function(e,t,n){var i=this;n.events&&Array.isArray(n.events)&&n.events.forEach(function(n){var o=i.findTargetObject(e,n.targetName,n.targetPath,n.targetInstanceId,n.targetType);null!=o&&(o.args=i.extractParameters(n.mode,n.parameters),t.onPointerClickObservable.add(function(){i.executeUnityUIEvent(o,n)}))})},n.wireUnityUIToggleEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUnityUISliderEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUnityUIDropdownEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUnityUIScrollRectEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUnityUIInputFieldEvents=function(e,t,n){BABYLON.GUI.InputText},n.wireUIToolkitButtonEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUIToolkitToggleEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUIToolkitSliderEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.wireUIToolkitDropdownEvents=function(e,t,n){n.events&&Array.isArray(n.events)},n.executeUnityUIEvent=function(e,t){for(var n,i=[],o=2;o<arguments.length;o++)i[o-2]=arguments[o];try{e.instance&&e.instance[t.methodName]&&"function"==typeof e.instance[t.methodName]?null!=e.args?(n=e.instance)[t.methodName].apply(n,e.args):e.instance[t.methodName]():console.warn("⚠️ UI Event: Target not found or method missing: ".concat(t.targetPath||t.targetName,".").concat(t.methodName))}catch(e){console.error("❌ Error Executing UI event: ".concat(t.methodName),e)}},n.executeUIToolkitEvent=function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i]},n.findTargetObject=function(e,t,n,i,o){var r=null;if(null!=e&&null!=t){var a=e.getNodeByName(t);if(null!=a&&null!=a.metadata&&null!=a.metadata.toolkit&&null!=a.metadata.toolkit.components&&a.metadata.toolkit.components.length>0)for(var l=a.metadata.toolkit.components.length,s=0;s<l;s++){var u=a.metadata.toolkit.components[s],c=u.klass,d=c.lastIndexOf(".");if(-1!==d&&(c=c.substring(d+1)),c===o&&u.instanceID===i){r=u;break}}}return r},n.extractParameters=function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var o=[];return n&&n.length>0&&o.push.apply(o,n),t?(6===e&&null!=t.boolArgument&&o.push(t.boolArgument),5===e&&null!=t.stringArgument&&o.push(t.stringArgument),4===e&&null!=t.floatArgument&&o.push(t.floatArgument),3===e&&null!=t.intArgument&&o.push(t.intArgument),2===e&&t.objectArgument,o):o},n.resolveObjectReference=function(t){return e.SceneManager.GetLastCreatedScene(),null},n.executeUIToolkitCallback=function(e,t){for(var n=[],i=2;i<arguments.length;i++)n[i-2]=arguments[i];var o=window.uiToolkitCallbackRegistry;if(o&&o[e]&&o[e][t]){var r=o[e][t];"function"==typeof r&&r.apply(void 0,n)}else console.warn("⚠️ UI Toolkit callback not registered: ".concat(e,".").concat(t))},n.ProcessHdrColors=function(e,t){var n=this,i=function(e,t){if(e instanceof BABYLON.GUI.TextBlock&&t&&"TextBlock"===t.className){var o=e;if(t.colorIsHDR&&t.colorHdrMultiplier&&t.colorHdrMultiplier>1){var r=n.emulateUnityHDR(t.color,t.colorHdrMultiplier,t.hdrToneMapping);o.color=r.color,o._hdrMultiplier=t.colorHdrMultiplier,o._originalColor=t.color,n.applyHdrEffects(o,r,t.hdrToneMapping)}if(t.outlineColorIsHDR&&t.outlineColorHdrMultiplier&&t.outlineColorHdrMultiplier>1){var a=n.emulateUnityHDR(t.outlineColor,t.outlineColorHdrMultiplier,t.hdrToneMapping);o._hdrOutlineColor=a.color,o._hdrOutlineMultiplier=t.outlineColorHdrMultiplier}if(t.outlineBlur&&t.outlineBlur>0&&(o.outlineBlur=t.outlineBlur),t.faceSoftness&&t.faceSoftness>0&&(o.faceSoftness=t.faceSoftness),t.faceDilate&&0!==t.faceDilate&&(o.faceDilate=t.faceDilate),t.shadowColorIsHDR&&t.shadowColorHdrMultiplier&&t.shadowColorHdrMultiplier>1){var l=n.emulateUnityHDR(t.shadowColor,t.shadowColorHdrMultiplier,t.hdrToneMapping);o._hdrShadowColor=l.color,o._hdrShadowMultiplier=t.shadowColorHdrMultiplier}if(t.glowEnabled&&t.glowColor){var s=t.glowColorIsHDR&&t.glowColorHdrMultiplier>1?n.emulateUnityHDR(t.glowColor,t.glowColorHdrMultiplier,t.hdrToneMapping):{color:t.glowColor,cssFilter:""};o._glowEnabled=!0,o._glowColor=s.color,o._glowOffset=t.glowOffset||0,o._glowInner=t.glowInner||0,o._glowOuter=t.glowOuter||0,o._glowPower=t.glowPower||1,o._hdrGlowMultiplier=t.glowColorHdrMultiplier||1,n.applyGlowEffects(o,s,t)}if(t.lightingEnabled){var u=t.lightColorIsHDR&&t.lightColorHdrMultiplier>1?n.emulateUnityHDR(t.lightColor,t.lightColorHdrMultiplier,t.hdrToneMapping):{color:t.lightColor||"#ffffff",cssFilter:""},c=t.specularColorIsHDR&&t.specularColorHdrMultiplier>1?n.emulateUnityHDR(t.specularColor,t.specularColorHdrMultiplier,t.hdrToneMapping):{color:t.specularColor||"#ffffff",cssFilter:""},d=t.envMapColorIsHDR&&t.envMapColorHdrMultiplier>1?n.emulateUnityHDR(t.envMapColor,t.envMapColorHdrMultiplier,t.hdrToneMapping):{color:t.envMapColor||"#88aadd",cssFilter:""};o._lightingEnabled=!0,o._lightColor=u.color,o._bevelAmount=t.bevelAmount||0,o._bevelOffset=t.bevelOffset||0,o._bevelWidth=t.bevelWidth||0,o._bevelRoundness=t.bevelRoundness||0,o._bevelClamp=t.bevelClamp||1,o._lightAngle=t.lightAngle||0,o._specularPower=t.specularPower||1,o._reflectance=t.reflectance||.5,o._hdrLightMultiplier=t.lightColorHdrMultiplier||1,o._specularColor=c.color,o._shininess=t.shininess||1,o._envMapSampling=t.envMapSampling||0,o._envMapColor=d.color,o._bumpIntensity=t.bumpIntensity||0,o._hdrSpecularMultiplier=t.specularColorHdrMultiplier||1,o._hdrEnvMapMultiplier=t.envMapColorHdrMultiplier||1,n.applyAdvancedLightingEffects(o,u,c,d,t)}}e instanceof BABYLON.GUI.Container&&e.children.forEach(function(e,n){var o=t&&t.children?t.children[n]:null;i(e,o)})};i(e,t)},n.emulateUnityHDR=function(e,t,n){var i=this.parseRgbaColor(e);if(!i)return{color:e,cssFilter:""};var o=(null==n?void 0:n.exposure)||1,r=(null==n?void 0:n.gamma)||2.2,a=(null==n?void 0:n.saturation)||.9,l=(null==n?void 0:n.brightness)||1.1;return this.applyUnityHDRToneMapping(i,t,{exposure:o,gamma:r,saturation:a,brightness:l})},n.applyUnityHDRToneMapping=function(e,t,n){var i=Math.min(t*n.exposure,3),o=e.r/255,r=e.g/255,a=e.b/255,l=.299*(o=1-Math.exp(-o*i))+.587*(r=1-Math.exp(-r*i))+.114*(a=1-Math.exp(-a*i)),s=Math.min(.2*(t-1),.5);o=o*(1-s)+l*s,r=r*(1-s)+l*s,a=a*(1-s)+l*s;var u=1/n.gamma;o=Math.pow(o,u),r=Math.pow(r,u),a=Math.pow(a,u);var c=1+.3*(t-1);o=Math.min(o*c,1),r=Math.min(r*c,1),a=Math.min(a*c,1);var d=Math.round(255*o),p=Math.round(255*r),h=Math.round(255*a),m="rgba(".concat(d,",").concat(p,",").concat(h,",").concat(e.a,")"),f=Math.min(1+.15*(t-1),1.5),g=Math.max(n.saturation,.7);return{color:m,cssFilter:"brightness(".concat(f,") saturate(").concat(g,")")}},n.applyHdrEffects=function(e,t,n){e.color=t.color,e._hdrEnabled=!0,e._hdrCssFilter=t.cssFilter,e._hdrToneMapping=n},n.applyGlowEffects=function(e,t,n){e._glowEnabled=!0,e._glowColor=t.color,e._glowOffset=n.glowOffset||0,e._glowInner=n.glowInner||0,e._glowOuter=n.glowOuter||0,e._glowPower=n.glowPower||1;var i=n.glowInner||0,o=n.glowOuter||0,r=n.glowOffset||0,a=n.glowPower||1,l=Math.max(i,o),s=Math.max(2,8*l*a),u=[];if(i>0){var c=.3*s;u.push("0 0 ".concat(c,"px ").concat(t.color))}if(o>0){var d=s;if(u.push("".concat(r,"px ").concat(r,"px ").concat(d,"px ").concat(t.color)),o>.5){var p=1.5*s;u.push("0 0 ".concat(p,"px ").concat(t.color))}}u.length>0&&(e._glowCssFilter="drop-shadow(".concat(u.join(") drop-shadow("),")"))},n.applyLightingEffects=function(e,t,n){e._lightingEnabled=!0,e._lightColor=t.color,e._bevelAmount=n.bevelAmount||0,e._bevelOffset=n.bevelOffset||0,e._bevelWidth=n.bevelWidth||0,e._bevelRoundness=n.bevelRoundness||0,e._bevelClamp=n.bevelClamp||1,e._lightAngle=n.lightAngle||0,e._specularPower=n.specularPower||1,e._reflectance=n.reflectance||.5;var i=n.bevelAmount||0,o=n.bevelWidth||0,r=(n.lightAngle||0)*Math.PI/180;if(i>0&&o>0){var a=Math.cos(r)*o,l=Math.sin(r)*o,s=-a,u=-l,c=this.parseRgbaColor(t.color),d=c?"rgba(".concat(Math.min(255,c.r+50),", ").concat(Math.min(255,c.g+50),", ").concat(Math.min(255,c.b+50),", ").concat(.6*c.a,")"):"rgba(255, 255, 255, 0.6)",p=c?"rgba(".concat(Math.max(0,c.r-100),", ").concat(Math.max(0,c.g-100),", ").concat(Math.max(0,c.b-100),", ").concat(.4*c.a,")"):"rgba(0, 0, 0, 0.4)",h=[];if(h.push("".concat(a,"px ").concat(l,"px 0px ").concat(d)),h.push("".concat(s,"px ").concat(u,"px 0px ").concat(p)),i>.5){var m=c?"rgba(".concat(c.r,", ").concat(c.g,", ").concat(c.b,", ").concat(.3*c.a,")"):"rgba(255, 255, 255, 0.3)";h.push("".concat(.5*a,"px ").concat(.5*l,"px 1px ").concat(m))}e._lightingCssFilter="drop-shadow(".concat(h.join(") drop-shadow("),")")}},n.applyAdvancedLightingEffects=function(e,t,n,i,o){e._lightingEnabled=!0,e._lightColor=t.color,e._specularColor=n.color,e._envMapColor=i.color;var r=o.bevelAmount||0,a=o.bevelWidth||0,l=(o.lightAngle||0)*Math.PI/180,s=o.shininess||1,u=o.envMapSampling||0,c=o.bumpIntensity||0,d=o.specularPower||1,p=[];if(r>0&&a>0){var h=Math.cos(l)*a,m=Math.sin(l)*a,f=-h,g=-m,y=this.parseRgbaColor(t.color),v=y?"rgba(".concat(Math.min(255,y.r+50),", ").concat(Math.min(255,y.g+50),", ").concat(Math.min(255,y.b+50),", ").concat(.6*y.a,")"):"rgba(255, 255, 255, 0.6)",_=y?"rgba(".concat(Math.max(0,y.r-100),", ").concat(Math.max(0,y.g-100),", ").concat(Math.max(0,y.b-100),", ").concat(.4*y.a,")"):"rgba(0, 0, 0, 0.4)";p.push("".concat(h,"px ").concat(m,"px 0px ").concat(v)),p.push("".concat(f,"px ").concat(g,"px 0px ").concat(_))}if(s>1&&"#ffffff"!==n.color){var S=this.parseRgbaColor(n.color);if(S){var B=Math.min(1,s/10),b="rgba(".concat(S.r,", ").concat(S.g,", ").concat(S.b,", ").concat(.8*B,")"),C=Math.cos(l+Math.PI)*(.3*a),A=Math.sin(l+Math.PI)*(.3*a);if(p.push("".concat(C,"px ").concat(A,"px ").concat(Math.max(1,s),"px ").concat(b)),d>2){var M="rgba(".concat(S.r,", ").concat(S.g,", ").concat(S.b,", ").concat(.4*B,")");p.push("".concat(1.5*C,"px ").concat(1.5*A,"px ").concat(2*s,"px ").concat(M))}}}if(u>0&&"#88aadd"!==i.color){var T=this.parseRgbaColor(i.color);if(T){var O=Math.min(.6,u),I="rgba(".concat(T.r,", ").concat(T.g,", ").concat(T.b,", ").concat(O,")"),L=Math.max(2,5*u);p.push("0 0 ".concat(L,"px ").concat(I));var x=2*Math.cos(l+Math.PI/2),N=2*Math.sin(l+Math.PI/2);p.push("".concat(x,"px ").concat(N,"px ").concat(.7*L,"px ").concat(I))}}if(c>0){var w="rgba(0, 0, 0, ".concat(Math.min(.3,.5*c),")"),P="rgba(255, 255, 255, ".concat(Math.min(.2,.3*c),")"),R=.5*Math.cos(l),k=.5*Math.sin(l);p.push("".concat(R,"px ").concat(k,"px 0px ").concat(P)),p.push("".concat(-R,"px ").concat(-k,"px 0px ").concat(w))}p.length>0&&(e._lightingCssFilter="drop-shadow(".concat(p.join(") drop-shadow("),")"))},n.parseRgbaColor=function(e){var t=e.match(/rgba?\s*\(\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*([\d.]+))?\s*\)/);return t?{r:parseInt(t[1]),g:parseInt(t[2]),b:parseInt(t[3]),a:t[4]?parseFloat(t[4]):1}:null},n.ApplyHdrVisualEnhancements=function(e){var t=function(e){if(e instanceof BABYLON.GUI.TextBlock){var n=e;if(n._hdrEnabled){n._hdrCssFilter;var i=n._hdrMultiplier;i&&i>2&&(n._needsGlowEffect=!0)}}e instanceof BABYLON.GUI.Container&&e.children.forEach(function(e){t(e)})};t(e)},n.ProcessPreserveAspectRatio=function(e,t){},n.applyPreserveAspectRatio=function(e,t){},n.ProcessTextSpacingProperties=function(t,n){var i=this,o=function(t,n){if(t instanceof BABYLON.GUI.TextBlock&&n&&"TextBlock"===n.className){var r=t,a=r.fontSize||"18px",l=parseFloat(a.toString().replace(/px$/,""));if(n.characterSpacing&&0!==n.characterSpacing){var s=parseFloat(n.characterSpacing);if(!isNaN(s)&&0!==s){var u=s*(l*e.UserInterface.CHARACTER_WORD_SPACE_FACTOR);r._characterSpacing=u,i.applyCharacterSpacing(r,u)}}if(n.wordSpacing&&0!==n.wordSpacing&&(s=parseFloat(n.wordSpacing),isNaN(s)||0===s||(u=s*(l*e.UserInterface.CHARACTER_WORD_SPACE_FACTOR),r._wordSpacing=u,i.applyWordSpacing(r,u))),n.paragraphSpacing&&0!==n.paragraphSpacing&&(s=parseFloat(n.paragraphSpacing),!isNaN(s)&&0!==s))if(u=s*l,r._paragraphSpacing=u,r.lineSpacing){var c=parseFloat(r.lineSpacing.toString().replace(/px$/,""));r.lineSpacing=c+u+"px"}else r.lineSpacing=u+"px"}t instanceof BABYLON.GUI.Container&&t.children.forEach(function(e,t){var i=n&&n.children?n.children[t]:null;o(e,i)})};o(t,n)},n.applyCharacterSpacing=function(e,t){var n=e.text;if(n&&t>0){var i=e._drawText;if(i&&(e._drawText=function(e,n,o,r){if(t>0){r.save();var a=this.shadowOffsetX||0,l=this.shadowOffsetY||0,s=this.shadowBlur||0,u=this._hdrShadowColor||this.shadowColor||"transparent",c=this.outlineWidth||0,d=this.outlineBlur||0,p=this._hdrOutlineColor||this.outlineColor||"transparent",h=this.faceSoftness||0,m=this.faceDilate||0;if(0!==m){var f=Math.max(0,1+2*m);f>0&&(r.lineWidth=f,r.strokeStyle=r.fillStyle)}var g=this._hdrCssFilter,y=this._glowCssFilter,v=this._lightingCssFilter,_="";if(h>0){var S=Math.min(3,2*h);_="blur(".concat(S,"px)")}var B=[];g&&B.push(g),y&&B.push(y),v&&B.push(v),_&&B.push(_),B.length>0&&void 0!==r.filter&&(r.filter=B.join(" ")),(0!==a||0!==l||s>0)&&(r.shadowOffsetX=a,r.shadowOffsetY=l,r.shadowBlur=s,r.shadowColor=u),c>0&&(r.strokeStyle=p,r.lineWidth=c);for(var b=e.split(""),C=this._currentMeasure.left,A=0,M=0;M<b.length;M++)A+=r.measureText(b[M]).width,M<b.length-1&&(A+=t);for(this.textHorizontalAlignment===BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER?C+=(this._currentMeasure.width-A)/2:this.textHorizontalAlignment===BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT&&(C+=this._currentMeasure.width-A),M=0;M<b.length;M++)c>0&&(d>0?(r.save(),r.shadowColor=p,r.shadowBlur=d,r.shadowOffsetX=0,r.shadowOffsetY=0,r.strokeStyle=p,r.lineWidth=c,r.strokeText(b[M],C,o),r.restore()):r.strokeText(b[M],C,o)),0!==m&&(r.save(),r.strokeStyle=r.fillStyle,r.lineWidth=Math.abs(2*m),r.strokeText(b[M],C,o),r.restore()),r.fillText(b[M],C,o),C+=r.measureText(b[M]).width+t;r.restore()}else i.call(this,e,n,o,r)}),!i){var o=n.split("").join(" ");e.text=o}}},n.applyWordSpacing=function(e,t){var n=e._drawText;if(n)e._drawText=function(e,i,o,r){if(t>0){r.save();var a=this.shadowOffsetX||0,l=this.shadowOffsetY||0,s=this.shadowBlur||0,u=this._hdrShadowColor||this.shadowColor||"transparent",c=this.outlineWidth||0,d=this.outlineBlur||0,p=this._hdrOutlineColor||this.outlineColor||"transparent",h=this.faceSoftness||0,m=this.faceDilate||0,f=this._hdrCssFilter,g=this._glowCssFilter,y=this._lightingCssFilter,v="";if(h>0){var _=Math.min(3,2*h);v="blur(".concat(_,"px)")}var S=[];f&&S.push(f),g&&S.push(g),y&&S.push(y),v&&S.push(v),S.length>0&&void 0!==r.filter&&(r.filter=S.join(" ")),(0!==a||0!==l||s>0)&&(r.shadowOffsetX=a,r.shadowOffsetY=l,r.shadowBlur=s,r.shadowColor=u),c>0&&(r.strokeStyle=p,r.lineWidth=c);for(var B=e.split(" "),b=this._currentMeasure.left,C=0,A=0;A<B.length;A++)C+=r.measureText(B[A]).width,A<B.length-1&&(C+=r.measureText(" ").width+t);for(this.textHorizontalAlignment===BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_CENTER?b+=(this._currentMeasure.width-C)/2:this.textHorizontalAlignment===BABYLON.GUI.Control.HORIZONTAL_ALIGNMENT_RIGHT&&(b+=this._currentMeasure.width-C),A=0;A<B.length;A++)c>0&&(d>0?(r.save(),r.shadowColor=p,r.shadowBlur=d,r.shadowOffsetX=0,r.shadowOffsetY=0,r.strokeStyle=p,r.lineWidth=c,r.strokeText(B[A],b,o),r.restore()):r.strokeText(B[A],b,o)),0!==m&&(r.save(),r.strokeStyle=r.fillStyle,r.lineWidth=Math.abs(2*m),r.strokeText(B[A],b,o),r.restore()),r.fillText(B[A],b,o),b+=r.measureText(B[A]).width,A<B.length-1&&(b+=r.measureText(" ").width+t);r.restore()}else n.call(this,e,i,o,r)};else{var i=e.text.split(" ").join("  ");e.text=i}},n.IsForegroundReady=function(e){return null!=e._foregroundTexture},n.SetForegroundTexture=function(e,t){e._foregroundTexture=t},n.GetForegroundTexture=function(t,n){return void 0===n&&(n=null),null==t._foregroundTexture&&null!=n&&(t._foregroundTexture=e.UserInterface.CreateInternalUserInterface(t,!0,null==n?void 0:n.samplerMode,null==n?void 0:n.adaptiveHardwareScaling)),t._foregroundTexture},n.IsBackgroundReady=function(e){return null!=e._backgroundTexture},n.SetBackgroundTexture=function(e,t){e._backgroundTexture=t},n.GetBackgroundTexture=function(t,n){return void 0===n&&(n=null),null==t._backgroundTexture&&null!=n&&(t._backgroundTexture=e.UserInterface.CreateInternalUserInterface(t,!1,null==n?void 0:n.samplerMode,null==n?void 0:n.adaptiveHardwareScaling)),t._backgroundTexture},n.GetCanvasElement=function(t,n){var i=n||e.SceneManager.GetLastCreatedScene();return null!=i._foregroundTexture?i._foregroundTexture.getControlByName(t):null},n.ShowCanvasElement=function(t){return r(this,arguments,void 0,function(t,n,i){var o;return void 0===n&&(n=0),void 0===i&&(i=1),a(this,function(r){switch(r.label){case 0:return null==t?[3,3]:n>0?(o=t.alpha,t.isVisible=!0,[4,e.SceneManager.TweenFromToAsync(t,{alpha:o},{alpha:1},{duration:n,speed:i})]):[3,2];case 1:return r.sent(),t.isEnabled=!0,[3,3];case 2:t.isEnabled=!0,t.isVisible=!0,t.alpha=1,r.label=3;case 3:return[2]}})})},n.HideCanvasElement=function(t){return r(this,arguments,void 0,function(t,n,i){var o;return void 0===n&&(n=0),void 0===i&&(i=1),a(this,function(r){switch(r.label){case 0:return null==t?[3,3]:n>0?(t.isEnabled=!1,o=t.alpha,t.isEnabled=!1,[4,e.SceneManager.TweenFromToAsync(t,{alpha:o},{alpha:0},{duration:n,speed:i})]):[3,2];case 1:return r.sent(),t.isVisible=!1,[3,3];case 2:t.isEnabled=!1,t.isVisible=!1,t.alpha=0,r.label=3;case 3:return[2]}})})},n.AttachClickHandler=function(e,t){return null==e||null==t?null:e.onPointerClickObservable.add(t)},n.PHYSICAL_SIZE_SLICE_FACTOR=1.5,n.PHYSICAL_SIZE_POINT_FACTOR=1.915,n.CHARACTER_WORD_SPACE_FACTOR=.01,n.OnParseNodeObject=new BABYLON.Observable,n.OnInterfaceLoaded=new BABYLON.Observable,n}(e.ScriptComponent);e.UserInterface=t,e.SceneManager.RegisterClass("TOOLKIT.UserInterface",t)}(i||(i={})),function(e){var t=function(t){function n(e,n,i,o){void 0===i&&(i={}),void 0===o&&(o="TOOLKIT.WebVideoPlayer");var r=t.call(this,e,n,i,o)||this;return r.videoLoop=!1,r.videoMuted=!1,r.videoAlpha=!1,r.videoFaded=!1,r.videoPoster=null,r.videoInvert=!0,r.videoSample=3,r.videoVolume=1,r.videoMipmaps=!1,r.videoPlayback=1,r.videoPlayOnAwake=!0,r.videoPreloaderUrl=null,r.videoBlobUrl=null,r.videoPreload=!1,r._initializedReadyInstance=!1,r.onReadyObservable=new BABYLON.Observable,r.m_abstractMesh=null,r.m_videoTexture=null,r.m_videoMaterial=null,r.m_diffuseIntensity=1,r}return o(n,t),n.prototype.getVideoMaterial=function(){return this.m_videoMaterial},n.prototype.getVideoTexture=function(){return this.m_videoTexture},n.prototype.getVideoElement=function(){return null!=this.m_videoTexture?this.m_videoTexture.video:null},n.prototype.getVideoScreen=function(){return this.m_abstractMesh},n.prototype.getVideoBlobUrl=function(){return this.videoBlobUrl},n.prototype.awake=function(){this.awakeWebVideoPlayer()},n.prototype.destroy=function(){this.destroyWebVideoPlayer()},n.prototype.awakeWebVideoPlayer=function(){this.videoLoop=this.getProperty("looping",!1),this.videoMuted=this.getProperty("muted",!1),this.videoInvert=this.getProperty("inverty",!0),this.videoSample=this.getProperty("sampling",3),this.videoVolume=this.getProperty("volume",1),this.videoMipmaps=this.getProperty("mipmaps",!1),this.videoAlpha=this.getProperty("texturealpha",!1),this.videoFaded=this.getProperty("diffusealpha",!1),this.videoPlayback=this.getProperty("playbackspeed",1),this.videoPlayOnAwake=this.getProperty("playonawake",!0),this.videoPreload=this.getProperty("preload",this.videoPreload),this.m_diffuseIntensity=this.getProperty("intensity",1),this.m_abstractMesh=this.getAbstractMesh(),!0===this.getProperty("poster")&&null!=this.m_abstractMesh&&null!=this.m_abstractMesh.material&&(this.m_abstractMesh.material instanceof BABYLON.PBRMaterial?null!=this.m_abstractMesh.material.albedoTexture&&null!=this.m_abstractMesh.material.albedoTexture.url&&""!==this.m_abstractMesh.material.albedoTexture.url&&(this.videoPoster=this.m_abstractMesh.material.albedoTexture.url.replace("data:","")):this.m_abstractMesh.material instanceof BABYLON.StandardMaterial&&null!=this.m_abstractMesh.material.diffuseTexture&&null!=this.m_abstractMesh.material.diffuseTexture.url&&""!==this.m_abstractMesh.material.diffuseTexture.url&&(this.videoPoster=this.m_abstractMesh.material.diffuseTexture.url.replace("data:","")));var t=this.getProperty("url",null),n=this.getProperty("source",null),i=t;null!=n&&null!=n.filename&&""!==n.filename&&(i=e.SceneManager.GetRootUrl(this.scene)+n.filename),null!=i&&""!==i&&(!0===this.videoPreload?this.videoPreloaderUrl=i:this.setDataSource(i))},n.prototype.destroyWebVideoPlayer=function(){this.m_abstractMesh=null,null!=this.m_videoTexture&&(this.m_videoTexture.dispose(),this.m_videoTexture=null),null!=this.m_videoMaterial&&(this.m_videoMaterial.dispose(),this.m_videoMaterial=null),this.revokeVideoBlobUrl()},n.prototype.isReady=function(){return null!=this.getVideoElement()},n.prototype.isPlaying=function(){var e=!1,t=this.getVideoElement();return null!=t&&(e=!1===t.paused),e},n.prototype.isPaused=function(){var e=!1,t=this.getVideoElement();return null!=t&&(e=!0===t.paused),e},n.prototype.play=function(){return r(this,void 0,void 0,function(){return a(this,function(t){switch(t.label){case 0:return[4,e.AudioSource.UnlockAudioEngine()];case 1:return t.sent(),this.internalPlay(),[2,!0]}})})},n.prototype.internalPlay=function(){var e=this;!0===this._initializedReadyInstance?this.checkedPlay():this.onReadyObservable.addOnce(function(){e.checkedPlay()})},n.prototype.checkedPlay=function(){var e=this,t=this.getVideoElement();null!=t&&t.play().then(function(){!0===t.paused&&e.checkedRePlay()})},n.prototype.checkedRePlay=function(){var e=this.getVideoElement();null!=e&&e.play().then(function(){})},n.prototype.pause=function(){var e=!1,t=this.getVideoElement();return null!=t&&(t.pause(),e=!0),e},n.prototype.mute=function(){var e=!1,t=this.getVideoElement();return null!=t&&(t.muted=!0,e=!0),e},n.prototype.unmute=function(){var e=!1,t=this.getVideoElement();return null!=t&&(t.muted=!1,e=!0),e},n.prototype.getVolume=function(){var e=0,t=this.getVideoElement();return null!=t&&(e=t.volume),e},n.prototype.setVolume=function(e){var t=!1,n=this.getVideoElement();return null!=n&&(n.volume=e,t=!0),t},n.prototype.setDataSource=function(e){var t=this;null!=this.m_abstractMesh&&(null==this.m_videoMaterial&&(this.m_videoMaterial=new BABYLON.StandardMaterial(this.transform.name+".VideoMat",this.scene),this.m_videoMaterial.roughness=1,this.m_videoMaterial.diffuseColor=new BABYLON.Color3(1,1,1),this.m_videoMaterial.emissiveColor=new BABYLON.Color3(1,1,1),this.m_videoMaterial.useAlphaFromDiffuseTexture=this.videoFaded,this.m_abstractMesh.material=this.m_videoMaterial),null!=this.m_videoMaterial?(this.m_videoMaterial.diffuseTexture=null,null!=this.m_videoTexture&&(this.m_videoTexture.dispose(),this.m_videoTexture=null),this._initializedReadyInstance=!1,this.m_videoTexture=new BABYLON.VideoTexture(this.transform.name+".VideoTex",e,this.scene,this.videoMipmaps,this.videoInvert,this.videoSample,{autoUpdateTexture:!0,poster:this.videoPoster}),null!=this.m_videoTexture&&(this.m_videoTexture.hasAlpha=this.videoAlpha,null!=this.m_videoTexture.video&&(this.m_videoTexture.video.loop=this.videoLoop,this.m_videoTexture.video.muted=this.videoMuted,this.m_videoTexture.video.volume=this.videoVolume,this.m_videoTexture.video.playbackRate=this.videoPlayback,this.m_videoTexture.video.addEventListener("loadeddata",function(){t._initializedReadyInstance=!0,t.onReadyObservable&&t.onReadyObservable.hasObservers()&&t.onReadyObservable.notifyObservers(t.m_videoTexture),!0===t.videoPlayOnAwake&&t.play()}),this.m_videoTexture.video.load())),null!=this.m_videoTexture&&(this.m_videoTexture.level=this.m_diffuseIntensity,this.m_videoMaterial.diffuseTexture=this.m_videoTexture)):BABYLON.Tools.Warn("No video mesh or material available for: "+this.transform.name))},n.prototype.revokeVideoBlobUrl=function(){null!=this.videoBlobUrl&&(URL.revokeObjectURL(this.videoBlobUrl),this.videoBlobUrl=null)},n.prototype.addPreloaderTasks=function(e){var t=this;if(!0===this.videoPreload){var n=e.addBinaryFileTask(this.transform.name+".VideoTask",this.videoPreloaderUrl);n.onSuccess=function(e){t.revokeVideoBlobUrl(),t.videoBlobUrl=URL.createObjectURL(new Blob([e.data])),t.setDataSource(t.videoBlobUrl)},n.onError=function(e,t,n){console.error(t,n)}}},n}(e.ScriptComponent);e.WebVideoPlayer=t,e.SceneManager.RegisterClass("TOOLKIT.WebVideoPlayer",t)}(i||(i={})),"undefined"!=typeof window?(window.TOOLKIT=i,window.SM=i.SceneManager,window.WM=i.WindowManager,window.UI=i.UserInterface,window.IC=i.InputController):(globalThis.TOOLKIT=i,globalThis.SM=i.SceneManager,globalThis.WM=i.WindowManager,globalThis.UI=i.UserInterface,globalThis.IC=i.InputController);const s=i;return t.default})());